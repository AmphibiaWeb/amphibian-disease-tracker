var checkCoordinateSanity,doDeepSearch,doSearch,generateColorByRecency,generateColorByRecency2,getSearchContainsObject,getSearchObject,namedMapAdvSource,namedMapSource,resetMap,showAllTables,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};namedMapSource="adp_generic_heatmap-v15",namedMapAdvSource="adp_specific_heatmap-v9",checkCoordinateSanity=function(){var a,b;return b=!0,a={n:toFloat($("#north-coordinate").val()),w:toFloat($("#west-coordinate").val()),s:toFloat($("#south-coordinate").val()),e:toFloat($("#east-coordinate").val())},console.log("User Bounds",a),a.n>a.s||(b=!1,$(".lat-input").parent().addClass("has-error")),a.e>a.w||(b=!1,$(".lng-input").parent().addClass("has-error")),b?($(".coord-input").parent().removeClass("has-error"),$(".do-search").removeAttr("disabled"),!0):($(".do-search").attr("disabled","disabled"),!1)},getSearchObject=function(){var a,b,c,d;return a={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},d={sampled_species:{data:$("#taxa-input").val().toLowerCase()},bounding_box_n:{data:a.n,search_type:"<="},bounding_box_e:{data:a.e,search_type:"<="},bounding_box_w:{data:a.w,search_type:">="},bounding_box_s:{data:a.s,search_type:">="}},b=$(p$("#disease-status").selectedItem).attr("data-search"),"*"!==b&&(d.disease_positive={data:0,search_type:b.toBool()?">":"="}),c=$(p$("#morbidity-status").selectedItem).attr("data-search"),"*"!==c&&(d.disease_morbidity={data:0,search_type:c.toBool()?">":"="}),d},getSearchContainsObject=function(){var a,b,c,d,e,f,g,h,i;return a={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},h=$("#taxa-input").val().toLowerCase(),i=h.split(" "),g=3===i.length?i.pop():"",f=2===i.length?i.pop():"",c=1===i.length?i.pop():"",e={sampled_species:{data:h,genus:c,species:f,subspecies:g},bounding_box_n:{data:a.s,search_type:">"},bounding_box_e:{data:a.w,search_type:">"},bounding_box_w:{data:a.e,search_type:"<"},bounding_box_s:{data:a.n,search_type:"<"}},b=$(p$("#disease-status").selectedItem).attr("data-search"),"*"!==b&&(e.disease_positive={data:0,search_type:b.toBool()?">":"="}),d=$(p$("#morbidity-status").selectedItem).attr("data-search"),"*"!==d&&(e.disease_morbidity={data:0,search_type:d.toBool()?">":"="}),e},doSearch=function(a,b){var c,d,e,f;return null==a&&(a=getSearchObject()),null==b&&(b=!1),startLoad(),e=jsonTo64(a),c="advanced_project_search",f=b?namedMapAdvSource:namedMapSource,d="perform="+c+"&q="+e,$.post(uri.urlString+"admin-api.php",d,"json").done(function(a){var c,d,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;if(console.info("Adv. search result",a),a.status!==!0)return console.error(a.error),stopLoadError("There was a problem fetching the results"),!1;if(B=Object.toArray(a.result),0===B.length)return console.warn("No results"),stopLoadError("No results"),!1;if(b)return doDeepSearch(B,f),!1;for(G=0,y=0,H=[],t=[],c={n:-90,s:90,e:-180,w:180},m=0,console.info("Using standard named map "+f),n=0,u=B.length;u>n;n++){for(z=B[n],z.bounding_box_n>c.n&&(c.n=z.bounding_box_n),z.bounding_box_e>c.e&&(c.e=z.bounding_box_e),z.bounding_box_s<c.s&&(c.s=z.bounding_box_s),z.bounding_box_w<c.w&&(c.w=z.bounding_box_w),G+=z.disease_samples,y+=z.disease_positive,C=z.sampled_species.split(","),o=0,v=C.length;v>o;o++)D=C[o],D=D.trim(),indexOf.call(H,D)<0&&H.push(D);if(null==(null!=(A=z.carto_id)?A.table:void 0))try{g=JSON.parse(z.carto_id),e={};for(p in g){I=g[p],h=p.replace("&#95;","_");try{i=I.replace("&#95;","_")}catch(K){i=I}e[h]=i}z.carto_id=e}catch(L){}try{F=z.carto_id.table.slice(0,63)}catch(L){}isNull(F)?console.warn("Unable to get a table id from this carto data:",z.carto_id):(r={name:f,type:"namedmap",layers:[{layer_name:"layer-"+t.length}],params:{table_name:F,color:"#FF6600"}},t.push(r)),B[m]=z,++m}try{d=[[c.n,c.w],[c.n,c.e],[c.s,c.e],[c.s,c.w]],x=getMapCenter(d),J=getMapZoom(d,".map-container"),console.info("Found @ zoom = "+J+" center",x,"for bounding box",d),null!=geo.lMap&&geo.lMap.setZoom(J);try{p$("#global-data-map").latitude=x.lat,p$("#global-data-map").longitude=x.lng}catch(M){try{geo.lMap.panTo([x.lat,x.lng])}catch(L){}}}catch(k){j=k,console.warn("Failed to rezoom/recenter map - "+j.message,d),console.warn(j.stack)}E=H.length,console.info("Projects containing your search returned "+G+" ("+y+" positive) among "+E+" species",c),$("#post-map-subtitle").text("Viewing projects containing "+G+" samples ("+y+" positive) among "+E+" species");try{for(resetMap(geo.lMap,!1,!1),q=0,w=t.length;w>q;q++)r=t[q],s={user_name:cartoAccount,type:"namedmap",named_map:r},createRawCartoMap(s)}catch(l){j=l,console.error("Couldn't create map! "+j.message),console.warn(j.stack)}return stopLoad(),!1}).fail(function(a,b){return console.error(a,b),console.warn("Attempted to do",uri.urlString+"admin-api.php?"+d),stopLoadError("Server error, couldn't perform search")}),!1},doDeepSearch=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O;null==b&&(b=namedMapAdvSource);try{for(E=getSearchContainsObject(),L=0,z=0,M=[],u=[],c={n:-90,s:90,e:-180,w:180},n=0,console.info("Using deep named map "+b),i="",null!=(null!=(B=E.disease_positive)?B.data:void 0)&&(i=">"===E.disease_positive.search_type?"true":"false"),o=0,v=a.length;v>o;o++){for(A=a[o],A.bounding_box_n>c.n&&(c.n=A.bounding_box_n),A.bounding_box_e>c.e&&(c.e=A.bounding_box_e),A.bounding_box_s<c.s&&(c.s=A.bounding_box_s),A.bounding_box_w<c.w&&(c.w=A.bounding_box_w),L+=A.disease_samples,z+=A.disease_positive,F=A.sampled_species.split(","),p=0,w=F.length;w>p;p++)H=F[p],H=H.trim(),indexOf.call(M,H)<0&&M.push(H);if(null==(null!=(C=A.carto_id)?C.table:void 0))try{f=JSON.parse(A.carto_id),e={};for(q in f){N=f[q],g=q.replace("&#95;","_");try{h=N.replace("&#95;","_")}catch(P){h=N}e[g]=h}A.carto_id=e}catch(Q){}try{K=A.carto_id.table.slice(0,63)}catch(Q){}isNull(K)?console.warn("Unable to get a table id from this carto data:",A.carto_id):(s={name:b,type:"namedmap",layers:[{layer_name:"layer-"+u.length}],params:{table_name:K,color:"#FF6600",genus:E.sampled_species.genus,specific_epithet:E.sampled_species.species,disease_detected:i}},u.push(s)),a[n]=A,++n}try{d=[[c.n,c.w],[c.n,c.e],[c.s,c.e],[c.s,c.w]],y=getMapCenter(d),O=getMapZoom(d,".map-container"),console.info("Found @ zoom = "+O+" center",y,"for bounding box",d),null!=geo.lMap&&geo.lMap.setZoom(O);try{p$("#global-data-map").latitude=y.lat,p$("#global-data-map").longitude=y.lng}catch(R){try{geo.lMap.panTo([y.lat,y.lng])}catch(Q){}}}catch(k){j=k,console.warn("Failed to rezoom/recenter map - "+j.message,d),console.warn(j.stack)}I=M.length,console.info("Projects containing your search returned "+L+" ("+z+" positive) among "+I+" species",c),J="viewing data points",null!=(null!=(D=E.sampled_species)?D.genus:void 0)&&(G=" of '"+E.sampled_species.genus+" "+E.sampled_species.species+" "+E.sampled_species.subspecies+"'",J+=G.replace(/( \*)/gim,"")),null!=E.disease_positive&&(J+=" with disease status '"+i+"'"),J+=" in bounds defined by [{lat: "+E.bounding_box_n.data+",lng: "+E.bounding_box_w.data+"},{lat: "+E.bounding_box_s.data+",lng: "+E.bounding_box_e.data+"}]",$("#post-map-subtitle").text(J);try{for(resetMap(geo.lMap,!1,!1),r=0,x=u.length;x>r;r++)s=u[r],t={user_name:cartoAccount,type:"namedmap",named_map:s},createRawCartoMap(t)}catch(l){j=l,console.error("Couldn't create map! "+j.message),console.warn(j.stack)}stopLoad()}catch(m){j=m,stopLoadError("There was a problem performing a sample search"),console.error("Problem performing sample search! "+j.message),console.warn(j.stack)}return!1},showAllTables=function(){var a,b;return console.log("Starting table list"),b=uri.urlString+"admin-api.php",a="perform=list",$.post(b,a,"json").done(function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(a.status===!1)return console.error("Got bad result",a),!1;console.info("Good result",a),b=a.carto_table_map,j=[],n=[],f=0;for(l in b)c=b[l],m=c.table,console.log("Colors",c.creation,generateColorByRecency(c.creation),generateColorByRecency2(c.creation)),isNull(m)?console.warn("Bad table #"+f,m):(m=m.slice(0,63),n.push(m),h={name:namedMapSource,type:"namedmap",layers:[{layer_name:"layer-"+j.length,interactivity:"cartodb_id, id, diseasedetected, genus, specificepithet"}],params:{table_name:m,color:generateColorByRecency2(c.creation)}},j.push(h)),++f;console.info("Got tables",n),console.info("Got layers",j);try{for(g=0,k=j.length;k>g;g++)h=j[g],i={user_name:cartoAccount,type:"namedmap",named_map:h},console.log("Creating raw map from",i),createRawCartoMap(i)}catch(e){d=e,console.error("Couldn't create map! "+d.message),console.warn(d.stack)}return!1}).error(function(a,b){return console.error("AJAX failure showing tables",a,b)}),!1},resetMap=function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a&&(a=geo.lMap),null==b&&(b=!0),null==c&&(c=!0),null==geo.mapSublayers)return console.error("geo.mapSublayers is not defined."),!1;try{for(i=geo.mapSublayers,e=0,g=i.length;g>e;e++)k=i[e],k.remove()}catch(l){j=a._layers;for(d in j)if(f=j[d],h=f._url.search("arcgisonline"),-1===h)try{f.removeLayer()}catch(m){f.remove()}}return c&&(geo.lMap.setZoom(geo.defaultLeafletOptions.zoom),geo.lMap.panTo(geo.defaultLeafletOptions.center)),b&&showAllTables(),!1},generateColorByRecency=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(null==b&&(b=1420070400),isNumber(a)||(p=new Date(a),a=p.getTime()/1e3),a>Date.now()/1e3&&(a/=1e3),c=Date.now()/1e3-a,l=a-b,c>l)e="#000";else{for(o=l/765,n=c/o,d=255,g=255,m=255-n,m=0>m?0:toInt(m),n>255&&(g=510-n,g=0>g?0:toInt(g),n>510&&(d=765-n,d=0>d?0:toInt(d))),console.log("Base channels",m,g,d),h=[m.toString(16),g.toString(16),d.toString(16)],i=0,j=0,k=h.length;k>j;j++)f=h[j],1===f.length&&(h[i]="0"+f),++i;e="#"+h.join("")}return e},generateColorByRecency2=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(null==b&&(b=1420070400),isNumber(a)||(p=new Date(a),a=p.getTime()/1e3),a>Date.now()/1e3&&(a/=1e3),c=Date.now()/1e3-a,l=a-b,c>l)e="#000";else{for(o=l/765,n=c/o,m=255-n,g=0>m?0-m:255-m,m=0>m?0:toInt(m),d=g>255?toInt(g-255):0,g=g>255?255-(g-255):toInt(g),d=0>d?0:toInt(d),console.log("Base channels",m,g,d),h=[m.toString(16),g.toString(16),d.toString(16)],i=0,j=0,k=h.length;k>j;j++)f=h[j],1===f.length&&(h[i]="0"+f),++i;e="#"+h.join("")}return e},$(function(){var a,b,c,d;return geo.initLocation(),d={center:[17.811456088564483,-37.265625],zoom:2},geo.defaultLeafletOptions=d,b=new L.Map("global-map-container",d),c={attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"},L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",c).addTo(b),geo.lMap=b,$(".coord-input").keyup(function(){return checkCoordinateSanity()}),a=function(a){var b,c,d;if(c=checkCoordinateSanity(),!c)return toastStatusMessage("Please check your coordinates"),!1;d=getSearchObject();try{b=$(a).attr("data-deep").toBool(),b&&(d=getSearchContainsObject())}catch(e){b=!1}return doSearch(d,b),!1},$("input.submit-project-search").keyup(function(b){var c;return c=b.keyCode?b.keyCode:b.which,13===c?a():!1}),$(".do-search").click(function(){return a(this)}),$("#reset-global-map").click(function(){return resetMap(),!1}),showAllTables(),!1});
//# sourceMappingURL=maps/c.map