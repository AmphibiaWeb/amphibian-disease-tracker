var checkCoordinateSanity,createOverflowMenu,createTemplateByProject,doDeepSearch,doSearch,firstLoadInstructionPrompt,generateColorByRecency,generateColorByRecency2,getPrettySpecies,getProjectResultDialog,getSampleSummaryDialog,getSearchContainsObject,getSearchObject,namedMapAdvSource,namedMapSource,resetMap,setViewerBounds,showAllTables,indexOf=[].indexOf||function(e){for(var t=0,a=this.length;t<a;t++)if(t in this&&this[t]===e)return t;return-1};namedMapSource="adp_generic_heatmap-v16",namedMapAdvSource="adp_specific_heatmap-v15";try{p$("#exact-species-search").checked&&(namedMapAdvSource="adp_specific_exact_heatmap-v1")}catch(e){}checkCoordinateSanity=function(){var e,t;return t=!0,e={n:toFloat($("#north-coordinate").val()),w:toFloat($("#west-coordinate").val()),s:toFloat($("#south-coordinate").val()),e:toFloat($("#east-coordinate").val())},console.log("User Bounds",e),e.s<e.n||(t=!1,$(".lat-input").parent().addClass("has-error")),e.w<e.e||(t=!1,$(".lng-input").parent().addClass("has-error")),t?($(".coord-input").parent().removeClass("has-error"),$(".do-search").removeAttr("disabled"),!0):($(".do-search").attr("disabled","disabled"),!1)},createTemplateByProject=function(n,r,s){var e,i,t,a,o,l,c;if(null==n&&(n="t2627cbcbb4d7597f444903b2e7a5ce5c_6d6d454828c05e8ceea03c99cc5f5"),null==r&&(r=!1),l=Date.now(),null==(null!=(o=window._adp)?o.templateReady:void 0)&&(null==window._adp&&(window._adp={}),window._adp.templateReady={},window._adp.templates={}),t=!1,"object"==typeof n){if(isNull(n.table))return console.error("Couldn't create template for project -- undefined table",n),!1;isNull(n.project)?n=n.table:(a=n.project,n=n.table,t=!0)}if(c="infowindow_template_"+n.slice(0,63),$("#"+c).exists()){if(r)return"function"==typeof s&&s(),!1;$("#"+c).remove()}return window._adp.templateReady[n]=!1,e="action=fetch&sql_query="+post64("SELECT cartodb_id FROM "+n+" LIMIT 1"),i=function(e,t,a){var o,n;return n='<script type="infowindow/html" id="'+t+'">\n  <div class="cartodb-popup v2">\n    <a href="#close" class="cartodb-popup-close-button close">x</a>\n    <div class="cartodb-popup-content-wrapper">\n      <div class="cartodb-popup-header">\n        <h2>Sample Info</h2>\n      </div>\n      <div class="cartodb-popup-content">\n        \x3c!-- content.data contains the field info --\x3e\n        <h4>Species: </h4>\n        <p><i>{{content.data.genus}} {{content.data.specificepithet}}</i></p>\n        '+(r?"":'<p>Tested {{content.data.diseasetested}} as <strong>{{content.data.diseasedetected}}</strong> (Fatal: <strong>{{content.data.fatal}}</strong>)</p><p><span class="date-group">Sample was taken in <span class="unix-date">{{content.data.dateidentified}}</span>.</span></p>')+'\n        <p><a href="https://amphibiandisease.org/project.php?id='+e+'">View Project</a></p>\n      </div>\n    </div>\n    <div class="cartodb-popup-tip-container"></div>\n  </div>\n<\/script>',$("head").append(n),window._adp.templates[a]=n,window._adp.templates[a.slice(0,63)]=n,window._adp.templateReady[a]=!0,o=Date.now()-l,console.info("Template set for #"+t+" (took "+o+"ms)"),"function"==typeof s&&s(),!1},t?(console.info("Directly provided project id"),i(a,c,n)):(console.info("Creating template after pinging API endpoint"),$.post(uri.urlString+"api.php",e,"json").done(function(e){var t,a,o;return t=null!=(a=e.parsed_responses)&&null!=(o=a[0])?o.project_id:void 0,isNull(t)?console.warn("Couldn't find project ID for table "+n,e):i(t,c,n)})),!1},setViewerBounds=function(e){var t,a,o;return null==e&&(e=geo.lMap),o=(t=e.getBounds())._southWest,360<(a=t._northEast).lng-o.lng&&(o.lng=-180,a.lng=180),$("#north-coordinate").val(a.lat),$("#west-coordinate").val(o.lng),$("#south-coordinate").val(o.lat),$("#east-coordinate").val(a.lng),!1},getSearchObject=function(){var e,t,a,o,n;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(e){}return e={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},n={sampled_species:{data:$("#taxa-input").val().toLowerCase()},bounding_box_n:{data:e.n,search_type:"<="},bounding_box_e:{data:e.e,search_type:"<="},bounding_box_w:{data:e.w,search_type:">="},bounding_box_s:{data:e.s,search_type:">="}},"*"!==(t=$(p$("#disease-status").selectedItem).attr("data-search"))&&(n.disease_positive={data:0,search_type:t.toBool()?">":"="}),"*"!==(a=$(p$("#morbidity-status").selectedItem).attr("data-search"))&&(n.disease_morbidity={data:0,search_type:a.toBool()?">":"="}),"*"!==(o=$(p$("#pathogen-choice").selectedItem).attr("data-search"))&&(n.disease={data:o}),n},getSearchContainsObject=function(){var e,t,a,o,n,r,s,i,l;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(e){}return e={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},s=3===(l=(i=$("#taxa-input").val().toLowerCase()).split(" ")).length?l.pop():"",r=2===l.length?l.pop():"",n={sampled_species:{data:i,genus:1===l.length?l.pop():"",species:r,subspecies:s},bounding_box_n:{data:e.s,search_type:">"},bounding_box_e:{data:e.w,search_type:">"},bounding_box_w:{data:e.e,search_type:"<"},bounding_box_s:{data:e.n,search_type:"<"}},"*"!==(t=$(p$("#disease-status").selectedItem).attr("data-search"))&&(n.disease_positive={data:0,search_type:t.toBool()?">":"="}),"*"!==(a=$(p$("#morbidity-status").selectedItem).attr("data-search"))&&(n.disease_morbidity={data:0,search_type:a.toBool()?">":"="}),"*"!==(o=$(p$("#pathogen-choice").selectedItem).attr("data-search"))&&(n.disease={data:o}),n},doSearch=function(V,z,G){var a,e,U;return null==V&&(V=getSearchObject()),null==z&&(z=!1),null==G&&(G=!1),startLoad(),$("#post-map-subtitle").removeClass("bg-success"),e=jsonTo64(V),"advanced_project_search",U=z?namedMapAdvSource:namedMapSource,a="perform=advanced_project_search&q="+e,$.post(uri.urlString+"admin-api.php",a,"json").done(function(e){var t,a,o,n,r,s,i,d,p,l,c,u,m,h,g,b,f,w,y,v,_,S,k,j,x,C,M,N,T,D,L,O,A,P,R,I,B,E,F,W;if(console.info("Adv. search result",e),!0!==e.status)return console.error(e.error),stopLoadError("There was a problem fetching the results"),!1;if(0===(N=Object.toArray(e.result)).length)return T=function(e){var t,a;return null==e&&(e=!1),console.warn("The search failed!"),isNull(null!=(a=V.sampled_species)?a.data:void 0)||(t='<span id="taxa-input-error" class="help-block">\n  Invalid taxon: Please check your spelling. <a href="http://amphibiaweb.org/search/index.html" class="click" data-newtab="true">Check AmphibiaWeb for valid taxa</a>\n</span>',e&&(t='<span id="taxa-input-error" class="help-block">\n  No matching samples found.\n</span>'),$("#taxa-input-container").addClass("has-error"),$("#taxa-input-error").remove(),$("#taxa-input").attr("aria-describedby","taxa-input-error").after(t).keyup(function(){try{return $("#taxa-input-container").removeClass("has-error"),$("#taxa-input-error").remove()}catch(e){}}),bindClicks()),console.warn("No results"),stopLoadError("No results"),!1},isNull(null!=(k=V.sampled_species)?k.data:void 0)||G?(console.warn("No need to validate",isNull(null!=(C=V.sampled_species)?C.data:void 0),G),T(!0)):(console.warn("The initial search failed, we're going to validate the taxon and re-check"),P={genus:null!=(j=(R=V.sampled_species.data.split(" "))[0])?j:"",species:null!=(x=R[1])?x:""},validateAWebTaxon(P,function(e){var t,a;return!0===e.invalid?(console.error("This taxon is invalid!",e),T()):(a=(a=e.genus+" "+e.species+" "+(null!=(t=e.subspecies)?t:"")).trim(),$("#taxa-input").val(a),doSearch(getSearchObject(),z,!0)),!1})),!1;if(z)return doDeepSearch(N,U),!1;for(E=[],b=[],t={n:-90,s:90,e:-180,w:180},l=_=B=0,console.info("Using standard named map "+U),c=0,f=N.length;c<f;c++){for((S=N[c]).bounding_box_n>t.n&&(t.n=S.bounding_box_n),S.bounding_box_e>t.e&&(t.e=S.bounding_box_e),S.bounding_box_s<t.s&&(t.s=S.bounding_box_s),S.bounding_box_w<t.w&&(t.w=S.bounding_box_w),B+=S.disease_samples,_+=S.disease_positive,u=0,w=(D=S.sampled_species.split(",")).length;u<w;u++)L=(L=D[u]).trim(),indexOf.call(E,L)<0&&E.push(L);if(null==(null!=(M=S.carto_id)?M.table:void 0))try{for(m in n=JSON.parse(S.carto_id),o={},n){F=n[m],r=m.replace("&#95;","_");try{s=F.replace("&#95;","_")}catch(e){s=F}o[r]=s}S.carto_id=o}catch(e){}try{A=(A=S.carto_id.table).unescape()}catch(e){}if(isNull(A))console.warn("Unable to get a table id from this carto data:",S.carto_id);else{try{I={project:S.project_id,table:A},createTemplateByProject(I)}catch(e){console.error("Warning: couldn't create project template: "+(d=e).message),console.warn(d.stack)}g={name:U,type:"namedmap",layers:[{layer_name:"layer-"+b.length}],params:{table_name:A,color:"#FF6600"}},b.push(g)}N[l]=S,++l}try{a=[[t.n,t.w],[t.n,t.e],[t.s,t.e],[t.s,t.w]],v=getMapCenter(a),W=getMapZoom(a,".map-container"),console.info("Found @ zoom = "+W+" center",v,"for bounding box",a),null!=geo.lMap&&(geo.lMap.once("zoomend",function(){return console.info("ZoomEnd is ensuring centering"),p(0)}),geo.lMap.setZoom(W));try{p$("#global-data-map").latitude=v.lat,p$("#global-data-map").longitude=v.lng,p$("#global-data-map").zoom=W}catch(e){}try{geo.lMap.setView(v.getObj())}catch(e){}}catch(e){console.warn("Failed to rezoom/recenter map - "+(d=e).message,a),console.warn(d.stack)}O=E.length,console.info("Projects containing your search returned "+B+" ("+_+" positive) among "+O+" species",t);try{for(resetMap(geo.lMap,!1,!1),h=0,y=b.length;h<y;h++)g=b[h],(i=function(e,t){var a,o,n,r;return!0===(null!=(n=window._adp)&&null!=(r=n.templateReady)?r[t.params.table_name]:void 0)||(50<e?(console.error("Error -- timed out waiting for template to be ready"),o=!0):o=!1,o)?(console.info("Template script ready for table '"+window._adp.templateReady[t.params.table_name]+"' after "+e+" iterations, rendering on map"),a={user_name:cartoAccount,type:"namedmap",named_map:t},createRawCartoMap(a)):delay(50,function(){return i(++e,t)}),!1})(0,g);$("#post-map-subtitle").text("Viewing projects containing "+B+" samples ("+_+" positive) among "+O+" species"),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),$(".show-result-list").remove(),'<paper-icon-button class="show-result-list" icon="icons:subject" data-toggle="tooltip" title="Show Project list" raised></paper-icon-button>',$("#post-map-subtitle").append('<paper-icon-button class="show-result-list" icon="icons:subject" data-toggle="tooltip" title="Show Project list" raised></paper-icon-button>'),getProjectResultDialog(N),(p=function(e,t,a){var o,n,r,s,i,l,c;l=roundNumber(v.lat,3),c=roundNumber(v.lng,3);try{o={type:"google-map-element",lat:n=roundNumber(p$("#global-data-map").latitude,3),lng:r=roundNumber(p$("#global-data-map").longitude,3)}}catch(e){}try{o=geo.lMap.getCenter(),n=roundNumber(o.lat,3),r=roundNumber(o.lng,3)}catch(e){}return s=100*Math.abs((n-l)/l),i=100*Math.abs((r-c)/c),s<2&&i<2&&5<e?(console.info("Correctly centered",v,o,[s,i]),geo.lMap.getZoom()!==W&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(e<=15||console.warn("Centering too deviant",s<2,i<2,s<2&&i<2,n,r,l,c),isNumber(t)||(t=100),t<e?(console.info("Map could not be correctly centered in "+a*t+"ms"),clearTimeout(_adp.centerTimeout),!1):(++e,_adp.centerTimeout=delay(a,function(){isNumber(t)||(t=100);try{p$("#global-data-map").latitude=v.lat,p$("#global-data-map").longitude=v.lng}catch(e){}try{console.log("#"+e+"/"+t+" General setting view to",v.getObj(),[s,i]),geo.lMap.setView(v.getObj())}catch(e){console.warn("Error setting view - "+(d=e).message)}if(e<t)return p(e)})))})(0,100,100)}catch(e){console.error("Couldn't create map! "+(d=e).message),console.warn(d.stack)}return stopLoad(),!1}).fail(function(e,t){return console.error(e,t),console.warn("Attempted to do",uri.urlString+"admin-api.php?"+a),stopLoadError("Server error, couldn't perform search")}),!1},doDeepSearch=function(d,e){var p,t,a,o,n,r,s,i,u,m,l,c,h,g,b,f,w,y,v,_,S,k,j,x,C,M,N,T,D,L,O,A,P,R,I,B,E,F,W,V,z,G,U,q,Z,J;null==e&&(e=namedMapAdvSource);try{for(B=getSearchContainsObject(),q=[],_=[],t={n:-90,s:90,e:-180,w:180},h=N=U=0,console.info("Using deep named map "+e),i="",null!=(null!=(L=B.disease_positive)?L.data:void 0)&&(i=">"===B.disease_positive.search_type?"true":"false"),l="",null!=(null!=(O=B.disease_morbidity)?O.data:void 0)&&(">"===B.disease_morbidity.search_type?(l="and fatal = true",c=!0):c=!(l="and fatal = false")),M="",null!=(null!=(A=B.disease)?A.data:void 0)&&(M=function(){switch(B.disease.data){case"Batrachochytrium dendrobatidis":return"bd";case"Batrachochytrium salamandrivorans":return"bsal";default:return""}}()),D={},x=getSearchObject(),g=0,S=d.length;g<S;g++){for(T=d[g],x.bounding_box_n.data>t.n&&(t.n=x.bounding_box_n.data),x.bounding_box_e.data>t.e&&(t.e=x.bounding_box_e.data),x.bounding_box_s.data<t.s&&(t.s=x.bounding_box_s.data),x.bounding_box_w.data<t.w&&(t.w=x.bounding_box_w.data),U+=T.disease_samples,N+=T.disease_positive,E=T.sampled_species.split(","),b=0,k=E.length;b<k;b++)F=(F=E[b]).trim(),indexOf.call(q,F)<0&&q.push(F);if(null==(null!=(P=T.carto_id)?P.table:void 0))try{for(f in n=JSON.parse(T.carto_id),o={},n){Z=n[f],r=f.replace("&#95;","_");try{s=Z.replace("&#95;","_")}catch(e){s=Z}o[r]=s}T.carto_id=o}catch(e){}try{z=(z=T.carto_id.table).unescape()}catch(e){}if(isNull(z))console.warn("Unable to get a table id from this carto data:",T.carto_id);else{try{G={project:T.project_id,table:z},createTemplateByProject(G)}catch(e){console.error("Warning: couldn't create project template: "+(u=e).message),console.warn(u.stack)}y={name:e,type:"namedmap",layers:[{layer_name:"layer-"+_.length}],params:{table_name:z,color:"#FF6600",genus:B.sampled_species.genus,specific_epithet:B.sampled_species.species,disease_detected:i,morbidity:l,pathogen:M}},_.push(y),D[z]={id:T.project_id,name:T.project_title}}d[h]=T,++h}try{a=[[t.n,t.w],[t.n,t.e],[t.s,t.e],[t.s,t.w]],C=getMapCenter(a),J=getMapZoom(a,".map-container"),console.info("Found @ zoom = "+J+" center",C,"for bounding box",a)}catch(e){}W=q.length,console.info("Projects containing your search returned "+U+" ("+N+" positive) among "+W+" species",t),V="Viewing data points",isNull(null!=(R=B.sampled_species)?R.genus:void 0)||(V+=(" of '"+B.sampled_species.genus+" "+B.sampled_species.species+" "+B.sampled_species.subspecies+"'").replace(/( \*)/gim,"")),null!=B.pathogen?B.pathogen.data:"disease",null!=B.disease&&(V+=" for "+B.disease.data),null!=B.disease_positive&&(V+=" with disease status '"+i+"'"),null!=B.disease_morbidity&&(V+=" with morbidity status '"+c+"'"),V+=" in bounds defined by [{lat: "+B.bounding_box_n.data+",lng: "+B.bounding_box_w.data+"},{lat: "+B.bounding_box_s.data+",lng: "+B.bounding_box_e.data+"}]";try{for(resetMap(geo.lMap,!1,!1),I="",w=0,j=_.length;w<j;w++)y=_[w],v={user_name:cartoAccount,type:"namedmap",named_map:y},createRawCartoMap(v),I+="select * from "+y.params.table_name+" where (genus ilike '%"+y.params.genus+"%' and specificepithet ilike '%"+y.params.specific_epithet+"%' and diseasedetected ilike '%"+y.params.disease_detected+"%' and diseasetested ilike '%"+y.params.pathogen+"%' and decimallatitude between "+t.s+" and "+t.n+" and decimallongitude between "+t.w+" and "+t.e+");";$("#post-map-subtitle").text(V),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),p="action=fetch&sql_query="+post64(I),$.post(uri.urlString+"api.php",p,"json").done(function(t){var a,e,o,n,r,s,i,l,c;console.info("Detailed results: ",t);try{for(d=Object.toArray(t.parsed_responses),getSampleSummaryDialog(d,D),a=[],n=0,e=d.length;n<e;n++)for(c=d[n],l=Object.toArray(c.rows),r=0,o=l.length;r<o;r++)s={lat:(i=l[r]).decimallatitude,lng:i.decimallongitude},a.push(canonicalizePoint(s));J=getMapZoom(a,".map-container"),C=getMapCenter(a),console.info("Recalculate data zoom = "+J+" center",C,"for points array",a);try{null!=geo.lMap&&(geo.lMap.once("zoomend",function(){return console.info("ZoomEnd is ensuring centering"),m(0)}),geo.lMap.setZoom(J));try{p$("#global-data-map").latitude=C.lat,p$("#global-data-map").longitude=C.lng,p$("#global-data-map").zoom=J}catch(e){}try{geo.lMap.setView(C.getObj())}catch(e){console.warn("Failed to recenter map - "+(u=e).message,a),console.warn(u.stack)}}catch(e){console.warn("Failed to rezoom/recenter map - "+(u=e).message,a),console.warn(u.stack)}}catch(e){console.error("Couldn't parse responses from server: "+(u=e).message),console.warn(u.stack),console.log("Got",t),console.debug(uri.urlString+"api.php?"+p)}return!1}).fail(function(e,t){return console.error("Couldn't fetch detailed results")}),(m=function(e,t,a){var o,n,r,s,i,l,c;l=roundNumber(C.lat,3),c=roundNumber(C.lng,3);try{o={type:"google-map-element",lat:n=roundNumber(p$("#global-data-map").latitude,3),lng:r=roundNumber(p$("#global-data-map").longitude,3)}}catch(e){}try{o=geo.lMap.getCenter(),n=roundNumber(o.lat,3),r=roundNumber(o.lng,3)}catch(e){}return s=100*Math.abs((n-l)/l),i=100*Math.abs((r-c)/c),s<2&&i<2&&5<e?(console.info("Correctly centered",C,o,[s,i]),geo.lMap.getZoom()!==J&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(e<=15||console.warn("Centering too deviant",s<2,i<2,s<2&&i<2,n,r,l,c),isNumber(t)||(t=100),t<e?(console.info("Map could not be correctly centered in "+a*t+"ms"),clearTimeout(_adp.centerTimeout),!1):(++e,_adp.centerTimeout=delay(a,function(){isNumber(t)||(t=100);try{p$("#global-data-map").latitude=C.lat,p$("#global-data-map").longitude=C.lng}catch(e){}try{console.log("#"+e+"/"+t+" Deep setting view to",C.getObj(),[s,i]),geo.lMap.setView(C.getObj())}catch(e){console.warn("Error setting view - "+(u=e).message)}if(e<t)return m(e)})))})(0,100,100)}catch(e){console.error("Couldn't create map! "+(u=e).message),console.warn(u.stack)}stopLoad()}catch(e){u=e,stopLoadError("There was a problem performing a sample search"),console.error("Problem performing sample search! "+u.message),console.warn(u.stack)}return!1},showAllTables=function(){var e;return console.log("Starting table list"),e=uri.urlString+"admin-api.php","perform=list",$.post(e,"perform=list","json").done(function(e){var t,a,o,n,r,s,i,l,c,d,p,u;if(!1===e.status)return console.error("Got bad result",e),!1;for(d in console.info("Good result",e),l=[],u=[],n=0,t=e.carto_table_map){if(p=(a=t[d]).table,console.log("Colors",a.creation,generateColorByRecency2(a.creation)),isNull(p))console.warn("Bad table #"+n,p);else{p=p.unescape();try{createTemplateByProject({project:d,table:p},!0)}catch(e){}u.push(p),s={name:namedMapSource,type:"namedmap",layers:[{layer_name:"layer-"+l.length,interactivity:"cartodb_id, id, diseasedetected, genus, specificepithet, dateidentified"}],params:{table_name:p,color:generateColorByRecency2(a.creation)}},l.push(s)}++n}console.info("Got tables",u),console.info("Got layers",l);try{for(r=0,c=l.length;r<c;r++)s=l[r],i={user_name:cartoAccount,type:"namedmap",named_map:s},console.log("Creating raw map from",i),createRawCartoMap(i)}catch(e){console.error("Couldn't create map! "+(o=e).message),console.warn(o.stack)}return!1}).error(function(e,t){return console.error("AJAX failure showing tables",e,t)}),!1},resetMap=function(t,e,a){var o,n,r,s,i,l;if(null==t&&(t=geo.lMap),null==e&&(e=!0),null==a&&(a=!0),null==geo.mapSublayers)return console.error("geo.mapSublayers is not defined."),!1;try{for(i=geo.mapSublayers,n=0,s=i.length;n<s;n++)i[n].remove()}catch(e){for(o in l=t._layers){r=l[o];try{if(-1===r._url.search("arcgisonline"))try{r.removeLayer()}catch(e){r.remove()}}catch(e){}}}return $("#post-map-subtitle").removeClass("bg-success").addClass("text-muted").text(""),a&&(geo.lMap.setZoom(geo.defaultLeafletOptions.zoom),geo.lMap.panTo(geo.defaultLeafletOptions.center)),e&&(showAllTables(),$("#post-map-subtitle").text("All Projects")),!1},getPrettySpecies=function(e){var t,a,o,n,r,s;return t=e.genus,r=null!=(o=e.specificEpithet)?o:e.specificepithet,s=null!=(n=e.infraspecificEpithet)?n:e.infraspecificEpithet,a=t,isNull(r)||(a+=" "+r,isNull(s)||(a+=" "+s)),a},generateColorByRecency=function(e,t){var a,o,n,r,s,i,l,c,d,p,u;if(null==t&&(t=1420070400),isNumber(e)||(e=new Date(e).getTime()/1e3),e>Date.now()/1e3&&(e/=1e3),(d=e-t)<(a=Date.now()/1e3-e))"#000000";else{for(p=(p=(r=o=255)-(u=a/(d/765)))<0?0:toInt(p),255<u&&(r=(r=510-u)<0?0:toInt(r),510<u&&(o=(o=765-u)<0?0:toInt(o))),console.log("Base channels",p,r,o),l=i=0,c=(s=[p.toString(16),r.toString(16),o.toString(16)]).length;l<c;l++)1===(n=s[l]).length&&(s[i]="0"+n),++i;"#"+s.join("")}return"#ff0000"},generateColorByRecency2=function(e,t){var a,o,n,r,s,i,l,c,d,p,u;if(null==t&&(t=1420070400),isNumber(e)||(e=new Date(e).getTime()/1e3),e>Date.now()/1e3&&(e/=1e3),(p=e-t)<(a=Date.now()/1e3-e))n="#000000";else{for(s=(u=255-a/(p/765))<0?0-u:255-u,u=u<0?0:toInt(u),o=255<s?toInt(s-255):0,s=255<s?255-(s-255):toInt(s),o=o<0?0:toInt(o),console.log("Base channels 2",u,s,o),c=l=0,d=(i=[u.toString(16),s.toString(16),o.toString(16)]).length;c<d;c++)1===(r=i[c]).length&&(i[l]="0"+r),++l;n="#"+i.join("")}return console.log("Recency2 generated",i,n),n="#ff0000"},getProjectResultDialog=function(e){var t,a,o,n,r,s,i,l,c;if(isArray(e)||(e=Object.toArray(e)),0===e.length)return console.warn("There were no projects in the result list"),!1;for(l=[],r=0,s=e.length;r<s;r++)t=(i=e[r]).includes_anura?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",a=i.includes_caudata?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",o=i.includes_gymnophiona?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",c="<tr>\n  <td>"+i.project_title+'</td>\n  <td class="text-center">'+t+'</td>\n  <td class="text-center">'+a+'</td>\n  <td class="text-center">'+o+'</td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" title="Visit Project" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+i.project_id+'" icon="icons:arrow-forward"></paper-icon-button></td>\n</tr>',l.push(c);return n='<paper-dialog id="modal-project-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    <div>\n      <table class="table table-striped">\n        <tr>\n          <th>Project Name</th>\n          <th>Caudata</th>\n          <th>Anura</th>\n          <th>Gymnophiona</th>\n          <th>Visit</th>\n        </tr>\n        '+l.join("\n")+'\n      </table>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#modal-project-list").remove(),$("body").append(n),$("#modal-project-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").unbind().click(function(){return console.log("Calling dialog helper"),safariDialogHelper("#modal-project-list",0,function(){return console.info("Successfully opened dialog"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden")})}),bindClicks(),console.info("Generated project result list"),!1},getSampleSummaryDialog=function(t,a){var o,n,r,s,i,l,c,d,p,u,m,h,g,b,f,e,w,y,v,_,S,k,j,x,C,M,N,T,D,L,O;T=Date.now();try{console.info("Starting Web Worker to do hard work"),e={action:"summary-dialog",resultsList:t,tableToProjectMap:a,windowWidth:$(window).width()},(O=new Worker("js/global-search-worker.min.js")).addEventListener("message",function(e){var t,a;return t=e.data.html,a=e.data.summaryRowData,console.info("Web worker returned",e.data),console.log("Sending to setupDisplay",a),M(t,a)}),O.postMessage(e)}catch(e){if(e,console.warn("Warning: This browser doesn't support Web Workers. Using fallback."),isArray(t)||(t=Object.toArray(t)),0===t.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from",t),_=[],f=[],p=0,L=["cartodb_id","the_geom","the_geom_webmercator","id"],window.dataSummary={species:[],diseases:[],data:{}},u=0,h=t.length;u<h;u++){v=t[u],++p,s=.5*$(window).width(),i=.3*$(window).width();try{C=v.rows;try{for(b in o={},S=v.rows){for(x=S[b],m=0,g=L.length;m<g;m++)delete x[L[m]];(o[b]=x).carto_table=v.table,x.project_id=v.project_id,N=getPrettySpecies(x),indexOf.call(dataSummary.species,N)<0&&dataSummary.species.push(N),n=x.diseasetested,indexOf.call(dataSummary.diseases,n)<0&&dataSummary.diseases.push(n),isNull(dataSummary.data[N])&&(dataSummary.data[N]={}),isNull(dataSummary.data[N][n])&&(dataSummary.data[N][n]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),x.diseasedetected.toBool()?dataSummary.data[N][n].positive++:"no_confidence"===x.diseasedetected.toLowerCase()?dataSummary.data[N][n].no_confidence++:dataSummary.data[N][n].negative++,dataSummary.data[N][n].samples++,w=dataSummary.data[N][n].positive/dataSummary.data[N][n].samples,dataSummary.data[N][n].prevalence=w,f.push(x)}C=o}catch(e){for(b in k=v.rows)(x=k[b]).carto_table=v.table,x.project_id=v.project_id,f.push(x)}if(r=JSON.stringify(C),isNull(r)){console.warn("Got bad data for row #"+p+"!",v,v.rows,r);continue}r=""+r}catch(e){r="Invalid data from server"}y=a[v.table],x='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+s+"px;min-width:"+i+'px">'+r+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+y.id+'" icon="icons:arrow-forward" title="'+y.name+'"></paper-icon-button></td>\n</tr>',_.push(x)}for(N in window.summaryTableRows={},j=dataSummary.data)for(l in c=j[N])r=c[l],null==summaryTableRows[l]&&(summaryTableRows[l]=[]),w=100*r.prevalence,w=roundNumberSigfig(w,2),summaryTableRows[l].push("<tr>\n  <td>"+N+"</td>\n  <td>"+r.samples+"</td>\n  <td>"+r.positive+"</td>\n  <td>"+r.negative+"</td>\n  <td>"+w+"%</td>\n</tr>");for(l in D="",summaryTableRows)D+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+l+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+summaryTableRows[l].join("\n")+"\n    </table>\n  </div>\n</div>";d='<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+D+'\n    <div class="row">\n      <div class="col-xs-12">\n        <h3>Raw Data For Developers</h3>\n        <table class="table table-striped">\n          <tr>\n            <th colspan="4">Query Data (JSON)</th>\n            <th>Visit Project</th>\n          </tr>\n          '+_.join("\n")+'\n        </table>\n      </div>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',M(d,f)}return!(M=function(e,t){var a,o,n,r,s,i;a="#generate-download",$("#modal-sql-details-list").remove(),$("body").append(e),console.log("SetupDisplay about to generate using",t),$(a).click(function(){return generateCSVFromResults(t,this)});try{generateCSVFromResults(t,document.getElementById(a.slice(1)))}catch(e){}for(r=0,s=(i=$(".code-box")).length;r<s;r++){o=i[r];try{Prism.highlightElement(o,!0)}catch(e){}}return $("#modal-sql-details-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").remove(),'<paper-icon-button class="show-result-list" icon="editor:insert-chart" data-toggle="tooltip" title="Show Sample Details" raised></paper-icon-button>',$("#post-map-subtitle").append('<paper-icon-button class="show-result-list" icon="editor:insert-chart" data-toggle="tooltip" title="Show Sample Details" raised></paper-icon-button>'),$(".show-result-list").unbind().click(function(){var e;return animateLoad(),e=Date.now(),console.log("Calling dialog helper"),safariDialogHelper("#modal-sql-details-list",0,function(){var t,a;return a=Date.now()-e,console.info("Successfully opened dialog in "+a+"ms via safariDialogHelper"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden"),p=0,100,3e4,(t=function(){return delay(100,function(){var e;return 100*++p<3e4&&!$("#modal-sql-details-list").isVisible()?t():(stopLoad(),500<(e=100*p-50+a)?console.warn("It took about "+e+"ms to render the dialog visible!"):console.info("Dialog ready in about "+e+"ms"))})})()})}),bindClicks(),n=Date.now()-T,console.info("Generated project result list in "+n+"ms")})},createOverflowMenu=function(){return checkLoggedIn(function(e){var t,a;return a='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+(t=e.status?'<paper-menu class="dropdown-content">\n<paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"")+'\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n      <paper-item data-href="'+uri.urlString+'dashboard.php" class="click">\n        <iron-icon icon="icons:donut-small"></iron-icon>\n        Data Dashboard\n      </paper-item>\n    <paper-item data-function="firstLoadInstructionPrompt" data-args="true" class="click">\n      Show Welcome\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(a),isNull(t)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1},firstLoadInstructionPrompt=function(t){var a,o;null==t&&(t=!1),o=uri.domain+"_firstLoadPrompt";try{a=$.cookie(o).toBool()}catch(e){a=!1}return!t&&a||(a&&console.info("Forced to continue showing prompt to user who has seen it already"),checkLoggedIn(function(e){return e.status&&(console.info("User is logged in, and does not need an instruction prompt"),$.cookie(o,!0),a=!0),!(a&&!t)&&(a&&console.warn("Force-showing the prompt to a logged in user"),'<div class="alert alert-warning alert-dismissable slide-alert slide-out" role="alert" id="first-load-prompt">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <div class="alert-message">\n    <p class="center-block text-center"><strong>Welcome!</strong></p>\n    <p>\n      Need help getting started? We\'ve put together some resources for you below.\n    </p>\n    <div class="center-block text-center">\n      <a href="http://updates.amphibiandisease.org/portal/2016/06/30/Uploadingdata.html" class="btn btn-default click" data-newtab="true">Get Involved</a>  <a href="http://updates.amphibiandisease.org/posts/" class="click btn btn-default" data-newtab="true">Learn More</a>  <a href="https://amphibian-disease-tracker.readthedocs.io/en/latest/User%20Workflow/" class="btn btn-default click" data-newtab="true">Read Documentation</a>\n    </div>\n    <p>\n      You can also find these resources by scrolling down on this page later.\n    </p>\n  </div>\n</div>',$("#first-load-prompt").remove(),$("body").append('<div class="alert alert-warning alert-dismissable slide-alert slide-out" role="alert" id="first-load-prompt">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <div class="alert-message">\n    <p class="center-block text-center"><strong>Welcome!</strong></p>\n    <p>\n      Need help getting started? We\'ve put together some resources for you below.\n    </p>\n    <div class="center-block text-center">\n      <a href="http://updates.amphibiandisease.org/portal/2016/06/30/Uploadingdata.html" class="btn btn-default click" data-newtab="true">Get Involved</a>  <a href="http://updates.amphibiandisease.org/posts/" class="click btn btn-default" data-newtab="true">Learn More</a>  <a href="https://amphibian-disease-tracker.readthedocs.io/en/latest/User%20Workflow/" class="btn btn-default click" data-newtab="true">Read Documentation</a>\n    </div>\n    <p>\n      You can also find these resources by scrolling down on this page later.\n    </p>\n  </div>\n</div>'),bindClicks(),$("#first-load-prompt").removeClass("slide-out").addClass("slide-in"),$.cookie(o,!0))})),!1},$(function(){var t,e,a,o,n;return geo.initLocation(),o={center:[17.811456088564483,-37.265625],zoom:2},geo.defaultLeafletOptions=o,e=new L.Map("global-map-container",o),a={attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"},geo.tileLayer=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",a),geo.tileLayer.addTo(e),geo.lMap=e,geo.tileLayer.on("load",function(){return console.info("Map ready"),firstLoadInstructionPrompt()}),$(".coord-input").keyup(function(){return checkCoordinateSanity()}),t=function(e,t){var a,o;if(null==t&&(t=!1),!checkCoordinateSanity())return toastStatusMessage("Please check your coordinates"),!1;o=getSearchObject();try{try{a=$(e).attr("data-deep").toBool()}catch(e){a=!1}t&&(a=!0),a&&(o=getSearchContainsObject())}catch(e){a=!1}return doSearch(o,a),!1},$("input.submit-project-search").keyup(function(e){return 13===(e.keyCode?e.keyCode:e.which)&&t(null,!0)}),$(".do-search").click(function(){return t(this)}),$("#reset-global-map").click(function(){return resetMap(),!1}),$("#toggle-global-search-filters").click(function(){var e,t;return t=p$("#global-search-filters").opened,p$("#global-search-filters").toggle(),e=t?"Show":"Hide",$(this).find(".action-word").text(e),!1}),$("#use-viewport-bounds").on("iron-change",function(){return p$("#use-viewport-bounds").checked?setViewerBounds():(console.debug("Resetting search bounds on uncheck"),$("#north-coordinate").val(90),$("#west-coordinate").val(-180),$("#south-coordinate").val(-90),$("#east-coordinate").val(180)),!1}),n=function(){return p$("#use-viewport-bounds").checked?(console.info("Setting viewer bounds, checkbox is checked"),setViewerBounds()):console.info("Not using viewport bounds")},geo.lMap.on("moveend",function(){return n()}).on("zoomend",function(){return n()}),showAllTables(),checkFileVersion(!1,"js/global-search.min.js"),$("#show-more-tips").click(function(){var e,t;return e=!p$("#more-tips").opened,p$("#more-tips").toggle(),t=e?"Fewer tips...":"More tips...",$("#show-more-tips").text(t)}),$("#reset-global-map").contextmenu(function(){var e,t,a,o;for(resetMap(),$("#taxa-input").val(""),p$("#use-viewport-bounds").checked=!0,e=0,t=(o=$("paper-radio-group")).length;e<t;e++){a=o[e];try{p$(a).selectIndex(0)}catch(e){}}return!1}),createOverflowMenu(),!1});
//# sourceMappingURL=global-search.min.js.map