var checkCoordinateSanity,createOverflowMenu,createTemplateByProject,doDeepSearch,doSearch,firstLoadInstructionPrompt,generateColorByRecency,generateColorByRecency2,getPrettySpecies,getProjectResultDialog,getSampleSummaryDialog,getSearchContainsObject,getSearchObject,namedMapAdvSource,namedMapSource,resetMap,setViewerBounds,showAllTables,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};namedMapSource="adp_generic_heatmap-v16",namedMapAdvSource="adp_specific_heatmap-v15";try{p$("#exact-species-search").checked&&(namedMapAdvSource="adp_specific_exact_heatmap-v1")}catch(a){}checkCoordinateSanity=function(){var a,b;return b=!0,a={n:toFloat($("#north-coordinate").val()),w:toFloat($("#west-coordinate").val()),s:toFloat($("#south-coordinate").val()),e:toFloat($("#east-coordinate").val())},console.log("User Bounds",a),a.n>a.s||(b=!1,$(".lat-input").parent().addClass("has-error")),a.e>a.w||(b=!1,$(".lng-input").parent().addClass("has-error")),b?($(".coord-input").parent().removeClass("has-error"),$(".do-search").removeAttr("disabled"),!0):($(".do-search").attr("disabled","disabled"),!1)},createTemplateByProject=function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a&&(a="t2627cbcbb4d7597f444903b2e7a5ce5c_6d6d454828c05e8ceea03c99cc5f5"),null==b&&(b=!1),j=Date.now(),null==(null!=(i=window._adp)?i.templateReady:void 0)&&(null==window._adp&&(window._adp={}),window._adp.templateReady={},window._adp.templates={}),f=!1,"object"==typeof a){if(isNull(a.table))return console.error("Couldn't create template for project -- undefined table",a),!1;isNull(a.project)?a=a.table:(g=a.project,a=a.table,f=!0)}if(k="infowindow_template_"+a.slice(0,63),$("#"+k).exists()){if(b)return"function"==typeof c&&c(),!1;$("#"+k).remove()}return window._adp.templateReady[a]=!1,h="SELECT cartodb_id FROM "+a+" LIMIT 1",d="action=fetch&sql_query="+post64(h),e=function(a,d,e){var f,g,h;return f=b?"":'<p>Tested {{content.data.diseasetested}} as <strong>{{content.data.diseasedetected}}</strong> (Fatal: <strong>{{content.data.fatal}}</strong>)</p><p><span class="date-group">Sample was taken in <span class="unix-date">{{content.data.dateidentified}}</span>.</span></p>',h='<script type="infowindow/html" id="'+d+'">\n  <div class="cartodb-popup v2">\n    <a href="#close" class="cartodb-popup-close-button close">x</a>\n    <div class="cartodb-popup-content-wrapper">\n      <div class="cartodb-popup-header">\n        <h2>Sample Info</h2>\n      </div>\n      <div class="cartodb-popup-content">\n        \x3c!-- content.data contains the field info --\x3e\n        <h4>Species: </h4>\n        <p><i>{{content.data.genus}} {{content.data.specificepithet}}</i></p>\n        '+f+'\n        <p><a href="https://amphibiandisease.org/project.php?id='+a+'">View Project</a></p>\n      </div>\n    </div>\n    <div class="cartodb-popup-tip-container"></div>\n  </div>\n<\/script>',$("head").append(h),window._adp.templates[e]=h,window._adp.templates[e.slice(0,63)]=h,window._adp.templateReady[e]=!0,g=Date.now()-j,console.info("Template set for #"+d+" (took "+g+"ms)"),"function"==typeof c&&c(),!1},f?(console.info("Directly provided project id"),e(g,k,a),!1):(console.info("Creating template after pinging API endpoint"),$.post(uri.urlString+"api.php",d,"json").done(function(b){var c,d,f;return c=null!=(d=b.parsed_responses)&&null!=(f=d[0])?f.project_id:void 0,isNull(c)?console.warn("Couldn't find project ID for table "+a,b):e(c,k,a)}),!1)},setViewerBounds=function(a){var b,c,d;return null==a&&(a=geo.lMap),b=a.getBounds(),d=b._southWest,c=b._northEast,c.lng-d.lng>360&&(d.lng=-180,c.lng=180),$("#north-coordinate").val(c.lat),$("#west-coordinate").val(d.lng),$("#south-coordinate").val(d.lat),$("#east-coordinate").val(c.lng),!1},getSearchObject=function(){var a,b,c,d,e;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(a){}return a={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},e={sampled_species:{data:$("#taxa-input").val().toLowerCase()},bounding_box_n:{data:a.n,search_type:"<="},bounding_box_e:{data:a.e,search_type:"<="},bounding_box_w:{data:a.w,search_type:">="},bounding_box_s:{data:a.s,search_type:">="}},b=$(p$("#disease-status").selectedItem).attr("data-search"),"*"!==b&&(e.disease_positive={data:0,search_type:b.toBool()?">":"="}),c=$(p$("#morbidity-status").selectedItem).attr("data-search"),"*"!==c&&(e.disease_morbidity={data:0,search_type:c.toBool()?">":"="}),d=$(p$("#pathogen-choice").selectedItem).attr("data-search"),"*"!==d&&(e.disease={data:d}),e},getSearchContainsObject=function(){var a,b,c,d,e,f,g,h,i,j;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(a){}return a={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},i=$("#taxa-input").val().toLowerCase(),j=i.split(" "),h=3===j.length?j.pop():"",g=2===j.length?j.pop():"",c=1===j.length?j.pop():"",f={sampled_species:{data:i,genus:c,species:g,subspecies:h},bounding_box_n:{data:a.s,search_type:">"},bounding_box_e:{data:a.w,search_type:">"},bounding_box_w:{data:a.e,search_type:"<"},bounding_box_s:{data:a.n,search_type:"<"}},b=$(p$("#disease-status").selectedItem).attr("data-search"),"*"!==b&&(f.disease_positive={data:0,search_type:b.toBool()?">":"="}),d=$(p$("#morbidity-status").selectedItem).attr("data-search"),"*"!==d&&(f.disease_morbidity={data:0,search_type:d.toBool()?">":"="}),e=$(p$("#pathogen-choice").selectedItem).attr("data-search"),"*"!==e&&(f.disease={data:e}),f},doSearch=function(a,b,c){var d,e,f,g;return null==a&&(a=getSearchObject()),null==b&&(b=!1),null==c&&(c=!1),startLoad(),$("#post-map-subtitle").removeClass("bg-success"),f=jsonTo64(a),d="advanced_project_search",g=b?namedMapAdvSource:namedMapSource,e="perform="+d+"&q="+f,$.post(uri.urlString+"admin-api.php",e,"json").done(function(d){var e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U;if(console.info("Adv. search result",d),!0!==d.status)return console.error(d.error),stopLoadError("There was a problem fetching the results"),!1;if(G=Object.toArray(d.result),0===G.length)return I=function(b){var c,d;return null==b&&(b=!1),console.warn("The search failed!"),isNull(null!=(d=a.sampled_species)?d.data:void 0)||(c='<span id="taxa-input-error" class="help-block">\n  Invalid taxon: Please check your spelling. <a href="http://amphibiaweb.org/search/index.html" class="click" data-newtab="true">Check AmphibiaWeb for valid taxa</a>\n</span>',b&&(c='<span id="taxa-input-error" class="help-block">\n  No matching samples found.\n</span>'),$("#taxa-input-container").addClass("has-error"),$("#taxa-input-error").remove(),$("#taxa-input").attr("aria-describedby","taxa-input-error").after(c).keyup(function(){try{return $("#taxa-input-container").removeClass("has-error"),$("#taxa-input-error").remove()}catch(a){}}),bindClicks()),console.warn("No results"),stopLoadError("No results"),!1},isNull(null!=(B=a.sampled_species)?B.data:void 0)||c?(console.warn("No need to validate",isNull(null!=(E=a.sampled_species)?E.data:void 0),c),I(!0)):(console.warn("The initial search failed, we're going to validate the taxon and re-check"),P=a.sampled_species.data,O=P.split(" "),N={genus:null!=(C=O[0])?C:"",species:null!=(D=O[1])?D:""},validateAWebTaxon(N,function(a){var c,d;return!0===a.invalid?(console.error("This taxon is invalid!",a),I(),!1):(d=a.genus+" "+a.species+" "+(null!=(c=a.subspecies)?c:""),d=d.trim(),$("#taxa-input").val(d),doSearch(getSearchObject(),b,!0),!1)})),!1;if(b)return doDeepSearch(G,g),!1;for(R=0,z=0,S=[],u=[],e={n:-90,s:90,e:-180,w:180},o=0,console.info("Using standard named map "+g),p=0,v=G.length;p<v;p++){for(A=G[p],A.bounding_box_n>e.n&&(e.n=A.bounding_box_n),A.bounding_box_e>e.e&&(e.e=A.bounding_box_e),A.bounding_box_s<e.s&&(e.s=A.bounding_box_s),A.bounding_box_w<e.w&&(e.w=A.bounding_box_w),R+=A.disease_samples,z+=A.disease_positive,J=A.sampled_species.split(","),q=0,w=J.length;q<w;q++)K=J[q],K=K.trim(),indexOf.call(S,K)<0&&S.push(K);if(null==(null!=(F=A.carto_id)?F.table:void 0))try{i=JSON.parse(A.carto_id),h={};for(r in i){T=i[r],j=r.replace("&#95;","_");try{k=T.replace("&#95;","_")}catch(a){k=T}h[j]=k}A.carto_id=h}catch(a){}try{M=A.carto_id.table,M=M.unescape()}catch(a){}if(isNull(M))console.warn("Unable to get a table id from this carto data:",A.carto_id);else{try{Q={project:A.project_id,table:M},createTemplateByProject(Q)}catch(a){m=a,console.error("Warning: couldn't create project template: "+m.message),console.warn(m.stack)}t={name:g,type:"namedmap",layers:[{layer_name:"layer-"+u.length}],params:{table_name:M,color:"#FF6600"}},u.push(t)}G[o]=A,++o}try{f=[[e.n,e.w],[e.n,e.e],[e.s,e.e],[e.s,e.w]],y=getMapCenter(f),U=getMapZoom(f,".map-container"),console.info("Found @ zoom = "+U+" center",y,"for bounding box",f),null!=geo.lMap&&(geo.lMap.once("zoomend",function(a){return function(){return console.info("ZoomEnd is ensuring centering"),n(0)}}()),geo.lMap.setZoom(U));try{p$("#global-data-map").latitude=y.lat,p$("#global-data-map").longitude=y.lng,p$("#global-data-map").zoom=U}catch(a){}try{geo.lMap.setView(y.getObj())}catch(a){}}catch(a){m=a,console.warn("Failed to rezoom/recenter map - "+m.message,f),console.warn(m.stack)}L=S.length,console.info("Projects containing your search returned "+R+" ("+z+" positive) among "+L+" species",e);try{for(resetMap(geo.lMap,!1,!1),s=0,x=u.length;s<x;s++)t=u[s],(l=function(a,b){var c,d,e,f;return!0===(null!=(e=window._adp)&&null!=(f=e.templateReady)?f[b.params.table_name]:void 0)||(a>50?(console.error("Error -- timed out waiting for template to be ready"),d=!0):d=!1,d)?(console.info("Template script ready for table '"+window._adp.templateReady[b.params.table_name]+"' after "+a+" iterations, rendering on map"),c={user_name:cartoAccount,type:"namedmap",named_map:b},createRawCartoMap(c),!1):(delay(50,function(){return++a,l(a,b)}),!1)})(0,t);$("#post-map-subtitle").text("Viewing projects containing "+R+" samples ("+z+" positive) among "+L+" species"),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),$(".show-result-list").remove(),H='<paper-icon-button class="show-result-list" icon="icons:subject" data-toggle="tooltip" title="Show Project list" raised></paper-icon-button>',$("#post-map-subtitle").append(H),getProjectResultDialog(G),(n=function(a,b,c){var d,e,f,g,h,i,j,k;i=roundNumber(y.lat,3),j=roundNumber(y.lng,3);try{e=roundNumber(p$("#global-data-map").latitude,3),f=roundNumber(p$("#global-data-map").longitude,3),d={type:"google-map-element",lat:e,lng:f}}catch(a){}try{d=geo.lMap.getCenter(),e=roundNumber(d.lat,3),f=roundNumber(d.lng,3)}catch(a){}return g=100*Math.abs((e-i)/i),h=100*Math.abs((f-j)/j),g<2&&h<2&&a>5?(console.info("Correctly centered",y,d,[g,h]),geo.lMap.getZoom()!==U&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(a<=15||console.warn("Centering too deviant",g<2,h<2,g<2&&h<2,e,f,i,j),isNumber(b)||(b=100),a>b?(k=c*b,console.info("Map could not be correctly centered in "+k+"ms"),clearTimeout(_adp.centerTimeout),!1):(++a,_adp.centerTimeout=delay(c,function(){isNumber(b)||(b=100);try{p$("#global-data-map").latitude=y.lat,p$("#global-data-map").longitude=y.lng}catch(a){}try{console.log("#"+a+"/"+b+" General setting view to",y.getObj(),[g,h]),geo.lMap.setView(y.getObj())}catch(a){m=a,console.warn("Error setting view - "+m.message)}if(a<b)return n(a)})))})(0,100,100)}catch(a){m=a,console.error("Couldn't create map! "+m.message),console.warn(m.stack)}return stopLoad(),!1}).fail(function(a,b){return console.error(a,b),console.warn("Attempted to do",uri.urlString+"admin-api.php?"+e),stopLoadError("Server error, couldn't perform search")}),!1},doDeepSearch=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X;null==b&&(b=namedMapAdvSource);try{for(L=getSearchContainsObject(),U=0,C=0,V=[],v=[],d={n:-90,s:90,e:-180,w:180},o=0,console.info("Using deep named map "+b),j="",null!=(null!=(F=L.disease_positive)?F.data:void 0)&&(j=">"===L.disease_positive.search_type?"true":"false"),m="",null!=(null!=(G=L.disease_morbidity)?G.data:void 0)&&(">"===L.disease_morbidity.search_type?(m="and fatal = true",n=!0):(m="and fatal = false",n=!1)),B="",null!=(null!=(H=L.disease)?H.data:void 0)&&(B=function(){switch(L.disease.data){case"Batrachochytrium dendrobatidis":return"bd";case"Batrachochytrium salamandrivorans":return"bsal";default:return""}}()),E={},z=getSearchObject(),p=0,w=a.length;p<w;p++){for(D=a[p],z.bounding_box_n.data>d.n&&(d.n=z.bounding_box_n.data),z.bounding_box_e.data>d.e&&(d.e=z.bounding_box_e.data),z.bounding_box_s.data<d.s&&(d.s=z.bounding_box_s.data),z.bounding_box_w.data<d.w&&(d.w=z.bounding_box_w.data),U+=D.disease_samples,C+=D.disease_positive,M=D.sampled_species.split(","),q=0,x=M.length;q<x;q++)O=M[q],O=O.trim(),indexOf.call(V,O)<0&&V.push(O);if(null==(null!=(I=D.carto_id)?I.table:void 0))try{g=JSON.parse(D.carto_id),f={};for(r in g){W=g[r],h=r.replace("&#95;","_");try{i=W.replace("&#95;","_")}catch(a){i=W}f[h]=i}D.carto_id=f}catch(a){}try{R=D.carto_id.table,R=R.unescape()}catch(a){}if(isNull(R))console.warn("Unable to get a table id from this carto data:",D.carto_id);else{try{T={project:D.project_id,table:R},createTemplateByProject(T)}catch(a){k=a,console.error("Warning: couldn't create project template: "+k.message),console.warn(k.stack)}t={name:b,type:"namedmap",layers:[{layer_name:"layer-"+v.length}],params:{table_name:R,color:"#FF6600",genus:L.sampled_species.genus,specific_epithet:L.sampled_species.species,disease_detected:j,morbidity:m,pathogen:B}},v.push(t),E[R]={id:D.project_id,name:D.project_title}}a[o]=D,++o}try{e=[[d.n,d.w],[d.n,d.e],[d.s,d.e],[d.s,d.w]],A=getMapCenter(e),X=getMapZoom(e,".map-container"),console.info("Found @ zoom = "+X+" center",A,"for bounding box",e)}catch(a){}P=V.length,console.info("Projects containing your search returned "+U+" ("+C+" positive) among "+P+" species",d),Q="Viewing data points",isNull(null!=(J=L.sampled_species)?J.genus:void 0)||(N=" of '"+L.sampled_species.genus+" "+L.sampled_species.species+" "+L.sampled_species.subspecies+"'",Q+=N.replace(/( \*)/gim,"")),null!=L.pathogen?L.pathogen.data:"disease",null!=L.disease&&(Q+=" for "+L.disease.data),null!=L.disease_positive&&(Q+=" with disease status '"+j+"'"),null!=L.disease_morbidity&&(Q+=" with morbidity status '"+n+"'"),Q+=" in bounds defined by [{lat: "+L.bounding_box_n.data+",lng: "+L.bounding_box_w.data+"},{lat: "+L.bounding_box_s.data+",lng: "+L.bounding_box_e.data+"}]";try{for(resetMap(geo.lMap,!1,!1),K="",s=0,y=v.length;s<y;s++)t=v[s],u={user_name:cartoAccount,type:"namedmap",named_map:t},createRawCartoMap(u),S="select * from "+t.params.table_name+" where (genus ilike '%"+t.params.genus+"%' and specificepithet ilike '%"+t.params.specific_epithet+"%' and diseasedetected ilike '%"+t.params.disease_detected+"%' and diseasetested ilike '%"+t.params.pathogen+"%' and decimallatitude between "+d.s+" and "+d.n+" and decimallongitude between "+d.w+" and "+d.e+");",K+=S;$("#post-map-subtitle").text(Q),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),c="action=fetch&sql_query="+post64(K),$.post(uri.urlString+"api.php",c,"json").done(function(b){var d,e,f,g,h,i,j,m,n;console.info("Detailed results: ",b);try{for(a=Object.toArray(b.parsed_responses),getSampleSummaryDialog(a,E),d=[],g=0,e=a.length;g<e;g++)for(n=a[g],m=Object.toArray(n.rows),h=0,f=m.length;h<f;h++)j=m[h],i={lat:j.decimallatitude,lng:j.decimallongitude},d.push(canonicalizePoint(i));X=getMapZoom(d,".map-container"),A=getMapCenter(d),console.info("Recalculate data zoom = "+X+" center",A,"for points array",d);try{null!=geo.lMap&&(geo.lMap.once("zoomend",function(a){return function(){return console.info("ZoomEnd is ensuring centering"),l(0)}}()),geo.lMap.setZoom(X));try{p$("#global-data-map").latitude=A.lat,p$("#global-data-map").longitude=A.lng,p$("#global-data-map").zoom=X}catch(a){}try{geo.lMap.setView(A.getObj())}catch(a){k=a,console.warn("Failed to recenter map - "+k.message,d),console.warn(k.stack)}}catch(a){k=a,console.warn("Failed to rezoom/recenter map - "+k.message,d),console.warn(k.stack)}}catch(a){k=a,console.error("Couldn't parse responses from server: "+k.message),console.warn(k.stack),console.log("Got",b),console.debug(uri.urlString+"api.php?"+c)}return!1}).fail(function(a,b){return console.error("Couldn't fetch detailed results")}),(l=function(a,b,c){var d,e,f,g,h,i,j,m;i=roundNumber(A.lat,3),j=roundNumber(A.lng,3);try{e=roundNumber(p$("#global-data-map").latitude,3),f=roundNumber(p$("#global-data-map").longitude,3),d={type:"google-map-element",lat:e,lng:f}}catch(a){}try{d=geo.lMap.getCenter(),e=roundNumber(d.lat,3),f=roundNumber(d.lng,3)}catch(a){}return g=100*Math.abs((e-i)/i),h=100*Math.abs((f-j)/j),g<2&&h<2&&a>5?(console.info("Correctly centered",A,d,[g,h]),geo.lMap.getZoom()!==X&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(a<=15||console.warn("Centering too deviant",g<2,h<2,g<2&&h<2,e,f,i,j),isNumber(b)||(b=100),a>b?(m=c*b,console.info("Map could not be correctly centered in "+m+"ms"),clearTimeout(_adp.centerTimeout),!1):(++a,_adp.centerTimeout=delay(c,function(){isNumber(b)||(b=100);try{p$("#global-data-map").latitude=A.lat,p$("#global-data-map").longitude=A.lng}catch(a){}try{console.log("#"+a+"/"+b+" Deep setting view to",A.getObj(),[g,h]),geo.lMap.setView(A.getObj())}catch(a){k=a,console.warn("Error setting view - "+k.message)}if(a<b)return l(a)})))})(0,100,100)}catch(a){k=a,console.error("Couldn't create map! "+k.message),console.warn(k.stack)}stopLoad()}catch(a){k=a,stopLoadError("There was a problem performing a sample search"),console.error("Problem performing sample search! "+k.message),console.warn(k.stack)}return!1},showAllTables=function(){var a,b;return console.log("Starting table list"),b=uri.urlString+"admin-api.php",a="perform=list",$.post(b,a,"json").done(function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(!1===a.status)return console.error("Got bad result",a),!1;console.info("Good result",a),b=a.carto_table_map,i=[],n=[],e=0;for(k in b){if(c=b[k],l=c.table,console.log("Colors",c.creation,generateColorByRecency2(c.creation)),isNull(l))console.warn("Bad table #"+e,l);else{l=l.unescape();try{m={project:k,table:l},createTemplateByProject(m,!0)}catch(a){}n.push(l),g={name:namedMapSource,type:"namedmap",layers:[{layer_name:"layer-"+i.length,interactivity:"cartodb_id, id, diseasedetected, genus, specificepithet, dateidentified"}],params:{table_name:l,color:generateColorByRecency2(c.creation)}},i.push(g)}++e}console.info("Got tables",n),console.info("Got layers",i);try{for(f=0,j=i.length;f<j;f++)g=i[f],h={user_name:cartoAccount,type:"namedmap",named_map:g},console.log("Creating raw map from",h),createRawCartoMap(h)}catch(a){d=a,console.error("Couldn't create map! "+d.message),console.warn(d.stack)}return!1}).error(function(a,b){return console.error("AJAX failure showing tables",a,b)}),!1},resetMap=function(a,b,c){var d,e,f,g,h,i,j;if(null==a&&(a=geo.lMap),null==b&&(b=!0),null==c&&(c=!0),null==geo.mapSublayers)return console.error("geo.mapSublayers is not defined."),!1;try{for(h=geo.mapSublayers,e=0,g=h.length;e<g;e++)j=h[e],j.remove()}catch(b){i=a._layers;for(d in i){f=i[d];try{if(-1===f._url.search("arcgisonline"))try{f.removeLayer()}catch(a){f.remove()}}catch(a){}}}return $("#post-map-subtitle").removeClass("bg-success").addClass("text-muted").text(""),c&&(geo.lMap.setZoom(geo.defaultLeafletOptions.zoom),geo.lMap.panTo(geo.defaultLeafletOptions.center)),b&&(showAllTables(),$("#post-map-subtitle").text("All Projects")),!1},getPrettySpecies=function(a){var b,c,d,e,f,g;return b=a.genus,f=null!=(d=a.specificEpithet)?d:a.specificepithet,g=null!=(e=a.infraspecificEpithet)?e:a.infraspecificEpithet,c=b,isNull(f)||(c+=" "+f,isNull(g)||(c+=" "+g)),c},generateColorByRecency=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;if(null==b&&(b=1420070400),isNumber(a)||(o=new Date(a),a=o.getTime()/1e3),a>Date.now()/1e3&&(a/=1e3),c=Date.now()/1e3-a,k=a-b,c>k)"#000000";else{for(n=k/765,m=c/n,d=255,f=255,l=255-m,l=l<0?0:toInt(l),m>255&&(f=510-m,f=f<0?0:toInt(f),m>510&&(d=765-m,d=d<0?0:toInt(d))),console.log("Base channels",l,f,d),g=[l.toString(16),f.toString(16),d.toString(16)],h=0,i=0,j=g.length;i<j;i++)e=g[i],1===e.length&&(g[h]="0"+e),++h;"#"+g.join("")}return"#ff0000"},generateColorByRecency2=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(null==b&&(b=1420070400),isNumber(a)||(p=new Date(a),a=p.getTime()/1e3),a>Date.now()/1e3&&(a/=1e3),c=Date.now()/1e3-a,l=a-b,c>l)e="#000000";else{for(o=l/765,n=c/o,m=255-n,g=m<0?0-m:255-m,m=m<0?0:toInt(m),d=g>255?toInt(g-255):0,g=g>255?255-(g-255):toInt(g),d=d<0?0:toInt(d),console.log("Base channels 2",m,g,d),h=[m.toString(16),g.toString(16),d.toString(16)],i=0,j=0,k=h.length;j<k;j++)f=h[j],1===f.length&&(h[i]="0"+f),++i;e="#"+h.join("")}return console.log("Recency2 generated",h,e),e="#ff0000"},getProjectResultDialog=function(a){var b,c,d,e,f,g,h,i,j;if(isArray(a)||(a=Object.toArray(a)),0===a.length)return console.warn("There were no projects in the result list"),!1;for(i=[],f=0,g=a.length;f<g;f++)h=a[f],b=h.includes_anura?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",c=h.includes_caudata?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",d=h.includes_gymnophiona?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",j="<tr>\n  <td>"+h.project_title+'</td>\n  <td class="text-center">'+b+'</td>\n  <td class="text-center">'+c+'</td>\n  <td class="text-center">'+d+'</td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" title="Visit Project" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+h.project_id+'" icon="icons:arrow-forward"></paper-icon-button></td>\n</tr>',i.push(j);return e='<paper-dialog id="modal-project-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    <div>\n      <table class="table table-striped">\n        <tr>\n          <th>Project Name</th>\n          <th>Caudata</th>\n          <th>Anura</th>\n          <th>Gymnophiona</th>\n          <th>Visit</th>\n        </tr>\n        '+i.join("\n")+'\n      </table>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#modal-project-list").remove(),$("body").append(e),$("#modal-project-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").unbind().click(function(){return console.log("Calling dialog helper"),safariDialogHelper("#modal-project-list",0,function(){return console.info("Successfully opened dialog"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden")})}),bindClicks(),console.info("Generated project result list"),!1},getSampleSummaryDialog=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;E=Date.now();try{console.info("Starting Web Worker to do hard work"),s={action:"summary-dialog",resultsList:a,tableToProjectMap:b,windowWidth:$(window).width()},I=new Worker("js/global-search-worker.min.js"),I.addEventListener("message",function(a){var b,c;return b=a.data.html,c=a.data.summaryRowData,console.info("Web worker returned",a.data),console.log("Sending to setupDisplay",c),C(b,c)}),I.postMessage(s)}catch(s){if(s,console.warn("Warning: This browser doesn't support Web Workers. Using fallback."),isArray(a)||(a=Object.toArray(a)),0===a.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from",a),w=[],r=[],l=0,H=["cartodb_id","the_geom","the_geom_webmercator","id"],window.dataSummary={species:[],diseases:[],data:{}},m=0,o=a.length;m<o;m++){v=a[m],++l,g=.5*$(window).width(),h=.3*$(window).width();try{B=v.rows;try{c={},x=v.rows;for(q in x){for(A=x[q],n=0,p=H.length;n<p;n++)d=H[n],delete A[d];c[q]=A,A.carto_table=v.table,A.project_id=v.project_id,D=getPrettySpecies(A),indexOf.call(dataSummary.species,D)<0&&dataSummary.species.push(D),e=A.diseasetested,indexOf.call(dataSummary.diseases,e)<0&&dataSummary.diseases.push(e),isNull(dataSummary.data[D])&&(dataSummary.data[D]={}),isNull(dataSummary.data[D][e])&&(dataSummary.data[D][e]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),A.diseasedetected.toBool()?dataSummary.data[D][e].positive++:"no_confidence"===A.diseasedetected.toLowerCase()?dataSummary.data[D][e].no_confidence++:dataSummary.data[D][e].negative++,dataSummary.data[D][e].samples++,t=dataSummary.data[D][e].positive/dataSummary.data[D][e].samples,dataSummary.data[D][e].prevalence=t,r.push(A)}B=c}catch(a){y=v.rows;for(q in y)A=y[q],A.carto_table=v.table,A.project_id=v.project_id,r.push(A)}if(f=JSON.stringify(B),isNull(f)){console.warn("Got bad data for row #"+l+"!",v,v.rows,f);continue}f=""+f}catch(a){f="Invalid data from server"}u=b[v.table],A='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+g+"px;min-width:"+h+'px">'+f+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+u.id+'" icon="icons:arrow-forward" title="'+u.name+'"></paper-icon-button></td>\n</tr>',w.push(A)}window.summaryTableRows={},z=dataSummary.data;for(D in z){j=z[D];for(i in j)f=j[i],null==summaryTableRows[i]&&(summaryTableRows[i]=[]),t=100*f.prevalence,t=roundNumberSigfig(t,2),summaryTableRows[i].push("<tr>\n  <td>"+D+"</td>\n  <td>"+f.samples+"</td>\n  <td>"+f.positive+"</td>\n  <td>"+f.negative+"</td>\n  <td>"+t+"%</td>\n</tr>")}F="";for(i in summaryTableRows)G=summaryTableRows[i],F+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+i+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+G.join("\n")+"\n    </table>\n  </div>\n</div>";k='<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+F+'\n    <div class="row">\n      <div class="col-xs-12">\n        <h3>Raw Data For Developers</h3>\n        <table class="table table-striped">\n          <tr>\n            <th colspan="4">Query Data (JSON)</th>\n            <th>Visit Project</th>\n          </tr>\n          '+w.join("\n")+'\n        </table>\n      </div>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',C(k,r)}return C=function(a,b){var c,d,e,f,g,h,i;c="#generate-download",$("#modal-sql-details-list").remove(),$("body").append(a),console.log("SetupDisplay about to generate using",b),$(c).click(function(){return generateCSVFromResults(b,this)});try{generateCSVFromResults(b,document.getElementById(c.slice(1)))}catch(a){}for(h=$(".code-box"),f=0,g=h.length;f<g;f++){d=h[f];try{Prism.highlightElement(d,!0)}catch(a){}}return $("#modal-sql-details-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").remove(),i='<paper-icon-button class="show-result-list" icon="editor:insert-chart" data-toggle="tooltip" title="Show Sample Details" raised></paper-icon-button>',$("#post-map-subtitle").append(i),$(".show-result-list").unbind().click(function(){var a;return animateLoad(),a=Date.now(),console.log("Calling dialog helper"),safariDialogHelper("#modal-sql-details-list",0,function(){var b,c,d,e;return c=Date.now()-a,console.info("Successfully opened dialog in "+c+"ms via safariDialogHelper"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden"),l=0,e=100,d=3e4,(b=function(){return delay(e,function(){var a;return++l,l*e<d&&!$("#modal-sql-details-list").isVisible()?b():(stopLoad(),a=e*l-e/2+c,a>500?console.warn("It took about "+a+"ms to render the dialog visible!"):console.info("Dialog ready in about "+a+"ms"))})})()})}),bindClicks(),e=Date.now()-E,console.info("Generated project result list in "+e+"ms")},!1},createOverflowMenu=function(){return checkLoggedIn(function(a){var b,c;return b=a.status?'<paper-menu class="dropdown-content">\n<paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",c='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+b+'\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n      <paper-item data-href="'+uri.urlString+'/dashboard.php" class="click">\n        Data Dashboard\n      </paper-item>\n    <paper-item data-function="firstLoadInstructionPrompt" data-args="true" class="click">\n      Show Welcome\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(c),isNull(b)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1},firstLoadInstructionPrompt=function(a){var b,c;null==a&&(a=!1),c=uri.domain+"_firstLoadPrompt";try{b=$.cookie(c).toBool()}catch(a){b=!1}return!a&&b||(b&&console.info("Forced to continue showing prompt to user who has seen it already"),checkLoggedIn(function(d){var e;return d.status&&(console.info("User is logged in, and does not need an instruction prompt"),$.cookie(c,!0),b=!0),!(b&&!a)&&(b&&console.warn("Force-showing the prompt to a logged in user"),
e='<div class="alert alert-warning alert-dismissable slide-alert slide-out" role="alert" id="first-load-prompt">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <div class="alert-message">\n    <p class="center-block text-center"><strong>Welcome!</strong></p>\n    <p>\n      Need help getting started? We\'ve put together some resources for you below.\n    </p>\n    <div class="center-block text-center">\n      <a href="http://updates.amphibiandisease.org/portal/2016/06/30/Uploadingdata.html" class="btn btn-default click" data-newtab="true">Get Involved</a>  <a href="http://updates.amphibiandisease.org/posts/" class="click btn btn-default" data-newtab="true">Learn More</a>  <a href="https://amphibian-disease-tracker.readthedocs.io/en/latest/User%20Workflow/" class="btn btn-default click" data-newtab="true">Read Documentation</a>\n    </div>\n    <p>\n      You can also find these resources by scrolling down on this page later.\n    </p>\n  </div>\n</div>',$("#first-load-prompt").remove(),$("body").append(e),bindClicks(),$("#first-load-prompt").removeClass("slide-out").addClass("slide-in"),$.cookie(c,!0))})),!1},$(function(){var a,b,c,d,e;return geo.initLocation(),d={center:[17.811456088564483,-37.265625],zoom:2},geo.defaultLeafletOptions=d,b=new L.Map("global-map-container",d),c={attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"},geo.tileLayer=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",c),geo.tileLayer.addTo(b),geo.lMap=b,geo.tileLayer.on("load",function(){return console.info("Map ready"),firstLoadInstructionPrompt()}),$(".coord-input").keyup(function(){return checkCoordinateSanity()}),a=function(a,b){var c,d;if(null==b&&(b=!1),!checkCoordinateSanity())return toastStatusMessage("Please check your coordinates"),!1;d=getSearchObject();try{try{c=$(a).attr("data-deep").toBool()}catch(a){c=!1}b&&(c=!0),c&&(d=getSearchContainsObject())}catch(a){c=!1}return doSearch(d,c),!1},$("input.submit-project-search").keyup(function(b){return 13===(b.keyCode?b.keyCode:b.which)&&a(null,!0)}),$(".do-search").click(function(){return a(this)}),$("#reset-global-map").click(function(){return resetMap(),!1}),$("#toggle-global-search-filters").click(function(){var a,b;return b=p$("#global-search-filters").opened,p$("#global-search-filters").toggle(),a=b?"Show":"Hide",$(this).find(".action-word").text(a),!1}),e=function(){return p$("#use-viewport-bounds").checked?(console.info("Setting viewer bounds, checkbox is checked"),setViewerBounds()):console.info("Not using viewport bounds")},geo.lMap.on("moveend",function(){return e()}).on("zoomend",function(){return e()}),showAllTables(),checkFileVersion(!1,"js/global-search.min.js"),$("#show-more-tips").click(function(){var a,b;return a=!p$("#more-tips").opened,p$("#more-tips").toggle(),b=a?"Fewer tips...":"More tips...",$("#show-more-tips").text(b)}),$("#reset-global-map").contextmenu(function(){var a,b,c,d;for(resetMap(),$("#taxa-input").val(""),p$("#use-viewport-bounds").checked=!0,d=$("paper-radio-group"),a=0,b=d.length;a<b;a++){c=d[a];try{p$(c).selectIndex(0)}catch(a){}}return!1}),createOverflowMenu(),!1});
//# sourceMappingURL=global-search.min.js.map