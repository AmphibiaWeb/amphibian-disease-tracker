var checkCoordinateSanity,createOverflowMenu,createTemplateByProject,doDeepSearch,doSearch,firstLoadInstructionPrompt,generateColorByRecency,generateColorByRecency2,getPrettySpecies,getProjectResultDialog,getSampleSummaryDialog,getSearchContainsObject,getSearchObject,namedMapAdvSource,namedMapSource,resetMap,setViewerBounds,showAllTables,indexOf=[].indexOf||function(e){for(var t=0,a=this.length;t<a;t++)if(t in this&&this[t]===e)return t;return-1};namedMapSource="adp_generic_heatmap-v16",namedMapAdvSource="adp_specific_heatmap-v15";try{p$("#exact-species-search").checked&&(namedMapAdvSource="adp_specific_exact_heatmap-v1")}catch(e){}checkCoordinateSanity=function(){var e,t;return t=!0,e={n:toFloat($("#north-coordinate").val()),w:toFloat($("#west-coordinate").val()),s:toFloat($("#south-coordinate").val()),e:toFloat($("#east-coordinate").val())},console.log("User Bounds",e),e.n>e.s||(t=!1,$(".lat-input").parent().addClass("has-error")),e.e>e.w||(t=!1,$(".lng-input").parent().addClass("has-error")),t?($(".coord-input").parent().removeClass("has-error"),$(".do-search").removeAttr("disabled"),!0):($(".do-search").attr("disabled","disabled"),!1)},createTemplateByProject=function(e,t,a){var o,n,r,s,i,l,c,d;if(null==e&&(e="t2627cbcbb4d7597f444903b2e7a5ce5c_6d6d454828c05e8ceea03c99cc5f5"),null==t&&(t=!1),c=Date.now(),null==(null!=(l=window._adp)?l.templateReady:void 0)&&(null==window._adp&&(window._adp={}),window._adp.templateReady={},window._adp.templates={}),r=!1,"object"==typeof e){if(isNull(e.table))return console.error("Couldn't create template for project -- undefined table",e),!1;isNull(e.project)?e=e.table:(s=e.project,e=e.table,r=!0)}if(d="infowindow_template_"+e.slice(0,63),$("#"+d).exists()){if(t)return"function"==typeof a&&a(),!1;$("#"+d).remove()}return window._adp.templateReady[e]=!1,i="SELECT cartodb_id FROM "+e+" LIMIT 1",o="action=fetch&sql_query="+post64(i),n=function(e,o,n){var r,s,i;return r=t?"":'<p>Tested {{content.data.diseasetested}} as <strong>{{content.data.diseasedetected}}</strong> (Fatal: <strong>{{content.data.fatal}}</strong>)</p><p><span class="date-group">Sample was taken in <span class="unix-date">{{content.data.dateidentified}}</span>.</span></p>',i='<script type="infowindow/html" id="'+o+'">\n  <div class="cartodb-popup v2">\n    <a href="#close" class="cartodb-popup-close-button close">x</a>\n    <div class="cartodb-popup-content-wrapper">\n      <div class="cartodb-popup-header">\n        <h2>Sample Info</h2>\n      </div>\n      <div class="cartodb-popup-content">\n        \x3c!-- content.data contains the field info --\x3e\n        <h4>Species: </h4>\n        <p><i>{{content.data.genus}} {{content.data.specificepithet}}</i></p>\n        '+r+'\n        <p><a href="https://amphibiandisease.org/project.php?id='+e+'">View Project</a></p>\n      </div>\n    </div>\n    <div class="cartodb-popup-tip-container"></div>\n  </div>\n<\/script>',$("head").append(i),window._adp.templates[n]=i,window._adp.templates[n.slice(0,63)]=i,window._adp.templateReady[n]=!0,s=Date.now()-c,console.info("Template set for #"+o+" (took "+s+"ms)"),"function"==typeof a&&a(),!1},r?(console.info("Directly provided project id"),n(s,d,e),!1):(console.info("Creating template after pinging API endpoint"),$.post(uri.urlString+"api.php",o,"json").done(function(t){var a,o,r;return a=null!=(o=t.parsed_responses)&&null!=(r=o[0])?r.project_id:void 0,isNull(a)?console.warn("Couldn't find project ID for table "+e,t):n(a,d,e)}),!1)},setViewerBounds=function(e){var t,a,o;return null==e&&(e=geo.lMap),t=e.getBounds(),o=t._southWest,(a=t._northEast).lng-o.lng>360&&(o.lng=-180,a.lng=180),$("#north-coordinate").val(a.lat),$("#west-coordinate").val(o.lng),$("#south-coordinate").val(o.lat),$("#east-coordinate").val(a.lng),!1},getSearchObject=function(){var e,t,a,o,n;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(e){}return e={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},n={sampled_species:{data:$("#taxa-input").val().toLowerCase()},bounding_box_n:{data:e.n,search_type:"<="},bounding_box_e:{data:e.e,search_type:"<="},bounding_box_w:{data:e.w,search_type:">="},bounding_box_s:{data:e.s,search_type:">="}},"*"!==(t=$(p$("#disease-status").selectedItem).attr("data-search"))&&(n.disease_positive={data:0,search_type:t.toBool()?">":"="}),"*"!==(a=$(p$("#morbidity-status").selectedItem).attr("data-search"))&&(n.disease_morbidity={data:0,search_type:a.toBool()?">":"="}),"*"!==(o=$(p$("#pathogen-choice").selectedItem).attr("data-search"))&&(n.disease={data:o}),n},getSearchContainsObject=function(){var e,t,a,o,n,r,s,i,l,c;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(e){}return e={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},l=$("#taxa-input").val().toLowerCase(),c=l.split(" "),i=3===c.length?c.pop():"",s=2===c.length?c.pop():"",a=1===c.length?c.pop():"",r={sampled_species:{data:l,genus:a,species:s,subspecies:i},bounding_box_n:{data:e.s,search_type:">"},bounding_box_e:{data:e.w,search_type:">"},bounding_box_w:{data:e.e,search_type:"<"},bounding_box_s:{data:e.n,search_type:"<"}},"*"!==(t=$(p$("#disease-status").selectedItem).attr("data-search"))&&(r.disease_positive={data:0,search_type:t.toBool()?">":"="}),"*"!==(o=$(p$("#morbidity-status").selectedItem).attr("data-search"))&&(r.disease_morbidity={data:0,search_type:o.toBool()?">":"="}),"*"!==(n=$(p$("#pathogen-choice").selectedItem).attr("data-search"))&&(r.disease={data:n}),r},doSearch=function(e,t,a){var o,n,r,s;return null==e&&(e=getSearchObject()),null==t&&(t=!1),null==a&&(a=!1),startLoad(),$("#post-map-subtitle").removeClass("bg-success"),r=jsonTo64(e),o="advanced_project_search",s=t?namedMapAdvSource:namedMapSource,n="perform="+o+"&q="+r,$.post(uri.urlString+"admin-api.php",n,"json").done(function(o){var n,r,i,l,c,d,p,u,m,h,g,b,f,w,y,v,_,S,j,x,k,C,M,T,N,D,O,A,L,P,R,I,B,E,F,V,W,z,G,q,U;if(console.info("Adv. search result",o),!0!==o.status)return console.error(o.error),stopLoadError("There was a problem fetching the results"),!1;if(0===(A=Object.toArray(o.result)).length)return P=function(t){var a,o;return null==t&&(t=!1),console.warn("The search failed!"),isNull(null!=(o=e.sampled_species)?o.data:void 0)||(a='<span id="taxa-input-error" class="help-block">\n  Invalid taxon: Please check your spelling. <a href="http://amphibiaweb.org/search/index.html" class="click" data-newtab="true">Check AmphibiaWeb for valid taxa</a>\n</span>',t&&(a='<span id="taxa-input-error" class="help-block">\n  No matching samples found.\n</span>'),$("#taxa-input-container").addClass("has-error"),$("#taxa-input-error").remove(),$("#taxa-input").attr("aria-describedby","taxa-input-error").after(a).keyup(function(){try{return $("#taxa-input-container").removeClass("has-error"),$("#taxa-input-error").remove()}catch(e){}}),bindClicks()),console.warn("No results"),stopLoadError("No results"),!1},isNull(null!=(M=e.sampled_species)?M.data:void 0)||a?(console.warn("No need to validate",isNull(null!=(D=e.sampled_species)?D.data:void 0),a),P(!0)):(console.warn("The initial search failed, we're going to validate the taxon and re-check"),F={genus:null!=(T=(V=e.sampled_species.data.split(" "))[0])?T:"",species:null!=(N=V[1])?N:""},validateAWebTaxon(F,function(e){var a,o;return!0===e.invalid?(console.error("This taxon is invalid!",e),P(),!1):(o=e.genus+" "+e.species+" "+(null!=(a=e.subspecies)?a:""),o=o.trim(),$("#taxa-input").val(o),doSearch(getSearchObject(),t,!0),!1)})),!1;if(t)return doDeepSearch(A,s),!1;for(z=0,k=0,G=[],v=[],n={n:-90,s:90,e:-180,w:180},h=0,console.info("Using standard named map "+s),g=0,_=A.length;g<_;g++){for((C=A[g]).bounding_box_n>n.n&&(n.n=C.bounding_box_n),C.bounding_box_e>n.e&&(n.e=C.bounding_box_e),C.bounding_box_s<n.s&&(n.s=C.bounding_box_s),C.bounding_box_w<n.w&&(n.w=C.bounding_box_w),z+=C.disease_samples,k+=C.disease_positive,b=0,S=(R=C.sampled_species.split(",")).length;b<S;b++)I=(I=R[b]).trim(),indexOf.call(G,I)<0&&G.push(I);if(null==(null!=(O=C.carto_id)?O.table:void 0))try{l=JSON.parse(C.carto_id),i={};for(f in l){q=l[f],c=f.replace("&#95;","_");try{d=q.replace("&#95;","_")}catch(e){d=q}i[c]=d}C.carto_id=i}catch(e){}try{E=(E=C.carto_id.table).unescape()}catch(e){}if(isNull(E))console.warn("Unable to get a table id from this carto data:",C.carto_id);else{try{W={project:C.project_id,table:E},createTemplateByProject(W)}catch(e){u=e,console.error("Warning: couldn't create project template: "+u.message),console.warn(u.stack)}y={name:s,type:"namedmap",layers:[{layer_name:"layer-"+v.length}],params:{table_name:E,color:"#FF6600"}},v.push(y)}A[h]=C,++h}try{r=[[n.n,n.w],[n.n,n.e],[n.s,n.e],[n.s,n.w]],x=getMapCenter(r),U=getMapZoom(r,".map-container"),console.info("Found @ zoom = "+U+" center",x,"for bounding box",r),null!=geo.lMap&&(geo.lMap.once("zoomend",function(){return console.info("ZoomEnd is ensuring centering"),m(0)}),geo.lMap.setZoom(U));try{p$("#global-data-map").latitude=x.lat,p$("#global-data-map").longitude=x.lng,p$("#global-data-map").zoom=U}catch(e){}try{geo.lMap.setView(x.getObj())}catch(e){}}catch(e){u=e,console.warn("Failed to rezoom/recenter map - "+u.message,r),console.warn(u.stack)}B=G.length,console.info("Projects containing your search returned "+z+" ("+k+" positive) among "+B+" species",n);try{for(resetMap(geo.lMap,!1,!1),w=0,j=v.length;w<j;w++)y=v[w],(p=function(e,t){var a,o,n,r;return!0===(null!=(n=window._adp)&&null!=(r=n.templateReady)?r[t.params.table_name]:void 0)||(e>50?(console.error("Error -- timed out waiting for template to be ready"),o=!0):o=!1,o)?(console.info("Template script ready for table '"+window._adp.templateReady[t.params.table_name]+"' after "+e+" iterations, rendering on map"),a={user_name:cartoAccount,type:"namedmap",named_map:t},createRawCartoMap(a),!1):(delay(50,function(){return++e,p(e,t)}),!1)})(0,y);$("#post-map-subtitle").text("Viewing projects containing "+z+" samples ("+k+" positive) among "+B+" species"),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),$(".show-result-list").remove(),L='<paper-icon-button class="show-result-list" icon="icons:subject" data-toggle="tooltip" title="Show Project list" raised></paper-icon-button>',$("#post-map-subtitle").append(L),getProjectResultDialog(A),(m=function(e,t,a){var o,n,r,s,i,l,c,d;l=roundNumber(x.lat,3),c=roundNumber(x.lng,3);try{o={type:"google-map-element",lat:n=roundNumber(p$("#global-data-map").latitude,3),lng:r=roundNumber(p$("#global-data-map").longitude,3)}}catch(e){}try{o=geo.lMap.getCenter(),n=roundNumber(o.lat,3),r=roundNumber(o.lng,3)}catch(e){}return s=100*Math.abs((n-l)/l),i=100*Math.abs((r-c)/c),s<2&&i<2&&e>5?(console.info("Correctly centered",x,o,[s,i]),geo.lMap.getZoom()!==U&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(e<=15||console.warn("Centering too deviant",s<2,i<2,s<2&&i<2,n,r,l,c),isNumber(t)||(t=100),e>t?(d=a*t,console.info("Map could not be correctly centered in "+d+"ms"),clearTimeout(_adp.centerTimeout),!1):(++e,_adp.centerTimeout=delay(a,function(){isNumber(t)||(t=100);try{p$("#global-data-map").latitude=x.lat,p$("#global-data-map").longitude=x.lng}catch(e){}try{console.log("#"+e+"/"+t+" General setting view to",x.getObj(),[s,i]),geo.lMap.setView(x.getObj())}catch(e){u=e,console.warn("Error setting view - "+u.message)}if(e<t)return m(e)})))})(0,100,100)}catch(e){u=e,console.error("Couldn't create map! "+u.message),console.warn(u.stack)}return stopLoad(),!1}).fail(function(e,t){return console.error(e,t),console.warn("Attempted to do",uri.urlString+"admin-api.php?"+n),stopLoadError("Server error, couldn't perform search")}),!1},doDeepSearch=function(e,t){var a,o,n,r,s,i,l,c,d,p,u,m,h,g,b,f,w,y,v,_,S,j,x,k,C,M,T,N,D,O,A,L,P,R,I,B,E,F,V,W,z,G,q,U,Z,J;null==t&&(t=namedMapAdvSource);try{for(B=getSearchContainsObject(),q=0,T=0,U=[],_=[],o={n:-90,s:90,e:-180,w:180},h=0,console.info("Using deep named map "+t),c="",null!=(null!=(O=B.disease_positive)?O.data:void 0)&&(c=">"===B.disease_positive.search_type?"true":"false"),u="",null!=(null!=(A=B.disease_morbidity)?A.data:void 0)&&(">"===B.disease_morbidity.search_type?(u="and fatal = true",m=!0):(u="and fatal = false",m=!1)),M="",null!=(null!=(L=B.disease)?L.data:void 0)&&(M=function(){switch(B.disease.data){case"Batrachochytrium dendrobatidis":return"bd";case"Batrachochytrium salamandrivorans":return"bsal";default:return""}}()),D={},k=getSearchObject(),g=0,S=e.length;g<S;g++){for(N=e[g],k.bounding_box_n.data>o.n&&(o.n=k.bounding_box_n.data),k.bounding_box_e.data>o.e&&(o.e=k.bounding_box_e.data),k.bounding_box_s.data<o.s&&(o.s=k.bounding_box_s.data),k.bounding_box_w.data<o.w&&(o.w=k.bounding_box_w.data),q+=N.disease_samples,T+=N.disease_positive,b=0,j=(E=N.sampled_species.split(",")).length;b<j;b++)F=(F=E[b]).trim(),indexOf.call(U,F)<0&&U.push(F);if(null==(null!=(P=N.carto_id)?P.table:void 0))try{s=JSON.parse(N.carto_id),r={};for(f in s){Z=s[f],i=f.replace("&#95;","_");try{l=Z.replace("&#95;","_")}catch(e){l=Z}r[i]=l}N.carto_id=r}catch(e){}try{z=(z=N.carto_id.table).unescape()}catch(e){}if(isNull(z))console.warn("Unable to get a table id from this carto data:",N.carto_id);else{try{G={project:N.project_id,table:z},createTemplateByProject(G)}catch(e){d=e,console.error("Warning: couldn't create project template: "+d.message),console.warn(d.stack)}y={name:t,type:"namedmap",layers:[{layer_name:"layer-"+_.length}],params:{table_name:z,color:"#FF6600",genus:B.sampled_species.genus,specific_epithet:B.sampled_species.species,disease_detected:c,morbidity:u,pathogen:M}},_.push(y),D[z]={id:N.project_id,name:N.project_title}}e[h]=N,++h}try{n=[[o.n,o.w],[o.n,o.e],[o.s,o.e],[o.s,o.w]],C=getMapCenter(n),J=getMapZoom(n,".map-container"),console.info("Found @ zoom = "+J+" center",C,"for bounding box",n)}catch(e){}V=U.length,console.info("Projects containing your search returned "+q+" ("+T+" positive) among "+V+" species",o),W="Viewing data points",isNull(null!=(R=B.sampled_species)?R.genus:void 0)||(W+=(" of '"+B.sampled_species.genus+" "+B.sampled_species.species+" "+B.sampled_species.subspecies+"'").replace(/( \*)/gim,"")),null!=B.pathogen?B.pathogen.data:"disease",null!=B.disease&&(W+=" for "+B.disease.data),null!=B.disease_positive&&(W+=" with disease status '"+c+"'"),null!=B.disease_morbidity&&(W+=" with morbidity status '"+m+"'"),W+=" in bounds defined by [{lat: "+B.bounding_box_n.data+",lng: "+B.bounding_box_w.data+"},{lat: "+B.bounding_box_s.data+",lng: "+B.bounding_box_e.data+"}]";try{for(resetMap(geo.lMap,!1,!1),I="",w=0,x=_.length;w<x;w++)y=_[w],v={user_name:cartoAccount,type:"namedmap",named_map:y},createRawCartoMap(v),I+="select * from "+y.params.table_name+" where (genus ilike '%"+y.params.genus+"%' and specificepithet ilike '%"+y.params.specific_epithet+"%' and diseasedetected ilike '%"+y.params.disease_detected+"%' and diseasetested ilike '%"+y.params.pathogen+"%' and decimallatitude between "+o.s+" and "+o.n+" and decimallongitude between "+o.w+" and "+o.e+");";$("#post-map-subtitle").text(W),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),a="action=fetch&sql_query="+post64(I),$.post(uri.urlString+"api.php",a,"json").done(function(t){var o,n,r,s,i,l,c,u,m;console.info("Detailed results: ",t);try{for(e=Object.toArray(t.parsed_responses),getSampleSummaryDialog(e,D),o=[],s=0,n=e.length;s<n;s++)for(m=e[s],i=0,r=(u=Object.toArray(m.rows)).length;i<r;i++)l={lat:(c=u[i]).decimallatitude,lng:c.decimallongitude},o.push(canonicalizePoint(l));J=getMapZoom(o,".map-container"),C=getMapCenter(o),console.info("Recalculate data zoom = "+J+" center",C,"for points array",o);try{null!=geo.lMap&&(geo.lMap.once("zoomend",function(){return console.info("ZoomEnd is ensuring centering"),p(0)}),geo.lMap.setZoom(J));try{p$("#global-data-map").latitude=C.lat,p$("#global-data-map").longitude=C.lng,p$("#global-data-map").zoom=J}catch(e){}try{geo.lMap.setView(C.getObj())}catch(e){d=e,console.warn("Failed to recenter map - "+d.message,o),console.warn(d.stack)}}catch(e){d=e,console.warn("Failed to rezoom/recenter map - "+d.message,o),console.warn(d.stack)}}catch(e){d=e,console.error("Couldn't parse responses from server: "+d.message),console.warn(d.stack),console.log("Got",t),console.debug(uri.urlString+"api.php?"+a)}return!1}).fail(function(e,t){return console.error("Couldn't fetch detailed results")}),(p=function(e,t,a){var o,n,r,s,i,l,c,u;l=roundNumber(C.lat,3),c=roundNumber(C.lng,3);try{o={type:"google-map-element",lat:n=roundNumber(p$("#global-data-map").latitude,3),lng:r=roundNumber(p$("#global-data-map").longitude,3)}}catch(e){}try{o=geo.lMap.getCenter(),n=roundNumber(o.lat,3),r=roundNumber(o.lng,3)}catch(e){}return s=100*Math.abs((n-l)/l),i=100*Math.abs((r-c)/c),s<2&&i<2&&e>5?(console.info("Correctly centered",C,o,[s,i]),geo.lMap.getZoom()!==J&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(e<=15||console.warn("Centering too deviant",s<2,i<2,s<2&&i<2,n,r,l,c),isNumber(t)||(t=100),e>t?(u=a*t,console.info("Map could not be correctly centered in "+u+"ms"),clearTimeout(_adp.centerTimeout),!1):(++e,_adp.centerTimeout=delay(a,function(){isNumber(t)||(t=100);try{p$("#global-data-map").latitude=C.lat,p$("#global-data-map").longitude=C.lng}catch(e){}try{console.log("#"+e+"/"+t+" Deep setting view to",C.getObj(),[s,i]),geo.lMap.setView(C.getObj())}catch(e){d=e,console.warn("Error setting view - "+d.message)}if(e<t)return p(e)})))})(0,100,100)}catch(e){d=e,console.error("Couldn't create map! "+d.message),console.warn(d.stack)}stopLoad()}catch(e){d=e,stopLoadError("There was a problem performing a sample search"),console.error("Problem performing sample search! "+d.message),console.warn(d.stack)}return!1},showAllTables=function(){var e;return console.log("Starting table list"),e=uri.urlString+"admin-api.php","perform=list",$.post(e,"perform=list","json").done(function(e){var t,a,o,n,r,s,i,l,c,d,p,u;if(!1===e.status)return console.error("Got bad result",e),!1;console.info("Good result",e),t=e.carto_table_map,l=[],u=[],n=0;for(d in t){if(a=t[d],p=a.table,console.log("Colors",a.creation,generateColorByRecency2(a.creation)),isNull(p))console.warn("Bad table #"+n,p);else{p=p.unescape();try{createTemplateByProject({project:d,table:p},!0)}catch(e){}u.push(p),s={name:namedMapSource,type:"namedmap",layers:[{layer_name:"layer-"+l.length,interactivity:"cartodb_id, id, diseasedetected, genus, specificepithet, dateidentified"}],params:{table_name:p,color:generateColorByRecency2(a.creation)}},l.push(s)}++n}console.info("Got tables",u),console.info("Got layers",l);try{for(r=0,c=l.length;r<c;r++)s=l[r],i={user_name:cartoAccount,type:"namedmap",named_map:s},console.log("Creating raw map from",i),createRawCartoMap(i)}catch(e){o=e,console.error("Couldn't create map! "+o.message),console.warn(o.stack)}return!1}).error(function(e,t){return console.error("AJAX failure showing tables",e,t)}),!1},resetMap=function(e,t,a){var o,n,r,s,i,l;if(null==e&&(e=geo.lMap),null==t&&(t=!0),null==a&&(a=!0),null==geo.mapSublayers)return console.error("geo.mapSublayers is not defined."),!1;try{for(n=0,s=(i=geo.mapSublayers).length;n<s;n++)i[n].remove()}catch(t){l=e._layers;for(o in l){r=l[o];try{if(-1===r._url.search("arcgisonline"))try{r.removeLayer()}catch(e){r.remove()}}catch(e){}}}return $("#post-map-subtitle").removeClass("bg-success").addClass("text-muted").text(""),a&&(geo.lMap.setZoom(geo.defaultLeafletOptions.zoom),geo.lMap.panTo(geo.defaultLeafletOptions.center)),t&&(showAllTables(),$("#post-map-subtitle").text("All Projects")),!1},getPrettySpecies=function(e){var t,a,o,n,r,s;return t=e.genus,r=null!=(o=e.specificEpithet)?o:e.specificepithet,s=null!=(n=e.infraspecificEpithet)?n:e.infraspecificEpithet,a=t,isNull(r)||(a+=" "+r,isNull(s)||(a+=" "+s)),a},generateColorByRecency=function(e,t){var a,o,n,r,s,i,l,c,d,p,u;if(null==t&&(t=1420070400),isNumber(e)||(e=new Date(e).getTime()/1e3),e>Date.now()/1e3&&(e/=1e3),a=Date.now()/1e3-e,d=e-t,a>d)"#000000";else{for(o=255,r=255,p=(p=255-(u=a/(d/765)))<0?0:toInt(p),u>255&&(r=(r=510-u)<0?0:toInt(r),u>510&&(o=(o=765-u)<0?0:toInt(o))),console.log("Base channels",p,r,o),i=0,l=0,c=(s=[p.toString(16),r.toString(16),o.toString(16)]).length;l<c;l++)1===(n=s[l]).length&&(s[i]="0"+n),++i;"#"+s.join("")}return"#ff0000"},generateColorByRecency2=function(e,t){var a,o,n,r,s,i,l,c,d,p,u;if(null==t&&(t=1420070400),isNumber(e)||(e=new Date(e).getTime()/1e3),e>Date.now()/1e3&&(e/=1e3),a=Date.now()/1e3-e,p=e-t,a>p)n="#000000";else{for(s=(u=255-a/(p/765))<0?0-u:255-u,u=u<0?0:toInt(u),o=s>255?toInt(s-255):0,s=s>255?255-(s-255):toInt(s),o=o<0?0:toInt(o),console.log("Base channels 2",u,s,o),l=0,c=0,d=(i=[u.toString(16),s.toString(16),o.toString(16)]).length;c<d;c++)1===(r=i[c]).length&&(i[l]="0"+r),++l;n="#"+i.join("")}return console.log("Recency2 generated",i,n),n="#ff0000"},getProjectResultDialog=function(e){var t,a,o,n,r,s,i,l,c;if(isArray(e)||(e=Object.toArray(e)),0===e.length)return console.warn("There were no projects in the result list"),!1;for(l=[],r=0,s=e.length;r<s;r++)t=(i=e[r]).includes_anura?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",a=i.includes_caudata?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",o=i.includes_gymnophiona?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",c="<tr>\n  <td>"+i.project_title+'</td>\n  <td class="text-center">'+t+'</td>\n  <td class="text-center">'+a+'</td>\n  <td class="text-center">'+o+'</td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" title="Visit Project" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+i.project_id+'" icon="icons:arrow-forward"></paper-icon-button></td>\n</tr>',l.push(c);return n='<paper-dialog id="modal-project-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    <div>\n      <table class="table table-striped">\n        <tr>\n          <th>Project Name</th>\n          <th>Caudata</th>\n          <th>Anura</th>\n          <th>Gymnophiona</th>\n          <th>Visit</th>\n        </tr>\n        '+l.join("\n")+'\n      </table>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#modal-project-list").remove(),$("body").append(n),$("#modal-project-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").unbind().click(function(){return console.log("Calling dialog helper"),safariDialogHelper("#modal-project-list",0,function(){return console.info("Successfully opened dialog"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden")})}),bindClicks(),console.info("Generated project result list"),!1},getSampleSummaryDialog=function(e,t){var a,o,n,r,s,i,l,c,d,p,u,m,h,g,b,f,w,y,v,_,S,j,x,k,C,M,T,N,D,O,A,L,P;D=Date.now();try{console.info("Starting Web Worker to do hard work"),w={action:"summary-dialog",resultsList:e,tableToProjectMap:t,windowWidth:$(window).width()},(P=new Worker("js/global-search-worker.min.js")).addEventListener("message",function(e){var t,a;return t=e.data.html,a=e.data.summaryRowData,console.info("Web worker returned",e.data),console.log("Sending to setupDisplay",a),T(t,a)}),P.postMessage(w)}catch(w){if(w,console.warn("Warning: This browser doesn't support Web Workers. Using fallback."),isArray(e)||(e=Object.toArray(e)),0===e.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from",e),S=[],f=[],p=0,L=["cartodb_id","the_geom","the_geom_webmercator","id"],window.dataSummary={species:[],diseases:[],data:{}},u=0,h=e.length;u<h;u++){_=e[u],++p,s=.5*$(window).width(),i=.3*$(window).width();try{M=_.rows;try{a={},j=_.rows;for(b in j){for(C=j[b],m=0,g=L.length;m<g;m++)o=L[m],delete C[o];a[b]=C,C.carto_table=_.table,C.project_id=_.project_id,N=getPrettySpecies(C),indexOf.call(dataSummary.species,N)<0&&dataSummary.species.push(N),n=C.diseasetested,indexOf.call(dataSummary.diseases,n)<0&&dataSummary.diseases.push(n),isNull(dataSummary.data[N])&&(dataSummary.data[N]={}),isNull(dataSummary.data[N][n])&&(dataSummary.data[N][n]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),C.diseasedetected.toBool()?dataSummary.data[N][n].positive++:"no_confidence"===C.diseasedetected.toLowerCase()?dataSummary.data[N][n].no_confidence++:dataSummary.data[N][n].negative++,dataSummary.data[N][n].samples++,y=dataSummary.data[N][n].positive/dataSummary.data[N][n].samples,dataSummary.data[N][n].prevalence=y,f.push(C)}M=a}catch(e){x=_.rows;for(b in x)(C=x[b]).carto_table=_.table,C.project_id=_.project_id,f.push(C)}if(r=JSON.stringify(M),isNull(r)){console.warn("Got bad data for row #"+p+"!",_,_.rows,r);continue}r=""+r}catch(e){r="Invalid data from server"}v=t[_.table],C='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+s+"px;min-width:"+i+'px">'+r+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+v.id+'" icon="icons:arrow-forward" title="'+v.name+'"></paper-icon-button></td>\n</tr>',S.push(C)}window.summaryTableRows={},k=dataSummary.data;for(N in k){c=k[N];for(l in c)r=c[l],null==summaryTableRows[l]&&(summaryTableRows[l]=[]),y=100*r.prevalence,y=roundNumberSigfig(y,2),summaryTableRows[l].push("<tr>\n  <td>"+N+"</td>\n  <td>"+r.samples+"</td>\n  <td>"+r.positive+"</td>\n  <td>"+r.negative+"</td>\n  <td>"+y+"%</td>\n</tr>")}O="";for(l in summaryTableRows)A=summaryTableRows[l],O+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+l+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+A.join("\n")+"\n    </table>\n  </div>\n</div>";d='<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+O+'\n    <div class="row">\n      <div class="col-xs-12">\n        <h3>Raw Data For Developers</h3>\n        <table class="table table-striped">\n          <tr>\n            <th colspan="4">Query Data (JSON)</th>\n            <th>Visit Project</th>\n          </tr>\n          '+S.join("\n")+'\n        </table>\n      </div>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',T(d,f)}return T=function(e,t){var a,o,n,r,s,i;$("#modal-sql-details-list").remove(),$("body").append(e),console.log("SetupDisplay about to generate using",t),$("#generate-download").click(function(){return generateCSVFromResults(t,this)});try{generateCSVFromResults(t,document.getElementById("generate-download"))}catch(e){}for(n=0,r=(s=$(".code-box")).length;n<r;n++){a=s[n];try{Prism.highlightElement(a,!0)}catch(e){}}return $("#modal-sql-details-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").remove(),i='<paper-icon-button class="show-result-list" icon="editor:insert-chart" data-toggle="tooltip" title="Show Sample Details" raised></paper-icon-button>',$("#post-map-subtitle").append(i),$(".show-result-list").unbind().click(function(){var e;return animateLoad(),e=Date.now(),console.log("Calling dialog helper"),safariDialogHelper("#modal-sql-details-list",0,function(){var t,a;return a=Date.now()-e,console.info("Successfully opened dialog in "+a+"ms via safariDialogHelper"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden"),p=0,100,3e4,(t=function(){return delay(100,function(){var e;return 100*++p<3e4&&!$("#modal-sql-details-list").isVisible()?t():(stopLoad(),(e=100*p-50+a)>500?console.warn("It took about "+e+"ms to render the dialog visible!"):console.info("Dialog ready in about "+e+"ms"))})})()})}),bindClicks(),o=Date.now()-D,console.info("Generated project result list in "+o+"ms")},!1},createOverflowMenu=function(){return checkLoggedIn(function(e){var t,a;return t=e.status?'<paper-menu class="dropdown-content">\n<paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",a='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+t+'\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n      <paper-item data-href="'+uri.urlString+'dashboard.php" class="click">\n        <iron-icon icon="icons:donut-small"></iron-icon>\n        Data Dashboard\n      </paper-item>\n    <paper-item data-function="firstLoadInstructionPrompt" data-args="true" class="click">\n      Show Welcome\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(a),isNull(t)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1},firstLoadInstructionPrompt=function(e){var t,a;null==e&&(e=!1),a=uri.domain+"_firstLoadPrompt";try{t=$.cookie(a).toBool()}catch(e){t=!1}return!e&&t||(t&&console.info("Forced to continue showing prompt to user who has seen it already"),checkLoggedIn(function(o){var n;return o.status&&(console.info("User is logged in, and does not need an instruction prompt"),$.cookie(a,!0),t=!0),!(t&&!e)&&(t&&console.warn("Force-showing the prompt to a logged in user"),n='<div class="alert alert-warning alert-dismissable slide-alert slide-out" role="alert" id="first-load-prompt">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <div class="alert-message">\n    <p class="center-block text-center"><strong>Welcome!</strong></p>\n    <p>\n      Need help getting started? We\'ve put together some resources for you below.\n    </p>\n    <div class="center-block text-center">\n      <a href="http://updates.amphibiandisease.org/portal/2016/06/30/Uploadingdata.html" class="btn btn-default click" data-newtab="true">Get Involved</a>  <a href="http://updates.amphibiandisease.org/posts/" class="click btn btn-default" data-newtab="true">Learn More</a>  <a href="https://amphibian-disease-tracker.readthedocs.io/en/latest/User%20Workflow/" class="btn btn-default click" data-newtab="true">Read Documentation</a>\n    </div>\n    <p>\n      You can also find these resources by scrolling down on this page later.\n    </p>\n  </div>\n</div>',$("#first-load-prompt").remove(),$("body").append(n),bindClicks(),$("#first-load-prompt").removeClass("slide-out").addClass("slide-in"),$.cookie(a,!0))})),!1},$(function(){var e,t,a,o,n;return geo.initLocation(),o={center:[17.811456088564483,-37.265625],zoom:2},geo.defaultLeafletOptions=o,t=new L.Map("global-map-container",o),a={attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"},geo.tileLayer=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",a),geo.tileLayer.addTo(t),geo.lMap=t,geo.tileLayer.on("load",function(){return console.info("Map ready"),firstLoadInstructionPrompt()}),$(".coord-input").keyup(function(){return checkCoordinateSanity()}),e=function(e,t){var a,o;if(null==t&&(t=!1),!checkCoordinateSanity())return toastStatusMessage("Please check your coordinates"),!1;o=getSearchObject();try{try{a=$(e).attr("data-deep").toBool()}catch(e){a=!1}t&&(a=!0),a&&(o=getSearchContainsObject())}catch(e){a=!1}return doSearch(o,a),!1},$("input.submit-project-search").keyup(function(t){return 13===(t.keyCode?t.keyCode:t.which)&&e(null,!0)}),$(".do-search").click(function(){return e(this)}),$("#reset-global-map").click(function(){return resetMap(),!1}),$("#toggle-global-search-filters").click(function(){var e,t;return t=p$("#global-search-filters").opened,p$("#global-search-filters").toggle(),e=t?"Show":"Hide",$(this).find(".action-word").text(e),!1}),$("#use-viewport-bounds").on("iron-change",function(){return p$("#use-viewport-bounds").checked?setViewerBounds():(console.debug("Resetting search bounds on uncheck"),$("#north-coordinate").val(90),$("#west-coordinate").val(-180),$("#south-coordinate").val(-90),$("#east-coordinate").val(180)),!1}),n=function(){return p$("#use-viewport-bounds").checked?(console.info("Setting viewer bounds, checkbox is checked"),setViewerBounds()):console.info("Not using viewport bounds")},geo.lMap.on("moveend",function(){return n()}).on("zoomend",function(){return n()}),showAllTables(),checkFileVersion(!1,"js/global-search.min.js"),$("#show-more-tips").click(function(){var e,t;return e=!p$("#more-tips").opened,p$("#more-tips").toggle(),t=e?"Fewer tips...":"More tips...",$("#show-more-tips").text(t)}),$("#reset-global-map").contextmenu(function(){var e,t,a,o;for(resetMap(),$("#taxa-input").val(""),p$("#use-viewport-bounds").checked=!0,e=0,t=(o=$("paper-radio-group")).length;e<t;e++){a=o[e];try{p$(a).selectIndex(0)}catch(e){}}return!1}),createOverflowMenu(),!1});
//# sourceMappingURL=global-search.min.js.map