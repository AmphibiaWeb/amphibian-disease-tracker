function shuffle(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}function pointSort(a,b){if(a==upper)return-1;if(b==upper)return 1;var c=upper.slope(a),d=upper.slope(b);return c==d?a.distance(upper)<b.distance(upper)?-1:1:c<=0&&d>0?-1:c>0&&d<=0?1:c>d?-1:1}function upperLeft(a){for(var b=a[0],c=1;c<a.length;c++){var d=a[c];(d.y>b.y||d.y==b.y&&d.x<b.x)&&(b=d)}return b}function cross(a,b,c){return(b.lat-a.lat)*(c.lng-a.lng)-(b.lng-a.lng)*(c.lat-a.lat)}function convexHull(a){a.sort(function(a,b){return a.lat==b.lat?a.lng-b.lng:a.lat-b.lat});for(var b=[],c=0;c<a.length;c++){for(;b.length>=2&&cross(b[b.length-2],b[b.length-1],a[c])<=0;)b.pop();b.push(a[c])}for(var d=[],c=a.length-1;c>=0;c--){for(;d.length>=2&&cross(d[d.length-2],d[d.length-1],a[c])<=0;)d.pop();d.push(a[c])}return d.pop(),b.pop(),b.concat(d)}function calculateConvexHull(){polyline&&polyline.setMap(null),document.getElementById("hull_points").innerHTML="",points=[];for(var a=0;a<gmarkers.length;a++)points.push(gmarkers[a].getPosition());points.sort(sortPointY),points.sort(sortPointX),DrawHull()}function DrawHull(){hullPoints=[],chainHull_2D(points,points.length,hullPoints),polyline=new google.maps.Polygon({map:map,paths:hullPoints,fillColor:"#FF0000",strokeWidth:2,fillOpacity:.5,strokeColor:"#0000FF",strokeOpacity:.5}),displayHullPts()}function displayHullPts(){document.getElementById("hull_points").innerHTML="";for(var a=0;a<hullPoints.length;a++)document.getElementById("hull_points").innerHTML+=hullPoints[a].toUrlValue()+"<br>"}function isLeft(a,b,c){return(b.lng()-a.lng())*(c.lat()-a.lat())-(c.lng()-a.lng())*(b.lat()-a.lat())}function chainHull_2D(a,b,c){var d,e,f=0,g=-1,h=0,i=a[0].lng();for(d=1;d<b&&a[d].lng()==i;d++);if(e=d-1,e==b-1)return c[++g]=a[h],a[e].lat()!=a[h].lat()&&(c[++g]=a[e]),c[++g]=a[h],g+1;var j,k=b-1,l=a[b-1].lng();for(d=b-2;d>=0&&a[d].lng()==l;d--);for(j=d+1,c[++g]=a[h],d=e;++d<=j;)if(!(isLeft(a[h],a[j],a[d])>=0&&d<j)){for(;g>0&&!(isLeft(c[g-1],c[g],a[d])>0);)g--;c[++g]=a[d]}for(k!=j&&(c[++g]=a[k]),f=g,d=j;--d>=e;)if(!(isLeft(a[k],a[e],a[d])>=0&&d>e)){for(;g>f&&!(isLeft(c[g-1],c[g],a[d])>0);)g--;c[++g]=a[d]}return e!=h&&(c[++g]=a[h]),g+1}function shuffle(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}var Point,activityIndicatorOff,activityIndicatorOn,adData,allError,animateHoverShadows,animateLoad,backupDebugLog,bindClicks,bindCopyEvents,bindDismissalRemoval,bsAlert,buildMap,byteCount,cancelAsyncOperation,canonicalizePoint,cartoAccount,cartoMap,cartoVis,checkFileVersion,checkLoggedIn,cleanupToasts,copyText,createConvexHull,createMap,createMap2,createRawCartoMap,d$,dateMonthToString,deEscape,decode64,deepJQuery,defaultFillColor,defaultFillOpacity,defaultMapMouseOverBehaviour,delay,disableDebugLogging,doCORSget,doMapBuilder,doNothing,downloadCSVFile,downloadCSVFileOnThread,e,enableDebugLogging,encode64,error1,fPoint,featureClickEvent,fetchCitation,fixTruncatedJson,foo,formatScientificNames,gMapsApiKey,generateCSVFromResults,getColumnObj,getConvexHull,getConvexHullConfig,getConvexHullPoints,getCorners,getElementHtml,getLocation,getMapCenter,getMapZoom,getMaxZ,getPointsFromBoundingBox,getPointsFromCartoResult,getPosterFromSrc,goTo,interval,isArray,isBlank,isBool,isEmpty,isHovered,isJson,isNull,isNumber,jsonTo64,lightboxImages,linkUsers,loadJS,localityFromMapBuilder,makePageCitationOverflow,mapNewWindows,openLink,openTab,overlayOff,overlayOn,p$,post64,prepURI,randomInt,randomString,reInitMap,reportDebugLog,roundNumber,roundNumberSigfig,safariDialogHelper,setupMapMarkerToggles,sortPointX,sortPointY,sortPoints,sortPointsXY,speculativeApiLoader,startLoad,stopLoad,stopLoadError,toFloat,toInt,toObject,toastStatusMessage,toggleGoogleMapMarkers,uri,validateAWebTaxon,slice=[].slice,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},modulo=function(a,b){return(+a%(b=+b)+b)%b};try{uri=new Object,uri.o=$.url(),uri.urlString=uri.o.attr("protocol")+"://"+uri.o.attr("host")+uri.o.attr("directory"),uri.query=uri.o.attr("fragment")}catch(a){e=a,console.warn("PURL not installed!")}window.locationData=new Object,locationData.params={enableHighAccuracy:!0},locationData.last=void 0,window.debounce_timer=null,null==window.adminParams&&(window.adminParams=new Object),null==window._adp&&(window._adp=new Object),isBool=function(a,b){if(null==b&&(b=!1),b)return"boolean"==typeof a;try{return"boolean"==typeof a?a===!0||a===!1:"string"==typeof a?"true"===a.toLowerCase()||"false"===a.toLowerCase():"number"==typeof a&&(1===a||0===a)}catch(a){return e=a,!1}},isEmpty=function(a){return!a||0===a.length},isBlank=function(a){return!a||/^\s*$/.test(a)},isNull=function(a,b){var c;if(null==b&&(b=!1),"object"==typeof a)try{if(c=a.length,null!=c)try{return 0===c}catch(a){}return 0===Object.size}catch(a){}try{if(isEmpty(a)||isBlank(a)||null==a){if(a!==!1&&0!==a)return!0;if(b&&(a===!1||0===a))return!0}}catch(a){return e=a,!1}try{a=a.toString().toLowerCase()}catch(a){}return"undefined"===a||"null"===a||!(!b||"false"!==a&&"0"!==a)},isJson=function(a){if("object"==typeof a&&!isArray(a))return!0;try{return JSON.parse(a),!0}catch(a){return!1}return!1},isArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),!0}catch(a){return!1}},isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},toFloat=function(a){return!isNumber(a)||isNull(a)?0:parseFloat(a)},toInt=function(a){var b;return"string"==typeof a&&(a=a.replace("px","").replace("em","").replace("rem","").replace("vw","").replace("vh","")),!isNumber(a)||isNull(a)?0:(b=parseFloat(a),parseInt(b))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var a;return a=this.toString().toLowerCase(),"true"===a||"1"===a},Boolean.prototype.toBool=function(){return"true"===this.toString()},Number.prototype.toBool=function(){return"1"===this.toString()},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(a){var b;try{return b=_.find(this,function(b){return _.isEqual(a,b)}),"object"==typeof b}catch(a){return e=a,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),a}catch(a){}return Object.keys(a).map(function(b){return function(b){return a[b]}}(this))},Object.size=function(a){var b,c;if("object"!=typeof a)try{return a.length}catch(a){e=a,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(e.message)}c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},Object.doOnSortedKeys=function(a,b){var c,d,e,f,g,h;for(g=Object.keys(a).sort(),f=[],h=0,e=g.length;h<e;h++)d=g[h],c=a[d],f.push(b(c));return f},delay=function(a,b){return setTimeout(b,a)},interval=function(a,b){return setInterval(b,a)},roundNumber=function(a,b){var c;return null==b&&(b=0),c=Math.pow(10,b),Math.round(a*c)/c},roundNumberSigfig=function(a,b){var c,d,e,f,g;return null==b&&(b=0),e=roundNumber(a,b).toString(),c=e.split("."),1===c.length?e+"."+Array(b+1).join("0"):(g=c.pop(),f=c[0]+".",g.length===b?e:(d=b-g.length,g+=Array(d+1).join("0"),""+f+g))},String.prototype.stripHtml=function(a){var b;return null==a&&(a=!1),b=this,a&&(b=b.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),b=b.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),b=b.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(a){var b,c,d;return null==a&&(a=!1),c=document.createElement("div"),b=function(b){return null!=b&&"string"==typeof b&&(a!==!0?b=escape(b).replace(/%26/g,"&").replace(/%23/g,"#").replace(/%3B/g,";"):(b=b.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),b=b.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")),c.innerHTML=b,c.innerText?(b=c.innerText,c.innerText=""):(b=c.textContent,c.textContent="")),unescape(b)},d=deEscape(this),b(d)},deEscape=function(a){return a=a.replace(/\&amp;#/gm,"&#"),a=a.replace(/\&quot;/gm,'"'),a=a.replace(/\&quote;/gm,'"'),a=a.replace(/\&#95;/gm,"_"),a=a.replace(/\&#39;/gm,"'"),a=a.replace(/\&#34;/gm,'"'),a=a.replace(/\&#62;/gm,">"),a=a.replace(/\&#60;/gm,"<")},String.prototype.escapeQuotes=function(){var a;return a=this.replace(/"/gm,"&#34;"),a=a.replace(/'/gm,"&#39;")},getElementHtml=function(a){return a.outerHTML},jQuery.fn.outerHTML=function(){return e=$(this).get(0),e.outerHTML},jQuery.fn.outerHtml=function(){return $(this).outerHTML()},jQuery.fn.selectText=function(){var a,b,c=document,d=this[0];c.body.createTextRange?(a=document.body.createTextRange(),a.moveToElementText(d),a.select()):window.getSelection&&(b=window.getSelection(),a=document.createRange(),a.selectNodeContents(d),b.removeAllRanges(),b.addRange(a))},copyText=function(a,b,c){var d,e,f,g;if(null==window.copyDebouncer&&(window.copyDebouncer=new Object),Date.now()-window.copyDebouncer.last<300)return console.warn("Skipping copy on debounce"),!1;window.copyDebouncer.last=Date.now(),f=md5($(c).html());try{return e={dataType:"text/plain",data:a},d=new ClipboardEvent("copy",e),document.dispatchEvent(d),!1}catch(a){}return null!=(null!=(g=_adp.copyObject)?g[f]:void 0)?(e={"text/plain":a},console.info('Setting up clipboard events for "'+a+'"'),_adp.copyObject[f].setData(e),_adp.copyObject[f].on("copy",function(a){try{return a.clipboardData={setData:_adp.copyObject[f].setData(e)}}catch(a){}}),_adp.copyObject[f].on("aftercopy",function(b){return b.data["text/plain"]===a?(toastStatusMessage("Copied to clipboard"),console.info("Succesfully copied",b.data["text/plain"]),window.hasRetriedCopy=!1):b.data["text/plain"]?(console.warn("Incorrect copy: instead of '"+a+"', '"+b.data["text/plain"]+"'"),window.hasRetriedCopy?(console.error("Re-copy failed!"),toastStatusMessage("Error copying to clipboard. Please try again")):(window.hasRetriedCopy=!0,delete window.copyDebouncer.last,delay(100,function(){return console.warn("Re-trying copy"),$(c).click(),console.info("Sent click")}))):(console.error("Bad data passed",b.data["text/plain"]),toastStatusMessage("Error copying to clipboard. Please try again"),window.hasRetriedCopy=!1),window.resetClipboard=!1,_adp.copyObject[f].setData(e)}),_adp.copyObject[f].on("error",function(b){if(console.error("Error copying to clipboard"),console.warn("Got",b),"flash-overdue"===b.name){if(window.resetClipboard===!0)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return window.resetClipboard=!0,copyLink(window.tempZC,a)}),window.tempZC=new ZeroClipboard(c)}if("flash-disabled"===b.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),$(".click-copy").remove(),p$("paper-dialog").refit(),toastStatusMessage("Clipboard copying isn't available on your system")})):console.error("Can't copy: zcObject doesn't exist for identifier "+f),!1},bindCopyEvents=function(a){return null==a&&(a=".click-copy"),loadJS("bower_components/zeroclipboard/dist/ZeroClipboard.min.js",function(){var b,c,d,e,f,g,h,i,j;for(j={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},ZeroClipboard.config(j),f=$(a),g=[],h=0,e=f.length;h<e;h++)if(c=f[h],d=md5($(c).html()),null==_adp.copyObject&&(_adp.copyObject=new Object),null==_adp.copyObject[d]){if(console.info("Setting up copy events for identifier",d),_adp.copyObject[d]=new ZeroClipboard(c),i=$(c).attr("data-clipboard-text"),isNull(i)&&(b=$(c).attr("data-copy-selector"),i=$(b).val(),isNull(i)))try{i=p$(b).value}catch(a){}console.info("Registering copy text",i);try{delete window.copyDebouncer.last}catch(a){}g.push(copyText(i,_adp.copyObject[d],c))}else g.push(console.info("Copy event already set up for identifier",d));return g}),!1},jsonTo64=function(a,b){var c,d,e;null==b&&(b=!0);try{e=a.slice(0),e.push("foo"),a=toObject(a)}catch(a){}return d=JSON.stringify(a),c=b===!0?post64(d):encode64(c)},encode64=function(a){try{return Base64.encode(a)}catch(b){return e=b,console.warn("Bad encode string provided"),a}},decode64=function(a){try{return Base64.decode(a)}catch(b){return e=b,console.warn("Bad decode string provided"),a}},post64=function(a){var b,c;return c=encode64(a),b=encodeURIComponent(c)},jQuery.fn.polymerSelected=function(a,b){var c,d,f;if(null==a&&(a=void 0),null==b&&(b="attrForSelected"),c=$(this).attr(b),null==a){f=void 0;try{f=$(this).get(0).selected,isNumber(f)&&!isNull(c)&&(d=$(this).find("paper-item")[toInt(f)],f=$(d).attr(c))}catch(a){return e=a,!1}return"null"!==f&&null!=f||(f=void 0),f}if(isBool(a)){if($(this).parent().children().removeAttribute("aria-selected"),$(this).parent().children().removeAttribute("active"),$(this).parent().children().removeClass("iron-selected"),$(this).prop("selected",a),$(this).prop("active",a),$(this).prop("aria-selected",a),a===!0)return $(this).addClass("iron-selected")}else try{return $(this).get(0).select(a)}catch(a){return e=a,!1}},jQuery.fn.polymerChecked=function(a){var b;return null==a&&(a=void 0),null!=a?jQuery(this).prop("checked",a):(b=jQuery(this)[0].checked,"null"!==b&&null!=b||(b=void 0),b)},isHovered=function(a){return $(a+":hover").length>0},jQuery.fn.exists=function(){return jQuery(this).length>0},jQuery.fn.isVisible=function(){return jQuery(this).is(":visible")&&"hidden"!==jQuery(this).css("visibility")},jQuery.fn.hasChildren=function(){return Object.size(jQuery(this).children())>3},byteCount=function(a){return function(a){return encodeURI(a).split(/%..|./).length-1}}(this),toObject=function(a){var b,c,d;d=new Object;for(c in a)b=a[c],void 0!==b&&(d[c]=b);return d},loadJS=function(a,b,c){var d,f,g;if(null==b&&(b=new Object),null==c&&(c=!0),$("script[src='"+a+"']").exists()){if("function"==typeof b)try{b()}catch(a){e=a,console.error("Script is already loaded, but there was an error executing the callback function - "+e.message)}return!0}return g=document.createElement("script"),g.setAttribute("src",a),g.setAttribute("async","async"),g.setAttribute("type","text/javascript"),g.src=a,g.async=!0,f=function(){var c;c=g.readyState;try{if(!b.done&&(!c||/loaded|complete/.test(c))&&(b.done=!0,"function"==typeof b))try{return b()}catch(b){return e=b,console.error("Postload callback error for "+a+" - "+e.message),console.warn(e.stack)}}catch(a){return e=a,console.error("Onload error - "+e.message)}},d=function(){console.warn("There may have been a problem loading "+a);try{if(!b.done&&(b.done=!0,"function"==typeof b&&c))try{return b()}catch(a){return e=a,console.error("Post error callback error - "+e.message)}}catch(a){return e=a,console.error("There was an error in the error handler! "+e.message)}},g.setAttribute("onload",f),g.setAttribute("onreadystate",f),g.setAttribute("onerror",d),g.onload=g.onreadystate=f,g.onerror=d,document.getElementsByTagName("head")[0].appendChild(g),!0},String.prototype.toTitleCase=function(){var a,b,c,d,e,f,g,h,i,j,k;for(f=this.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),e=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],g=0,a=e.length;g<a;g++)c=e[g],d=new RegExp("\\s"+c+"\\s","g"),f=f.replace(d,function(a){return a.toLowerCase()});for(k=["Id","Tv"],h=0,b=k.length;h<b;h++)i=k[h],j=new RegExp("\\b"+i+"\\b","g"),f=f.replace(j,i.toUpperCase());return f},Function.prototype.getName=function(){var a;return a=this.name,null==a&&(a=this.toString().substr(0,this.toString().indexOf("(")).replace("function ","")),isNull(a)&&(a=md5(this.toString())),a},Function.prototype.debounce=function(){var a,b,c,d,f,g,h,i;h=arguments[0],c=arguments[1],i=arguments[2],a=4<=arguments.length?slice.call(arguments,3):[],null==h&&(h=300),null==c&&(c=!1),null==i&&(i=window.debounce_timer),null==(null!=(g=window.core)?g.debouncers:void 0)&&(null==window.core&&(window.core=new Object),core.debouncers=new Object);try{f=this.getName()}catch(a){}try{null!=core.debouncers[f]&&(i=core.debouncers[f])}catch(a){}if(d=this,b=function(){return null!=f&&(clearTimeout(i),delete core.debouncers[f]),c||d.apply(d,a),console.info("Debounce applied")},null!=i)try{clearTimeout(i)}catch(a){e=a}return c?(d.apply(obj,a),console.log("Executed "+f+" immediately"),!1):null!=f?(console.log("Debouncing '"+f+"' for "+h+" ms"),core.debouncers[f]=delay(h,function(){return b()})):(console.log("Delaying '"+f+"' for "+h+" ms"),window.debounce_timer=delay(h,function(){return b()}))},randomInt=function(a,b){var c,d,e;return null==a&&(a=0),null==b&&(b=1),e=Math.random(),null==a&&(c=[0,a],a=c[0],b=c[1]),a>b&&(d=[b,a],a=d[0],b=d[1]),Math.floor(e*(b-a+1)+a)},randomString=function(a){var b,c,d,e,f;for(null==a&&(a=8),e=0,c=65,d=126,f=new Array;e<a;)++e,b=randomInt(c,d),f.push(String.fromCharCode(b));return f.join("")},animateLoad=function(a){var b;null==a&&(a="loader"),isNumber(a)&&(a="loader"),"#"===a.slice(0,1)?(b=a,a=a.slice(1)):b="#"+a;try{return $(b).exists()?$(b).attr("active",!0):$("body").append('<paper-spinner id="'+a+'" active></paper-spinner'),!1}catch(a){return e=a,console.log("Could not animate loader",e.message)}},startLoad=animateLoad,stopLoad=function(a,b){var c;null==a&&(a="loader"),null==b&&(b=1e3),"#"===a.slice(0,1)?(c=a,a=a.slice(1)):c="#"+a;try{if($(c).exists())return $(c).addClass("good"),delay(b,function(){return $(c).removeClass("good"),$(c).removeAttr("active")})}catch(a){return e=a,console.log("Could not stop load animation",e.message)}},stopLoadError=function(a,b,c){var d;null==b&&(b="loader"),null==c&&(c=1e4),"#"===b.slice(0,1)?(d=b,b=b.slice(1)):d="#"+b;try{if($(d).exists())return $(d).addClass("bad"),null!=a&&toastStatusMessage(a,"",c),delay(c,function(){return $(d).removeClass("bad"),$(d).removeAttr("active")})}catch(a){return e=a,console.log("Could not stop load error animation",e.message)}},toastStatusMessage=function(a,b,c,d){var e,f,g;if(null==b&&(b=""),null==c&&(c=3e3),null==d&&(d="#status-message"),null==(null!=(f=window.metaTracker)?f.isToasting:void 0)&&null==window.metaTracker&&(window.metaTracker=new Object,window.metaTracker.toastTracker=new Array,window.metaTracker.isToasting=!1),window.metaTracker.isToasting)return g=delay(250,function(){return toastStatusMessage(a,b,c,d)}),window.metaTracker.toastTracker.push(g),!1;window.metaTracker.isToasting=!0,isNumber(c)||(c=3e3),d.slice(0,1)===!1&&(d="#"+d),$(d).exists()||(e='<paper-toast id="'+d.slice(1)+'" duration="'+c+'"></paper-toast>',$(e).appendTo("body")),$(d).attr("text",a).html(a).addClass(b);try{p$(d).show()}catch(a){}return delay(c+500,function(){var a;try{a=p$(d).opened}catch(b){a=!1}return a||($(d).empty(),$(d).removeClass(b),$(d).attr("text","")),window.metaTracker.isToasting=!1})},cleanupToasts=function(){var a,b,c,d,e;for(b=window.metaTracker.toastTracker,c=[],d=0,a=b.length;d<a;d++){e=b[d];try{c.push(clearTimeout(e))}catch(a){}}return c},openLink=function(a){return null!=a&&(window.open(a),!1)},openTab=function(a){return openLink(a)},goTo=function(a){return null!=a&&(window.location.href=a,!1)},mapNewWindows=function(a){var b,c,d,e;for(null==a&&(a=!0),e=[".newwindow",".newWindow",".new-window","[newwindow]","[new-window]"],d=0,b=e.length;d<b;d++)c=e[d],$(c).each(function(){var b;return b=$(this).attr("href"),null==b&&(b=$(this).attr("data-href")),$(this).click(function(c){return a&&(c.preventDefault(),c.stopPropagation()),openTab(b)}),$(this).keypress(function(){return openTab(b)})});return!1},deepJQuery=function(a){"undefined"!=typeof jQuery&&null!==jQuery||console.warn("Danger -- jQuery isn't defined. Selectors may fail.");try{if(!$("html /deep/ "+a).exists())throw"Bad /deep/ selector";return $("html /deep/ "+a)}catch(b){e=b;try{if(!$("html >>> "+a).exists())throw"Bad >>> selector";return $("html >>> "+a)}catch(b){return e=b,$(p$(a))}}},d$=function(a){return deepJQuery(a)},bindClicks=function(a){return null==a&&(a=".click"),$(a).each(function(){var a,b,c,d,f,g,h,i;try{if(i=null!=(c=$(this).attr("data-href"))?c:$(this).attr("href"),!isNull(i)){try{h=$(this).prop("tagName").toLowerCase()}catch(a){h=null}try{i===uri.o.attr("path")&&"paper-tab"===h&&$(this).parent().prop("selected",$(this).index())}catch(a){e=a,console.warn("tagname lower case error")}return b=(null!=(d=$(this).attr("newTab"))?d.toBool():void 0)||(null!=(f=$(this).attr("newtab"))?f.toBool():void 0)||(null!=(g=$(this).attr("data-newtab"))?g.toBool():void 0),"a"===h&&!b||("a"===h&&$(this).keypress(function(){return openTab(i)}),$(this).unbind().click(function(a){a.preventDefault(),a.stopPropagation();try{return b?openTab(i):goTo(i)}catch(a){return goTo(i)}}),i)}if(a=$(this).attr("data-function"),null!=a)return $(this).unbind(),$(this).click(function(){var b;try{console.log("Executing bound function "+a+"()");try{b=null,isNull($(this).attr("data-args"))||(b=$(this).attr("data-args").split(","))}catch(a){}try{return null!=b?window[a].apply(window,b):window[a]()}catch(b){return window[a]()}}catch(b){return e=b,console.error("'"+a+"()' is a bad function - "+e.message)}})}catch(a){return e=a,console.error("There was a problem binding to #"+$(this).attr("id")+" - "+e.message)}}),!1},dateMonthToString=function(a){var b,c;b={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{c=b[a]}catch(b){c=a}return c},getPosterFromSrc=function(a){var b,c;try{return c=a.split("."),b=c.pop(),c.push("png"),c.join(".")}catch(a){return e=a,""}},doCORSget=function(a,b,c,d){var f,g,h,i;null==c&&(c=void 0),null==d&&(d=void 0),f=function(){if("function"==typeof d)return d();throw new Error("There was an error performing the CORS request")},h={url:a,data:b,type:"get",crossDomain:!0};try{$.ajax(h).done(function(a){return"function"==typeof c?(c(),!1):console.log(response)}).fail(function(a,b){return console.warn("Couldn't perform jQuery AJAX CORS. Attempting manually.")})}catch(a){e=a,console.warn("There was an error using jQuery to perform the CORS request. Attemping manually.")}if(a=a+"?"+b,g=function(a,b){var c;return null==a&&(a="get"),c=new XMLHttpRequest,"withCredentials"in c?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null,c},i=g("get",a),!i)throw new Error("CORS not supported");return i.onload=function(){var a;return a=i.responseText,"function"==typeof c&&c(a),console.log(a),!1},i.onerror=function(){return console.warn("Couldn't do manual XMLHttp CORS request"),f()},i.send(),!1},lightboxImages=function(a,b){var c,d;return null==a&&(a=".lightboximage"),null==b&&(b=!1),d={onStart:function(){return overlayOn()},onEnd:function(){return overlayOff(),activityIndicatorOff()},onLoadStart:function(){return activityIndicatorOn()},onLoadEnd:function(){return activityIndicatorOff()},allowedTypes:"png|jpg|jpeg|gif|bmp|webp",quitOnDocClick:!0,quitOnImgClick:!0},c=b?d$(a):$(a),loadJS("bower_components/imagelightbox/dist/imagelightbox.min.js",function(){return c.click(function(a){try{return a.preventDefault(),a.stopPropagation(),$(this).imageLightbox(d).startImageLightbox(),console.warn("Event propagation was stopped when clicking on this.")}catch(b){return a=b,console.error("Unable to lightbox this image!")}}).each(function(){var b,c;console.log("Using selectors '"+a+"' / '"+this+"' for lightboximages");try{if("img"===$(this).prop("tagName").toLowerCase()&&"a"!==$(this).parent().prop("tagName").toLowerCase())return c=$(this).removeClass("lightboximage").prop("outerHTML"),b=function(){switch(!1){case!!isNull($(this).attr("data-layzr-retina")):return $(this).attr("data-layzr-retina");case!!isNull($(this).attr("data-layzr")):return $(this).attr("data-layzr");case!!isNull($(this).attr("data-lightbox-image")):return $(this).attr("data-lightbox-image");default:return $(this).attr("src")}}.call(this),$(this).replaceWith("<a href='"+b+"' class='lightboximage'>"+c+"</a>"),$("a[href='"+b+"']").imageLightbox(d)}catch(a){return e=a,console.log("Couldn't parse through the elements")}}),console.info("Lightboxed the following:",c)})},activityIndicatorOn=function(){return $('<div id="imagelightbox-loading"><div></div></div>').appendTo("body")},activityIndicatorOff=function(){return $("#imagelightbox-loading").remove(),$("#imagelightbox-overlay").click(function(){return $("#imagelightbox").click()})},overlayOn=function(){return $('<div id="imagelightbox-overlay"></div>').appendTo("body")},overlayOff=function(){return $("#imagelightbox-overlay").remove()},formatScientificNames=function(a){return null==a&&(a=".sciname"),$(".sciname").each(function(){var a;return a="italic"===$(this).css("font-style")?"normal":"italic",$(this).css("font-style",a)})},prepURI=function(a){return a=encodeURIComponent(a),a.replace(/%20/g,"+")},window.locationData=new Object,locationData.params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(a){var b,c,d;return null==a&&(a=void 0),d=1500,c=function(b){var c,e;return clearTimeout(window.geoTimeout),window.locationData.lat=b.coords.latitude,window.locationData.lng=b.coords.longitude,window.locationData.acc=b.coords.accuracy,e=window.locationData.last,window.locationData.last=Date.now(),c=window.locationData.last-e,!(c<d)&&(console.info("Successfully set location"),"function"==typeof a&&a(window.locationData),!1)},b=function(b){var c;return clearTimeout(window.geoTimeout),c=function(){switch(b.code){case 0:return"There was an error while retrieving your location: "+b.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+b.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(c),"function"==typeof a&&a(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(c,b,window.locationData.params),window.geoTimeout=delay(1500,function(){return getLocation(a)})):(console.warn("This browser doesn't support geolocation!"),null!=a?a(!1):void 0)},getMaxZ=function(){var a;return a=function(){return $.map($("body *"),function(a,b){if("static"!==$(a).css("position"))return parseInt($(a).css("z-index")||1)})},Math.max.apply(null,a())},foo=function(){return toastStatusMessage("Sorry, this feature is not yet finished"),stopLoad(),!1},safariDialogHelper=function(a,b,c){var d,f;if(null==a&&(a="#download-chooser"),null==b&&(b=0),"function"!=typeof c&&(c=function(){return bindDismissalRemoval()}),!(b<10))return stopLoadError("Unable to show dialog. Please try again.");try{return d$(a).get(0).open(),delay(125,function(){return d$(a).get(0).refit()}),"function"==typeof c&&c(),stopLoad()}catch(g){return e=g,f=b+1,d=250,delay(d,function(){return console.warn("Trying again to display dialog after "+f*d+"ms"),safariDialogHelper(a,f,c)})}},bindDismissalRemoval=function(){return $("[dialog-dismiss]").unbind().click(function(){return $(this).parents("paper-dialog").remove()})},p$=function(a){try{return $$(a)[0]}catch(b){return $(a).get(0)}},bsAlert=function(a,b,c,d){var e,f;return null==b&&(b="warning"),null==c&&(c="body"),null==d&&(d="#bs-alert"),$(d).exists()?($(d).removeClass("alert-warning alert-info alert-danger alert-success"),$(d).addClass("alert-"+b)):(e='<div class="alert alert-'+b+' alert-dismissable hanging-alert" role="alert" id="'+d.slice(1)+'">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    <div class="alert-message"></div>\n</div>',f=$("main").exists()?"main":$("article").exists()?"article":c,$(f).prepend(e)),$(d+" .alert-message").html(a),bindClicks(),mapNewWindows(),!1},animateHoverShadows=function(a,b,c){var d,e;return null==a&&(a="paper-card.card-tile"),null==b&&(b=2),null==c&&(c=4),d=function(){return $(this).attr("elevation",c)},e=function(){return $(this).attr("elevation",b)},$(a).hover(d,e),!1},allError=function(a){return stopLoadError(a),bsAlert(a,"danger"),console.error(a),!1},checkFileVersion=function(a,b,c){var d,e,f;null==a&&(a=!1),null==b&&(b="js/c.min.js"),null==("undefined"!=typeof _adp&&null!==_adp?_adp.lastModChecked:void 0)&&(null==window._adp&&(window._adp=new Object),window._adp.lastModChecked=new Object),e=b.split("/").pop().split(".")[0],d=function(f,g){return null==f&&(f=b),null==g&&(g=e),$.get(uri.urlString+"meta.php","do=get_last_mod&file="+f,"json").done(function(b){var c;return window._adp.lastModChecked[g]=Date.now(),a&&doNothing(),!!isNumber(b.last_mod)&&(null==_adp.lastMod&&(window._adp.lastMod=new Object),null==_adp.lastMod[g]&&(window._adp.lastMod[g]=b.last_mod),b.last_mod>_adp.lastMod[g]?(c='<div id="outdated-warning" class="alert alert-warning alert-dismissible fade in" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <strong>We have page updates!</strong> This page has been updated since you last refreshed. <a class="alert-link" id="refresh-page" style="cursor:pointer">Click here to refresh now</a> and get bugfixes and updates.\n</div>',$("#outdated-warning").exists()||($("body").append(c),$("#refresh-page").click(function(){return document.location.reload(!0)})),console.warn("Your current version of this page is out of date! Please refresh the page.")):a?doNothing():void 0)}).fail(function(){return console.warn("Couldn't check file version!!")}).always(function(){if(delay(3e5,function(){return d(f,g)}),"function"==typeof c)return c()})};try{f=window._adp.lastMod[e]}catch(a){f=!1}if(a||null==window._adp.lastMod||!f){try{Date.now()-toInt(window._adp.lastModChecked[e])<15e3||d(b,e)}catch(a){d(b,e)}return!0}return!1},window.checkFileVersion=checkFileVersion,fixTruncatedJson=function(a){var b,c,d,e,f;for(c=a,b=c,e=!1,d=!1,f=[];d=b.match(/[^\{\[\]\}"]*([\{\[\]\}"])/);){switch(d[1]){case"{":f.push("}");break;case"[":f.push("]");break;case"}":case"]":f.pop();break;case'"':e?(e=!1,f.pop()):(e=!0,f.push('"'))}b=b.substring(d[0].length)}for(":"===b[b.length-1]&&(c+='""');f.length;)c+=f.pop();try{return JSON.parse(c)}catch(a){return!1}},checkLoggedIn=function(a){var b,c,d,e,f;return c=$.cookie(uri.domain+"_auth"),f=$.cookie(uri.domain+"_secret"),d=$.cookie(uri.domain+"_link"),b="hash="+c+"&secret="+f+"&dblink="+d,e=uri.urlString+"admin/async_login_handler.php",$.post(e,b,"json").done(function(b){return console.info("Got",b),a(b)}).fail(function(b,c){var d;return d={status:!1},a(d)}),!1},doNothing=function(){return null},downloadCSVFile=function(a,b,c){var d,f;try{d={action:"csv",data:a,options:b},f=new Worker("js/global-search-worker.min.js"),console.info("Generating an off-thread worker for CSV population"),f.addEventListener("message",function(a){var d,e,f;if(e=a.data.html,d=a.data.file,b=a.data.options,console.info("CSV Web worker returned",a.data),f=function(){var a;return a=b.selector,b.create===!0?$(a).append(e):$(a).attr("download",b.downloadFile).attr("href",d).removeClass("disabled").removeAttr("disabled"),!1},"function"!=typeof c)return f();try{return c(function(){return f()})}catch(a){return f()}}),f.postMessage(d)}catch(c){e=c,console.warn("Web workers aren't supported or otherwise failed"),console.warn(e.message),console.warn("Doing work on-thread"),downloadCSVFileOnThread(a,b)}return!1},downloadCSVFileOnThread=function(a,b){var c,d,f,g,h,i,j,k,l,m,n,o,p,q,r;if(r="",isJson(a))console.info("Parsing as JSON string"),l=JSON.parse(a);else if(isArray(a))console.info("Parsing as array"),l=toObject(a);else{if("object"!=typeof a)return console.error("Unexpected data type '"+typeof a+"' for downloadCSVFile()",a),!1;console.info("Parsing as object"),
l=a}for(null==b&&(b=new Object),null==b.create&&(b.create=!1),null==b.downloadFile&&(b.downloadFile="datalist.csv"),null==b.classes&&(b.classes="btn btn-default"),null==b.buttonText&&(b.buttonText="Download File"),null==b.iconHtml&&(b.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==b.selector&&(b.selector="#download-file"),null==b.splitValues&&(b.splitValues=!1),null==b.cascadeObjects&&(b.cascadeObjects=!1),null==b.objectAsValues&&(b.objectAsValues=!0),h=new Array,(o=function(c,d){var f,g,i,j,k,l,m,n,p,q,s,t;n=0,b.objectAsValues&&(b.splitValues="::@@::"),m=[];for(k in c)if(t=c[k],"function"!=typeof t){++n;try{if(i=k.toString().replace(/"/g,'""'),1===n)if(b.objectAsValues){console.info("objectAsValues set");for(f in t)a=t[f],isArray(b.acceptableCols)?indexOf.call(b.acceptableCols,f)>=0&&h.push(f):h.push(f);console.log("Using as header",h)}else console.log("Boring options",b.objectAsValues,b),h.push(i);if("object"==typeof t&&d&&(t=o(t,!0)),j=function(a,c){var d,e,f,g;return null==a&&(a=t),null==c&&(c=b),isNull(t)?d="":("object"==typeof a&&(a=JSON.stringify(a)),a=a.toString(),e=a.replace(/"/g,'""'),e=e.replace(/,/g,","),e=e.replace(/<\/p><p>/g,'","'),"string"==typeof c.splitValues&&(f=e.split(c.splitValues),e=f.join('","'),i=!1),d=e),i===!1?g='"'+d+'"\n':isNumber(i)?g='"'+d+'",':isNull(i)||(g='"'+i+'","'+d+'"\n'),g},b.objectAsValues){for(q=new Array,p=0,l=h.length;p<l;p++){if(f=h[p],g=t[f],"object"==typeof g)try{g=JSON.stringify(g),g=g.replace(/"/g,'""')}catch(a){}q.push(g)}s=q.join(b.splitValues),m.push(r+=j(s,b))}else m.push(r+=j(t))}catch(a){e=a,console.warn("Unable to run key "+k+" on row "+n,t,c),m.push(console.warn(e.stack))}}return m})(l,b.cascadeObjects),r=r.trim(),m=0,q=0,n=h.length;q<n;q++)d=h[q],d=d.replace(/"/g,'""'),h[m]=d,++m;return b.objectAsValues&&(b.header=h),isArray(b.header)?(i=b.header.join('","'),r='"'+i+'"\n'+r,r=r.trim(),g="present"):g="absent",","===r.slice(-1)&&(r=r.slice(0,-1)),f="data:text/csv;charset=utf-8;header="+g+","+encodeURIComponent(r),p=b.selector,b.create===!0?(c=$(p).find("button").length,k=p.slice(1)+"-download-button-"+c,j='<a id="'+k+'" class="'+b.classes+'" href="'+f+'" download="'+b.downloadFile+'">\n  '+b.iconHtml+"\n  "+b.buttonText+"\n</a>",$(p).append(j)):$(p).attr("download",b.downloadFile).attr("href",f),f},linkUsers=function(a){var b,c;return null==a&&(a=".is-user"),c="https://amphibiandisease.org/profile.php",b="?id=",$(a).addClass("linked-user-profile").attr("title","Visit Profile").attr("data-toggle","tooltip").click(function(){var a,d,e,f,g,h,i;if(i=$(this).attr("data-uid"),h=$(this).attr("data-email"),!isNull(i))return e=""+c+b+i,document.location.href=e,!1;if(isNull(h)){if(g=$(this).text(),isNull(g)&&(g=$(this).attr("data-name"),isNull(g)))return console.error("Unable to find a search criterion!"),!1;d="name"}else g=h,d="username,alternate_email";return startLoad(),f=encodeURIComponent(g),a="action=search_users&q="+f+"&cols="+d,$.post(uri.urlString+"api.php",a,"json").done(function(a){var d,f,h;return console.info("Found",a),a.status!==!0?(console.error("Error searching for profile"),stopLoadError("There was an error looking up the user. Please try again later."),!1):(f=Object.toArray(a.result),f.length<1?(stopLoadError("Couldn't find user '"+g+"'"),!1):(stopLoad(),d=f[0],h=d.uid,e=""+c+b+h,document.location.href=e,!1))}).fail(function(a,b){return console.error(a,b),stopLoadError("Error communicating with server. Please try again later."),!1}),!1}),!1},fetchCitation=function(a,b){var c,d,f;return d="https://api.crossref.org/works/",c=encodeURIComponent(a),f=""+d+a,$.get(f,"","json").done(function(c){var d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;for(console.info("Citation base",c),s=c.message,h=new Array,o=0,f=", ",x=s.author,G=0,t=x.length;G<t;G++){for(d=x[G],q=d.given.split(" "),p="",H=0,u=q.length;H<u;H++)n=q[H],v=n.slice(0,1),p+=v;if(g=d.family+" "+p,h.push(g),++o,o>2){++o,h.push("et al");break}}2===o&&(f=" and "),w=null!=(y=null!=(z=null!=(A=s["published-print"])&&null!=(B=A["date-parts"])&&null!=(C=B[0])?C[0]:void 0)?z:null!=(D=s["published-online"])&&null!=(E=D["date-parts"])&&null!=(F=E[0])?F[0]:void 0)?y:"In press",r=isNull(s.issue)?"":"("+s.issue+")",isNull(s.volume)&&(s.volume=""),J=isNull(s.volume)&&isNull(r)?"":""+s.volume+r+":";try{try{k=s.DOI,m=k.replace(/[^0-9]/gm,""),l=m.slice(-8),j=" "+l+"; doi: "+k}catch(a){j=s.page+"."}i=h.join(f)+". "+w+" "+s.title[0]+". "+s["container-title"][0]+" "+J+j}catch(a){e=a,console.warn("Couldn't generate full citation"),console.warn(s),i=h.join(", ")+". "+s.title[0]+". "+s["container-title"][0]+". In press."}if(console.log(i),"function"==typeof b){try{I=isNull(s.URL)?s.link[0].URL:s.URL,I.search("http:")!==-1&&(I=I.replace(/^(http):\/\/(([a-z0-9]+\.?)+)(.*)$/g,"https://$2$4"))}catch(b){I="https://dx.doi.og/"+a}try{b(i,I)}catch(a){e=a,console.error("Callback failed, couldn't display citation - "+e.message),console.warn(e.stack),stopLoadError("Failed to display citation")}}return!1}).fail(function(a,b){return console.error("Failed to fetch citation"),stopLoadError("Failed to fetch citation")}),!1},cancelAsyncOperation=function(a,b){null==b&&(b=_adp.currentAsyncJqxhr);try{null!=a&&$(a).remove()}catch(a){}try{if(b.readyState===XMLHttpRequest.DONE)return console.warn("Couldn't cancel operation -- it's already completed"),!1;b.abort();try{stopLoadBarsError(null,"Operation Cancelled")}catch(a){stopLoadError("Operation Cancelled")}}catch(a){console.error("Couldn't abort current async operation")}return!1},generateCSVFromResults=function(a,b,c){var d,e;null==c&&(c="#modal-sql-details-list"),e=Date.now(),console.info("Source CSV data:",a),d={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv",acceptableCols:["collectionid","catalognumber","fieldnumber","sampleid","diseasetested","diseasestrain","samplemethod","sampledisposition","diseasedetected","fatal","cladesampled","genus","specificepithet","infraspecificepithet","lifestage","dateidentified","decimallatitude","decimallongitude","alt","coordinateuncertaintyinmeters","collector","fimsextra","originaltaxa"]};try{downloadCSVFile(a,d,function(){var a,d;return $("#download-file").remove(),d='<a tabindex="-1" id="download-file" class="paper-button-link">\n  <paper-button disabled>\n    <iron-icon icon="icons:cloud-download"></iron-icon>\n    Download File\n  </paper-button>\n</a>',$(b).replaceWith(d),$(c+" #download-file paper-button").removeAttr("disabled"),a=Date.now()-e,console.debug("GenerateCSVFromResults completed in "+a+"ms"),stopLoad()})}catch(a){animateLoad(),stopLoadError("Sorry, there was a problem with this dataset and we can't generate a downloadable file.")}return!1},validateAWebTaxon=function(a,b){var c,d,e;return null==b&&(b=null),null==(null!=(e=window.validationMeta)?e.validatedTaxons:void 0)&&("object"!=typeof window.validationMeta&&(window.validationMeta=new Object),window.validationMeta.validatedTaxons=new Array),d=function(a){return"function"==typeof b&&b(a),!1},window.validationMeta.validatedTaxons.containsObject(a)?(console.info("Already validated taxon, skipping revalidation",a),d(a),!1):(c="action=validate&genus="+a.genus+"&species="+a.species,null!=a.subspecies&&(c+="&subspecies="+a.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(b){return b.status?(a.genus=b.validated_taxon.genus,a.species=b.validated_taxon.species,a.subspecies=b.validated_taxon.subspecies,null==a.clade&&(a.clade=b.validated_taxon.family),window.validationMeta.validatedTaxons.push(a)):a.invalid=!0,a.response=b,d(a),!1}).fail(function(b,c){var d;return d=a.genus+" "+a.species,d=null!=a.subspecies?d+" "+a.subspecies:d,bsAlert("<strong>Problem validating taxon:</strong> "+d+" couldn't be validated."),console.warn("Warning: Couldn't validated "+d+" with AmphibiaWeb")}),!1)},makePageCitationOverflow=function(){var a,b,c,d,e,f,g,h,i,j,k;for(j=["project_id","id","projectid"],k=0,f=j.length;k<f;k++)if(i=j[k],!isNull(uri.o.param(i)))return console.info("Not creating overflow citation - page is project-specific"),!1;if("admin-login.php"===uri.o.data.seg.path[0])return!1;c=new Date,h=dateMonthToString(c.getMonth()),b="AmphibiaWeb. "+c.getUTCFullYear()+". "+$("title").text()+" &lt;"+uri.o.data.attr.source+"&gt;. University of California, Berkeley, CA, USA. Accessed "+c.getUTCDate()+" "+h+" "+c.getUTCFullYear()+".",a='<paper-dialog id="page-citation" modal>\n  <h2>Citation</h2>\n  <paper-dialog-scrollable>\n    <div>\n      <p style="opacity:0">\n        '+b+'\n      </p>\n      <paper-input value="'+b.escapeQuotes()+'" label="Citation" readonly></paper-input>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',e="dialog-trigger-item";try{d=document.createElement("paper-item"),d.setAttribute("id",e),d.textContent="Show Citation",g=p$("header paper-menu"),Polymer.dom(g).appendChild(d)}catch(a){d='<paper-item id="'+e+'">\n  Show Citation\n</paper-item>',$("header paper-menu-button .paper-menu").append(d)}return $("#page-citation").remove(),$("body").append(a),delay(250,function(){return $("#"+e).click(function(){return console.debug("Clicked trigger item"),p$("#page-citation").open()})}),b},$(function(){bindClicks(),formatScientificNames(),lightboxImages(),animateHoverShadows(),checkFileVersion(),linkUsers();try{$(".do-mailto").click(function(){var a;return a=$(this).attr("data-email"),document.location.href="mailto:"+a,!1})}catch(a){}try{$("body").tooltip({selector:"[data-toggle='tooltip']"})}catch(a){e=a,console.warn("Tooltips were attempted to be set up, but do not exist")}try{checkAdmin(),("undefined"!=typeof adminParams&&null!==adminParams?adminParams.loadAdminUi:void 0)===!0?loadJS("js/admin.js",function(){return console.info("Loaded admin file"),loadAdminUi()}):console.info("No admin setup requested"),$("header .header-bar-user-name").click(function(){return goTo(uri.urlString+"profile.php")})}catch(a){}loadJS(uri.urlString+"js/prism.js");try{return makePageCitationOverflow()}catch(a){}}),uri.domain=uri.o.attr("host").split(".").reverse().pop(),cartoAccount="mvz",gMapsApiKey="AIzaSyAZvQMkfFkbqNStlgzNjw1VOWBASd74gq4",cartoMap=null,cartoVis=null,defaultFillColor="#ff7800",defaultFillOpacity=.35,adData=new Object,window.geo=new Object,geo.GLOBE_WIDTH_GOOGLE=256,geo.initLocation=function(){try{return window.locationData.lat=37.871527,window.locationData.lng=-122.262113,getLocation(function(){return _adp.currentLocation=new Point(window.locationData.lat,window.locationData.lng)})}catch(a){}},geo.init=function(a){var b;try{window.locationData.lat=37.871527,window.locationData.lng=-122.262113,getLocation(function(){return _adp.currentLocation=new Point(window.locationData.lat,window.locationData.lng)})}catch(a){}return b='<link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />',$("head").append(b),null==a&&(a=function(){return getCanonicalDataCoords(geo.dataTable),!1}),window.gMapsCallback=function(){return a()},speculativeApiLoader()},speculativeApiLoader=function(){var a,b,c;if(!isNull("undefined"!=typeof google&&null!==google&&null!=(c=google.maps)?c.Geocoder:void 0))return a=function(){var a;if(!isNull("undefined"!=typeof google&&null!==google&&null!=(a=google.maps)?a.Geocoder:void 0)){try{console.debug("API element was insufficient. Loading direct API")}catch(a){}return loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=gMapsCallback")}},$("google-maps-api").exists()?a():(b='<google-maps-api\n  api-key="'+gMapsApiKey+'" >\n</google-maps-api>',$("head").append(b),$("google-maps-api").on("api-load",function(){try{return window.gMapsCallback()}catch(a){}}),delay(300,function(){return a()}));try{return window.gMapsCallback()}catch(a){}},getMapCenter=function(a){var b,c,d,e,f,g,h,i,j,k,l;if(null==a&&(a=geo.canonicalBoundingBox),null!=a){for(g=0,k=0,l=0,b=Object.toArray(a),j=0,h=b.length;j<h;j++)f=b[j],++g,i=canonicalizePoint(f),k+=i.lat,l+=i.lng;d=toFloat(k)/toFloat(g),e=toFloat(l)/toFloat(g),c={lat:d,lng:e}}else c={lat:window.locationData.lat,lng:window.locationData.lng};return c=canonicalizePoint(c)},getCorners=function(a){var b,c,d,e,f,g,h,i,j,k;for(h=new Array,f=-90,i=90,k=180,b=-180,d=0,j=0,e=a.length;j<e;j++)g=a[j],0===d&&console.debug("Sample point:",g),++d,g.lat>f&&(f=g.lat),g.lng>b&&(b=g.lng),g.lng<k&&(k=g.lng),g.lat<i&&(i=g.lat);return c={lat:f,lng:k},h.push(c),c={lat:f,lng:b},h.push(c),c={lat:i,lng:b},h.push(c),c={lat:i,lng:k},h.push(c),c={lat:f,lng:k},h.push(c),h},getPointsFromBoundingBox=function(a,b){var c,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;for(null==b&&(b=!1),A=["n","e","w","s"],n=!1,y=0,p=A.length;y<p;y++)if(l=A[y],o="bounding_box_"+l,isNull(a[o])||0===toInt(a[o])){n=!0;break}if(n){if(i=a.carto_id,"object"!=typeof i)try{g=JSON.parse(deEscape(i))}catch(a){e=a,m=e.message;try{g=JSON.parse(i)}catch(a){if(e=a,i.length>511&&(h=fixTruncatedJson(i),"object"==typeof h&&(console.debug("The carto data object was truncated, but rebuilt."),g=h)),isNull(g))return console.error("Couldn't get bounding points: cartoObj must be JSON string or obj"),!1}}else g=i;if(f=null!=(v=g.bounding_polygon)?v:g["bounding&#95;polygon"],isNull(f))return console.error("Bad bounding box set, and not a projectData object"),!1;if(isNull(f.multibounds))return console.error("Project objects with no intrinsic bounding box and no multibounds are not supported yet"),!1;for(console.debug("Using multibound coordinate assignment"),d=new Array,w=f.multibounds,B=0,q=w.length;B<q;B++)t=w[B],z=getCorners(t),console.debug("Poly got corners "+JSON.stringify(z),z),d.push(z);for(x=new Array,C=0,r=d.length;C<r;C++)c=d[C],x=x.concat(c);k=getCorners(x)}else k=[[a.bounding_box_n,a.bounding_box_w],[a.bounding_box_n,a.bounding_box_e],[a.bounding_box_s,a.bounding_box_e],[a.bounding_box_s,a.bounding_box_w]];for(u=new Array,D=0,s=k.length;D<s;D++)j=k[D],console.log("Pushing corner",j),u.push(canonicalizePoint(j));return u},null==geo.mapSelector&&(geo.mapSelector="#transect-viewport"),getMapZoom=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;if(null==b&&(b=geo.mapSelector),null==c&&(c=!0),D=$(window).width()<1024?1:2,null!=a){g=-180,y=180,o=-90,x=90,isArray(a)&&(a=toObject(a)),console.info("Working with dataset",a),Object.size(a)<3&&console.warn("Danger: Very small dataset");for(h in a)f=a[h],j=null!=f.lng?f.lng:f[1],i=null!=f.lat?f.lat:f[0],j<y&&(y=j),j>g&&(g=j),i<x&&(x=i),i>o&&(o=i);for(e=g-y,q=o-x;e<0;)e+=360;for(;q<0;)q+=360;$(b).exists()||console.warn("Can't find '"+b+"' - will use 650x480"),n=null!=(t=$(b).width())?t:650,l=null!=(u=$(b).height())?u:480,d=360/e,m=d/geo.GLOBE_WIDTH_GOOGLE,p=360/q,r=p/geo.GLOBE_WIDTH_GOOGLE,E=Math.log(n*m)/Math.LN2,s=Math.log(l*r)/Math.LN2,console.info("Calculated raw zoom",E,s),console.info("Sources",n,m,Math.LN2),s<D&&(s=100),E<D&&(E=100),z=s<E?s:E,(D>z||z>20)&&(z=7.5),A=toInt(z),console.log("Diff between zoomBasis vs zoomCalc",z-A),v=.6,w=16,B=v/w,C=B*z,z-A<C&&--A}else A=7;if(c&&$(b).exists()&&"google-map"===$(b).get(0).tagName.toLowerCase()){console.log("Trying to assign zoom");try{k=p$(b),k.isAttached?(console.info("Setting zoom on "+b+" to "+A),k.zoom=A,k.ready=function(){return k.zoom=A}):(console.info("Deferring till ready"),$(b).on("google-map-ready",function(){return k.zoom=A}))}catch(a){console.warn("Zoom setting failed!")}}return A},geo.getMapZoom=getMapZoom,defaultMapMouseOverBehaviour=function(a,b,c,d,e){return console.log(a,b,c,d,e)},createMap2=function(a,b,c){var d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W;console.log("createMap2 was provided options:",b),null==b&&(b=new Object,b={polyParams:{fillColor:defaultFillColor,fillOpacity:defaultFillOpacity},classes:"",onClickCallback:null,skipHull:!1,skipPoints:!1,boundingBox:null,selector:"#carto-map-container",bsGrid:"col-md-9 col-lg-6",resetMapBuilder:!0,onlyOne:!0}),N=null!=b.selector?b.selector:"#carto-map-container",isNull(b.onlyOne)&&(b.onlyOne=!0);try{if(H=null!=(null!=b&&null!=(J=b.polyParams)?J.fillColor:void 0)&&null!=(null!=b&&null!=(K=b.polyParams)?K.fillOpacity:void 0)?b.polyParams:{fillColor:defaultFillColor,fillOpacity:defaultFillOpacity},console.info("createMap2 working with data",a),Object.size(a)<3){try{F=Object.toArray(a)}catch(a){F=new Array}if(G=new Array,b.skipHull=!0,0===F.length)b.skipPoints=!0;else for(Q=0,s=F.length;Q<s;Q++)D=F[Q],console.log("Checking",D,"in",F),G.push(canonicalizePoint(D));if(null!=b.boundingBox){if(null!=b.boundingBox.nw)G.push(canonicalizePoint(b.boundingBox.nw)),G.push(canonicalizePoint(b.boundingBox.ne)),G.push(canonicalizePoint(b.boundingBox.sw)),G.push(canonicalizePoint(b.boundingBox.se));else for(L=b.boundingBox,T=0,t=L.length;T<t;T++)D=L[T],G.push(canonicalizePoint(D));n=createConvexHull(G),b.skipHull=!1}}else j=createConvexHull(a,!0),n=j.hull,G=j.points;console.info("createMap2 working with",G);try{W=getMapZoom(G,N),console.info("Got zoom",W)}catch(a){W=""}if(b.skipHull!==!0){for(w='<google-map-poly closed fill-color="'+H.fillColor+'" fill-opacity="'+H.fillOpacity+'" stroke-weight="1">',U=0,u=n.length;U<u;U++)D=n[U],w+='<google-map-point latitude="'+D.lat+'" longitude="'+D.lng+'"> </google-map-point>';w+="    </google-map-poly>"}else w="";if(b.skipPoints!==!0){for(o=0,V=0,v=G.length;V<v;V++){D=G[V],A="",B="";try{null!=a[o].infoWindow?(r=a[o].infoWindow,B=escape(null!=(M=r.title)?M:""),A=r.html,null!=a[o].data?(E=a[o].data,k=null!=E.diseasedetected?E.diseasedetected:E.diseaseDetected,g=null!=E.catalognumber?E.catalognumber:E.catalogNumber,O=null!=E.specificepithet?E.specificepithet:E.specificEpithet,P=null!=E.infraspecificepithet?E.infraspecificepithet:E.infraspecificeEpithet,null==P&&(P=""),isNull(B)&&g+": "+E.genus+" "+O+" "+P):k=""):null!=a[o].data&&(E=a[o].data,l=E.genus,O=null!=E.specificepithet?E.specificepithet:E.specificEpithet,C=null!=E.originaltaxa?E.originaltaxa:E.originalTaxa,k=null!=E.diseasedetected?E.diseasedetected:E.diseaseDetected,S=null!=E.diseasetested?E.diseasetested:E.diseaseTested,null==l&&(l="No Data"),null==O&&(O=""),C=isNull(C)?"":"("+C+")",R=null!=k&&null!=S?"<br/> Tested <strong>"+k+"</strong> for "+S:"",A="<p>\n  <em>"+l+" "+O+"</em> "+C+"\n  "+R+"\n</p>",null==E.catalogNumber&&null==E.catalognumber||(f=null!=E.catalognumber?E.catalognumber:E.catalogNumber,P=null!=E.infraspecificepithet?E.infraspecificepithet:E.infraspecificEpithet,B=f+": "+l+" "+O))}catch(a){}D=canonicalizePoint(D),z='<google-map-marker latitude="'+D.lat+'" longitude="'+D.lng+'" data-disease-detected="'+k+'" title="'+B+'" animation="DROP">\n  '+A+"\n</google-map-marker>",w+=z}h=getMapCenter(G)}else{if(null==window.locationData)try{window.locationData.lat=37.871527,window.locationData.lng=-122.262113,getLocation(function(){return _adp.currentLocation=new Point(window.locationData.lat,window.locationData.lng)})}catch(a){}h=new Point(window.locationData.lat,window.locationData.lng),W=14}if(x=null!=geo.googleMap?'map="geo.googleMap"':"",q=$("google-map").length,p="transect-viewport-"+q,y="#"+p,null!=(null!=b?b.classes:void 0)?("object"==typeof b.classes?(d=Object.toArray(b.classes),i=d.join(" ")):i=b.classes,i=escape(i)):i="",m='<google-map id="'+p+'" latitude="'+h.lat+'" longitude="'+h.lng+'" map-type="hybrid" click-events  zoom="'+W+'" class="col-xs-12 '+b.bsGrid+" center-block clearfix google-map transect-viewport map-viewport "+i+'" api-key="'+gMapsApiKey+'" '+x+">\n      "+w+"\n</google-map>",b.onlyOne===!0&&(N=$("google-map").get(0)),!$(N).exists()){try{console.debug("Selector does not exist:",N)}catch(a){}N="#carto-map-container",$(N).exists()||(N="body")}"google-map"!==$(N).get(0).tagName.toLowerCase()?(console.log("Appending map to selector "+N,$(N)),$(N).addClass("map-container has-map").append(m)):(console.log("Replacing map at selector "+N),$(N).replaceWith(m)),console.log("Attaching events to "+y),null==window.mapBuilder&&(window.mapBuilder=new Object,window.mapBuilder.points=new Array,window.mapBuilder.selector="#"+$(y).attr("id")),(null!=b?b.resetMapBuilder:void 0)!==!1?window.mapBuilder.points=new Array:window.mapBuilder.selector="#"+$(y).attr("id"),null==(null!=b?b.onClickCallback:void 0)&&(null==b&&(b=new Object),b.onClickCallback=function(a,b){null==window.mapBuilder&&(window.mapBuilder=new Object,window.mapBuilder.selector="#"+$(b).attr("id"),window.mapBuilder.points=new Array),window.mapBuilder.points.push(a);try{$("#using-computed-locality").remove()}catch(a){}return $("#init-map-build").removeAttr("disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length),z=document.createElement("google-map-marker"),z.setAttribute("latitude",a.lat),z.setAttribute("longitude",a.lng),z.setAttribute("animation","DROP"),Polymer.dom(b).appendChild(z),!1}),$(""+y).on("google-map-click",function(a){var c;return c=a.originalEvent.detail.latLng,D=canonicalizePoint(c),console.info("Clicked point "+D.toString(),D,c),"function"==typeof b.onClickCallback?b.onClickCallback(D,this):console.warn("google-map-click wasn't provided a callback"),!1}),I={selector:y,html:m,points:G,hull:n,center:h},console.info("Map",I),geo.googleMapWebComponent=m,"function"==typeof c&&(console.log("createMap2 calling back"),c(I))}catch(a){e=a,console.error("Couldn't create map! "+e.message),console.warn(e.stack)}return!1},reInitMap=function(a){var b,c,d,e,f,g,h,i;for(c=p$(a),c.map=null,e=c.objects,c._initGMap(),d=new Array,i=0,b=e.length;i<b;i++)f=e[i],"google-map-poly"===f.tagName.toLowerCase()&&(f._points=new Array,$(f).find("google-map-point").each(function(){var a,b,c,d;return a=$(this).attr("latitude"),b=$(this).attr("longitude"),d={lat:toFloat(a),lng:toFloat(b)},c=new google.maps.LatLng(d),f._points.push(c)}),f.path=null,f.map=c.map,h={clickable:f.clickable||f.draggable,draggable:f.draggable,editable:f.editable,geodesic:f.geodesic,map:f.map,strokeColor:f.strokeColor,strokeOpacity:f.strokeOpacity,strokePosition:f._convertStrokePosition(),strokeWeight:f.strokeWeight,visible:!f.hidden,zIndex:f.zIndex},g=new google.maps.Polygon(h),g.setPaths(f._points),f._setPoly(g),d.push(f));return c.objects=d},buildMap=function(a,b,c){return null==a&&(a=window.mapBuilder),null==b&&(b={selector:a.selector,resetMapBuilder:!1}),createMap2(a.points,b,c),!1},getPointsFromCartoResult=function(a,b){var c,d,f,g,h,i,j,k,l,m,n;null==b&&(b=!1);try{for(m=Object.toArray(a),k=new Array,n=0,f=m.length;n<f;n++)l=m[n],j=l.st_asgeojson,i=JSON.parse(j),c=i.coordinates,d={lat:c[1],lng:c[0]},h=canonicalizePoint(d),k.push(h);return b&&(g=k.slice(0),k=sortPoints(g)),k}catch(a){e=a,console.error("Couldn't get points: "+e.message),console.warn(e.stack)}return!1},featureClickEvent=function(a,b,c,d,e,f){var g,h,i,j,k;console.log("Clicked feature event",d,c,b),h=new Array;for(g in d)k=d[g],h.push(g);return i=["genus","specificepithet","diseasedetected","dateidentified"],j=null!=f?{infowindowTemplate:f,templateType:"mustache"}:null,!1},createRawCartoMap=function(a,b,c,d,f){var g,h,i,j,k,l,m,n,o,p,q;null==d&&(d="#global-data-map"),null==f&&(f=featureClickEvent),isNull(c)&&(c=new Object),m=null==a.user_name?{user_name:null!=(n=c.user_name)?n:cartoAccount,type:null!=(o=c.type)?o:"cartodb",sublayers:a,extra_params:{map_key:window.apiKey,api_key:window.apiKey}}:a,console.info("Creating map",m),l={cartodb_logo:!1,https:!0,mobile_layout:!0};try{h={center:new google.maps.LatLng(null!=(p=l.center_lat)?p:0,null!=(q=l.center_lon)?q:0),zoom:l.zoom,mapTypeId:google.maps.MapTypeId.TERRAIN},geo.googleMap=p$(d).map}catch(a){}return k={center:[window.locationData.lat,window.locationData.lng],zoom:5},null==geo.lMap&&(i=new L.Map("global-map-container",k),geo.lMap=i,j={attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"},L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",j).addTo(i)),g=localStorage.useTestMap?geo.googleMap:geo.lMap,cartodb.createLayer(g,m,l).addTo(g,1).on("done",function(d){var h,i,j,k,l,n,o,p;try{d.setParams("table_name",m.named_map.params.table_name)}catch(a){console.warn("Couldn't explicitly set table")}if(isArray(a)){for(p=0,j=a.length;p<j;p++)h=a[p],console.info("Re-adding sublayer",h),d.createSubLayer(h);console.info("Added layers to map")}null==geo.mapSublayers&&(geo.mapSublayers=new Array),k=d.getSubLayerCount();try{d.setInteraction(!0)}catch(a){}try{d.unbind("featureClick")}catch(a){}for(d.on("featureClick",function(a,b,c,e,g){var h;return h=m.named_map.params.table_name.slice(0,63),f.debounce(150,!1,null,a,b,c,e,d,$("#infowindow_template_"+h).outerHtml()),!1}).on("error",function(a){return console.warn("Error on layer feature click",a)}),i=0,l=function(a,b,d,f,g){var h,i,j,k,m,n,o;if(null==d&&(d=0),n="#infowindow_template_"+b,o=null!=(k=null!=(m=window._adp.templates)?m[b]:void 0)?k:$(n).html(),isNull(o)&&(o=$(n).html(),isNull(o)&&0===modulo(d,100)&&d>0&&console.warn("Warning: null template for table '"+b+"' @ sublayer "+f,o)),isNull(o))d<100?delay(200,function(){return d+=1,l(a,b,d,f,g)}):(console.warn("Timed out (count: "+d+") trying to assign a template for '"+b+"'",n,"https://github.com/AmphibiaWeb/amphibian-disease-tracker/issues/154"),g.show());else{j={template:o,width:218,maxHeight:250},a.infowindow.set(j),console.info("Successfully set template "+n+" on sublayer "+f);try{h=["genus","specificepithet","diseasedetected","dateidentified"],i=function(a){var b;return console.debug("Running infowindow parser on ",a),$("body .temp-parser").remove(),$("body").append("<div class='temp-parser'>\n  "+a+"\n</div>"),$(".temp-parser").find(".unix-date").each(function(){var a,b,c;return b=$(this).text(),isNull(b)&&$(this).parent().remove(),isNumber(b)&&(b=toInt(b)),a=new Date(b),c=a.getUTCFullYear(),$(this).replaceWith(c)}),$(".temp-parser").find(".disposition").each(function(){var a;if(a=$(this).find(".disposition-label"),isNull(a))return console.debug("Removed empty disposition from label"),$(this).remove()}),b=$(".temp-parser").html(),$(".temp-parser").remove(),console.debug("Parser output",b),b},c={infowindowTemplate:$(n).html(),templateType:"mustache",sanitizeTemplate:i};try{g.getSubLayer(f).infowindow.sanitizeTemplate=i,console.debug("Assigned template parser to sublayer")}catch(a){e=a,console.warn("Couldn't assign template parser - "+e.message),console.warn(e.stack)}cartodb.vis.Vis.addInfowindow(geo.lMap,g.getSubLayer(f),h,c),console.info("Successfully assigned template "+n+" to sublayer "+f+" in vis"),console.debug("template",o),console.debug("selector",$(n).html())}catch(a){}if(0===f)try{g.infowindow.set("template",o),console.info("Successfully assigned template to primary layer",o)}catch(a){}f===g.getSubLayerCount()-1&&(console.info("Showing layer for '"+b+"' after successful template assignment for all sublayers"),g.show())}return!1};i<k;){o=d.getSubLayer(i),o.setInteraction(!0);try{n=m.named_map.params.table_name.slice(0,63),l(o,n,0,i,d)}catch(a){}geo.mapSublayers.push(o),++i}try{console.log("Layer counts:",g.overlayMapTypes.length)}catch(a){}return"function"==typeof b&&b(),!1}).on("error",function(a){return toastStatusMessage("Couldn't load maps!"),console.error("Couldn't get map - "+a)}),!1},createMap=function(a,b,c,d){var f,g,h,i;return null==a&&(a="38544c04-5e56-11e5-8515-0e4fddd5de28"),null==b&&(b="carto-map-container"),null==a&&console.info("Can't create map without a data visualization identifier"),geo.mapId=b,geo.mapSelector="#"+b,h=function(){var f,h,i,j;null==c&&(c={cartodb_logo:!1,https:!0,mobile_layout:!0,gmaps_base_type:"hybrid",center_lat:window.locationData.lat,center_lon:window.locationData.lng,zoom:getMapZoom(geo.boundingBox)}),geo.mapParams=c,$("#"+b).exists()||(f='<div id="'+b+'" class="carto-map wide-map map-container">\n  <!-- Dynamically inserted from unavailable target -->\n</div>',$("main #main-body").append(f)),"function"!=typeof d&&(d=function(a,b){return cartodb.createLayer(b,g).addTo(b).done(function(a){geo.mapLayer=a;try{return a.setInteraction(!0),a.on("featureOver",defaultMapMouseOverBehaviour)}catch(a){return console.warn("Can't set carto map interaction")}})}),j={center:new google.maps.LatLng(c.center_lat,c.center_lon),zoom:c.zoom,mapTypeId:google.maps.MapTypeId.HYBRID},geo.googleMap=new google.maps.Map(document.getElementById(b),j),geo.cartoMap=geo.googleMap,i=function(b){return console.info("Fetched data into Google Map from CartoDB account "+cartoAccount+", from data set "+a),geo.mapLayer=b,geo.cartoMap=geo.googleMap,clearTimeout(h),"function"==typeof d&&d(b,geo.cartoMap),!1};try{console.info("About to render map with options",geo.cartoUrl,c),cartodb.createLayer(geo.googleMap,geo.cartoUrl,c).addTo(geo.googleMap).on("done",function(a){return i(a)}).on("error",function(a){return toastStatusMessage("Couldn't load maps!"),console.error("Couldn't get map - "+a)}),h=delay(1e3,function(){if("function"==typeof d)return console.warn("Callback wasn't called, forcing"),d(null,geo.cartoMap)})}catch(a){console.warn("The map threw an error! "+e.message),console.warn(e.stack),clearTimeout(h),"function"==typeof d&&d(null,geo.cartoMap)}return!1},"object"!=typeof a?(g=/^https?:\/\/.*$/m.test(a)?a:"https://"+cartoAccount+".cartodb.com/api/v2/viz/"+a+"/viz.json",geo.cartoUrl=g,h()):(f=new Object,i="http://tigerhawkvok.cartodb.com/api/v2/viz/38544c04-5e56-11e5-8515-0e4fddd5de28/viz.json",$.get(i,"","json").done(function(b){var c,d,e;f=b,d=[];for(c in a)e=a[c],d.push(f[c]=e);return d}).fail(function(b,c){return f=a}).always(function(){return g=f,geo.cartoUrl=g,h()}))},getColumnObj=function(a){var b;return null==a&&(a=!1),b={id:"int",collectionID:"varchar",catalogNumber:"varchar",sampleId:"varchar",diseaseTested:"varchar",diseaseStrain:"varchar",sampleMethod:"varchar",sampleDisposition:"varchar",diseaseDetected:"varchar",fatal:"boolean",cladeSampled:"varchar",genus:"varchar",specificEpithet:"varchar",infraspecificEpithet:"varchar",lifeStage:"varchar",dateIdentified:"date",decimalLatitude:"decimal",decimalLongitude:"decimal",alt:"decimal",coordinateUncertaintyInMeters:"decimal",Collector:"varchar",originalTaxa:"varchar",sex:"varchar",datum:"text",fimsExtra:"json",the_geom:"varchar"},null==_adp.activeCols||a?b:_adp.activeCols},geo.requestCartoUpload=function(a,b,c,d){var f,g,h,i,j,k;startLoad();try{h=a.data}catch(a){}return"object"!=typeof h?(console.info("This function requires the base data to be a JSON object."),toastStatusMessage("Your data is malformed. Please double check your data and try again."),!1):(f=["edit","insert","delete","create"],indexOf.call(f,c)<0?(console.error(c+" is not an allowed operation on a data set!"),console.info("Allowed operations are ",f),toastStatusMessage("Sorry, '"+c+"' isn't an allowed operation."),!1):isNull(b)?(console.error("Must use a defined table name!"),toastStatusMessage("You must name your data table"),!1):(j=$.cookie(uri.domain+"_link"),i=$.cookie(uri.domain+"_auth"),k=$.cookie(uri.domain+"_secret"),null==j||null==i||null==k?(console.error("You're not logged in. Got one or more invalid tokens for secrets.",j,i,k),toastStatusMessage("Sorry, you're not logged in. Please log in and try again."),!1):(b=b+"_"+j,g="hash="+i+"&secret="+k+"&dblink="+j,null==("undefined"!=typeof adminParams&&null!==adminParams?adminParams.apiTarget:void 0)?(console.warn("Administration file not loaded. Upload cannot continue"),stopLoadError("Administration file not loaded. Upload cannot continue"),!1):($.post(adminParams.apiTarget,g,"json").done(function(f){var g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea;if(!f.status)return console.error("Unable to authenticate session. Please log in."),stopLoadError("Sorry, your session has expired. Please log in and try again.");V=new Array,F=new Array,K=new Array;for(O in h){U=h[O],
I=new Array;for(n in U)switch(ca=U[n],n){case"decimalLongitude":I[1]=ca,K.push(ca);break;case"decimalLatitude":I[0]=ca,F.push(ca)}V.push(I)}j=null!=(P=F.max())?P:0,k=null!=(Q=F.min())?Q:0,i=null!=(R=K.max())?R:0,l=null!=(S=K.min())?S:0,v=[[j,l],[j,i],[k,i],[k,l]];try{for(ba=JSON.parse(a.transectRing),ba=Object.toArray(ba),A=0,Z=0,G=ba.length;Z<G;Z++){if(s=ba[Z],s instanceof Point&&(s=s.toGeoJson(),ba[A]=s),2!==s.length)throw{message:"Bad coordinate length for '"+s+"'"};for(aa=0,H=s.length;aa<H;aa++)if(r=s[aa],!isNumber(r))throw{message:"Bad coordinate number '"+r+"'"};++A}}catch(a){e=a,console.warn("Error parsing the user transect ring - "+e.message),ba=void 0}switch(_=null!=ba?ba:v,x={type:"GeometryCollection",geometries:[{type:"MultiPoint",coordinates:V},{type:"Polygon",coordinates:_}]},t="ST_AsBinary("+JSON.stringify(x)+", 4326)",o=getColumnObj(!0),c){case"edit":return X="UPDATE "+b+" ",foo(),!1;case"insert":case"create":X="","create"===c&&(X="CREATE TABLE "+b+" "),u={the_geom:t},ea=new Array,q=new Array,q.push("id int"),_adp.rowsCount=Object.size(h);for(A in h){U=h[A],A=toInt(A),da=new Array,E=0,J=0,g=0,w=0,y={type:"Point",coordinates:new Array},B=A+1,da.push(B);for(n in U){ca=U[n],0===A&&(M=n.toLowerCase(),p=null!=(T=o[n])?T:o[M],"object"==typeof p&&(p=p.type),isNull(p)&&(p="text"),q.push(n+" "+p));try{ca=ca.replace("'","&#95;")}catch(a){}switch(n){case"decimalLongitude":y.coordinates[1]=ca;break;case"decimalLatitude":y.coordinates[0]=ca}"string"==typeof ca?da.push("'"+ca+"'"):isNull(ca)?da.push("null"):da.push(ca)}0===A&&(console.log("We're appending to col names list"),q.push("the_geom geometry"),"create"===c&&(X=X+" ("+q.join(",")+"); ")),z="ST_SetSRID(ST_Point("+y.coordinates[1]+","+y.coordinates[0]+"),4326)",da.push(z),ea.push("("+da.join(",")+")")}for(N=4096,C=15,D=0,console.info("Inserting statements of max length "+N),L=0,W=N,$=new Array;ea.slice(D,D+C).length>0;){for(Y=0;$.join(", ").length<N-1&&(++Y,$=ea.slice(D,D+Y),!(Y>C)););Y--,Y>L&&(L=Y),Y<W&&(W=Y),$=ea.slice(D,D+Y),D+=Y,X+="INSERT INTO "+b+" VALUES "+$.join(", ")+";"}m="SELECT cdb_cartodbfytable('"+b+"');",X+=m,console.info("Constructed statements: maximum "+L+" rows, minimum "+W+" rows");break;case"delete":return X="DELETE FROM "+b+" WHERE ",foo(),!1}try{return geo.postToCarto(X,b,d)}catch(a){return stopLoadBarsErrors()}}).fail(function(a,b){return console.error("Couldn't communicate with server!",a,b),console.warn(""+uri.urlString+adminParams.apiTarget+"?"+g),stopLoadError("There was a problem communicating with the server. Please try again in a bit. (E-001)"),$("#upload-data").removeAttr("disabled")}),!1))))},geo.postToCarto=function(a,b,c){var d,f,g,h,i,j,k,l,m,n,o;d=encodeURIComponent(encode64(a)),f="action=upload&sql_query="+d,console.info("Querying:"),console.info(a),console.info("POSTing to server"),$("#data-sync").removeAttr("indeterminate"),l=Date.now(),o=0,m=["A silly story for you, while you wait!","Everything had gone according to plan, up 'til this moment.","His design team had done their job flawlessly,","and the machine, still thrumming behind him,","a thing of another age,","was settled on a bed of prehistoric moss.","They'd done it.","But now,","beyond the protection of the pod","and facing an enormous Tyrannosaurus rex with dripping jaws,","Professor Cho reflected that,","had he known of the dinosaur's presence,","he wouldn’t have left the Chronoculator","- and he certainly wouldn't have chosen 'Staying&#39; Alive',","by The Beegees,","as his dying soundtrack.","Curse his MP3 player!","The End.","Yep, your data is still being processed","And we're out of fun things to say","We hope you think it's all worth it"],g=function(){var a;return a=null!=m[o]?"("+m[o]+")":"",toastStatusMessage("Still working ... "+a),++o,window._adp.secondaryTimeout=delay(15e3,function(){return g()})};try{i=toInt(.7*_adp.rowsCount),console.log("Estimate "+i+" seconds"),window._adp.uploader=!0,$("#data-sync").removeAttr("indeterminate"),k=30*i;try{p$("#data-sync").max=k}catch(a){}(n=function(a){try{p$("#data-sync").value=a}catch(a){}return++a,window._adp.uploader&&a<=k?delay(33,function(){return n(a)}):a>k?(toastStatusMessage("This may take a few minutes. We'll give you an error if things go wrong."),window._adp.secondaryTimeout=delay(15e3,function(){return g()})):console.log("Not running upload progress indicator",a,window._adp.uploader,k)})(0)}catch(a){e=a,console.warn("Can't show upload status - "+e.message),console.warn(e.stack);try{window._adp.initialTimeout=delay(5e3,function(){var a,b;return a=toInt(i/60)+1,b=a>1?"minutes":"minute",toastStatusMessage("Please be patient, it may take a few minutes (we guess "+a+" "+b+")"),window._adp.secondaryTimeout=delay(15e3,function(){return g()})})}catch(a){h=a,console.error("Can't show backup upload notices! "+h.message),console.warn(h.stack)}}return j=Date.now(),$.post("api.php",f,"json").done(function(a){var d,e,f,g,h,l,m,n,o,p,q,r;console.log("Got back response from carto",a);try{p=roundNumber((Date.now()-j)/1e3,1),console.info("Really took "+p+"s (estimated "+i+"s)",p/i)}catch(a){}if(a.status!==!0)return console.error("Got an error from the server!"),console.warn(a),stopLoadError("There was a problem uploading your data. Please try again."),!1;e=a.post_response,d=!1;for(l in e){q=e[l],isNull(null!=q?q.error:void 0)||(h=null!=(null!=q?q.error:void 0)?q.error[0]:"Unspecified Error",d=h);try{q=JSON.parse(q);for(m in q)r=q[m],"error"===m&&(d=r)}catch(a){}}if(d!==!1)return console.error("There was an error communicating with cartoDB!"),bsAlert("Error uploading your data to CartoDB: <code>"+d+"</code>","danger"),stopLoadError("CartoDB returned an error: "+d),!1;console.info("Carto was successful! Got results",e);try{o=JsonHuman.format(e)}catch(a){}return bsAlert("Upload to CartoDB of table <code>"+b+"</code> was successful","success"),toastStatusMessage("Data parse and upload successful"),geo.dataTable=b,f="",g=isNull(f)?"object"==typeof f?f:"":"https://"+cartoAccount+".cartodb.com/api/v2/viz/"+f+"/viz.json",n=function(a){var b,d;console.info("Initiating parent callback"),stopLoad();try{k=p$("#data-sync").max,p$("#data-sync").value=k}catch(a){}return $("#data-sync").removeAttr("indeterminate"),b={boundingBox:geo.boundingBox,bsGrid:""},null!=(null!=(d=window.mapBuilder)?d.selector:void 0)?b.selector=window.mapBuilder.selector:$("google-map").exists()?b.selector=$($("google-map").get(0)).attr("id"):b.selector="#carto-map-container",_adp.defaultMapOptions=b,"function"==typeof c?c(geo.dataTable,a,b):console.info("requestCartoUpload recieved no callback")},geo.init(function(){return console.info("Post init"),getCanonicalDataCoords(geo.dataTable,null,function(a,b){return console.info("gcdc callback successful",a),n(a)}),!1})}).fail(function(a,b){return console.error("Couldn't communicate with server!",a,b),console.warn(""+uri.urlString+adminParams.apiTarget+"?"+f),stopLoadError("There was a problem communicating with the server. Please try again in a bit. (E-002)"),bsAlert("Couldn't upload dataset. Please try again later.","danger")}).always(function(){var a;try{return a=Date.now()-l,console.info("POST and process took "+a+"ms"),clearTimeout(window._adp.initialTimeout),clearTimeout(window._adp.secondaryTimeout),window._adp.uploader=!1,$("#upload-data").removeAttr("disabled")}catch(a){}}),!1},sortPoints=function(a,b){var c,d,e,f,g;for(null==b&&(b=!0),window.upper=upperLeft(a),a.sort(pointSort),f=new Array,g=0,d=a.length;g<d;g++)c=a[g],b?f.push(c.getObj()):(e=c.toSimplePoint(),f.push(e));return delete window.upper,f},canonicalizePoint=function(a,b){var c,d,e,f;null==b&&(b=!1),e={lat:null,lng:null};try{f=toFloat(a.lat),f.toString()===a.lat?b?(a.lat=toFloat(a.lng),a.lng=toFloat(a.lat)):(a.lat=toFloat(a.lat),a.lng=toFloat(a.lng)):(f=toFloat(a[0]),f.toString()===a[0]&&(b?(a[0]=toFloat(a[1]),a[1]=toFloat(a[0])):(a[0]=toFloat(a[0]),a[1]=toFloat(a[1]))))}catch(a){}if("number"==typeof(null!=a?a.lat:void 0))e=a;else if("number"==typeof(null!=a?a[0]:void 0))e={lat:a[0],lng:a[1]};else try{if("number"!=typeof a.lat())throw"Not fPoint";e.lat=a.lat(),e.lng=a.lng()}catch(b){try{if("number"!=typeof a.getLat())throw"Not Point";e=a.getObj()}catch(b){if(null!=("undefined"!=typeof google&&null!==google?google.map:void 0))try{c=a.getPosition(),e.lat=c.lat(),e.lng=c.lng()}catch(a){throw"Unable to determine point type"}}}return d=new Point(e.lat,e.lng)},createConvexHull=function(a,b){var c,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(null==b&&(b=!1),n=new Array,m=new Array,o=Date.now(),console.log("createConvexHull called with "+Object.size(a)+" points"),a=Object.toArray(a),p=!1,q=0,h=a.length;q<h&&(l=a[q],!(Math.abs(l.lng)>90));q++)if(Math.abs(l.lat)>90){p=!0;break}for(r=0,i=a.length;r<i;r++)l=a[r],c=canonicalizePoint(l,p),m.push(c);try{console.info("Getting convex hull (original: "+a.length+"; canonical: "+m.length+")",m);try{d=getConvexHull(m)}catch(a){console.warn("Couldn't run real way!"),n=sortPoints(m,!1),f=getConvexHullPoints(n)}f=d.paths}catch(a){e=a,console.error("Unable to get convex hull - "+e.message),console.warn(e.stack)}for(geo.canonicalBoundingBox=new Array,s=0,j=f.length;s<j;s++)l=f[s],geo.canonicalBoundingBox.push(l.getObj());k={hull:f,points:m},geo.canonicalHullObject=k;try{g=Date.now()-o,console.debug("createConvexHull completed in "+g+"ms")}catch(a){}return b===!0?k:f},fPoint=function(a,b){return this.latval=a,this.lngval=b,this.lat=function(){return this.latval},this.lng=function(){return this.lngval},this.toString=function(){return"("+this.x+", "+this.y+")"},this.toString()},Point=function(a,b){return this.lat=toFloat(a),this.lng=toFloat(b),this.x=360*(this.lng+180),this.y=180*(this.lat+90),this.distance=function(a){var b,c;return b=a.x-this.x,c=a.y-this.y,Math.sqrt(Math.pow(b,2)+Math.pow(c,2))},this.slope=function(a){var b,c;return b=a.x-this.x,c=a.y-this.y,c/b},this.toString=function(){return"("+this.lat+", "+this.lng+")"},this.getObj=function(){var a;return a={lat:this.lat,lng:this.lng}},this.getLatLng=function(){var a;return null!=("undefined"!=typeof google&&null!==google?google.maps:void 0)?(a=this.getObj(),new google.maps.LatLng(a)):this.getObj()},this.getLat=function(){return this.lat},this.getLng=function(){return this.lng},this.toSimplePoint=function(){var a;return a=new fPoint(this.lat,this.lng)},this.toGeoJson=function(){var a;return a=[this.lat,this.lng]},this.toString()},geo.Point=Point,Number.prototype.toRad=function(){return this*Math.PI/180},geo.distance=function(a,b,c,d){var e,f,g,h,i,j,k;return e=6371,h=(c-a).toRad(),i=(d-b).toRad(),j=h/2,k=i/2,f=Math.pow(Math.sin(j),2)+Math.cos(a.toRad())*Math.cos(c.toRad())*Math.pow(Math.sin(k),2),g=2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f)),e*g},geo.getBoundingRectangle=function(a){var b,c,d,e,f,g,h,i,j,k,l;if(null==a&&(a=geo.boundingBox),a=Object.toArray(a),isNull(a))return console.warn("Need a set of coordinates for the bounding rectangle!"),!1;for(i=-90,j=90,l=180,e=-180,k=0,g=a.length;k<g;k++)c=a[k],d=canonicalizePoint(c),f=d.lat,h=d.lng,f>i&&(i=f),f<j&&(j=f),h<l&&(l=h),h>e&&(e=h);return b={nw:[i,l],ne:[i,e],se:[j,e],sw:[j,l],north:i,east:e,west:l,south:j},geo.computedBoundingRectangle=b,b},localityFromMapBuilder=function(a,b){var c;return null==a&&(a=window.mapBuilder),c=getMapCenter(a.points),geo.reverseGeocode(c.lat,c.lng,a.points,function(a){if(console.info("Got locality '"+a+"'"),"function"==typeof b)return b(a)}),!1},doMapBuilder=function(a,b,c){return null==a&&(a=window.mapBuilder),null==b&&(b={selector:a.selector,resetMapBuilder:!1}),null==b.resetMapBuilder&&(b.resetMapBuilder=!1),"object"!=typeof(null!=a?a.points:void 0)?(console.error("Invalid builder",a),!1):buildMap(a,b,function(a){return geo.boundingBox=a.hull,localityFromMapBuilder(a,function(b){return a.locality=b,console.info("Map results:",a),"function"==typeof c&&c(a),!1})})},geo.geocode=function(a,b,c){var d,f,g,h,i,j,k,l,m,n;try{null!=geo.geocoder?i=geo.geocoder:(i=new google.maps.Geocoder,geo.geocoder=i)}catch(a){return e=a,console.error("Couldn't instance a google map geocoder - "+e.message),console.warn(e.stack),!1}if(h=function(){var d;return d={address:a,componentRestrictions:b},i.geocode(d,function(a,b){var e,f,g,h,i,j,k;if(console.log("Geocoder fetched",a,b),console.log("Provided",d),b!==google.maps.GeocoderStatus.OK)return console.warn("Geocoder failed -- Google said",b),!1;f=a[0],j=new Object,j.google=new Object,j.human=f.formatted_address;try{for(h=f.address_components,i=0,e=h.length;i<e;i++){g=h[i];try{k=g.types[0],j.google[k]=g.long_name}catch(a){continue}}}catch(a){}return j.partial_match=f.partial_match,"function"==typeof c?c(j):console.warn("No callback provided! Got address object",j)})},k=null,null!=a&&null!=k){m="https://maps.googleapis.com/maps/api/geocode/json",f=new Array;for(j in b)n=b[j],l=j+":"+encodeURIComponent(n),f.push(l);g=f.join("|"),d="address="+encodeURIComponent(a)+"&components="+g+"&key="+k,console.log("Trying",m+"?"+d),$.get(m,d,"json").done(function(a){var b,d,e,f,g,i,j,k;if(console.log("API hit fetched",a),d=a.results[0],g=a.status,g!==google.maps.GeocoderStatus.OK)return console.warn("Geocoder failed -- Google said",g),h(),!1;j=new Object,j.google=new Object,j.human=d.formatted_address;try{for(f=d.address_components,i=0,b=f.length;i<b;i++){e=f[i];try{k=e.types[0],j.google[k]=e.long_name}catch(a){continue}}}catch(a){}return j.partial_match=d.partial_match,"function"==typeof c?c(j):console.warn("No callback provided! Got address object",j)}).fail(function(a,b){return console.error("Error ("+b+"): Couldn't post to Google, trying geocoder"),h()})}else h();return!1},geo.reverseGeocode=function(a,b,c,d){var f,g,h;null==c&&(c=geo.boundingBox);try{null!=geo.geocoder?f=geo.geocoder:(f=new google.maps.Geocoder,geo.geocoder=f)}catch(a){return e=a,console.error("Couldn't instance a google map geocoder - "+e.message),console.warn(e.stack),!1}return g={lat:toFloat(a),lng:toFloat(b)},h={location:g},f.geocode(h,function(a,b){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(b===google.maps.GeocoderStatus.OK){for(console.info("Google said:",a),i=geo.getBoundingRectangle(c),s=null,n=0,g=a.length;n<g&&(t=a[n],s=t,f=t.geometry.bounds,null==f||(j=f.getNorthEast(),m=f.getSouthWest(),k=j.lat(),l=m.lat(),e=j.lng(),u=m.lng(),k<i.north||l>i.south||u>i.west||e<i.east));n++);return h=s.formatted_address,p=k<i.north,q=l>i.south,r=u>i.west,o=e<i.east,(p||q||r||o)&&(console.warn("The last locality, '"+h+"', doesn't contain all coordinates!"),console.warn("North: "+!p+", South: "+!q+", East: "+!o+", West: "+!r),console.info("Using",s,i),h="near "+h+" (nearest region)"),console.info("Computed locality: '"+h+"'"),geo.computedLocality=h,"function"==typeof d?d(h):console.warn("No callback provided to geo.reverseGeocode()!")}if(console.error("There was a problem getting the locality",a,b),"function"==typeof d)return console.warn("Proceeding anyway with fake locality 'Bad Locality'"),geo.computedLocality="Bad Locality",d("Bad Locality")})},toggleGoogleMapMarkers=function(a,b,c){var d,e,f,g,h;for(null==a&&(a="positive"),null==b&&(b="#transect-viewport"),b=b+" google-map-marker[data-disease-detected='"+a+"']",f=$(b),console.info("Got "+f.length+" markers"),g=void 0,h=0,d=f.length;h<d;h++)e=f[h],null==g&&(g=!p$(e).open,console.info("Setting "+a+" markers open state to "+g)),p$(e).open=g;return"function"==typeof c&&c(g),!1},setupMapMarkerToggles=function(){var a;return a='<div class="row">\n  <h3 class="col-xs-12">\n    Toggle map markers\n  </h3>\n  <button class="btn btn-danger col-xs-3 toggle-marker" data-disease-status="positive">Positive</button>\n  <button class="btn btn-primary col-xs-3 toggle-marker" data-disease-status="negative">Negative</button>\n  <button class="btn btn-warning col-xs-3 toggle-marker" data-disease-status="no_confidence"><span class="hidden-xs">Inconclusive</span><span class="visible-xs-inline">?</span></button>\n</div>',$(".toggle-marker").exists()||$("google-map + div").append(a),console.log("Setting up events for map marker toggles"),$(".toggle-marker").unbind().click(function(){var a;return a=$(this).attr("data-disease-status"),$(".aweb-link-species").removeAttr("hidden"),console.log("Clicked '"+a+"' toggle"),toggleGoogleMapMarkers(a,null,function(b){return"no_confidence"===a&&(a="inconclusive"),b?(console.info("Hiding selector",".aweb-link-species:not([data-"+a+"='true'])"),$(".aweb-link-species:not([data-"+a+"='true'])").attr("hidden","hidden")):console.info("Removing hidden attribute")})}),!1},getConvexHull=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;try{l=a[0],f=l.getPosition()}catch(e){for(c=new Array,k=0,d=a.length;k<d;k++){i=a[k],b=new google.maps.Marker;try{f=i.getLatLng()}catch(a){g={lat:i.lat,lng:i.lng},f=new google.maps.LatLng(g)}b.setPosition(f),c.push(b)}a=c.slice(0)}for(j=new Array,m=0,e=a.length;m<e;m++)h=a[m],j.push(h.getPosition());j.sort(sortPointY),j.sort(sortPointX);try{console.debug("Convex hull being formed from",j.slice(0))}catch(a){}return getConvexHullConfig(j)},sortPointX=function(a,b){return a.lng()-b.lng()},sortPointY=function(a,b){return a.lat()-b.lat()},sortPointsXY=function(a){return a.sort(sortPointY),a.sort(sortPointX),a},getConvexHullPoints=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(b=new Array,!isArray(a))return console.error("Function requires an array"),!1;j=new Array;try{if(!(a[0]instanceof Point)){for(g=a.slice(0),a=new Array,k=0,c=g.length;k<c;k++)i=g[k],a.push(canonicalizePoint(i));b=convexHull(a)}for(l=0,d=b.length;l<d;l++)i=b[l],h=new Point(i.lat,i.lng),j.push(h)}catch(c){if(a[0]instanceof Point){for(g=a.slice(0),a=new Array,m=0,e=g.length;m<e;m++)i=g[m],a.push(i.toSimplePoint());console.debug("Converted Point array to fPoint array",a.slice(0))}for(chainHull_2D(a,a.length,b),n=0,f=b.length;n<f;n++)i=b[n],h=new Point(i.lat(),i.lng()),j.push(h)}return console.info("Got hull from "+a.length+" points:",j),j},getConvexHullConfig=function(a,b){var c,d;return null==b&&(b=geo.googleMap),c=getConvexHullPoints(a),d={map:b,paths:c,fillColor:defaultFillColor,fillOpacity:defaultFillOpacity,strokeWidth:2,strokeColor:"#0000FF",strokeOpacity:.5}};var gmarkers=[],points=[],hullPoints=[],map=null,polyline;$(function(){return $("google-maps-api").exists()&&$("google-maps-api").on("api-load",function(){try{return window.gMapsCallback()}catch(a){}}),speculativeApiLoader()}),enableDebugLogging=function(){var a,b,c;if(window.debugLoggingEnabled)return!1;if(null!=("undefined"!=typeof localStorage&&null!==localStorage?localStorage.debugLog:void 0))try{c=JSON.parse(localStorage.debugLog),window._debug=c,console.info("Restored log history to local object")}catch(a){console.warn("Unable to restore log history"),window._debug=new Array}else window._debug=new Array;window.sysConsole=console,window.sysLog=console.log,window.sysInfo=console.info,window.sysWarn=console.warn,window.sysError=console.error,window.sysDebug=console.debug,console.debug=function(){var a,b;return a=1<=arguments.length?slice.call(arguments,0):[],b={callType:"debug",arguments:a},_debug.push(b),sysDebug.apply(console,arguments),backupDebugLog(!0)},console.log=function(){var a,b;return a=1<=arguments.length?slice.call(arguments,0):[],b={callType:"log",arguments:a},_debug.push(b),sysLog.apply(console,arguments),backupDebugLog(!0)},console.info=function(){var a,b;return a=1<=arguments.length?slice.call(arguments,0):[],b={callType:"info",arguments:a},_debug.push(b),sysInfo.apply(console,arguments),backupDebugLog(!0)},console.warn=function(){var a,b;return a=1<=arguments.length?slice.call(arguments,0):[],b={callType:"warn",arguments:a},_debug.push(b),sysWarn.apply(console,arguments),backupDebugLog(!0)},console.error=function(){var a,b;return a=1<=arguments.length?slice.call(arguments,0):[],b={callType:"error",arguments:a},_debug.push(b),sysError.apply(console,arguments),backupDebugLog(!0)},$(window).on("popstate",function(a){return console.log("Navigation event"),!1}),$(window).unload(function(a){return console.log("unload event"),!1}),$("#debug-reporter").remove(),b='<paper-fab id="debug-reporter" icon="icons:send" data-toggle="tooltip" title="Send Debug Report" elevation="5">\n</paper-fab>',$("body").append(b),a='<style type="text/css">\n  #debug-reporter {\n    background: #F44336;\n    color: #fff!important;\n    position: fixed;\n    right: 1rem;\n    bottom: 1rem;\n    cursor: pointer;\n  }\n</style>',$("#debug-reporter").before(a),$("#debug-reporter").click(function(){return reportDebugLog()}),window.debugLoggingEnabled=!0;try{p$(".debug-enable-context").disabled=!0}catch(a){}return backupDebugLog(),!1},backupDebugLog=function(a){var b;if(null==a&&(a=!1),"undefined"!=typeof localStorage&&null!==localStorage&&null!=window._debug){a||console.info("Saving backup of debug log");try{b=JSON.stringify(window._debug),localStorage.debugLog=b}catch(a){e=a,sysError.apply(console,["Unable to backup debug log! "+e.message,window._debug])}}return!1},window.enableDebugLogging=enableDebugLogging,disableDebugLogging=function(){null!=("undefined"!=typeof localStorage&&null!==localStorage?localStorage.debugLog:void 0)&&(delete localStorage.debugLog,delete _debug),"function"==typeof window.sysLog&&(console.log=sysLog,console.info=sysInfo,console.warn=sysWarn,console.error=sysError,console.debug=sysDebug),$("#debug-reporter").remove(),window.debugLoggingEnabled=!1;try{p$(".debug-disable-context").disabled=!0}catch(a){}return!1},window.disableDebugLogging=disableDebugLogging,reportDebugLog=function(){var a,b,c,d,f,g,h;if(null!=window._debug){backupDebugLog(),console.info("Opening debug reporter"),f=function(){var a;return a='<div>\n  <p>Copy the text below</p>\n  <textarea readonly rows="10" class="form-control">\n    '+localStorage.debugLog+'\n  </textarea>\n  <br/><br/>\n  <p>And email it to <a href="mailto:support@velociraptorsystems.com?subject=Debug%20Log">support@velociraptorsystems.com</a></p>\n</div>'},g='<paper-dialog modal id="report-bug-modal">\n  <h2>Bug Report</h2>\n  <paper-dialog-scrollable>\n    '+f()+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog-modal>',$("#report-bug-modal").remove(),$("body").append(g);try{safariDialogHelper("#report-bug-modal")}catch(g){e=g,console.warn("Warning -- couldn't use safariDialogHelper to open. Some browsers may have an issue seeing this alert. ("+e.message+")"),console.debug(e.stack);try{try{p$("#report-bug-modal").open()}catch(b){a=b,console.warn("Couldn't use p$ to show modal, trying direct ... ("+a.message+")"),document.querySelector("#report-bug-modal").open()}h=3e3,delay(h,function(){var a;if(!$("#report-bug-modal").isVisible())throw a=function(){return this.message="Modal failed visibility test at "+h+"ms",this.name="InvisibleModalError"}})}catch(a){b=a,console.error("Unable to show bug report modal! "+b.message),console.warn(b.stack);try{bsAlert(f())}catch(a){c=a,console.error("Couldn't show fallback bsAlert! "+c.message),console.warn(c.stack);try{startLoad(),stopLoadError("Unable to show bug report modal!")}catch(a){d=a,console.error("Couldn't alert user to the problem! "+d.message),console.warn(c.stack)}}}}}return!1},window.reportDebugLog=reportDebugLog,"function"!=typeof delay&&(delay=function(a,b){return setTimeout(b,a)}),delay(100,function(){var a,b;if("function"!=typeof("undefined"!=typeof jQuery&&null!==jQuery&&null!=(a=jQuery.fn)?a.isVisible:void 0)&&(jQuery.fn.isVisible=function(){return jQuery(this).is(":visible")&&"hidden"!==jQuery(this).css("visibility")}),"function"!=typeof("undefined"!=typeof jQuery&&null!==jQuery&&null!=(b=jQuery.fn)?b.exists:void 0)&&(jQuery.fn.exists=function(){return jQuery(this).length>0}),"function"!=typeof p$&&(p$=function(a){try{return $$(a)[0]}catch(b){return $(a).get(0)}}),"function"!=typeof isNull&&(isEmpty=function(a){return!a||0===a.length},isBlank=function(a){return!a||/^\s*$/.test(a)},isNull=function(a,b){var c;if(null==b&&(b=!1),"object"==typeof a)try{if(c=a.length,null!=c)try{return 0===c}catch(a){}return 0===Object.size}catch(a){}try{if(isEmpty(a)||isBlank(a)||null==a){if(a!==!1&&0!==a)return!0;if(b&&(a===!1||0===a))return!0}}catch(a){return e=a,!1}try{a=a.toString().toLowerCase()}catch(a){}return"undefined"===a||"null"===a||!(!b||"false"!==a&&"0"!==a)}),"function"!=typeof bsAlert&&(bsAlert=function(a,b,c,d){var e,f,g;return null==b&&(b="warning"),null==c&&(c="body"),null==d&&(d="#bs-alert"),$(d).exists()?($(d).removeClass("alert-warning alert-info alert-danger alert-success"),$(d).addClass("alert-"+b)):(f='<div class="alert alert-'+b+' alert-dismissable hanging-alert" role="alert" id="'+d.slice(1)+'">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    <div class="alert-message"></div>\n</div>',g=$("main").exists()?"main":$("article").exists()?"article":c,$(g).prepend(f)),$(d+" .alert-message").html(a),e='<style type="text/css">\n  .hanging-alert {\n    position: fixed;\n    top: 0;\n    width: 50%;\n    margin: 0;\n    left: 25%;\n    z-index: 5999;\n  }\n</style>',$(d).before(e),bindClicks(),mapNewWindows(),!1},"function"!=typeof openTab&&(openLink=function(a){return null!=a&&(window.open(a),!1)},openTab=function(a){return openLink(a)},goTo=function(a){return null!=a&&(window.location.href=a,!1)}),"function"!=typeof mapNewWindows&&(mapNewWindows=function(a){return null==a&&(a=!0),$(".newwindow").each(function(){var b;return b=$(this).attr("href"),null==b&&(b=$(this).attr("data-href")),$(this).click(function(c){return a&&(c.preventDefault(),c.stopPropagation()),openTab(b)}),$(this).keypress(function(){return openTab(b)})})}),"function"!=typeof bindClicks&&(bindClicks=function(a){return null==a&&(a=".click"),$(a).each(function(){var a,b,c,d,f,g,h,i;try{if(i=null!=(c=$(this).attr("data-href"))?c:$(this).attr("href"),!isNull(i)){try{h=$(this).prop("tagName").toLowerCase()}catch(a){h=null}try{i===uri.o.attr("path")&&"paper-tab"===h&&$(this).parent().prop("selected",$(this).index())}catch(a){e=a,console.warn("tagname lower case error")}return b=(null!=(d=$(this).attr("newTab"))?d.toBool():void 0)||(null!=(f=$(this).attr("newtab"))?f.toBool():void 0)||(null!=(g=$(this).attr("data-newtab"))?g.toBool():void 0),"a"===h&&!b||("a"===h&&$(this).keypress(function(){return openTab(i)}),$(this).unbind().click(function(a){a.preventDefault(),a.stopPropagation();try{return b?openTab(i):goTo(i)}catch(a){return goTo(i)}}),i)}if(a=$(this).attr("data-function"),null!=a)return $(this).unbind(),$(this).click(function(){var b;try{console.log("Executing bound function "+a+"()");try{b=null,isNull($(this).attr("data-args"))||(b=$(this).attr("data-args").split(","))}catch(a){}try{return null!=b?window[a].apply(window,b):window[a]()}catch(b){return window[a]()}}catch(b){return e=b,console.error("'"+a+"()' is a bad function - "+e.message)}})}catch(a){return e=a,console.error("There was a problem binding to #"+$(this).attr("id")+" - "+e.message)}}),!1})),"function"!=typeof Function.debounce)return Function.prototype.getName=function(){var a;return a=this.name,null==a&&(a=this.toString().substr(0,this.toString().indexOf("(")).replace("function ","")),isNull(a)&&(a=md5(this.toString())),a},Function.prototype.debounce=function(){var a,b,c,d,f,g,h,i;h=arguments[0],c=arguments[1],i=arguments[2],a=4<=arguments.length?slice.call(arguments,3):[],null==h&&(h=300),null==c&&(c=!1),null==i&&(i=window.debounce_timer),null==(null!=(g=window.core)?g.debouncers:void 0)&&(null==window.core&&(window.core=new Object),core.debouncers=new Object);try{f=this.getName()}catch(a){}d=this,b=function(){if(!c)return d.apply(d,a)};try{null!=core.debouncers[f]&&(i=core.debouncers[f])}catch(a){}if(null!=i)try{clearTimeout(i)}catch(a){e=a}return c?(d.apply(obj,a),console.log("Executed "+f+" immediately"),!1):null!=f?core.debouncers[f]=delay(h,function(){return b()}):window.debounce_timer=delay(h,function(){return b()})}}),window.debugScriptSetup=!1,$(function(){var a,b;return(a=function(){return window.debugScriptSetup=!0,null!=("undefined"!=typeof localStorage&&null!==localStorage?localStorage.debugLog:void 0)?(window.debugLoggingEnabled=!0,enableDebugLogging()):window.debugLoggingEnabled=!1})(),(b=function(a){var c,d,f,g,h,i,j,k,l;if(!("undefined"!=typeof Polymer&&null!==Polymer&&null!=(i=Polymer.RenderStatus)?i._ready:void 0)){if("undefined"!=typeof Polymer&&null!==Polymer){if(a>20){l=500*a,console.warn("Fake it till you make it -- after waiting "+l+"ms, we're going to pretend Polymer is ready");try{Polymer.RenderStatus._ready=!0}catch(a){}}}else if(a>20)try{console.warn("Inserting Polymer components into DOM"),h="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib",f='<script src="'+h+'/webcomponentsjs/webcomponents-lite.min.js"></script>\n<link rel="import" href="'+h+'/polymer/polymer.html"/>\n<link rel="import" href="'+h+'/paper-spinner/paper-spinner.html"/>\n<link rel="import" href="'+h+'/paper-menu/paper-menu.html"/>\n<link rel="import" href="'+h+'/paper-material/paper-material.html"/>\n<link rel="import" href="'+h+'/paper-dialog/paper-dialog.html"/>\n<link rel="import" href="'+h+'/paper-dialog-scrollable/paper-dialog-scrollable.html"/>\n<link rel="import" href="'+h+'/paper-button/paper-button.html"/>\n<link rel="import" href="'+h+'/paper-icon-button/paper-icon-button.html"/>\n<link rel="import" href="'+h+'/paper-fab/paper-fab.html"/>\n<link rel="import" href="'+h+'/paper-item/paper-item.html"/>\n<link rel="import" href="'+h+'/iron-icons/iron-icons.html"/>\n<link rel="import" href="'+h+'/iron-icons/image-icons.html"/>\n<link rel="import" href="'+h+'/iron-icons/social-icons.html"/>\n<link rel="import" href="'+h+'/iron-icons/editor-icons.html"/>\n<link rel="import" href="'+h+'/neon-animation/neon-animation.html"/>\n</',$("head").append(f),a=-2}catch(a){e=a,console.error("Unable to insert Polymer into DOM ("+e.message+")")}return console.warn("Delaying context until Polymer.RenderStatus is ready"),delay(500,function(){return a++,b(a)}),!1}for(console.info("Setting up context events"),$("paper-icon-button[icon='icons:bug-report']").contextmenu(function(a){return d.debounce(null,null,null,this,a),!1}),c=["paper-button","button"],j=0,g=c.length;j<g;j++)k=c[j],$(k).find("[icon='icons:bug-report']").parents(k).contextmenu(function(a){return d.debounce(null,null,null,this,a),!1});return d=function(a,b){var c,d;if(b.preventDefault(),console.info("Showing bug report context menu"),f='<paper-material class="bug-report-context-wrapper" style="top:'+b.pageY+"px;left:"+b.pageX+'px;position:absolute">\n  <paper-menu class=context-menu">\n    <paper-item class="debug-enable-context" data-fn="enableDebugLogging">\n      Enable debug reporting\n    </paper-item>\n    <paper-item class="debug-disable-context" data-fn="disableDebugLogging">\n      Disable debug reporting\n    </paper-item>\n  </paper-menu>\n</paper-material>',$(".bug-report-context-wrapper").remove(),$("body").append(f),c=function(b){return $(a).addClass("iron-selected"),!1},d=function(b){return $(a).removeClass("iron-selected"),!1},$(".bug-report-context-wrapper paper-item").hover(c,d).click(function(){var b;return b=$(a).attr("data-fn"),!1}),$(".debug-enable-context").click(function(){return enableDebugLogging()}),$(".debug-disable-context").click(function(){return disableDebugLogging()}),window.debugLoggingEnabled)try{p$(".debug-enable-context").disabled=!0}catch(a){}else try{p$(".debug-disable-context").disabled=!0}catch(a){}return delay(5e3,function(){return $(".bug-report-context-wrapper").remove()})}})(0),window.setupDebugContext=function(){return a(),b()}});var _7zHandler,alertBadProject,bootstrapTransect,bootstrapUploader,checkInitLoad,copyMarkdown,createOverflowMenu,csvHandler,dataAttrs,dataFileParams,delayFimsRecheck,excelDateToUnixTime,excelHandler,excelHandler2,finalizeData,getCanonicalDataCoords,getInfoTooltip,getProjectCartoData,getTableCoordinates,getUploadIdentifier,helperDir,imageHandler,kmlHandler,kmlLoader,loadCreateNewProject,loadEditor,loadProject,loadProjectBrowser,loadSUProfileBrowser,loadSUProjectBrowser,mapAddPoints,mapOverlayPolygon,mintBcid,mintExpedition,newGeoDataHandler,pointStringToLatLng,pointStringToPoint,popManageUserAccess,populateAdminActions,recalculateAndUpdateHull,removeDataFile,renderValidateProgress,resetForm,revalidateAndUpdateData,saveEditorData,showAddUserDialog,showUnrestrictionCriteria,singleDataFileHelper,startAdminActionHelper,startEditorUploader,stopLoadBarsError,uploadedData,user,userEmail,userFullname,validateData,validateFimsData,validateTaxonData,verifyLoginCredentials,zipHandler,indexOf=[].indexOf||function(a){
for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},modulo=function(a,b){return(+a%(b=+b)+b)%b};window.adminParams=new Object,adminParams.domain="amphibiandisease",adminParams.apiTarget="admin-api.php",adminParams.adminPageUrl="https://"+adminParams.domain+".org/admin-page.html",adminParams.loginDir="admin/",adminParams.loginApiTarget=adminParams.loginDir+"async_login_handler.php",dataFileParams=new Object,dataFileParams.hasDataFile=!1,dataFileParams.fileName=null,dataFileParams.filePath=null,dataAttrs=new Object,uploadedData=null,helperDir="helpers/",user=$.cookie(adminParams.domain+"_link"),userEmail=$.cookie(adminParams.domain+"_user"),userFullname=$.cookie(adminParams.domain+"_fullname"),window.loadAdminUi=function(){var a;try{verifyLoginCredentials(function(a){var b,c;return c=a.unrestricted===!0?"<iron-icon id='restriction-badge' icon='icons:verified-user' class='material-green' data-toggle='tooltip' title='Unrestricted Account'></iron-icon>":"<iron-icon id='restriction-badge' icon='icons:verified-user' class='text-muted' data-toggle='tooltip' title='Restricted Account'></iron-icon>",b="<h3>\n  Welcome, "+$.cookie(adminParams.domain+"_name")+" "+c+"\n</h3>\n<section id='admin-actions-block' class=\"row center-block text-center\">\n  <div class='bs-callout bs-callout-info'>\n    <p>Please be patient while the administrative interface loads.</p>\n  </div>\n</section>",$("main #main-body").before(b),$(".fill-user-fullname").text($.cookie(adminParams.domain+"_fullname")),$("#restriction-badge").click(function(){return showUnrestrictionCriteria()}),checkInitLoad(function(){return populateAdminActions(),bindClicks()}),!1})}catch(b){a=b,$("main #main-body").html("<div class='bs-callout bs-callout-danger'><h4>Application Error</h4><p>There was an error in the application. Please refresh and try again. If this persists, please contact administration.</p></div>")}return!1},populateAdminActions=function(){var a,b,c,d,e,f;return f=uri.urlString+"admin-page.html",e={do:"home",prop:null},history.pushState(e,"Admin Home",f),$(".hanging-alert").remove(),b='<paper-button id="new-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:add"></iron-icon>\n    Create New Project\n</paper-button>\n',d='<paper-button id="create-placeholder" class="admin-action non-action col-md-3 col-sm-4 col-xs-12" raised data-toggle="tooltip" title="Your account is restricted. Click to verify account">\n  <iron-icon icon="icons:star-border"></iron-icon>\n  Verify &amp; Create Project\n</paper-button>',c=_adp.isUnrestricted?b:d,a=c+'\n      <paper-button id="edit-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n        <iron-icon icon="icons:create"></iron-icon>\n          Edit Existing Project\n      </paper-button>\n      <paper-button id="view-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n        <iron-icon icon="icons:visibility"></iron-icon>\n          View All My Projects\n      </paper-button>',$("#admin-actions-block").html(a),$("#show-actions").remove(),$("main #main-body").empty(),$("#new-project").click(function(){return loadCreateNewProject()}),$("#edit-project").click(function(){return loadEditor()}),$("#view-project").click(function(){return loadProjectBrowser()}),$("#create-placeholder").click(function(){return showUnrestrictionCriteria()}),verifyLoginCredentials(function(a){var c,e;return e=toInt(a.detail.userdata.su_flag),e.toBool()&&(console.info("NOTICE: This is an SUPERUSER Admin"),c='<paper-button id="su-view-projects" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:add"></iron-icon>\n  (SU) Administrate All Projects\n</paper-button>\n<paper-button id="su-manage-users" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:create"></iron-icon>\n  (SU) Manage All Users\n</paper-button>',$("#admin-actions-block").append(c),$("#su-view-projects").click(function(){return loadSUProjectBrowser()}),$("#su-manage-users").click(function(){return loadSUProfileBrowser()})),_adp.isUnrestricted=a.unrestricted,a.unrestricted!==!0&&($("#new-project").remove(),$("#create-placeholder").exists()||$("#edit-project").before(d),$("#create-placeholder").unbind().click(function(){return showUnrestrictionCriteria()})),a.unrestricted!==!0||$("#new-project").exists()||($("#create-placeholder").remove(),$("#new-project").exists()||$("#edit-project").before(b),$("#new-project").unbind().click(function(){return loadCreateNewProject()})),!1}),!1};try{(createOverflowMenu=function(){return checkLoggedIn(function(a){var b,c;return b=a.status?'    <paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",c='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+b+'\n    <paper-item disabled data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker/issues/176" class="click">\n      Summary Dashboard\n    </paper-item>\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About / Legal\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(c),isNull(b)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1})()}catch(a){}showUnrestrictionCriteria=function(){return startLoad(),verifyLoginCredentials(function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;return stopLoad(),n=a.unrestricted.toBool(),k=a.has_alternate.toBool(),v=a.detail.userdata.email_verified.toBool(),i=a.email_allowed.toBool(),k?(u=a.detail.userdata.alternate_email_verified.toBool(),e=a.alternate_allowed.toBool(),j=e||i):j=i,r=toInt(a.detail.userdata.su_flag),q=toInt(a.detail.userdata.admin_flag),l=r.toBool()||q.toBool(),b="https://"+adminParams.domain+".org/"+adminParams.loginDir.slice(0,-1),f='<iron-icon icon="icons:verified-user" class="material-green" data-toggle="tooltip" title="Completed"></iron-icon>',m='<iron-icon icon="icons:verified-user" class="text-muted" data-toggle="tooltip" title="Incomplete"></iron-icon>',d="<br/><small class='allowed-tld-domains'>Verifiable email addresses can be from "+a.restriction_criteria.domains+" <span data-toggle='tooltip' title='e.g., your institution'>domains</span>, but must end in: "+a.restriction_criteria.tlds+"</small>",c=j?f+" Have an email in allowed TLDs / domains. "+d:k?m+" Neither your primary email or alternate email is in an allowed TLD / domain. <strong>Fix:</strong> Change your alternative email in <a href='"+b+"'>Account Settings</a>. "+d:m+" To create a new project, you must have a verifiable email address. <strong>Fix:</strong> Add  an alternative email address in <a href='"+b+"'>Account Settings</a>. "+d,w=v?f+" Have a verified username":m+" Your primary email isn't verified. <strong>Fix:</strong> Verify it in <a href='"+b+"'>Account Settings</a>",k&&(u?t=f+" Your alternate email is verified":e&&(t=m+" Your alternate email isn't verified. <strong>Fix:</strong> Verify it in <a href='"+b+"'>Account Settings</a>")),t=isNull(t)?"":"<li>"+t+"</li>",o="",l&&(p=r.toBool()?"a SuperUser":"an administrator",o=f+" You're "+p+". You're always unrestricted."),g="<div>\n  "+o+'\n  <ul class="restriction-criteria">\n    <li>'+c+"</li>\n    <li>"+w+"</li>\n    "+t+"\n  </ul>\n  <p>\n    Restricted accounts can't create projects.\n  </p>\n</div>",s=n?"Your account is unrestricted":"Your account is restricted",$("#restriction-summary").remove(),h='<paper-dialog id="restriction-summary" modal>\n  <h2>'+s+"</h2>\n  <paper-dialog-scrollable>\n    "+g+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("body").append(h),safariDialogHelper("#restriction-summary",0,function(){return console.info("Opened restriction summary dialog")}),!1}),!1},verifyLoginCredentials=function(a){var b,c,d,e;return c=$.cookie(adminParams.domain+"_auth"),e=$.cookie(adminParams.domain+"_secret"),d=$.cookie(adminParams.domain+"_link"),b="hash="+c+"&secret="+e+"&dblink="+d,$.post(adminParams.loginApiTarget,b,"json").done(function(b){return b.status===!0?("undefined"!=typeof _adp&&null!==_adp||(window._adp=new Object),_adp.isUnrestricted=b.unrestricted,a(b)):goTo(b.login_url)}).fail(function(a,b){return $("main #main-body").html("<div class='bs-callout-danger bs-callout'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p></div>"),console.log(a,b),!1}),!1},startAdminActionHelper=function(){var a;return $("#admin-actions-block").empty(),$("#pib-wrapper-dashboard").remove(),a='<span id="pib-wrapper-dashboard" class="pib-wrapper" data-toggle="tooltip" title="Administration Home" data-placement="bottom">\n  <paper-icon-button icon="icons:dashboard" class="admin-action" id="show-actions">\n  </paper-icon-button>\n</span>',$("#pib-wrapper-settings").after(a),$("#show-actions").click(function(){return $(this).tooltip("hide"),$(".tooltip").tooltip("hide"),populateAdminActions()})},getInfoTooltip=function(a){var b;return null==a&&(a="No Message Provided"),b='<div class="col-xs-1 adjacent-info">\n  <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="'+a+'"></span>\n</div>'},alertBadProject=function(a){return a=null!=a?"project "+a:"this project",stopLoadError("Sorry, "+a+" doesn't exist"),!1},loadCreateNewProject=function(){var a,b,c,d,e,f,g,h,i;i=uri.urlString+"admin-page.html#action:create-project",g={do:"action",prop:"create-project"},history.pushState(g,"Create New Project",i),startAdminActionHelper(),b='<h2 class="new-title col-xs-12">Project Title</h2>\n<paper-input label="Descriptive, unique project title" id="project-title" class="project-field col-md-6 col-xs-11" required auto-validate data-field="project_title"></paper-input>\n'+getInfoTooltip("A descriptive title is most useful. Tell us the main focus of the project and whether a monitoring effort or project that just occurred in the Spring of 2015.")+'\n<h2 class="new-title col-xs-12">Project Parameters</h2>\n<section class="project-inputs clearfix col-xs-12">\n  <div class="row">\n    <paper-input label="Primary Pathogen" id="project-disease" class="project-field col-xs-6" required auto-validate data-field="disease"></paper-input>\n      '+getInfoTooltip("Bd, Bsal, or other. If empty, we'll take it from your data.")+'\n      <button class="btn btn-default fill-pathogen col-xs-2" data-pathogen="Batrachochytrium dendrobatidis">Bd</button>\n      <button class="btn btn-default fill-pathogen col-xs-2" data-pathogen="Batrachochytrium salamandrivorans">Bsal</button>\n    <paper-input label="Pathogen Strain" id="project-disease-strain" class="project-field col-md-6 col-xs-11" data-field="disease_strain"></paper-input>'+getInfoTooltip("For example, specific Bd strains which have been sequenced JEL423, JAM81, if known")+'\n    <paper-input label="Project Reference" id="reference-id" class="project-field col-md-6 col-xs-11" data-field="reference_id"></paper-input>\n    '+getInfoTooltip("E.g.  a DOI or other reference")+'\n    <paper-input label="Publication DOI" id="pub-doi" class="project-field col-md-6 col-xs-11" data-field="publication"></paper-input>\n    '+getInfoTooltip("Publication DOI citing these datasets may be added here.")+'\n    <h2 class="new-title col-xs-12">Lab Parameters</h2>\n    <paper-input label="Project PI" id="project-pi" class="project-field col-md-6 col-xs-12"  required auto-validate data-field="pi_lab"></paper-input>\n    <paper-input label="Project Contact" id="project-author" class="project-field col-md-6 col-xs-12" value="'+userFullname+'"  required auto-validate></paper-input>\n    '+getInfoTooltip("This will be the identity used for the project citation")+'\n    <gold-email-input label="Contact Email" id="author-email" class="project-field col-md-6 col-xs-12" value="'+userEmail+'"  required auto-validate></gold-email-input>\n    <paper-input label="Technical/Data Contact" id="project-technical-contact" class="project-field col-md-6 col-xs-12" value="'+userFullname+'"  required auto-validate></paper-input>\n    '+getInfoTooltip("This will be the identity suggested for technical communications about the project")+'\n    <gold-email-input label="Technical/Data Contact Email" id="technical-contact-email" class="project-field col-md-6 col-xs-12" value="'+userEmail+'"  required auto-validate></gold-email-input>\n    <paper-input label="Diagnostic Lab" id="project-lab" class="project-field col-md-6 col-xs-11"  required auto-validate></paper-input>\n    '+getInfoTooltip("Name or PI responsible for lab results")+'\n    <paper-input label="Affiliation" id="project-affiliation" class="project-field col-md-6 col-xs-11"  required auto-validate></paper-input> '+getInfoTooltip("Of project PI. e.g., UC Berkeley")+'\n    <h2 class="new-title col-xs-12">Project Notes</h2>\n    <iron-autogrow-textarea id="project-notes" class="project-field col-md-6 col-xs-11 language-markdown" rows="3" data-field="sample_notes"></iron-autogrow-textarea>'+getInfoTooltip("Project notes or brief abstract; accepts Markdown ")+'\n    <marked-element class="project-param col-md-6 col-xs-12" id="note-preview">\n      <div class="markdown-html"></div>\n    </marked-element>\n    <h2 class="new-title col-xs-12">Data Permissions</h2>\n    <div class="col-xs-12">\n      <span class="toggle-off-label iron-label">Private Dataset</span>\n      <paper-toggle-button id="data-encumbrance-toggle" class="red">Public Dataset</paper-toggle-button>\n      '+getInfoTooltip("this will be the setting for all data uploaded to this Project")+'\n    </div>\n\n    <h2 class="new-title col-xs-12">Project Area of Interest</h2>\n    <div class="col-xs-12">\n      <p>\n        This represents the approximate collection region for your samples.\n        <br/>\n        <strong>\n          The last thing you do (search, build a locality, or upload data) will be your dataset\'s canonical locality.\n        </strong>.\n      </p>\n      <span class="toggle-off-label iron-label">Locality Name</span>\n      <paper-toggle-button id="transect-input-toggle">Coordinate List</paper-toggle-button>\n    </div>\n    <p id="transect-instructions" class="col-xs-12"></p>\n    <div id="transect-input" class="col-md-6 col-xs-12">\n      <div id="transect-input-container" class="clearfix">\n      </div>\n      <p class="computed-locality" id="computed-locality">\n        You may also click on the map to outline a region of interest, then click "Build Map" below to calculate a locality.\n      </p>\n      <br/><br/>\n      <button class="btn btn-primary" disabled id="init-map-build">\n        <iron-icon icon="maps:map"></iron-icon>\n        Build Map\n        <small>\n          (<span class="points-count">0</span> points)\n        </small>\n      </button>\n      <paper-icon-button icon="icons:restore" id="reset-map-builder" data-toggle="tooltip" title="Reset Points"></paper-icon-button>\n    </div>\n    <div id="carto-rendered-map" class="col-md-6 col-xs-12">\n      <div id="carto-map-container" class="carto-map map">\n      </div>\n    </div>\n    <div class="col-xs-12">\n      <br/>\n      <paper-checkbox checked id="has-data">My project already has data</paper-checkbox>\n      <br/>\n    </div>\n  </div>\n</section>\n<section id="uploader-container-section" class="data-section col-xs-12 clearfix">\n  <h2 class="new-title">Uploading your project data</h2>\n  <p>Drag and drop as many files as you need below. </p>\n  <p>\n    Please note that the data <strong>must</strong> have a header row,\n    and the data <strong>must</strong> have the columns <code>decimalLatitude</code>, <code>decimalLongitude</code>, and <code>coordinateUncertaintyInMeters</code>. Your project must also be titled before uploading data.\n  </p>\n  <div class="alert alert-info" role="alert">\n    We\'ve partnered with the Biocode FIMS project and you can get a template with definitions at <a href="http://biscicol.org/biocode-fims/templates.jsp" class="newwindow alert-link" data-newtab="true">biscicol.org <span class="glyphicon glyphicon-new-window"></span></a>. Check out the documentation for <a href="https://amphibian-disease-tracker.readthedocs.org/en/latest/Creating%20a%20New%20Project/#with-data" class="newwindow alert-link" data-newtab="true">more instructions <span class="glyphicon glyphicon-new-window"></span></a>\n  </div>\n  <div class="alert alert-warning" role="alert">\n    <strong>If the data are in Excel</strong>, ensure that they are in the first sheet in the workbook, or in a worksheet titled <code>Samples</code>, as per FIMS.\n  </div>\n</section>\n<section class="project-inputs clearfix data-section col-xs-12">\n  <div class="row">\n    <h2 class="new-title col-xs-12">Project Data Summary</h2>\n    <h3 class="new-title col-xs-12">Calculated Data Parameters</h3>\n    <paper-input label="Samples Counted" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="samplecount" readonly type="number" data-field="disease_samples"></paper-input>\n    <paper-input label="Positive Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="positive-samples" readonly type="number" data-field="disease_positive"></paper-input>\n    <paper-input label="Negative Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="negative-samples" readonly type="number" data-field="disease_negative"></paper-input>\n    <paper-input label="No Confidence Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="no_confidence-samples" readonly type="number" data-field="disease_no_confidence"></paper-input>\n    <paper-input label="Disease Morbidity" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="morbidity-count" readonly type="number" data-field="disease_morbidity"></paper-input>\n    <paper-input label="Disease Mortality" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="mortality-count" readonly type="number" data-field="disease_mortality"></paper-input>\n    <h4 class="new-title col-xs-12">Species in dataset</h4>\n    <iron-autogrow-textarea id="species-list" class="project-field col-md-6 col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    <p class="col-xs-12"><a id="download-server-parsed-data" class="btn btn-primary disabled">Download Parsed Data</a></p>\n  </div>\n</section>\n<section id="submission-section" class="col-xs-12">\n  <div class="pull-right">\n    <button id="upload-data" class="btn btn-success click" data-function="finalizeData"><iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project</button>\n    <button id="reset-data" class="btn btn-danger click" data-function="resetForm">Reset Form</button>\n  </div>\n</section>',$("main #main-body").append(b);try{$("#project-title").blur(function(){var a,b,c,d;return c=p$(this).value.toLowerCase(),b=c.replace(/ *b(sal|d\W) *|(19|20)[0-9]{2}|\s+\W|\s+(for|the|and|of|in|from|a|an)\s+/gim," "),a=b.replace(/  /gm," "),d=a.trim().split(" "),d.length<=3&&bsAlert("Your title seems very short/generic. Read it again, and make sure it is both <strong>unique</strong> and <strong>descriptive</strong>."),!1})}catch(b){a=b,console.warn("Couldn't set up blur event - "+a.message),console.warn(a.stack)}mapNewWindows();try{for(f=$("paper-input[required]"),d=0,e=f.length;d<e;d++)c=f[d],p$(c).validate()}catch(a){console.warn("Couldn't pre-validate fields")}return $(".fill-pathogen").click(function(){var a;return a=$(this).attr("data-pathogen"),p$("#project-disease").value=a,!1}),$("#init-map-build").click(function(){return doMapBuilder(window.mapBuilder,null,function(a){return console.debug("doMapBuilder callback initialized ..."),b='<p class="text-muted" id="computed-locality">\n  Computed locality: <strong>'+a.locality+"</strong>\n</p>",$("#computed-locality").remove(),$("#using-computed-locality").remove(),$("#transect-input-container").after(b),!1})}),$("#reset-map-builder").click(function(){delete window.mapBuilder,$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length);try{p$("google-map").clear()}catch(a){}return $("google-map google-map-marker").remove(),$("google-map google-map-poly").remove()}),h=p$("#project-notes").textarea,$(h).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),bootstrapUploader(),bootstrapTransect(),$("#has-data").on("iron-change",function(){return $(this).get(0).checked?($(".data-section").removeAttr("hidden"),$(".label-with-data").removeAttr("hidden")):($(".data-section").attr("hidden","hidden"),$(".label-with-data").attr("hidden","hidden"))}),$("#data-encumbrance-toggle").on("iron-change",function(){var a;return a=p$("#data-encumbrance-toggle").checked?'<iron-icon icon="social:public"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Public Project':'<iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project',$("#upload-data").html(a)}),console.log("Getting location, prerequisite to setting up map ..."),getLocation(function(){var a;return _adp.currentLocation=new Point(window.locationData.lat,window.locationData.lng),a={bsGrid:""},console.log("Location fetched, setting up map ..."),createMap2(null,a)}),bindClicks(),!1},finalizeData=function(a,b){var c,d,e,f,g,h;null==a&&(a=!1),startLoad();try{return d=!0,$("[required]").each(function(){var a;try{if(a=$(this).val(),isNull(a))return $(this).get(0).focus(),d=!1,!1}catch(a){}}),d?(c=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectId)&&(_adp.projectId=md5(""+geo.dataTable+c+Date.now())),h=p$("#project-title").value,(null!=dataFileParams?dataFileParams.hasDataFile:void 0)&&dataFileParams.filePath.search(helperDir)===-1&&(dataFileParams.filePath=""+helperDir+dataFileParams.filePath),f=null!=(g=null!=dataFileParams?dataFileParams.filePath:void 0)?g:null,mintBcid(_adp.projectId,f,h,function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R;try{if(!c.status)return console.error(c.error),bsAlert(c.human_error,"danger"),stopLoadError(c.human_error),!1;if(dataAttrs.ark=c.ark,null==dataAttrs.data_ark&&(dataAttrs.data_ark=new Array),dataAttrs.data_ark.push(c.ark+"::"+dataFileParams.fileName),A=new Object,a)A=_adp.projectData;else for(B=$(".project-field"),p=0,q=B.length;p<q;p++)k=B[p],n=$(k).hasClass("iron-autogrow-textarea-0")?$($(k).get(0).textarea).val():$(k).val(),o=$(k).attr("data-field"),isNull(o)||("number"===$(k).attr("type")?A[o]=toInt(n):A[o]=n);if(e=getMapCenter(geo.boundingBox),l=0,null!=uploadedData){for(g=new Array,w=new Array,R=new Array,v=new Array,d=new Array,N=new Array,h=new Array,O=new Array,C=Object.toArray(uploadedData),t=0,r=C.length;t<r;t++)J=C[t],f=null!=(D=J.dateCollected)?D:J.dateIdentified,Q=excelDateToUnixTime(f),g.push(Q),P=new Date(Q),u=dateMonthToString(P.getUTCMonth()),indexOf.call(w,u)<0&&w.push(u),E=P.getFullYear(),indexOf.call(R,E)<0&&R.push(P.getFullYear()),null!=J.catalogNumber&&d.push(J.catalogNumber),N.push(J.sampleId),K=J.decimalLatitude,L=J.decimalLongitude,i=geo.distance(K,L,e.lat,e.lng),i>l&&(l=i),null!=J.sampleType&&(F=J.sampleType,indexOf.call(O,F)<0&&O.push(J.sampleType)),null!=J.specimenDisposition&&(G=J.specimenDisposition,indexOf.call(h,G)<0&&h.push(J.sampleDisposition));console.info("Got date ranges",g),w.sort(),R.sort(),A.sampled_collection_start=g.min(),A.sampled_collection_end=g.max(),console.info("Collected from",g.min(),g.max()),A.sampling_months=w.join(","),A.sampling_years=R.join(","),console.info("Got uploaded data",uploadedData),A.sample_catalog_numbers=d.join(","),A.sample_field_numbers=N.join(","),A.sample_methods_used=O.join(",")}else{if(null==geo.canonicalHullObject)try{createConvexHullFINISHME}catch(a){}if(null!=geo.canonicalHullObject)for(m=geo.canonicalHullObject.hull,x=0,s=m.length;x<s;x++)y=m[x],i=geo.distance(y.lat,y.lng,e.lat,e.lng),i>l&&(l=i)}if((null!=dataFileParams?dataFileParams.hasDataFile:void 0)&&(dataFileParams.filePath.search(helperDir)===-1&&(dataFileParams.filePath=""+helperDir+dataFileParams.filePath),A.sample_raw_data="https://amphibiandisease.org/"+dataFileParams.filePath),A.lat=e.lat,A.lng=e.lng,A.radius=toInt(1e3*l),null!=(null!=(H=_adp.data)&&null!=(I=H.pushDataUpload)?I.samples:void 0)&&(M=_adp.data.pushDataUpload.samples,A.disease_morbidity=M.morbidity,A.disease_mortality=M.mortality,A.disease_negative=M.negative,A.disease_no_confidence=M.no_confidence,A.disease_positive=M.positive,A.disease_samples=toInt(M.positive)+toInt(M.negative)+toInt(M.no_confidence)),z=function(){var c,d,e,f,g,h,i,j,k,l,m,n,p,q,r,s,t,u,v;console.info("Computed locality "+_adp.locality),A.locality=_adp.locality,null!=geo.computedBoundingRectangle&&(A.bounding_box_n=geo.computedBoundingRectangle.north,A.bounding_box_s=geo.computedBoundingRectangle.south,A.bounding_box_e=geo.computedBoundingRectangle.east,A.bounding_box_w=geo.computedBoundingRectangle.west),A.author=$.cookie(adminParams.domain+"_link");try{A.technical_contact=p$("#project-technical-contact").value,A.technical_contact_email=p$("#project-technical-contact-email").value}catch(a){}try{if("object"==typeof kmlInfo)try{A.transect_file=JSON.stringify(kmlInfo)}catch(a){h=a,console.warn("Couldn't stringify data - "+h.message,kmlInfo),null!=kmlInfo.path&&(A.transect_file=kmlInfo.path)}}catch(a){}null==("undefined"!=typeof _adp&&null!==_adp&&null!=(t=_adp.projectData)?t.author_data:void 0)?(d={name:p$("#project-author").value,contact_email:p$("#author-email").value,affiliation:p$("#project-affiliation").value,lab:p$("#project-pi").value,diagnostic_lab:p$("#project-lab").value,entry_date:Date.now()},A.author_data=JSON.stringify(d)):A.author_data=_adp.projectData.author_data,f={table:geo.dataTable,raw_data:dataFileParams,bounding_polygon:"undefined"!=typeof geo&&null!==geo?geo.canonicalBoundingBox:void 0,bounding_polygon_geojson:"undefined"!=typeof geo&&null!==geo?geo.geoJsonBoundingBox:void 0},A.carto_id=JSON.stringify(f),A.project_id=_adp.projectId;try{A.project_obj_id=_adp.fims.expedition.ark}catch(a){return mintExpedition(_adp.projectId,null,function(){return z()}),!1}if(null==dataAttrs.data_ark&&(dataAttrs.data_ark=new Array),A.dataset_arks=dataAttrs.data_ark.join(","),A.project_dir_identifier=getUploadIdentifier(),A.public=null==(k=null!=(l=null!=(m=null!=(n=p$("#data-encumbrance-toggle"))?n.checked:void 0)?m:null!=(p=p$("#public"))?p.checked:void 0)?l:"undefined"!=typeof _adp&&null!==_adp&&null!=(q=_adp.projectData)?q.public:void 0)||k,null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(r=_adp.data)&&null!=(s=r.taxa)?s.validated:void 0))for(u=_adp.data.taxa.validated,A.sampled_clades=_adp.data.taxa.clades.join(","),A.sampled_species=_adp.data.taxa.list.join(","),j=0,i=u.length;j<i&&(v=u[j],e=v.response.validated_taxon,console.info("Aweb taxon result:",e),g=e.order.toLowerCase(),o="includes_"+g,A[o]=!0,null!=A.includes_anura==!1||null!=A.includes_caudata==!1||null!=A.includes_gymnophiona==!1);j++);return c="perform=new&data="+jsonTo64(A),console.info("Data object constructed:",A),a?("function"==typeof b&&b(A),stopLoad(),A):_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,c,"json").done(function(a){var b;try{a.status===!0?(bsAlert("Project ID #<strong>"+A.project_id+"</strong> created","success"),stopLoad(),delay(1e3,function(){return loadEditor(_adp.projectId)}),toastStatusMessage("Data successfully saved to server")):(console.error(a.error.error),console.log(a),stopLoadError(a.human_error),bsAlert(a.human_error,"error"))}catch(c){h=c,stopLoadError("There was a verifying your save data");try{b=JSON.stringify(a)}catch(a){b="BAD_OBJECT"}try{bsAlert("There was a problem verifying your save data<br/><br/>Application said: <code>"+b+"</code><code>"+h.message+"</code><code>"+h.stack+"</code>","error")}catch(a){}console.error("JavaScript error in save data callback! FinalizeData said: "+h.message),console.warn(h.stack)}return!1}).fail(function(a,b){return stopLoadError("There was a problem saving your data. Please try again"),!1})},console.info("Checking locality ..."),null==geo.computedLocality&&dataFileParams.hasDataFile){if(dataFileParams.hasDataFile)return null==e&&(e=getMapCenter(geo.boundingBox)),console.info("Computing locality with reverse geocode from",e,geo.boundingBox),geo.reverseGeocode(e.lat,e.lng,geo.boundingBox,function(a){return console.info("Computed locality "+a),_adp.locality=a,z()});try{_adp.locality=p$("#locality-input").value}catch(a){_adp.locality=""}return console.warn("How did we get to this state? No locality precomputed, no data file"),z()}if(null!=geo.computedLocality)console.info("Already have locality"),_adp.locality=geo.computedLocality;else try{console.info("Took written locality"),_adp.locality=p$("#locality-input").value}catch(a){console.info("Can't figure out locality"),_adp.locality=""}return dataFileParams.hasDataFile?z():mintExpedition(_adp.projectId,null,function(){return z()})}catch(a){return j=a,stopLoadError("There was a problem with the application. Please try again later. (E-003)"),console.error("JavaScript error in saving data (E-003)! FinalizeData said: "+j.message),console.warn(j.stack)}})):(stopLoadError("Please fill out all required fields"),!1)}catch(a){e=a,stopLoadError("There was a problem with the application. Please try again later. (E-004)");try{bsAlert("There was a problem with the application. Please try again later. (E-004)<br/><br/>Application said: <code>"+e.message+"</code><code>"+e.stack+"</code>","error")}catch(a){}return console.error("JavaScript error in saving data (E-004)! FinalizeData said: "+e.message),console.warn(e.stack)}},resetForm=function(){return foo()},getTableCoordinates=function(a){return null==a&&(a="tdf0f1bc730325de59d48a5c80df45931_6d6d454828c05e8ceea03c99cc5f547e52fcb5fb"),!1},pointStringToLatLng=function(a,b){var c,d,e,f,g;return null==b&&(b=!1),a.search(!1)?(g=a.slice(6,-1),e=g.split(" "),c=Math.abs(e[0])>90||b?1:0,d=1===c?0:1,f={lat:e[c],lng:e[d]}):(console.warn("Invalid point string"),!1)},pointStringToPoint=function(a,b){var c,d;return null==b&&(b=!1),a.search(!1)?(d=pointStringToLatLng(a,b),c=canonicalizePoint(d)):(console.warn("Invalid point string"),!1)},bootstrapTransect=function(){var a,b;return window.geocodeLookupCallback=function(){var a,b,c;return startLoad(),b=p$("#locality-input").value,a=new google.maps.Geocoder,c={address:b},a.geocode(c,function(a,b){var c,d,e,f,g,h,i,j,k,l;if(b===google.maps.GeocoderStatus.OK){console.info("Google said:",a),$("#locality-lookup-result").exists()||$("#carto-rendered-map").prepend('<div class="alert alert-info alert-dismissable" role="alert" id="locality-lookup-result">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <strong>Location Found</strong>: <span class="lookup-name">'+a[0].formatted_address+"</span>\n</div>"),
i='<p class="text-muted" id="computed-locality">\n  Computed locality: <strong>'+a[0].formatted_address+'</strong>\n</p>\n<div class="alert alert-info" id="using-computed-locality">\n  <p>\n    This is your currently active locality. Entering points below will take priority over this.\n  </p>\n</div>',$("#computed-locality").remove(),$("#using-computed-locality").remove(),$("#transect-input-container").after(i),$("#locality-lookup-result .lookup-name").text(a[0].formatted_address),_adp.locality=a[0].formatted_address,l=a[0].geometry.location,j=l.lat(),k=l.lng(),f=a[0].geometry.viewport;try{c=f.R,d=f.j,e={nw:[c.j,d.R],ne:[c.j,d.j],se:[c.R,d.R],sw:[c.R,d.j],north:c.j,south:c.R,east:d.j,west:d.R}}catch(b){h=b,console.warn("Danger: There was an error calculating the bounding box ("+h.message+")"),console.warn(h.stack),console.info("Got bounds",f),console.info("Got geometry",a[0].geometry)}return console.info("Got bounds: ",[j,k],e),geo.boundingBox=e,g=function(){return geo.renderMapHelper(e,j,k)},loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",g,!1)}return stopLoadError("Couldn't find location: "+b)})},geo.renderMapHelper=function(a,b,c){var d,e,f,g;if(null==a&&(a=geo.boundingBox),startLoad(),null==("undefined"!=typeof google&&null!==google?google.maps:void 0))return window.recallMapHelper=function(){return geo.renderMapHelper(a,b,c)},loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=recallMapHelper"),!1;try{return $("#carto-map-container").empty(),e={selector:"#carto-map-container",bsGrid:""},$(e.selector).empty(),g=function(){return stopLoad(),!1},null!=geo.dataTable?getCanonicalDataCoords(geo.dataTable,e,function(){return g()}):(e.boundingBox=a,f=new Point(b,c),createMap2([f],e,function(){return g()}))}catch(a){return d=a,console.error("There was an error rendering the map - "+d.message),stopLoadError("There was an error rendering the map - "+d.message)}},a=function(){return null==("undefined"!=typeof google&&null!==google?google.maps:void 0)?loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=geocodeLookupCallback"):geocodeLookupCallback(),!1},(b=function(){var b,c;return p$("#transect-input-toggle").checked?(b="Please input a list of coordinates, in the form <code>lat, lng</code>, with one set on each line. <strong>Please press <kbd>enter</kbd> to insert a new line after your last coordinate</strong>.",c='<iron-autogrow-textarea id="coord-input" class="" rows="3"></iron-autogrow-textarea>'):(b="Please enter a name of a locality",c='<paper-input id="locality-input" label="Locality" class="pull-left"></paper-input> <paper-icon-button class="pull-left" id="do-search-locality" icon="icons:search"></paper-icon-button>'),$("#transect-instructions").html(b),$("#transect-input-container").html(c),p$("#transect-input-toggle").checked?$(p$("#coord-input").textarea).keyup(function(a){return function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(j=a.keyCode?a.keyCode:a.which,13===j&&(q=$(p$("#coord-input").textarea).val(),n=q.split("\n").length,n>3)){for(f=new Array,g=q.split("\n"),console.info("Raw coordinate info:",g),k=0,l=g.length;k<l;k++)d=g[k],d.search(",")>0&&!isNull(d)&&(e=d.split(","),2===e.length&&(p=[toFloat(e[0]),toFloat(e[1])],f.push(p)));if(f.length>=3){for(console.info("Coords:",f),i=0,b=new Object,o=0,m=f.length;o<m;o++)c=f[o],++i,b[i]=c;return h=function(){return geo.renderMapHelper(b)},geo.boundingBox=b,loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",h,!1)}return console.warn("There is one or more invalid coordinates preventing the UI from being shown.")}}}(this)):($("#locality-input").keyup(function(b){var c;if(c=b.keyCode?b.keyCode:b.which,13===c)return a()}),$("#do-search-locality").click(function(){return a()})),!1})(),$("#transect-input-toggle").on("iron-change",function(){return b()}),!1},mapOverlayPolygon=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(null==b&&(b=null),null==c&&(c=new Object),null==d&&(d=geo.googleMap),n=new Object,"object"!=typeof a)return console.warn("mapOverlayPolygon() got an invalid data type to overlay!"),!1;if("object"!=typeof c&&(c=new Object),null==c.fillColor&&(c.fillColor="#ff7800"),n.fillColor=c.fillColor,n.fillOpacity=.35,"object"!=typeof b&&(b=null),console.info("Should overlay polygon from bounds here"),$("#carto-map-container").exists()&&null!=geo.cartoMap){s=new Array,f=new Array,e=new Array,l=new Array,m=new Array,t=-90,v=90,k=-180,x=180;for(r in a)u=a[r],s.push(u),w=new Object,w.lat=u[0],w.lng=u[1],e.push(new fPoint(w.lat,w.lng)),m.push(new Point(w.lat,w.lng));l=sortPoints(m),f=sortPoints(m,!1),g=e,g.sort(sortPointY),g.sort(sortPointX),h=new Array,h.push(s);try{i=getConvexHullPoints(g)}catch(a){j=a,console.error("Convex hull points CHP failed! - "+j.message),console.warn(j.stack),console.info(g)}console.info("Got hulls",i),console.info("Sources",f,e,g),n.paths=i,q={type:"Polygon",coordinates:i},p={type:"Feature",properties:b,geometry:q},console.info("Rendering GeoJSON MultiPolygon",q),geo.geoJsonBoundingBox=p,geo.overlayOptions=c,console.info("Rendering Google Maps polygon",n),geo.canonicalBoundingBox=n,o=new google.maps.Polygon(n),null!=geo.googlePolygon&&geo.googlePolygon.setMap(null),geo.googlePolygon=o,o.setMap(d),isNull(dataAttrs.coords||isNull(geo.dataTable))||getCanonicalDataCoords(geo.dataTable)}else console.warn("There's no map yet! Can't overlay polygon");return!1},mapAddPoints=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(null==c&&(c=geo.googleMap),j=0,k=a.length;j<k;j++)if(r=a[j],!(r instanceof geo.Point))return console.warn("Invalid datatype in array -- array must be constructed of Point objects"),!1;for(q=new Object,g=new Array,e=0,m=0,l=a.length;m<l;m++)r=a[m],u=null!=b?null!=(t=b[e])?t.title:void 0:"",s=r.getObj(),d=new google.maps.LatLng(s.lat,s.lng),o={position:d,map:c,title:u},n=new google.maps.Marker(o),q[e]={marker:n},isNull(u)?console.info("Key "+e+" has no title in pointInfoArray",b[e]):(h={content:b[e].html},f=new google.maps.InfoWindow(h),q[e].infoWindow=f,g.push(f)),++e;if(!isNull(g)){dataAttrs.coordInfoWindows=g;for(i in q)p=q[i],n=p.marker,n.unbind("click"),n.self=n,n.iw=p.infoWindow,n.iwk=i,n.addListener("click",function(){var a;try{return this.iw.open(c,this),console.info("Opening infoWindow #"+this.iwk)}catch(b){return a=b,console.error("Invalid infowindow @ "+this.iwk+"!",g,p,this.iw)}});geo.markers=q}return q},getCanonicalDataCoords=function(a,b,c){return null==b&&(b=_adp.defaultMapOptions),null==c&&(c=createMap2),isNull(a)?(console.error("A table must be specified!"),!1):"function"!=typeof c?(console.error("This function needs a callback function as the second argument"),!1):(verifyLoginCredentials(function(d){var e,f;return f="SELECT * FROM "+a+" WHERE FALSE",e="action=fetch&sql_query="+post64(f),_adp.currentAsyncJqxhr=$.post("api.php",e,"json").done(function(g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;try{q=JSON.parse(g.post_response[0])}catch(d){m=d,console.error("getCanonicalDataCoords couldn't read carto data! Failed to get columns ("+m.message+")",g),console.warn("Table: '"+a+"' for query",f),console.warn(m.stack),n=null!=(r=null!=(s=g.human_error)?s:g.error)?r:"It should be safe, however.",p="There was a problem fetching your data back from CartoDB. ",stopLoadError(p),bsAlert(p,"danger");try{"function"==typeof c&&c([],b)}catch(a){}return!1}k=new Object,t=q.fields;for(o in t)w=t[o],k[o]=w;_adp.activeCols=k,l=new Array,j=new Object;for(i in k)v=k[i],"id"!==i&&"the_geom"!==i&&l.push(i),j[i.toLowerCase()]=i;return _adp.colsList=l,_adp.colRemap=j,u="SELECT ST_AsText(the_geom), "+l.join(",")+" FROM "+a,h=encodeURIComponent(encode64(u)),e="action=fetch&sql_query="+h,_adp.currentAsyncJqxhr=$.post("api.php",e,"json").done(function(a){var e,f,g,h,k,l,m,n,o,p,q;e=a.parsed_responses[0],f=new Array,h=new Array,_adp.cartoRows=new Object,m=e.rows;for(g in m){o=m[g],_adp.cartoRows[g]=new Object;for(i in o)q=o[i],l=null!=(n=j[i])?n:i,_adp.cartoRows[g][l]=q;p=o.st_astext,isNull(o.infraspecificepithet)&&(o.infraspecificepithet=""),k=pointStringToLatLng(p,!0),d={title:o.catalognumber+": "+o.genus+" "+o.specificepithet+" "+o.infraspecificepithet,html:'<p>\n  <span class="sciname italic">'+o.genus+" "+o.specificepithet+" "+o.infraspecificepithet+"</span> collected on "+o.dateidentified+"\n</p>\n<p>\n  <strong>Status:</strong>\n  Sampled by "+o.samplemethod+", disease status "+o.diseasedetected+" for "+o.diseasetested+"\n</p>"},k.infoWindow=d,f.push(k),h.push(d)}if(dataAttrs.coords=f,dataAttrs.markerInfo=h,console.info("Calling back with",f,b),"function"==typeof c)return c(f,b)}).fail(function(a,d){return null!=(null!=dataAttrs?dataAttrs.coords:void 0)?c(dataAttrs.coords,b):(stopLoadError("Couldn't get bounding coordinates from data"),console.error("No valid coordinates accessible!"))})}).fail(function(a,b){return!1})}),!1)},getUploadIdentifier=function(){var a,b,c;if(isNull(_adp.uploadIdentifier)){if(isNull(_adp.projectId)){if(a=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectIdentifierString)){try{c=isNull(p$("#project-title").value)?randomString(16):p$("#project-title").value}catch(a){c=randomString(16)}b="t"+md5(c+a),_adp.projectIdentifierString=b}_adp.projectId=md5(""+b+a+Date.now())}_adp.uploadIdentifier=md5(""+user+_adp.projectId)}return _adp.uploadIdentifier},bootstrapUploader=function(a,b,c){var d,e,f,g,h;return null==a&&(a="file-uploader"),null==b&&(b="col-md-4"),g="#"+a,d=$.cookie(adminParams.domain+"_link"),h=getUploadIdentifier(),f=_adp.projectIdentifierString,$(g).exists()||(e='<form id="'+a+'-form" class="'+b+' clearfix">\n  <p class="visible-xs-block">Tap the button to upload a file</p>\n  <fieldset class="hidden-xs">\n    <legend>Upload Files</legend>\n    <div id="'+a+'" class="media-uploader outline media-upload-target">\n    </div>\n  </fieldset>\n</form>',$("main #uploader-container-section").append(e),console.info("Appended upload form"),$(g).submit(function(a){return a.preventDefault(),a.stopPropagation(),!1})),verifyLoginCredentials(function(){var a;return null==window.dropperParams&&(window.dropperParams=new Object),window.dropperParams.dropTargetSelector=g,window.dropperParams.uploadPath="uploaded/"+getUploadIdentifier()+"/",a=window.dropperParams.hasInitialized===!0,loadJS("helpers/js-dragdrop/client-upload.min.js",function(){if(console.info("Loaded drag drop helper"),a){console.info("Reinitialized dropper");try{window.dropperParams.initialize()}catch(a){console.warn("Couldn't reinitialize dropper!")}}if(window.dropperParams.postUploadHandler=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof b)return console.error("Dropzone returned an error - "+b),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(b.status!==!0)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(""+b.human_error),console.error("Error uploading!",b),!1;try{switch(console.info("Server returned the following result:",b),console.info("The script returned the following file information:",a),k="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",g=b.full_path.split("/").pop(),m=b.wrote_thumb,j=b.mime_provided.split("/")[0],i=b.mime_provided.split("/")[1],h=a.size<5242880||"image"!==j?""+k+b.wrote_file:""+k+m,l=function(){switch(j){case"image":return'<div class="uploaded-media center-block" data-system-file="'+g+'" data-link-path="'+h+'">\n  <img src="'+h+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+a.name+" -> "+g+'\n      (<a href="'+h+'" class="newwindow" download="'+a.name+'">\n        Original Image\n      </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+g+'">\n  <audio src="'+h+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+a.name+" -> "+g+'\n    (<a href="'+h+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+g+'">\n  <video src="'+h+'" controls preload="auto">\n    <img src="'+k+m+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+a.name+" -> "+g+'\n    (<a href="'+h+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+g+'" data-link-path="'+h+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+a.name+" -> "+g+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(l),$("#validator-progress-container").remove(),c=h.slice(0),d=h.slice(0),f=d.split(".").pop(),j){case"application":switch(console.info("Checking "+i+" in application"),i){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":return excelHandler(h);case"vnd.ms-office":switch(f){case"xls":return excelHandler(h);default:return stopLoadError("Sorry, we didn't understand the upload type."),!1}break;case"zip":case"x-zip-compressed":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===a.type||"xlsx"===f?excelHandler(h):"kmz"===f?kmlHandler(h):zipHandler(h);case"x-7z-compressed":return _7zHandler(h);case"vnd.google-earth.kml+xml":case"vnd.google-earth.kmz":case"xml":return"kml"===f||"kmz"===f?kmlHandler(h):(console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+i),!1);default:return console.warn("Unknown mime type application/"+i),allError("Sorry, we can't processes files of type application/"+i),!1}break;case"text":return csvHandler(h);case"image":return imageHandler(h)}}catch(a){return e=a,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}},"function"==typeof c)return c()}),!1})},singleDataFileHelper=function(a,b){var c;return"function"!=typeof b?(console.error("Second argument must be a function"),!1):dataFileParams.hasDataFile===!0&&a!==dataFileParams.filePath?($("#single-data-file-modal").exists()&&$("#single-data-file-modal").remove(),c='<paper-dialog modal id="single-data-file-modal">\n  <h2>You can only have one primary data file</h2>\n  <div>\n    Continuing will remove your previous one\n  </div>\n  <div class="buttons">\n    <paper-button id="cancel-parse">Cancel Upload</paper-button>\n    <paper-button id="overwrite">Replace Previous</paper-button>\n  </div>\n</paper-dialog>',$("body").append(c),$("#cancel-parse").click(function(){return removeDataFile(a,!1),p$("#single-data-file-modal").close(),!1}),$("#overwrite").click(function(){return removeDataFile(),p$("#single-data-file-modal").close(),b()}),safariDialogHelper("#single-data-file-modal")):b()},excelHandler=function(a,b,c){var d,e,f,g,h,i,j,k;null==b&&(b=!0),startLoad(),$("#validator-progress-container").remove(),renderValidateProgress(),g=helperDir+"excelHelper.php",e=a,a.search(helperDir)!==-1&&(console.info("removing '"+helperDir+"'"),e=a.slice(helperDir.length)),console.info("Pinging for "+e),d="action=parse&path="+e+"&sheets=Samples",f=!1;try{for(k=$("paper-input[required]"),i=0,j=k.length;i<j;i++)if(h=k[i],p$(h).invalid){f=!0,stopLoadError("Please fill out all required fields before uploading data"),bsAlert("Please fill out all required fields before uploading data","danger");try{stopLoadBarsError()}catch(a){}return removeDataFile(e),!1}}catch(a){}return f?(console.error("Exiting handler -- invalid inputs"),!1):($.get(g,d,"json").done(function(b){return console.info("Got result",b),b.status===!1?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):singleDataFileHelper(a,function(){var d,f;$("#upload-data").attr("disabled","disabled"),d=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=d.pop(),dataFileParams.filePath=e,f=Object.size(b.data),uploadedData=b.data,_adp.parsedUploadedData=b.data;try{p$("#replace-data-toggle").disabled=!1}catch(a){}return"function"!=typeof c?newGeoDataHandler(b.data):(console.warn("Skipping newGeoDataHandler() !"),c(b.data)),stopLoad()})}).fail(function(a,b){return console.error("Couldn't POST"),console.warn(a,b),stopLoadError()}),!1)},csvHandler=function(a,b,c){var d;return null==b&&(b=!0),a.search(helperDir)!==-1&&(console.info("removing '"+helperDir+"'"),d=a.slice(helperDir.length)),singleDataFileHelper(a,function(){var b;return $("#upload-data").attr("disabled","disabled"),b=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=b.pop(),dataFileParams.filePath=d,geoDataHandler()}),!1},kmlHandler=function(a,b){var c,d;try{console.debug("Loading KML file")}catch(a){}return geo.inhibitKMLInit=!0,c=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(d=_adp.lastMod)?d.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),loadJS(c,function(){return initializeParser(null,function(){return loadKML(a,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;try{if(o=geo.kml.parser.docsByUrl[a],isNull(o)&&(a="/"+a,o=geo.kml.parser.docsByUrl[a],isNull(o)&&(console.warn("Could not resolve KML by url, using first doc"),o=geo.kml.parser.docs[0])),isNull(o))return allError("Bad KML provided"),!1;for(console.debug("Using parsed data from path '"+a+"'",o),t=new Array,r=new Array,s=new Array,u=o.gpolygons,i=0,j=u.length;i<j;i++){for(q=u[i],p=new Array,r.push(q.fillColor),s.push(q.fillOpacity),v=q.getPaths().getArray(),m=0,k=v.length;m<k;m++)for(x=v[m],w=x.getArray(),n=0,l=w.length;n<l;n++)y=w[n],A=canonicalizePoint(y),p.push(A);t.push(p)}window.kmlInfo=new Object,kmlInfo.path=a;try{if(z=t[0],1===t.length&&(t=t[0]),c={fillOpacity:s[0],fillColor:r[0],paths:z,multibounds:t},kmlInfo.parameters=c,kmlInfo.polys=t,isNull(geo)&&(window.geo=new Object),isNull(geo.canonicalHullObject)&&(geo.canonicalHullObject=new Object),geo.canonicalHullObject.hull=z,geo.canonicalBoundingBox=c,!isNull("undefined"!=typeof _adp&&null!==_adp?_adp.projectData:void 0))try{if(f=_adp.projectData.carto_id,"object"!=typeof f)try{d=JSON.parse(deEscape(f))}catch(a){g=a,h=g.message;try{d=JSON.parse(f)}catch(a){if(g=a,f.length>511&&(e=fixTruncatedJson(f),"object"==typeof e&&(console.debug("The carto data object was truncated, but rebuilt."),d=e)),isNull(d))return console.error("cartoObj must be JSON string or obj, given",f),console.warn("Cleaned obj:",deEscape(f)),console.warn("Told '"+h+"' then",g.message),stopLoadError("Couldn't parse data"),!1}}else d=f;d.bounding_polygon=c,_adp.projectData.carto_id=JSON.stringify(d)}catch(a){g=a,console.error(g.message),console.warn(g.stack),allError("Warning: there may have been a problem saving your carto data")}}catch(a){g=a,console.warn("WARNING: Couldn't write polygon data to globals")}"function"==typeof b?b(kmlInfo):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(a){g=a,allError("There was an error importing the data from this KML file"),console.warn(g.message),console.warn(g.stack)}return!1}),!1}),!1}),!1},copyMarkdown=function(a,b,c){var d,e,f,g,h,i;if(null==c&&(c=!0),null==("undefined"!=typeof _adp&&null!==_adp?_adp.zcClient:void 0)&&(i={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},ZeroClipboard.config(i),_adp.zcClient=new ZeroClipboard($(a).get(0)),$("#copy-ark").click(function(){return copyLink(_adp.zcClient)})),d=p$(".ark-identifier").value,c)try{return h="https://n2t.net/"+d,f={dataType:"text/plain",data:h,"text/plain":h},e=new ClipboardEvent("copy",f),document.dispatchEvent(e),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(a){g=a,console.error("Error creating copy: "+g.message),console.warn(g.stack)}return console.warn("Can't use HTML5"),"undefined"!=typeof zeroClipObj&&null!==zeroClipObj?(zeroClipObj.setData(f),null!=b&&b.setData(f),zeroClipObj.on("aftercopy",function(a){return toastStatusMessage(a.data["text/plain"]?"ARK resolver path copied to clipboard":"Error copying to clipboard")}),zeroClipObj.on("error",function(a){if(console.error("Error copying to clipboard"),console.warn("Got",a),"flash-overdue"===a.name){if(_adp.resetClipboard===!0)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,copyLink()}),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0))}if("flash-disabled"===a.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),$("#copy-ark").tooltip("destroy").remove(),$(".ark-identifier").removeClass("col-xs-9 col-md-11").addClass("col-xs-12"),toastStatusMessage("Clipboard copying isn't available on your system")})):console.error("Can't use HTML, and ZeroClipboard wasn't passed"),!1},imageHandler=function(a){var b;return b=$("div[data-link-path='"+a+"']"),foo(),!1},zipHandler=function(a){return foo(),!1},_7zHandler=function(a){return foo(),!1},removeDataFile=function(a,b){var c,d;return null==a&&(a=dataFileParams.fileName),null==b&&(b=!0),a=a.split("/").pop(),b&&(dataFileParams.hasDataFile=!1),$(".uploaded-media[data-system-file='"+a+"']").remove(),$("#validator-progress-container paper-progress").removeAttr("indeterminate"),d=helperDir+"/js-dragdrop/uploaded/"+_adp.uploadIdentifier+"/"+a,c="action=removefile&path="+encode64(d)+"&user="+user,!1},newGeoDataHandler=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N;null==a&&(a=new Object),null==b&&(b=!1),console.info("Starting geoDataHandler()");try{if(null==geo.geocoder)try{geo.geocoder=new google.maps.Geocoder}catch(a){}try{D=a[0]}catch(a){return toastStatusMessage("Your data file was malformed, and could not be parsed. Please try again."),removeDataFile(),!1}if(isNull(D.decimalLatitude)||isNull(D.decimalLongitude)||isNull(D.coordinateUncertaintyInMeters))return toastStatusMessage("Data are missing required geo columns. Please reformat and try again."),v="You're missing ",u=new Array,isNull(D.decimalLatitude)&&u.push("decimalLatitude"),isNull(D.decimalLongitude)&&u.push("decimalLongitude"),isNull(D.coordinateUncertaintyInMeters)&&u.push("coordinateUncertaintyInMeters"),v+=u.length>1?"some required columns: ":"a required column: ",t=u.join("</code>, <code>"),v+="<code>"+t+"</code>",bsAlert(v,"danger"),console.info("Missing: ",null!=D.decimalLatitude,null!=D.decimalLongitude,null!=D.coordinateUncertaintyInMeters),removeDataFile(),!1;if(!(isNumber(D.decimalLatitude)&&isNumber(D.decimalLongitude)&&isNumber(D.coordinateUncertaintyInMeters)))return toastStatusMessage("Data has invalid entries for geo columns. Please be sure they're all numeric and try again."),removeDataFile(),!1;C=Object.size(a);try{p$("#samplecount").value=C}catch(a){}if(isNull($("#project-disease").val()))try{p$("#project-disease").value=D.diseaseTested}catch(a){}z=new Object,dataAttrs.coords=new Array,dataAttrs.coordsFull=new Array,dataAttrs.fimsData=new Array,p=new Object,toastStatusMessage("Please wait, parsing your data"),$("#data-parsing").removeAttr("indeterminate");try{p$("#data-parsing").max=C}catch(a){}y=Date.now(),M=new Array,n=new Array;for(x in a){B=a[x],H=new Object,L=new Array;for(g in B){if(N=B[g],g=g.trim(),indexOf.call(L,g)>=0)return console.error("There was a duplicate column '"+g+"'",L),stopLoadBarsError(null,"You have at least one duplicate column '"+g+"'. Ensure all your columns are unique."),!1;switch(F=!1,g){case"ContactName":case"basisOfRecord":case"occurrenceID":case"institutionCode":case"collectionCode":case"labNumber":case"originalsource":case"datum":case"georeferenceSource":case"depth":case"Collector2":case"Collector3":case"verbatimLocality":case"Habitat":case"Test_Method":case"eventRemarks":case"quantityDetected":case"dilutionFactor":case"cycleTimeFirstDetection":if("string"==typeof N)try{N=N.replace(/;/gim,"&#59;"),N=N.replace(/'/gim,"&#39;"),N=N.replace(/"/gim,"&#34;")}catch(a){console.warn("Couldn't replace quotes for this:",N)}p[g]=N,F=!0;break;case"specimenDisposition":g="sampleDisposition";break;case"sampleType":g="sampleMethod";break;case"elevation":g="alt";break;case"dateCollected":case"dateIdentified":if(g="dateIdentified",G=excelDateToUnixTime(N,!0),!isNumber(G))return console.error("This row (#"+x+") has a non-date value ! ("+N+" = "+G+")"),stopLoadBarsError(null,"Detected an invalid date '"+N+"' at row #"+x+". Check your dates!"),!1;if(k=new Date(G),K=new Date("1868-03-23"),G<K.getTime())return console.error("This row (#"+x+") has a date ("+N+" = "+G+") too far in the past!"),stopLoadBarsError(null,"Detected an implausibly old date '"+N+"' = <code>"+k.toDateString()+"</code> at row #"+x+". Check your dates!"),!1;if(G>Date.now())return console.error("This row (#"+x+") has a date ("+N+" = "+G+") after today!"),stopLoadBarsError(null,"Detected a future date '"+N+"' at row #"+x+". Check your dates!"),!1;m=k.getUTCDate(),m<10&&(m="0"+m),w=k.getUTCMonth()+1,w<10&&(w="0"+w),f=k.getUTCFullYear()+"-"+w+"-"+m;break;case"fatal":f=N.toBool();break;case"decimalLatitude":case"decimalLongitude":case"alt":case"coordinateUncertaintyInMeters":if(!isNumber(N))return stopLoadBarsError(null,"Detected an invalid number for "+g+" at row "+x+" ('"+N+"')"),!1;if("decimalLatitude"===g&&-90>N&&N>90)return stopLoadBarsError(null,"Detected an invalid latitude "+N+" at row "+x),!1;if("decimalLongitude"===g&&-180>N&&N>180)return stopLoadBarsError(null,"Detected an invalid longitude "+N+" at row "+x),!1;if("coordinateUncertaintyInMeters"===g&&N<=0)return stopLoadBarsError(null,"Coordinate uncertainty must be >= 0 at row "+x),!1;f=toFloat(N);break;case"diseaseDetected":if(isBool(N))f=N.toBool();else try{f="negative"!==N.trim().toLowerCase()&&("positive"===N.trim().toLowerCase()||"NO_CONFIDENCE")}catch(a){f="NO_CONFIDENCE"}break;case"sex":try{N=N.trim().toLowerCase(),N="m"===N.slice(0,1)?"male":"f"===N.slice(0,1)?"female":"not determined"}catch(a){N="not determined"}break;case"sampleId":try{J=N.trim(),"n/a"===J.toLowerCase()&&(J=""),J=J.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2"),f=J}catch(a){f=N}indexOf.call(M,f)<0?M.push(f):indexOf.call(n,f)<0&&n.push(f);break;default:try{f=N.trim()}catch(a){f=N}}F||(H[g]=f)}h={lat:H.decimalLatitude,lng:H.decimalLongitude,alt:H.alt,uncertainty:H.coordinateUncertaintyMeters},i=new Point(h.lat,h.lng),dataAttrs.coords.push(i),dataAttrs.coordsFull.push(h),dataAttrs.fimsData.push(p);try{H.fimsExtra=JSON.stringify(p)}catch(a){console.warn("Couldn't store FIMS extra data",p)}z[x]=H,0===modulo(x,500)&&x>0&&(toastStatusMessage("Processed "+x+" rows ..."),console.log("Processed "+x+" rows ..."));try{p$("#data-parsing").value=x+1}catch(a){}}try{console.log("Basic validation passed"),isNull(n)||bsAlert("<strong>Warning</strong>: the following field IDs all had duplicates:<br/><code>"+n+"</code></br>We <strong>strongly</strong> recommend unique IDs.","warning")}catch(a){}isNull(_adp.projectIdentifierString)?(A="t"+md5(p$("#project-title").value+d+Date.now()),_adp.projectIdentifierString=A):A=_adp.projectIdentifierString;try{j={downloadFile:"cleaned-dataset-"+Date.now()+".csv",selector:"#download-server-parsed-data"},downloadCSVFile(z,j)}catch(a){}q=function(){var a,b,c,d,e,f,g;for(b=0,c=new Object,f=sortPoints(dataAttrs.coords),g="",d=0,e=f.length;d<e;d++)a=f[d],c[b]=[a.lat,a.lng],g+=a.lat+","+a.lng+"\n",++b;try{p$("#transect-input-toggle").checked=!0,g+="\n",$(p$("#coord-input").textarea).val(g)}catch(a){}return c},null==geo.boundingBox&&(geo.boundingBox=q()),e=getMapCenter(geo.boundingBox),geo.reverseGeocode(e.lat,e.lng,geo.boundingBox,function(a){_adp.locality=a,dataAttrs.locality=a;try{return p$("#locality-input").value=a,p$("#locality-input").readonly=!0}catch(a){}}),E={mortality:0,morbidity:0,positive:0,negative:0,no_confidence:0};for(r in z){switch(l=z[r],l.diseaseDetected){case!0:E.morbidity++,E.positive++;break;case!1:E.negative++;break;case"NO_CONFIDENCE":E.no_confidence++}l.fatal&&E.mortality++}try{p$("#positive-samples").value=E.positive,p$("#negative-samples").value=E.negative,p$("#no_confidence-samples").value=E.no_confidence,p$("#morbidity-count").value=E.morbidity,p$("#mortality-count").value=E.mortality}catch(a){}isNull(_adp.projectId)&&(d=$.cookie(adminParams.domain+"_link"),_adp.projectId=md5(""+A+d+Date.now())),I={transectRing:geo.boundingBox,data:z,samples:E,dataSrc:""+helperDir+dataFileParams.filePath},null==("undefined"!=typeof _adp&&null!==_adp?_adp.data:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp=new Object),window._adp.data=new Object),_adp.data.pushDataUpload=I,validateData(I,function(a){var d,e,f,g,h,i,k,l,m,n,o,p,q;for(p="",o=new Array,d=new Array,f=0,l=a.validated_taxa,g=0,h=l.length;g<h;g++){n=l[g],q=n.genus+" "+n.species,null!=n.response.original_taxon&&(console.info("Taxon obj",n),k=""+n.response.original_taxon.slice(0,1).toUpperCase()+n.response.original_taxon.slice(1),i='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+k+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+q+"</em>' below. <a href=\""+n.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(i)),isNull(n.subspecies)||(q+=" "+n.subspecies),indexOf.call(o,q)<0&&(f>0&&(p+="\n"),p+=""+q,o.push(q));try{m=n.response.validated_taxon.family,indexOf.call(d,m)<0&&d.push(n.response.validated_taxon.family)}catch(a){e=a,console.warn("Couldn't get the family! "+e.message,n.response),console.warn(e.stack)}++f}try{p$("#species-list").bindValue=p}catch(a){}if(dataAttrs.dataObj=a,_adp.data.dataObj=a,_adp.data.taxa=new Object,_adp.data.taxa.list=o,_adp.data.taxa.clades=d,_adp.data.taxa.validated=a.validated_taxa,"function"!=typeof b&&b!==!0){try{j={downloadFile:"cleaned-dataset-"+Date.now()+".csv",selector:"#download-server-parsed-data"},downloadCSVFile(a,j)}catch(a){}return geo.requestCartoUpload(a,A,"create",function(a,b,d){return createMap2(b,d,function(){if(window.mapBuilder.points=new Array,$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length),"function"==typeof c)return c(a,b)})})}return"function"==typeof b?b(a,A):console.warn("Carto upload was skipped, but no callback provided")})}catch(a){o=a,console.error("Error parsing data - "+o.message),console.warn(o.stack),s='There was a problem parsing your data. Please check <a href="http://biscicol.org/biocode-fims/templates.jsp" class="newwindow alert-link" data-newtab="true">biscicol.org FIMS requirements<span class="glyphicon glyphicon-new-window"></span></a>',stopLoadBarsError(null,s)}return!1},excelDateToUnixTime=function(a,b){var c,d,e,f,g,h,i,j;null==b&&(b=!1),f=1863,c=new Date,j=c.getUTCFullYear();try{if(!isNumber(a))throw"Bad date error";if(f<=a&&a<=j)g=a+"-01-03",i=Date.parse(g);else if(0<a&&a<1e6){if(d=25569,e=24107,h=86400,i=(a-d)*h*1e3,!isNumber(i))throw console.warn("excelDateToUnixTime got bad number: "+a+" -> "+i),"Bad Number Error"}else i=Date.parse(a)}catch(a){i=!b&&Date.now()}return i},renderValidateProgress=function(a,b){var c;return null==a&&(a="#file-uploader-form"),null==b&&(b=!1),c='<div id="validator-progress-container" class="col-md-6 col-xs-12">\n  <label for="data-parsing">Data Parsing:</label><paper-progress id="data-parsing" class="blue" indeterminate></paper-progress>\n  <label for="data-validation">Data Validation:</label><paper-progress id="data-validation" class="cyan" indeterminate></paper-progress>\n  <label for="taxa-validation">Taxa Validation:</label><paper-progress id="taxa-validation" class="teal" indeterminate></paper-progress>\n  <label for="data-sync">Estimated Data Sync Progress:</label><paper-progress id="data-sync" indeterminate></paper-progress>\n  <br/><br/>\n  <button class="btn btn-danger" id="cancel-new-upload"><iron-icon icon="icons:cancel"></iron-icon> Cancel</button>\n</div>',
$("#validator-progress-container").exists()||($(a).after(c),$("#cancel-new-upload").click(function(){return cancelAsyncOperation(this)})),!!b&&c},checkInitLoad=function(a){var b,c,d;if($("#please-wait-prefill").remove(),d=uri.o.param("id"),isNull(d))if(b="string"==typeof a?a:"object"==typeof a?a.do+":"+a.prop:uri.o.attr("fragment"),isNull(b))"function"==typeof a&&a();else switch(c=b.split(":"),console.info("Looking at fragment",b,c),c[0]){case"edit":loadEditor(c[1]);break;case"action":switch(c[1]){case"show-editable":loadEditor();break;case"create-project":loadCreateNewProject();break;case"show-viewable":loadProjectBrowser();break;case"show-su-viewable":loadSUProjectBrowser();break;case"show-su-profiles":loadSUProfileBrowser()}break;case"home":populateAdminActions()}else loadEditor(d);return!1},window.onpopstate=function(a){return console.log("State popped",a,a.state),checkInitLoad(a.state),!1},$(function(){$("#next").exists()&&$("#next").unbind().click(function(){return openTab(adminParams.adminPageUrl)}),loadJS("bower_components/bootstrap/dist/js/bootstrap.min.js",function(){return $("body").tooltip({selector:"[data-toggle='tooltip']"})}),checkFileVersion(!1,"js/admin.min.js"),$("paper-icon-button[icon='icons:dashboard']").removeAttr("data-href").unbind("click").click(function(){return populateAdminActions()});try{return checkFileVersion(!0,"js/kml.min.js")}catch(a){}}),kmlLoader=function(a,b){var c,d,e,f,g,h;try{if("object"==typeof a)e=a,a=e.path;else try{e=JSON.parse(a),a=e.path}catch(b){try{e=JSON.parse(deEscape(a)),a=e.path}catch(b){a.length>511&&(g=fixTruncatedJson(a),"object"==typeof g&&(e=g,a=e.path)),isNull(e)&&(e={path:a})}}console.debug("Loading KML file",a)}catch(a){}if(geo.inhibitKMLInit=!0,d=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(h=_adp.lastMod)?h.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),!$("google-map").exists()){if(c='<google-map id="transect-viewport" class="col-xs-12 col-md-9 col-lg-6 kml-lazy-map" api-key="'+gMapsApiKey+'" map-type="hybrid">\n</google-map>',f='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+c+"\n</div>",!$("#auth-block").exists())return console.warn("Couldn't find an authorization block to render the KML map in!"),!1;$("#auth-block").append(f),_adp.mapRendered=!0}return loadJS(d,function(){return initializeParser(null,function(){return loadKML(a,function(){var c,d;try{if(d=geo.kml.parser.docsByUrl[a],isNull(d)&&(a="/"+a,d=geo.kml.parser.docsByUrl[a],isNull(d)&&(console.warn("Could not resolve KML by url, using first doc"),d=geo.kml.parser.docs[0])),isNull(d))return allError("Bad KML provided"),!1;console.debug("Using parsed data from path '"+a+"'",d),"function"==typeof b?b(d):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(a){c=a,allError("There was a importing the data from this KML file"),console.warn(c.message),console.warn(c.stack)}return!1}),!1}),!1}),!1},loadEditor=function(a){var b,c;return startAdminActionHelper(),b=function(a){var b,d;return startAdminActionHelper(),d=uri.urlString+"admin-page.html#edit:"+a,b={do:"edit",prop:a},history.pushState(b,"Editing #"+a,d),startLoad(),window.projectParams=new Object,window.projectParams.pid=a,verifyLoginCredentials(function(b){var d,e,f;return f=b.detail,user=f.uid,e=a,a=encodeURIComponent(a),d="perform=get&project="+a,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,d,"json").done(function(b){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da,ea,fa,ga;try{if(console.info("Server said",b),b.status!==!0)return u=null!=(T=b.human_error)?T:b.error,null==u&&(u="Unidentified Error"),stopLoadError("There was a problem loading your project ("+u+")"),console.error("Couldn't load project! (POST OK) Error: "+b.error),console.warn("Attempted",adminParams.apiTarget+"?"+d),!1;if(b.user.has_edit_permissions!==!0)return b.user.has_view_permissions||b.project.public.toBool()===!0?(loadProject(e,"Ineligible to edit "+e+", loading as read-only"),delay(1e3,function(){return loadProject(a)}),!1):(alertBadProject(e),!1);for(R=b.project,R.access_data.total=Object.toArray(R.access_data.total),R.access_data.total.sort(),R.access_data.editors_list=Object.toArray(R.access_data.editors_list),R.access_data.viewers_list=Object.toArray(R.access_data.viewers_list),R.access_data.editors=Object.toArray(R.access_data.editors),R.access_data.viewers=Object.toArray(R.access_data.viewers),console.info("Project access lists:",R.access_data),_adp.projectData=R,_adp.originalProjectId=R.project_id,_adp.fetchResult=b,ca="",y=new Array,U=R.access_data.total,C=0,D=U.length;C<D;C++){user=U[C];try{if(ba=R.access_data.composite[user].user_id,indexOf.call(y,ba)>=0)continue;y.push(ba)}catch(a){}B="",user===R.access_data.author?B='<iron-icon icon="social:person"></iron-icon>':indexOf.call(R.access_data.editors_list,user)>=0?B='<iron-icon icon="image:edit"></iron-icon>':indexOf.call(R.access_data.viewers_list,user)>=0&&(B='<iron-icon icon="icons:visibility"></iron-icon>'),ca+='<tr class="user-permission-list-row" data-user="'+ba+'">\n  <td colspan="5">'+user+'</td>\n  <td class="text-center user-current-permission">'+B+"</td>\n</tr>"}B=R.public.toBool()?'<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>':'<iron-icon icon="icons:lock" class="material-red" data-toggle="tooltip" title="Private Project"></iron-icon>',S=R.public.toBool()?"<!-- This project is already public -->":b.user.is_author?'<div class="col-xs-12">\n  <paper-toggle-button id="public" class="project-params danger-toggle red">\n    <iron-icon icon="icons:warning"></iron-icon>\n    Make this project public\n  </paper-toggle-button> <span class="text-muted small">Once saved, this cannot be undone</span>\n</div>':"<!-- This user does not have permission to toggle the public state of this project -->",n=b.user.has_edit_permissions?"":"readonly",g=R.includes_anura.toBool()?"checked disabled":"disabled",k=R.includes_caudata.toBool()?"checked disabled":"disabled",x=R.includes_gymnophiona.toBool()?"checked disabled":"disabled";try{j=JSON.parse(deEscape(R.carto_id))}catch(a){console.error("Couldn't parse the carto JSON!",R.carto_id),stopLoadError("We couldn't parse your data. Please try again later."),j=new Object}H="";try{i=Object.toArray(j.bounding_polygon)}catch(a){i=null}o={boundingBox:i,classes:"carto-data map-editor",bsGrid:"",skipPoints:!1,skipHull:!1,onlyOne:!0},geo.mapOptions=o,null==(null!=(V=j.bounding_polygon)?V.paths:void 0)&&(w='<google-map id="transect-viewport" latitude="'+R.lat+'" longitude="'+R.lng+'" fit-to-markers map-type="hybrid" disable-default-ui  api-key="'+gMapsApiKey+'">\n</google-map>'),null==w&&(w=""),geo.googleMapWebComponent=w,s=b.user.is_author?'<div class="card-actions">\n      <paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>\n    </div>':"",J=isNull(R.sample_notes)?"*No notes for this project*":R.sample_notes.unescape(),O='<h3>Project Notes</h3>\n<ul class="nav nav-tabs" id="markdown-switcher">\n  <li role="presentation" class="active" data-view="md"><a>Preview</a></li>\n  <li role="presentation" data-view="edit"><a>Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-notes" class="markdown-pair project-param language-markdown" rows="3" data-field="sample_notes" hidden '+n+">"+R.sample_notes+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="note-preview">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+J+"</script>\n</marked-element>",I=isNull(R.extended_funding_reach_goals)?"*No funding reach goals*":R.extended_funding_reach_goals.unescape(),v='<ul class="nav nav-tabs" id="markdown-switcher-funding">\n  <li role="presentation" class="active" data-view="md"><a>Preview</a></li>\n  <li role="presentation" data-view="edit"><a>Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-funding" class="markdown-pair project-param language-markdown" rows="3" data-field="extended_funding_reach_goals" hidden '+n+">"+R.extended_funding_reach_goals+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="preview-funding">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+I+"</script>\n</marked-element>";try{h=JSON.parse(R.author_data),p=new Date(toInt(h.entry_date))}catch(a){h=new Object,p=new Object,p.toLocaleString=function(){return"Error retrieving creation time"}}for(L="",M=R.sampling_months.split(","),N=new Array,A=0,G=0,E=M.length;G<E;G++)K=M[G],++A,A>1&&A===M.length?(M.length>2&&(L+=","),L+=" and "):A>1&&(L+=", "),isNumber(K)&&(N.push(K),K=dateMonthToString(K)),L+=K;for(A=0,ea="",fa=R.sampling_years.split(","),ga=new Array,A=0,P=0,F=fa.length;P<F;P++)da=fa[P],++A,isNumber(da)&&(ga.push(toInt(da)),A>1&&A===fa.length?(ga.length>2&&(ea+=","),ea+=" and "):A>1&&(ea+=", "),ea+=da);ea=1===fa.length?"the year "+ea:"the years "+ea,fa=ga,0!==toInt(R.sampled_collection_start)?(q=new Date(toInt(R.sampled_collection_start)),r=new Date(toInt(R.sampled_collection_end)),m=dateMonthToString(q.getMonth())+" "+q.getFullYear()+" &#8212; "+dateMonthToString(r.getMonth())+" "+r.getFullYear()):m="<em>(no data)</em>",(0===M.length||isNull(L))&&(L="<em>(no data)</em>"),(0===fa.length||isNull(ea))&&(ea="<em>(no data)</em>"),_=null!=(null!=j&&null!=(W=j.raw_data)?W.filePath:void 0)?"":"checked disabled",isNull(R.technical_contact)&&(R.technical_contact=h.name),isNull(R.technical_contact_email)&&(R.technical_contact_email=h.contact_email),z='<h2 class="clearfix newtitle col-xs-12">'+R.project_title+" "+B+' <paper-icon-button icon="icons:visibility" class="click" data-href="'+uri.urlString+"project.php?id="+e+'" data-toggle="tooltip" title="View in Project Viewer" data-newtab="true"></paper-icon-button><br/><small>Project #'+e+"</small></h2>\n"+S+'\n<section id="manage-users" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Collaborators" elevation="2">\n    <div class="card-content">\n      <table class="table table-striped table-condensed table-responsive table-hover clearfix" id="permissions-table">\n        <thead>\n          <tr>\n            <td colspan="5">User</td>\n            <td>Permissions</td>\n          </tr>\n        </thead>\n        <tbody>\n          '+ca+'\n        </tbody>\n      </table>\n    </div>\n    <div class="card-actions">\n      <paper-button class="manage-users" id="manage-users-button">Manage Users</paper-button>\n    </div>\n  </paper-card>\n</section>\n<section id="project-basics" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Basics</h3>\n  <paper-input readonly label="Project Identifier" value="'+R.project_id+'" id="project_id" class="project-param"></paper-input>\n  <paper-input readonly label="Project Creation" value="'+p.toLocaleString()+'" id="project_creation" class="author-param" data-key="entry_date" data-value="'+h.entry_date+'"></paper-input>\n  <div class="row">\n    <paper-input readonly label="Project ARK" value="'+R.project_obj_id+'" id="project_creation" class="project-param col-xs-11"></paper-input>\n    '+getInfoTooltip("ARK or Archival Resource Key identifier is a persistent, citable identifier for this project and maybe used to cite these data in a publication or report. We use the California Digital Library Name Assigning Authority")+"\n  </div>\n  <paper-input "+n+' class="project-param" label="Project Title" value="'+R.project_title+'" id="project-title" data-field="project_title"></paper-input>\n  <paper-input '+n+' class="project-param" label="Primary Pathogen" value="'+R.disease+'" data-field="disease"></paper-input>\n  <paper-input '+n+' class="project-param" label="PI Lab" value="'+R.pi_lab+'" id="project-title" data-field="pi_lab"></paper-input>\n  <paper-input '+n+' class="project-param" label="Project Reference" value="'+R.reference_id+'" id="project-reference" data-field="reference_id"></paper-input>\n  <div class="row">\n    <paper-input '+n+' class="project-param col-xs-11" label="Publication DOI" value="'+R.publication+'" id="doi" data-field="publication"></paper-input>\n    '+getInfoTooltip("Publication DOI citing these datasets may be added here.")+"\n  </div>\n  <paper-input "+n+' class="author-param" data-key="name" label="Project Contact" value="'+h.name+'" id="project-contact"></paper-input>\n  <gold-email-input '+n+' class="author-param" data-key="contact_email" label="Contact Email" value="'+h.contact_email+'" id="contact-email"></gold-email-input>\n  <paper-input '+n+' class="author-param" data-key="diagnostic_lab" label="Diagnostic Lab" value="'+h.diagnostic_lab+'" id="project-lab"></paper-input>\n  <paper-input '+n+' class="author-param" data-key="affiliation" label="Affiliation" value="'+h.affiliation+'" id="project-affiliation"></paper-input>\n  <paper-input '+n+' class="project-param" label="Technical/Data Contact" value="'+R.technical_contact+'" data-field="technical_contact" id="technical-contact"></paper-input>\n  <gold-email-input '+n+' class="project-param" label="Technical/Data Contact_email" value="'+R.technical_contact_email+'" data-field="technical_contact_email" id="technical-contact-email"></gold-email-input>\n</section>\n<section id="notes" class="col-xs-12 col-md-8 clearfix">\n  '+O+'\n</section>\n<section id="data-management" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Data" elevation="2" id="data-card">\n    <div class="card-content">\n      <div class="variable-card-content">\n      Your project does/does not have data associated with it. (Does should note overwrite, and link to cartoParsed.raw_data.filePath for current)\n      </div>\n      <div id="append-replace-data-toggle">\n        <span class="toggle-off-label iron-label">Append/Amend Data\n          <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload a dataset, append all rows as additional data, and modify existing ones by sampleId"></span>\n        </span>\n        <paper-toggle-button id="replace-data-toggle" class="material-red" '+_+'>Replace Data</paper-toggle-button>\n        <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload data, archive current data and only have new data parsed"></span>\n      </div>\n      <div id="uploader-container-section">\n      </div>\n    </div>\n  </paper-card>\n  <paper-card class="clearfix" heading="Project Status" elevation="2" id="save-card">\n    <div class="card-content">\n      <p>Notice if there\'s unsaved data or not. Buttons below should dynamically disable/enable based on appropriate state.</p>\n    </div>\n    <div class="card-actions">\n      <paper-button id="save-project"><iron-icon icon="icons:save" class="material-green"></iron-icon> Save Project</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="reparse-project"><iron-icon icon="icons:cached" class="materialindigotext"></iron-icon> Re-parse Data, Save Project &amp; Reload</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="discard-changes-exit"><iron-icon icon="icons:undo"></iron-icon> Discard Changes &amp; Exit</paper-button>\n    </div>\n    '+s+'\n  </paper-card>\n</section>\n<section id="project-data" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Data Overview</h3>\n    <h4>Project Studies:</h4>\n      <paper-checkbox '+g+">Anura</paper-checkbox>\n      <paper-checkbox "+k+">Caudata</paper-checkbox>\n      <paper-checkbox "+x+'>Gymnophiona</paper-checkbox>\n      <paper-input readonly label="Sampled Species" value="'+R.sampled_species.split(",").sort().join(", ")+'"></paper-input>\n      <paper-input readonly label="Sampled Clades" value="'+R.sampled_clades.split(",").sort().join(", ")+'"></paper-input>\n      <p class="text-muted">\n        <span class="glyphicon glyphicon-info-sign"></span> There are '+R.sampled_species.split(",").length+" species in this dataset, across "+R.sampled_clades.split(",").length+' clades\n      </p>\n    <h4>Sample Metrics</h4>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken from '+m+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken in '+L+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were sampled in '+ea+'</p>\n      <p class="text-muted"><iron-icon icon="icons:language"></iron-icon> The effective project center is at ('+roundNumberSigfig(R.lat,6)+", "+roundNumberSigfig(R.lng,6)+") with a sample radius of "+R.radius+"m and a resulting locality <strong class='locality'>"+R.locality+'</strong></p>\n      <p class="text-muted"><iron-icon icon="editor:insert-chart"></iron-icon> The dataset contains '+R.disease_positive+" positive samples ("+roundNumber(100*R.disease_positive/R.disease_samples)+"%), "+R.disease_negative+" negative samples ("+roundNumber(100*R.disease_negative/R.disease_samples)+"%), and "+R.disease_no_confidence+" inconclusive samples ("+roundNumber(100*R.disease_no_confidence/R.disease_samples)+'%)</p>\n    <h4 id="map-header">Locality &amp; Transect Data</h4>\n      <div id="carto-map-container" class="clearfix">\n      '+w+"\n      </div>\n  <h3>Project Meta Parameters</h3>\n    <h4>Project funding status</h4>\n      "+v+'\n      <div class="row markdown-pair" id="preview-funding">\n        <span class="pull-left" style="margin-top:1.75em;vertical-align:bottom;padding-left:15px">$</span><paper-input '+n+' class="project-param col-xs-11" label="Additional Funding Request" value="'+R.more_analysis_funding_request+'" id="more-analysis-funding" data-field="more_analysis_funding_request" type="number"></paper-input>\n      </div>\n</section>',$("#main-body").html(z),$(".pull-right paper-card .header").click(function(){return console.info("Clicked header, triggering collapse"),$(this).parent().toggleClass("collapsed")}),null!=(null!=(X=j.bounding_polygon)?X.paths:void 0)&&(l=new Point(R.lat,R.lng),geo.centerPoint=l,geo.mapOptions=o,createMap2([l],o,function(a){var b;if(geo.mapOptions.selector=a.selector,!$(a.selector).exists())return(b=function(){return $("#map-header").exists()?($("#map-header").after(a.html),w=a.html):delay(250,function(){return b()})})()}),Q=j.bounding_polygon,w=null!=(Y=geo.googleMapWebComponent)?Y:"");try{p$("#project-notes").bindValue=R.sample_notes.unescape()}catch(a){}try{p$("#project-funding").bindValue=R.extended_funding_reach_goals.unescape()}catch(a){}return isNull(R.transect_file)||kmlLoader(R.transect_file,function(){return console.debug("Editor loaded KML file")}),Z=p$("#project-notes").textarea,$(Z).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),$("#markdown-switcher li").click(function(){var a;switch($("#markdown-switcher li").removeClass("active"),$("#markdown-switcher").parent().find(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),a=$(this).attr("data-view"),console.info("Switching to target view",a),a){case"md":$("#project-notes").attr("hidden","hidden");break;case"edit":$("#note-preview").attr("hidden","hidden")}return!1}),Z=p$("#project-funding").textarea,$(Z).keyup(function(){return p$("#preview-funding").markdown=$(this).val()}),$("#markdown-switcher-funding li").click(function(){var a;switch($("#markdown-switcher-funding li").removeClass("active"),$("#markdown-switcher-funding").parent().find(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),a=$(this).attr("data-view"),console.info("Switching to target view",a),a){case"md":$("#project-funding").attr("hidden","hidden");break;case"edit":$("#preview-funding").attr("hidden","hidden")}return!1}),$("#delete-project").click(function(){var a;return a='<paper-button id="confirm-delete-project" class="materialred">\n  <iron-icon icon="icons:warning"></iron-icon> Confirm Project Deletion\n</paper-button>',$(this).replaceWith(a),$("#confirm-delete-project").click(function(){var a;return startLoad(),a=this,d="perform=delete&id="+R.id,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,d,"json").done(function(b){return b.status===!0?(stopLoad(),toastStatusMessage("Successfully deleted Project #"+R.project_id),delay(1e3,function(){return populateAdminActions()})):(stopLoadError(b.human_error),$(a).remove())}).fail(function(a,b){return console.error("Server error",a,b),stopLoadError("Error deleting project")}),!1}),!1}),$("#save-project").click(function(){var a;return $("#confirm-delete-project").exists()&&(a='<paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>',$("#confirm-delete-project").replaceWith(a)),saveEditorData(!0),!1}),$("#discard-changes-exit").click(function(){return c(),!1}),$("#reparse-project").click(function(){try{recalculateAndUpdateHull()}catch(a){}return revalidateAndUpdateData(),!1}),aa=$("#data-management").offset().top,f={top:aa,bottom:0,target:window},$("paper-button#manage-users-button").click(function(){return popManageUserAccess(_adp.projectData)}),$(".danger-toggle").on("iron-change",function(){return $(this).get(0).checked?$(this).find("iron-icon").addClass("material-red"):$(this).find("iron-icon").removeClass("material-red")}),isNull(R.carto_id)?(console.warn("There is no carto data to load up for the editor"),startEditorUploader()):(console.info("Getting carto data with id "+R.carto_id+" and options",o),getProjectCartoData(R.carto_id,o))}catch(a){return t=a,stopLoadError("There was an error loading your project"),console.error("Unhandled exception loading project! "+t.message),console.warn(t.stack),loadEditor(),!1}}).fail(function(a,b){return console.error("AJAX failure: Error from server",a,b),stopLoadError("We couldn't load your project. Please try again."),loadEditor()})}),!1},null==a?(c=function(){var a,c,d;return d=uri.urlString+"admin-page.html#action:show-editable",c={do:"action",prop:"show-editable"},history.pushState(c,"Viewing Editable Projects",d),startLoad(),a="perform=list",$.get(adminParams.apiTarget,a,"json").done(function(a){var c,d,e,f,g,h,i,j,k,l,m;g='<h2 class="new-title col-xs-12">Editable Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(g),k=Object.toArray(a.public_projects),d=Object.toArray(a.authored_projects),e=Object.toArray(a.editable_projects),m=new Array,f=!1,l=a.projects;for(i in l)j=l[i],c=indexOf.call(k,i)>=0?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',h=indexOf.call(d,i)>=0?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author"></iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator"></iron-icon>',indexOf.call(e,i)>=0?(g='<li>\n  <button class="btn btn-primary" data-project="'+i+'">\n    '+c+" "+j+" / #"+i.substring(0,8)+"\n  </button>\n  "+h+"\n</li>",$("#project-list").append(g),f=!0):m.push(i);if(console.info("Didn't display read-only projects",m),!f){g='<p class="text-muted col-xs-12" id="no-edits-available">\n  Sorry, you have no projects you\'re eligible to edit.\n</p>',$("#project-list").before(g);try{verifyLoginCredentials(function(a){var b;if(b=toInt(a.detail.userdata.su_flag),b.toBool())return console.info("NOTICE: This is an SUPERUSER Admin"),g='<button class="btn btn-xs btn-primary" id="su-view-projects">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:add"></iron-icon>\n  (SU) Administrate All Projects\n</button>',$("#no-edits-available").append(g),$("#su-view-projects").click(function(){return loadSUProjectBrowser()})})}catch(a){}}return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),b(a)}),stopLoad()}).fail(function(a,b){return stopLoadError("There was a problem loading viable projects")})})():b(a),!1},popManageUserAccess=function(a,b){return null==a&&(a=_adp.projectData),null==b&&(b=_adp.fetchResult),verifyLoginCredentials(function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(console.info("Working with",b,c,a),r="",i=new Array,o=a.access_data.total,m=0,n=o.length;m<n;m++)user=o[m],q=a.access_data.composite[user].user_id,indexOf.call(i,q)>=0||(i.push(q),p=user+" <span class='set-permission-block' data-user='"+q+"'>",j=user===a.access_data.author,k=indexOf.call(a.access_data.editors_list,user)>=0,l=!k,h=k||j?"disabled":"data-toggle='tooltip' title='Make Editor'",s=l||j?"disabled":"data-toggle='tooltip' title='Make Read-Only'",d=j?"disabled":"data-toggle='tooltip' title='Grant Ownership'",f=j?"author":k?"edit":"read",e="data-current='"+f+"'",p+='<paper-icon-button icon="image:edit" '+h+' class="set-permission" data-permission="edit" data-user="'+q+'" '+e+'> </paper-icon-button>\n<paper-icon-button icon="icons:visibility" '+s+' class="set-permission" data-permission="read" data-user="'+q+'" '+e+"> </paper-icon-button>",b.user.is_author&&(p+='<paper-icon-button icon="social:person" '+d+' class="set-permission" data-permission="author" data-user="'+q+'" '+e+"> </paper-icon-button>"),b.user.has_edit_permissions&&!j&&q!==b.user.user&&(p+='<paper-icon-button icon="icons:delete" class="set-permission" data-permission="delete" data-user="'+q+'" '+e+">\n</paper-icon-button>"),r+="<li>"+p+"</span></li>");return r='<ul class="simple-list">\n  '+r+"\n</ul>",1===a.access_data.total.length&&(r+='<div id="single-user-warning">\n  <iron-icon icon="icons:warning"></iron-icon> <strong>Head\'s-up</strong>: You can\'t change permissions when a project only has one user. Consider adding another user first.\n</div>'),g='<paper-dialog modal id="user-setter-dialog">\n  <h2>Manage "'+a.project_title+'" users</h2>\n  <paper-dialog-scrollable>\n    '+r+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button class="add-user" dialog-confirm><iron-icon icon="social:group-add"></iron-icon> Add Users</paper-button>\n    <paper-button class="close-dialog" dialog-dismiss>Done</paper-button>\n  </div>\n</paper-dialog>',$("#user-setter-dialog").remove(),$("body").append(g),userEmail=user,$(".set-permission").unbind().click(function(){var a,b,c,d,e,f,g;if(user=$(this).attr("data-user"),f=$(this).attr("data-permission"),c=$(this).attr("data-current"),d=this,"delete"!==f)g={changes:{0:{newRole:f,currentRole:c,uid:user}}};else{try{b=$(this).attr("data-confirm").toBool()}catch(a){b=!1}if(!b)return $(this).addClass("extreme-danger").attr("data-confirm","true"),!1;g={delete:{0:{currentRole:c,uid:user}}}}return startLoad(),e=jsonTo64(g),a="perform=editaccess&project="+window.projectParams.pid+"&deltas="+e,console.log("Would push args to",""+uri.urlString+adminParams.apiTarget+"?"+a),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,a,"json").done(function(a){var b,d,e,g,h,i,j,k,l;if(console.log("Server permissions alter said",a),a.status!==!0)return b=null!=(g=null!=(h=a.human_error)?h:a.error)?g:"We couldn't update user permissions",stopLoadError(b),!1;if("delete"!==f)$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+f+"']").attr("disabled","disabled").attr("data-current",f),$(".set-permission-block[data-user='"+user+"'] paper-icon-button:not([data-permission='"+f+"'])").removeAttr("disabled"),k=$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+f+"']").attr("icon"),$(".user-permission-list-row[data-user='"+{user:user}+"'] .user-current-permission iron-icon").attr("icon",k),toastStatusMessage(user+" granted "+f+" permissions");else{$(".set-permission-block[data-user='"+user+"']").parent().remove(),$(".user-permission-list-row[data-user='"+{user:user}+"']").remove(),toastStatusMessage("Removed "+user+" from project #"+window.projectParams.pid),e="read"===c?"viewers":"editors",delete _adp.projectData.access_data.composite[userEmail],i=_adp.projectData.access_data[e+"_list"];for(d in i){l=i[d];try{if("object"!=typeof l)continue;l.user_id===user&&delete _adp.projectData.access_data[e+"_list"][d]}catch(a){}}j=_adp.projectData.access_data[e];for(d in j){l=j[d];try{if("object"!=typeof l)continue;l.user_id===user&&delete _adp.projectData.access_data[e][d]}catch(a){}}}return _adp.projectData.access_data.raw=a.new_access_saved,stopLoad()}).fail(function(a,b){return console.error("Server error",a,b),stopLoadError("Problem changing permissions")}),!1}),$(".add-user").unbind().click(function(){return showAddUserDialog(a.access_data.total),!1}),safariDialogHelper("#user-setter-dialog"),!1})},showAddUserDialog=function(a){var b;return b='<paper-dialog modal id="add-new-user">\n<h2>Add New User To Project</h2>\n<paper-dialog-scrollable>\n  <p>Search by email, real name, or username below. Click on a search result to queue a user for adding.</p>\n  <div class="form-horizontal" id="search-user-form-container">\n    <div class="form-group">\n      <label for="search-user" class="sr-only form-label">Search User</label>\n      <input type="text" id="search-user" name="search-user" class="form-control"/>\n    </div>\n    <paper-material id="user-search-result-container" class="pop-result" hidden>\n      <div class="result-list">\n      </div>\n    </paper-material>\n  </div>\n  <p>Adding users:</p>\n  <ul class="simple-list" id="user-add-queue">\n    <!--\n      <li class="list-add-users" data-uid="789">\n        jsmith@sample.com\n      </li>\n    -->\n  </ul>\n</paper-dialog-scrollable>\n<div class="buttons">\n  <paper-button id="add-user"><iron-icon icon="social:person-add"></iron-icon> Save Additions</paper-button>\n  <paper-button dialog-dismiss>Cancel</paper-button>\n</div>\n</paper-dialog>',$("#add-new-user").exists()||$("body").append(b),safariDialogHelper("#add-new-user"),$("#search-user").keyup(function(){var b;return console.log("Should search",$(this).val()),b=function(){var b;if(b=$("#search-user").val(),isNull(b))return $("#user-search-result-container").prop("hidden","hidden");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().removeClass("has-success"),$("#search-user").parent().find(".help-block").remove()}catch(a){}return _adp.currentAsyncJqxhr=$.post(uri.urlString+"/api.php","action=search_users&q="+b,"json").done(function(c){var d,e,f,g,h,i,j,k,l;if(console.info(c),l=Object.toArray(c.result),l.length>0){for($("#user-search-result-container").removeAttr("hidden"),h="",i=0,j=l.length;i<j;i++)user=l[i],null!=_adp.projectData.access_data.composite[user.email]?(k='<iron-icon icon="icons:done-all" class="materialgreen round"></iron-icon>',d='<paper-badge for="'+user.uid+'-email" icon="icons:done-all" label="Already Added"> </paper-badge>',e="noclick"):(k="",d="",e=""),h+='<div class="user-search-result '+e+'" data-uid="'+user.uid+'" id="'+user.uid+'-result">\n  <span class="email search-result-detail" id="'+user.uid+'-email">'+k+user.email+'</span>\n    |\n  <span class="name search-result-detail" id="'+user.uid+'-name">'+user.full_name+'</span>\n    |\n  <span class="user search-result-detail" id="'+user.uid+'-handle">'+user.handle+"</span></div>";return $("#user-search-result-container").html(h),$(".user-search-result:not(.noclick)").click(function(){var b,c,d,e,f,g;for(g=$(this).attr("data-uid"),console.info("Clicked on "+g),b=$(this).find(".email").text(),null==("undefined"!=typeof _adp&&null!==_adp?_adp.currentQueueUids:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp=new Object),_adp.currentQueueUids=new Array),f=$("#user-add-queue .list-add-users"),e=0,c=f.length;e<c;e++)user=f[e],_adp.currentQueueUids.push($(user).attr("data-uid"));return indexOf.call(a,b)<0?indexOf.call(_adp.currentQueueUids,g)<0?(d='<li class="list-add-users" data-uid="'+g+'">'+b+"</li>",$("#user-add-queue").append(d),$("#search-user").val(""),$("#user-search-result-container").prop("hidden","hidden")):(toastStatusMessage(b+" is already in the addition queue"),!1):(toastStatusMessage(b+" already has access to this project"),!1)})}$("#user-search-result-container").prop("hidden","hidden");
try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().removeClass("has-success"),$("#search-user").parent().find(".help-block").remove()}catch(a){}return f=/^(?:[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/im.test(b)?'<button class="btn btn-xs btn-primary add-listed-user"> Invite Them </button> ':"Finish the email address and we can invite them.",g='<span class="help-block">\n  We couldn\'t find a user matching "'+b+'".\n  '+f+"\n</span>",$("#search-user").after(g),$("#search-user").parent().addClass("has-error"),$(".add-listed-user").click(function(){var a;return startLoad(),a="action=invite&invitee="+b,$.post(uri.urlString+"/admin-api.php",a,"json").done(function(a){var b;a.status!==!0&&(b=function(){switch(a.error){case"INVALID_EMAIL":return a.target+" isn't a valid email";case"ALREADY_REGISTERED":return a.target+" already has an account";default:return console.error(a),"There was a problem sending the email"}}(),stopLoadError(b)),toastStatusMessage("Invitation sent");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().addClass("has-success"),$("#search-user").parent().find(".help-block").text("Invitation Sent to "+a.invited),$("#search-user").val("")}catch(a){}return stopLoad()}).fail(function(){return stopLoadError("Failed to contact the server")}),!1})}).fail(function(a,b){return console.error(a,b)})},b.debounce()}),$("#add-user").click(function(){var a,b,c,d,e,f,g,h;for(startLoad(),g=new Array,f=new Array,e=$("#user-add-queue .list-add-users"),c=0,d=e.length;c<d;c++)user=e[c],g.push($(user).attr("data-uid")),f.push(user);return g.length<1?(toastStatusMessage("Please add at least one user to the access list."),!1):(console.info("Saving list of "+g.length+" UIDs to "+window.projectParams.pid,g),b={add:g},h=jsonTo64(b),a="perform=editaccess&project="+window.projectParams.pid+"&deltas="+h,console.log("Would push args to",adminParams.apiTarget+"?"+a),_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,a,"json").done(function(a){var b,c,d,e,h,i,j,k,l,m,n,o;if(console.log("Server permissions said",a),a.status!==!0)return b=null!=(j=null!=(k=a.human_error)?k:a.error)?j:"We couldn't update user permissions",stopLoadError(b),!1;for(stopLoad(),l=1===g.length?"viewer":"viewers",toastStatusMessage("Successfully added "+g.length+" "+l+" to the project"),$("#user-add-queue").empty(),e='<iron-icon icon="icons:visibility"></iron-icon>',d=0,i=0,h=g.length;i<h;i++){m=g[i],user=f[d],console.info("Adding",user),n=$(user).text(),++d,c='<tr class="user-permission-list-row" data-user="'+m+'">\n  <td colspan="5">'+n+'</td>\n  <td class="text-center user-current-permission">'+e+"</td>\n</tr>",$("#permissions-table").append(c),o={email:user,user_id:m,permission:"READ"};try{isArray(_adp.projectData.access_data.total)||(_adp.projectData.access_data.total=Object.toArray(_adp.projectData.access_data.total),_adp.projectData.access_data.viewers_list=Object.toArray(_adp.projectData.access_data.viewers_list),_adp.projectData.access_data.viewers=Object.toArray(_adp.projectData.access_data.viewers))}catch(a){}_adp.projectData.access_data.total.push(user),_adp.projectData.access_data.viewers_list.push(user),_adp.projectData.access_data.viewers.push(o),_adp.projectData.access_data.raw=a.new_access_saved,_adp.projectData.access_data.composite[user]=o}return p$("#add-new-user").close()}).fail(function(a,b){return console.error("Server error",a,b)}))}),!1},getProjectCartoData=function(a,b){var c,d,e,f,g,h,i,j;if("object"!=typeof a)try{d=JSON.parse(deEscape(a))}catch(b){g=b,h=g.message;try{d=JSON.parse(a)}catch(b){if(g=b,a.length>511&&(e=fixTruncatedJson(a),"object"==typeof e&&(console.debug("The carto data object was truncated, but rebuilt."),d=e)),isNull(d))return console.error("cartoObj must be JSON string or obj, given",a),console.warn("Cleaned obj:",deEscape(a)),console.warn("Told",h,g.message),stopLoadError("Couldn't parse data"),!1}}else d=a;f=d.table,console.info("Working with Carto data base set",d);try{j=getMapZoom(d.bounding_polygon.paths,"#transect-viewport"),console.info("Got zoom",j),$("#transect-viewport").attr("zoom",j)}catch(a){}return isNull(f)?(console.warn("There's no assigned table, not pulling carto data"),stopLoad(),startEditorUploader(),!1):(i="SELECT * FROM "+f+" WHERE FALSE",c="action=fetch&sql_query="+post64(i),_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(e){var h,i,j,k,l,m,n,o,p,q,r,s,t;try{q=JSON.parse(e.post_response[0])}catch(a){return g=a,console.error("Couldn't load carto data! ("+g.message+")",e),console.warn("post_response: (want key 0)",e.post_response),console.warn("Base data source:",d),console.warn(g.stack),stopLoadError("There was a problem talking to CartoDB. Please try again later"),startEditorUploader(),!1}l=new Object,r=q.fields;for(p in r)t=r[p],l[p]=t;_adp.activeCols=l,m=new Array,k=new Object;for(j in l)s=l[j],"id"!==j&&"the_geom"!==j&&m.push(j),k[j.toLowerCase()]=j;return _adp.colsList=m,_adp.colRemap=k,i="SELECT "+m.join(",")+", ST_asGeoJSON(the_geom) FROM "+f+";",console.info("Would ping cartodb with",i),h=encodeURIComponent(encode64(i)),c="action=fetch&sql_query="+h,_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(c){var e,f,g,h,i,l,m,n,o,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;if(console.info("Carto query got result:",c),!c.status)return h=null!=(v=c.human_error)?v:c.error,null==h&&(h="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+h+")"),!1;E=c.parsed_responses[0].rows,_adp.cartoRows=new Object;for(l in E){D=E[l],_adp.cartoRows[l]=new Object;for(j in D)I=D[j],u=null!=(w=k[j])?w:j,_adp.cartoRows[l][u]=I}H=0-"</google-map>".length;try{J=geo.googleMapWebComponent.slice(0,H)}catch(a){J="<google-map>"}t=new Array;for(p in E)D=E[p],i=JSON.parse(D.st_asgeojson),n=D.decimallatitude,o=D.decimallongitude,s=new Point(n,o),s.infoWindow=new Object,s.data=D,D.diseasedetected=function(){switch(D.diseasedetected.toString().toLowerCase()){case"true":return"positive";case"false":return"negative";default:return D.diseasedetected.toString()}}(),F=D.genus+" "+D.specificepithet,r="",F!==D.originaltaxa&&(console.warn(F+" was changed from "+D.originaltaxa),r="(<em>"+D.originaltaxa+"</em>)"),m="<p>\n  <em>"+D.genus+" "+D.specificepithet+"</em> "+r+"\n  <br/>\n  Tested <strong>"+D.diseasedetected+"</strong> for "+D.diseasetested+"\n</p>",s.infoWindow.html=m,q='<google-map-marker latitude="'+n+'" longitude="'+o+'" data-disease-detected="'+D.diseasedetected+'">\n'+m+"\n</google-map-marker>",J+=q,t.push(s);if(_adp.workingProjectPoints=t,null==(null!=d&&null!=(x=d.bounding_polygon)?x.paths:void 0)||null==(null!=d&&null!=(y=d.bounding_polygon)?y.fillColor:void 0))try{_adp.canonicalHull=createConvexHull(t,!0);try{a=new Object,null==d&&(d=new Object),null==d.bounding_polygon&&(d.bounding_polygon=new Object),d.bounding_polygon.paths=_adp.canonicalHull.hull,null==(e=d.bounding_polygon).fillOpacity&&(e.fillOpacity=defaultFillOpacity),null==(f=d.bounding_polygon).fillColor&&(f.fillColor=defaultFillColor),_adp.projectData.carto_id=JSON.stringify(d)}catch(a){}}catch(a){}return G=null!=(z=c.parsed_responses[0].total_rows)?z:0,t.length>0||(null!=b&&null!=(A=b.boundingBox)?A.length:void 0)>0?(b.skipHull=!1,0===t.length&&(g=null!=(B=null!=(C=geo.centerPoint)?C:[b.boundingBox[0].lat,b.boundingBox[0].lng])?B:[window.locationData.lat,window.locationData.lng],t.push(g)),b.onClickCallback=function(){return console.log("No callback for data-provided maps.")},createMap2(t,b,function(a){var b;return b='<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+G+"</span> sample points in this dataset</p>",$(a.selector).after,stopLoad()})):(console.info("Classic render.",b,t.length),J+='</google-map>\n<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+G+"</span> sample points in this dataset</p>",$("#transect-viewport").replaceWith(J),stopLoad())}).fail(function(a,b){return console.error("Couldn't talk to back end server to ping carto!"),stopLoadError("There was a problem communicating with the server. Please try again in a bit. (E-002)")}),window.dataFileparams=d.raw_data,d.raw_data.hasDataFile?(n=d.raw_data.filePath,n.search(helperDir)===-1&&(n=""+helperDir+n),o='<p>\n  Your project already has data associated with it. <span id="last-modified-file"></span>\n</p>\n<button id="download-project-file" class="btn btn-primary center-block click download-file" data-href="'+n+'"><iron-icon icon="icons:cloud-download"></iron-icon> Download File</button>\n<p>You can upload more data below, or replace existing data of the same type.</p>\n<br/><br/>\n<p class="text-muted">\n  Allowed types (single type of each): <code>*.kml</code>, <code>*.kmz</code>, <code>*.xls</code>, <code>*.xlsx</code>\n  <br/>\n  Allowed types (inifinite copies): <code>image/*</code>, <code>*.pdf</code>, <code>*.7z</code>, <code>*.zip</code>\n</p>',$("#data-card .card-content .variable-card-content").html(o),c="do=get_last_mod&file="+n,console.info("Timestamp: ",uri.urlString+"meta.php?"+c),$.get("meta.php",c,"json").done(function(a){var b,c,d,e;return d=1e3*toInt(a.last_mod),console.log("Last modded",d,a),isNumber(d)?(c=new Date(d),b=c.toISOString(),e=""+b.slice(0,b.search("T")),$("#last-modified-file").text("Last uploaded on "+e+"."),bindClicks()):console.warn("Didn't get a number back to check last mod time for "+n),!1}).fail(function(a,b){return console.warn("Couldn't get last mod time for "+n),!1})):($("#data-card .card-content .variable-card-content").html("<p>You can upload data to your project here:</p>"),$("#append-replace-data-toggle").attr("hidden","hidden")),startEditorUploader()}).fail(function(a,b){return!1}),!1)},startEditorUploader=function(){var a;return $("link[href='bower_components/neon-animation/animations/fade-out-animation.html']").exists()||(a='<link rel="import" href="bower_components/neon-animation/animations/fade-in-animation.html" />\n<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html" />',$("head").append(a)),bootstrapUploader("data-card-uploader","",function(){return window.dropperParams.postUploadHandler=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;try{o="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",i=b.full_path.split("/").pop(),q=b.wrote_thumb,n=b.mime_provided.split("/")[0],m=b.mime_provided.split("/")[1],l=a.size<5242880||"image"!==n?""+o+b.wrote_file:""+o+q,d=l.slice(0),e=l.slice(0),h=e.split(".").pop()}catch(a){g=a,console.warn("Warning - "+g.message),console.warn(g.stack)}if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof b)return console.error("Dropzone returned an error - "+b),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(b.status!==!0)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(""+b.human_error),console.error("Error uploading!",b),!1;if(c=["vnd.google-earth.kml+xml","vnd.google-earth.kmz","xml"],indexOf.call(c,m)>=0)return"kml"===h||"kmz"===h?(j=function(a){var b;b={path:l,data:a};try{_adp.projectData.transect_file=JSON.stringify(b)}catch(b){g=b;try{console.warn("Couldn't stringify json - "+g.message,l,a)}catch(a){}_adp.projectData.transect_file=l}return bsAlert("Your KML will take over your current bounding polygon once you save and refresh this page")},kmlHandler(l,j)):(console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+m),!1);try{switch(k=renderValidateProgress("dont-exist",!0),f='  <paper-dialog modal id="upload-progress-dialog"\n    entry-animation="fade-in-animation"\n    exit-animation="fade-out-animation">\n    <h2>Upload Progress</h2>\n    <paper-dialog-scrollable>\n      <div id="upload-progress-container" style="min-width:80vw; ">\n      </div>\n      '+k+'\n<p class="col-xs-12">Species in dataset</p>\n<iron-autogrow-textarea id="species-list" class="project-field  col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    </paper-dialog-scrollable>\n    <div class="buttons">\n      <paper-button id="close-overlay">Close &amp; Cancel</paper-button>\n      <paper-button id="save-now-upload" disabled>Save</paper-button>\n    </div>\n  </paper-dialog>',$("#upload-progress-dialog").remove(),$("body").append(f),p$("#upload-progress-dialog").open(),$("#close-overlay").click(function(){return cancelAsyncOperation(this),p$("#upload-progress-dialog").close()}),console.info("Server returned the following result:",b),console.info("The script returned the following file information:",a),o="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",i=b.full_path.split("/").pop(),q=b.wrote_thumb,n=b.mime_provided.split("/")[0],m=b.mime_provided.split("/")[1],l=a.size<5242880||"image"!==n?""+o+b.wrote_file:""+o+q,p=function(){switch(n){case"image":return'<div class="uploaded-media center-block" data-system-file="'+i+'">\n  <img src="'+l+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+a.name+" -> "+i+'\n  (<a href="'+l+'" class="newwindow" download="'+a.name+'">\n    Original Image\n  </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+i+'">\n  <audio src="'+l+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+a.name+" -> "+i+'\n    (<a href="'+l+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+i+'">\n  <video src="'+l+'" controls preload="auto">\n    <img src="'+o+q+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+a.name+" -> "+i+'\n    (<a href="'+l+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+i+'" data-link-path="'+l+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+a.name+" -> "+i+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(p),$("#validator-progress-container").remove(),n){case"application":switch(console.info("Checking "+m+" in application"),m){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":excelHandler2(l);break;case"zip":case"x-zip-compressed":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===a.type||"xlsx"===l.split(".").pop()?excelHandler2(l):(zipHandler(l),p$("#upload-progress-dialog").close());break;case"x-7z-compressed":_7zHandler(l),p$("#upload-progress-dialog").close();break;case"vnd.google-earth.kml+xml":case"vnd.google-earth.kmz":case"xml":if("kml"!==h&&"kmz"!==h)return console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+m),p$("#upload-progress-dialog").close(),!1;kmlHandler(l),p$("#upload-progress-dialog").close();break;default:return console.warn("Unknown mime type application/"+m),allError("Sorry, we can't processes files of type application/"+m),p$("#upload-progress-dialog").close(),!1}break;case"text":csvHandler(),p$("#upload-progress-dialog").close();break;case"image":imageHandler(),p$("#upload-progress-dialog").close()}}catch(a){g=a,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}return!1}}),!1},excelHandler2=function(a,b,c){var d,e,f;return null==b&&(b=!0),startLoad(),$("#validator-progress-container").remove(),f=helperDir+"excelHelper.php",e=a,a.search(helperDir)!==-1&&(console.info("removing '"+helperDir+"'"),e=a.slice(helperDir.length)),console.info("Pinging for "+e),d="action=parse&path="+e+"&sheets=Samples",$.get(f,d,"json").done(function(b){var d,f,g;return console.info("Got result",b),b.status===!1?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):($("#upload-data").attr("disabled","disabled"),f=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=f.pop(),dataFileParams.filePath=e,g=Object.size(b.data),uploadedData=b.data,_adp.parsedUploadedData=b.data,"function"!=typeof c?p$("#replace-data-toggle").checked?(startLoad(),revalidateAndUpdateData(!1,!1,!1,!1,!0),console.info("Starting newGeoDataHandler to handle a replacement dataset"),_adp.projectIdentifierString="t"+md5(_adp.projectId+_adp.projectData.author+Date.now()),d='<div class="row">\n<div class="alert alert-info col-xs-12" id="still-processing">\n  Please do not close this window until your upload has finished. As long as this message is showing, your processing is still incomplete.\n</div>\n</div>',$("#validator-progress-container").before(d),newGeoDataHandler(b.data,!1,function(a,b){return console.info("Upload and save complete",a),startLoad(),finalizeData(!0,function(a){return a.project_id=_adp.originalProjectId,_adp.reassignedTrashProjectId=_adp.projectId,_adp.projectId=_adp.originalProjectId,console.info("Successfully finalized data",a),$("#still-processing").remove(),d='<div class="row">\n<div class="alert alert-warning center-block text-center col-xs-8 force-center">\n  <strong>IMPORTANT</strong>: Remember to save your project after closing this window!<br/><br/>\n    If you don\'t, your new data <em>will not be saved</em>!\n</div>\n</div>',$("#validator-progress-container").before(d),_adp.projectData=a,$("#save-now-upload").click(function(){return saveEditorData(!0,function(){return document.location.reload})}).removeAttr("disabled"),stopLoad()})})):(console.info("Starting revalidateAndUpdateData to handle an update"),revalidateAndUpdateData(b)):(console.warn("Skipping Revalidator() !"),c(b)),stopLoad())}).fail(function(a,b){return console.error("Couldn't POST"),console.warn(a,b),stopLoadError()}),!1},revalidateAndUpdateData=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o;if(null==a&&(a=!1),null==b&&(b=!1),null==c&&(c=!1),null==d&&(d=!1),null==e&&(e=!1),$("#upload-progress-dialog").exists()||(i=renderValidateProgress("dont-exist",!0),h='  <paper-dialog modal id="upload-progress-dialog"\n    entry-animation="fade-in-animation"\n    exit-animation="fade-out-animation">\n    <h2>Upload Progress</h2>\n    <paper-dialog-scrollable>\n      <div id="upload-progress-container" style="min-width:80vw; ">\n      </div>\n      '+i+'\n<p class="col-xs-12">Species in dataset</p>\n<iron-autogrow-textarea id="species-list" class="project-field  col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    </paper-dialog-scrollable>\n    <div class="buttons">\n      <paper-button id="close-overlay">Close &amp; Cancel</paper-button>\n      <paper-button id="save-now-upload" disabled>Save</paper-button>\n    </div>\n  </paper-dialog>',$("#upload-progress-dialog").remove(),$("body").append(h),$("#close-overlay").click(function(){return cancelAsyncOperation(this),p$("#upload-progress-dialog").close()})),safariDialogHelper("#upload-progress-dialog"),e)return!1;try{f=JSON.parse(_adp.projectData.carto_id.unescape()),_adp.cartoData=f}catch(a){j=$.cookie(uri.domain+"_link"),f={table:_adp.projectIdentifierString+("_"+j),bounding_polygon:new Object}}return o=!1,a!==!1?"object"==typeof a?(o=!0,k=a.data,l=a.path.requested_path):l=a:(l=_adp.projectData.sample_raw_data.slice(uri.urlString.length),null==l&&(l=null!=(null!=dataFileParams?dataFileParams.filePath:void 0)?dataFileParams.filePath:f.raw_data.filePath)),_adp.projectIdentifierString=f.table.split("_")[0],_adp.projectId=_adp.projectData.project_id,null==(null!=(m=_adp.fims)&&null!=(n=m.expedition)?n.expeditionId:void 0)&&(_adp.fims={expedition:{expeditionId:26,ark:_adp.projectData.project_obj_id}}),g=function(a){var e,g;return e=["edit","create"],g=p$("#replace-data-toggle").checked?"create":"edit",indexOf.call(e,g)<0?(console.error(g+" is not an allowed operation on a data set!"),console.info("Allowed operations are ",e),toastStatusMessage("Sorry, '"+g+"' isn't an allowed operation."),!1):"create"===g?(newGeoDataHandler(a,function(a,b){return geo.requestCartoUpload(a,b,"create",function(a,b,c){bsAlert("Hang on for a moment while we reprocess this for saving","info"),f.table=geo.dataTable;try{isArray(points)&&(f=recalculateAndUpdateHull())}catch(a){}return _adp.projectData.carto_id=JSON.stringify(f),l=dataFileParams.filePath,revalidateAndUpdateData(l),!1}),!1}),!1):(newGeoDataHandler(a,function(e,g){var h,i,k,l;return console.info("Ready to update",e),i=f.table,a=e.data,"object"!=typeof a?(console.info("This function requires the base data to be a JSON object."),toastStatusMessage("Your data is malformed. Please double check your data and try again."),!1):isNull(i)?(console.error("Must use a defined table name!"),toastStatusMessage("You must name your data table"),!1):(j=$.cookie(uri.domain+"_link"),k=$.cookie(uri.domain+"_auth"),l=$.cookie(uri.domain+"_secret"),null==j||null==k||null==l?(console.error("You're not logged in. Got one or more invalid tokens for secrets.",j,k,l),toastStatusMessage("Sorry, you're not logged in. Please log in and try again."),!1):(h="hash="+k+"&secret="+l+"&dblink="+j,null==("undefined"!=typeof adminParams&&null!==adminParams?adminParams.apiTarget:void 0)?(console.warn("Administration file not loaded. Upload cannot continue"),stopLoadError("Administration file not loaded. Upload cannot continue"),!1):(_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,h,"json").done(function(g){var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa;if(g.status){console.info("Validated data",e),ga=new Array,J=new Array,O=new Array;for(R in a){ea=a[R],M=new Array;for(q in ea)switch(qa=ea[q],q){case"decimalLongitude":M[1]=qa,O.push(qa);break;case"decimalLatitude":M[0]=qa,J.push(qa)}ga.push(M)}m=null!=(S=J.max())?S:0,n=null!=(T=J.min())?T:0,l=null!=(U=O.max())?U:0,o=null!=(V=O.min())?V:0,x=[[m,o],[m,l],[n,l],[n,o]];try{for(na="string"==typeof a.transectRing?JSON.parse(e.transectRing):e.transectRing,na=Object.toArray(na),E=0,H=0,K=na.length;H<K;H++){if(u=na[H],u instanceof Point&&(u=u.toGeoJson(),na[E]=u),2!==u.length)throw{message:"Bad coordinate length for '"+u+"'"};for(Q=0,L=u.length;Q<L;Q++)if(t=u[Q],!isNumber(t))throw{message:"Bad coordinate number '"+t+"'"};++E}}catch(a){y=a,console.warn("Error parsing the user transect ring - "+y.message),na=void 0}la=null!=na?na:x,A={type:"GeometryCollection",geometries:[{type:"MultiPoint",coordinates:ga},{type:"Polygon",coordinates:la}]},w="ST_AsBinary("+JSON.stringify(A)+", 4326)",r=getColumnObj();try{P=new Object,W=_adp.cartoRows;for(E in W){ea=W[E],fa=null!=(X=ea.sampleId)?X:ea.sampleid;try{ma=fa.trim()}catch(a){continue}ma=ma.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2"),fa=ma,P[fa]=E}}catch(a){console.warn("Couldn't make lookupMap")}ha="",sa=new Array,s=new Array,s.push("id int"),_adp.rowsCount=Object.size(a),_adp.lookupMap=P;for(E in a){ea=a[E],E=toInt(E),ra=new Array,I=0,N=0,j=0,z=0,B={type:"Point",coordinates:new Array},F=E+1,fa=ea.sampleId;try{ba=P[fa]}catch(a){}aa=null,null!=ba&&(aa=_adp.cartoRows[ba]),p=new Array;for(q in ea){qa=ea[q],0===E&&s.push(q+" "+r[q]);try{qa=qa.replace("'","&#95;")}catch(a){}switch(q){case"decimalLongitude":B.coordinates[1]=qa;break;case"decimalLatitude":B.coordinates[0]=qa;break;case"sampleId":if(null!=aa)continue}if(null!=aa){if(ca=null!=(Y=aa[q])?Y:aa[q.toLowerCase()],"object"==typeof ca){if("string"==typeof qa)try{pa=JSON.parse(qa)}catch(a){}else pa=qa;da=10;for(G in pa)oa=pa[G],"number"==typeof oa&&(pa[G]=roundNumber(oa,da));for(G in ca)oa=ca[G],"number"==typeof oa&&(ca[G]=roundNumber(oa,da));if(v=JSON.stringify(pa),ca=JSON.stringify(ca),ca===v)continue;console.info("No Object Match:",ca,v)}if("boolean"==typeof qa)k=ca.toBool();else if("boolean"==typeof ca)k=ca.toString();else if("number"==typeof ca)k=""+ca;else if("number"==typeof qa)k=toFloat(ca);else if("null"===ca)k=null;else if(null===ca)k="null";else try{k=ca.replace("T00:00:00Z","")}catch(a){k=void 0}if(ca===qa||k===qa)continue;console.info("Not skipping for",ca,k,"on "+ea.sampleId+" @ "+q+" = ",qa)}"string"==typeof qa?null!=aa?ra.push(q.toLowerCase()+"='"+qa+"'"):ra.push("'"+qa+"'"):isNull(qa)?null!=aa?ra.push(q.toLowerCase()+"=null"):ra.push("null"):null!=aa?ra.push(q.toLowerCase()+"="+qa):ra.push(qa),p.push(q)}C="ST_SetSRID(ST_Point("+B.coordinates[1]+","+B.coordinates[0]+"),4326)",null!=aa?(D=JSON.stringify(B),_=null!=(Z=aa.the_geom)?Z:aa.st_asgeojson,_!==D&&(console.info("Not skipping coords",_,B,D),ra.push("the_geom="+C))):(p.push("the_geom"),ra.push(C)),0!==ra.length&&(null!=aa?(ia=" WHERE sampleid='"+fa+"';",ha+="UPDATE "+i+" SET "+ra.join(", ")+" "+ia):ha+="INSERT INTO "+i+" ("+p.join(",")+") VALUES ("+ra.join(",")+"); ")}return ka=ha.split(";"),ja=ka.length-1,console.log(ka),console.info("Running "+ja+" statements"),c===!0?(console.warn("Exiting before carto post because testOnly is set true"),!1):(geo.postToCarto(ha,i,function(a,c,g){var j;console.info("Post carto callback fn"),bsAlert("<strong>Please Wait</strong>: Re-Validating your total taxa data","info");try{p$("#taxa-validation").value=0,p$("#taxa-validation").indeterminate=!0}catch(a){}return _adp.canonicalHull=createConvexHull(c,!0),f.bounding_polygon.paths=_adp.canonicalHull.hull,_adp.projectData.carto_id=JSON.stringify(f),j="SELECT "+_adp.colsList.join(",")+", ST_asGeoJSON(the_geom) FROM "+i+";",h="action=fetch&sql_query="+post64(j),_adp.currentAsyncJqxhr=$.post("api.php",h,"json").done(function(a){var c,f,g,h,i,j,k,l;if(console.info("Carto query got result:",a),!a.status)return f=null!=(i=a.human_error)?i:a.error,null==f&&(f="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+f+")"),!1;k=a.parsed_responses[0].rows,_adp.cartoRows=new Object;for(E in k){ea=k[E],_adp.cartoRows[E]=new Object;for(c in ea)l=ea[c],h=null!=(j=_adp.colRemap[c])?j:c,_adp.cartoRows[E][h]=l}g={data:_adp.cartoRows};try{p$("#taxa-validation").indeterminate=!1}catch(a){}return validateTaxonData(g,function(a){var c,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,z,A,B,C,D,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z;for(e.validated_taxa=a.validated_taxa,_adp.projectData.includes_anura=!1,_adp.projectData.includes_caudata=!1,_adp.projectData.includes_gymnophiona=!1,D=e.validated_taxa,A=0,s=D.length;A<s&&(U=D[A],f=U.response.validated_taxon,console.info("Aweb taxon result:",f),i=f.order.toLowerCase(),r="includes_"+i,_adp.projectData[r]=!0,_adp.projectData.includes_anura===!1||_adp.projectData.includes_caudata===!1||_adp.projectData.includes_gymnophiona===!1);A++);for(T="",S=new Array,j=new Array,E=0,F=e.validated_taxa,C=0,t=F.length;C<t;C++){R=F[C],V=R.genus+" "+R.species,null!=R.response.original_taxon&&(console.info("Taxon obj",R),B=""+R.response.original_taxon.slice(0,1).toUpperCase()+R.response.original_taxon.slice(1),z='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+B+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+V+"</em>' below. <a href=\""+R.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(z)),isNull(R.subspecies)||(V+=" "+R.subspecies),indexOf.call(S,V)<0&&(E>0&&(T+="\n"),T+=""+V,S.push(V));try{G=R.response.validated_taxon.family,indexOf.call(j,G)<0&&j.push(R.response.validated_taxon.family)}catch(a){y=a,console.warn("Couldn't get the family! "+y.message,R.response),console.warn(y.stack)}++E}try{p$("#species-list").bindValue=T}catch(a){}for(dataAttrs.dataObj=e,_adp.data.dataObj=e,_adp.data.taxa=new Object,_adp.data.taxa.list=S,_adp.data.taxa.clades=j,_adp.data.taxa.validated=e.validated_taxa,_adp.projectData.sampled_species=S.join(","),_adp.projectData.sampled_clades=j.join(","),_adp.projectData.disease_morbidity=e.samples.morbidity,_adp.projectData.disease_mortality=e.samples.mortality,_adp.projectData.disease_positive=e.samples.positive,_adp.projectData.disease_negative=e.samples.negative,_adp.projectData.disease_no_confidence=e.samples.no_confidence,_adp.projectData.disease_samples=_adp.rowsCount,h=getMapCenter(geo.boundingBox),o=0,l=new Array,x=new Array,Z=new Array,w=new Array,g=new Array,P=new Array,m=new Array,Q=new Array,H=Object.toArray(_adp.cartoRows),W=0,u=H.length;W<u;W++)ea=H[W],k=ea.dateidentified,Y=excelDateToUnixTime(k),l.push(Y),X=new Date(Y),v=dateMonthToString(X.getUTCMonth()),indexOf.call(x,v)<0&&x.push(v),I=X.getFullYear(),indexOf.call(Z,I)<0&&Z.push(X.getFullYear()),null!=ea.catalogNumber&&g.push(ea.catalognumber),P.push(ea.sampleid),N=ea.decimallatitude,O=ea.decimallongitude,n=geo.distance(N,O,h.lat,h.lng),n>o&&(o=n),null!=ea.samplemethod&&(J=ea.samplemethod,indexOf.call(Q,J)<0&&Q.push(ea.samplemethod)),null!=ea.specimendisposition&&(K=ea.specimendisposition,indexOf.call(m,K)<0&&m.push(ea.sampledisposition));console.info("Got date ranges",l),x.sort(),Z.sort(),_adp.projectData.sampled_collection_start=l.min(),_adp.projectData.sampled_collection_end=l.max(),console.info("Collected from",l.min(),l.max()),_adp.projectData.sampling_months=x.join(","),_adp.projectData.sampling_years=Z.join(","),_adp.projectData.sample_catalog_numbers=g.join(","),_adp.projectData.sample_field_numbers=P.join(","),_adp.projectData.sample_methods_used=Q.join(",");try{recalculateAndUpdateHull()}catch(a){}return p=function(){return _adp.skipRead=!0,_adp.dataBu=_adp.projectData,d===!0?(console.warn("Save skipped on flag!"),console.info("Project data",_adp.projectData),!1):(saveEditorData(!0,function(){if(b===!0&&console.info("Saved",_adp.projectData,dataBu),null==localStorage._adp)return document.location.reload(!0)}),!1)},q=""+uri.urlString+e.dataSrc,q!==_adp.projectData.sample_raw_data?(c=_adp.projectData.dataset_arks.split(","),null==(null!=(L=_adp.fims)&&null!=(M=L.expedition)?M.ark:void 0)&&(null==_adp.fims&&(_adp.fims=new Object),null==_adp.fims.expedition&&(_adp.fims.expedition=new Object),_adp.fims.expedition.ark=_adp.projectData.project_obj_id),null!=_adp.originalProjectId&&(_adp.projectId===_adp.originalProjectId&&_adp.projectData.project_id===_adp.originalProjectId||(_adp.projectId=_adp.originalProjectId,_adp.projectData.project_id=_adp.originalProjectId)),_adp.projectData.project_id!==_adp.projectId&&(_adp.projectId=_adp.projectData.project_id),mintBcid(_adp.projectId,q,_adp.projectData.project_title,function(a){var b,d,e;return null!=a.ark?(d=q.split("/"),b=d.pop(),e=a.ark+"::"+b,c.push(e),_adp.projectData.dataset_arks=c.join(",")):console.warn("Couldn't mint!"),_adp.previousRawData=_adp.projectData.sample_raw_data,_adp.projectData.sample_raw_data=q,p()})):p(),!1}),!1}).fail(function(a,b){return stopLoadError("Error fetching updated table")}),!1}),!1)}return stopLoadError("Invalid user")}).fail(function(a,b){return stopLoadError("Error updating Carto")}),!1)))}),!1)},o?g(k):excelHandler2(l,!0,function(a){var b;return b=a.data,g(b)}),!1},recalculateAndUpdateHull=function(a){
var b,c,d,e,f,g,h,i,j,k,l,m,n;null==a&&(a=_adp.workingProjectPoints),null==a&&console.error("Can't run without points!"),_adp.projectPreModBackup=_adp.projectData;try{localStorage.projectPreModBackup=JSON.stringify(_adp.projectData)}catch(a){}if(_adp.canonicalHull=createConvexHull(a,!0),isNull(_adp.canonicalHull))return!1;for(n=new Array,i=_adp.canonicalHull.hull,e=0,f=i.length;e<f;e++)h=i[e],n.push(h.getObj());try{b=JSON.parse(_adp.projectData.carto_id)}catch(a){b=new Object}return g=null!=(j=null!=(k=b.bounding_polygon)?k.fillOpacity:void 0)?j:defaultFillOpacity,c=null!=(l=null!=(m=b.bounding_polygon)?m.fillColor:void 0)?l:defaultFillColor,d=b,console.warn("Overwriting cartoData",d),b.bounding_polygon={paths:_adp.canonicalHull.hull,fillOpacity:g,fillColor:c},_adp.projectData.carto_id=JSON.stringify(b),b},saveEditorData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R;if(null==a&&(a=!1),startLoad(),$(".hanging-alert").remove(),a||null==localStorage._adp){C=_adp.projectData;try{C.access_data=_adp.projectData.access_data.raw}catch(a){}if(_adp.skipRead!==!0){for(E=$(".project-param:not([readonly])"),n=0,o=E.length;n<o;n++)j=E[n],m=$(j).attr("data-field"),isNull(m)||(C[m]=p$(j).value.unescape());for(d=new Object,F=$(".author-param"),v=0,p=F.length;v<p;v++)j=F[v],m=$(j).attr("data-key"),d[m]=null!=(G=$(j).attr("data-value"))?G:p$(j).value;C.author_data=JSON.stringify(d)}_adp.postedSaveData=C,_adp.postedSaveTimestamp=Date.now()}else window._adp=JSON.parse(localStorage._adp),C=_adp.postedSaveData;for(m in C){g=C[m];try{C[m]=deEscape(g)}catch(a){}}if(l=!1,$("paper-toggle-button#public").exists()&&(C.public=p$("paper-toggle-button#public").checked,C.public)){l=!0;try{recalculateAndUpdateHull(),C.carto_id=_adp.projectData.carto_id}catch(a){}}null!=_adp.originalProjectId&&_adp.originalProjectId!==_adp.projectId&&(console.warn("Mismatched IDs!",_adp.originalProjectId,_adp.projectId),C.project_id=_adp.originalProjectId);try{w=4e3;try{f=JSON.parse(C.carto_id),A=f.bounding_polygon.paths}catch(a){A=[]}try{M=JSON.parse(C.transect_file),O=M.data.parameters.paths}catch(a){O=[]}e=Object.size(A);try{for(H=f.bounding_polygon.multibounds,y=0,q=H.length;y<q;y++)x=H[y],e+=Object.size(x)}catch(a){}N=Object.size(O);try{for(I=M.data.polys,D=0,r=I.length;D<r;D++)x=I[D],N+=Object.size(x)}catch(a){}if(B=e+N,B>w){if(console.warn("Danger: Have "+B+" paths. The recommended max is "+w),N===e){M.data.parameters.paths="SEE_BOUNDING_POLY";try{for(k=0,J=M.data.polys,P=0,s=J.length;P<s;P++)z=J[P],M.data.polys[k]="SEE_BOUNDING_POLY",++k}catch(a){}C.transect_file=JSON.stringify(M),N=M.data.parameters.paths.length}try{f.bounding_polygon.paths=!1,C.carto_id=JSON.stringify(f),e=0}catch(a){}try{for(K=f.bounding_polygon.multibounds,Q=0,t=K.length;Q<t;Q++)x=K[Q],e+=Object.size(x)}catch(a){}try{for(L=M.data.polys,R=0,u=L.length;R<u;R++)x=L[R],N+=Object.size(x)}catch(a){}B=e+N,console.debug("Shrunk to reduced data size "+B+". May have compatability errors.")}}catch(a){i=a,console.error("Couldn't check path count -- "+i.message+". Faking it."),B=w+1}return console.log("Sending to server",C),c="perform=save&data="+jsonTo64(C),h=delay(1e4,function(){return console.warn("POST may have hung after 10 seconds"),console.warn("args length was '"+c.length+"' = "+8*c.length+" bytes"),!1}),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,c,"json").done(function(a){var b,c,d,e;return console.info("Save result: server said",a),a.status!==!0?(b=null!=(d=null!=(e=a.human_error)?e:a.error)?d:"There was an error saving to the server",stopLoadError("There was an error saving to the server"),localStorage._adp=JSON.stringify(_adp),bsAlert("<strong>Save Error:</strong> "+b+". An offline backup has been made.","danger"),console.error(a.error),!1):(stopLoad(),toastStatusMessage("Save successful"),_adp.projectData=a.project.project,delete localStorage._adp,l?_adp.projectData.public?($("paper-toggle-button#public").parent().remove(),c='<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>',$("iron-icon[icon='icons:lock'].material-red").replaceWith(c)):console.warn("We sent a change to public, but it didn't update server-side."):void 0)}).fail(function(a,b){var d,e;stopLoadError("Sorry, there was an error communicating with the server");try{if(e=_adp,delete e.currentAsyncJqxhr,B>w)try{M=JSON.parse(e.projectData.transect_file),M.data.parameters.paths="REMOVED_FOR_LOCAL_SAVE",M.data.polys="REMOVED_FOR_LOCAL_SAVE",e.projectData.transect_file=JSON.stringify(M)}catch(a){}localStorage._adp=JSON.stringify(e),console.debug("Local storage backup succeeded"),d="An offline backup has been made."}catch(a){i=a,console.warn("Couldn't backup to local storage! "+i.message),console.warn(i.stack),d="Offline backup failed (said: <code>"+i.message+"</code>)",delay(250,function(){delete e.currentAsyncJqxhr,delete _adp.currentAsyncJqxhr;try{return localStorage._adp=JSON.stringify(_adp),d="An offline backup has been made.",$("#offline-backup-status").replaceWith(d)}catch(a){}}),$("#offline-backup-status").replaceWith(d)}return bsAlert("<strong>Save Error</strong>: We had trouble communicating with the server and your data was NOT saved. Please try again in a bit. <span id='offline-backup-status'>"+d+"</span>","danger"),console.error(a,b),console.warn("Raw post data",C),console.warn("args length was '"+c.length+"' = "+8*c.length+" bytes")}).always(function(){if(clearTimeout(h),"function"==typeof b)return b()}),!1},$(function(){var a,b,c,d;try{_adp.originalProjectId=_adp.projectData.project_id,b=_adp.projectData.project_id}catch(a){delay(1e3,function(){try{return _adp.originalProjectId=_adp.projectData.project_id,b=_adp.projectData.project_id}catch(a){return console.warn("Warning: COuldn't backup project id")}})}if(null!=localStorage._adp){try{window._adp=JSON.parse(localStorage._adp)}catch(a){null==window._adp&&(window._adp=new Object)}try{_adp.originalProjectId=b}catch(a){}try{return c=new Date(_adp.postedSaveTimestamp),a="<strong>You have offline save information</strong> &#8212; did you want to save it?\n<br/><br/>\nProject #"+_adp.postedSaveData.project_id+" on "+c.toLocaleDateString()+" at "+c.toLocaleTimeString()+'\n<br/><br/>\n<button class="btn btn-success" id="offline-save">\n  Save Now &amp; Refresh Page\n</button>\n<button class="btn btn-danger" id="offline-trash">\n  Remove Offline Backup\n</button>',bsAlert(a,"info"),$("#outdated-warning").remove(),delay(300,function(){return $("#outdated-warning").remove()}),$("#offline-save").click(function(){return saveEditorData(!1,function(){return document.location.reload(!0)})}),$("#offline-trash").click(function(){return delete localStorage._adp,$(".hanging-alert").alert("close")})}catch(a){return d=a,console.warn("Backup corrupted, removing -- "+d.message),delete localStorage._adp}}}),loadProjectBrowser=function(){var a,b,c;return c=uri.urlString+"admin-page.html#action:show-viewable",b={do:"action",prop:"show-viewable"},history.pushState(b,"Viewing Personal Project List",c),startAdminActionHelper(),startLoad(),a="perform=list",$.get(adminParams.apiTarget,a,"json").done(function(a){var b,c,d,e,f,g,h,i;b='<h2 class="new-title col-xs-12">Available Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(b),g=new Array,h=a.public_projects;for(d in h)e=h[d],g.push(e);i=a.projects;for(e in i)f=i[e],c=indexOf.call(g,e)>=0?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',b='<li>\n  <button class="btn btn-primary" data-project="'+e+'" data-toggle="tooltip" title="Project #'+e.substring(0,8)+'...">\n    '+c+" "+f+"\n  </button>\n</li>",$("#project-list").append(b);return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),loadProject(a)}),stopLoad()}).fail(function(a,b){return stopLoadError("There was a problem loading viable projects")}),!1},loadProject=function(a,b){return null==b&&(b=""),goTo(uri.urlString+"project.php?id="+a),!1},"object"!=typeof window.validationMeta&&(window.validationMeta=new Object),validateData=function(a,b){var c;return null==b&&(b=null),_adp.validationDataObject=a,console.info("Doing nested validation"),c=Date.now(),renderValidateProgress(),validateFimsData(a,function(){return validateTaxonData(a,function(){var d;return d=Date.now()-c,console.info("Validation took "+d+"ms",a),cleanupToasts(),toastStatusMessage("Your dataset has been successfully validated"),"function"==typeof b?b(a):(console.warn("validateData had no defined callback!"),console.info("Got back",a))})}),!1},stopLoadBarsError=function(a,b){var c,d,e,f,g;if(!$("#validator-progress-container:visible").exists())throw new(d=function(){return this.message="Loading bars aren't visible!",this.name="BadLoadState"});try{clearTimeout(a)}catch(a){}for($("#validator-progress-container paper-progress[indeterminate]").addClass("error-progress").removeAttr("indeterminate"),g=$("#validator-progress-container paper-progress:not([indeterminate])"),e=0,f=g.length;e<f;e++){c=g[e];try{p$(c).value!==p$(c).max&&($(c).addClass("error-progress"),$(c).find("#primaryProgress").css("background","#F44336"))}catch(a){}}return null!=b&&(bsAlert("<strong>Data Validation Error</strong>: "+b,"danger"),stopLoadError(null,"There was a problem validating your data")),!1},delayFimsRecheck=function(a,b){var c,d;return d=encodeURIComponent(a.responses.login_response.cookies),c="perform=validate&auth="+d,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,c,"json").done(function(a){return console.log("Server said",a),"function"==typeof b?b():console.warn("Warning: delayed recheck had no callback")}).fail(function(a,b){return console.error(b+": Couldn't check status on FIMS server!"),console.warn("Server said",a.responseText),stopLoadBarsError(null,"There was a problem validating your data, please try again later")}),!1},validateFimsData=function(a,b){var c,d,e,f,g,h,i,j,k;if(null==b&&(b=null),"number"!=typeof("undefined"!=typeof _adp&&null!==_adp&&null!=(f=_adp.fims)&&null!=(g=f.expedition)?g.expeditionId:void 0))return _adp.hasRunMintCallback===!0?(console.error("Couldn't run validateFimsData(); called itself back recursively. There may be a problem with the server. "),stopLoadBarsError(null,"Couldn't generate an ARK for your data, please try again later (couldn't communicate with the FIMS server)"),_adp.hasRunMintCallback=!1,!1):(_adp.hasRunMintCallback=!1,console.warn("Haven't minted expedition yet! Minting that first"),mintExpedition(_adp.projectId,p$("#project-title").value,function(){return _adp.hasRunMintCallback=!0,validateFimsData(a,b)}),!1);console.info("FIMS Validating",a.data),$("#data-validation").removeAttr("indeterminate"),h=Object.size(a.data);try{p$("#data-validation").max=2*h}catch(a){}return j=20,k=null,(c=function(){var a;try{a=p$("#data-validation").value}catch(a){return!1}if(a>=h)return clearTimeout(k),!1;++a;try{p$("#data-validation").value=a}catch(a){return!1}return k=delay(j,function(){return c()})})(),e=jsonTo64(a.data),i=post64(a.dataSrc),d="perform=validate&datasrc="+i+"&link="+_adp.projectId,console.info("Posting ...",""+uri.urlString+adminParams.apiTarget+"?"+d),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,d,"json").done(function(c){var d,e,f,g,h,i,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;if(console.log("FIMS validate result",c),c.status!==!0)return stopLoadError("There was a problem talking to the server"),d=null!=(v=null!=(w=c.human_error)?w:c.error)?v:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.",bsAlert("<strong>Server Error:</strong> "+d,"danger"),stopLoadBarsError(k),!1;E=null!=(null!=(x=c.validate_status)?x.status:void 0)?c.validate_status.status:c.validate_status,n=["FIMS_SERVER_DOWN"],m=["server error"],t=!1,D="";try{if(1===Object.size(c.validate_status.errors)){y=c.validate_status.errors[0];for(j in y){g=y[j],D=g,"object"==typeof D&&(D=g[0]);break}z=D.toLowerCase(),t=indexOf.call(m,z)>=0}}catch(a){}if(i={statusesOK:n,errorsOK:m,message:D,permissible:t,errorSize:Object.size(c.validate_status.errors)},A=c.validate_status,indexOf.call(n,A)>=0||t)toastStatusMessage("Validation server is down, proceeding ..."),bsAlert("<strong>FIMS error</strong>: The validation server is down, we're trying to finish up anyway.","warning");else if(E!==!0){if(s=!1,console.error("Bad validation",i),stopLoadError("There was a problem with your dataset"),d=null!=(B=null!=(C=null!=(u="<code>"+c.validate_status.error+"</code>")?u:c.human_error)?C:c.error)?B:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.",d.length>255&&(s=!0,d=d.substr(0,255)+"[...] and more."),bsAlert("<strong>FIMS reported an error validating your data:</strong> "+d,"danger"),stopLoadBarsError(k),l=c.validate_status.errors,Object.size(l)>1||s){o='<div class="error-block" id="validation-error-block">\n  <p><strong>Your dataset had errors</strong>. Here\'s a summary:</p>\n  <table class="table-responsive table-striped table-condensed table table-bordered table-hover" >\n    <thead>\n      <tr>\n        <th>Error Type</th>\n        <th>Error Message</th>\n      </tr>\n    </thhead>\n    <tbody>';for(q in l){j=l[q];for(e in j){h=j[e],f="<ul>";for(p in h)r=h[p],r=r.stripHtml(!0),/\[(?:((?:"(\w+)"((, )?))*?))\]/m.test(r)&&(r=r.replace(/"(\w+)"/gm,"<code>$1</code>")),f+="<li>"+r+"</li>";f+="</ul>",o+="<tr>\n  <td><strong>"+e.stripHtml(!0)+"</strong></td>\n  <td>"+f+"</td>\n</tr>"}}o+="    </tbody>\n  </table>\n</div>",$("#validator-progress-container").append(o),$("#validator-progress-container").get(0).scrollIntoView()}return!1}try{p$("#data-validation").value=p$("#data-validation").max,clearTimeout(k)}catch(a){}return"function"==typeof b?b(a):void 0}).fail(function(a,b){return clearTimeout(k),console.error(b+": Couldn't upload to FIMS server!"),console.warn("Server said",a.responseText),stopLoadBarsError(null,"There was a problem validating your data, please try again later"),!1}),!1},mintBcid=function(a,b,c,d){var e,f,g,h,i;return null==b&&(b=null!=dataFileParams?dataFileParams.filePath:void 0),"function"!=typeof d?(console.warn("mintBcid() requires a callback function"),!1):(i=new Object,e=null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(g=_adp.fims)&&null!=(h=g.expedition)?h.ark:void 0),f="perform=mint&link="+a+"&title="+post64(c)+"&file="+b+"&expedition="+e,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,f,"json").done(function(a){return console.log("Got",a),a.status?i=a:(stopLoadBarsError(null,a.human_error),console.error(a.error),!1)}).fail(function(a,b){return i={ark:null,error:b,human_error:a.responseText,status:!1},!1}).always(function(){return console.info("mintBcid is calling back",i),d(i)}),!1)},mintExpedition=function(a,b,c){var d,e,f;if(null==a&&(a=_adp.projectId),null==b&&(b=p$("#project-title").value),"function"!=typeof c)return console.warn("mintExpedition() requires a callback function"),!1;f=new Object;try{e=p$("#data-encumbrance-toggle").checked}catch(a){try{e=p$("#public").checked}catch(a){}}return"boolean"!=typeof e&&(e=!1),d="perform=create_expedition&link="+a+"&title="+post64(b)+"&public="+e,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,d,"json").done(function(a){return console.log("Expedition got",a),a.status?(f=a,null==("undefined"!=typeof _adp&&null!==_adp?_adp.fims:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp=new Object),_adp.fims=new Object),_adp.fims.expedition={permalink:a.project_permalink,ark:a.ark,expeditionId:a.fims_expedition_id,fimsRawResponse:a.responses.expedition_response}):(stopLoadBarsError(null,a.human_error),console.error(a.error,adminParams.apiTarget+"?"+d),!1)}).fail(function(a,b){return f.ark=null,!1}).always(function(){return console.info("mintExpedition is calling back",f),c(f)}),!1},validateTaxonData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;null==b&&(b=null),d=a.data,n=new Array,o=new Object;for(g in d)k=d[g],l=null!=(h=k.specificEpithet)?h:k.specificepithet,m=null!=(i=k.infraspecificEpithet)?i:k.infraspecificepithet,c=null!=(j=k.cladeSampled)?j:k.cladesampled,q={genus:k.genus,species:l,subspecies:m,clade:c},n.containsObject(q)||n.push(q),p=q.genus+" "+q.species,isNull(q.subspecies)||(p+=" "+q.subspecies),null==o[p]&&(o[p]=new Array),o[p].push(g);console.info("Found "+n.length+" unique taxa:",n),e=n.length>1?"taxa":"taxon",f=Object.toArray(d).length,toastStatusMessage("Validating "+n.length+" unique "+e+" from "+f+" rows ..."),console.info("Replacement tracker",o),$("#taxa-validation").removeAttr("indeterminate");try{p$("#taxa-validation").max=n.length}catch(a){}return(r=function(c,d){return p=c[d].genus+" "+c[d].species,isNull(c[d].subspecies)||(p+=" "+c[d].subspecies),validateAWebTaxon(c[d],function(e){var f,h,i,j,l,m,n,q,s,t,u,v,w,x,y,z;if(e.invalid===!0){for(cleanupToasts(),w=/^([a-zA-Z]+) +[a-zA-Z\. ]+$/im,n=w.exec(c[d].species),x=w.exec(c[d].subspecies),null!=n||null!=x?(z=null!=n?"species":"subspecies",h="(We noticed your "+z+' looks like the full species name. <a href="https://tdwg.github.io/dwc/terms/index.htm#specificEpithet" class="alert-link newwindow" data-newtab="true">Double check the definition <span class="glyphicon glyphicon-new-window"></span></a> and your entry &#8212; that may help!)'):h="Please correct taxonomy issues and try uploading again. If you're confused by this message, please check <a href='https://amphibian-disease-tracker.readthedocs.io/en/latest/APIs/#validating-updating-taxa' data-newtab='true' class='newwindow alert-link'>our documentation  <span class='glyphicon glyphicon-new-window'></span></a>.",q=null!=(s=null!=(t=e.response.human_error)?t:e.response.error)?s:"Unknown error.",stopLoadError(q),q=null!=(u=e.response.human_error_html)?u:q,console.error(e.response.error),y=o[p].slice(0),g=0,i=0,j=y.length;i<j;i++)k=y[i],k++,y[g]=k,g++;return y.length>5&&(y=y.slice(0,5),y=y.toString()+"..."),q="<strong>Taxonomy Error</strong>: There was a taxon error in your file. "+q+" The error occured while we were checking taxon <span class='sciname'>\""+p+'"</span>, which occurs at rows '+y+". We stopped validation at that point. "+h,bsAlert(q),removeDataFile(),stopLoadBarsError(),!1}try{for(v=o[p],console.info("Replacing rows @ "+p,v,c[d]),m=0,l=v.length;m<l;m++)k=v[m],a.data[k].genus=e.genus,a.data[k].specificEpithet=e.species,null==e.subspecies&&(e.subspecies=""),a.data[k].infraspecificEpithet=e.subspecies,a.data[k].originalTaxa=p}catch(a){f=a,console.warn("Problem replacing rows! "+f.message),console.warn(f.stack)}c[d]=e;try{p$("#taxa-validation").value=d}catch(a){}if(d++,d<c.length)return 0===modulo(d,50)&&toastStatusMessage("Validating taxa "+d+" of "+c.length+" ..."),r(c,d);try{p$("#taxa-validation").value=d}catch(a){}return a.validated_taxa=c,console.info("Calling back!",a),b(a)})})(n,0),!1},loadSUProfileBrowser=function(){var a,b;return b=uri.urlString+"admin-page.html#action:show-su-profiles",a={do:"action",prop:"show-su-profiles"},history.pushState(a,"Viewing Superuser Profile List",b),startAdminActionHelper(),startLoad(),verifyLoginCredentials(function(a){var b,c,d,e;return e=toInt(a.detail.userdata.su_flag),e.toBool()?(c="su-admin-users",b="action=search_users&q=",d=uri.urlString+"api.php",$.post(d,b).done(function(a){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(a.status!==!0)return n=null!=(o=null!=(p=a.human_error)?p:a.error)?o:"There was a problem loading the user list",stopLoadError(n),!1;for(k=a.result,k=Object.toArray(k),l=new Array,g=0,i=0,j=k.length;i<j;i++)user=k[i],++g,isNull(user.full_name)||(r=user.has_verified_email?"<iron-icon id='restriction-badge-"+g+"' icon='icons:verified-user' class='material-blue' data-toggle='tooltip' title='At least one verified email'></iron-icon>":"",h=user.unrestricted?"<iron-icon id='unrestriction-badge-"+g+"' icon='icons:verified-user' class='material-green' data-toggle='tooltip' title='Meets restriction criteria'></iron-icon>":"<iron-icon id='unrestriction-badge-"+g+"' icon='icons:verified-user' class='material-red' data-toggle='tooltip' title='Fails restriction criteria'></iron-icon>",d=user.is_admin?'<span class="glyphicons glyphicons-user-key" data-toggle="tooltip" title="Adminstrator"></span>':"",e='<span class="'+c+'-user-details">\n  '+user.full_name+" / "+user.handle+" / "+user.email+" | <small>"+(null!=(q=user.alternate_email)?q:"No Alternate Email")+"</small> "+h+" "+r+" "+d+'\n</span>\n<div>\n  <button class="'+c+'-view-projects btn btn-default" data-uid="'+user.uid+'" data-email="'+user.email+'">\n    <iron-icon icon="icons:find-in-page"></iron-icon>\n    Find Projects\n  </button>\n  <button class="'+c+'-reset btn btn-warning" data-uid="'+user.uid+'" data-email="'+user.email+'">\n    <iron-icon icon="av:replay"></iron-icon>\n    Reset Password\n  </button>\n  <button class="'+c+'-delete btn btn-danger" data-uid="'+user.uid+'">\n    <iron-icon icon="icons:delete"></iron-icon>\n    Delete User\n  </button>\n</div>',l.push(e));return m=l.join("</li><li class='su-user-list'>"),f="<ul class='su-total-list col-xs-12' id=\"su-management-list\">\n  <li class='su-user-list'>"+m+"</li>\n</ul>",$("#main-body").html(f),$("."+c+"-view-projects").click(function(){var a,c,d,e;return startLoad(),e=$(this).attr("data-uid"),c=$(this).attr("data-email"),d=e,a="access_data,author_data,author",console.info("Searching on "+d+" ... in "+a),b="action=search_project&q="+d+"&cols="+a,$.post(uri.urlString+"api.php",b,"json").done(function(a){return function(b){var e,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(console.info(b),f='<h3 class="col-xs-12">\n  Projects with "'+c+'" as a participant\n</h3>',t=new Array,o=Object.toArray(b.result),o.length>0){for(f+="<ul class='project-search-su col-xs-12'>",l=0,k=o.length;l<k;l++)n=o[l],isNull(n.project_id)||(t.push(n.project_id),p=n.public.toBool(),j=d===n.author,console.log(d,n.author,j,n),m=j?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author">\n</iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator">\n</iron-icon>',h=!isNull(n.dataset_arks),g=h?'<iron-icon icon="editor:insert-chart" data-toggle="tooltip" title="Data Attached">\n</iron-icon>':"",i=p?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',e='<button class="btn btn-primary search-proj-link" data-href="'+uri.urlString+"project.php?id="+n.project_id+'" data-toggle="tooltip" data-placement="right" title="Project #'+n.project_id.slice(0,8)+'...">\n  '+i+" "+n.project_title+"\n</button> "+m+" "+g,f+="<li class='project-search-result'>"+e+"</li>");f+="</ul>"}else s=null!=(q=null!=(r=null!=c?c:$(a).attr("data-email"))?r:b.search)?q:d,f="<p class='col-xs-12'><em>No results found for user \"<strong>"+s+'</strong>"';return f+='<div class="col-xs-12">\n  <button class="btn btn-default go-back-button">\n    <iron-icon icon="icons:arrow-back"></iron-icon>\n    Back to Profile Browser\n  </button>\n</div>',$("#main-body").html(f),bindClicks(".search-proj-link"),$(".go-back-button").click(function(){return loadSUProfileBrowser(),!1}),!1}}(this)).fail(function(a){return function(a,b){return console.error("AJAX error trying to search on user projects",a,b),n=b+" "+a.status+": "+a.statusText,stopLoadError("Couldn't search projects ("+n+")"),!1}}(this)),stopLoad(),!1}),$("."+c+"-reset").click(function(){var a;return startLoad(),a=$(this).attr("data-email"),b="action=startpasswordreset&username="+a+"&method=email",$(this).attr("disabled","disabled"),$.post("admin/async_login_handler.php",b,"json").done(function(b){var c,d;return console.info("Reset prompt returned",b),b.status?(stopLoad(),n="Successfully prompted '"+a+"' to reset their password (method: "+b.method+")",toastStatusMessage(n,"",7e3),!1):(n=null!=(c=null!=(d=b.human_error)?d:b.error)?c:"Couldn't initiate password reset for "+a,"GET_TOTP"===b.action?n="User has two-factor authentication. They have to reset themselves.":isNull(b.action)||(n+=" ("+b.action+")"),stopLoadError(n),!1)}).fail(function(a){return function(b,c){return console.error("AJAX error trying to initiate password reset",b,c),n=c+" "+b.status+": "+b.statusText,stopLoadError("Couldn't initiate password reset ("+n+")"),$(a).removeAttr("disabled"),!1}}(this)),!1}),$("."+c+"-delete").click(function(){return f='<iron-icon icon="icons:warning" class="">\n</iron-icon>\nConfirm Deletion',$(this).addClass("danger-glow").html(f).unbind().click(function(){var a,c;return startLoad(),a=$(this).parents(".su-user-list"),c=$(this).attr("data-uid"),$(this).attr("disabled","disabled"),b="perform=su_manipulate_user&user="+c+"&change_type=delete",console.info("Posting to",""+uri.urlString+adminParams.apiTarget+"?"+b),$.post(adminParams.apiTarget,b,"json").done(function(b){return function(c){var d,e,f;if(console.info("Click to delete returned",c),c.status!==!0){switch(n=null!=(d=null!=(e=c.human_error)?e:c.error)?d:"There was an error executing the action",f=c.error){case f.search("INVALID_TARGET")!==-1:$(b).attr("disabled","disabled")}return stopLoadError(n),!1}return console.log("Got li of ",a),a.slideUp("slow",function(){return a.remove()}),delay(1e3,function(){if(a.exists())return console.warn("Trying to force removal of element"),a.remove()}),!1}}(this)).fail(function(a,b){return console.error("AJAX error",a,b),n=b+" "+a.status+": "+a.statusText,stopLoadError("Couldn't execute action ("+n+")"),!1}).always(function(a){return function(){return delay(300,function(){return $(a).removeAttr("disabled")})}}(this)),stopLoad(),!1}),!1}),stopLoad(),!1}).fail(function(a,b){var c;return console.error("Couldn't load user list",a,b),c=b+" "+a.status+": "+a.statusText,stopLoadError("Sorry, can't load user list ("+c+")")})):(stopLoadError("Sorry, you must be an admin to do this"),!1)}),!1},loadSUProjectBrowser=function(){var a,b;return b=uri.urlString+"admin-page.html#action:show-su-viewable",a={do:"action",prop:"show-su-viewable"},history.pushState(a,"Viewing Superuser Project List",b),startAdminActionHelper(),startLoad(),verifyLoginCredentials(function(a){var b,c;return c=toInt(a.detail.userdata.su_flag),c.toBool()?(b="perform=sulist",$.get(adminParams.apiTarget,b,"json").done(function(a){var b,c,d,e,f,g,h,i;if(a.status!==!0)return b=null!=(h=a.human_error)?h:"Sorry, you can't do that right now",stopLoadError(b),console.error("Can't do SU listing!"),console.warn(a),populateAdminActions(),!1;c='<h2 class="new-title col-xs-12">All Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(c),e=new Array,i=a.projects;for(g in i)f=i[g],e.push(g),d=f.public.toBool()?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',c='<li>\n  <button class="btn btn-primary" data-project="'+g+'" data-toggle="tooltip" title="Project #'+g.substring(0,8)+'...">\n    '+d+" "+f.title+"\n  </button>\n</li>",$("#project-list").append(c);return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),loadEditor(a)}),stopLoad()}).fail(function(a,b){return stopLoadError("There was a problem loading projects")})):(stopLoadError("Sorry, you must be an admin to do this"),!1)}),!1};var checkArkDataset,checkProjectAuthorization,copyLink,createOverflowMenu,fillSorterWithDropdown,kmlLoader,postAuthorizeRender,prepParsedDataDownload,publicData,renderEmail,renderMapWithData,renderPublicMap,searchProjects,setPublicData,showCitation,showEmailField,sqlQueryBox,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};_adp.mapRendered=!1,_adp.zcClient=null,publicData=null;try{(createOverflowMenu=function(){return checkLoggedIn(function(a){var b,c;return b=a.status?'    <paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",c='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+b+'\n    <paper-item disabled data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker/issues/176" class="click">\n      Summary Dashboard\n    </paper-item>\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About / Legal\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(c),isNull(b)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1})()}catch(a){}fillSorterWithDropdown=function(a){var b,c,d,e,f,g,h,i,j;null==a&&(a=".sort-by-placeholder-text"),j={date:{title:"sampling date",key:"date"},affiliation:{title:"affiliation",key:"affiliation"},lab:{title:"PI lab",key:"lab"},contact:{title:"PI contact",key:"contact"}},g=$(a).attr("data-order-key"),c="",e=0,i=0;for(f in j)b=j[f],b.key===g&&(i=e),++e,c+='<paper-item data-sort-key="'+b.key+'">'+b.title+"</paper-item>";return d='<paper-dropdown-menu label="Sort Options" id="sort-options">\n  <paper-listbox class="dropdown-content" selected="'+i+'">\n    '+c+"\n  </paper-listbox>\n</paper-dropdown-menu>",$(a).replaceWith(d),h=0,$("#sort-options").on("iron-select",function(){var a,b;return a=p$(this).selectedItem,b=$(a).attr("data-sort-key"),console.debug("Selected '"+b+"'"),h>0&&goTo("https://"+uri.domain+".org/project.php?sort="+b),++h}),!1},checkProjectAuthorization=function(a,b){return null==a&&(a=_adp.projectId),null==b&&(b=postAuthorizeRender),startLoad(),console.info("Checking authorization for "+a),checkLoggedIn(function(c){var d,e,f;return null==a?(c.status?(console.info("Logged in user, no project"),d='<paper-icon-button icon="icons:dashboard" class="authorized-action" id="show-actions" data-href="'+uri.urlString+'admin-page.html" data-toggle="tooltip" title="Administration Dashboard"> </paper-icon-button>'):console.info("Not logged in"),stopLoad(),!1):c.status?(f=uri.urlString+"admin-api.php",e="perform=check_access&project="+a,$.post(f,e,"json").done(function(a){var c;return a.status?(console.info("User is authorized"),c=a.detail.project,"function"==typeof b?b(c,a.detailed_authorization):(console.warn("No callback specified!"),console.info("Got project data",c))):console.info("User is unauthorized")}).fail(function(a,b){return console.log("Error checking server",a,b)}).always(function(){return stopLoad()})):(console.info("Non logged-in user or unauthorized user"),renderPublicMap(),stopLoad(),!1)}),!1},renderEmail=function(a){var b,c;return animateLoad(),c=uri.urlString+"api.php",b="action=is_human&recaptcha_response="+a+"&project="+_adp.projectId,$.post(c,b,"json").done(function(a){var b,c,d,e;return console.info("Checked response"),console.log(a),b=a.author_data,showEmailField(b.contact_email),isNull(null!=(d=a.technical)?d.name:void 0)||isNull(null!=(e=a.technical)?e.email:void 0)||(c="Technical Contact "+a.technical.name,showEmailField(a.technical.email,c,"technical-email-send")),stopLoad()}).fail(function(a,b){return stopLoadError("Sorry, there was a problem getting the contact email"),!1}),!1},showEmailField=function(a,b,c){
var d,e,f,g;return null==b&&(b="Contact Email"),null==c&&(c="contact-email-send"),e='<div class="row appended-email-field">\n  <paper-input readonly class="col-xs-8 col-md-11" label="'+b+'" value="'+a+'"></paper-input>\n  <paper-fab icon="communication:email" class="click materialblue" id="'+c+'" data-href="mailto:'+a+'" data-toggle="tooltip" title="Send Email"></paper-fab>\n</div>',$("#email-fill").exists()?$("#email-fill").replaceWith(e):(d=$(".appended-email-field"),f=d.length-1,g=$(".appended-email-field").get(f),$(g).after(e)),bindClicks("#"+c),!1},renderMapWithData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M;if(null==b&&(b=!1),H=function(){try{if(!isNull(a.transect_file))return kmlLoader(a.transect_file,function(){return console.debug("Loaded KML file successfully")})}catch(a){}},_adp.mapRendered===!0&&b!==!0)return console.warn("Carto: The map was asked to be rendered again, but it has already been rendered!"),H(),!1;if(k=a.carto_id,"object"!=typeof k)try{i=JSON.parse(deEscape(k))}catch(a){p=a,q=p.message;try{i=JSON.parse(k)}catch(a){if(p=a,k.length>511&&(j=fixTruncatedJson(k),"object"==typeof j&&(console.debug("The carto data object was truncated, but rebuilt."),i=j)),isNull(i))return console.error("cartoObj must be JSON string or obj, given",k),console.warn("Cleaned obj:",deEscape(k)),console.warn("Told '"+q+"' then",p.message),stopLoadError("Couldn't parse data"),!1}}else i=k;if(_adp.cartoDataParsed=i,E=i.raw_data,isNull(E))return console.warn("No raw data to render"),H(),!1;if(E.hasDataFile&&(t="helpers/",s=E.filePath,s.search(t)===-1&&(s=""+t+s),o="",g=a.dataset_arks.split(","),g.length>0))for(h=s.split("/"),h.pop(),h=h.join("/"),v=0,w=0,y=g.length;w<y;w++)e=g[w],n=e.split("::"),f=n[0],s=h+"/"+n[1],r=0===v?"":"btn-xs download-alt-datafile",I=0===v?"Download Newest Datafile":f+" dataset",u='<button class="btn btn-primary click download-file download-data-file '+r+'" data-href="'+s+'" data-newtab="true" data-toggle="tooltip" title="'+f+' (right-click to copy)" data-ark="'+f+'">\n  <iron-icon icon="editor:insert-chart"></iron-icon>\n  '+I+"\n</button>",o+=u,++v;if(null==o&&(o=""),m=i.table,isNull(m))return console.warn("WARNING: This project has no data associated with it. Not doing map render."),H(),!1;try{try{i.bounding_polygon.paths.toBool()!==!1||isNull(i.bounding_polygon.multibounds)||(i.bounding_polygon.paths=i.bounding_polygon.multibounds[0])}catch(a){}M=null!=(F=i.bounding_polygon.paths)?F:i.bounding_polygon,L=getMapZoom(M,"#transect-viewport"),console.info("Got zoom",L)}catch(a){L=""}for(D=i.bounding_polygon,(isArray(D)||null==(null!=D?D.paths:void 0))&&(B=D,J=toObject(D),"object"!=typeof J&&(J=new Object),J.paths=D,isArray(J.paths)||(J.paths=new Array),D=J),null==D.fillColor&&(D.fillColor=defaultFillColor),null==D.fillOpacity&&(D.fillOpacity=defaultFillOpacity),A='<google-map-poly closed fill-color="'+D.fillColor+'" fill-opacity="'+D.fillOpacity+'" stroke-weight="1">',K=new Array,G=D.paths,x=0,z=G.length;x<z;x++)C=G[x],indexOf.call(K,C)<0&&(K.push(C),A+='<google-map-point latitude="'+C.lat+'" longitude="'+C.lng+'"> </google-map-point>');return A+="    </google-map-poly>",l="SELECT genus, specificepithet, diseasetested, diseasedetected, originaltaxa, ST_asGeoJSON(the_geom) FROM "+m+";",console.info("Would ping cartodb with",l),c=encodeURIComponent(encode64(l)),d="action=fetch&sql_query="+c,console.debug("Hitting endpoint for carto lookup",uri.urlString+"api.php?"+d),$.post("api.php",d,"json").done(function(b){var c,d,f,g,h,i,j,k,l,m,n,q,r,s,t,w,x,y,z,B,C,E,F,G,I,K,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_;if(_adp.mapRendered===!0)return console.warn("Duplicate map render! Skipping thread"),H(),!1;if(console.info("Carto query got result:",b),!b.status)return j=null!=(Q=b.human_error)?Q:b.error,null==j&&(j="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+j+")"),H(),!1;U=b.parsed_responses[0].rows,O=new Array,N=new Array,console.log("Running swapped cartoDB order (lng, lat)"),M=new Object;for(n in U){T=U[n],k=JSON.parse(T.st_asgeojson),q=k.coordinates[1],x=k.coordinates[0],O.push([q,x]);try{N.push(canonicalizePoint([q,x]))}catch(a){}X=T.genus+" "+T.specificepithet,null==M[X]&&(M[X]={positive:!1,negative:!1,no_confidence:!1,counts:{total:0,positive:0,negative:0,no_confidence:0}}),T.diseasedetected=function(){switch(T.diseasedetected.toString().toLowerCase()){case"true":return M[X].positive=!0,M[X].counts.positive++,"positive";case"false":return M[X].negative=!0,M[X].counts.negative++,"negative";default:return M[X].no_confidence=!0,M[X].counts.no_confidence++,T.diseasedetected.toString()}}(),M[X].counts.total++,G="",X!==T.originaltaxa&&(G="(<em>"+T.originaltaxa+"</em>)"),B='<google-map-marker latitude="'+q+'" longitude="'+x+'" data-disease-detected="'+T.diseasedetected+'">\n  <p>\n    <em>'+T.genus+" "+T.specificepithet+"</em> "+G+"\n    <br/>\n    Tested <strong>"+T.diseasedetected+"</strong> for "+T.diseasetested+"\n  </p>\n</google-map-marker>","positive"!==T.diseasedetected&&"negative"!==T.diseasedetected&&(T.diseasedetected="inconclusive"),$(".aweb-link-species[data-species='"+T.genus+" "+T.specificepithet+"']").attr("data-"+T.diseasedetected,"true"),A+=B}if(null==(null!=D?D.paths:void 0))try{_adp.canonicalHull=createConvexHull(O,!0)}catch(a){}for(l='<google-map id="transect-viewport" latitude="'+a.lat+'" longitude="'+a.lng+'" map-type="hybrid" zoom="'+L+'" class="col-xs-12 col-md-9 col-lg-6" api-key="'+gMapsApiKey+'">\n  '+A+"\n</google-map>",E="",F=a.sampling_months.split(","),v=0,y=0,r=F.length;y<r;y++)C=F[y],++v,v>1&&v===F.length?(F.length>2&&(E+=","),E+=" and "):v>1&&(E+=", "),isNumber(C)&&(C=dateMonthToString(C)),E+=C;for(v=0,Z="",_=a.sampling_years.split(","),v=0,I=0,s=_.length;I<s;I++)Y=_[I],++v,v>1&&v===_.length?(_.length>2&&(Z+=","),Z+=" and "):v>1&&(Z+=", "),Z+=Y;if(Z=1===_.length?"the year "+Z:"the years "+Z,g=new Date(toInt(a.sampled_collection_start)),h=new Date(toInt(a.sampled_collection_end)),d=dateMonthToString(g.getMonth())+" "+g.getFullYear()+" &#8212; "+dateMonthToString(h.getMonth())+" "+h.getFullYear(),z='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+l+'\n  <div class="col-xs-12 col-md-3 col-lg-6">\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken from '+d+'</p>\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken in '+E+'</p>\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were sampled in '+Z+'</p>\n    <p class="text-muted"><iron-icon icon="icons:language"></iron-icon> The effective project center is at ('+roundNumberSigfig(a.lat,6)+", "+roundNumberSigfig(a.lng,6)+") with a sample radius of "+a.radius+"m and a resulting locality <strong class='locality'>"+a.locality+'</strong></p>\n    <p class="text-muted"><iron-icon icon="editor:insert-chart"></iron-icon> The dataset contains '+a.disease_positive+" positive samples ("+roundNumber(100*a.disease_positive/a.disease_samples)+"%), "+a.disease_negative+" negative samples ("+roundNumber(100*a.disease_negative/a.disease_samples)+"%), and "+a.disease_no_confidence+" inconclusive samples ("+roundNumber(100*a.disease_no_confidence/a.disease_samples)+'%)</p>\n    <div class="download-buttons" id="data-download-buttons">\n      '+o+"\n    </div>\n  </div>\n</div>",z=z.replace(/NaN/gm,"0"),_adp.mapRendered!==!0&&($("#auth-block").append(z),setupMapMarkerToggles(),_adp.mapRendered=!0,!isNull(_adp.pageSpeciesList))){for(console.log("Creating CSV downloader for species list"),f=new Date,K={create:!0,downloadFile:"species-list-"+a.project_id+"-"+f.toISOString()+".csv",selector:".download-buttons",buttonText:"Download Species Stats",splitValues:" ",header:["Genus","Species","Subspecies","Positive Samples?","Negative Samples?","Inconclusive Samples?","Positive Count","Negative Count","Inconclusive Count","Totals"]},c=new Array,R=_adp.pageSpeciesList,P=0,t=R.length;P<t;P++){if(V=R[P],J=V.split(K.splitValues),J.length<3)for(;J.length<3;)J.push("");null!=M[V]?(J.push(M[V].positive.toString()),J.push(M[V].negative.toString()),J.push(M[V].no_confidence.toString()),J.push(M[V].counts.positive.toString()),J.push(M[V].counts.negative.toString()),J.push(M[V].counts.no_confidence.toString()),J.push(M[V].counts.total.toString())):(console.warn("CSV downloader couldn't find "+V+" in perTaxaStatus"),window.perTaxaStatus=M),c.push(J.join(K.splitValues))}downloadCSVFile(c,K)}for(bindClicks(".download-file"),sqlQueryBox(),$(".download-data-file").contextmenu(function(a){var b,c,d,f,g,h,i,j;return a.preventDefault(),console.log("Event details",a),f=$(this).offset(),u='<paper-material class="ark-context-wrapper" style="top:'+a.pageY+"px;left:"+a.pageX+'px;position:absolute">\n  <paper-menu class=context-menu">\n    <paper-item class="copy-ark-context">\n      Copy ARK to clipboard\n    </paper-item>\n  </paper-menu>\n</paper-material>',$(".ark-context-wrapper").remove(),$("body").append(u),getMapZoom(N,"#transect-viewport"),ZeroClipboard.config(_adp.zcConfig),j=new ZeroClipboard($(".copy-ark-context").get(0)),e=$(this).attr("data-ark"),i="http://biscicol.org/id/"+e,c={dataType:"text/plain",data:i,"text/plain":i},j.setData(c),j.on("aftercopy",function(a){return a.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):(console.error("ZeroClipboard had an error - ",a),console.warn(c),toastStatusMessage("Error copying to clipboard"))}),j.on("error",function(a){var b;return console.error("Initial error"),b=new ZeroClipboard($(".copy-ark-context").get(0)),d(b)}),d=function(a,b){var e;null==a&&(a=j),null==b&&(b=null);try{return e=new ClipboardEvent("copy",c),document.dispatchEvent(e),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(a){p=a,console.error("Error creating copy: "+p.message),console.warn(p.stack),console.warn("Can't use HTML5")}return a.setData(c),isNull(b)||b.setData(c),a.on("aftercopy",function(a){return a.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):(console.error("ZeroClipboard had an error - ",a),console.warn(c),toastStatusMessage("Error copying to clipboard"))}),a.on("error",function(b){if(console.error("Error copying to clipboard"),console.warn("Got",b),"flash-overdue"===b.name){if(_adp.resetClipboard===!0)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,a=new ZeroClipboard($(".copy-ark-context").get(0)),d(a)})}if("flash-disabled"===b.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),toastStatusMessage("Clipboard copying isn't available on your system")})},g=function(a){return $(this).addClass("iron-selected"),!1},h=function(a){return $(this).removeClass("iron-selected"),!1},b=this,$(".ark-context-wrapper paper-item").hover(g,h).click(function(){return _adp.resetClipboard=!1,$(".ark-context-wrapper").remove(),!1}).contextmenu(function(){return $(".ark-context-wrapper").remove(),!1}),!1}),checkArkDataset(a),setPublicData(a),S=$(".aweb-link-species"),W=0,w=S.length;W<w;W++)i=S[W],m=$(i).attr("data-positive").toBool(),m&&$(i).attr("data-negative","false").attr("data-inconclusive","false");return console.info("Carto lookup complete"),H(),stopLoad()}).fail(function(a,b){return console.error("Couldn't render map and carto data"),console.error(a,b),H(),stopLoadError("Couldn't render map")}),!1},postAuthorizeRender=function(a,b){var c,d,e,f,g,h,i,j,k;a.public&&console.info("Project is already public, not rerendering"),startLoad(),console.info("Should render stuff",a),i=c="",b.can_edit&&(i='<paper-icon-button icon="icons:create" class="authorized-action" data-href="'+uri.urlString+"admin-page.html?id="+a.project_id+'" data-toggle="tooltip" title="Edit Project"></paper-icon-button>'),c='<paper-icon-button icon="icons:dashboard" class="authorized-action" id="show-actions" data-href="'+uri.urlString+'admin-page.html" data-toggle="tooltip" title="Administration Dashboard"> </paper-icon-button>',$("#title").append(i),d=JSON.parse(a.author_data),showEmailField(d.contact_email);try{isNull(a.technical_contact)||isNull(a.technical_contact_email)||(k="Technical Contact "+a.technical_contact,showEmailField(a.technical_contact_email,k,"technical-email-send"))}catch(a){}if(bindClicks(".authorized-action"),g=a.carto_id,"object"!=typeof g)try{e=JSON.parse(deEscape(g))}catch(a){h=a,j=h.message;try{e=JSON.parse(g)}catch(a){if(h=a,g.length>511&&(f=fixTruncatedJson(g),"object"==typeof f&&(console.debug("The carto data object was truncated, but rebuilt."),e=f)),isNull(e))return console.error("cartoObj must be JSON string or obj, given",g),console.warn("Cleaned obj:",deEscape(g)),console.warn("Told '"+j+"' then",h.message),stopLoadError("Couldn't parse data"),!1}}else e=g;renderMapWithData(a);try{prepParsedDataDownload(a)}catch(a){}return!1},kmlLoader=function(a,b){var c,d,e,f,g;try{if("object"==typeof a)e=a,a=e.path;else try{e=JSON.parse(a),a=e.path}catch(b){e={path:a}}console.debug("Loading KML file",a)}catch(a){}if(geo.inhibitKMLInit=!0,d=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(g=_adp.lastMod)?g.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),!$("google-map").exists()){if(c='<google-map id="transect-viewport" class="col-xs-12 col-md-9 col-lg-6 kml-lazy-map" api-key="'+gMapsApiKey+'" map-type="hybrid">\n</google-map>',f='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+c+"\n</div>",!$("#auth-block").exists())return console.warn("Couldn't find an authorization block to render the KML map in!"),!1;$("#auth-block").append(f),_adp.mapRendered=!0}return loadJS(d,function(){return initializeParser(null,function(){return loadKML(a,function(){var c,d;try{if(d=geo.kml.parser.docsByUrl[a],isNull(d)&&(a="/"+a,d=geo.kml.parser.docsByUrl[a],isNull(d)&&(console.warn("Could not resolve KML by url, using first doc"),d=geo.kml.parser.docs[0])),isNull(d))return allError("Bad KML provided"),!1;console.debug("Using parsed data from path '"+a+"'",d),"function"==typeof b?b(d):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(a){c=a,allError("There was a importing the data from this KML file"),console.warn(c.message),console.warn(c.stack)}return!1}),!1}),!1}),!1},copyLink=function(a,b,c){var d,e,f,g,h;if(null==a&&(a=_adp.zcClient),null==c&&(c=!0),d=p$(".ark-identifier").value,c)try{return h="http://biscicol.org/id/"+d,f={dataType:"text/plain",data:h,"text/plain":h},e=new ClipboardEvent("copy",f),document.dispatchEvent(e),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(a){g=a,console.error("Error creating copy: "+g.message),console.warn(g.stack)}return console.warn("Can't use HTML5"),null!=a?(a.setData(f),null!=b&&b.setData(f),a.on("aftercopy",function(a){return toastStatusMessage(a.data["text/plain"]?"ARK resolver path copied to clipboard":"Error copying to clipboard")}),a.on("error",function(a){if(console.error("Error copying to clipboard"),console.warn("Got",a),"flash-overdue"===a.name){if(_adp.resetClipboard===!0)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,copyLink()}),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0))}if("flash-disabled"===a.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),$("#copy-ark").tooltip("destroy").remove(),$(".ark-identifier").removeClass("col-xs-9 col-md-11").addClass("col-xs-12"),toastStatusMessage("Clipboard copying isn't available on your system")})):console.error("Can't use HTML, and ZeroClipboard wasn't passed"),!1},searchProjects=function(){var a,b,c,d;return d=$("#project-search").val(),isNull(d)?($("google-map-poly").removeAttr("hidden"),!1):(c=p$("#search-filter").selectedItem,b=$(c).attr("data-cols"),console.info("Searching on "+d+" ... in "+b),a="action=search_project&q="+d+"&cols="+b,$.post(uri.urlString+"api.php",a,"json").done(function(a){var b,c,e,f,g,h,i,j,k,l,m,n,o,p,q;if(console.info(a),c="",q=new Array,l=Object.toArray(a.result),l.length>0)for(f=0,h=l.length;f<h;f++)j=l[f],q.push(j.project_id),m=j.public.toBool(),e=m?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',b='<button class="btn btn-info search-proj-link" data-href="'+uri.urlString+"project.php?id="+j.project_id+'" data-toggle="tooltip" data-placement="right" title="Project #'+j.project_id.slice(0,8)+'...">\n  '+e+" "+j.project_title+"\n</button>",c+="<li class='project-search-result'>"+b+"</li>";else p=null!=(n=a.search)?n:d,c='<p><em>No results found for "<strong>'+p+'</strong>"';for($("#project-result-container").html(c),bindClicks(".search-proj-link"),$("google-map-poly").attr("hidden","hidden"),o=[],g=0,i=q.length;g<i;g++)k=q[g],o.push($("google-map-poly[data-project='"+k+"']").removeAttr("hidden"));return o}).fail(function(a,b){return console.error(a,b)}),!1)},setPublicData=function(a){return publicData=a,!1},renderPublicMap=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;null==a&&(a=publicData);try{if(a.public.toBool())return console.info("Not rendering low-data public map for public project"),!1}catch(b){return console.error("Invalid project data passed!"),console.warn(a),!1}try{console.info("Working with limited data",a),b=a.carto_id,o=b.bounding_polygon,null==o.fillColor&&(o.fillColor="#ff7800"),null==o.fillOpacity&&(o.fillOpacity=.35),j='<google-map-poly closed fill-color="'+o.fillColor+'" fill-opacity="'+o.fillOpacity+'" stroke-weight="1">',r=new Array,c=getPointsFromBoundingBox(a),null==c[0].lat&&(c=getCorners(c)),l={lat:c[0].lat,lng:c[0].lng},k={lat:c[1].lat,lng:c[1].lng},p={lat:c[2].lat,lng:c[2].lng},q={lat:c[3].lat,lng:c[3].lng},m=[l,k,p,q];try{s=getMapZoom(c,"#transect-viewport"),console.info("Got public zoom",s)}catch(a){s=""}for(g=0,h=m.length;g<h;g++)n=m[g],indexOf.call(r,n)<0&&(r.push(n),j+='<google-map-point latitude="'+n.lat+'" longitude="'+n.lng+'"> </google-map-point>');j+="    </google-map-poly>",i=getMapCenter(c),f='<div class="row" id="public-map">\n  <h2 class="col-xs-12">Project Area of Interest</h2>\n  <google-map id="transect-viewport" latitude="'+i.lat+'" longitude="'+i.lng+'" map-type="hybrid" zoom="'+s+'" class="col-xs-12 col-md-9 col-lg-6 center-block clearfix public-fuzzy-map"  api-key="'+gMapsApiKey+'">\n        '+j+"\n  </google-map>\n</div>",$("#auth-block").append(f);try{return s=getMapZoom(m,"#transect-viewport"),p$("#transect-viewport").zoom=s}catch(a){e=a;try{return s=getMapZoom(c,"#transect-viewport"),p$("#transect-viewport").zoom=s}catch(a){}}}catch(a){return d=a,stopLoadError("Couldn't render map"),console.error("Map rendering error - "+d.message),console.warn(d.stack)}},checkArkDataset=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;if(null==b&&(b=!1),null==c&&(c=!1),"undefined"!=typeof _adp&&null!==_adp||(window._adp=new Object),l=uri.o.attr("fragment"),k=l.split(","),c||null==_adp.fragmentData){for(console.info("Examining fragment list"),h=new Object,m=0,o=k.length;m<o;m++)d=k[m],s=d.split(":"),h[s[0]]=s[1];_adp.fragmentData=h}if(j=null!=(t=_adp.fragmentData)?t.dataset:void 0,null==j)return!1;for(console.info("Checking  ARK identifiers for dataset "+j+" ..."),f=a.dataset_arks.split(","),g="",q=!1,n=0,p=f.length;n<p;n++)if(e=f[n],e.search(j)!==-1){g=e,q=!0;break}return q!==!0?(console.warn("Could not find matching dataset in",f),!1):(h=g.split("::"),i=h[1],console.info("Got matching identifier "+g+" -> "+i),u=".download-file[data-href*='"+i+"']",u=$(u).get(0),b?(v=$(u).attr("data-href"),openTab(v)):($(u).removeClass("btn-xs btn-primary").addClass("btn-success success-glow").click(function(){return $(this).removeClass("success-glow")}),r={behavior:"smooth",block:"start"},$(u).get(0).scrollIntoView(!1)),u)},prepParsedDataDownload=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;if(i=new Date,l={selector:"#data-download-buttons",create:!0,objectAsValues:!0,buttonText:"Download Parsed Dataset",downloadFile:"datalist-"+a.project_id+"-"+i.toISOString()+".csv"},m=new Object,f=a.carto_id,"object"!=typeof f)try{d=JSON.parse(deEscape(f))}catch(a){j=a,k=j.message;try{d=JSON.parse(f)}catch(a){if(j=a,f.length>511&&(e=fixTruncatedJson(f),"object"==typeof e&&(console.debug("The carto data object was truncated, but rebuilt."),d=e)),isNull(d))return console.error("cartoObj must be JSON string or obj, given",f),console.warn("Cleaned obj:",deEscape(f)),console.warn("Told '"+k+"' then",j.message),stopLoadError("Couldn't parse data"),!1}}else d=f;return h=d.table,isNull(h)?(console.warn("WARNING: This project has no data associated with it. Not creating download."),!1):(g="SELECT *, ST_asGeoJSON(the_geom) FROM "+h+";",console.info("Would ping cartodb with",g),b=encodeURIComponent(encode64(g)),c="action=fetch&sql_query="+b,_adp.dataPoints=new Array,$.post("api.php",c,"json").done(function(a){var b,c,d,e,f,g,h,i,j,k,m,n,o,p;if(!a.status)return f=null!=(n=a.human_error)?n:a.error,null==f&&(f="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+f+")"),!1;p=a.parsed_responses[0].rows,e=new Array;for(i in p){o=p[i],h=JSON.parse(o.st_asgeojson),j=h.coordinates[1],k=h.coordinates[0],c={lat:j,lng:k},m=canonicalizePoint(c),_adp.dataPoints.push(m),o.decimalLatitude=j,o.decimalLongitude=k,delete o.st_asgeojson;try{try{g=JSON.parse(o.fimsextra)}catch(a){g=o.fimsextra}if("object"==typeof g){for(b in g)d=g[b],o[b]=d;delete o.fimsextra}}catch(a){}delete o.cartodb_id,delete o.id,delete o.the_geom,delete o.the_geom_webmercator,e.push(o)}return downloadCSVFile(e,l)}).fail(function(a,b){return console.error("Couldn't create"),console.error(a,b)}),!1)},sqlQueryBox=function(){var a,b,c,d,e,f;return null==_adp.cartoDataParsed?(console.error("CartoDB data not available. Are you logged in?"),!1):(c=function(a){var b;return animateLoad(),console.info("Querying with"),console.log(a),b="action=fetch&sql_query="+post64(a),_adp.currentAsyncJqxhr=$.post("api.php",b,"json").done(function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(console.log(a),a.status!==!0)return c=null!=(k=null!=(l=a.human_error)?l:a.error)?k:"Unknown error",console.error(c),e=function(){switch(c){case"UNAUTHORIZED_QUERY_TYPE":return a.query_type;default:return d="(no details for error "+a.error+")"}}(),$("#query-immediate-result").text(c+": "+e),$(".do-sql-query").removeAttr("disabled"),stopLoad(),!1;try{j=JSON.parse(a.post_response[0])}catch(a){return b=a,console.error("Error parsing result"),$("#query-immediate-result").text("Error parsing result from CartoDB"),$(".do-sql-query").removeAttr("disabled"),stopLoad(),!1}if(null!=j.error)return console.error("Error in result: "+j.error),$("#query-immediate-result").text(j.error),$(".do-sql-query").removeAttr("disabled"),stopLoad(),!1;console.log("Using responses",a.parsed_responses),i="",m=a.parsed_responses;for(g in m){n=m[g],h=toInt(g)+1,i+="#"+h+": ";try{f=JSON.stringify(n.rows),i+='<code class="language-json">'+f+"</code>"}catch(a){i+="BAD QUERY"}i+="\n\n"}$("#query-immediate-result").html(i);try{Prism.highlightAll(!0)}catch(a){}return $(".do-sql-query").removeAttr("disabled"),stopLoad(),!1}).error(function(){return $("#query-immediate-result").text("Error executing query"),$(".do-sql-query").removeAttr("disabled"),stopLoadError()}),!1},a=function(a,b){var c,d;return null==b&&(b=!1),c=a.trim(),d=c.replace(/@@/gim,_adp.cartoDataParsed.table),d=d.replace(/!@/gim,"SELECT * FROM "+_adp.cartoDataParsed.table),b||$("#query-input").val(d),d},d=function(){return!1},e=function(){return!1},$("#project-sql-query-box").exists()||(b='<div id="project-sql-query-box" class="row">\n  <h2 class="col-xs-12">Raw Project Queries</h2>\n  <textarea class="form-control code col-xs-10 col-xs-offset-1" rows="3" id="query-input" placeholder="SQL Query" aria-describedby="query-cheats"></textarea>\n  <div class="col-xs-12">\n    <label class="text-muted col-xs-2 col-md-1" for="interpreted-query">Real Query:</label>\n    <code class="language-sql col-xs-10 col-md-11" id="interpreted-query">\n    </code>\n  </div>\n  <div class="col-xs-12 col-sm-9">\n    <span class="text-muted" id="query-cheats">Tips: <ol><li>You\'re querying PostgreSQL</li><li>Type <kbd>@@</kbd> as a placeholder for the table name</li><li>Type <kbd>!@</kbd> as a placeholder for <code>SELECT * FROM @@</code></li><li>Multiple queries at once is just fine. They\'re broken at <kbd>);</kbd>, so enclosing your <code>WHERE</code> in parentheses is good enough.</li></ol></span>\n  </div>\n  <div class="col-xs-12 col-sm-3">\n    <button class="btn btn-default do-sql-query pull-right">Execute Query</button>\n  </div>\n  <h3 class="col-xs-12">Result:</h3>\n  <pre class="code col-xs-12" id="query-immediate-result"></pre>\n</div>',$("h2.project-identifier").exists()?$("h2.project-identifier").before(b):$("main").append(b)),f=function(){var b,d;return console.info("Executing query ..."),b=$("#query-input").val(),d=a(b),d.search(_adp.cartoDataParsed.table)===-1?(console.error("Query didn't specify a table!"),toastStatusMessage("You forgot to include the table identifier in your query."),!1):($(".do-sql-query").attr("disabled","disabled"),c(d))},$("#query-input").keyup(function(b){var c,d;if(c=b.keyCode?b.keyCode:b.which,13===c){try{b.preventDefault()}catch(a){}f()}else d=a($(this).val(),!0),$("code#interpreted-query").text(d),Prism.highlightElement($("code#interpreted-query")[0],!0);return!1}),$(".do-sql-query").click(function(){return f()}),!1)},showCitation=function(){var a;return a=p$("paper-input[label='DOI']").value,$("#citation-pop").exists()?p$("#citation-pop").open():(animateLoad(),fetchCitation(a,function(a,b){var c,d,e;try{e=isNull(b)?"":'<paper-button class="click" data-newtab="true" data-href="'+b+'">\n  <iron-icon icon="icons:open-in-new"></iron-icon>\n  Open\n</paper-button>',d='<paper-dialog id="citation-pop" modal>\n  <h2>Citation</h2>\n  <paper-dialog-scrollable>\n    <div class="pop-contents">\n      <paper-textarea label="Citation" id="popped-citation" readonly>\n        '+a+'\n      </paper-textarea>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="copy-citation" class="click-copy" data-copy-selector="#popped-citation">\n      <iron-icon icon="icons:content-copy"></iron-icon>\n      Copy Citation\n    </paper-button>\n    <paper-button id="copy-doi" class="click-copy" data-copy-selector="#doi-input">\n      <iron-icon icon="icons:content-copy"></iron-icon>\n      Copy DOI\n    </paper-button>\n    '+e+"\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>",$("body").append(d);try{p$("#popped-citation").value=a}catch(b){delay(500,function(){try{return p$("#popped-citation").value=a}catch(a){}})}return bindClicks(),bindCopyEvents(),safariDialogHelper("#citation-pop"),stopLoad()}catch(a){c=a,console.error("Couldn't show citation - "+c.message);try{return p$("#citation-pop").open()}catch(a){return stopLoadError("Failed to display citation")}}})),!1},window.showCitation=showCitation,$(function(){var a;_adp.projectId=uri.o.param("id"),checkProjectAuthorization(),$("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),goTo(uri.urlString+"project.php?id="+a)}),$("#project-search").unbind().keyup(function(){return searchProjects.debounce()}),$("paper-radio-button").click(function(){var a;return a=$(this).attr("data-cue"),$("#project-search").attr("placeholder",a),searchProjects.debounce()}),a={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},_adp.zcConfig=a,ZeroClipboard.config(a),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0)),$("#copy-ark").click(function(){return copyLink(_adp.zcClient)}),checkFileVersion(!1,"js/project.js"),$("#toggle-project-viewport").click(function(){return $(".project-list-page").toggleClass("hidden-xs"),$(".project-search").hasClass("hidden-xs")?$(this).text("Show Project Search"):$(this).text("Show Project List")}),$("#community-map google-map-poly").on("google-map-poly-click",function(a){var b,c;return c=$(this).attr("data-project"),b=uri.urlString+"project.php?id="+c,goTo(b),!1}),$("#community-map").on("google-map-ready",function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;try{fillSorterWithDropdown()}catch(a){}if(k=p$("#community-map"),null!=_adp.aggregateHulls){for(c=new Array,f=Object.toArray(_adp.aggregateHulls),g=0,i=f.length;g<i;g++)for(e=f[g],n=Object.toArray(e),h=0,j=n.length;h<j;h++)m=n[h],a=isNull(m.lat)||90===Math.abs(m.lat),b=isNull(m.lng)||180===Math.abs(m.lng),a||b||(l=new Point(m.lat,m.lng),c.push(l));console.info("Adjusting zoom from "+k.zoom),o=getMapZoom(c,"#community-map"),console.info("Calculated new zoom "+o);try{d=getMapCenter(c),k.latitude=d.lat,k.longitude=d.lng,console.info("Recentered map")}catch(a){}k.zoom=o}return!1});try{return $(".self-citation").click(function(){return $(this).selectText(),!1})}catch(a){}}),$(function(){return console.log("Loaded dashboard"),!1});var checkCoordinateSanity,createOverflowMenu,createTemplateByProject,doDeepSearch,doSearch,firstLoadInstructionPrompt,generateColorByRecency,generateColorByRecency2,getPrettySpecies,getProjectResultDialog,getSampleSummaryDialog,getSearchContainsObject,getSearchObject,namedMapAdvSource,namedMapSource,resetMap,setViewerBounds,showAllTables,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};namedMapSource="adp_generic_heatmap-v16",namedMapAdvSource="adp_specific_heatmap-v15";try{p$("#exact-species-search").checked&&(namedMapAdvSource="adp_specific_exact_heatmap-v1")}catch(a){}checkCoordinateSanity=function(){var a,b;return b=!0,a={n:toFloat($("#north-coordinate").val()),w:toFloat($("#west-coordinate").val()),s:toFloat($("#south-coordinate").val()),e:toFloat($("#east-coordinate").val())},console.log("User Bounds",a),a.n>a.s||(b=!1,$(".lat-input").parent().addClass("has-error")),a.e>a.w||(b=!1,$(".lng-input").parent().addClass("has-error")),b?($(".coord-input").parent().removeClass("has-error"),$(".do-search").removeAttr("disabled"),!0):($(".do-search").attr("disabled","disabled"),!1)},createTemplateByProject=function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a&&(a="t2627cbcbb4d7597f444903b2e7a5ce5c_6d6d454828c05e8ceea03c99cc5f5"),null==b&&(b=!1),j=Date.now(),null==(null!=(i=window._adp)?i.templateReady:void 0)&&(null==window._adp&&(window._adp=new Object),window._adp.templateReady=new Object,window._adp.templates=new Object),f=!1,"object"==typeof a){if(isNull(a.table))return console.error("Couldn't create template for project -- undefined table",a),!1;isNull(a.project)?a=a.table:(g=a.project,a=a.table,f=!0)}if(k="infowindow_template_"+a.slice(0,63),$("#"+k).exists()){if(b)return"function"==typeof c&&c(),!1;$("#"+k).remove()}return window._adp.templateReady[a]=!1,h="SELECT cartodb_id FROM "+a+" LIMIT 1",d="action=fetch&sql_query="+post64(h),e=function(a,d,e){var f,g,h;return f=b?"":'<p>Tested {{content.data.diseasetested}} as <strong>{{content.data.diseasedetected}}</strong> (Fatal: <strong>{{content.data.fatal}}</strong>)</p><p><span class="date-group">Sample was taken in <span class="unix-date">{{content.data.dateidentified}}</span>.</span></p>',h='<script type="infowindow/html" id="'+d+'">\n  <div class="cartodb-popup v2">\n    <a href="#close" class="cartodb-popup-close-button close">x</a>\n    <div class="cartodb-popup-content-wrapper">\n      <div class="cartodb-popup-header">\n        <h2>Sample Info</h2>\n      </div>\n      <div class="cartodb-popup-content">\n        <!-- content.data contains the field info -->\n        <h4>Species: </h4>\n        <p><i>{{content.data.genus}} {{content.data.specificepithet}}</i></p>\n        '+f+'\n        <p><a href="https://amphibiandisease.org/project.php?id='+a+'">View Project</a></p>\n      </div>\n    </div>\n    <div class="cartodb-popup-tip-container"></div>\n  </div>\n</script>',$("head").append(h),window._adp.templates[e]=h,window._adp.templates[e.slice(0,63)]=h,
window._adp.templateReady[e]=!0,g=Date.now()-j,console.info("Template set for #"+d+" (took "+g+"ms)"),"function"==typeof c&&c(),!1},f?(console.info("Directly provided project id"),e(g,k,a),!1):(console.info("Creating template after pinging API endpoint"),$.post(uri.urlString+"api.php",d,"json").done(function(b){var c,d,f;return c=null!=(d=b.parsed_responses)&&null!=(f=d[0])?f.project_id:void 0,isNull(c)?console.warn("Couldn't find project ID for table "+a,b):e(c,k,a)}),!1)},setViewerBounds=function(a){var b,c,d;return null==a&&(a=geo.lMap),b=a.getBounds(),d=b._southWest,c=b._northEast,c.lng-d.lng>360&&(d.lng=-180,c.lng=180),$("#north-coordinate").val(c.lat),$("#west-coordinate").val(d.lng),$("#south-coordinate").val(d.lat),$("#east-coordinate").val(c.lng),!1},getSearchObject=function(){var a,b,c,d,e;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(a){}return a={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},e={sampled_species:{data:$("#taxa-input").val().toLowerCase()},bounding_box_n:{data:a.n,search_type:"<="},bounding_box_e:{data:a.e,search_type:"<="},bounding_box_w:{data:a.w,search_type:">="},bounding_box_s:{data:a.s,search_type:">="}},b=$(p$("#disease-status").selectedItem).attr("data-search"),"*"!==b&&(e.disease_positive={data:0,search_type:b.toBool()?">":"="}),c=$(p$("#morbidity-status").selectedItem).attr("data-search"),"*"!==c&&(e.disease_morbidity={data:0,search_type:c.toBool()?">":"="}),d=$(p$("#pathogen-choice").selectedItem).attr("data-search"),"*"!==d&&(e.disease={data:d}),e},getSearchContainsObject=function(){var a,b,c,d,e,f,g,h,i,j;try{p$("#use-viewport-bounds").checked&&setViewerBounds()}catch(a){}return a={n:$("#north-coordinate").val(),w:$("#west-coordinate").val(),s:$("#south-coordinate").val(),e:$("#east-coordinate").val()},i=$("#taxa-input").val().toLowerCase(),j=i.split(" "),h=3===j.length?j.pop():"",g=2===j.length?j.pop():"",c=1===j.length?j.pop():"",f={sampled_species:{data:i,genus:c,species:g,subspecies:h},bounding_box_n:{data:a.s,search_type:">"},bounding_box_e:{data:a.w,search_type:">"},bounding_box_w:{data:a.e,search_type:"<"},bounding_box_s:{data:a.n,search_type:"<"}},b=$(p$("#disease-status").selectedItem).attr("data-search"),"*"!==b&&(f.disease_positive={data:0,search_type:b.toBool()?">":"="}),d=$(p$("#morbidity-status").selectedItem).attr("data-search"),"*"!==d&&(f.disease_morbidity={data:0,search_type:d.toBool()?">":"="}),e=$(p$("#pathogen-choice").selectedItem).attr("data-search"),"*"!==e&&(f.disease={data:e}),f},doSearch=function(a,b,c){var d,e,f,g;return null==a&&(a=getSearchObject()),null==b&&(b=!1),null==c&&(c=!1),startLoad(),$("#post-map-subtitle").removeClass("bg-success"),f=jsonTo64(a),d="advanced_project_search",g=b?namedMapAdvSource:namedMapSource,e="perform="+d+"&q="+f,$.post(uri.urlString+"admin-api.php",e,"json").done(function(d){var e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U;if(console.info("Adv. search result",d),d.status!==!0)return console.error(d.error),stopLoadError("There was a problem fetching the results"),!1;if(G=Object.toArray(d.result),0===G.length)return I=function(b){var c,d;return null==b&&(b=!1),console.warn("The search failed!"),isNull(null!=(d=a.sampled_species)?d.data:void 0)||(c='<span id="taxa-input-error" class="help-block">\n  Invalid taxon: Please check your spelling. <a href="http://amphibiaweb.org/search/index.html" class="click" data-newtab="true">Check AmphibiaWeb for valid taxa</a>\n</span>',b&&(c='<span id="taxa-input-error" class="help-block">\n  No matching samples found.\n</span>'),$("#taxa-input-container").addClass("has-error"),$("#taxa-input-error").remove(),$("#taxa-input").attr("aria-describedby","taxa-input-error").after(c).keyup(function(){try{return $("#taxa-input-container").removeClass("has-error"),$("#taxa-input-error").remove()}catch(a){}}),bindClicks()),console.warn("No results"),stopLoadError("No results"),!1},isNull(null!=(B=a.sampled_species)?B.data:void 0)||c?(console.warn("No need to validate",isNull(null!=(E=a.sampled_species)?E.data:void 0),c),I(!0)):(console.warn("The initial search failed, we're going to validate the taxon and re-check"),P=a.sampled_species.data,O=P.split(" "),N={genus:null!=(C=O[0])?C:"",species:null!=(D=O[1])?D:""},validateAWebTaxon(N,function(a){var c,d;return a.invalid===!0?(console.error("This taxon is invalid!",a),I(),!1):(d=a.genus+" "+a.species+" "+(null!=(c=a.subspecies)?c:""),d=d.trim(),$("#taxa-input").val(d),doSearch(getSearchObject(),b,!0),!1)})),!1;if(b)return doDeepSearch(G,g),!1;for(R=0,z=0,S=new Array,u=new Array,e={n:-90,s:90,e:-180,w:180},o=0,console.info("Using standard named map "+g),p=0,v=G.length;p<v;p++){for(A=G[p],A.bounding_box_n>e.n&&(e.n=A.bounding_box_n),A.bounding_box_e>e.e&&(e.e=A.bounding_box_e),A.bounding_box_s<e.s&&(e.s=A.bounding_box_s),A.bounding_box_w<e.w&&(e.w=A.bounding_box_w),R+=A.disease_samples,z+=A.disease_positive,J=A.sampled_species.split(","),q=0,w=J.length;q<w;q++)K=J[q],K=K.trim(),indexOf.call(S,K)<0&&S.push(K);if(null==(null!=(F=A.carto_id)?F.table:void 0))try{i=JSON.parse(A.carto_id),h=new Object;for(r in i){T=i[r],j=r.replace("&#95;","_");try{k=T.replace("&#95;","_")}catch(a){k=T}h[j]=k}A.carto_id=h}catch(a){}try{M=A.carto_id.table,M=M.unescape()}catch(a){}if(isNull(M))console.warn("Unable to get a table id from this carto data:",A.carto_id);else{try{Q={project:A.project_id,table:M},createTemplateByProject(Q)}catch(a){m=a,console.error("Warning: couldn't create project template: "+m.message),console.warn(m.stack)}t={name:g,type:"namedmap",layers:[{layer_name:"layer-"+u.length}],params:{table_name:M,color:"#FF6600"}},u.push(t)}G[o]=A,++o}try{f=[[e.n,e.w],[e.n,e.e],[e.s,e.e],[e.s,e.w]],y=getMapCenter(f),U=getMapZoom(f,".map-container"),console.info("Found @ zoom = "+U+" center",y,"for bounding box",f),null!=geo.lMap&&(geo.lMap.once("zoomend",function(a){return function(){return console.info("ZoomEnd is ensuring centering"),n(0)}}(this)),geo.lMap.setZoom(U));try{p$("#global-data-map").latitude=y.lat,p$("#global-data-map").longitude=y.lng,p$("#global-data-map").zoom=U}catch(a){}try{geo.lMap.setView(y.getObj())}catch(a){}}catch(a){m=a,console.warn("Failed to rezoom/recenter map - "+m.message,f),console.warn(m.stack)}L=S.length,console.info("Projects containing your search returned "+R+" ("+z+" positive) among "+L+" species",e);try{for(resetMap(geo.lMap,!1,!1),s=0,x=u.length;s<x;s++)t=u[s],(l=function(a,b){var c,d,e,f;return(null!=(e=window._adp)&&null!=(f=e.templateReady)?f[b.params.table_name]:void 0)===!0||(a>50?(console.error("Error -- timed out waiting for template to be ready"),d=!0):d=!1,d)?(console.info("Template script ready for table '"+window._adp.templateReady[b.params.table_name]+"' after "+a+" iterations, rendering on map"),c={user_name:cartoAccount,type:"namedmap",named_map:b},createRawCartoMap(c),!1):(delay(50,function(){return++a,l(a,b)}),!1)})(0,t);$("#post-map-subtitle").text("Viewing projects containing "+R+" samples ("+z+" positive) among "+L+" species"),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),$(".show-result-list").remove(),H='<paper-icon-button class="show-result-list" icon="icons:subject" data-toggle="tooltip" title="Show Project list" raised></paper-icon-button>',$("#post-map-subtitle").append(H),getProjectResultDialog(G),(n=function(a,b,c){var d,e,f,g,h,i,j,k;i=roundNumber(y.lat,3),j=roundNumber(y.lng,3);try{e=roundNumber(p$("#global-data-map").latitude,3),f=roundNumber(p$("#global-data-map").longitude,3),d={type:"google-map-element",lat:e,lng:f}}catch(a){}try{d=geo.lMap.getCenter(),e=roundNumber(d.lat,3),f=roundNumber(d.lng,3)}catch(a){}return g=100*Math.abs((e-i)/i),h=100*Math.abs((f-j)/j),g<2&&h<2&&a>5?(console.info("Correctly centered",y,d,[g,h]),geo.lMap.getZoom()!==U&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(a<=15||console.warn("Centering too deviant",g<2,h<2,g<2&&h<2,e,f,i,j),isNumber(b)||(b=100),a>b?(k=c*b,console.info("Map could not be correctly centered in "+k+"ms"),clearTimeout(_adp.centerTimeout),!1):(++a,_adp.centerTimeout=delay(c,function(){isNumber(b)||(b=100);try{p$("#global-data-map").latitude=y.lat,p$("#global-data-map").longitude=y.lng}catch(a){}try{console.log("#"+a+"/"+b+" General setting view to",y.getObj(),[g,h]),geo.lMap.setView(y.getObj())}catch(a){m=a,console.warn("Error setting view - "+m.message)}if(a<b)return n(a)})))})(0,100,100)}catch(a){m=a,console.error("Couldn't create map! "+m.message),console.warn(m.stack)}return stopLoad(),!1}).fail(function(a,b){return console.error(a,b),console.warn("Attempted to do",uri.urlString+"admin-api.php?"+e),stopLoadError("Server error, couldn't perform search")}),!1},doDeepSearch=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z;null==b&&(b=namedMapAdvSource),p=!0;try{for(N=getSearchContainsObject(),W=0,E=0,X=new Array,x=new Array,d={n:-90,s:90,e:-180,w:180},q=0,console.info("Using deep named map "+b),j="",null!=(null!=(H=N.disease_positive)?H.data:void 0)&&(j=">"===N.disease_positive.search_type?"true":"false"),n="",null!=(null!=(I=N.disease_morbidity)?I.data:void 0)&&(">"===N.disease_morbidity.search_type?(n="and fatal = true",o=!0):(n="and fatal = false",o=!1)),D="",null!=(null!=(J=N.disease)?J.data:void 0)&&(D=function(){switch(N.disease.data){case"Batrachochytrium dendrobatidis":return"bd";case"Batrachochytrium salamandrivorans":return"bsal";default:return""}}()),G=new Object,B=getSearchObject(),r=0,y=a.length;r<y;r++){for(F=a[r],B.bounding_box_n.data>d.n&&(d.n=B.bounding_box_n.data),B.bounding_box_e.data>d.e&&(d.e=B.bounding_box_e.data),B.bounding_box_s.data<d.s&&(d.s=B.bounding_box_s.data),B.bounding_box_w.data<d.w&&(d.w=B.bounding_box_w.data),W+=F.disease_samples,E+=F.disease_positive,O=F.sampled_species.split(","),s=0,z=O.length;s<z;s++)Q=O[s],Q=Q.trim(),indexOf.call(X,Q)<0&&X.push(Q);if(null==(null!=(K=F.carto_id)?K.table:void 0))try{g=JSON.parse(F.carto_id),f=new Object;for(t in g){Y=g[t],h=t.replace("&#95;","_");try{i=Y.replace("&#95;","_")}catch(a){i=Y}f[h]=i}F.carto_id=f}catch(a){}try{T=F.carto_id.table,T=T.unescape()}catch(a){}if(isNull(T))console.warn("Unable to get a table id from this carto data:",F.carto_id);else{try{V={project:F.project_id,table:T},createTemplateByProject(V)}catch(a){l=a,console.error("Warning: couldn't create project template: "+l.message),console.warn(l.stack)}v={name:b,type:"namedmap",layers:[{layer_name:"layer-"+x.length}],params:{table_name:T,color:"#FF6600",genus:N.sampled_species.genus,specific_epithet:N.sampled_species.species,disease_detected:j,morbidity:n,pathogen:D}},x.push(v),G[T]={id:F.project_id,name:F.project_title}}a[q]=F,++q}try{e=[[d.n,d.w],[d.n,d.e],[d.s,d.e],[d.s,d.w]],C=getMapCenter(e),Z=getMapZoom(e,".map-container"),console.info("Found @ zoom = "+Z+" center",C,"for bounding box",e)}catch(a){}R=X.length,console.info("Projects containing your search returned "+W+" ("+E+" positive) among "+R+" species",d),S="Viewing data points",isNull(null!=(L=N.sampled_species)?L.genus:void 0)||(P=" of '"+N.sampled_species.genus+" "+N.sampled_species.species+" "+N.sampled_species.subspecies+"'",S+=P.replace(/( \*)/gim,"")),k=null!=N.pathogen?N.pathogen.data:"disease",null!=N.disease&&(S+=" for "+N.disease.data),null!=N.disease_positive&&(S+=" with disease status '"+j+"'"),null!=N.disease_morbidity&&(S+=" with morbidity status '"+o+"'"),S+=" in bounds defined by [{lat: "+N.bounding_box_n.data+",lng: "+N.bounding_box_w.data+"},{lat: "+N.bounding_box_s.data+",lng: "+N.bounding_box_e.data+"}]";try{for(resetMap(geo.lMap,!1,!1),M="",u=0,A=x.length;u<A;u++)v=x[u],w={user_name:cartoAccount,type:"namedmap",named_map:v},createRawCartoMap(w),U="select * from "+v.params.table_name+" where (genus ilike '%"+v.params.genus+"%' and specificepithet ilike '%"+v.params.specific_epithet+"%' and diseasedetected ilike '%"+v.params.disease_detected+"%' and diseasetested ilike '%"+v.params.pathogen+"%' and decimallatitude between "+d.s+" and "+d.n+" and decimallongitude between "+d.w+" and "+d.e+");",M+=U;$("#post-map-subtitle").text(S),$("#post-map-subtitle").removeClass("text-muted").addClass("bg-success"),c="action=fetch&sql_query="+post64(M),$.post(uri.urlString+"api.php",c,"json").done(function(b){var c,d,e,f,g,h,i,j,k;console.info("Detailed results: ",b);try{for(a=Object.toArray(b.parsed_responses),getSampleSummaryDialog(a,G),c=new Array,f=0,d=a.length;f<d;f++)for(k=a[f],j=Object.toArray(k.rows),g=0,e=j.length;g<e;g++)i=j[g],h={lat:i.decimallatitude,lng:i.decimallongitude},c.push(canonicalizePoint(h));Z=getMapZoom(c,".map-container"),C=getMapCenter(c),console.info("Recalculate data zoom = "+Z+" center",C,"for points array",c);try{null!=geo.lMap&&(geo.lMap.once("zoomend",function(a){return function(){return console.info("ZoomEnd is ensuring centering"),m(0)}}(this)),geo.lMap.setZoom(Z));try{p$("#global-data-map").latitude=C.lat,p$("#global-data-map").longitude=C.lng,p$("#global-data-map").zoom=Z}catch(a){}try{geo.lMap.setView(C.getObj())}catch(a){l=a,console.warn("Failed to recenter map - "+l.message,c),console.warn(l.stack)}}catch(a){l=a,console.warn("Failed to rezoom/recenter map - "+l.message,c),console.warn(l.stack)}}catch(a){console.warn("Couldn't parse responses from server")}return!1}).fail(function(a,b){return console.error("Couldn't fetch detailed results")}),(m=function(a,b,c){var d,e,f,g,h,i,j,k;i=roundNumber(C.lat,3),j=roundNumber(C.lng,3);try{e=roundNumber(p$("#global-data-map").latitude,3),f=roundNumber(p$("#global-data-map").longitude,3),d={type:"google-map-element",lat:e,lng:f}}catch(a){}try{d=geo.lMap.getCenter(),e=roundNumber(d.lat,3),f=roundNumber(d.lng,3)}catch(a){}return g=100*Math.abs((e-i)/i),h=100*Math.abs((f-j)/j),g<2&&h<2&&a>5?(console.info("Correctly centered",C,d,[g,h]),geo.lMap.getZoom()!==Z&&console.warn("The map was centered before the zoom finished -- this may need to fire again"),clearTimeout(_adp.centerTimeout),!1):(a<=15||console.warn("Centering too deviant",g<2,h<2,g<2&&h<2,e,f,i,j),isNumber(b)||(b=100),a>b?(k=c*b,console.info("Map could not be correctly centered in "+k+"ms"),clearTimeout(_adp.centerTimeout),!1):(++a,_adp.centerTimeout=delay(c,function(){isNumber(b)||(b=100);try{p$("#global-data-map").latitude=C.lat,p$("#global-data-map").longitude=C.lng}catch(a){}try{console.log("#"+a+"/"+b+" Deep setting view to",C.getObj(),[g,h]),geo.lMap.setView(C.getObj())}catch(a){l=a,console.warn("Error setting view - "+l.message)}if(a<b)return m(a)})))})(0,100,100)}catch(a){l=a,console.error("Couldn't create map! "+l.message),console.warn(l.stack)}stopLoad()}catch(a){l=a,stopLoadError("There was a problem performing a sample search"),console.error("Problem performing sample search! "+l.message),console.warn(l.stack)}return!1},showAllTables=function(){var a,b;return console.log("Starting table list"),b=uri.urlString+"admin-api.php",a="perform=list",$.post(b,a,"json").done(function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(a.status===!1)return console.error("Got bad result",a),!1;console.info("Good result",a),b=a.carto_table_map,i=new Array,n=new Array,e=0;for(k in b){if(c=b[k],l=c.table,console.log("Colors",c.creation,generateColorByRecency2(c.creation)),isNull(l))console.warn("Bad table #"+e,l);else{l=l.unescape();try{m={project:k,table:l},createTemplateByProject(m,!0)}catch(a){}n.push(l),g={name:namedMapSource,type:"namedmap",layers:[{layer_name:"layer-"+i.length,interactivity:"cartodb_id, id, diseasedetected, genus, specificepithet, dateidentified"}],params:{table_name:l,color:generateColorByRecency2(c.creation)}},i.push(g)}++e}console.info("Got tables",n),console.info("Got layers",i);try{for(f=0,j=i.length;f<j;f++)g=i[f],h={user_name:cartoAccount,type:"namedmap",named_map:g},console.log("Creating raw map from",h),createRawCartoMap(h)}catch(a){d=a,console.error("Couldn't create map! "+d.message),console.warn(d.stack)}return!1}).error(function(a,b){return console.error("AJAX failure showing tables",a,b)}),!1},resetMap=function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a&&(a=geo.lMap),null==b&&(b=!0),null==c&&(c=!0),null==geo.mapSublayers)return console.error("geo.mapSublayers is not defined."),!1;try{for(i=geo.mapSublayers,e=0,g=i.length;e<g;e++)k=i[e],k.remove()}catch(b){j=a._layers;for(d in j){f=j[d];try{if(h=f._url.search("arcgisonline"),h===-1)try{f.removeLayer()}catch(a){f.remove()}}catch(a){}}}return $("#post-map-subtitle").removeClass("bg-success").addClass("text-muted").text(""),c&&(geo.lMap.setZoom(geo.defaultLeafletOptions.zoom),geo.lMap.panTo(geo.defaultLeafletOptions.center)),b&&(showAllTables(),$("#post-map-subtitle").text("All Projects")),!1},getPrettySpecies=function(a){var b,c,d,e,f,g;return b=a.genus,f=null!=(d=a.specificEpithet)?d:a.specificepithet,g=null!=(e=a.infraspecificEpithet)?e:a.infraspecificEpithet,c=b,isNull(f)||(c+=" "+f,isNull(g)||(c+=" "+g)),c},generateColorByRecency=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(null==b&&(b=1420070400),isNumber(a)||(p=new Date(a),a=p.getTime()/1e3),a>Date.now()/1e3&&(a/=1e3),c=Date.now()/1e3-a,l=a-b,c>l)e="#000000";else{for(o=l/765,n=c/o,d=255,g=255,m=255-n,m=m<0?0:toInt(m),n>255&&(g=510-n,g=g<0?0:toInt(g),n>510&&(d=765-n,d=d<0?0:toInt(d))),console.log("Base channels",m,g,d),h=[m.toString(16),g.toString(16),d.toString(16)],i=0,j=0,k=h.length;j<k;j++)f=h[j],1===f.length&&(h[i]="0"+f),++i;e="#"+h.join("")}return e="#ff0000"},generateColorByRecency2=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(null==b&&(b=1420070400),isNumber(a)||(p=new Date(a),a=p.getTime()/1e3),a>Date.now()/1e3&&(a/=1e3),c=Date.now()/1e3-a,l=a-b,c>l)e="#000000";else{for(o=l/765,n=c/o,m=255-n,g=m<0?0-m:255-m,m=m<0?0:toInt(m),d=g>255?toInt(g-255):0,g=g>255?255-(g-255):toInt(g),d=d<0?0:toInt(d),console.log("Base channels 2",m,g,d),h=[m.toString(16),g.toString(16),d.toString(16)],i=0,j=0,k=h.length;j<k;j++)f=h[j],1===f.length&&(h[i]="0"+f),++i;e="#"+h.join("")}return console.log("Recency2 generated",h,e),e="#ff0000"},getProjectResultDialog=function(a){var b,c,d,e,f,g,h,i,j;if(isArray(a)||(a=Object.toArray(a)),0===a.length)return console.warn("There were no projects in the result list"),!1;for(i=new Array,f=0,g=a.length;f<g;f++)h=a[f],b=h.includes_anura?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",c=h.includes_caudata?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",d=h.includes_gymnophiona?"<iron-icon icon='icons:check-circle'></iron-icon>":"<iron-icon icon='icons:clear'></iron-icon>",j="<tr>\n  <td>"+h.project_title+'</td>\n  <td class="text-center">'+b+'</td>\n  <td class="text-center">'+c+'</td>\n  <td class="text-center">'+d+'</td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" title="Visit Project" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+h.project_id+'" icon="icons:arrow-forward"></paper-icon-button></td>\n</tr>',i.push(j);return e='<paper-dialog id="modal-project-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    <div>\n      <table class="table table-striped">\n        <tr>\n          <th>Project Name</th>\n          <th>Caudata</th>\n          <th>Anura</th>\n          <th>Gymnophiona</th>\n          <th>Visit</th>\n        </tr>\n        '+i.join("\n")+'\n      </table>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#modal-project-list").remove(),$("body").append(e),$("#modal-project-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").unbind().click(function(){return console.log("Calling dialog helper"),safariDialogHelper("#modal-project-list",0,function(){return console.info("Successfully opened dialog"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden")})}),bindClicks(),console.info("Generated project result list"),!1},getSampleSummaryDialog=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K;F=Date.now();try{console.info("Starting Web Worker to do hard work"),t={action:"summary-dialog",resultsList:a,tableToProjectMap:b,windowWidth:$(window).width()},K=new Worker("js/global-search-worker.min.js"),K.addEventListener("message",function(a){var b,c;return b=a.data.html,c=a.data.outputData,console.info("Web worker returned",a.data),D(b,c)}),K.postMessage(t)}catch(t){if(k=t,console.warn("Warning: This browser doesn't support Web Workers. Using fallback."),isArray(a)||(a=Object.toArray(a)),0===a.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from",a),x=new Array,s=new Array,m=0,J=["cartodb_id","the_geom","the_geom_webmercator","id"],window.dataSummary={species:[],diseases:[],data:{}},n=0,p=a.length;n<p;n++){w=a[n],++m,g=.5*$(window).width(),h=.3*$(window).width();try{C=w.rows;try{c=new Object,y=w.rows;for(r in y){for(B=y[r],o=0,q=J.length;o<q;o++)d=J[o],delete B[d];c[r]=B,B.carto_table=w.table,B.project_id=w.project_id,E=getPrettySpecies(B),indexOf.call(dataSummary.species,E)<0&&dataSummary.species.push(E),e=B.diseasetested,indexOf.call(dataSummary.diseases,e)<0&&dataSummary.diseases.push(e),isNull(dataSummary.data[E])&&(dataSummary.data[E]={}),isNull(dataSummary.data[E][e])&&(dataSummary.data[E][e]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),B.diseasedetected.toBool()?dataSummary.data[E][e].positive++:"no_confidence"===B.diseasedetected.toLowerCase()?dataSummary.data[E][e].no_confidence++:dataSummary.data[E][e].negative++,dataSummary.data[E][e].samples++,u=dataSummary.data[E][e].positive/dataSummary.data[E][e].samples,dataSummary.data[E][e].prevalence=u,s.push(B)}C=c}catch(a){z=w.rows;for(r in z)B=z[r],B.carto_table=w.table,B.project_id=w.project_id,s.push(B)}if(f=JSON.stringify(C),isNull(f)){console.warn("Got bad data for row #"+m+"!",w,w.rows,f);continue}f=""+f}catch(a){f="Invalid data from server"}H=v=b[w.table],B='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+g+"px;min-width:"+h+'px">'+f+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+v.id+'" icon="icons:arrow-forward" title="'+v.name+'"></paper-icon-button></td>\n</tr>',x.push(B)}window.summaryTableRows=new Object,A=dataSummary.data;for(E in A){j=A[E];for(i in j)f=j[i],null==summaryTableRows[i]&&(summaryTableRows[i]=new Array),u=100*f.prevalence,u=roundNumberSigfig(u,2),summaryTableRows[i].push("<tr>\n  <td>"+E+"</td>\n  <td>"+f.samples+"</td>\n  <td>"+f.positive+"</td>\n  <td>"+f.negative+"</td>\n  <td>"+u+"%</td>\n</tr>")}G="";for(i in summaryTableRows)I=summaryTableRows[i],G+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+i+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+I.join("\n")+"\n    </table>\n  </div>\n</div>";l='<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+G+'\n    <div class="row">\n      <div class="col-xs-12">\n        <h3>Raw Data For Developers</h3>\n        <table class="table table-striped">\n          <tr>\n            <th colspan="4">Query Data (JSON)</th>\n            <th>Visit Project</th>\n          </tr>\n          '+x.join("\n")+'\n        </table>\n      </div>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',D(l,s)}return D=function(a,b){var c,d,e,f,g,h;$("#modal-sql-details-list").remove(),$("body").append(a),$("#generate-download").click(function(){return generateCSVFromResults(b,this)});try{generateCSVFromResults(b,document.getElementById("generate-download"))}catch(a){}for(g=$(".code-box"),e=0,f=g.length;e<f;e++){c=g[e];try{Prism.highlightElement(c,!0)}catch(a){}}return $("#modal-sql-details-list").on("iron-overlay-closed",function(){return $(".leaflet-control-attribution").removeAttr("hidden"),$(".leaflet-control").removeAttr("hidden")}),$(".show-result-list").remove(),h='<paper-icon-button class="show-result-list" icon="editor:insert-chart" data-toggle="tooltip" title="Show Sample Details" raised></paper-icon-button>',$("#post-map-subtitle").append(h),$(".show-result-list").unbind().click(function(){var a;return animateLoad(),a=Date.now(),console.log("Calling dialog helper"),safariDialogHelper("#modal-sql-details-list",0,function(){var b,c,d,e;return c=Date.now()-a,console.info("Successfully opened dialog in "+c+"ms via safariDialogHelper"),$(".leaflet-control-attribution").attr("hidden","hidden"),$(".leaflet-control").attr("hidden","hidden"),m=0,e=100,d=3e4,(b=function(){return delay(e,function(){var a;return++m,m*e<d&&!$("#modal-sql-details-list").isVisible()?b():(stopLoad(),a=e*m-e/2+c,a>500?console.warn("It took about "+a+"ms to render the dialog visible!"):console.info("Dialog ready in about "+a+"ms"))})})()})}),bindClicks(),d=Date.now()-F,console.info("Generated project result list in "+d+"ms")},!1},createOverflowMenu=function(){return checkLoggedIn(function(a){var b,c;return b=a.status?'<paper-menu class="dropdown-content">\n<paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",c='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+b+'\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n    <paper-item disabled data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker/issues/176" class="click">\n      Summary Dashboard\n    </paper-item>\n    <paper-item data-function="firstLoadInstructionPrompt" data-args="true" class="click">\n      Show Welcome\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(c),isNull(b)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1},firstLoadInstructionPrompt=function(a){var b,c;null==a&&(a=!1),c=uri.domain+"_firstLoadPrompt";try{b=$.cookie(c).toBool()}catch(a){b=!1}return!a&&b||(b&&console.info("Forced to continue showing prompt to user who has seen it already"),checkLoggedIn(function(d){var e;return d.status&&(console.info("User is logged in, and does not need an instruction prompt"),$.cookie(c,!0),b=!0),!(b&&!a)&&(b&&console.warn("Force-showing the prompt to a logged in user"),e='<div class="alert alert-warning alert-dismissable slide-alert slide-out" role="alert" id="first-load-prompt">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <div class="alert-message">\n    <p class="center-block text-center"><strong>Welcome!</strong></p>\n    <p>\n      Need help getting started? We\'ve put together some resources for you below.\n    </p>\n    <div class="center-block text-center">\n      <a href="http://updates.amphibiandisease.org/portal/2016/06/30/Uploadingdata.html" class="btn btn-default click" data-newtab="true">Get Involved</a>  <a href="http://updates.amphibiandisease.org/posts/" class="click btn btn-default" data-newtab="true">Learn More</a>  <a href="https://amphibian-disease-tracker.readthedocs.io/en/latest/User%20Workflow/" class="btn btn-default click" data-newtab="true">Read Documentation</a>\n    </div>\n    <p>\n      You can also find these resources by scrolling down on this page later.\n    </p>\n  </div>\n</div>',$("#first-load-prompt").remove(),$("body").append(e),bindClicks(),$("#first-load-prompt").removeClass("slide-out").addClass("slide-in"),$.cookie(c,!0))})),!1},$(function(){var a,b,c,d,e;return geo.initLocation(),d={center:[17.811456088564483,-37.265625],zoom:2},geo.defaultLeafletOptions=d,b=new L.Map("global-map-container",d),c={attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"},geo.tileLayer=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",c),geo.tileLayer.addTo(b),geo.lMap=b,geo.tileLayer.on("load",function(){return console.info("Map ready"),firstLoadInstructionPrompt()}),$(".coord-input").keyup(function(){return checkCoordinateSanity()}),a=function(a,b){var c,d,e;if(null==b&&(b=!1),d=checkCoordinateSanity(),!d)return toastStatusMessage("Please check your coordinates"),!1;e=getSearchObject();try{try{c=$(a).attr("data-deep").toBool()}catch(a){c=!1}b&&(c=!0),c&&(e=getSearchContainsObject())}catch(a){c=!1}return doSearch(e,c),!1},$("input.submit-project-search").keyup(function(b){var c;return c=b.keyCode?b.keyCode:b.which,13===c&&a(null,!0)}),$(".do-search").click(function(){return a(this)}),$("#reset-global-map").click(function(){return resetMap(),!1}),$("#toggle-global-search-filters").click(function(){var a,b;return b=p$("#global-search-filters").opened,p$("#global-search-filters").toggle(),a=b?"Show":"Hide",$(this).find(".action-word").text(a),!1}),e=function(){return p$("#use-viewport-bounds").checked?(console.info("Setting viewer bounds, checkbox is checked"),setViewerBounds()):console.info("Not using viewport bounds")},geo.lMap.on("moveend",function(){return e()}).on("zoomend",function(){return e()}),showAllTables(),checkFileVersion(!1,"js/global-search.min.js"),$("#show-more-tips").click(function(){var a,b;return a=!p$("#more-tips").opened,p$("#more-tips").toggle(),b=a?"Fewer tips...":"More tips...",$("#show-more-tips").text(b)}),$("#reset-global-map").contextmenu(function(){var a,b,c,d;for(resetMap(),$("#taxa-input").val(""),p$("#use-viewport-bounds").checked=!0,d=$("paper-radio-group"),a=0,b=d.length;a<b;a++){c=d[a];try{p$(c).selectIndex(0)}catch(a){}}return!1}),createOverflowMenu(),!1});var byteCount,dateMonthToString,deEscape,decode64,delay,downloadCSVFile,encode64,generateCSVFromResults,getLocation,getPrettySpecies,getSampleSummaryDialog,goTo,isArray,isBlank,isBool,isEmpty,isJson,isNull,isNumber,jsonTo64,locationData,openLink,openTab,post64,prepURI,randomInt,randomString,roundNumber,roundNumberSigfig,toFloat,toInt,toObject,validateAWebTaxon,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};self.addEventListener("message",function(a){var b,c,d,e,f;switch(a.data.action){case"summary-dialog":return c=a.data.resultsList,f=a.data.tableToProjectMap,
getSampleSummaryDialog(c,f,a.data.windowWidth);case"csv":return b=a.data.data,d=a.data.options,e=downloadCSVFile(b,d),console.info("CSV file successfully generated"),self.postMessage(e),self.close()}}),getPrettySpecies=function(a){var b,c,d,e,f,g;return b=a.genus,f=null!=(d=a.specificEpithet)?d:a.specificepithet,g=null!=(e=a.infraspecificEpithet)?e:a.infraspecificEpithet,c=b,isNull(f)||(c+=" "+f,isNull(g)||(c+=" "+g)),c},getSampleSummaryDialog=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q;if(I=Date.now(),isArray(a)||(a=Object.toArray(a)),0===a.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from list of length "+a.length,a),A=new Array,w=new Array,p=0,Q=["cartodb_id","the_geom","the_geom_webmercator","id"],h={species:[],diseases:[],data:{}},q=0,s=a.length;q<s;q++){z=a[q],++p,i=.5*c,j=.3*c;try{F=z.rows;try{d=new Object,G=new Object,B=z.rows;for(v in B){for(E=B[v],r=0,t=Q.length;r<t;r++)e=Q[r],delete E[e];d[v]=E,E.carto_table=z.table,E.project_id=z.project_id,H=getPrettySpecies(E),indexOf.call(h.species,H)<0&&h.species.push(H),f=E.diseasetested,indexOf.call(h.diseases,f)<0&&h.diseases.push(f),isNull(h.data[H])&&(h.data[H]={}),isNull(h.data[H][f])&&(h.data[H][f]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),E.diseasedetected.toBool()?h.data[H][f].positive++:"no_confidence"===E.diseasedetected.toLowerCase()?h.data[H][f].no_confidence++:h.data[H][f].negative++,h.data[H][f].samples++,x=h.data[H][f].positive/h.data[H][f].samples,h.data[H][f].prevalence=x,G[H]=E}F=d,Object.doOnSortedKeys(G,function(a){return w.push(a)})}catch(a){C=z.rows;for(v in C)E=C[v],E.carto_table=z.table,E.project_id=z.project_id,w.push(E)}if(g=JSON.stringify(F),isNull(g)){console.warn("Got bad data for row #"+p+"!",z,z.rows,g);continue}g=""+g}catch(a){g="Invalid data from server"}N=y=b[z.table],E='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+i+"px;min-width:"+j+'px">'+g+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+y.id+'" icon="icons:arrow-forward" title="'+y.name+'"></paper-icon-button></td>\n</tr>',A.push(E)}L=new Object,M=new Object,D=h.data;for(H in D){l=D[H];for(k in l)g=l[k],null==L[k]&&(L[k]=new Array,M[k]=new Object),x=100*g.prevalence,x=roundNumberSigfig(x,2),J="<tr>\n  <td>"+H+"</td>\n  <td>"+g.samples+"</td>\n  <td>"+g.positive+"</td>\n  <td>"+g.negative+"</td>\n  <td>"+x+"%</td>\n</tr>",L[k].push(J),M[k][H]=J}K="";for(k in M){O=M[k];try{"object"==typeof O?(P=new Array,Object.doOnSortedKeys(O,function(a){return P.push(a)})):(console.warn("Warning: table rows aren't an object"),P=O)}catch(a){m=a,console.error("Can't sort rows: "+m.message),console.warn(m.stack),P=L[k]}K+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+k+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+P.join("\n")+"\n    </table>\n  </div>\n</div>"}return isNull(K)&&(K="<h3><em>Sorry, we were unable to generate a summary table</em></h3>"),o='<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+K+'\n    <div class="row">\n      <div class="col-xs-12">\n        <h3>Raw Data</h3>\n        <table class="table table-striped">\n          <tr>\n            <th colspan="4">Query Data</th>\n            <th>Visit Project</th>\n          </tr>\n          '+A.join("\n")+'\n        </table>\n      </div>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',u={html:o,outputData:w,data:h,summaryRows:L,providedList:a,providedMap:b,providedWidth:c},n=Date.now()-I,console.info("Worker saved "+n+"ms from the main thread"),self.postMessage(u),self.close()},locationData=new Object,locationData.params={enableHighAccuracy:!0},locationData.last=void 0,isBool=function(a,b){var c;if(null==b&&(b=!1),b)return"boolean"==typeof a;try{return"boolean"==typeof a?a===!0||a===!1:"string"==typeof a?"true"===a.toLowerCase()||"false"===a.toLowerCase():"number"==typeof a&&(1===a||0===a)}catch(a){return c=a,!1}},isEmpty=function(a){return!a||0===a.length},isBlank=function(a){return!a||/^\s*$/.test(a)},isNull=function(a){var b;try{if((isEmpty(a)||isBlank(a)||null==a)&&a!==!1&&0!==a)return!0}catch(a){return b=a,!1}return!1},isJson=function(a){if("object"==typeof a&&!isArray(a))return!0;try{return JSON.parse(a),!0}catch(a){return!1}return!1},isArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),!0}catch(a){return!1}},isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},toFloat=function(a){return!isNumber(a)||isNull(a)?0:parseFloat(a)},toInt=function(a){var b;return!isNumber(a)||isNull(a)?0:(b=parseFloat(a),parseInt(b))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var a;return a=this.toString().toLowerCase(),"true"===a||"1"===a},Boolean.prototype.toBool=function(){return"true"===this.toString()},Number.prototype.toBool=function(){return"1"===this.toString()},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(a){var b,c;try{return c=_.find(this,function(b){return _.isEqual(a,b)}),"object"==typeof c}catch(a){return b=a,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),a}catch(a){}return Object.keys(a).map(function(b){return function(b){return a[b]}}(this))},Object.size=function(a){var b,c,d;if("object"!=typeof a)try{return a.length}catch(a){b=a,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(b.message)}d=0;for(c in a)a.hasOwnProperty(c)&&d++;return d},Object.doOnSortedKeys=function(a,b){var c,d,e,f,g,h;for(h=Object.keys(a).sort(),g=[],d=0,f=h.length;d<f;d++)e=h[d],c=a[e],g.push(b(c));return g},delay=function(a,b){return setTimeout(b,a)},roundNumber=function(a,b){var c;return null==b&&(b=0),c=Math.pow(10,b),Math.round(a*c)/c},roundNumberSigfig=function(a,b){var c,d,e,f,g;return null==b&&(b=0),e=roundNumber(a,b).toString(),c=e.split("."),1===c.length?e+"."+Array(b+1).join("0"):(g=c.pop(),f=c[0]+".",g.length===b?e:(d=b-g.length,g+=Array(d+1).join("0"),""+f+g))},String.prototype.stripHtml=function(a){var b;return null==a&&(a=!1),b=this,a&&(b=b.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),b=b.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),b=b.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(a){var b,c,d,e;return null==a&&(a=!1),c=document.createElement("div"),b=function(b){return null!=b&&"string"==typeof b&&(a!==!0?b=escape(b).replace(/%26/g,"&").replace(/%23/g,"#").replace(/%3B/g,";"):(b=b.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),b=b.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")),c.innerHTML=b,c.innerText?(b=c.innerText,c.innerText=""):(b=c.textContent,c.textContent="")),unescape(b)},d=function(a){return a=a.replace(/\&amp;#/gm,"&#"),a=a.replace(/\&quot;/gm,'"'),a=a.replace(/\&quote;/gm,'"'),a=a.replace(/\&#95;/gm,"_"),a=a.replace(/\&#39;/gm,"'"),a=a.replace(/\&#34;/gm,'"'),a=a.replace(/\&#62;/gm,">"),a=a.replace(/\&#60;/gm,"<")},e=d(this),b(e)},deEscape=function(a){return a=a.replace(/\&amp;#/gm,"&#"),a=a.replace(/\&quot;/gm,'"'),a=a.replace(/\&quote;/gm,'"'),a=a.replace(/\&#95;/gm,"_"),a=a.replace(/\&#39;/gm,"'"),a=a.replace(/\&#34;/gm,'"'),a=a.replace(/\&#62;/gm,">"),a=a.replace(/\&#60;/gm,"<")},jsonTo64=function(a,b){var c,d,e;null==b&&(b=!0);try{e=a.slice(0),e.push("foo"),a=toObject(a)}catch(a){}return d=JSON.stringify(a),c=b===!0?post64(d):encode64(c)},encode64=function(a){var b;try{return Base64.encode(a)}catch(c){return b=c,console.warn("Bad encode string provided"),a}},decode64=function(a){var b;try{return Base64.decode(a)}catch(c){return b=c,console.warn("Bad decode string provided"),a}},post64=function(a){var b,c;return c=encode64(a),b=encodeURIComponent(c)},byteCount=function(a){return function(a){return encodeURI(a).split(/%..|./).length-1}}(this),toObject=function(a){var b,c,d;d=new Object;for(c in a)b=a[c],void 0!==b&&(d[c]=b);return d},String.prototype.toTitleCase=function(){var a,b,c,d,e,f,g,h,i,j,k;for(h=this.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),g=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],a=0,c=g.length;a<c;a++)e=g[a],f=new RegExp("\\s"+e+"\\s","g"),h=h.replace(f,function(a){return a.toLowerCase()});for(k=["Id","Tv"],b=0,d=k.length;b<d;b++)i=k[b],j=new RegExp("\\b"+i+"\\b","g"),h=h.replace(j,i.toUpperCase());return h},Function.prototype.getName=function(){var a;return a=this.name,null==a&&(a=this.toString().substr(0,this.toString().indexOf("(")).replace("function ","")),isNull(a)&&(a=md5(this.toString())),a},randomInt=function(a,b){var c,d,e;return null==a&&(a=0),null==b&&(b=1),e=Math.random(),null==a&&(c=[0,a],a=c[0],b=c[1]),a>b&&(d=[b,a],a=d[0],b=d[1]),Math.floor(e*(b-a+1)+a)},randomString=function(a){var b,c,d,e,f;for(null==a&&(a=8),e=0,c=65,d=126,f=new Array;e<a;)++e,b=randomInt(c,d),f.push(String.fromCharCode(b));return f.join("")},openLink=function(a){return null!=a&&(open(a),!1)},openTab=function(a){return openLink(a)},goTo=function(a){return null!=a&&(location.href=a,!1)},dateMonthToString=function(a){var b,c;b={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{c=b[a]}catch(b){c=a}return c},prepURI=function(a){return a=encodeURIComponent(a),a.replace(/%20/g,"+")},locationData=new Object,locationData.params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(a){var b,c,d,e;return null==a&&(a=void 0),e=1500,c=function(b){var c,f;return clearTimeout(d),locationData.lat=b.coords.latitude,locationData.lng=b.coords.longitude,locationData.acc=b.coords.accuracy,f=locationData.last,locationData.last=Date.now(),c=locationData.last-f,!(c<e)&&(console.info("Successfully set location"),"function"==typeof a&&a(locationData),!1)},b=function(b){var c;return clearTimeout(d),c=function(){switch(b.code){case 0:return"There was an error while retrieving your location: "+b.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+b.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(c),"function"==typeof a&&a(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(c,b,locationData.params),d=delay(1500,function(){return getLocation(a)})):(console.warn("This browser doesn't support geolocation!"),null!=a?a(!1):void 0)},downloadCSVFile=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(t=Date.now(),u="",isJson(a)&&"string"==typeof a){console.info("Parsing as JSON string");try{n=JSON.parse(a)}catch(b){throw e=b,console.error("COuldn't parse json! "+e.message),console.warn(e.stack),console.info(a),"error"}}else if(isArray(a))console.info("Parsing as array"),n=toObject(a);else{if("object"!=typeof a)return console.error("Unexpected data type '"+typeof a+"' for downloadCSVFile()",a),!1;console.info("Parsing as object"),n=a}for(null==b&&(b=new Object),null==b.create&&(b.create=!1),null==b.downloadFile&&(b.downloadFile="datalist.csv"),null==b.classes&&(b.classes="btn btn-default"),null==b.buttonText&&(b.buttonText="Download File"),null==b.iconHtml&&(b.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==b.selector&&(b.selector="#download-file"),null==b.splitValues&&(b.splitValues=!1),null==b.cascadeObjects&&(b.cascadeObjects=!1),null==b.objectAsValues&&(b.objectAsValues=!1),i=new Array,(q=function(c,d){var f,g,h,j,k,l,m,n,o,p,r,s;o=0,b.objectAsValues&&(b.splitValues="::@@::"),n=[];for(l in c)if(s=c[l],"function"!=typeof s){++o;try{if(h=l.toString().replace(/"/g,'""'),1===o)if(b.objectAsValues){console.info("objectAsValues set");for(f in s)a=s[f],isArray(b.acceptableCols)?indexOf.call(b.acceptableCols,f)>=0&&i.push(f):i.push(f);console.log("Using as header",i)}else console.log("Boring options",b.objectAsValues,b),i.push(h);if("object"==typeof s&&d&&(s=q(s,!0)),j=function(a,c){var d,e,f,g;return null==a&&(a=s),null==c&&(c=b),isNull(s)?d="":("object"==typeof a&&(a=JSON.stringify(a)),a=a.toString(),e=a.replace(/,/g,","),e=e.replace(/"/g,'""'),e=e.replace(/<\/p><p>/g,'","'),"string"==typeof c.splitValues&&(f=e.split(c.splitValues),e=f.join('","'),h=!1),d=e),h===!1?g='"'+d+'"\n':isNumber(h)?g='"'+d+'",':isNull(h)||(g='"'+h+'","'+d+'"\n'),g},b.objectAsValues){for(p=new Array,k=0,m=i.length;k<m;k++){if(f=i[k],g=s[f],"object"==typeof g)try{g=JSON.stringify(g),g=g.replace(/"/g,'""')}catch(a){}p.push(g)}r=p.join(b.splitValues),n.push(u+=j(r,b))}else n.push(u+=j(s))}catch(a){e=a,console.warn("Unable to run key "+l+" on row "+o,s,c),n.push(console.warn(e.stack))}}return n})(n,b.cascadeObjects),u=u.trim(),o=0,m=0,p=i.length;m<p;m++)d=i[m],d=d.replace(/"/g,'""'),i[o]=d,++o;return b.objectAsValues&&(b.header=i),isArray(b.header)?(j=b.header.join('","'),u='"'+j+'"\n'+u,u=u.trim(),h="present"):h="absent",","===u.slice(-1)&&(u=u.slice(0,-1)),g="data:text/csv;charset=utf-8;header="+h+","+encodeURIComponent(u),s=b.selector,b.create===!0?(c=randomInt(0,9999),l=s.slice(1)+"-download-button-"+c,k='<a id="'+l+'" class="'+b.classes+'" href="'+g+'" download="'+b.downloadFile+'">\n  '+b.iconHtml+"\n  "+b.buttonText+"\n</a>"):k="",r={file:g,options:b,html:k},f=Date.now()-t,console.debug("CSV Worker saved "+f+"ms from main thread"),r},generateCSVFromResults=function(a,b,c){var d,e;null==c&&(c="#modal-sql-details-list"),console.info("Worker CSV: Given",a),d={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv",acceptableCols:["collectionid","catalognumber","fieldnumber","sampleid","diseasetested","diseasestrain","samplemethod","sampledisposition","diseasedetected","fatal","cladesampled","genus","specificepithet","infraspecificepithet","lifestage","dateidentified","decimallatitude","decimallongitude","alt","coordinateuncertaintyinmeters","collector","fimsextra","originaltaxa"]};try{e=downloadCSVFile(a,d)}catch(a){console.error("Sorry, there was a problem with this dataset and we can't do that right now."),e={file:"",options:d,html:""}}return e},validateAWebTaxon=function(a,b){var c,d,e;return null==b&&(b=null),null==("undefined"!=typeof e&&null!==e?e.validatedTaxons:void 0)&&("object"!=typeof e&&(e=new Object),e.validatedTaxons=new Array),d=function(a){return"function"==typeof b&&b(a),!1},e.validatedTaxons.containsObject(a)?(console.info("Already validated taxon, skipping revalidation",a),d(a),!1):(c="action=validate&genus="+a.genus+"&species="+a.species,null!=a.subspecies&&(c+="&subspecies="+a.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(b){return b.status?(a.genus=b.validated_taxon.genus,a.species=b.validated_taxon.species,a.subspecies=b.validated_taxon.subspecies,null==a.clade&&(a.clade=b.validated_taxon.family),e.validatedTaxons.push(a)):a.invalid=!0,a.response=b,d(a),!1}).fail(function(b,c){var d;return d=a.genus+" "+a.species,d=null!=a.subspecies?d+" "+a.subspecies:d,bsAlert("<strong>Problem validating taxon:</strong> "+d+" couldn't be validated."),console.warn("Warning: Couldn't validated "+d+" with AmphibiaWeb")}),!1)};
//# sourceMappingURL=maps/combined.map