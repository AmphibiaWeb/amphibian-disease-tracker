var adminApiTarget,apiTarget,createChart,createOverflowMenu,dropdownSortEvents,fetchMiniTaxonBlurb,fetchMiniTaxonBlurbs,getRandomDataColor,getServerChart,renderNewChart,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};apiTarget=uri.urlString+"api.php",adminApiTarget=uri.urlString+"admin-api.php",window._adp={taxonCharts:{}};try{(createOverflowMenu=function(){return checkLoggedIn(function(a){var b,c;return b=a.status?'    <paper-item data-href="'+uri.urlString+'admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="'+uri.urlString+'admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",c='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+b+'\n    <paper-item data-href="'+uri.urlString+'/dashboard.php" class="click">\n      Data Dashboard\n    </paper-item>\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n    <paper-item data-href="'+uri.urlString+'about.php" class="click">\n      About / Legal\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(c),isNull(b)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1})()}catch(a){}createChart=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n;if(null==c&&(c=!1),null==d&&(d="main"),"object"!=typeof b)return console.error("Can't create a chart without a data object"),!1;if("function"==typeof c&&isNull(e)&&(e=c,c=!1),l={label:"Sample Data",data:[65,59,80,81,56,55,40],borderWidth:1,borderColor:["rgba(255,99,132,1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)"],backgroundColor:["rgba(255, 99, 132, 0.2)","rgba(54, 162, 235, 0.2)","rgba(255, 206, 86, 0.2)","rgba(75, 192, 192, 0.2)","rgba(153, 102, 255, 0.2)","rgba(255, 159, 64, 0.2)"]},n=[l],m={labels:["January","February","March","April","May","June","July"],datasets:n},isNull(b.data)&&(j=b,console.warn("No data for chart, will use sample data",j)),null==b.data&&(b.data=m),null==b.type&&(b.type="bar"),"object"!=typeof b.options&&(b.options={responsive:!0,scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}),$(a).exists())console.log("Canvas already exists:",a);else{console.log("Creating new canvas"),i="#"===a.slice(0,1)?a.slice(1):"dataChart-"+$("canvas").length,f=document.createElement("canvas"),f.setAttribute("class","chart dynamic-chart col-xs-12"),f.setAttribute("id",i);try{_adp.newCanvas=f}catch(a){}document.querySelector(d).appendChild(f)}if(null!=(null!=(k=_adp.chart)?k.chart:void 0)&&_adp.chart.chart.destroy(),h=$(a),isNull(h))try{console.log("trying again to make context"),h=$(f)}catch(a){}return g=new Chart(h,b),_adp.chart={chart:g,ctx:h},console.info("Chart created with",b),"function"==typeof e&&e(),g},getRandomDataColor=function(){var a;return a="rgba("+randomInt(0,255)+","+randomInt(0,255)+","+randomInt(0,255),{border:a+",1)",background:a+",0.2)"}},getServerChart=function(a,b){var c,d,e,f,g;null==a&&(a="location"),startLoad();try{$("#post-species-summary").remove()}catch(a){}if(c="action=chart&bin="+a,"object"==typeof b){d=[];for(e in b)f=b[e],d.push(e+"="+f);c+="&"+d.join("&")}try{$("#diseasetested-select").exists()&&(g=p$("#diseasetested-select").selectedItem.name,isNull(g)||(c+="&disease="+g))}catch(a){}return console.debug("Fetching chart with",apiTarget+"?"+c),$.post(apiTarget,c,"json").done(function(d){var e,f,g,h,i,j,k,l,m,n,o,p;if(!1===d.status)return console.error("Server had a problem fetching chart data - "+d.human_error),console.warn(d),stopLoadError(d.human_error),!1;for(console.debug("Fetched chart",d),e=d.data,h=Object.toArray(e.datasets),i=0,j=0,k=h.length;j<k;j++){if(g=h[j],g.data=Object.toArray(g.data),console.log("examine data",g),null==g.borderWidth&&(g.borderWidth=1),null==g.backgroundColor)for(g.borderColor=[],g.backgroundColor=[],p=0,o=g.data,m=0,l=o.length;m<l;m++)o[m],"PosNeg"===g.stack?(-1!==g.label.toLowerCase().search("positive")&&(f={border:"rgba(220,30,25,1)",background:"rgba(220,30,25,0.2)"}),-1!==g.label.toLowerCase().search("negative")&&(f={border:"rgba(25,70,220,1)",background:"rgba(25,70,220,0.2)"})):"totals"===g.stack?-1!==g.label.toLowerCase().search("total")&&(f={border:"rgba(25,200,90,1)",background:"rgba(25,200,90,0.2)"}):f=getRandomDataColor(),g.borderColor.push(f.border),g.backgroundColor.push(f.background),++p;h[i]=g,++i}switch(d.use_preprocessor){case"geocoder":console.log("Got results",d),n=function(a){var b,c,d,f,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;for(console.log("Starting geocoder preprocessor",h),c=0,o=[],f=[],j={},i=0,C=!1,z=[],s=0,p=h.length;s<p;s++){for(k=h[s],g=k.data,console.log("Data blob",g),C||(!1,d=i,m=0,n=0),l=0,t=0,q=g.length;t<q;t++){if(w=g[t],++l,!isNull(w.points)){for(console.debug("Using pointset",w),B=w.title,x=w.project_id,b={points:[],title:B,project:x},c=0,console.log("Looking at project #"+x+", '"+B+"'"),y=Object.toArray(w.points),u=0,r=y.length;u<r;u++){v=y[u];try{A=canonicalizePoint(v),b.points.push(A),c++}catch(a){}}if(0===c){console.log("Skipping project #"+x+" = '"+B+"' with no points");continue}m++,80,localityFromMapBuilder(b,function(b,c){var g,l,p,q,r,s,t;n++;try{for(t=null!=(r=c.views)?r:geo.geocoderViews,q=0,p=t.length;q<p;q++)s=t[q],indexOf.call(s.types,"country")<0||(l=s.formatted_address)}catch(a){l="Multiple Countries"}if(isNull(l)&&(l=b),console.log("Final locality '"+l+"' for "+c.title),indexOf.call(o,l)<0?(o.push(l),j[l]=f.length,f.push(1)):(g=j[l],f[g]++),n===m&&(k.data=f,h[d]=k,n=0,m=0,C=!1,i===h.length))return e.labels=o,a()})}l===g.length&&(!0,C=!0)}z.push(++i)}return z};break;default:n=function(a){return a()}}return n(function(){var f,i,j,k,l,m,n,o,p,q,r,s,t,u,v;if(f={labels:Object.toArray(e.labels),datasets:h},i={data:f,type:null!=(l=e.type)?l:"bar"},isNull(e.stacking))try{null==i.options&&(i.options={scales:{xAxes:[{scaleLabel:{}}],yAxes:[{scaleLabel:{}}]}}),null!=d.title&&(i.options.title={display:!0,text:d.title}),null!=(m=i.options)&&null!=(n=m.scales)&&null!=(o=n.xAxes)&&null!=(p=o[0])&&(p.scaleLabel={labelString:d.axes.x,display:!0}),null!=(q=i.options)&&null!=(r=q.scales)&&null!=(s=r.yAxes)&&null!=(t=s[0])&&(t.scaleLabel={labelString:d.axes.y,display:!0})}catch(a){k=a,console.warn("Couldn't set up redundant options - "+k.message),console.warn(k.stack)}else i.options={scales:{xAxes:[{scaleLabel:{labelString:d.axes.x,display:!0},stacked:e.stacking.x}],yAxes:[{scaleLabel:{labelString:d.axes.y,display:!0},stacked:e.stacking.y}]}},null!=d.title&&(i.options.title={display:!0,text:d.title});try{u=f.labels.join(","+JSON.stringify(f.datasets))}catch(a){try{u=f.labels.join(",")}catch(a){u="BAD_STRINGIFY"}}return v=md5(u),j="#dataChart-"+h[0].label.replace(/ /g,"-")+"-"+v,console.log("Creating chart with",j,i),createChart(j,i,function(){var k,l,m,n,o,p,q,r,s,t,u;if(isNull(d.full_description)||$("#chart-"+h[0].label.replace(" ","-")).before("<h3 class='col-xs-12 text-center chart-title'>"+d.full_description+"</h3>"),"species"===a){for(n={},l="",t=f.labels,s=0,p=t.length;s<p;s++)k=t[s],u=md5(k+"-"+Date.now()),l+='<div class="col-xs-12 col-md-6 col-lg-4">\n  <button type="button" class="btn btn-default collapse-trigger" data-target="#'+u+'" id="'+u+'-button-trigger">\n  '+k+'\n  </button>\n  <iron-collapse id="'+u+'" data-bin="'+b.sort+'" data-taxon="'+k+'">\n    <div class="collapse-content alert">\n      Binned data for '+k+". Should populate this asynchronously ....\n    </div>\n  </iron-collapse>\n</div>",n[u]=k;"species"===b.sort?(q="species",r=q):(q="genera",r="genus"),m=_adp.chart.chart.toBase64Image(),o='<section id="post-species-summary" class="col-xs-12" style="margin-top:2rem;">\n  <div class="row">\n    <a href="'+m+'" class="btn btn-primary pull-right col-xs-8 col-sm-4 col-md-3 col-lg-2" id="download-main-chart" download disabled>\n      <iron-icon icon="icons:cloud-download"></iron-icon>\n      Download Chart\n    </a>\n  </div>\n  <p hidden>\n    These data are generated from over '+d.rows+" "+q+". AND MORE SUMMARY BLAHDEYBLAH. Per "+r+' summary links, etc.\n  </p>\n  <div class="row">\n    <h3 class="capitalize col-xs-12">'+r+' Summaries <small class="text-muted">Ordered as the above chart</small></h3>\n    <p class="col-xs-12 text-muted">Click on a taxon to toggle charts and more data for that taxon</p>\n    '+l+"\n  </div>\n</section>";try{$("#post-species-summary").remove()}catch(a){}$(j).after(o),delay(750,function(){return m=_adp.chart.chart.toBase64Image(),$("#download-main-chart").attr("href",m).removeAttr("disabled")});try{bindCollapsors(),_adp.fetchUpdatesFor=n,delay(250,function(){return fetchMiniTaxonBlurbs()})}catch(a){}return _adp.chart.ctx.click(function(a){var b,c,d,e,f;return c=_adp.chart.chart.getDatasetAtEvent(a),e=_adp.chart.chart.getElementAtEvent(a),console.debug("Dataset",c),console.debug("Element",e),d=e[0]._index,g=c[d],console.debug("Specific data:",g),f=g._model.label,console.debug("Taxon clicked:",f),getRandomDataColor(),b="button[data-taxon='"+f+"']",console.debug("Selector",b,$(b).exists()),$(".success-glow").removeClass("success-glow"),$(b).addClass("success-glow").get(0).scrollIntoView(!1)})}if("location"===a)return _adp.chart.ctx.click(function(a){var b,d,f,h;return d=_adp.chart.chart.getDatasetAtEvent(a),h=_adp.chart.chart.getElementAtEvent(a),console.debug("Dataset",d),console.debug("Element",h),f=h[0]._index,g=d[f],console.debug("Specific data:",g),b=g._model.label,console.debug("country clicked:",b),c={async:!0,action:"country_taxon",country:b},$.get("dashboard.php",buildQuery(c,"json")).done(function(a){var c,d,f,g,h,k,l;if(console.debug("Got country result",a),a.status){console.log("Should build out new chart here"),i={type:"bar",options:{responsive:!0,title:{display:!0,text:"Taxa in "+b},scales:{xAxes:[{scaleLabel:{labelString:"Taxa",display:!0}}],yAxes:[{scaleLabel:{labelString:"Sample Count",display:!0},stacked:!0}]}}},g={label:"Positive Samples",data:[],borderColor:"rgba(220,30,25,1)",backgroundColor:"rgba(220,30,25,0.3)",borderWidth:1,stack:"pnSamples"},f={label:"Negative Samples",data:[],borderColor:"rgba(25,70,220,1)",backgroundColor:"rgba(25,70,220,0.3)",borderWidth:1,stack:"pnSamples"},d=[],h=a.data;for(k in h)l=h[k],f.data.push(toInt(l.false)),g.data.push(toInt(l.true)),d.push(k);e={labels:d,datasets:[g,f]},i.data=e,console.log("USing chart data",i),v=JSON.stringify(e),j="#locale-zoom-chart",c=$(j),$(j).attr("data-uid",v),null!=_adp.zoomChart&&_adp.zoomChart.destroy(),_adp.zoomChart=new Chart(c,i)}return!1}),!1})}),stopLoad()}),!1}).fail(function(a,b){return console.error("AJAX error",a,b),stopLoadError("There was a problem communicating with the server"),!1}),!1},fetchMiniTaxonBlurbs=function(a){var b,c,d,e,f,g;null==a&&(a=_adp.fetchUpdatesFor),console.debug("Binding / setting up taxa updates for",a),_adp.collapseOpener=function(a){if(a.opened){if(Date.now()-_adp.lastOpened<1e3)return!1;a.hide()}else _adp.lastOpened=Date.now(),a.show();return!1};for(b in a)e=a[b],d="#"+b+" .collapse-content",f=e.split(" "),g={genus:f[0],species:null!=(c=f[1])?c:""},$("button#"+b+"-button-trigger").attr("data-taxon",e).click(function(){var a,b,c,h,i;return e=$(this).attr("data-taxon"),f=e.split(" "),g={genus:f[0],species:null!=(h=f[1])?h:""},d=$(this).parent().find(".collapse-content"),b=null!=(i=$(this).attr("data-has-data"))&&i,b.toBool()?console.debug("Already has data"):($(this).attr("data-has-data","true"),c="<paper-spinner active></paper-spinner> Fetching Data...",$(d).html(c),fetchMiniTaxonBlurb(g,d)),a=$(this).parent().find("iron-collapse").get(0),console.debug("is opened?",a.opened)});return!1},fetchMiniTaxonBlurb=function(a,b,c){var d,e,f;null==c&&(c=!1),d=["action=taxon"];for(e in a)f=a[e],d.push(e+"="+encodeURIComponent(f));return $.get("api.php",d.join("&"),"json").done(function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U;if(console.log("Got result",a),!0!==a.status)return r='<div class="alert alert-danger">\n  <p>\n    <strong>Error:</strong> Couldn\'t fetch taxon data\n  </p>\n</div>',$(b).html(r),!1;if($(b).html(""),a.isGenusLookup)for(u=[],I=Object.toArray(a.taxa),v=0,w=I.length;v<w;v++)N=I[v],u.push(N.data);else u=[a];for(A=0,x=u.length;A<x;A++){O=u[A];try{console.log("Doing blurb for",JSON.stringify(O.taxon));try{if("object"!=typeof O.amphibiaweb.data.common_name)throw{message:"NOT_OBJECT"};for(F=Object.toArray(O.amphibiaweb.data.common_name),E="",s=0,B=0,y=F.length;B<y;B++)C=F[B],++s,C===O.iucn.data.main_common_name&&(C="<strong>"+C.trim()+"</strong>"),E+=C.trim(),F.length!==s&&(E+=", ")}catch(a){p=a,"string"==typeof O.amphibiaweb.data.common_name?E=O.amphibiaweb.data.common_name:(E=null!=(J=null!=(K=O.iucn)&&null!=(L=K.data)?L.main_common_name:void 0)?J:"",console.warn("Couldn't create common name string! "+p.message),console.warn(p.stack),console.debug(O.amphibiaweb.data))}D=isNull(E)?"":"<p>\n  <strong>Names:</strong> "+E+"\n</p>",k=Object.toArray(O.adp.countries),l='<ul class="country-list">\n  <li>'+k.join("</li><li>")+"</li>\n</ul>",z="<div class='clade-project-summary'>\n  <p>Represented in <strong>"+O.adp.project_count+"</strong> projects with <strong>"+O.adp.samples+"</strong> samples</p>",M=O.adp.projects;for(H in M)T=M[H],U=T,T.length>30&&(T=T.slice(0,27)+"..."),z+='<a class="btn btn-primary newwindow project-button-link" href="'+uri.urlString+"/project.php?id="+H+'" data-toggle="tooltip" title="'+U+'">\n  '+T+"\n</a>";z+="</div>",a.isGenusLookup?(P='<span class="sciname">\n  <span class="genus">'+O.taxon.genus+'</span>\n  <span class="species">'+O.taxon.species+"</span>\n</span>",Q="<p>\n  <strong>Taxon:</strong> "+P+"\n</p>"):Q="",t=encode64(JSON.stringify(O.taxon)),t=t.replace(/[^\w0-9]/gim,""),console.log("Appended blurb for idTaxon",t),c="<div class='blurb-info' id=\"taxon-blurb-"+t+'">\n  '+Q+"\n  <p>\n    <strong>IUCN Status:</strong> "+O.iucn.category+"\n  </p>\n  "+D+"\n  <p>Sampled in the following countries:</p>\n  "+l+"\n  "+z+'\n  <div class="charts-container row">\n  </div>\n</div>',$(b).append(c),o=O.adp.disease_data;for(n in o)m=o[n],m.detected.no_confidence!==m.detected.total&&(S={labels:[n+" detected",n+" not detected",n+" inconclusive data"],datasets:[{data:[m.detected.true,m.detected.false,m.detected.no_confidence],backgroundColor:["#FF6384","#36A2EB","#FFCE56"],hoverBackgroundColor:["#FF6384","#36A2EB","#FFCE56"]}]},g={type:"pie",data:S},d=document.createElement("canvas"),d.setAttribute("class","chart dynamic-pie-chart"),f=t+"-"+n+"-testdata",d.setAttribute("id",f),e=f+"-container",h=$(b).find("#taxon-blurb-"+t).find(".charts-container").get(0),j='<div id="'+e+'" class="col-xs-6">\n</div>',$(h).append(j),$("#"+e).get(0).appendChild(d),i=$("#"+f),G=new Chart(i,g),_adp.taxonCharts[f]=G),m.fatal.unknown!==m.fatal.total&&(q={labels:[n+" fatal",n+" not fatal",n+" unknown fatality"],datasets:[{data:[m.fatal.true,m.fatal.false,m.fatal.unknown],backgroundColor:["#FF6384","#36A2EB","#FFCE56"],hoverBackgroundColor:["#FF6384","#36A2EB","#FFCE56"]}]},g={type:"pie",data:q},d=document.createElement("canvas"),d.setAttribute("class","chart dynamic-pie-chart"),f=t+"-"+n+"-fataldata",d.setAttribute("id",f),e=f+"-container",h=$(b).find(".charts-container").get(0),j='<div id="'+e+'" class="col-xs-6">\n</div>',$(h).append(j),$("#"+e).get(0).appendChild(d),i=$("#"+f),G=new Chart(i,g),_adp.taxonCharts[f]=G)}catch(a){p=a;try{R="",R='for\n  <span class="sciname">\n    <span class="genus">'+O.taxon.genus+'</span>\n    <span class="species">'+O.taxon.species+"</span>\n  </span>"}catch(a){}r='<div class="alert alert-danger">\n  <p>\n    <strong>Error:</strong> Couldn\'t fetch taxon data '+R+"\n  </p>\n</div>",$(b).append(r),console.error("Couldn't get taxon data -- "+p.message,O),console.warn(p.stack)}}return!1}).error(function(a,c){var d;return d='<div class="alert alert-danger">\n  <p>\n    <strong>Error:</strong> Server error fetching taxon data ()\n  </p>\n</div>',$(b).html(d),console.error("Couldn't fetch taxon data from server"),console.warn(a,c),!1}),!1},renderNewChart=function(){var a,b,c,d,e,f,g,h;try{null!=_adp.zoomChart&&_adp.zoomChart.destroy()}catch(a){}for(a={},g=$(".chart-param"),d=0,e=g.length;d<e;d++){f=g[d],c=$(f).attr("data-key").replace(" ","-");try{if(null==p$(f).checked)throw"Not Toggle";a[c]=p$(f).checked}catch(b){a[c]=p$(f).selectedItemLabel.toLowerCase().replace(" ","-")}}return $(".chart.dynamic-chart").remove(),$(".chart-title").remove(),b=null!=(h=a.bin)?h:"location",delete a.bin,console.info("Going to generate a new chart with the following options",a),getServerChart(b,a),a},dropdownSortEvents=function(){var a;return!0!==("undefined"!=typeof _adp&&null!==_adp?_adp.hasBoundSortDisables:void 0)&&($("paper-dropdown-menu#binned-by paper-listbox").on("iron-select",function(){return a.debounce(50,null,null,this)}),$("paper-dropdown-menu#binned-by paper-listbox > paper-item").click(function(){return a.debounce(50,null,null,$(this).parents("paper-listbox"))}),_adp.hasBoundSortDisabled=!0),a=function(a){var b,c,d,e,f,g,h,i,j,k,l;for(e=p$(a).selectedItem,console.log("Firing doSortDisables",e,a),d=$(e).text().trim().toLowerCase(),h=0,f=!1,k=$("paper-dropdown-menu#sort-by paper-listbox paper-item"),i=0,j=k.length;i<j;i++){if(g=k[i],c=null!=(l=$(g).attr("data-bins"))?l:"",b=c.split(","),console.log("Searching allowed bins for '"+d+"'",b,g),indexOf.call(b,d)>=0){try{p$(g).disabled=!1}catch(a){}$(g).removeAttr("disabled"),f=!0}else{try{p$(g).disabled=!0}catch(a){}$(g).attr("disabled","disabled")}f||h++}return p$("paper-dropdown-menu#sort-by paper-listbox").selected=h,!1},console.log("Dropdown sort events bound"),!1},$(function(){return console.log("Loaded dashboard"),getServerChart(),$("#generate-chart").click(function(){return renderNewChart.debounce(50)}),delayPolymerBind("paper-dropdown-menu#binned-by",function(){return $(".chart-param paper-listbox").on("iron-select",function(){return console.log("Firing iron-select event",this),renderNewChart.debounce(50)}),$(".chart-param paper-listbox paper-item").on("click",function(){return console.log("Firing click event on paper-item",this),renderNewChart.debounce(50)}),$("#diseasetested-select").on("selected-item-changed",function(){return console.log("Firing selection change"),renderNewChart.debounce(50)}),dropdownSortEvents()}),!1});
//# sourceMappingURL=dashboard.min.js.map