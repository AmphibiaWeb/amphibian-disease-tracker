function shuffle(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}var byteCount,dateMonthToString,deEscape,decode64,delay,downloadCSVFile,encode64,generateCSVFromResults,getLocation,getPrettySpecies,getSampleSummaryDialog,goTo,isArray,isBlank,isBool,isEmpty,isJson,isNull,isNumber,jsonTo64,locationData,openLink,openTab,post64,prepURI,randomInt,randomString,roundNumber,roundNumberSigfig,toFloat,toInt,toObject,validateAWebTaxon,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};self.addEventListener("message",function(a){var b,c,d,e,f;switch(a.data.action){case"summary-dialog":return c=a.data.resultsList,f=a.data.tableToProjectMap,getSampleSummaryDialog(c,f,a.data.windowWidth);case"csv":return b=a.data.data,d=a.data.options,e=downloadCSVFile(b,d),console.info("CSV file successfully generated"),self.postMessage(e),self.close()}}),getPrettySpecies=function(a){var b,c,d,e,f,g;return b=a.genus,f=null!=(d=a.specificEpithet)?d:a.specificepithet,g=null!=(e=a.infraspecificEpithet)?e:a.infraspecificEpithet,c=b,isNull(f)||(c+=" "+f,isNull(g)||(c+=" "+g)),c},getSampleSummaryDialog=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q;if(I=Date.now(),isArray(a)||(a=Object.toArray(a)),0===a.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from list of length "+a.length,a),A=[],w=[],p=0,Q=["cartodb_id","the_geom","the_geom_webmercator","id"],h={species:[],diseases:[],data:{}},q=0,s=a.length;q<s;q++){z=a[q],++p,i=.5*c,j=.3*c;try{F=z.rows;try{d={},G={},B=z.rows;for(v in B){for(E=B[v],r=0,t=Q.length;r<t;r++)e=Q[r],delete E[e];d[v]=E,E.carto_table=z.table,E.project_id=z.project_id,H=getPrettySpecies(E),indexOf.call(h.species,H)<0&&h.species.push(H),f=E.diseasetested,indexOf.call(h.diseases,f)<0&&h.diseases.push(f),isNull(h.data[H])&&(h.data[H]={}),isNull(h.data[H][f])&&(h.data[H][f]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),E.diseasedetected.toBool()?h.data[H][f].positive++:"no_confidence"===E.diseasedetected.toLowerCase()?h.data[H][f].no_confidence++:h.data[H][f].negative++,h.data[H][f].samples++,x=h.data[H][f].positive/h.data[H][f].samples,h.data[H][f].prevalence=x,G[H]=E}F=d,Object.doOnSortedKeys(G,function(a){return w.push(a)})}catch(a){C=z.rows;for(v in C)E=C[v],E.carto_table=z.table,E.project_id=z.project_id,w.push(E)}if(g=JSON.stringify(F),isNull(g)){console.warn("Got bad data for row #"+p+"!",z,z.rows,g);continue}g=""+g}catch(a){g="Invalid data from server"}N=y=b[z.table],E='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+i+"px;min-width:"+j+'px">'+g+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+y.id+'" icon="icons:arrow-forward" title="'+y.name+'"></paper-icon-button></td>\n</tr>',A.push(E)}L={},M={},D=h.data;for(H in D){l=D[H];for(k in l)g=l[k],null==L[k]&&(L[k]=[],M[k]={}),x=100*g.prevalence,x=roundNumberSigfig(x,2),J="<tr>\n  <td>"+H+"</td>\n  <td>"+g.samples+"</td>\n  <td>"+g.positive+"</td>\n  <td>"+g.negative+"</td>\n  <td>"+x+"%</td>\n</tr>",L[k].push(J),M[k][H]=J}K="";for(k in M){O=M[k];try{"object"==typeof O?(P=[],Object.doOnSortedKeys(O,function(a){return P.push(a)})):(console.warn("Warning: table rows aren't an object"),P=O)}catch(a){m=a,console.error("Can't sort rows: "+m.message),console.warn(m.stack),P=L[k]}K+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+k+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+P.join("\n")+"\n    </table>\n  </div>\n</div>"}return isNull(K)&&(K="<h3><em>Sorry, we were unable to generate a summary table</em></h3>"),o='<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+K+'\n    <div class="row">\n      <div class="col-xs-12">\n        <h3>Raw Data</h3>\n        <table class="table table-striped">\n          <tr>\n            <th colspan="4">Query Data</th>\n            <th>Visit Project</th>\n          </tr>\n          '+A.join("\n")+'\n        </table>\n      </div>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',u={html:o,outputData:w,data:h,summaryRows:L,providedList:a,providedMap:b,providedWidth:c},n=Date.now()-I,console.info("Worker saved "+n+"ms from the main thread"),self.postMessage(u),self.close()},locationData={},locationData.params={enableHighAccuracy:!0},locationData.last=void 0,isBool=function(a,b){var c;if(null==b&&(b=!1),b)return"boolean"==typeof a;try{return"boolean"==typeof a?a===!0||a===!1:"string"==typeof a?"true"===a.toLowerCase()||"false"===a.toLowerCase():"number"==typeof a&&(1===a||0===a)}catch(a){return c=a,!1}},isEmpty=function(a){return!a||0===a.length},isBlank=function(a){return!a||/^\s*$/.test(a)},isNull=function(a){var b;try{if((isEmpty(a)||isBlank(a)||null==a)&&a!==!1&&0!==a)return!0}catch(a){return b=a,!1}return!1},isJson=function(a){if("object"==typeof a&&!isArray(a))return!0;try{return JSON.parse(a),!0}catch(a){return!1}return!1},isArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),!0}catch(a){return!1}},isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},toFloat=function(a){return!isNumber(a)||isNull(a)?0:parseFloat(a)},toInt=function(a){var b;return!isNumber(a)||isNull(a)?0:(b=parseFloat(a),parseInt(b))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var a;return a=(""+this).toLowerCase(),"true"===a||"1"===a},Boolean.prototype.toBool=function(){return""+this=="true"},Number.prototype.toBool=function(){return""+this=="1"},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(a){var b,c;try{return c=_.find(this,function(b){return _.isEqual(a,b)}),"object"==typeof c}catch(a){return b=a,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),a}catch(a){}return Object.keys(a).map(function(b){return function(b){return a[b]}}(this))},Object.size=function(a){var b,c,d;if("object"!=typeof a)try{return a.length}catch(a){b=a,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(b.message)}d=0;for(c in a)a.hasOwnProperty(c)&&d++;return d},Object.doOnSortedKeys=function(a,b){var c,d,e,f,g,h;for(h=Object.keys(a).sort(),g=[],d=0,f=h.length;d<f;d++)e=h[d],c=a[e],g.push(b(c));return g},delay=function(a,b){return setTimeout(b,a)},roundNumber=function(a,b){var c;return null==b&&(b=0),c=Math.pow(10,b),Math.round(a*c)/c},roundNumberSigfig=function(a,b){var c,d,e,f,g;return null==b&&(b=0),e=""+roundNumber(a,b),c=e.split("."),1===c.length?e+"."+Array(b+1).join("0"):(g=c.pop(),f=c[0]+".",g.length===b?e:(d=b-g.length,g+=Array(d+1).join("0"),""+f+g))},String.prototype.stripHtml=function(a){var b;return null==a&&(a=!1),b=this,a&&(b=b.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),b=b.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),b=b.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(a){var b,c,d,e;return null==a&&(a=!1),c=document.createElement("div"),b=function(b){return null!=b&&"string"==typeof b&&(a!==!0?b=escape(b).replace(/%26/g,"&").replace(/%23/g,"#").replace(/%3B/g,";"):(b=b.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),b=b.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")),c.innerHTML=b,c.innerText?(b=c.innerText,c.innerText=""):(b=c.textContent,c.textContent="")),unescape(b)},d=function(a){return a=a.replace(/\&amp;#/gm,"&#"),a=a.replace(/\&quot;/gm,'"'),a=a.replace(/\&quote;/gm,'"'),a=a.replace(/\&#95;/gm,"_"),a=a.replace(/\&#39;/gm,"'"),a=a.replace(/\&#34;/gm,'"'),a=a.replace(/\&#62;/gm,">"),a=a.replace(/\&#60;/gm,"<")},e=d(this),b(e)},deEscape=function(a){return a=a.replace(/\&amp;#/gm,"&#"),a=a.replace(/\&quot;/gm,'"'),a=a.replace(/\&quote;/gm,'"'),a=a.replace(/\&#95;/gm,"_"),a=a.replace(/\&#39;/gm,"'"),a=a.replace(/\&#34;/gm,'"'),a=a.replace(/\&#62;/gm,">"),a=a.replace(/\&#60;/gm,"<")},jsonTo64=function(a,b){var c,d,e;null==b&&(b=!0);try{e=a.slice(0),e.push("foo"),a=toObject(a)}catch(a){}return d=JSON.stringify(a),c=b===!0?post64(d):encode64(c)},encode64=function(a){var b;try{return Base64.encode(a)}catch(c){return b=c,console.warn("Bad encode string provided"),a}},decode64=function(a){var b;try{return Base64.decode(a)}catch(c){return b=c,console.warn("Bad decode string provided"),a}},post64=function(a){var b,c;return c=encode64(a),b=encodeURIComponent(c)},byteCount=function(a){return function(a){return encodeURI(a).split(/%..|./).length-1}}(this),toObject=function(a){var b,c,d;d={};for(c in a)b=a[c],void 0!==b&&(d[c]=b);return d},String.prototype.toTitleCase=function(){var a,b,c,d,e,f,g,h,i,j,k;for(h=this.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),g=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],a=0,c=g.length;a<c;a++)e=g[a],f=RegExp("\\s"+e+"\\s","g"),h=h.replace(f,function(a){return a.toLowerCase()});for(k=["Id","Tv"],b=0,d=k.length;b<d;b++)i=k[b],j=RegExp("\\b"+i+"\\b","g"),h=h.replace(j,i.toUpperCase());return h},Function.prototype.getName=function(){var a;return a=this.name,null==a&&(a=(""+this).substr(0,(""+this).indexOf("(")).replace("function ","")),isNull(a)&&(a=md5(""+this)),a},randomInt=function(a,b){var c,d,e;return null==a&&(a=0),null==b&&(b=1),e=Math.random(),null==a&&(c=[0,a],a=c[0],b=c[1]),a>b&&(d=[b,a],a=d[0],b=d[1]),Math.floor(e*(b-a+1)+a)},randomString=function(a){var b,c,d,e,f;for(null==a&&(a=8),e=0,c=65,d=126,f=[];e<a;)++e,b=randomInt(c,d),f.push(String.fromCharCode(b));return f.join("")},openLink=function(a){return null!=a&&(open(a),!1)},openTab=function(a){return openLink(a)},goTo=function(a){return null!=a&&(location.href=a,!1)},dateMonthToString=function(a){var b,c;b={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{c=b[a]}catch(b){c=a}return c},prepURI=function(a){return a=encodeURIComponent(a),a.replace(/%20/g,"+")},locationData={},locationData.params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(a){var b,c,d,e;return null==a&&(a=void 0),e=1500,c=function(b){var c,f;return clearTimeout(d),locationData.lat=b.coords.latitude,locationData.lng=b.coords.longitude,locationData.acc=b.coords.accuracy,f=locationData.last,locationData.last=Date.now(),c=locationData.last-f,!(c<e)&&(console.info("Successfully set location"),"function"==typeof a&&a(locationData),!1)},b=function(b){var c;return clearTimeout(d),c=function(){switch(b.code){case 0:return"There was an error while retrieving your location: "+b.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+b.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(c),"function"==typeof a&&a(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(c,b,locationData.params),d=delay(1500,function(){return getLocation(a)})):(console.warn("This browser doesn't support geolocation!"),null!=a?a(!1):void 0)},downloadCSVFile=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(s=Date.now(),t="",isJson(a))console.info("Parsing as JSON string"),m=JSON.parse(a);else if(isArray(a))console.info("Parsing as array"),m=toObject(a);else{if("object"!=typeof a)return console.error("Unexpected data type '"+typeof a+"' for downloadCSVFile()",a),!1;console.info("Parsing as object"),m=a}for(null==b&&(b={}),null==b.create&&(b.create=!1),null==b.downloadFile&&(b.downloadFile="datalist.csv"),null==b.classes&&(b.classes="btn btn-default"),null==b.buttonText&&(b.buttonText="Download File"),null==b.iconHtml&&(b.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==b.selector&&(b.selector="#download-file"),null==b.splitValues&&(b.splitValues=!1),null==b.cascadeObjects&&(b.cascadeObjects=!1),null==b.objectAsValues&&(b.objectAsValues=!1),h=[],(p=function(c,d){var e,f,g,i,j,k,l,m,n,o,q,r,s;o=0,b.objectAsValues&&(b.splitValues="::@@::"),n=[];for(l in c)if(s=c[l],"function"!=typeof s){++o;try{if(i=(""+l).replace(/"/g,'""'),1===o)if(b.objectAsValues){console.info("objectAsValues set");for(e in s)a=s[e],isArray(b.acceptableCols)?indexOf.call(b.acceptableCols,e)>=0&&h.push(e):h.push(e);console.log("Using as header",h)}else console.log("Boring options",b.objectAsValues,b),h.push(i);if("object"==typeof s&&d&&(s=p(s,!0)),j=function(a,c){var d,e,f,g;return null==a&&(a=s),null==c&&(c=b),isNull(s)?d="":("object"==typeof a&&(a=JSON.stringify(a)),a=""+a,e=a.replace(/"/g,'""'),e=a.replace(/<\/p><p>/g,'","'),"string"==typeof c.splitValues&&(f=e.split(c.splitValues),e=f.join('","'),i=!1),d=e),i===!1?g='"'+d+'"\n':isNumber(i)?g='"'+d+'",':isNull(i)||(g='"'+i+'","'+d+'"\n'),g},b.objectAsValues){for(q=[],k=0,m=h.length;k<m;k++){if(e=h[k],f=s[e],"object"==typeof f)try{f=JSON.stringify(f),f=f.replace(/"/g,'""')}catch(a){}q.push(f)}r=q.join(b.splitValues),n.push(t+=j(r,b))}else n.push(t+=j(s))}catch(a){g=a,console.warn("Unable to run key "+l+" on row "+o,s,c),n.push(console.warn(g.stack))}}return n})(m,b.cascadeObjects),t=t.trim(),n=0,l=0,o=h.length;l<o;l++)d=h[l],d=d.replace(/"/g,'""'),h[n]=d,++n;return b.objectAsValues&&(b.header=h),isArray(b.header)?(i=b.header.join('","'),t='"'+i+'"\n'+t,t=t.trim(),g="present"):g="absent",","===t.slice(-1)&&(t=t.slice(0,-1)),f="data:text/csv;charset=utf-8;header="+g+","+encodeURIComponent(t),r=b.selector,b.create===!0?(c=randomInt(0,9999),k=r.slice(1)+"-download-button-"+c,j='<a id="'+k+'" class="'+b.classes+'" href="'+f+'" download="'+b.downloadFile+'">\n  '+b.iconHtml+"\n  "+b.buttonText+"\n</a>"):j="",q={file:f,options:b,html:j},e=Date.now()-s,console.debug("CSV Worker saved "+e+"ms from main thread"),q},generateCSVFromResults=function(a,b,c){var d,e;null==c&&(c="#modal-sql-details-list"),console.info("Worker CSV: Given",a),d={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv",acceptableCols:["collectionid","catalognumber","fieldnumber","diseasetested","diseasestrain","samplemethod","sampledisposition","diseasedetected","fatal","cladesampled","genus","specificepithet","infraspecificepithet","lifestage","dateidentified","decimallatitude","decimallongitude","alt","coordinateuncertaintyinmeters","collector","fimsextra","originaltaxa"]};try{e=downloadCSVFile(a,d)}catch(a){console.error("Sorry, there was a problem with this dataset and we can't do that right now."),e={file:"",options:d,html:""}}return e},validateAWebTaxon=function(a,b){var c,d,e;return null==b&&(b=null),null==(void 0!==e&&null!==e?e.validatedTaxons:void 0)&&("object"!=typeof e&&(e={}),e.validatedTaxons=[]),d=function(a){return"function"==typeof b&&b(a),!1},e.validatedTaxons.containsObject(a)?(console.info("Already validated taxon, skipping revalidation",a),d(a),!1):(c="action=validate&genus="+a.genus+"&species="+a.species,null!=a.subspecies&&(c+="&subspecies="+a.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(b){return b.status?(a.genus=b.validated_taxon.genus,a.species=b.validated_taxon.species,a.subspecies=b.validated_taxon.subspecies,null==a.clade&&(a.clade=b.validated_taxon.family),e.validatedTaxons.push(a)):a.invalid=!0,a.response=b,d(a),!1}).fail(function(b,c){var d;return d=a.genus+" "+a.species,d=null!=a.subspecies?d+" "+a.subspecies:d,bsAlert("<strong>Problem validating taxon:</strong> "+d+" couldn't be validated."),console.warn("Warning: Couldn't validated "+d+" with AmphibiaWeb")}),!1)};
//# sourceMappingURL=global-search-worker.min.js.map