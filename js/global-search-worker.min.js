var byteCount,dateMonthToString,deEscape,decode64,delay,downloadCSVFile,encode64,generateCSVFromResults,getLocation,getPrettySpecies,getSampleSummaryDialog,goTo,isArray,isBlank,isBool,isEmpty,isJson,isNull,isNumber,jsonTo64,locationData,openLink,openTab,post64,prepURI,randomInt,randomString,roundNumber,roundNumberSigfig,toFloat,toInt,toObject,validateAWebTaxon,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};function shuffle(e){for(var t,n,o=e.length;o;t=Math.floor(Math.random()*o),n=e[--o],e[o]=e[t],e[t]=n);return e}self.addEventListener("message",function(e){var t,n,o,r,a;switch(e.data.action){case"summary-dialog":return n=e.data.resultsList,a=e.data.tableToProjectMap,getSampleSummaryDialog(n,a,e.data.windowWidth);case"csv":return t=e.data.data,o=e.data.options,r=downloadCSVFile(t,o),console.info("CSV file successfully generated"),self.postMessage(r),self.close()}}),getPrettySpecies=function(e){var t,n,o,r,a,s;return t=e.genus,a=null!=(o=e.specificEpithet)?o:e.specificepithet,s=null!=(r=e.infraspecificEpithet)?r:e.infraspecificEpithet,n=t,isNull(a)||(n+=" "+a,isNull(s)||(n+=" "+s)),n},getSampleSummaryDialog=function(e,t,n){var o,r,a,s,i,l,c,u,p,d,f,g,h,m,b,y,v,w,j,S,x,A,N,O,C,D,T,V,F,_,B,k,I,L,M,P,E,J,R,W,U;if(k=Date.now(),isArray(e)||(e=Object.toArray(e)),0===e.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from list of length "+e.length,e),N=[],x=[],w=[],U=["cartodb_id","the_geom","the_geom_webmercator","id"],s={species:[],diseases:[],data:{}},g=f=0,m=e.length;g<m;g++){A=e[g],++f,i=.5*n,l=.3*n;try{F=A.rows;try{for(v in o={},_={},C=A.rows){for(V=C[v],h=0,b=U.length;h<b;h++)delete V[U[h]];(o[v]=V).carto_table=A.table,V.project_id=A.project_id,B=getPrettySpecies(V),indexOf.call(s.species,B)<0&&s.species.push(B),r=V.diseasetested,indexOf.call(s.diseases,r)<0&&s.diseases.push(r),isNull(s.data[B])&&(s.data[B]={}),isNull(s.data[B][r])&&(s.data[B][r]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),V.diseasedetected.toBool()?s.data[B][r].positive++:"no_confidence"===V.diseasedetected.toLowerCase()?s.data[B][r].no_confidence++:s.data[B][r].negative++,s.data[B][r].samples++,j=s.data[B][r].positive/s.data[B][r].samples,s.data[B][r].prevalence=j,_[B]=V}F=o,Object.doOnSortedKeys(_,function(e){return w.push(e)})}catch(e){for(v in D=A.rows)(V=D[v]).carto_table=A.table,V.project_id=A.project_id,w.push(V)}if(a=JSON.stringify(F),isNull(a)){console.warn("Got bad data for row #"+f+"!",A,A.rows,a);continue}a=""+a}catch(e){a="Invalid data from server"}S=t[A.table],V='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+i+"px;min-width:"+l+'px">'+a+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+S.id+'" icon="icons:arrow-forward" title="'+S.name+'"></paper-icon-button></td>\n</tr>',N.push(V),x.push(a)}for(B in E={},J={},I=[],T=s.data)for(c in u=T[B])a=u[c],null==E[c]&&(E[c]=[],J[c]={}),j=100*a.prevalence,j=roundNumberSigfig(j,2),L="<tr>\n  <td>"+B+"</td>\n  <td>"+a.samples+"</td>\n  <td>"+a.positive+"</td>\n  <td>"+a.negative+"</td>\n  <td>"+j+"%</td>\n</tr>",M={genus:B.split(" ")[0],species:B.split(" ")[1],fullScientificName:B,disease:c,samples:a.samples,positive:a.positive,negative:a.negative,prevalence:j+"%"},I.push(M),E[c].push(L),J[c][B]=L;for(c in P="",J){R=J[c];try{"object"==typeof R?(W=[],Object.doOnSortedKeys(R,function(e){return W.push(e)})):(console.warn("Warning: table rows aren't an object"),W=R)}catch(e){console.error("Can't sort rows: "+(p=e).message),console.warn(p.stack),W=E[c]}P+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+c+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+W.join("\n")+"\n    </table>\n  </div>\n</div>"}return isNull(P)&&(P="<h3><em>Sorry, we were unable to generate a summary table</em></h3>"),O='<div class="row">\n  <div class="col-xs-12">\n    <h3>Raw Data</h3>\n    <table class="table table-striped">\n      <tr>\n        <th colspan="4">Query Data</th>\n        <th>Visit Project</th>\n      </tr>\n      '+N.join("\n")+"\n    </table>\n  </div>\n</div>",y={html:'<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+P+'\n\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',outputData:w,data:s,summaryRowData:I,summaryRows:E,providedList:e,providedMap:t,providedWidth:n,rawProjectData:x,rawDataHtml:O},d=Date.now()-k,console.info("Worker saved "+d+"ms from the main thread"),self.postMessage(y),self.close()},(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,isBool=function(e,t){if(null==t&&(t=!1),t)return"boolean"==typeof e;try{return"boolean"==typeof e?!0===e||!1===e:"string"==typeof e?"true"===e.toLowerCase()||"false"===e.toLowerCase():"number"==typeof e&&(1===e||0===e)}catch(e){return e,!1}},isEmpty=function(e){return!e||0===e.length},isBlank=function(e){return!e||/^\s*$/.test(e)},isNull=function(e){try{if((isEmpty(e)||isBlank(e)||null==e)&&!1!==e&&0!==e)return!0}catch(e){return e,!1}return!1},isJson=function(e){if("object"==typeof e&&!isArray(e))return!0;try{return JSON.parse(e),!0}catch(e){return!1}return!1},isArray=function(e){try{return e.slice(0).push("foo"),!0}catch(e){return!1}},isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},toFloat=function(e){return!isNumber(e)||isNull(e)?0:parseFloat(e)},toInt=function(e){return!isNumber(e)||isNull(e)?0:parseInt(parseFloat(e))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var e;return"true"===(e=this.toString().toLowerCase())||"1"===e},Boolean.prototype.toBool=function(){return"true"===this.toString()},Number.prototype.toBool=function(){return"1"===this.toString()},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(t){try{return"object"==typeof _.find(this,function(e){return _.isEqual(t,e)})}catch(e){return e,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(t){try{return t.slice(0).push("foo"),t}catch(e){}return Object.keys(t).map(function(e){return t[e]})},Object.size=function(e){var t,n,o;if("object"!=typeof e)try{return e.length}catch(e){t=e,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(t.message)}for(n in o=0,e)e.hasOwnProperty(n)&&o++;return o},Object.doOnSortedKeys=function(e,t){var n,o,r,a,s;for(a=[],o=0,r=(s=Object.keys(e).sort()).length;o<r;o++)n=e[s[o]],a.push(t(n));return a},delay=function(e,t){return setTimeout(t,e)},roundNumber=function(e,t){var n;return null==t&&(t=0),Math.round(e*(n=Math.pow(10,t)))/n},roundNumberSigfig=function(e,t){var n,o,r,a,s;return null==t&&(t=0),1===(n=(r=roundNumber(e,t).toString()).split(".")).length?r+"."+Array(t+1).join("0"):(s=n.pop(),a=n[0]+".",s.length===t?r:(o=t-s.length,""+a+(s+=Array(o+1).join("0"))))},String.prototype.stripHtml=function(e){var t;return null==e&&(e=!1),t=this,e&&(t=t.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),t=(t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(t){var n;return null==t&&(t=!1),n=document.createElement("div"),function(e){return null!=e&&"string"==typeof e&&(e=!0!==t?escape(e).replace(/%26/g,"&").replace(/%23/g,"#").replace(/%3B/g,";"):(e=e.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),n.innerHTML=e,n.innerText?(e=n.innerText,n.innerText=""):(e=n.textContent,n.textContent="")),unescape(e)}(function(e){return e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\&amp;#/gm,"&#")).replace(/\&quot;/gm,'"')).replace(/\&quote;/gm,'"')).replace(/\&#95;/gm,"_")).replace(/\&#39;/gm,"'")).replace(/\&#34;/gm,'"')).replace(/\&#62;/gm,">")).replace(/\&#60;/gm,"<")}(this))},deEscape=function(e){return e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\&amp;#/gm,"&#")).replace(/\&quot;/gm,'"')).replace(/\&quote;/gm,'"')).replace(/\&#95;/gm,"_")).replace(/\&#39;/gm,"'")).replace(/\&#34;/gm,'"')).replace(/\&#62;/gm,">")).replace(/\&#60;/gm,"<")},jsonTo64=function(e,t){var n,o;null==t&&(t=!0);try{e.slice(0).push("foo"),e=toObject(e)}catch(e){}return o=JSON.stringify(e),n=!0===t?post64(o):encode64(n)},encode64=function(t){try{return Base64.encode(t)}catch(e){return e,console.warn("Bad encode string provided"),t}},decode64=function(t){try{return Base64.decode(t)}catch(e){return e,console.warn("Bad decode string provided"),t}},post64=function(e){var t;return t=encode64(e),encodeURIComponent(t)},byteCount=function(e){return encodeURI(e).split(/%..|./).length-1},toObject=function(e){var t,n,o;for(n in o={},e)void 0!==(t=e[n])&&(o[n]=t);return o},String.prototype.toTitleCase=function(){var e,t,n,o,r,a,s,i,l,c;for(s=this.replace(/([^\W_]+[^\s-]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),e=0,n=(a=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"]).length;e<n;e++)r=RegExp("\\s"+a[e]+"\\s","g"),s=s.replace(r,function(e){return e.toLowerCase()});for(t=0,o=(c=["Id","Tv"]).length;t<o;t++)l=RegExp("\\b"+(i=c[t])+"\\b","g"),s=s.replace(l,i.toUpperCase());return s},Function.prototype.getName=function(){var e;return null==(e=this.name)&&(e=this.toString().substr(0,this.toString().indexOf("(")).replace("function ","")),isNull(e)&&(e=md5(this.toString())),e},randomInt=function(e,t){var n,o,r;return null==e&&(e=0),null==t&&(t=1),r=Math.random(),null==e&&(e=(n=[0,e])[0],t=n[1]),t<e&&(e=(o=[t,e])[0],t=o[1]),Math.floor(r*(t-e+1)+e)},randomString=function(e){var t,n,o;for(null==e&&(e=8),n=0,65,126,o=[];n<e;)++n,t=randomInt(65,126),o.push(String.fromCharCode(t));return o.join("")},openLink=function(e){return null==e||open(e),!1},openTab=function(e){return openLink(e)},goTo=function(e){return null==e||(location.href=e),!1},dateMonthToString=function(t){var e,n;e={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{n=e[t]}catch(e){n=t}return n},prepURI=function(e){return(e=encodeURIComponent(e)).replace(/%20/g,"+")},(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(n){var e,t,o;return null==n&&(n=void 0),1500,t=function(e){var t;return clearTimeout(o),locationData.lat=e.coords.latitude,locationData.lng=e.coords.longitude,locationData.acc=e.coords.accuracy,t=locationData.last,locationData.last=Date.now(),locationData.last-t<1500||(console.info("Successfully set location"),"function"==typeof n&&n(locationData)),!1},e=function(e){var t;return clearTimeout(o),t=function(){switch(e.code){case 0:return"There was an error while retrieving your location: "+e.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+e.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(t),"function"==typeof n&&n(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(t,e,locationData.params),o=delay(1500,function(){return getLocation(n)})):(console.warn("This browser doesn't support geolocation!"),null!=n?n(!1):void 0)},downloadCSVFile=function(g,h){var e,t,m,n,o,r,b,a,s,i,l,c,u,y,p,d,f,v;if(f=Date.now(),v="",isJson(g)&&"string"==typeof g){console.info("Parsing as JSON string");try{l=JSON.parse(g)}catch(e){throw console.error("COuldn't parse json! "+(m=e).message),console.warn(m.stack),console.info(g),"error"}}else if(isArray(g))console.info("Parsing as array"),l=toObject(g);else{if("object"!=typeof g)return console.error("Unexpected data type '"+typeof g+"' for downloadCSVFile()",g),!1;console.info("Parsing as object"),l=g}for(null==h&&(h={}),null==h.create&&(h.create=!1),null==h.downloadFile&&(h.downloadFile="datalist.csv"),null==h.classes&&(h.classes="btn btn-default"),null==h.buttonText&&(h.buttonText="Download File"),null==h.iconHtml&&(h.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==h.selector&&(h.selector="#download-file"),null==h.splitValues&&(h.splitValues=!1),null==h.cascadeObjects&&(h.cascadeObjects=!1),null==h.objectAsValues&&(h.objectAsValues=!0),b=[],(y=function(t,e){var n,o,a,r,s,i,l,c,u,p,d,f;for(i in u=0,h.objectAsValues&&(h.splitValues="::@@::"),c=[],t)if("function"!=typeof(f=t[i])){++u;try{if(a=i.toString().replace(/"/g,'""'),1===u)if(h.objectAsValues){for(n in console.info("objectAsValues set"),f)g=f[n],isArray(h.acceptableCols)?0<=indexOf.call(h.acceptableCols,n)&&b.push(n):b.push(n);console.log("Using as header",b)}else console.log("Boring options",h.objectAsValues,h),b.push(a);if("object"==typeof f&&e&&(f=y(f,!0)),r=function(e,t){var n,o,r;return null==e&&(e=f),null==t&&(t=h),isNull(f)?n="":("object"==typeof e&&(e=JSON.stringify(e)),o=(o=(o=(e=e.toString()).replace(/,/g,",")).replace(/"/g,'""')).replace(/<\/p><p>/g,'","'),"string"==typeof t.splitValues&&(o=o.split(t.splitValues).join('","'),a=!1),n=o),!1===a?r='"'+n+'"\n':isNumber(a)?r='"'+n+'",':isNull(a)||(r='"'+a+'","'+n+'"\n'),r},h.objectAsValues){for(p=[],s=0,l=b.length;s<l;s++){if(n=b[s],"object"==typeof(o=f[n]))try{o=(o=JSON.stringify(o)).replace(/"/g,'""')}catch(e){}p.push(o)}d=p.join(h.splitValues),c.push(v+=r(d,h))}else c.push(v+=r(f))}catch(e){m=e,console.warn("Unable to run key "+i+" on row "+u,f,t),c.push(console.warn(m.stack))}}return c})(l,h.cascadeObjects),v=v.trim(),i=c=0,u=b.length;i<u;i++)t=(t=b[i]).replace(/"/g,'""'),b[c]=t,++c;return h.objectAsValues&&(h.header=b),isArray(h.header)?(a=h.header.join('","'),v=(v='"'+a+'"\n'+v).trim(),r="present"):r="absent",","===v.slice(-1)&&(v=v.slice(0,-1)),o="data:text/csv;charset=utf-8;header="+r+","+encodeURIComponent(v),d=h.selector,!0===h.create?(e=randomInt(0,9999),s='<a id="'+(d.slice(1)+"-download-button-"+e)+'" class="'+h.classes+'" href="'+o+'" download="'+h.downloadFile+'">\n  '+h.iconHtml+"\n  "+h.buttonText+"\n</a>"):s="",p={file:o,options:h,html:s},n=Date.now()-f,console.debug("CSV Worker saved "+n+"ms from main thread"),p},generateCSVFromResults=function(e,t,n){var o,r;null==n&&(n="#modal-sql-details-list"),console.info("Worker CSV: Given",e),o={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv"};try{r=downloadCSVFile(e,o)}catch(e){console.error("Sorry, there was a problem with this dataset and we can't do that right now."),r={file:"",options:o,html:""}}return r},validateAWebTaxon=function(o,t){var e,n,r;return null==t&&(t=null),null==(null!=r?r.validatedTaxons:void 0)&&("object"!=typeof r&&(r={}),r.validatedTaxons=[]),n=function(e){return"function"==typeof t&&t(e),!1},r.validatedTaxons.containsObject(o)?(console.info("Already validated taxon, skipping revalidation",o),n(o)):(e="action=validate&genus="+o.genus+"&species="+o.species,null!=o.subspecies&&(e+="&subspecies="+o.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",e,"json").done(function(e){return e.status?(o.genus=e.validated_taxon.genus,o.species=e.validated_taxon.species,o.subspecies=e.validated_taxon.subspecies,null==o.clade&&(o.clade=e.validated_taxon.family),r.validatedTaxons.push(o)):o.invalid=!0,o.response=e,n(o),!1}).fail(function(e,t){var n;return n=o.genus+" "+o.species,n=null!=o.subspecies?n+" "+o.subspecies:n,bsAlert("<strong>Problem validating taxon:</strong> "+n+" couldn't be validated."),console.warn("Warning: Couldn't validated "+n+" with AmphibiaWeb with owrker")})),!1};
//# sourceMappingURL=global-search-worker.min.js.map