function shuffle(e){for(var t,n,o=e.length;o;t=Math.floor(Math.random()*o),n=e[--o],e[o]=e[t],e[t]=n);return e}var byteCount,dateMonthToString,deEscape,decode64,delay,downloadCSVFile,encode64,generateCSVFromResults,getLocation,getPrettySpecies,getSampleSummaryDialog,goTo,isArray,isBlank,isBool,isEmpty,isJson,isNull,isNumber,jsonTo64,locationData,openLink,openTab,post64,prepURI,randomInt,randomString,roundNumber,roundNumberSigfig,toFloat,toInt,toObject,validateAWebTaxon,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};self.addEventListener("message",function(e){var t,n,o,r,a;switch(e.data.action){case"summary-dialog":return n=e.data.resultsList,a=e.data.tableToProjectMap,getSampleSummaryDialog(n,a,e.data.windowWidth);case"csv":return t=e.data.data,o=e.data.options,r=downloadCSVFile(t,o),console.info("CSV file successfully generated"),self.postMessage(r),self.close()}}),getPrettySpecies=function(e){var t,n,o,r,a,s;return t=e.genus,a=null!=(o=e.specificEpithet)?o:e.specificepithet,s=null!=(r=e.infraspecificEpithet)?r:e.infraspecificEpithet,n=t,isNull(a)||(n+=" "+a,isNull(s)||(n+=" "+s)),n},getSampleSummaryDialog=function(e,t,n){var o,r,a,s,i,l,c,u,p,d,f,g,h,m,b,y,v,w,j,S,x,A,N,O,C,D,T,V,F,_,B,k,I,L,M,P,E,J,R,W,U,q;if(I=Date.now(),isArray(e)||(e=Object.toArray(e)),0===e.length)return console.warn("There were no results in the result list"),!1;for(console.log("Generating dialog from list of length "+e.length,e),O=[],A=[],j=[],g=0,q=["cartodb_id","the_geom","the_geom_webmercator","id"],s={species:[],diseases:[],data:{}},h=0,b=e.length;h<b;h++){N=e[h],++g,i=.5*n,l=.3*n;try{_=N.rows;try{o={},B={},D=N.rows;for(w in D){for(F=D[w],m=0,y=4;m<y;m++)delete F[q[m]];o[w]=F,F.carto_table=N.table,F.project_id=N.project_id,k=getPrettySpecies(F),indexOf.call(s.species,k)<0&&s.species.push(k),r=F.diseasetested,indexOf.call(s.diseases,r)<0&&s.diseases.push(r),isNull(s.data[k])&&(s.data[k]={}),isNull(s.data[k][r])&&(s.data[k][r]={samples:0,positive:0,negative:0,no_confidence:0,prevalence:0}),F.diseasedetected.toBool()?s.data[k][r].positive++:"no_confidence"===F.diseasedetected.toLowerCase()?s.data[k][r].no_confidence++:s.data[k][r].negative++,s.data[k][r].samples++,S=s.data[k][r].positive/s.data[k][r].samples,s.data[k][r].prevalence=S,B[k]=F}_=o,Object.doOnSortedKeys(B,function(e){return j.push(e)})}catch(e){T=N.rows;for(w in T)(F=T[w]).carto_table=N.table,F.project_id=N.project_id,j.push(F)}if(a=JSON.stringify(_),isNull(a)){console.warn("Got bad data for row #"+g+"!",N,N.rows,a);continue}a=""+a}catch(e){a="Invalid data from server"}x=t[N.table],F='<tr>\n  <td colspan="4" class="code-box-container"><pre readonly class="code-box language-json" style="max-width:'+i+"px;min-width:"+l+'px">'+a+'</pre></td>\n  <td class="text-center"><paper-icon-button data-toggle="tooltip" raised class="click" data-href="https://amphibiandisease.org/project.php?id='+x.id+'" icon="icons:arrow-forward" title="'+x.name+'"></paper-icon-button></td>\n</tr>',O.push(F),A.push(a)}J={},R={},L=[],V=s.data;for(k in V){u=V[k];for(c in u)a=u[c],null==J[c]&&(J[c]=[],R[c]={}),S=100*a.prevalence,S=roundNumberSigfig(S,2),M="<tr>\n  <td>"+k+"</td>\n  <td>"+a.samples+"</td>\n  <td>"+a.positive+"</td>\n  <td>"+a.negative+"</td>\n  <td>"+S+"%</td>\n</tr>",P={genus:k.split(" ")[0],species:k.split(" ")[1],fullScientificName:k,disease:c,samples:a.samples,positive:a.positive,negative:a.negative,prevalence:S+"%"},L.push(P),J[c].push(M),R[c][k]=M}E="";for(c in R){W=R[c];try{"object"==typeof W?(U=[],Object.doOnSortedKeys(W,function(e){return U.push(e)})):(console.warn("Warning: table rows aren't an object"),U=W)}catch(e){p=e,console.error("Can't sort rows: "+p.message),console.warn(p.stack),U=J[c]}E+='<div class="row">\n  <div class="col-xs-12">\n    <h3>'+c+'</h3>\n    <table class="table table-striped">\n      <tr>\n        <th>Species</th>\n        <th>Samples</th>\n        <th>Disease Positive</th>\n        <th>Disease Negative</th>\n        <th>Disease Prevalence</th>\n      </tr>\n      '+U.join("\n")+"\n    </table>\n  </div>\n</div>"}return isNull(E)&&(E="<h3><em>Sorry, we were unable to generate a summary table</em></h3>"),C='<div class="row">\n  <div class="col-xs-12">\n    <h3>Raw Data</h3>\n    <table class="table table-striped">\n      <tr>\n        <th colspan="4">Query Data</th>\n        <th>Visit Project</th>\n      </tr>\n      '+O.join("\n")+"\n    </table>\n  </div>\n</div>",f='<paper-dialog id="modal-sql-details-list" modal always-on-top auto-fit-on-attach>\n  <h2>Project Result List</h2>\n  <paper-dialog-scrollable>\n    '+E+'\n\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="generate-download">Create Download</paper-button>\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',v={html:f,outputData:j,data:s,summaryRowData:L,summaryRows:J,providedList:e,providedMap:t,providedWidth:n,rawProjectData:A,rawDataHtml:C},d=Date.now()-I,console.info("Worker saved "+d+"ms from the main thread"),self.postMessage(v),self.close()},(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,isBool=function(e,t){if(null==t&&(t=!1),t)return"boolean"==typeof e;try{return"boolean"==typeof e?!0===e||!1===e:"string"==typeof e?"true"===e.toLowerCase()||"false"===e.toLowerCase():"number"==typeof e&&(1===e||0===e)}catch(e){return e,!1}},isEmpty=function(e){return!e||0===e.length},isBlank=function(e){return!e||/^\s*$/.test(e)},isNull=function(e){try{if((isEmpty(e)||isBlank(e)||null==e)&&!1!==e&&0!==e)return!0}catch(e){return e,!1}return!1},isJson=function(e){if("object"==typeof e&&!isArray(e))return!0;try{return JSON.parse(e),!0}catch(e){return!1}return!1},isArray=function(e){try{return e.slice(0).push("foo"),!0}catch(e){return!1}},isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},toFloat=function(e){return!isNumber(e)||isNull(e)?0:parseFloat(e)},toInt=function(e){var t;return!isNumber(e)||isNull(e)?0:(t=parseFloat(e),parseInt(t))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var e;return"true"===(e=(""+this).toLowerCase())||"1"===e},Boolean.prototype.toBool=function(){return""+this=="true"},Number.prototype.toBool=function(){return""+this=="1"},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(e){try{return"object"==typeof _.find(this,function(t){return _.isEqual(e,t)})}catch(e){return e,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(e){try{return e.slice(0).push("foo"),e}catch(e){}return Object.keys(e).map(function(t){return e[t]})},Object.size=function(e){var t,n,o;if("object"!=typeof e)try{return e.length}catch(e){t=e,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(t.message)}o=0;for(n in e)e.hasOwnProperty(n)&&o++;return o},Object.doOnSortedKeys=function(e,t){var n,o,r,a,s;for(a=[],o=0,r=(s=Object.keys(e).sort()).length;o<r;o++)n=e[s[o]],a.push(t(n));return a},delay=function(e,t){return setTimeout(t,e)},roundNumber=function(e,t){var n;return null==t&&(t=0),n=Math.pow(10,t),Math.round(e*n)/n},roundNumberSigfig=function(e,t){var n,o,r,a,s;return null==t&&(t=0),r=""+roundNumber(e,t),1===(n=r.split(".")).length?r+"."+Array(t+1).join("0"):(s=n.pop(),a=n[0]+".",s.length===t?r:(o=t-s.length,s+=Array(o+1).join("0"),""+a+s))},String.prototype.stripHtml=function(e){var t;return null==e&&(e=!1),t=this,e&&(t=t.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),t=t.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(e){var t,n,o,r;return null==e&&(e=!1),n=document.createElement("div"),t=function(t){return null!=t&&"string"==typeof t&&(t=!0!==e?escape(t).replace(/%26/g,"&").replace(/%23/g,"#").replace(/%3B/g,";"):(t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),n.innerHTML=t,n.innerText?(t=n.innerText,n.innerText=""):(t=n.textContent,n.textContent="")),unescape(t)},o=function(e){return e=e.replace(/\&amp;#/gm,"&#"),e=e.replace(/\&quot;/gm,'"'),e=e.replace(/\&quote;/gm,'"'),e=e.replace(/\&#95;/gm,"_"),e=e.replace(/\&#39;/gm,"'"),e=e.replace(/\&#34;/gm,'"'),e=e.replace(/\&#62;/gm,">"),e=e.replace(/\&#60;/gm,"<")},r=o(this),t(r)},deEscape=function(e){return e=e.replace(/\&amp;#/gm,"&#"),e=e.replace(/\&quot;/gm,'"'),e=e.replace(/\&quote;/gm,'"'),e=e.replace(/\&#95;/gm,"_"),e=e.replace(/\&#39;/gm,"'"),e=e.replace(/\&#34;/gm,'"'),e=e.replace(/\&#62;/gm,">"),e=e.replace(/\&#60;/gm,"<")},jsonTo64=function(e,t){var n,o;null==t&&(t=!0);try{e.slice(0).push("foo"),e=toObject(e)}catch(e){}return o=JSON.stringify(e),n=!0===t?post64(o):encode64(n)},encode64=function(e){try{return Base64.encode(e)}catch(t){return t,console.warn("Bad encode string provided"),e}},decode64=function(e){try{return Base64.decode(e)}catch(t){return t,console.warn("Bad decode string provided"),e}},post64=function(e){var t;return t=encode64(e),encodeURIComponent(t)},byteCount=function(e){return encodeURI(e).split(/%..|./).length-1},toObject=function(e){var t,n,o;o={};for(n in e)void 0!==(t=e[n])&&(o[n]=t);return o},String.prototype.toTitleCase=function(){var e,t,n,o,r,a,s,i,l;for(a=this.replace(/([^\W_]+[^\s-]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),r=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],e=0,21;e<21;e++)n=r[e],o=RegExp("\\s"+n+"\\s","g"),a=a.replace(o,function(e){return e.toLowerCase()});for(l=["Id","Tv"],t=0,2;t<2;t++)s=l[t],i=RegExp("\\b"+s+"\\b","g"),a=a.replace(i,s.toUpperCase());return a},Function.prototype.getName=function(){var e;return null==(e=this.name)&&(e=(""+this).substr(0,(""+this).indexOf("(")).replace("function ","")),isNull(e)&&(e=md5(""+this)),e},randomInt=function(e,t){var n,o,r;return null==e&&(e=0),null==t&&(t=1),r=Math.random(),null==e&&(e=(n=[0,e])[0],t=n[1]),e>t&&(e=(o=[t,e])[0],t=o[1]),Math.floor(r*(t-e+1)+e)},randomString=function(e){var t,n,o;for(null==e&&(e=8),n=0,65,126,o=[];n<e;)++n,t=randomInt(65,126),o.push(String.fromCharCode(t));return o.join("")},openLink=function(e){return null!=e&&(open(e),!1)},openTab=function(e){return openLink(e)},goTo=function(e){return null!=e&&(location.href=e,!1)},dateMonthToString=function(e){var t,n;t={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{n=t[e]}catch(t){n=e}return n},prepURI=function(e){return(e=encodeURIComponent(e)).replace(/%20/g,"+")},(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(e){var t,n,o;return null==e&&(e=void 0),1500,n=function(t){var n;return clearTimeout(o),locationData.lat=t.coords.latitude,locationData.lng=t.coords.longitude,locationData.acc=t.coords.accuracy,n=locationData.last,locationData.last=Date.now(),!(locationData.last-n<1500)&&(console.info("Successfully set location"),"function"==typeof e&&e(locationData),!1)},t=function(t){var n;return clearTimeout(o),n=function(){switch(t.code){case 0:return"There was an error while retrieving your location: "+t.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+t.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(n),"function"==typeof e&&e(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(n,t,locationData.params),o=delay(1500,function(){return getLocation(e)})):(console.warn("This browser doesn't support geolocation!"),null!=e?e(!1):void 0)},downloadCSVFile=function(e,t){var n,o,r,a,s,i,l,c,u,p,d,f,g,h,m,b,y,v;if(y=Date.now(),v="",isJson(e)&&"string"==typeof e){console.info("Parsing as JSON string");try{d=JSON.parse(e)}catch(t){throw r=t,console.error("COuldn't parse json! "+r.message),console.warn(r.stack),console.info(e),"error"}}else if(isArray(e))console.info("Parsing as array"),d=toObject(e);else{if("object"!=typeof e)return console.error("Unexpected data type '"+typeof e+"' for downloadCSVFile()",e),!1;console.info("Parsing as object"),d=e}for(null==t&&(t={}),null==t.create&&(t.create=!1),null==t.downloadFile&&(t.downloadFile="datalist.csv"),null==t.classes&&(t.classes="btn btn-default"),null==t.buttonText&&(t.buttonText="Download File"),null==t.iconHtml&&(t.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==t.selector&&(t.selector="#download-file"),null==t.splitValues&&(t.splitValues=!1),null==t.cascadeObjects&&(t.cascadeObjects=!1),null==t.objectAsValues&&(t.objectAsValues=!0),l=[],(h=function(n,o){var a,s,i,c,u,p,d,f,g,m,b,y;g=0,t.objectAsValues&&(t.splitValues="::@@::"),f=[];for(p in n)if("function"!=typeof(y=n[p])){++g;try{if(i=(""+p).replace(/"/g,'""'),1===g)if(t.objectAsValues){console.info("objectAsValues set");for(a in y)e=y[a],isArray(t.acceptableCols)?indexOf.call(t.acceptableCols,a)>=0&&l.push(a):l.push(a);console.log("Using as header",l)}else console.log("Boring options",t.objectAsValues,t),l.push(i);if("object"==typeof y&&o&&(y=h(y,!0)),c=function(e,n){var o,r,a;return null==e&&(e=y),null==n&&(n=t),isNull(y)?o="":("object"==typeof e&&(e=JSON.stringify(e)),r=(r=(r=(e=""+e).replace(/,/g,",")).replace(/"/g,'""')).replace(/<\/p><p>/g,'","'),"string"==typeof n.splitValues&&(r=r.split(n.splitValues).join('","'),i=!1),o=r),!1===i?a='"'+o+'"\n':isNumber(i)?a='"'+o+'",':isNull(i)||(a='"'+i+'","'+o+'"\n'),a},t.objectAsValues){for(m=[],u=0,d=l.length;u<d;u++){if(a=l[u],"object"==typeof(s=y[a]))try{s=(s=JSON.stringify(s)).replace(/"/g,'""')}catch(e){}m.push(s)}b=m.join(t.splitValues),f.push(v+=c(b,t))}else f.push(v+=c(y))}catch(e){r=e,console.warn("Unable to run key "+p+" on row "+g,y,n),f.push(console.warn(r.stack))}}return f})(d,t.cascadeObjects),v=v.trim(),f=0,p=0,g=l.length;p<g;p++)o=(o=l[p]).replace(/"/g,'""'),l[f]=o,++f;return t.objectAsValues&&(t.header=l),isArray(t.header)?(c=t.header.join('","'),v=(v='"'+c+'"\n'+v).trim(),i="present"):i="absent",","===v.slice(-1)&&(v=v.slice(0,-1)),s="data:text/csv;charset=utf-8;header="+i+","+encodeURIComponent(v),b=t.selector,!0===t.create?(n=randomInt(0,9999),u='<a id="'+(b.slice(1)+"-download-button-"+n)+'" class="'+t.classes+'" href="'+s+'" download="'+t.downloadFile+'">\n  '+t.iconHtml+"\n  "+t.buttonText+"\n</a>"):u="",m={file:s,options:t,html:u},a=Date.now()-y,console.debug("CSV Worker saved "+a+"ms from main thread"),m},generateCSVFromResults=function(e,t,n){var o,r;null==n&&(n="#modal-sql-details-list"),console.info("Worker CSV: Given",e),o={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv"};try{r=downloadCSVFile(e,o)}catch(e){console.error("Sorry, there was a problem with this dataset and we can't do that right now."),r={file:"",options:o,html:""}}return r},validateAWebTaxon=function(e,t){var n,o,r;return null==t&&(t=null),null==(void 0!==r&&null!==r?r.validatedTaxons:void 0)&&("object"!=typeof r&&(r={}),r.validatedTaxons=[]),o=function(e){return"function"==typeof t&&t(e),!1},r.validatedTaxons.containsObject(e)?(console.info("Already validated taxon, skipping revalidation",e),o(e),!1):(n="action=validate&genus="+e.genus+"&species="+e.species,null!=e.subspecies&&(n+="&subspecies="+e.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",n,"json").done(function(t){return t.status?(e.genus=t.validated_taxon.genus,e.species=t.validated_taxon.species,e.subspecies=t.validated_taxon.subspecies,null==e.clade&&(e.clade=t.validated_taxon.family),r.validatedTaxons.push(e)):e.invalid=!0,e.response=t,o(e),!1}).fail(function(t,n){var o;return o=e.genus+" "+e.species,o=null!=e.subspecies?o+" "+e.subspecies:o,bsAlert("<strong>Problem validating taxon:</strong> "+o+" couldn't be validated."),console.warn("Warning: Couldn't validated "+o+" with AmphibiaWeb with owrker")}),!1)};
//# sourceMappingURL=global-search-worker.min.js.map