var checkProjectAuthorization,copyLink,postAuthorizeRender,publicData,renderEmail,renderMapWithData,renderPublicMap,searchProjects,setPublicData,showEmailField,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};_adp.mapRendered=!1,_adp.zcClient=null,publicData=null,checkProjectAuthorization=function(a,b){return null==a&&(a=_adp.projectId),null==b&&(b=postAuthorizeRender),startLoad(),console.info("Checking authorization for "+a),checkLoggedIn(function(c){var d,e,f;return null==a?(c.status?(console.info("Logged in user, no project"),d='<paper-icon-button icon="icons:dashboard" class="authorized-action" id="show-actions" data-href="'+uri.urlString+'admin-page.html" data-toggle="tooltip" title="Administration Dashboard"> </paper-icon-button>'):console.info("Not logged in"),stopLoad(),!1):c.status?(f=uri.urlString+"admin-api.php",e="perform=check_access&project="+a,$.post(f,e,"json").done(function(a){var c;return a.status?(console.info("User is authorized"),c=a.detail.project,"function"==typeof b?b(c,a.detailed_authorization):(console.warn("No callback specified!"),console.info("Got project data",c))):console.info("User is unauthorized")}).error(function(a,b){return console.log("Error checking server",a,b)}).always(function(){return stopLoad()})):(console.info("Non logged-in user or unauthorized user"),renderPublicMap(),stopLoad(),!1)}),!1},renderEmail=function(a){var b,c;return stopLoad(),c=uri.urlString+"api.php",b="action=is_human&recaptcha_response="+a+"&project="+_adp.projectId,$.post(c,b,"json").done(function(a){var b;return console.info("Checked response"),console.log(a),b=a.author_data,showEmailField(b.contact_email),stopLoad()}).error(function(a,b){return stopLoadError("Sorry, there was a problem getting the contact email"),!1}),!1},showEmailField=function(a){var b;return b='<div class="row">\n  <paper-input readonly class="col-xs-8 col-md-11" label="Contact Email" value="'+a+'"></paper-input>\n  <paper-fab icon="communication:email" class="click materialblue" id="contact-email-send" data-href="mailto:'+a+'" data-toggle="tooltip" title="Send Email"></paper-fab>\n</div>',$("#email-fill").replaceWith(b),bindClicks("#contact-email-send"),!1},renderMapWithData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(null==b&&(b=!1),_adp.mapRendered===!0&&b!==!0)return console.warn("The map was asked to be rendered again, but it has already been rendered!"),!1;e=JSON.parse(deEscape(a.carto_id)),p=e.raw_data,p.hasDataFile&&(j="helpers/",i=p.filePath,i.search(-1===j)&&(i=""+j+i),h='<button class="btn btn-primary click download-file download-data-file" data-href="'+i+'" data-newtab="true">\n  <iron-icon icon="editor:insert-chart"></iron-icon>\n  Download Data File\n</button>'),null==h&&(h=""),g=e.table;try{s=getMapZoom(e.bounding_polygon.paths,"#transect-viewport"),console.info("Got zoom",s)}catch(t){s=""}for(o=e.bounding_polygon,m='<google-map-poly closed fill-color="'+o.fillColor+'" fill-opacity="'+o.fillOpacity+'" stroke-weight="1">',r=[],q=o.paths,k=0,l=q.length;l>k;k++)n=q[k],indexOf.call(r,n)<0&&(r.push(n),m+='<google-map-point latitude="'+n.lat+'" longitude="'+n.lng+'"> </google-map-point>');return m+="    </google-map-poly>",f="SELECT genus, specificEpithet, diseaseTested, diseaseDetected, originalTaxa, ST_asGeoJSON(the_geom) FROM "+g+";",console.info("Would ping cartodb with",f),c=encodeURIComponent(encode64(f)),d="action=fetch&sql_query="+c,$.post("api.php",d,"json").done(function(b){var c,d,e,f,g,i,j,k,l,n,o,p,q,r,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;if(_adp.mapRendered===!0)return console.warn("Duplicate map render! Skipping thread"),!1;if(console.info("Carto query got result:",b),!b.status)return g=null!=(B=b.human_error)?B:b.error,null==g&&(g="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+g+")"),!1;D=b.parsed_responses[0].rows;for(l in D)C=D[l],i=JSON.parse(C.st_asgeojson),o=i.coordinates[0],r=i.coordinates[1],C.diseasedetected=function(){switch((""+C.diseasedetected).toLowerCase()){case"true":return"positive";case"false":return"negative";default:return""+C.diseasedetected}}(),E=C.genus+" "+C.specificepithet,z="",E!==C.originaltaxa&&(z="(<em>"+C.originaltaxa+"</em>)"),v='<google-map-marker latitude="'+o+'" longitude="'+r+'" data-disease-detected="'+C.diseasedetected+'">\n  <p>\n    <em>'+C.genus+" "+C.specificepithet+"</em> "+z+"\n    <br/>\n    Tested <strong>"+C.diseasedetected+"</strong> for "+C.diseasetested+"\n  </p>\n</google-map-marker>",m+=v;for(j='<google-map id="transect-viewport" latitude="'+a.lat+'" longitude="'+a.lng+'" fit-to-markers map-type="hybrid" disable-default-ui zoom="'+s+'" class="col-xs-12 col-md-9 col-lg-6">\n  '+m+"\n</google-map>",x="",y=a.sampling_months.split(","),k=0,n=0,p=y.length;p>n;n++)w=y[n],++k,k>1&&k===y.length?(y.length>2&&(x+=","),x+=" and "):k>1&&(x+=", "),isNumber(w)&&(w=dateMonthToString(w)),x+=w;for(k=0,G="",H=a.sampling_years.split(","),k=0,t=0,q=H.length;q>t;t++)F=H[t],++k,k>1&&k===H.length?(H.length>2&&(G+=","),G+=" and "):k>1&&(G+=", "),G+=F;return G=1===H.length?"the year "+G:"the years "+G,e=new Date(toInt(a.sampled_collection_start)),f=new Date(toInt(a.sampled_collection_end)),c=dateMonthToString(e.getMonth())+" "+e.getFullYear()+" &#8212; "+dateMonthToString(f.getMonth())+" "+f.getFullYear(),u='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+j+'\n  <div class="col-xs-12 col-md-3 col-lg-6">\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken from '+c+'</p>\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken in '+x+'</p>\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were sampled in '+G+'</p>\n    <p class="text-muted"><iron-icon icon="icons:language"></iron-icon> The effective project center is at ('+roundNumberSigfig(a.lat,6)+", "+roundNumberSigfig(a.lng,6)+") with a sample radius of "+a.radius+"m and a resulting locality <strong class='locality'>"+a.locality+'</strong></p>\n    <p class="text-muted"><iron-icon icon="editor:insert-chart"></iron-icon> The dataset contains '+a.disease_positive+" positive samples ("+roundNumber(100*a.disease_positive/a.disease_samples)+"%), "+a.disease_negative+" negative samples ("+roundNumber(100*a.disease_negative/a.disease_samples)+"%), and "+a.disease_no_confidence+" inconclusive samples ("+roundNumber(100*a.disease_no_confidence/a.disease_samples)+'%)</p>\n    <div class="download-buttons" id="data-download-buttons">\n      '+h+"\n    </div>\n  </div>\n</div>",bindClicks(".download-file"),_adp.mapRendered!==!0&&($("#auth-block").append(u),setupMapMarkerToggles(),_adp.mapRendered=!0,isNull(_adp.pageSpeciesList)||(console.log("Creating CSV downloader for species list"),d=new Date,A={create:!0,downloadFile:"species-list-"+a.project_id+"-"+d.toISOString()+".csv",selector:".download-buttons",buttonText:"Download Species List",splitValues:" ",header:["Genus","Species","Subspecies"]},downloadCSVFile(_adp.pageSpeciesList,A))),stopLoad()}).error(function(a,b){return console.error(a,b),stopLoadError("Couldn't render map")}),!1},postAuthorizeRender=function(a,b){var c,d,e,f;return a["public"]&&console.info("Project is already public, not rerendering"),startLoad(),console.info("Should render stuff",a),f=c="",b.can_edit&&(f='<paper-icon-button icon="icons:create" class="authorized-action" data-href="'+uri.urlString+"admin-page.html?id="+a.project_id+'" data-toggle="tooltip" title="Edit Project"></paper-icon-button>'),c='<paper-icon-button icon="icons:dashboard" class="authorized-action" id="show-actions" data-href="'+uri.urlString+'admin-page.html" data-toggle="tooltip" title="Administration Dashboard"> </paper-icon-button>',$("#title").append(f),d=JSON.parse(a.author_data),showEmailField(d.contact_email),bindClicks(".authorized-action"),e=JSON.parse(deEscape(a.carto_id)),renderMapWithData(a),!1},copyLink=function(a,b,c){var d,e,f,g,h,i;if(null==a&&(a=_adp.zcClient),null==c&&(c=!0),d=p$(".ark-identifier").value,c)try{return i="https://n2t.net/"+d,f={dataType:"text/plain",data:i,"text/plain":i},e=new ClipboardEvent("copy",f),document.dispatchEvent(e),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(h){g=h,console.error("Error creating copy: "+g.message),console.warn(g.stack)}return console.warn("Can't use HTML5"),null!=a?(a.setData(f),null!=b&&b.setData(f),a.on("aftercopy",function(a){return a.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):toastStatusMessage("Error copying to clipboard")}),a.on("error",function(a){if(console.error("Error copying to clipboard"),console.warn("Got",a),"flash-overdue"===a.name){if(_adp.resetClipboard===!0)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,copyLink()}),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0))}return"flash-disabled"===a.name?(console.info("No flash on this system"),ZeroClipboard.destroy(),$("#copy-ark").tooltip("destroy").remove(),$(".ark-identifier").removeClass("col-xs-9 col-md-11").addClass("col-xs-12"),toastStatusMessage("Clipboard copying isn't available on your system")):void 0})):console.error("Can't use HTML, and ZeroClipboard wasn't passed"),!1},searchProjects=function(){var a,b,c,d;return d=$("#project-search").val(),isNull(d)?!1:(c=p$("#search-filter").selectedItem,b=$(c).attr("data-cols"),console.info("Searching on "+d+" ... in "+b),a="action=search_project&q="+d+"&cols="+b,$.post(uri.urlString+"api.php",a,"json").done(function(a){var b,c,e,f,g,h,i,j,k,l;if(console.info(a),c="",i=Object.toArray(a.result),i.length>0)for(f=0,g=i.length;g>f;f++)h=i[f],j=h["public"].toBool(),e=j?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',b='<button class="btn btn-primary search-proj-link" data-href="'+uri.urlString+"project.php?id="+h.project_id+'" data-toggle="tooltip" data-placement="right" title="Project #'+h.project_id.slice(0,8)+'...">\n  '+e+" "+h.project_title+"\n</button>",c+="<li class='project-search-result'>"+b+"</li>";else l=null!=(k=a.search)?k:d,c='<p><em>No results found for "<strong>'+l+'</strong>"';return $("#project-result-container").html(c),bindClicks(".search-proj-link")}).error(function(a,b){return console.error(a,b)}),!1)},setPublicData=function(a){return publicData=a,!1},renderPublicMap=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;null==a&&(a=publicData);try{if(a["public"].toBool())return console.info("Not rendering low-data public map for public project"),!1}catch(r){return console.error("Invalid project data passed!"),console.warn(a),!1}try{console.info("Working with limited data",a),b=a.carto_id,m=b.bounding_polygon,h='<google-map-poly closed fill-color="'+m.fillColor+'" fill-opacity="'+m.fillOpacity+'" stroke-weight="1">',p=[],j={lat:a.bounding_box_n,lng:a.bounding_box_w},i={lat:a.bounding_box_n,lng:a.bounding_box_e},n={lat:a.bounding_box_s,lng:a.bounding_box_e},o={lat:a.bounding_box_s,lng:a.bounding_box_w},k=[j,i,n,o];try{q=getMapZoom(k,"#transect-viewport"),console.info("Got zoom",q)}catch(s){q=""}for(f=0,g=k.length;g>f;f++)l=k[f],indexOf.call(p,l)<0&&(p.push(l),h+='<google-map-point latitude="'+l.lat+'" longitude="'+l.lng+'"> </google-map-point>');return h+="    </google-map-poly>",e='<div class="row" id="public-map">\n  <h2 class="col-xs-12">Approximate Mapping Data</h2>\n  <google-map id="transect-viewport" latitude="'+a.lat+'" longitude="'+a.lng+'" fit-to-markers map-type="hybrid" disable-default-ui zoom="'+q+'" class="col-xs-12 col-md-9 col-lg-6 center-block clearfix public-fuzzy-map"  apiKey="'+gMapsApiKey+'">\n        '+h+"\n  </google-map>\n</div>",$("#auth-block").append(e)}catch(d){return c=d,stopLoadError("Couldn't render map"),console.error("Map rendering error - "+c.message),console.warn(c.stack)}},$(function(){var a;return _adp.projectId=uri.o.param("id"),checkProjectAuthorization(),$("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),goTo(uri.urlString+"project.php?id="+a)}),$("#project-search").unbind().keyup(function(){return searchProjects.debounce()}),$("paper-radio-button").click(function(){var a;return a=$(this).attr("data-cue"),$("#project-search").attr("placeholder",a),searchProjects.debounce()}),a={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},ZeroClipboard.config(a),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0)),$("#copy-ark").click(function(){return copyLink(_adp.zcClient)}),checkFileVersion(!1,"js/project.js"),$("#toggle-project-viewport").click(function(){return $(".project-list-page").toggleClass("hidden-xs"),$(".project-search").hasClass("hidden-xs")?$(this).text("Show Project Search"):$(this).text("Show Project List")}),$("#community-map google-map-poly").on("google-map-poly-click",function(a){var b,c;return c=$(this).attr("data-project"),b=uri.urlString+"project.php?id="+c,goTo(b),!1}),$("#community-map").on("google-map-ready",function(){var a,b,c,d,e,f,g,h,i,j,k,l;if(h=p$("#community-map"),null!=_adp.aggregateHulls){for(a=[],c=Object.toArray(_adp.aggregateHulls),d=0,f=c.length;f>d;d++)for(b=c[d],k=Object.toArray(b),e=0,g=k.length;g>e;e++)j=k[e],i=new Point(j.lat,j.lng),a.push(i);console.info("Adjusting zoom from "+h.zoom),l=getMapZoom(a,"#community-map"),console.info("Calculated new zoom "+l),h.zoom=l}return!1})});
//# sourceMappingURL=maps/c.map