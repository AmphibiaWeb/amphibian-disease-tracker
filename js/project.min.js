var checkArkDataset,checkProjectAuthorization,copyLink,createOverflowMenu,disableMapViewFilter,fillSorterWithDropdown,kmlLoader,paginationBinder,postAuthorizeRender,prepParsedDataDownload,publicData,renderEmail,renderMapWithData,renderPublicMap,restrictProjectsToMapView,searchProjects,setPublicData,showCitation,showEmailField,sqlQueryBox,indexOf=[].indexOf||function(e){for(var t=0,o=this.length;t<o;t++)if(t in this&&this[t]===e)return t;return-1};_adp.mapRendered=!1,_adp.zcClient=null,publicData=null;try{(createOverflowMenu=function(){return checkLoggedIn(function(e){var t,o;return t=e.status?'    <paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",o='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+t+'\n    <paper-item data-href="'+uri.urlString+'dashboard.php" class="click">\n      Data Dashboard\n    </paper-item>\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About / Legal\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(o),isNull(t)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1})()}catch(e){}fillSorterWithDropdown=function(e){var t,o,n,a,r,i,l,s,c;null==e&&(e=".sort-by-placeholder-text"),c={date:{title:"sampling date",key:"date"},affiliation:{title:"affiliation",key:"affiliation"},lab:{title:"PI lab",key:"lab"},contact:{title:"PI contact",key:"contact"}},i=$(e).attr("data-order-key"),o="",a=0,s=0;for(r in c)(t=c[r]).key===i&&(s=a),++a,o+='<paper-item data-sort-key="'+t.key+'">'+t.title+"</paper-item>";return n='<paper-dropdown-menu label="Sort Options" id="sort-options">\n  <paper-listbox class="dropdown-content" selected="'+s+'">\n    '+o+"\n  </paper-listbox>\n</paper-dropdown-menu>",$(e).replaceWith(n),l=0,$("#sort-options").on("iron-select",function(){var e,t;return e=p$(this).selectedItem,t=$(e).attr("data-sort-key"),console.debug("Selected '"+t+"'"),l>0&&goTo("https://"+uri.domain+".org/project.php?sort="+t),++l}),!1},checkProjectAuthorization=function(e,t){return null==e&&(e=_adp.projectId),null==t&&(t=postAuthorizeRender),startLoad(),console.info("Checking authorization for "+e),checkLoggedIn(function(o){var n,a;return null==e?(o.status?(console.info("Logged in user, no project"),'<paper-icon-button icon="icons:dashboard" class="authorized-action" id="show-actions" data-href="'+uri.urlString+'admin-page.html" data-toggle="tooltip" title="Administration Dashboard"> </paper-icon-button>'):console.info("Not logged in"),stopLoad(),!1):o.status?(a=uri.urlString+"admin-api.php",n="perform=check_access&project="+e,$.post(a,n,"json").done(function(e){var o;return e.status?(console.info("User is authorized"),o=e.detail.project,"function"==typeof t?t(o,e.detailed_authorization):(console.warn("No callback specified!"),console.info("Got project data",o))):console.info("User is unauthorized")}).fail(function(e,t){return console.log("Error checking server",e,t)}).always(function(){return stopLoad()})):(console.info("Non logged-in user or unauthorized user"),renderPublicMap(),stopLoad(),!1)}),!1},renderEmail=function(e){var t,o;return animateLoad(),o=uri.urlString+"api.php",t="action=is_human&recaptcha_response="+e+"&project="+_adp.projectId,$.post(o,t,"json").done(function(e){var t,o,n,a;return console.info("Checked response"),console.log(e),t=e.author_data,showEmailField(t.contact_email),isNull(null!=(n=e.technical)?n.name:void 0)||isNull(null!=(a=e.technical)?a.email:void 0)||(o="Technical Contact "+e.technical.name,showEmailField(e.technical.email,o,"technical-email-send")),stopLoad()}).fail(function(e,t){return stopLoadError("Sorry, there was a problem getting the contact email"),!1}),!1},showEmailField=function(e,t,o){var n,a,r;return null==t&&(t="Contact Email"),null==o&&(o="contact-email-send"),n='<div class="row appended-email-field">\n  <paper-input readonly class="col-xs-8 col-md-11" label="'+t+'" value="'+e+'"></paper-input>\n  <paper-fab icon="communication:email" class="click materialblue" id="'+o+'" data-href="mailto:'+e+'" data-toggle="tooltip" title="Send Email"></paper-fab>\n</div>',$("#email-fill").exists()?$("#email-fill").replaceWith(n):(a=$(".appended-email-field").length-1,r=$(".appended-email-field").get(a),$(r).after(n)),bindClicks("#"+o),!1},renderMapWithData=function(e,t){var o,n,a,r,i,l,s,c,p,d,u,g,h,f,m,b,y,w,v,j,k,_,x,C,S,M,N,E,D,L,P,T,q,O;if(null==t&&(t=!1),L=function(){try{if(!isNull(e.transect_file))return kmlLoader(e.transect_file,function(){return console.debug("Loaded KML file successfully")})}catch(e){}},!0===_adp.mapRendered&&!0!==t)return console.warn("Carto: The map was asked to be rendered again, but it has already been rendered!"),L(),!1;if("object"!=typeof(p=e.carto_id))try{s=JSON.parse(deEscape(p))}catch(e){m=(f=e).message;try{s=JSON.parse(p)}catch(e){if(f=e,p.length>511&&"object"==typeof(c=fixTruncatedJson(p))&&(console.debug("The carto data object was truncated, but rebuilt."),s=c),isNull(s))return console.error("cartoObj must be JSON string or obj, given",p),console.warn("Cleaned obj:",deEscape(p)),console.warn("Told '"+m+"' then",f.message),stopLoadError("Couldn't parse data"),!1}}else s=p;if(_adp.cartoDataParsed=s,N=s.raw_data,isNull(N))return console.warn("No raw data to render"),L(),!1;if(N.hasDataFile&&(y="helpers/",-1===(b=N.filePath).search(y)&&(b=""+y+b),h="",(i=e.dataset_arks.split(",")).length>0))for((l=b.split("/")).pop(),l=l.join("/"),v=0,j=0,_=i.length;j<_;j++)r=(g=(a=i[j]).split("::"))[0],b=l+"/"+g[1],h+=w='<button class="btn btn-primary click download-file download-data-file '+(0===v?"":"btn-xs download-alt-datafile")+'" data-href="'+b+'" data-newtab="true" data-toggle="tooltip" title="'+r+' (right-click to copy)" data-ark="'+r+'">\n  <iron-icon icon="editor:insert-chart"></iron-icon>\n  '+(0===v?"Download Newest Datafile":r+" dataset")+"\n</button>",++v;if(null==h&&(h=""),u=s.table,isNull(u))return console.warn("WARNING: This project has no data associated with it. Not doing map render."),L(),!1;try{try{!1!==s.bounding_polygon.paths.toBool()||isNull(s.bounding_polygon.multibounds)||(s.bounding_polygon.paths=s.bounding_polygon.multibounds[0])}catch(e){}O=null!=(E=s.bounding_polygon.paths)?E:s.bounding_polygon,q=getMapZoom(O,"#transect-viewport"),console.info("Got zoom",q)}catch(e){q=""}for(M=s.bounding_polygon,(isArray(M)||null==(null!=M?M.paths:void 0))&&(M,"object"!=typeof(P=toObject(M))&&(P={}),P.paths=M,isArray(P.paths)||(P.paths=[]),M=P),null==M.fillColor&&(M.fillColor=defaultFillColor),null==M.fillOpacity&&(M.fillOpacity=defaultFillOpacity),C='<google-map-poly closed fill-color="'+M.fillColor+'" fill-opacity="'+M.fillOpacity+'" stroke-weight="1">',T=[],k=0,x=(D=M.paths).length;k<x;k++)S=D[k],indexOf.call(T,S)<0&&(T.push(S),C+='<google-map-point latitude="'+S.lat+'" longitude="'+S.lng+'"> </google-map-point>');return C+="    </google-map-poly>",d="SELECT genus, specificepithet, diseasetested, diseasedetected, originaltaxa, ST_asGeoJSON(the_geom) FROM "+u+";",console.info("Would ping cartodb with",d),o=encodeURIComponent(encode64(d)),n="action=fetch&sql_query="+o,console.debug("Hitting endpoint for carto lookup",uri.urlString+"api.php?"+n),$.post("api.php",n,"json").done(function(t){var o,n,r,i,l,s,c,p,d,u,g,m,b,y,j,k,_,x,S,N,E,D,T,O,A,z,R,I,B,F,Z,J,V,K,W,U,G,Q,H,Y;if(!0===_adp.mapRendered)return console.warn("Duplicate map render! Skipping thread"),L(),!1;if(console.info("Carto query got result:",t),!t.status)return null==(c=null!=(F=t.human_error)?F:t.error)&&(c="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+c+")"),L(),!1;K=t.parsed_responses[0].rows,I=[],R=[],console.log("Running swapped cartoDB order (lng, lat)"),z={};for(u in K){V=K[u],g=(p=JSON.parse(V.st_asgeojson)).coordinates[1],k=p.coordinates[0],I.push([g,k]);try{R.push(canonicalizePoint([g,k]))}catch(e){}G=V.genus+" "+V.specificepithet,null==z[G]&&(z[G]={positive:!1,negative:!1,no_confidence:!1,counts:{total:0,positive:0,negative:0,no_confidence:0}}),V.diseasedetected=function(){switch((""+V.diseasedetected).toLowerCase()){case"true":return z[G].positive=!0,z[G].counts.positive++,"positive";case"false":return z[G].negative=!0,z[G].counts.negative++,"negative";default:return z[G].no_confidence=!0,z[G].counts.no_confidence++,""+V.diseasedetected}}(),z[G].counts.total++,T="",G!==V.originaltaxa&&(T="(<em>"+V.originaltaxa+"</em>)"),S='<google-map-marker latitude="'+g+'" longitude="'+k+'" data-disease-detected="'+V.diseasedetected+'">\n  <p>\n    <em>'+V.genus+" "+V.specificepithet+"</em> "+T+"\n    <br/>\n    Tested <strong>"+V.diseasedetected+"</strong> for "+V.diseasetested+"\n  </p>\n</google-map-marker>","positive"!==V.diseasedetected&&"negative"!==V.diseasedetected&&(V.diseasedetected="inconclusive"),$(".aweb-link-species[data-species='"+V.genus+" "+V.specificepithet+"']").attr("data-"+V.diseasedetected,"true"),C+=S}if(null==(null!=M?M.paths:void 0))try{_adp.canonicalHull=createConvexHull(I,!0)}catch(e){}for(d='<google-map id="transect-viewport" latitude="'+e.lat+'" longitude="'+e.lng+'" map-type="hybrid" zoom="'+q+'" class="col-xs-12 col-md-9 col-lg-6" api-key="'+gMapsApiKey+'">\n  '+C+"\n</google-map>",E="",D=e.sampling_months.split(","),v=0,_=0,m=D.length;_<m;_++)N=D[_],++v>1&&v===D.length?(D.length>2&&(E+=","),E+=" and "):v>1&&(E+=", "),isNumber(N)&&(N=dateMonthToString(N)),E+=N;for(v=0,H="",Y=e.sampling_years.split(","),v=0,O=0,b=Y.length;O<b;O++)Q=Y[O],++v>1&&v===Y.length?(Y.length>2&&(H+=","),H+=" and "):v>1&&(H+=", "),H+=Q;if(H=1===Y.length?"the year "+H:"the years "+H,i=new Date(toInt(e.sampled_collection_start)),l=new Date(toInt(e.sampled_collection_end)),n=dateMonthToString(i.getMonth())+" "+i.getFullYear()+" &#8212; "+dateMonthToString(l.getMonth())+" "+l.getFullYear(),x='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+d+'\n  <div class="col-xs-12 col-md-3 col-lg-6">\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken from '+n+'</p>\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken in '+E+'</p>\n    <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were sampled in '+H+'</p>\n    <p class="text-muted"><iron-icon icon="icons:language"></iron-icon> The effective project center is at ('+roundNumberSigfig(e.lat,6)+", "+roundNumberSigfig(e.lng,6)+") with a sample radius of "+e.radius+"m and a resulting locality <strong class='locality'>"+e.locality+'</strong></p>\n    <p class="text-muted"><iron-icon icon="editor:insert-chart"></iron-icon> The dataset contains '+e.disease_positive+" positive samples ("+roundNumber(100*e.disease_positive/e.disease_samples)+"%), "+e.disease_negative+" negative samples ("+roundNumber(100*e.disease_negative/e.disease_samples)+"%), and "+e.disease_no_confidence+" inconclusive samples ("+roundNumber(100*e.disease_no_confidence/e.disease_samples)+'%)</p>\n    <div class="download-buttons" id="data-download-buttons">\n      '+h+"\n    </div>\n  </div>\n</div>",x=x.replace(/NaN/gm,"0"),!0!==_adp.mapRendered&&($("#auth-block").append(x),setupMapMarkerToggles(),_adp.mapRendered=!0,!isNull(_adp.pageSpeciesList))){for(console.log("Creating CSV downloader for species list"),r=new Date,A={create:!0,downloadFile:"species-list-"+e.project_id+"-"+r.toISOString()+".csv",selector:".download-buttons",buttonText:"Download Species Stats",splitValues:" ",header:["Genus","Species","Subspecies","Positive Samples?","Negative Samples?","Inconclusive Samples?","Positive Count","Negative Count","Inconclusive Count","Totals"]},o=[],B=0,y=(Z=_adp.pageSpeciesList).length;B<y;B++){if(W=Z[B],(P=W.split(A.splitValues)).length<3)for(;P.length<3;)P.push("");null!=z[W]?(P.push(""+z[W].positive),P.push(""+z[W].negative),P.push(""+z[W].no_confidence),P.push(""+z[W].counts.positive),P.push(""+z[W].counts.negative),P.push(""+z[W].counts.no_confidence),P.push(""+z[W].counts.total)):(console.warn("CSV downloader couldn't find "+W+" in perTaxaStatus"),window.perTaxaStatus=z),o.push(P.join(A.splitValues))}downloadCSVFile(o,A)}for(bindClicks(".download-file"),sqlQueryBox(),$(".download-data-file").contextmenu(function(e){var t,o,n,r,i,l;return e.preventDefault(),console.log("Event details",e),$(this).offset(),w='<paper-material class="ark-context-wrapper" style="top:'+e.pageY+"px;left:"+e.pageX+'px;position:absolute">\n  <paper-menu class=context-menu">\n    <paper-item class="copy-ark-context">\n      Copy ARK to clipboard\n    </paper-item>\n  </paper-menu>\n</paper-material>',$(".ark-context-wrapper").remove(),$("body").append(w),getMapZoom(R,"#transect-viewport"),ZeroClipboard.config(_adp.zcConfig),l=new ZeroClipboard($(".copy-ark-context").get(0)),a=$(this).attr("data-ark"),i="http://biscicol.org/id/"+a,t={dataType:"text/plain",data:i,"text/plain":i},l.setData(t),l.on("aftercopy",function(e){return e.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):(console.error("ZeroClipboard had an error - ",e),console.warn(t),toastStatusMessage("Error copying to clipboard"))}),l.on("error",function(e){var t;return console.error("Initial error"),t=new ZeroClipboard($(".copy-ark-context").get(0)),o(t)}),o=function(e,n){var a;null==e&&(e=l),null==n&&(n=null);try{return a=new ClipboardEvent("copy",t),document.dispatchEvent(a),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(e){f=e,console.error("Error creating copy: "+f.message),console.warn(f.stack),console.warn("Can't use HTML5")}return e.setData(t),isNull(n)||n.setData(t),e.on("aftercopy",function(e){return e.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):(console.error("ZeroClipboard had an error - ",e),console.warn(t),toastStatusMessage("Error copying to clipboard"))}),e.on("error",function(t){if(console.error("Error copying to clipboard"),console.warn("Got",t),"flash-overdue"===t.name){if(!0===_adp.resetClipboard)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,e=new ZeroClipboard($(".copy-ark-context").get(0)),o(e)})}if("flash-disabled"===t.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),toastStatusMessage("Clipboard copying isn't available on your system")})},n=function(e){return $(this).addClass("iron-selected"),!1},r=function(e){return $(this).removeClass("iron-selected"),!1},this,$(".ark-context-wrapper paper-item").hover(n,r).click(function(){return _adp.resetClipboard=!1,$(".ark-context-wrapper").remove(),!1}).contextmenu(function(){return $(".ark-context-wrapper").remove(),!1}),!1}),checkArkDataset(e),setPublicData(e),U=0,j=(J=$(".aweb-link-species")).length;U<j;U++)s=J[U],$(s).attr("data-positive").toBool()&&$(s).attr("data-negative","false").attr("data-inconclusive","false");return console.info("Carto lookup complete"),L(),stopLoad()}).fail(function(e,t){return console.error("Couldn't render map and carto data"),console.error(e,t),L(),stopLoadError("Couldn't render map")}),!1},postAuthorizeRender=function(e,t){var o,n,a,r,i,l,s,c;e.public&&console.info("Project is already public, not rerendering"),startLoad(),console.info("Should render stuff",e),l="",t.can_edit&&(l='<paper-icon-button icon="icons:create" class="authorized-action" data-href="'+uri.urlString+"admin-page.html?id="+e.project_id+'" data-toggle="tooltip" title="Edit Project"></paper-icon-button>'),uri.urlString,$("#title").append(l),o=JSON.parse(e.author_data),showEmailField(o.contact_email);try{isNull(e.technical_contact)||isNull(e.technical_contact_email)||(c="Technical Contact "+e.technical_contact,showEmailField(e.technical_contact_email,c,"technical-email-send"))}catch(e){}if(bindClicks(".authorized-action"),"object"!=typeof(r=e.carto_id))try{n=JSON.parse(deEscape(r))}catch(e){s=(i=e).message;try{n=JSON.parse(r)}catch(e){if(i=e,r.length>511&&"object"==typeof(a=fixTruncatedJson(r))&&(console.debug("The carto data object was truncated, but rebuilt."),n=a),isNull(n))return console.error("cartoObj must be JSON string or obj, given",r),console.warn("Cleaned obj:",deEscape(r)),console.warn("Told '"+s+"' then",i.message),stopLoadError("Couldn't parse data"),!1}}else n=r;renderMapWithData(e);try{prepParsedDataDownload(e)}catch(e){}return!1},kmlLoader=function(e,t){var o,n,a,r,i;try{if("object"==typeof e)e=(a=e).path;else try{a=JSON.parse(e),e=a.path}catch(t){a={path:e}}console.debug("Loading KML file",e)}catch(e){}if(geo.inhibitKMLInit=!0,n=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(i=_adp.lastMod)?i.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),!$("google-map").exists()){if(o='<google-map id="transect-viewport" class="col-xs-12 col-md-9 col-lg-6 kml-lazy-map" api-key="'+gMapsApiKey+'" map-type="hybrid">\n</google-map>',r='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+o+"\n</div>",!$("#auth-block").exists())return console.warn("Couldn't find an authorization block to render the KML map in!"),!1;$("#auth-block").append(r),_adp.mapRendered=!0}return loadJS(n,function(){return initializeParser(null,function(){return loadKML(e,function(){var o,n;try{if(n=geo.kml.parser.docsByUrl[e],isNull(n)&&(e="/"+e,n=geo.kml.parser.docsByUrl[e],isNull(n)&&(console.warn("Could not resolve KML by url, using first doc"),n=geo.kml.parser.docs[0])),isNull(n))return allError("Bad KML provided"),!1;console.debug("Using parsed data from path '"+e+"'",n),"function"==typeof t?t(n):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(e){o=e,allError("There was a importing the data from this KML file"),console.warn(o.message),console.warn(o.stack)}return!1}),!1}),!1}),!1},copyLink=function(e,t,o){var n,a,r,i,l;if(null==e&&(e=_adp.zcClient),null==o&&(o=!0),n=p$(".ark-identifier").value,o)try{return l="http://biscicol.org/id/"+n,r={dataType:"text/plain",data:l,"text/plain":l},a=new ClipboardEvent("copy",r),document.dispatchEvent(a),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(e){i=e,console.error("Error creating copy: "+i.message),console.warn(i.stack)}return console.warn("Can't use HTML5"),null!=e?(e.setData(r),null!=t&&t.setData(r),e.on("aftercopy",function(e){return e.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):toastStatusMessage("Error copying to clipboard")}),e.on("error",function(e){if(console.error("Error copying to clipboard"),console.warn("Got",e),"flash-overdue"===e.name){if(!0===_adp.resetClipboard)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,copyLink()}),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0))}if("flash-disabled"===e.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),$("#copy-ark").tooltip("destroy").remove(),$(".ark-identifier").removeClass("col-xs-9 col-md-11").addClass("col-xs-12"),toastStatusMessage("Clipboard copying isn't available on your system")})):console.error("Can't use HTML, and ZeroClipboard wasn't passed"),!1},searchProjects=function(){var e,t,o,n;return n=$("#project-search").val(),isNull(n)?($("google-map-poly").removeAttr("hidden"),!1):(o=p$("#search-filter").selectedItem,t=$(o).attr("data-cols"),console.info("Searching on "+n+" ... in "+t),e="action=search_project&q="+n+"&cols="+t,$.post(uri.urlString+"api.php",e,"json").done(function(e){var t,o,a,r,i,l,s,c,p,d,u,g,h,f,m,b;if(console.info(e),t="",m=[],s=40,768,768<(u=$(window).width())&&u<1050?s=20:$(window).width()<1280&&(s=30),(d=Object.toArray(e.result)).length>0)for(a=0,i=d.length;a<i;a++)c=d[a],m.push(c.project_id),o=c.public.toBool()?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',f=c.project_title.slice(0,s),c.project_title!==f?(b=c.project_title,f+="..."):b="Project #"+c.project_id.slice(0,8)+"...",t+="<li class='project-search-result'>"+('<button class="btn btn-info search-proj-link" data-href="'+uri.urlString+"project.php?id="+c.project_id+'" data-toggle="tooltip" data-placement="top" title="'+b+'">\n  '+o+" "+f+"\n</button>")+"</li>";else t='<p><em>No results found for "<strong>'+(null!=(g=e.search)?g:n)+'</strong>"';for($("#project-result-container").html(t),bindClicks(".search-proj-link"),$("google-map-poly").attr("hidden","hidden"),h=[],r=0,l=m.length;r<l;r++)p=m[r],h.push($("google-map-poly[data-project='"+p+"']").removeAttr("hidden"));return h}).fail(function(e,t){return console.error(e,t)}),!1)},setPublicData=function(e){return publicData=e,!1},renderPublicMap=function(e){var t,o,n,a,r,i,l,s,c,p,d,u;null==e&&(e=publicData);try{if(e.public.toBool())return console.info("Not rendering low-data public map for public project"),!1}catch(t){return console.error("Invalid project data passed!"),console.warn(e),!1}try{console.info("Working with limited data",e),null==(p=e.carto_id.bounding_polygon).fillColor&&(p.fillColor="#ff7800"),null==p.fillOpacity&&(p.fillOpacity=.35),l='<google-map-poly closed fill-color="'+p.fillColor+'" fill-opacity="'+p.fillOpacity+'" stroke-weight="1">',d=[],null==(t=getPointsFromBoundingBox(e))[0].lat&&(t=getCorners(t)),s=[{lat:t[0].lat,lng:t[0].lng},{lat:t[1].lat,lng:t[1].lng},{lat:t[2].lat,lng:t[2].lng},{lat:t[3].lat,lng:t[3].lng}];try{u=getMapZoom(t,"#transect-viewport"),console.info("Got public zoom",u)}catch(e){u=""}for(a=0,r=s.length;a<r;a++)c=s[a],indexOf.call(d,c)<0&&(d.push(c),l+='<google-map-point latitude="'+c.lat+'" longitude="'+c.lng+'"> </google-map-point>');l+="    </google-map-poly>",n='<div class="row" id="public-map">\n  <h2 class="col-xs-12">Project Area of Interest</h2>\n  <google-map id="transect-viewport" latitude="'+(i=getMapCenter(t)).lat+'" longitude="'+i.lng+'" map-type="hybrid" zoom="'+u+'" class="col-xs-12 col-md-9 col-lg-6 center-block clearfix public-fuzzy-map"  api-key="'+gMapsApiKey+'">\n        '+l+"\n  </google-map>\n</div>",$("#auth-block").append(n);try{return u=getMapZoom(s,"#transect-viewport"),p$("#transect-viewport").zoom=u}catch(e){e;try{return u=getMapZoom(t,"#transect-viewport"),p$("#transect-viewport").zoom=u}catch(e){}}}catch(e){return o=e,stopLoadError("Couldn't render map"),console.error("Map rendering error - "+o.message),console.warn(o.stack)}},checkArkDataset=function(e,t,o){var n,a,r,i,l,s,c,p,d,u,g,h,f,m,b,y,w;if(null==t&&(t=!1),null==o&&(o=!1),"undefined"!=typeof _adp&&null!==_adp||(window._adp={}),p=uri.o.attr("fragment"),c=p.split(","),o||null==_adp.fragmentData){for(console.info("Examining fragment list"),i={},d=0,g=c.length;d<g;d++)i[(m=c[d].split(":"))[0]]=m[1];_adp.fragmentData=i}if(null==(s=null!=(b=_adp.fragmentData)?b.dataset:void 0))return!1;for(console.info("Checking  ARK identifiers for dataset "+s+" ..."),r="",f=!1,u=0,h=(a=e.dataset_arks.split(",")).length;u<h;u++)if(-1!==(n=a[u]).search(s)){r=n,f=!0;break}return!0!==f?(console.warn("Could not find matching dataset in",a),!1):(i=r.split("::"),l=i[1],console.info("Got matching identifier "+r+" -> "+l),y=".download-file[data-href*='"+l+"']",y=$(y).get(0),t?(w=$(y).attr("data-href"),openTab(w)):($(y).removeClass("btn-xs btn-primary").addClass("btn-success success-glow").click(function(){return $(this).removeClass("success-glow")}),{behavior:"smooth",block:"start"},$(y).get(0).scrollIntoView(!1)),y)},prepParsedDataDownload=function(e){var t,o,n,a,r,i,l,s,c,p,d;if(s=new Date,d={selector:"#data-download-buttons",create:!0,objectAsValues:!0,buttonText:"Download Parsed Dataset",downloadFile:"datalist-"+e.project_id+"-"+s.toISOString()+".csv"},{},"object"!=typeof(r=e.carto_id))try{n=JSON.parse(deEscape(r))}catch(e){p=(c=e).message;try{n=JSON.parse(r)}catch(e){if(c=e,r.length>511&&"object"==typeof(a=fixTruncatedJson(r))&&(console.debug("The carto data object was truncated, but rebuilt."),n=a),isNull(n))return console.error("cartoObj must be JSON string or obj, given",r),console.warn("Cleaned obj:",deEscape(r)),console.warn("Told '"+p+"' then",c.message),stopLoadError("Couldn't parse data"),!1}}else n=r;return l=n.table,isNull(l)?(console.warn("WARNING: This project has no data associated with it. Not creating download."),!1):(i="SELECT *, ST_asGeoJSON(the_geom) FROM "+l+";",console.info("Would ping cartodb with",i),t=encodeURIComponent(encode64(i)),o="action=fetch&sql_query="+t,_adp.dataPoints=[],$.post("api.php",o,"json").done(function(e){var t,o,n,a,r,i,l,s,c,p,u,g,h,f;if(!e.status)return null==(r=null!=(g=e.human_error)?g:e.error)&&(r="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+r+")"),!1;f=e.parsed_responses[0].rows,a=[];for(s in f){h=f[s],o={lat:c=(l=JSON.parse(h.st_asgeojson)).coordinates[1],lng:p=l.coordinates[0]},u=canonicalizePoint(o),_adp.dataPoints.push(u),h.decimalLatitude=c,h.decimalLongitude=p,delete h.st_asgeojson;try{try{i=JSON.parse(h.fimsextra)}catch(e){i=h.fimsextra}if("object"==typeof i){for(t in i)n=i[t],h[t]=n;delete h.fimsextra}}catch(e){}delete h.cartodb_id,delete h.id,delete h.the_geom,delete h.the_geom_webmercator,a.push(h)}return downloadCSVFile(a,d)}).fail(function(e,t){return console.error("Couldn't create"),console.error(e,t)}),!1)},sqlQueryBox=function(){var e,t,o,n;return null==_adp.cartoDataParsed?(console.error("CartoDB data not available. Are you logged in?"),!1):(o=function(e){var t;return animateLoad(),console.info("Querying with"),console.log(e),t="action=fetch&sql_query="+post64(e),_adp.currentAsyncJqxhr=$.post("api.php",t,"json").done(function(e){var t,o,n,a,r,i,l,s,c,p,d,u;if(console.log(e),!0!==e.status)return t=null!=(c=null!=(p=e.human_error)?p:e.error)?c:"Unknown error",console.error(t),n=function(){switch(t){case"UNAUTHORIZED_QUERY_TYPE":return e.query_type;default:return o="(no details for error "+e.error+")"}}(),$("#query-immediate-result").text(t+": "+n),$(".do-sql-query").removeAttr("disabled"),stopLoad(),!1;try{s=JSON.parse(e.post_response[0])}catch(e){return e,console.error("Error parsing result"),$("#query-immediate-result").text("Error parsing result from CartoDB"),$(".do-sql-query").removeAttr("disabled"),stopLoad(),!1}if(null!=s.error)return console.error("Error in result: "+s.error),$("#query-immediate-result").text(s.error),$(".do-sql-query").removeAttr("disabled"),stopLoad(),!1;console.log("Using responses",e.parsed_responses),l="",d=e.parsed_responses;for(r in d){u=d[r],i=toInt(r)+1,l+="#"+i+": ";try{a=JSON.stringify(u.rows),l+='<code class="language-json">'+a+"</code>"}catch(e){l+="BAD QUERY"}l+="\n\n"}$("#query-immediate-result").html(l);try{Prism.highlightAll(!0)}catch(e){}return $(".do-sql-query").removeAttr("disabled"),stopLoad(),!1}).error(function(){return $("#query-immediate-result").text("Error executing query"),$(".do-sql-query").removeAttr("disabled"),stopLoadError()}),!1},e=function(e,t){var o,n;return null==t&&(t=!1),o=e.trim(),n=o.replace(/@@/gim,_adp.cartoDataParsed.table),n=n.replace(/!@/gim,"SELECT * FROM "+_adp.cartoDataParsed.table),t||$("#query-input").val(n),n},function(){return!1},function(){return!1},$("#project-sql-query-box").exists()||(t='<div id="project-sql-query-box" class="row">\n  <h2 class="col-xs-12">Raw Project Queries</h2>\n  <textarea class="form-control code col-xs-10 col-xs-offset-1" rows="3" id="query-input" placeholder="SQL Query" aria-describedby="query-cheats"></textarea>\n  <div class="col-xs-12">\n    <label class="text-muted col-xs-2 col-md-1" for="interpreted-query">Real Query:</label>\n    <code class="language-sql col-xs-10 col-md-11" id="interpreted-query">\n    </code>\n  </div>\n  <div class="col-xs-12 col-sm-9">\n    <span class="text-muted" id="query-cheats">Tips: <ol><li>You\'re querying PostgreSQL</li><li>Type <kbd>@@</kbd> as a placeholder for the table name</li><li>Type <kbd>!@</kbd> as a placeholder for <code>SELECT * FROM @@</code></li><li>Multiple queries at once is just fine. They\'re broken at <kbd>);</kbd>, so enclosing your <code>WHERE</code> in parentheses is good enough.</li></ol></span>\n  </div>\n  <div class="col-xs-12 col-sm-3">\n    <button class="btn btn-default do-sql-query pull-right">Execute Query</button>\n  </div>\n  <h3 class="col-xs-12">Result:</h3>\n  <pre class="code col-xs-12" id="query-immediate-result"></pre>\n</div>',$("h2.project-identifier").exists()?$("h2.project-identifier").before(t):$("main").append(t)),n=function(){var t,n;return console.info("Executing query ..."),t=$("#query-input").val(),-1===(n=e(t)).search(_adp.cartoDataParsed.table)?(console.error("Query didn't specify a table!"),toastStatusMessage("You forgot to include the table identifier in your query."),!1):($(".do-sql-query").attr("disabled","disabled"),o(n))},$("#query-input").keyup(function(t){var o;if(13===(t.keyCode?t.keyCode:t.which)){try{t.preventDefault()}catch(e){}n()}else o=e($(this).val(),!0),$("code#interpreted-query").text(o),Prism.highlightElement($("code#interpreted-query")[0],!0);return!1}),$(".do-sql-query").click(function(){return n()}),!1)},showCitation=function(){var e;return e=p$("paper-input[label='DOI']").value,$("#citation-pop").exists()?p$("#citation-pop").open():(animateLoad(),fetchCitation(e,function(e,t){var o,n,a;try{a=isNull(t)?"":'<paper-button class="click" data-newtab="true" data-href="'+t+'">\n  <iron-icon icon="icons:open-in-new"></iron-icon>\n  Open\n</paper-button>',n='<paper-dialog id="citation-pop" modal>\n  <h2>Citation</h2>\n  <paper-dialog-scrollable>\n    <div class="pop-contents">\n      <paper-textarea label="Citation" id="popped-citation" readonly>\n        '+e+'\n      </paper-textarea>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button id="copy-citation" class="click-copy" data-copy-selector="#popped-citation">\n      <iron-icon icon="icons:content-copy"></iron-icon>\n      Copy Citation\n    </paper-button>\n    <paper-button id="copy-doi" class="click-copy" data-copy-selector="#doi-input">\n      <iron-icon icon="icons:content-copy"></iron-icon>\n      Copy DOI\n    </paper-button>\n    '+a+"\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>",$("body").append(n);try{p$("#popped-citation").value=e}catch(t){delay(500,function(){try{return p$("#popped-citation").value=e}catch(e){}})}return bindClicks(),bindCopyEvents(),safariDialogHelper("#citation-pop"),stopLoad()}catch(e){o=e,console.error("Couldn't show citation - "+o.message);try{return p$("#citation-pop").open()}catch(e){return stopLoadError("Failed to display citation")}}})),!1},window.showCitation=showCitation,disableMapViewFilter=function(){return $("google-map#community-map").unbind("google-map-idle"),_adp.hasBoundMapEvent=!1,$("nav#project-pagination").removeAttr("hidden"),!0},restrictProjectsToMapView=function(e){var t,o,n,a,r,i,l,s,c,p,d,u,g,h,f,m,b,y,w,v,j,k,_,x,C,S,M,N,E,D,L,P,T;if(null==e&&(e=!1),!$("google-map#community-map").exists())return!1;if(_adp.hasBoundMapEvent||(_adp.hasBoundMapEvent=!0,(P=function(e){return $("google-map#community-map").removeAttr("width"),delay(25,function(){var t;try{t=$("google-map#community-map").width(),$("google-map#community-map").attr("width",t+"px")}catch(e){}try{if("function"==typeof e)return e()}catch(e){}}),!1})(null),$("window").on("resize",function(){return P(function(){return restrictProjectsToMapView.debounce(50,null,null,e)}),!1}),$("google-map#community-map").on("google-map-idle",function(){return P(function(){return restrictProjectsToMapView.debounce(50,null,null,e)}),!1}),$("#projects-by-map-view").on("iron-change",function(){var e,t,o,n;for(t=0,o=(n=$(".map-view-control:not(.map-view-master)")).length;t<o;t++)e=n[t],p$(e).disabled=!p$(this).checked;return!1}),$(".map-view-control").on("iron-change",function(){return restrictProjectsToMapView.debounce(50,null,null,e),!1}),console.log("Bound events for RPTMV")),!p$("#projects-by-map-view").checked)return $("#project-list li").removeAttr("hidden"),$("h2.status-notice.project-list").removeAttr("hidden"),$("nav#project-pagination").removeAttr("hidden"),$("button.js-lazy-project").remove(),$("#map-view-title").remove(),!1;if($("nav#project-pagination").attr("hidden","hidden"),$("h2.status-notice.project-list").attr("hidden","hidden"),u=p$("google-map#community-map").map,g=u.getBounds(),(o={north:g.getNorthEast().lat(),east:g.getNorthEast().lng(),south:g.getSouthWest().lat(),west:g.getSouthWest().lng()}).west>o.east&&(o.west=-180,o.east=180),T=[],p$("#show-dataless-projects").checked)for(r=0,l=(y=$("#project-list button")).length;r<l;r++){t=y[r];try{b=$(t).attr("data-project"),$(t).attr("data-has-locale").toBool()?console.debug(b+" has a locale, handling normally"):T.push(b)}catch(e){n=e,console.warn("Error checking button -- "+n.message),console.warn(n.stack)}}for(i=0,s=(w=$("google-map#community-map").find("google-map-poly")).length;i<s;i++)if(m=w[i],b=$(m).attr("data-project"),!(indexOf.call(T,b)>=0||isNull(b))){try{if($("button[data-project='"+b+"']").exists()&&!0!==$("button[data-project='"+b+"']").attr("data-has-locale").toBool())continue}catch(e){}for(L={north:-90,south:90,east:-180,west:180},d=0,c=(_=$(m).find("google-map-point")).length;d<c;d++)f=_[d],p$(f).latitude>L.north&&(L.north=p$(f).latitude),p$(f).longitude>L.east&&(L.east=p$(f).longitude),p$(f).longitude<L.west&&(L.west=p$(f).longitude),p$(f).latitude<L.south&&(L.south=p$(f).latitude);a=!1,!0===e?(console.log("Checking edges of",b),o.south<(x=L.north)&&x<o.north&&(a=!0),o.south<(C=L.south)&&C<o.north&&(a=!0),o.west<(S=L.east)&&S<o.east&&(a=!0),o.west<(M=L.west)&&M<o.east&&(a=!0)):(console.log("Checking containement of",b),L.south>o.south&&L.north<o.north&&(o.west<(N=L.east)&&N<o.east||o.west<(E=L.west)&&E<o.east)&&(console.log("Project is wholly NS contained"),a=!0),L.west>o.west&&L.east<o.east&&(o.south<(D=L.north)&&D<o.north||o.south<(v=L.south)&&v<o.north)&&(console.log("Project is wholly EW contained"),a=!0)),a&&T.push(b)}for($("#project-list li").attr("hidden","hidden"),h=0,p=(j=$("#project-list button")).length;h<p;h++)t=j[h],k=$(t).attr("data-project"),indexOf.call(T,k)>=0&&$(t).parent("li").removeAttr("hidden");return $.get(uri.urlString+"admin-api.php","action=list","json").done(function(e){var t,o,n,a,r,i,l,s,c;console.log("Got project list",e),$("button.js-lazy-project").remove(),a=Object.toArray(e.public_projects),r=e.projects,i=[];for(n in r)s=r[n],indexOf.call(T,n)>=0?$("button[data-project='"+n+"']").exists()?i.push(console.log("Not re-adding button for",n)):(console.log("Should add visible project '"+s+"'",n),(l=s.slice(0,40))!==s?(c=s,l+="..."):c="Project #"+n.slice(0,8)+"...",o=indexOf.call(a,n)>=0?"social:public":"icons:lock",t='<li>\n<button class="js-lazy-project btn btn-primary" data-href="'+uri.urlString+"project.php?id="+n+'" data-project="'+n+'" data-toggle="tooltip" title="'+c+'">\n  <iron-icon icon="'+o+'"></iron-icon>\n  '+l+"\n</button>\n</li>",i.push($("#project-list").append(t))):i.push(console.log("Not adding invalid project",n));return i}).fail(function(e,t){return console.warn("Failed to get project list",e,t)}).always(function(){var e,t;return e=$("#project-list button:visible").length,t='<h2 class="col-xs-12 status-notice hidden-xs project-list project-list-page map-view-title" id="map-view-title">\n  Showing '+e+" projects in view\n</h2>",$("#map-view-title").remove(),$("h2.status-notice.project-list").before(t)}),console.log("Showing projects",T,"within",o),T},paginationBinder=function(){var e;return e="paper-dropdown-menu#pagination-selector-dropdown",$(e).exists()?(10,delayPolymerBind(e,function(){var t,o,n,a,r,i,l,s,c,p,d;if(p$(e).disabled){for(t=null!=(s=uri.o.param("pagination"))?s:$("#project-list li button:not(.js-lazy-project)").length,t=toInt(t),d=!1,p=0,a=0,r=(c=$("paper-dropdown-menu#pagination-selector-dropdown paper-listbox.dropdown-content paper-item")).length;a<r;a++){l=c[a];try{i=toInt($(l).text().trim())}catch(e){o=e,i=10}if(i===t){d=!0;break}p++}d||(p=0),p$("paper-dropdown-menu#pagination-selector-dropdown paper-listbox.dropdown-content").selected=p,console.log("Pre-selected item",p)}return p$(e).disabled=!1,$("paper-dropdown-menu#pagination-selector-dropdown paper-listbox.dropdown-content").unbind("iron-select").on("iron-select",function(){return console.log("iron-select fired"),n.debounce(50,null,null,this)}),$("paper-dropdown-menu#pagination-selector-dropdown paper-listbox.dropdown-content paper-item").unbind("click").click(function(){return console.log("paper-item click event fired"),n.debounce(50,null,null,$(this).parent("paper-listbox"))}),n=function(e){var n,a,r,s,c,p,d;l=p$(e).selectedItem;try{i=toInt($(l).text().trim())}catch(e){o=e,console.warn("Unable to read pagination number -- "+o.message),i=10}return console.log("Dropdown selected paginator",i),s=null!=(p=uri.o.param("page"))?p:1,t=null!=(d=uri.o.param("pagination"))?d:$("#project-list li button:not(.js-lazy-project)").length,(t=toInt(t))<10&&(t=10),t!==i&&(c=(s-1)*t+1,r=Math.floor(c/i)+1,n="page="+r+"&pagination="+i,a=uri.urlString+"project.php?"+n,console.log(a,n),goTo(a),!1)},!1}),!1):(console.error("Selector does not exist:",e),!1)},$(function(){var e;_adp.projectId=uri.o.param("id"),checkProjectAuthorization(),$("#project-list button").unbind().click(function(){var e;return e=$(this).attr("data-project"),goTo(uri.urlString+"project.php?id="+e)}),$("#project-search").unbind().keyup(function(){return searchProjects.debounce()}),$("paper-radio-button").click(function(){var e;return e=$(this).attr("data-cue"),$("#project-search").attr("placeholder",e),searchProjects.debounce()}),e={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},_adp.zcConfig=e,ZeroClipboard.config(e),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0)),$("#copy-ark").click(function(){return copyLink(_adp.zcClient)}),checkFileVersion(!1,"js/project.js"),$("#toggle-project-viewport").click(function(){return $(".project-list-page").toggleClass("hidden-xs"),$(".project-search").hasClass("hidden-xs")?$(this).text("Show Project Search"):$(this).text("Show Project List")}),$("#community-map google-map-poly").on("google-map-poly-click",function(e){var t,o;return o=$(this).attr("data-project"),t=uri.urlString+"project.php?id="+o,goTo(t),!1}),$("#community-map").on("google-map-ready",function(){var e,t,o,n,a,r,i,l,s,c,p,d,u,g,h;try{fillSorterWithDropdown()}catch(e){}if(p=p$("#community-map"),null!=_adp.aggregateHulls){for(o=[],i=0,s=(r=Object.toArray(_adp.aggregateHulls)).length;i<s;i++)for(a=r[i],l=0,c=(g=Object.toArray(a)).length;l<c;l++)u=g[l],e=isNull(u.lat)||90===Math.abs(u.lat),t=isNull(u.lng)||180===Math.abs(u.lng),e||t||(d=new Point(u.lat,u.lng),o.push(d));console.info("Adjusting zoom from "+p.zoom),h=getMapZoom(o,"#community-map"),console.info("Calculated new zoom "+h);try{n=getMapCenter(o),p.latitude=n.lat,p.longitude=n.lng,console.info("Recentered map")}catch(e){}p.zoom=h}return!1});try{$(".self-citation").click(function(){return $(this).selectText(),!1})}catch(e){}return restrictProjectsToMapView(),delay(500,function(){var e;try{return paginationBinder()}catch(t){return e=t,console.error("Unable to bind events to pagination - "+e.message),console.warn(e.stack),$(".pagination-selection-container").attr("hidden","hidden")}})});
//# sourceMappingURL=project.min.js.map