var _7zHandler,alertBadProject,bootstrapTransect,bootstrapUploader,checkInitLoad,copyMarkdown,csvHandler,dataAttrs,dataFileParams,delayFimsRecheck,excelDateToUnixTime,excelHandler,excelHandler2,finalizeData,getCanonicalDataCoords,getInfoTooltip,getProjectCartoData,getTableCoordinates,getUploadIdentifier,helperDir,imageHandler,loadCreateNewProject,loadEditor,loadProject,loadProjectBrowser,loadSUProjectBrowser,mapAddPoints,mapOverlayPolygon,mintBcid,mintExpedition,newGeoDataHandler,pointStringToLatLng,pointStringToPoint,popManageUserAccess,populateAdminActions,removeDataFile,renderValidateProgress,resetForm,revalidateAndUpdateData,saveEditorData,showAddUserDialog,singleDataFileHelper,startAdminActionHelper,startEditorUploader,stopLoadBarsError,uploadedData,user,userEmail,userFullname,validateAWebTaxon,validateData,validateFimsData,validateTaxonData,verifyLoginCredentials,zipHandler,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},modulo=function(a,b){return(+a%(b=+b)+b)%b};window.adminParams={},adminParams.domain="amphibiandisease",adminParams.apiTarget="admin-api.php",adminParams.adminPageUrl="https://"+adminParams.domain+".org/admin-page.html",adminParams.loginDir="admin/",adminParams.loginApiTarget=adminParams.loginDir+"async_login_handler.php",dataFileParams={},dataFileParams.hasDataFile=!1,dataFileParams.fileName=null,dataFileParams.filePath=null,dataAttrs={},uploadedData=null,helperDir="helpers/",user=$.cookie(adminParams.domain+"_link"),userEmail=$.cookie(adminParams.domain+"_user"),userFullname=$.cookie(adminParams.domain+"_fullname"),window.loadAdminUi=function(){var a,b;try{verifyLoginCredentials(function(a){var b;return b="<h3>\n  Welcome, "+$.cookie(adminParams.domain+"_name")+"\n</h3>\n<section id='admin-actions-block' class=\"row center-block text-center\">\n  <div class='bs-callout bs-callout-info'>\n    <p>Please be patient while the administrative interface loads.</p>\n  </div>\n</section>",$("main #main-body").before(b),$(".fill-user-fullname").text($.cookie(adminParams.domain+"_fullname")),checkInitLoad(function(){return populateAdminActions(),bindClicks()}),!1})}catch(b){a=b,$("main #main-body").html("<div class='bs-callout bs-callout-danger'><h4>Application Error</h4><p>There was an error in the application. Please refresh and try again. If this persists, please contact administration.</p></div>")}return!1},populateAdminActions=function(){var a,b,c;return c=uri.urlString+"admin-page.html",b={"do":"home",prop:null},history.pushState(b,"Admin Home",c),$(".hanging-alert").remove(),a='<paper-button id="new-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:add"></iron-icon>\n    Create New Project\n</paper-button>\n<paper-button id="edit-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:create"></iron-icon>\n    Edit Existing Project\n</paper-button>\n<paper-button id="view-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:visibility"></iron-icon>\n    View All My Projects\n</paper-button>',$("#admin-actions-block").html(a),$("#show-actions").remove(),$("main #main-body").empty(),$("#new-project").click(function(){return loadCreateNewProject()}),$("#edit-project").click(function(){return loadEditor()}),$("#view-project").click(function(){return loadProjectBrowser()}),verifyLoginCredentials(function(a){var b,c;return c=toInt(a.detail.userdata.su_flag),c.toBool()&&(console.info("NOTICE: This is an SUPERUSER Admin"),b='<paper-button id="su-view-projects" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:create"></iron-icon>\n  (SU) Administrate All Projects\n</paper-button>',$("#admin-actions-block").append(b),$("#su-view-projects").click(function(){return loadSUProjectBrowser()})),!1}),!1},verifyLoginCredentials=function(a){var b,c,d,e;return c=$.cookie(adminParams.domain+"_auth"),e=$.cookie(adminParams.domain+"_secret"),d=$.cookie(adminParams.domain+"_link"),b="hash="+c+"&secret="+e+"&dblink="+d,$.post(adminParams.loginApiTarget,b,"json").done(function(b){return b.status===!0?a(b):goTo(b.login_url)}).fail(function(a,b){return $("main #main-body").html("<div class='bs-callout-danger bs-callout'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p></div>"),console.log(a,b),!1}),!1},startAdminActionHelper=function(){var a;return $("#admin-actions-block").empty(),$("#pib-wrapper-dashboard").remove(),a='<span id="pib-wrapper-dashboard" class="pib-wrapper" data-toggle="tooltip" title="Administration Home" data-placement="bottom">\n  <paper-icon-button icon="icons:dashboard" class="admin-action" id="show-actions">\n  </paper-icon-button>\n</span>',$("#pib-wrapper-settings").after(a),$("#show-actions").click(function(){return $(this).tooltip("hide"),$(".tooltip").tooltip("hide"),populateAdminActions()})},getInfoTooltip=function(a){var b;return null==a&&(a="No Message Provided"),b='<div class="col-xs-1 adjacent-info">\n  <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="'+a+'"></span>\n</div>'},alertBadProject=function(a){return a=null!=a?"project "+a:"this project",stopLoadError("Sorry, "+a+" doesn't exist"),!1},loadCreateNewProject=function(){var a,b,c,d,e,f,g,h;h=uri.urlString+"admin-page.html#action:create-project",f={"do":"action",prop:"create-project"},history.pushState(f,"Create New Project",h),startAdminActionHelper(),a='<h2 class="new-title col-xs-12">Project Title</h2>\n<paper-input label="Project Title" id="project-title" class="project-field col-md-6 col-xs-12" required auto-validate data-field="project_title"></paper-input>\n<h2 class="new-title col-xs-12">Project Parameters</h2>\n<section class="project-inputs clearfix col-xs-12">\n  <div class="row">\n    <paper-input label="Primary Pathogen Studied" id="project-disease" class="project-field col-md-6 col-xs-8" required auto-validate data-field="disease"></paper-input>\n      '+getInfoTooltip("Bd, Bsal, or other. If empty, we'll take it from your data.")+'\n      <button class="btn btn-default fill-pathogen col-xs-1" data-pathogen="Batrachochytrium dendrobatidis">Bd</button>\n      <button class="btn btn-default fill-pathogen col-xs-1" data-pathogen="Batrachochytrium salamandrivorans ">Bsal</button>\n    <paper-input label="Pathogen Strain" id="project-disease-strain" class="project-field col-md-6 col-xs-11" data-field="disease_strain"></paper-input>'+getInfoTooltip("For example, Hepatitus A, B, C would enter the appropriate letter here")+'\n    <paper-input label="Project Reference" id="reference-id" class="project-field col-md-6 col-xs-11" data-field="reference_id"></paper-input>\n    '+getInfoTooltip("E.g.  a DOI or other reference")+'\n    <paper-input label="Publication DOI" id="pub-doi" class="project-field col-md-6 col-xs-11" data-field="publication"></paper-input>\n    <h2 class="new-title col-xs-12">Lab Parameters</h2>\n    <paper-input label="Project PI" id="project-pi" class="project-field col-md-6 col-xs-12"  required auto-validate data-field="pi_lab"></paper-input>\n    <paper-input label="Project Contact" id="project-author" class="project-field col-md-6 col-xs-12" value="'+userFullname+'"  required auto-validate></paper-input>\n    <gold-email-input label="Contact Email" id="author-email" class="project-field col-md-6 col-xs-12" value="'+userEmail+'"  required auto-validate></gold-email-input>\n    <paper-input label="Diagnostic Lab" id="project-lab" class="project-field col-md-6 col-xs-12"  required auto-validate></paper-input>\n    <paper-input label="Affiliation" id="project-affiliation" class="project-field col-md-6 col-xs-11"  required auto-validate></paper-input> '+getInfoTooltip("Of project PI. e.g., UC Berkeley")+'\n    <h2 class="new-title col-xs-12">Project Notes</h2>\n    <iron-autogrow-textarea id="project-notes" class="project-field col-md-6 col-xs-11" rows="3" data-field="sample_notes"></iron-autogrow-textarea>'+getInfoTooltip("Project notes or brief abstract; accepts Markdown ")+'\n    <marked-element class="project-param col-md-6 col-xs-12" id="note-preview">\n      <div class="markdown-html"></div>\n    </marked-element>\n    <h2 class="new-title col-xs-12">Data Permissions</h2>\n    <div class="col-xs-12">\n      <span class="toggle-off-label iron-label">Private Dataset</span>\n      <paper-toggle-button id="data-encumbrance-toggle" class="red">Public Dataset</paper-toggle-button>\n    </div>\n    <h2 class="new-title col-xs-12">Project Area of Interest</h2>\n    <div class="col-xs-12">\n      <p>\n        This represents the approximate collection region for your samples.\n        <br/>\n        <strong>\n          The last thing you do (search, build a locality, or upload data) will be your dataset\'s canonical locality.\n        </strong>.\n      </p>\n      <span class="toggle-off-label iron-label">Locality Name</span>\n      <paper-toggle-button id="transect-input-toggle">Coordinate List</paper-toggle-button>\n    </div>\n    <p id="transect-instructions" class="col-xs-12"></p>\n    <div id="transect-input" class="col-md-6 col-xs-12">\n      <div id="transect-input-container" class="clearfix">\n      </div>\n      <p class="computed-locality" id="computed-locality">\n        You may also click on the map to outline a region of interest, then click "Build Map" below to calculate a locality.\n      </p>\n      <br/><br/>\n      <button class="btn btn-primary" disabled id="init-map-build">\n        <iron-icon icon="maps:map"></iron-icon>\n        Build Map\n        <small>\n          (<span class="points-count">0</span> points)\n        </small>\n      </button>\n      <paper-icon-button icon="icons:restore" id="reset-map-builder" data-toggle="tooltip" title="Reset Points"></paper-icon-button>\n    </div>\n    <div id="carto-rendered-map" class="col-md-6">\n      <div id="carto-map-container" class="carto-map map">\n      </div>\n    </div>\n    <div class="col-xs-12">\n      <br/>\n      <paper-checkbox checked id="has-data">My project already has data</paper-checkbox>\n      <br/>\n    </div>\n  </div>\n</section>\n<section id="uploader-container-section" class="data-section col-xs-12">\n  <h2 class="new-title">Uploading your project data</h2>\n  <p>Drag and drop as many files as you need below. </p>\n  <p>\n    Please note that the data <strong>must</strong> have a header row,\n    and the data <strong>must</strong> have the columns <code>decimalLatitude</code>, <code>decimalLongitude</code>, and <code>coordinateUncertaintyInMeters</code>. Your project must also be titled before uploading data.\n  </p>\n  <div class="alert alert-info" role="alert">\n    We\'ve partnered with the Biocode FIMS project and you can get a template with definitions at <a href="http://biscicol.org/biocode-fims/templates.jsp" class="newwindow alert-link" data-newtab="true">biscicol.org <span class="glyphicon glyphicon-new-window"></span></a>. Select "Amphibian Disease" from the dropdown menu, and select your fields for your template. Your data will be validated with the same service.\n  </div>\n  <div class="alert alert-warning" role="alert">\n    <strong>If the data is in Excel</strong>, ensure that it is the first sheet in the workbook. Data across multiple sheets in one workbook may be improperly processed.\n  </div>\n</section>\n<section class="project-inputs clearfix data-section col-xs-12">\n  <div class="row">\n    <h2 class="new-title col-xs-12">Project Data Summary</h2>\n    <h3 class="new-title col-xs-12">Calculated Data Parameters</h3>\n    <paper-input label="Samples Counted" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="samplecount" readonly type="number" data-field="disease_samples"></paper-input>\n    <paper-input label="Positive Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="positive-samples" readonly type="number" data-field="disease_positive"></paper-input>\n    <paper-input label="Negative Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="negative-samples" readonly type="number" data-field="disease_negative"></paper-input>\n    <paper-input label="No Confidence Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="no_confidence-samples" readonly type="number" data-field="disease_no_confidence"></paper-input>\n    <paper-input label="Disease Morbidity" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="morbidity-count" readonly type="number" data-field="disease_morbidity"></paper-input>\n    <paper-input label="Disease Mortality" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="mortality-count" readonly type="number" data-field="disease_mortality"></paper-input>\n    <h4 class="new-title col-xs-12">Species in dataset</h4>\n    <iron-autogrow-textarea id="species-list" class="project-field col-md-6 col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    <p class="col-xs-12">Etc</p>\n  </div>\n</section>\n<section id="submission-section" class="col-xs-12">\n  <div class="pull-right">\n    <button id="upload-data" class="btn btn-success click" data-function="finalizeData"><iron-icon icon="icons:lock-open"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project</button>\n    <button id="reset-data" class="btn btn-danger click" data-function="resetForm">Reset Form</button>\n  </div>\n</section>',$("main #main-body").append(a),mapNewWindows();try{for(e=$("paper-input[required]"),c=0,d=e.length;d>c;c++)b=e[c],p$(b).validate()}catch(i){console.warn("Couldn't pre-validate fields")}return $(".fill-pathogen").click(function(){var a;return a=$(this).attr("data-pathogen"),p$("#project-disease").value=a,!1}),$("#init-map-build").click(function(){return doMapBuilder(window.mapBuilder,null,function(b){return a='<p class="text-muted" id="computed-locality">\n  Computed locality: <strong>'+b.locality+"</strong>\n</p>",$("#computed-locality").remove(),$("#transect-input-container").after(a),!1})}),$("#reset-map-builder").click(function(){return window.mapBuilder.points=[],$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length)}),g=p$("#project-notes").textarea,$(g).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),bootstrapUploader(),bootstrapTransect(),$("#has-data").on("iron-change",function(){return $(this).get(0).checked?($(".data-section").removeAttr("hidden"),$(".label-with-data").removeAttr("hidden")):($(".data-section").attr("hidden","hidden"),$(".label-with-data").attr("hidden","hidden"))}),$("#data-encumbrance-toggle").on("iron-change",function(){var a;return a=p$("#data-encumbrance-toggle").checked?'<iron-icon icon="social:public"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Public Project':'<iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project',$("#upload-data").html(a)}),console.log("Getting location, prerequisite to setting up map ..."),getLocation(function(){var a;return _adp.currentLocation=new Point(window.locationData.lat,window.locationData.lng),a={bsGrid:""},console.log("Location fetched, setting up map ..."),createMap2(null,a)}),bindClicks(),!1},finalizeData=function(){var a,b,c,d,e,f,g;startLoad();try{return b=!0,$("[required]").each(function(){var a;try{if(a=$(this).val(),isNull(a))return $(this).get(0).focus(),b=!1,!1}catch(c){}}),b?(a=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectId)&&(_adp.projectId=md5(""+geo.dataTable+a+Date.now())),g=p$("#project-title").value,e=null!=(f=null!=dataFileParams?dataFileParams.filePath:void 0)?f:null,mintBcid(_adp.projectId,e,g,function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N;try{if(!a.status)return console.error(a.error),bsAlert(a.human_error,"danger"),stopLoadError(a.human_error),!1;for(dataAttrs.ark=a.ark,null==dataAttrs.data_ark&&(dataAttrs.data_ark=[]),dataAttrs.data_ark.push(a.ark+"::"+dataFileParams.fileName),A={},B=$(".project-field"),p=0,q=B.length;q>p;p++)i=B[p],n=$(i).hasClass("iron-autogrow-textarea-0")?$($(i).get(0).textarea).val():$(i).val(),o=$(i).attr("data-field"),isNull(o)||("number"===$(i).attr("type")?A[o]=toInt(n):A[o]=n);if(c=getMapCenter(geo.boundingBox),k=0,null!=uploadedData){for(e=[],w=[],N=[],v=[],b=[],l=[],f=[],K=[],C=Object.toArray(uploadedData),t=0,r=C.length;r>t;t++)H=C[t],d=null!=(D=H.dateCollected)?D:H.dateIdentified,M=excelDateToUnixTime(d),e.push(M),L=new Date(M),u=dateMonthToString(L.getUTCMonth()),indexOf.call(w,u)<0&&w.push(u),E=L.getFullYear(),indexOf.call(N,E)<0&&N.push(L.getFullYear()),null!=H.catalogNumber&&b.push(H.catalogNumber),l.push(H.fieldNumber),I=H.decimalLatitude,J=H.decimalLongitude,g=geo.distance(I,J,c.lat,c.lng),g>k&&(k=g),null!=H.sampleType&&(F=H.sampleType,indexOf.call(K,F)<0&&K.push(H.sampleType)),null!=H.specimenDisposition&&(G=H.specimenDisposition,indexOf.call(f,G)<0&&f.push(H.sampleDisposition));console.info("Got date ranges",e),w.sort(),N.sort(),A.sampled_collection_start=e.min(),A.sampled_collection_end=e.max(),console.info("Collected from",e.min(),e.max()),A.sampling_months=w.join(","),A.sampling_years=N.join(","),console.info("Got uploaded data",uploadedData),A.sample_catalog_numbers=b.join(","),A.sample_field_numbers=l.join(","),A.sample_methods_used=K.join(",")}else if(null!=geo.canonicalHullObject)for(m=geo.canonicalHullObject.hull,x=0,s=m.length;s>x;x++)y=m[x],g=geo.distance(y.lat,y.lng,c.lat,c.lng),g>k&&(k=g);if((null!=dataFileParams?dataFileParams.hasDataFile:void 0)&&(dataFileParams.filePath.search(-1===helperDir)&&(dataFileParams.filePath=""+helperDir+dataFileParams.filePath),A.sample_raw_data="https://amphibiandisease.org/"+dataFileParams.filePath),A.lat=c.lat,A.lng=c.lng,A.radius=toInt(1e3*k),z=function(){var a,b,c,d,e,f,g,h,i,j,k;console.info("Computed locality "+_adp.locality),A.locality=_adp.locality,null!=geo.computedBoundingRectangle&&(A.bounding_box_n=geo.computedBoundingRectangle.north,A.bounding_box_s=geo.computedBoundingRectangle.south,A.bounding_box_e=geo.computedBoundingRectangle.east,A.bounding_box_w=geo.computedBoundingRectangle.west),A.author=$.cookie(adminParams.domain+"_link"),b={name:p$("#project-author").value,contact_email:p$("#author-email").value,affiliation:p$("#project-affiliation").value,lab:p$("#project-pi").value,diagnostic_lab:p$("#project-lab").value,entry_date:Date.now()},A.author_data=JSON.stringify(b),d={table:geo.dataTable,raw_data:dataFileParams,bounding_polygon:"undefined"!=typeof geo&&null!==geo?geo.canonicalBoundingBox:void 0,bounding_polygon_geojson:"undefined"!=typeof geo&&null!==geo?geo.geoJsonBoundingBox:void 0},A.carto_id=JSON.stringify(d),A.project_id=_adp.projectId;try{A.project_obj_id=_adp.fims.expedition.ark}catch(l){return mintExpedition(_adp.projectId,null,function(){return z()}),!1}if(null==dataAttrs.data_ark&&(dataAttrs.data_ark=[]),A.dataset_arks=dataAttrs.data_ark.join(","),A.project_dir_identifier=getUploadIdentifier(),A["public"]=p$("#data-encumbrance-toggle").checked,null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(h=_adp.data)&&null!=(i=h.taxa)?i.validated:void 0))for(j=_adp.data.taxa.validated,A.sampled_clades=_adp.data.taxa.clades.join(","),A.sampled_species=_adp.data.taxa.list.join(","),g=0,f=j.length;f>g&&(k=j[g],c=k.response.validated_taxon,console.info("Aweb taxon result:",c),e=c.order.toLowerCase(),o="includes_"+e,A[o]=!0,null!=A.includes_anura==!1||null!=A.includes_caudata==!1||null!=A.includes_gymnophiona==!1);g++);return a="perform=new&data="+jsonTo64(A),console.info("Data object constructed:",A),$.post(adminParams.apiTarget,a,"json").done(function(a){return a.status===!0?(bsAlert("Project ID #<strong>"+A.project_id+"</strong> created","success"),stopLoad(),delay(1e3,function(){return loadEditor(_adp.projectId)}),toastStatusMessage("Data successfully saved to server")):(console.error(a.error.error),console.log(a),stopLoadError(a.human_error)),!1}).error(function(a,b){return stopLoadError("There was a problem saving your data. Please try again"),!1})},console.info("Checking locality ..."),null==geo.computedLocality&&dataFileParams.hasDataFile){if(dataFileParams.hasDataFile)return null==c&&(c=getMapCenter(geo.boundingBox)),console.info("Computing locality with reverse geocode from",c,geo.boundingBox),geo.reverseGeocode(c.lat,c.lng,geo.boundingBox,function(a){return console.info("Computed locality "+a),_adp.locality=a,z()});try{_adp.locality=p$("#locality-input").value}catch(O){_adp.locality=""}return console.warn("How did we get to this state? No locality precomputed, no data file"),z()}if(null!=geo.computedLocality)console.info("Already have locality"),_adp.locality=geo.computedLocality;else try{console.info("Took written locality"),_adp.locality=p$("#locality-input").value}catch(P){console.info("Can't figure out locality"),_adp.locality=""}return dataFileParams.hasDataFile?z():mintExpedition(_adp.projectId,null,function(){return z()})}catch(j){return h=j,stopLoadError("There was a problem with the application. Please try again later. (E-003)"),console.error("JavaScript error in saving data (E-003)! FinalizeData said: "+h.message),console.warn(h.stack)}})):(stopLoadError("Please fill out all required fields"),!1)}catch(d){return c=d,stopLoadError("There was a problem with the application. Please try again later. (E-004)"),console.error("JavaScript error in saving data (E-004)! FinalizeData said: "+c.message),console.warn(c.stack)}},resetForm=function(){return foo()},getTableCoordinates=function(a){return null==a&&(a="tdf0f1bc730325de59d48a5c80df45931_6d6d454828c05e8ceea03c99cc5f547e52fcb5fb"),!1},pointStringToLatLng=function(a){var b,c,d;return a.search(!1)?(d=a.slice(6,-1),b=d.split(" "),c={lat:b[0],lng:b[1]}):(console.warn("Invalid point string"),!1)},pointStringToPoint=function(a){var b,c,d;return a.search(!1)?(d=a.slice(6,-1),c=d.split(" "),b=new Point(c[0],c[1])):(console.warn("Invalid point string"),!1)},bootstrapTransect=function(){var a,b;return window.geocodeLookupCallback=function(){var a,b,c;return startLoad(),b=p$("#locality-input").value,a=new google.maps.Geocoder,c={address:b},a.geocode(c,function(a,b){var c,d,e,f,g,h,i,j,k,l;if(b===google.maps.GeocoderStatus.OK){console.info("Google said:",a),$("#locality-lookup-result").exists()||$("#carto-rendered-map").prepend('<div class="alert alert-info alert-dismissable" role="alert" id="locality-lookup-result">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <strong>Location Found</strong>: <span class="lookup-name"></span>\n</div>'),$("#locality-lookup-result .lookup-name").text(a[0].formatted_address),_adp.locality=a[0].formatted_address,l=a[0].geometry.location,j=l.lat(),k=l.lng(),f=a[0].geometry.viewport;try{c=f.R,d=f.j,e={nw:[c.j,d.R],ne:[c.j,d.j],se:[c.R,d.R],sw:[c.R,d.j],north:c.j,south:c.R,east:d.j,west:d.R}}catch(i){h=i,console.warn("Danger: There was an error calculating the bounding box ("+h.message+")"),console.warn(h.stack),console.info("Got bounds",f),console.info("Got geometry",a[0].geometry)}return console.info("Got bounds: ",[j,k],e),geo.boundingBox=e,g=function(){return geo.renderMapHelper(e,j,k)},loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",g,!1)}return stopLoadError("Couldn't find location: "+b)})},geo.renderMapHelper=function(a,b,c){var d,e,f,g,h;if(null==a&&(a=geo.boundingBox),startLoad(),null==("undefined"!=typeof google&&null!==google?google.maps:void 0))return window.recallMapHelper=function(){return geo.renderMapHelper(a,b,c)},loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=recallMapHelper"),!1;try{return $("#carto-map-container").empty(),f={selector:"#carto-map-container",bsGrid:""},$(f.selector).empty(),h=function(){return stopLoad(),!1},null!=geo.dataTable?getCanonicalDataCoords(geo.dataTable,f,function(){return h()}):(f.boundingBox=a,g=new Point(b,c),createMap2([g],f,function(){return h()}))}catch(e){return d=e,console.error("There was an error rendering the map - "+d.message),stopLoadError("There was an error rendering the map - "+d.message)}},a=function(){return null==("undefined"!=typeof google&&null!==google?google.maps:void 0)?loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=geocodeLookupCallback"):geocodeLookupCallback(),!1},(b=function(){var b,c;return p$("#transect-input-toggle").checked?(b="Please input a list of coordinates, in the form <code>lat, lng</code>, with one set on each line. <strong>Please press <kbd>enter</kbd> to insert a new line after your last coordinate</strong>.",c='<iron-autogrow-textarea id="coord-input" class="" rows="3"></iron-autogrow-textarea>'):(b="Please enter a name of a locality",c='<paper-input id="locality-input" label="Locality" class="pull-left"></paper-input> <paper-icon-button class="pull-left" id="do-search-locality" icon="icons:search"></paper-icon-button>'),$("#transect-instructions").html(b),$("#transect-input-container").html(c),p$("#transect-input-toggle").checked?$(p$("#coord-input").textarea).keyup(function(a){return function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(j=a.keyCode?a.keyCode:a.which,13===j&&(q=$(p$("#coord-input").textarea).val(),n=q.split("\n").length,n>3)){for(f=[],g=q.split("\n"),console.info("Raw coordinate info:",g),k=0,l=g.length;l>k;k++)d=g[k],d.search(",")>0&&!isNull(d)&&(e=d.split(","),2===e.length&&(p=[toFloat(e[0]),toFloat(e[1])],f.push(p)));if(f.length>=3){for(console.info("Coords:",f),i=0,b={},o=0,m=f.length;m>o;o++)c=f[o],++i,b[i]=c;return h=function(){return geo.renderMapHelper(b)},geo.boundingBox=b,loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",h,!1)}return console.warn("There is one or more invalid coordinates preventing the UI from being shown.")}}}(this)):($("#locality-input").keyup(function(b){var c;return c=b.keyCode?b.keyCode:b.which,13===c?a():void 0}),$("#do-search-locality").click(function(){return a()})),!1})(),$("#transect-input-toggle").on("iron-change",function(){return b()}),!1},mapOverlayPolygon=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;if(null==b&&(b=null),null==c&&(c={}),null==d&&(d=geo.googleMap),o={},"object"!=typeof a)return console.warn("mapOverlayPolygon() got an invalid data type to overlay!"),!1;if("object"!=typeof c&&(c={}),null==c.fillColor&&(c.fillColor="#ff7800"),o.fillColor=c.fillColor,o.fillOpacity=.35,"object"!=typeof b&&(b=null),console.info("Should overlay polygon from bounds here"),$("#carto-map-container").exists()&&null!=geo.cartoMap){t=[],f=[],e=[],m=[],n=[],u=-90,w=90,k=-180,y=180;for(s in a)v=a[s],t.push(v),x={},x.lat=v[0],x.lng=v[1],e.push(new fPoint(x.lat,x.lng)),n.push(new Point(x.lat,x.lng));m=sortPoints(n),f=sortPoints(n,!1),g=e,g.sort(sortPointY),g.sort(sortPointX),h=[],h.push(t);try{i=getConvexHullPoints(g)}catch(l){j=l,console.error("Convex hull points CHP failed! - "+j.message),console.warn(j.stack),console.info(g)}console.info("Got hulls",i),console.info("Sources",f,e,g),o.paths=i,r={type:"Polygon",coordinates:i},q={type:"Feature",properties:b,geometry:r},console.info("Rendering GeoJSON MultiPolygon",r),geo.geoJsonBoundingBox=q,geo.overlayOptions=c,console.info("Rendering Google Maps polygon",o),geo.canonicalBoundingBox=o,p=new google.maps.Polygon(o),null!=geo.googlePolygon&&geo.googlePolygon.setMap(null),geo.googlePolygon=p,p.setMap(d),isNull(dataAttrs.coords||isNull(geo.dataTable))||getCanonicalDataCoords(geo.dataTable)}else console.warn("There's no map yet! Can't overlay polygon");return!1},mapAddPoints=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(null==c&&(c=geo.googleMap),j=0,k=a.length;k>j;j++)if(r=a[j],!(r instanceof geo.Point))return console.warn("Invalid datatype in array -- array must be constructed of Point objects"),!1;for(q={},g=[],e=0,m=0,l=a.length;l>m;m++)r=a[m],u=null!=b?null!=(t=b[e])?t.title:void 0:"",s=r.getObj(),d=new google.maps.LatLng(s.lat,s.lng),o={position:d,map:c,title:u},n=new google.maps.Marker(o),q[e]={marker:n},isNull(u)?console.info("Key "+e+" has no title in pointInfoArray",b[e]):(h={content:b[e].html},f=new google.maps.InfoWindow(h),q[e].infoWindow=f,g.push(f)),++e;if(!isNull(g)){dataAttrs.coordInfoWindows=g;for(i in q)p=q[i],n=p.marker,n.unbind("click"),n.self=n,n.iw=p.infoWindow,n.iwk=i,n.addListener("click",function(){var a,b;try{return this.iw.open(c,this),console.info("Opening infoWindow #"+this.iwk)}catch(b){return a=b,console.error("Invalid infowindow @ "+this.iwk+"!",g,p,this.iw)}});geo.markers=q}return q},getCanonicalDataCoords=function(a,b,c){return null==b&&(b=_adp.defaultMapOptions),null==c&&(c=createMap2),isNull(a)?(console.error("A table must be specified!"),!1):"function"!=typeof c?(console.error("This function needs a callback function as the second argument"),!1):(verifyLoginCredentials(function(d){var e,f,g,h,i,j,k,l;i=getColumnObj(),j=[],h={};for(g in i)l=i[g],"id"!==g&&"the_geom"!==g&&(j.push(g),h[g.toLowerCase()]=g);return k="SELECT ST_AsText(the_geom), "+j.join(",")+" FROM "+a,e=encodeURIComponent(encode64(k)),f="action=fetch&sql_query="+e,$.post("api.php",f,"json").done(function(a){var e,f,i,j,k,l,m,n,o,p;e=a.parsed_responses[0],f=[],j=[],_adp.cartoRows={},m=e.rows;for(i in m){n=m[i],_adp.cartoRows[i]={};for(g in n)p=n[g],l=h[g],_adp.cartoRows[i][l]=p;o=n.st_astext,isNull(n.infraspecificepithet)&&(n.infraspecificepithet=""),k=pointStringToLatLng(o),d={title:n.catalognumber+": "+n.genus+" "+n.specificepithet+" "+n.infraspecificepithet,html:'<p>\n  <span class="sciname italic">'+n.genus+" "+n.specificepithet+" "+n.infraspecificepithet+"</span> collected on "+n.dateidentified+"\n</p>\n<p>\n  <strong>Status:</strong>\n  Sampled by "+n.samplemethod+", disease status "+n.diseasedetected+" for "+n.diseasetested+"\n</p>"},k.infoWindow=d,f.push(k),j.push(d)}return dataAttrs.coords=f,dataAttrs.markerInfo=j,console.info("Calling back with",f,b),c(f,b)}).error(function(a,d){return null!=(null!=dataAttrs?dataAttrs.coords:void 0)?c(dataAttrs.coords,b):(stopLoadError("Couldn't get bounding coordinates from data"),console.error("No valid coordinates accessible!"))})}),!1)},getUploadIdentifier=function(){var a,b,c;return isNull(_adp.uploadIdentifier)&&(isNull(_adp.projectId)&&(a=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectIdentifierString)&&(c=isNull(p$("#project-title").value)?randomString(16):p$("#project-title").value,b="t"+md5(c+a),_adp.projectIdentifierString=b),_adp.projectId=md5(""+b+a+Date.now())),_adp.uploadIdentifier=md5(""+user+_adp.projectId)),_adp.uploadIdentifier},bootstrapUploader=function(a,b,c){var d,e,f,g,h;return null==a&&(a="file-uploader"),null==b&&(b="col-md-4"),g="#"+a,d=$.cookie(adminParams.domain+"_link"),h=getUploadIdentifier(),f=_adp.projectIdentifierString,$(g).exists()||(e='<form id="'+a+'-form" class="'+b+' clearfix">\n  <p class="visible-xs-block">Tap the button to upload a file</p>\n  <fieldset class="hidden-xs">\n    <legend>Upload Files</legend>\n    <div id="'+a+'" class="media-uploader outline media-upload-target">\n    </div>\n  </fieldset>\n</form>',$("main #uploader-container-section").append(e),console.info("Appended upload form"),$(g).submit(function(a){return a.preventDefault(),a.stopPropagation(),!1})),verifyLoginCredentials(function(){var a;return null==window.dropperParams&&(window.dropperParams={}),window.dropperParams.dropTargetSelector=g,window.dropperParams.uploadPath="uploaded/"+getUploadIdentifier()+"/",a=window.dropperParams.hasInitialized===!0,loadJS("helpers/js-dragdrop/client-upload.min.js",function(){
if(console.info("Loaded drag drop helper"),a){console.info("Reinitialized dropper");try{window.dropperParams.initialize()}catch(b){console.warn("Couldn't reinitialize dropper!")}}return window.dropperParams.postUploadHandler=function(a,b){var c,d,e,f,g,h,i,j,k;if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof b)return console.error("Dropzone returned an error - "+b),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(b.status!==!0)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(""+b.human_error),console.error("Error uploading!",b),!1;try{switch(console.info("Server returned the following result:",b),console.info("The script returned the following file information:",a),i="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",e=b.full_path.split("/").pop(),k=b.wrote_thumb,h=b.mime_provided.split("/")[0],g=b.mime_provided.split("/")[1],f=a.size<5242880||"image"!==h?""+i+b.wrote_file:""+i+k,j=function(){switch(h){case"image":return'<div class="uploaded-media center-block" data-system-file="'+e+'" data-link-path="'+f+'">\n  <img src="'+f+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+a.name+" -> "+e+'\n      (<a href="'+f+'" class="newwindow" download="'+a.name+'">\n        Original Image\n      </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+e+'">\n  <audio src="'+f+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+a.name+" -> "+e+'\n    (<a href="'+f+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+e+'">\n  <video src="'+f+'" controls preload="auto">\n    <img src="'+i+k+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+a.name+" -> "+e+'\n    (<a href="'+f+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+e+'" data-link-path="'+f+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+a.name+" -> "+e+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(j),$("#validator-progress-container").remove(),h){case"application":switch(console.info("Checking "+g+" in application"),g){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":return excelHandler(f);case"zip":case"x-zip-compressed":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===a.type||"xlsx"===f.split(".").pop()?excelHandler(f):zipHandler(f);case"x-7z-compressed":return _7zHandler(f)}break;case"text":return csvHandler();case"image":return imageHandler()}}catch(d){return c=d,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}},"function"==typeof c?c():void 0}),!1})},singleDataFileHelper=function(a,b){var c;return"function"!=typeof b?(console.error("Second argument must be a function"),!1):dataFileParams.hasDataFile===!0&&a!==dataFileParams.filePath?($("#single-data-file-modal").exists()&&$("#single-data-file-modal").remove(),c='<paper-dialog modal id="single-data-file-modal">\n  <h2>You can only have one primary data file</h2>\n  <div>\n    Continuing will remove your previous one\n  </div>\n  <div class="buttons">\n    <paper-button id="cancel-parse">Cancel Upload</paper-button>\n    <paper-button id="overwrite">Replace Previous</paper-button>\n  </div>\n</paper-dialog>',$("body").append(c),$("#cancel-parse").click(function(){return removeDataFile(a,!1),p$("#single-data-file-modal").close(),!1}),$("#overwrite").click(function(){return removeDataFile(),p$("#single-data-file-modal").close(),b()}),safariDialogHelper("#single-data-file-modal")):b()},excelHandler=function(a,b,c){var d,e,f;return null==b&&(b=!0),startLoad(),$("#validator-progress-container").remove(),renderValidateProgress(),f=helperDir+"excelHelper.php",e=a,-1!==a.search(helperDir)&&(console.info("removing '"+helperDir+"'"),e=a.slice(helperDir.length)),console.info("Pinging for "+e),d="action=parse&path="+e+"&sheets=Samples",$.get(f,d,"json").done(function(b){return console.info("Got result",b),b.status===!1?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):singleDataFileHelper(a,function(){var d,f;return $("#upload-data").attr("disabled","disabled"),d=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=d.pop(),dataFileParams.filePath=e,f=Object.size(b.data),uploadedData=b.data,_adp.parsedUploadedData=b.data,"function"!=typeof c?newGeoDataHandler(b.data):(console.warn("Skipping newGeoDataHandler() !"),c(b.data)),stopLoad()})}).fail(function(a,b){return console.error("Couldn't POST"),console.warn(a,b),stopLoadError()}),!1},csvHandler=function(a){var b;return b=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=b.pop(),dataFileParams.filePath=correctedPath,geoDataHandler(),!1},copyMarkdown=function(a,b,c){var d,e,f,g,h,i,j;if(null==c&&(c=!0),null==("undefined"!=typeof _adp&&null!==_adp?_adp.zcClient:void 0)&&(j={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},ZeroClipboard.config(j),_adp.zcClient=new ZeroClipboard($(a).get(0)),$("#copy-ark").click(function(){return copyLink(_adp.zcClient)})),d=p$(".ark-identifier").value,c)try{return i="https://n2t.net/"+d,f={dataType:"text/plain",data:i,"text/plain":i},e=new ClipboardEvent("copy",f),document.dispatchEvent(e),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(h){g=h,console.error("Error creating copy: "+g.message),console.warn(g.stack)}return console.warn("Can't use HTML5"),"undefined"!=typeof zeroClipObj&&null!==zeroClipObj?(zeroClipObj.setData(f),null!=b&&b.setData(f),zeroClipObj.on("aftercopy",function(a){return a.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):toastStatusMessage("Error copying to clipboard")}),zeroClipObj.on("error",function(a){if(console.error("Error copying to clipboard"),console.warn("Got",a),"flash-overdue"===a.name){if(_adp.resetClipboard===!0)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,copyLink()}),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0))}return"flash-disabled"===a.name?(console.info("No flash on this system"),ZeroClipboard.destroy(),$("#copy-ark").tooltip("destroy").remove(),$(".ark-identifier").removeClass("col-xs-9 col-md-11").addClass("col-xs-12"),toastStatusMessage("Clipboard copying isn't available on your system")):void 0})):console.error("Can't use HTML, and ZeroClipboard wasn't passed"),!1},imageHandler=function(a){var b;return b=$("div[data-link-path='"+a+"']"),foo(),!1},zipHandler=function(a){return foo(),!1},_7zHandler=function(a){return foo(),!1},removeDataFile=function(a,b){var c,d;return null==a&&(a=dataFileParams.fileName),null==b&&(b=!0),a=a.split("/").pop(),b&&(dataFileParams.hasDataFile=!1),$(".uploaded-media[data-system-file='"+a+"']").remove(),$("#validator-progress-container paper-progress").removeAttr("indeterminate"),d=helperDir+"/js-dragdrop/uploaded/"+_adp.uploadIdentifier+"/"+a,c="action=removefile&path="+encode64(d)+"&user="+user,!1},newGeoDataHandler=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;null==a&&(a={}),null==b&&(b=!1);try{if(null==geo.geocoder)try{geo.geocoder=new google.maps.Geocoder}catch(H){}try{z=a[0]}catch(I){return toastStatusMessage("Your data file was malformed, and could not be parsed. Please try again."),removeDataFile(),!1}if(isNull(z.decimalLatitude)||isNull(z.decimalLongitude)||isNull(z.coordinateUncertaintyInMeters))return toastStatusMessage("Data are missing required geo columns. Please reformat and try again."),s="You're missing ",r=[],isNull(z.decimalLatitude)&&r.push("decimalLatitude"),isNull(z.decimalLongitude)&&r.push("decimalLongitude"),isNull(z.coordinateUncertaintyInMeters)&&r.push("coordinateUncertaintyInMeters"),s+=r.length>1?"some required columns: ":"a required column: ",q=r.join("</code>, <code>"),s+="<code>"+q+"</code>",bsAlert(s,"danger"),console.info("Missing: ",null!=z.decimalLatitude,null!=z.decimalLongitude,null!=z.coordinateUncertaintyInMeters),removeDataFile(),!1;if(!(isNumber(z.decimalLatitude)&&isNumber(z.decimalLongitude)&&isNumber(z.coordinateUncertaintyInMeters)))return toastStatusMessage("Data has invalid entries for geo columns. Please be sure they're all numeric and try again."),removeDataFile(),!1;y=Object.size(a);try{p$("#samplecount").value=y}catch(H){}if(isNull($("#project-disease").val()))try{p$("#project-disease").value=z.diseaseTested}catch(H){}v={},dataAttrs.coords=[],dataAttrs.coordsFull=[],dataAttrs.fimsData=[],n={},toastStatusMessage("Please wait, parsing your data"),$("#data-parsing").removeAttr("indeterminate");try{p$("#data-parsing").max=y}catch(H){}for(u in a){x=a[u],D={};for(f in x){switch(G=x[f],f=f.trim(),B=!1,f){case"ContactName":case"basisOfRecord":case"occurrenceID":case"institutionCode":case"collectionCode":case"labNumber":case"originalsource":case"datum":case"georeferenceSource":case"depth":case"Collector2":case"Collector3":case"verbatimLocality":case"Habitat":case"Test_Method":case"eventRemarks":case"quantityDetected":case"dilutionFactor":case"cycleTimeFirstDetection":n[f]=G,B=!0;break;case"specimenDisposition":f="sampleDisposition";break;case"sampleType":f="sampleMethod";break;case"elevation":f="alt";break;case"dateCollected":case"dateIdentified":f="dateIdentified",C=excelDateToUnixTime(G),i=new Date(C),k=i.getUTCDate(),10>k&&(k="0"+k),t=i.getUTCMonth()+1,10>t&&(t="0"+t),e=i.getUTCFullYear()+"-"+t+"-"+k;break;case"fatal":e=G.toBool();break;case"decimalLatitude":case"decimalLongitude":case"alt":case"coordinateUncertaintyInMeters":if(!isNumber(G))return stopLoadBarsError(null,"Detected an invalid number for "+f+" at row "+u+" ('"+G+"')"),!1;if("decimalLatitude"===f&&-90>G&&G>90)return stopLoadBarsError(null,"Detected an invalid latitude "+G+" at row "+u),!1;if("decimalLongitude"===f&&-180>G&&G>180)return stopLoadBarsError(null,"Detected an invalid longitude "+G+" at row "+u),!1;if("coordinateUncertaintyInMeters"===f&&0>=G)return stopLoadBarsError(null,"Coordinate uncertainty must be >= 0 at row "+u),!1;e=toFloat(G);break;case"diseaseDetected":e=isBool(G)?G.toBool():"NO_CONFIDENCE";break;case"fieldNumber":try{F=G.trim(),F=F.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2"),e=F}catch(J){e=G}break;default:try{e=G.trim()}catch(K){e=G}}B||(D[f]=e)}g={lat:D.decimalLatitude,lng:D.decimalLongitude,alt:D.alt,uncertainty:D.coordinateUncertaintyMeters},h=new Point(g.lat,g.lng),dataAttrs.coords.push(h),dataAttrs.coordsFull.push(g),dataAttrs.fimsData.push(n);try{D.fimsExtra=JSON.stringify(n)}catch(L){console.warn("Couldn't store FIMS extra data",n)}v[u]=D,0===modulo(u,500)&&u>0&&toastStatusMessage("Processed "+u+" rows ...");try{p$("#data-parsing").value=u+1}catch(H){}}isNull(_adp.projectIdentifierString)?(w="t"+md5(p$("#project-title").value+c),_adp.projectIdentifierString=w):w=_adp.projectIdentifierString,o=function(){var a,b,c,d,e,f,g;for(b=0,c={},f=sortPoints(dataAttrs.coords),g="",d=0,e=f.length;e>d;d++)a=f[d],c[b]=[a.lat,a.lng],g+=a.lat+","+a.lng+"\n",++b;try{p$("#transect-input-toggle").checked=!0,g+="\n",$(p$("#coord-input").textarea).val(g)}catch(h){}return c},null==geo.boundingBox&&(geo.boundingBox=o()),d=getMapCenter(geo.boundingBox),geo.reverseGeocode(d.lat,d.lng,geo.boundingBox,function(a){_adp.locality=a,dataAttrs.locality=a;try{return p$("#locality-input").value=a,p$("#locality-input").readonly=!0}catch(b){}}),A={mortality:0,morbidity:0,positive:0,negative:0,no_confidence:0};for(p in v){switch(j=v[p],j.diseaseDetected){case!0:A.morbidity++,A.positive++;break;case!1:A.negative++;break;case"NO_CONFIDENCE":A.no_confidence++}j.fatal&&A.mortality++}try{p$("#positive-samples").value=A.positive,p$("#negative-samples").value=A.negative,p$("#no_confidence-samples").value=A.no_confidence,p$("#morbidity-count").value=A.morbidity,p$("#mortality-count").value=A.mortality}catch(H){}isNull(_adp.projectId)&&(c=$.cookie(adminParams.domain+"_link"),_adp.projectId=md5(""+w+c+Date.now())),E={transectRing:geo.boundingBox,data:v,samples:A,dataSrc:""+helperDir+dataFileParams.filePath},null==("undefined"!=typeof _adp&&null!==_adp?_adp.data:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),window._adp.data={}),_adp.data.pushDataUpload=E,validateData(E,function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(o="",n=[],c=[],f=0,k=a.validated_taxa,g=0,h=k.length;h>g;g++){m=k[g],p=m.genus+" "+m.species,null!=m.response.original_taxon&&(console.info("Taxon obj",m),j=""+m.response.original_taxon.slice(0,1).toUpperCase()+m.response.original_taxon.slice(1),i='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+j+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+p+"</em>' below. <a href=\""+m.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(i)),isNull(m.subspecies)||(p+=" "+m.subspecies),f>0&&(o+="\n"),o+=""+p,n.push(p);try{l=m.response.validated_taxon.family,indexOf.call(c,l)<0&&c.push(m.response.validated_taxon.family)}catch(e){d=e,console.warn("Couldn't get the family! "+d.message,m.response),console.warn(d.stack)}++f}try{p$("#species-list").bindValue=o}catch(q){}return dataAttrs.dataObj=a,_adp.data.dataObj=a,_adp.data.taxa={},_adp.data.taxa.list=n,_adp.data.taxa.clades=c,_adp.data.taxa.validated=a.validated_taxa,"function"!=typeof b&&b!==!0?geo.requestCartoUpload(a,w,"create",function(a,b,c){return createMap2(b,c,function(){return window.mapBuilder.points=[],$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length)})}):"function"==typeof b?b(a,w):console.warn("Carto upload was skipped, but no callback provided")})}catch(m){l=m,console.error("Error parsing data - "+l.message),console.warn(l.stack),toastStatusMessage("There was a problem parsing your data")}return!1},excelDateToUnixTime=function(a){var b,c,d,e;try{a>0&&1e6>a?(b=25569,c=24107,d=86400,e=(a-b)*d*1e3):e=Date.parse(a)}catch(f){e=Date.now()}return e},renderValidateProgress=function(a,b){var c;return null==a&&(a="#file-uploader-form"),null==b&&(b=!1),c='<div id="validator-progress-container" class="col-md-6 col-xs-12">\n  <label for="data-parsing">Data Parsing:</label><paper-progress id="data-parsing" class="blue" indeterminate></paper-progress>\n  <label for="data-validation">Data Validation:</label><paper-progress id="data-validation" class="cyan" indeterminate></paper-progress>\n  <label for="taxa-validation">Taxa Validation:</label><paper-progress id="taxa-validation" class="teal" indeterminate></paper-progress>\n  <label for="data-sync">Estimated Data Sync Progress:</label><paper-progress id="data-sync" indeterminate></paper-progress>\n</div>',$("#validator-progress-container").exists()||$(a).after(c),b?c:!1},checkInitLoad=function(a){var b,c,d;if($("#please-wait-prefill").remove(),d=uri.o.param("id"),isNull(d))if(b="string"==typeof a?a:"object"==typeof a?a["do"]+":"+a.prop:uri.o.attr("fragment"),isNull(b))"function"==typeof a&&a();else switch(c=b.split(":"),console.info("Looking at fragment",b,c),c[0]){case"edit":loadEditor(c[1]);break;case"action":switch(c[1]){case"show-editable":loadEditor();break;case"create-project":loadCreateNewProject();break;case"show-viewable":loadProjectBrowser();break;case"show-su-viewable":loadSUProjectBrowser()}break;case"home":populateAdminActions()}else loadEditor(d);return!1},window.onpopstate=function(a){return console.log("State popped",a,a.state),checkInitLoad(a.state),!1},$(function(){return $("#next").exists()&&$("#next").unbind().click(function(){return openTab(adminParams.adminPageUrl)}),loadJS("bower_components/bootstrap/dist/js/bootstrap.min.js",function(){return $("body").tooltip({selector:"[data-toggle='tooltip']"})}),checkFileVersion(!1,"js/admin.min.js"),$("paper-icon-button[icon='icons:dashboard']").removeAttr("data-href").unbind("click").click(function(){return populateAdminActions()})}),loadEditor=function(a){var b,c;return startAdminActionHelper(),b=function(a){var b,d;return startAdminActionHelper(),d=uri.urlString+"admin-page.html#edit:"+a,b={"do":"edit",prop:a},history.pushState(b,"Editing #"+a,d),startLoad(),window.projectParams={},window.projectParams.pid=a,verifyLoginCredentials(function(b){var d,e,f;return f=b.detail,user=f.uid,e=a,a=encodeURIComponent(a),d="perform=get&project="+a,$.post(adminParams.apiTarget,d,"json").done(function(b){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da,ea;try{if(console.info("Server said",b),b.status!==!0)return u=null!=(T=b.human_error)?T:b.error,null==u&&(u="Unidentified Error"),stopLoadError("There was a problem loading your project ("+u+")"),console.error("Couldn't load project! (POST OK) Error: "+b.error),console.warn("Attempted",adminParams.apiTarget+"?"+d),!1;if(b.user.has_edit_permissions!==!0)return b.user.has_view_permissions||b.project["public"].toBool()===!0?(loadProject(e,"Ineligible to edit "+e+", loading as read-only"),delay(1e3,function(){return loadProject(a)}),!1):(alertBadProject(e),!1);for(R=b.project,R.access_data.total=Object.toArray(R.access_data.total),R.access_data.total.sort(),R.access_data.editors_list=Object.toArray(R.access_data.editors_list),R.access_data.viewers_list=Object.toArray(R.access_data.viewers_list),R.access_data.editors=Object.toArray(R.access_data.editors),R.access_data.viewers=Object.toArray(R.access_data.viewers),console.info("Project access lists:",R.access_data),_adp.projectData=R,_adp.fetchResult=b,aa="",U=R.access_data.total,C=0,D=U.length;D>C;C++){user=U[C];try{_=R.access_data.composite[user].user_id}catch(fa){}B="",user===R.access_data.author?B='<iron-icon icon="social:person"></iron-icon>':indexOf.call(R.access_data.editors_list,user)>=0?B='<iron-icon icon="image:edit"></iron-icon>':indexOf.call(R.access_data.viewers_list,user)>=0&&(B='<iron-icon icon="icons:visibility"></iron-icon>'),aa+='<tr class="user-permission-list-row" data-user="'+_+'">\n  <td colspan="5">'+user+'</td>\n  <td class="text-center user-current-permission">'+B+"</td>\n</tr>"}B=R["public"].toBool()?'<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>':'<iron-icon icon="icons:lock" class="material-red" data-toggle="tooltip" title="Private Project"></iron-icon>',S=R["public"].toBool()?"<!-- This project is already public -->":b.user.is_author?'<div class="col-xs-12">\n  <paper-toggle-button id="public" class="project-params danger-toggle red">\n    <iron-icon icon="icons:warning"></iron-icon>\n    Make this project public\n  </paper-toggle-button> <span class="text-muted small">Once saved, this cannot be undone</span>\n</div>':"<!-- This user does not have permission to toggle the public state of this project -->",n=b.user.has_edit_permissions?"":"readonly",g=R.includes_anura.toBool()?"checked disabled":"disabled",k=R.includes_caudata.toBool()?"checked disabled":"disabled",y=R.includes_gymnophiona.toBool()?"checked disabled":"disabled";try{j=JSON.parse(deEscape(R.carto_id))}catch(ga){console.error("Couldn't parse the carto JSON!",R.carto_id),stopLoadError("We couldn't parse your data. Please try again later."),j={}}H="";try{i=Object.toArray(j.bounding_polygon)}catch(ha){i=null}o={boundingBox:i,classes:"carto-data map-editor",bsGrid:"",skipPoints:!1,skipHull:!1,onlyOne:!0},geo.mapOptions=o,null==(null!=(V=j.bounding_polygon)?V.paths:void 0)&&(x='<google-map id="transect-viewport" latitude="'+R.lat+'" longitude="'+R.lng+'" fit-to-markers map-type="hybrid" disable-default-ui  apiKey="'+gMapsApiKey+'">\n</google-map>'),null==x&&(x=""),geo.googleMapWebComponent=x,s=b.user.is_author?'<div class="card-actions">\n      <paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>\n    </div>':"",J=isNull(R.sample_notes)?"*No notes for this project*":R.sample_notes.unescape(),O='<h3>Project Notes</h3>\n<ul class="nav nav-tabs" id="markdown-switcher">\n  <li role="presentation" class="active" data-view="md"><a href="#markdown-switcher">Preview</a></li>\n  <li role="presentation" data-view="edit"><a href="#markdown-switcher">Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-notes" class="markdown-pair project-param" rows="3" data-field="sample_notes" hidden '+n+">"+R.sample_notes+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="note-preview">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+J+"</script>\n</marked-element>",I=isNull(R.extended_funding_reach_goals)?"*No funding reach goals*":R.extended_funding_reach_goals.unescape(),w='<ul class="nav nav-tabs" id="markdown-switcher-funding">\n  <li role="presentation" class="active" data-view="md"><a href="#markdown-switcher-funding">Preview</a></li>\n  <li role="presentation" data-view="edit"><a href="#markdown-switcher-funding">Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-funding" class="markdown-pair project-param" rows="3" data-field="extended_funding_reach_goals" hidden '+n+">"+R.extended_funding_reach_goals+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="preview-funding">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+I+"</script>\n</marked-element>";try{h=JSON.parse(R.author_data),p=new Date(toInt(h.entry_date))}catch(ia){h={},p={},p.toLocaleString=function(){return"Error retrieving creation time"}}for(L="",M=R.sampling_months.split(","),N=[],A=0,G=0,E=M.length;E>G;G++)K=M[G],++A,A>1&&A===M.length?(M.length>2&&(L+=","),L+=" and "):A>1&&(L+=", "),isNumber(K)&&(N.push(K),K=dateMonthToString(K)),L+=K;for(A=0,ca="",da=R.sampling_years.split(","),ea=[],A=0,P=0,F=da.length;F>P;P++)ba=da[P],++A,isNumber(ba)&&(ea.push(toInt(ba)),A>1&&A===da.length?(ea.length>2&&(ca+=","),ca+=" and "):A>1&&(ca+=", "),ca+=ba);ca=1===da.length?"the year "+ca:"the years "+ca,da=ea,toInt(R.sampled_collection_start)>0?(q=new Date(toInt(R.sampled_collection_start)),r=new Date(toInt(R.sampled_collection_end)),m=dateMonthToString(q.getMonth())+" "+q.getFullYear()+" &#8212; "+dateMonthToString(r.getMonth())+" "+r.getFullYear()):m="<em>(no data)</em>",(0===M.length||isNull(L))&&(L="<em>(no data)</em>"),(0===da.length||isNull(ca))&&(ca="<em>(no data)</em>"),z='<h2 class="clearfix newtitle col-xs-12">Managing '+R.project_title+" "+B+' <paper-icon-button icon="icons:visibility" class="click" data-href="'+uri.urlString+"/project.php?id="+e+'" data-toggle="tooltip" title="View in Project Viewer" data-newtab="true"></paper-icon-button><br/><small>Project #'+e+"</small></h2>\n"+S+'\n<section id="manage-users" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Collaborators" elevation="2">\n    <div class="card-content">\n      <table class="table table-striped table-condensed table-responsive table-hover clearfix" id="permissions-table">\n        <thead>\n          <tr>\n            <td colspan="5">User</td>\n            <td>Permissions</td>\n          </tr>\n        </thead>\n        <tbody>\n          '+aa+'\n        </tbody>\n      </table>\n    </div>\n    <div class="card-actions">\n      <paper-button class="manage-users" id="manage-users">Manage Users</paper-button>\n    </div>\n  </paper-card>\n</section>\n<section id="project-basics" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Basics</h3>\n  <paper-input readonly label="Project Identifier" value="'+R.project_id+'" id="project_id" class="project-param"></paper-input>\n  <paper-input readonly label="Project Creation" value="'+p.toLocaleString()+'" id="project_creation" class="author-param" data-key="entry_date" data-value="'+h.entry_date+'"></paper-input>\n  <paper-input readonly label="Project ARK" value="'+R.project_obj_id+'" id="project_creation" class="project-param"></paper-input>\n  <paper-input '+n+' class="project-param" label="Project Title" value="'+R.project_title+'" id="project-title" data-field="project_title"></paper-input>\n  <paper-input '+n+' class="project-param" label="Primary Pathogen" value="'+R.disease+'" data-field="disease"></paper-input>\n  <paper-input '+n+' class="project-param" label="PI Lab" value="'+R.pi_lab+'" id="project-title" data-field="pi_lab"></paper-input>\n  <paper-input '+n+' class="project-param" label="Project Reference" value="'+R.reference_id+'" id="project-reference" data-field="reference_id"></paper-input>\n  <paper-input '+n+' class="project-param" label="Publication DOI" value="'+R.publication+'" id="doi" data-field="publication"></paper-input>\n  <paper-input '+n+' class="author-param" data-key="name" label="Project Contact" value="'+h.name+'" id="project-contact"></paper-input>\n  <gold-email-input '+n+' class="author-param" data-key="contact_email" label="Contact Email" value="'+h.contact_email+'" id="contact-email"></gold-email-input>\n  <paper-input '+n+' class="author-param" data-key="diagnostic_lab" label="Diagnostic Lab" value="'+h.diagnostic_lab+'" id="project-lab"></paper-input>\n  <paper-input '+n+' class="author-param" data-key="affiliation" label="Affiliation" value="'+h.affiliation+'" id="project-affiliation"></paper-input>\n</section>\n<section id="notes" class="col-xs-12 col-md-8 clearfix">\n  '+O+'\n</section>\n<section id="data-management" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Data" elevation="2" id="data-card">\n    <div class="card-content">\n      <div class="variable-card-content">\n      Your project does/does not have data associated with it. (Does should note overwrite, and link to cartoParsed.raw_data.filePath for current)\n      </div>\n      <div id="append-replace-data-toggle">\n        <span class="toggle-off-label iron-label">Append Data\n          <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload a dataset, append all rows as additional data"></span>\n        </span>\n        <paper-toggle-button id="replace-data-toggle" checked disabled>Replace Data</paper-toggle-button>\n        <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload data, archive current data and only have new data parsed"></span>\n      </div>\n      <p><strong>PLEASE NOTE UPLOADS ARE CURRENTLY DISABLED HERE PENDING DEBUGGING</strong></p>\n      <div id="uploader-container-section">\n      </div>\n    </div>\n  </paper-card>\n  <paper-card class="clearfix" heading="Project Status" elevation="2" id="save-card">\n    <div class="card-content">\n      <p>Notice if there\'s unsaved data or not. Buttons below should dynamically disable/enable based on appropriate state.</p>\n    </div>\n    <div class="card-actions">\n      <paper-button id="save-project"><iron-icon icon="icons:save" class="material-green"></iron-icon> Save Project</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="discard-changes-exit"><iron-icon icon="icons:undo"></iron-icon> Discard Changes &amp; Exit</paper-button>\n    </div>\n    '+s+'\n  </paper-card>\n</section>\n<section id="project-data" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Data Overview</h3>\n    <h4>Project Studies:</h4>\n      <paper-checkbox '+g+">Anura</paper-checkbox>\n      <paper-checkbox "+k+">Caudata</paper-checkbox>\n      <paper-checkbox "+y+'>Gymnophiona</paper-checkbox>\n      <paper-input readonly label="Sampled Species" value="'+R.sampled_species.split(",").sort().join(", ")+'"></paper-input>\n      <paper-input readonly label="Sampled Clades" value="'+R.sampled_clades.split(",").sort().join(", ")+'"></paper-input>\n      <p class="text-muted">\n        <span class="glyphicon glyphicon-info-sign"></span> There are '+R.sampled_species.split(",").length+" species in this dataset, across "+R.sampled_clades.split(",").length+' clades\n      </p>\n    <h4>Sample Metrics</h4>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken from '+m+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken in '+L+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were sampled in '+ca+'</p>\n      <p class="text-muted"><iron-icon icon="icons:language"></iron-icon> The effective project center is at ('+roundNumberSigfig(R.lat,6)+", "+roundNumberSigfig(R.lng,6)+") with a sample radius of "+R.radius+"m and a resulting locality <strong class='locality'>"+R.locality+'</strong></p>\n      <p class="text-muted"><iron-icon icon="editor:insert-chart"></iron-icon> The dataset contains '+R.disease_positive+" positive samples ("+roundNumber(100*R.disease_positive/R.disease_samples)+"%), "+R.disease_negative+" negative samples ("+roundNumber(100*R.disease_negative/R.disease_samples)+"%), and "+R.disease_no_confidence+" inconclusive samples ("+roundNumber(100*R.disease_no_confidence/R.disease_samples)+'%)</p>\n    <h4 id="map-header">Locality &amp; Transect Data</h4>\n      <div id="carto-map-container" class="clearfix">\n      '+x+"\n      </div>\n  <h3>Project Meta Parameters</h3>\n    <h4>Project funding status</h4>\n      "+w+'\n      <div class="row">\n        <span class="pull-left" style="margin-top:1.75em;vertical-align:bottom;padding-left:15px">$</span><paper-input '+n+' class="project-param col-xs-11" label="Additional Funding Request" value="'+R.more_analysis_funding_request+'" id="more-analysis-funding" data-field="more_analysis_funding_request" type="number"></paper-input>\n      </div>\n</section>',$("#main-body").html(z),null!=(null!=(W=j.bounding_polygon)?W.paths:void 0)&&(l=new Point(R.lat,R.lng),geo.centerPoint=l,geo.mapOptions=o,createMap2([l],o,function(a){var b;return geo.mapOptions.selector=a.selector,$(a.selector).exists()?fa:(b=function(){return $("#map-header").exists()?($("#map-header").after(a.html),x=a.html):delay(250,function(){return b()})})()}),Q=j.bounding_polygon,x=null!=(X=geo.googleMapWebComponent)?X:"");try{p$("#project-notes").bindValue=R.sample_notes.unescape()}catch(fa){}try{p$("#project-funding").bindValue=R.extended_funding_reach_goals.unescape()}catch(fa){}return Y=p$("#project-notes").textarea,$(Y).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),$("#markdown-switcher li").click(function(){switch($("#markdown-switcher li").removeClass("active"),$(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),$(this).attr("data-view")){case"md":return $("#project-notes").attr("hidden","hidden");case"edit":return $("#note-preview").attr("hidden","hidden")}}),Y=p$("#project-funding").textarea,$(Y).keyup(function(){return p$("#preview-funding").markdown=$(this).val()}),$("#markdown-switcher-funding li").click(function(){switch($("#markdown-switcher-funding li").removeClass("active"),$(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),$(this).attr("data-view")){case"md":return $("#project-funding").attr("hidden","hidden");case"edit":return $("#preview-funding").attr("hidden","hidden");
}}),$("#delete-project").click(function(){var a;return a='<paper-button id="confirm-delete-project" class="materialred">\n  <iron-icon icon="icons:warning"></iron-icon> Confirm Project Deletion\n</paper-button>',$(this).replaceWith(a),$("#confirm-delete-project").click(function(){var a;return startLoad(),a=this,d="perform=delete&id="+R.id,$.post(adminParams.apiTarget,d,"json").done(function(b){return b.status===!0?(stopLoad(),toastStatusMessage("Successfully deleted Project #"+R.project_id),delay(1e3,function(){return populateAdminActions()})):(stopLoadError(b.human_error),$(a).remove())}).error(function(a,b){return console.error("Server error",a,b),stopLoadError("Error deleting project")}),!1}),!1}),$("#save-project").click(function(){var a;return $("#confirm-delete-project").exists()&&(a='<paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>',$("#confirm-delete-project").replaceWith(a)),saveEditorData(!0),!1}),$("#discard-changes-exit").click(function(){return c(),!1}),Z=$("#data-management").offset().top,f={top:Z,bottom:0,target:window},$("#manage-users").click(function(){return popManageUserAccess(_adp.projectData)}),$(".danger-toggle").on("iron-change",function(){return $(this).get(0).checked?$(this).find("iron-icon").addClass("material-red"):$(this).find("iron-icon").removeClass("material-red")}),console.info("Getting carto data with id "+R.carto_id+" and options",o),getProjectCartoData(R.carto_id,o)}catch(v){return t=v,stopLoadError("There was an error loading your project"),console.error("Unhandled exception loading project! "+t.message),console.warn(t.stack),loadEditor(),!1}}).error(function(a,b){return stopLoadError("We couldn't load your project. Please try again."),loadEditor()})}),!1},null==a?(c=function(){var a,c,d;return d=uri.urlString+"admin-page.html#action:show-editable",c={"do":"action",prop:"show-editable"},history.pushState(c,"Viewing Editable Projects",d),startLoad(),a="perform=list",$.get(adminParams.apiTarget,a,"json").done(function(a){var c,d,e,f,g,h,i,j,k,l,m;e='<h2 class="new-title col-xs-12">Editable Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(e),j=[],k=a.public_projects;for(g in k)h=k[g],j.push(h);d=[],l=a.authored_projects;for(g in l)h=l[g],d.push(h);m=a.projects;for(h in m)i=m[h],c=indexOf.call(j,h)>=0?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',f=indexOf.call(d,h)>=0?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author"></iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator"></iron-icon>',indexOf.call(d,h)>=0&&(e='<li>\n  <button class="btn btn-primary" data-project="'+h+'">\n    '+c+" "+i+" / #"+h.substring(0,8)+"\n  </button>\n  "+f+"\n</li>",$("#project-list").append(e));return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),b(a)}),stopLoad()}).error(function(a,b){return stopLoadError("There was a problem loading viable projects")})})():b(a),!1},popManageUserAccess=function(a,b){return null==a&&(a=_adp.projectData),null==b&&(b=_adp.fetchResult),verifyLoginCredentials(function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(q="",n=a.access_data.total,l=0,m=n.length;m>l;l++)user=n[l],p=a.access_data.composite[user].user_id,o=user+" <span class='set-permission-block' data-user='"+p+"'>",i=user===a.access_data.author,j=indexOf.call(a.access_data.editors_list,user)>=0,k=!j,h=j||i?"disabled":"data-toggle='tooltip' title='Make Editor'",r=k||i?"disabled":"data-toggle='tooltip' title='Make Read-Only'",d=i?"disabled":"data-toggle='tooltip' title='Grant Ownership'",f=i?"author":j?"edit":"read",e="data-current='"+f+"'",o+='<paper-icon-button icon="image:edit" '+h+' class="set-permission" data-permission="edit" data-user="'+p+'" '+e+'> </paper-icon-button>\n<paper-icon-button icon="icons:visibility" '+r+' class="set-permission" data-permission="read" data-user="'+p+'" '+e+"> </paper-icon-button>",b.user.is_author&&(o+='<paper-icon-button icon="social:person" '+d+' class="set-permission" data-permission="author" data-user="'+p+'" '+e+"> </paper-icon-button>"),b.user.has_edit_permissions&&user!==i&&user!==b.user&&(o+='<paper-icon-button icon="icons:delete" class="set-permission" data-permission="delete" data-user="'+p+'" '+e+">\n</paper-icon-button>"),q+="<li>"+o+"</span></li>";return q='<ul class="simple-list">\n  '+q+"\n</ul>",1===a.access_data.total.length&&(q+='<div id="single-user-warning">\n  <iron-icon icon="icons:warning"></iron-icon> <strong>Head\'s-up</strong>: You can\'t change permissions when a project only has one user. Consider adding another user first.\n</div>'),g='<paper-dialog modal id="user-setter-dialog">\n  <h2>Manage "'+a.project_title+'" users</h2>\n  <paper-dialog-scrollable>\n    '+q+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button class="add-user" dialog-confirm><iron-icon icon="social:group-add"></iron-icon> Add Users</paper-button>\n    <paper-button class="close-dialog" dialog-dismiss>Done</paper-button>\n  </div>\n</paper-dialog>',$("#user-setter-dialog").remove(),$("body").append(g),userEmail=user,$(".set-permission").unbind().click(function(){var a,b,c,d,e,f,g;if(user=$(this).attr("data-user"),f=$(this).attr("data-permission"),c=$(this).attr("data-current"),d=this,"delete"!==f)g={changes:{0:{newRole:f,currentRole:c,uid:user}}};else{try{b=$(this).attr("data-confirm").toBool()}catch(h){b=!1}if(!b)return $(this).addClass("extreme-danger").attr("data-confirm","true"),!1;g={"delete":{0:{currentRole:c,uid:user}}}}return startLoad(),e=jsonTo64(g),a="perform=editaccess&project="+window.projectParams.pid+"&deltas="+e,console.log("Would push args to",""+uri.urlString+adminParams.apiTarget+"?"+a),$.post(""+uri.urlString+adminParams.apiTarget,a,"json").done(function(a){var b,d,e,g,h,i,j,k,l;if(console.log("Server permissions alter said",a),a.status!==!0)return b=null!=(g=null!=(h=a.human_error)?h:a.error)?g:"We couldn't update user permissions",stopLoadError(b),!1;if("delete"!==f)$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+f+"']").attr("disabled","disabled").attr("data-current",f),$(".set-permission-block[data-user='"+user+"'] paper-icon-button:not([data-permission='"+f+"'])").removeAttr("disabled"),k=$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+f+"']").attr("icon"),$(".user-permission-list-row[data-user='"+{user:user}+"'] .user-current-permission iron-icon").attr("icon",k),toastStatusMessage(user+" granted "+f+" permissions");else{$(".set-permission-block[data-user='"+user+"']").parent().remove(),$(".user-permission-list-row[data-user='"+{user:user}+"']").remove(),toastStatusMessage("Removed "+user+" from project #"+window.projectParams.pid),e="read"===c?"viewers":"editors",delete _adp.projectData.access_data.composite[userEmail],i=_adp.projectData.access_data[e+"_list"];for(d in i){l=i[d];try{if("object"!=typeof l)continue;l.user_id===user&&delete _adp.projectData.access_data[e+"_list"][d]}catch(m){}}j=_adp.projectData.access_data[e];for(d in j){l=j[d];try{if("object"!=typeof l)continue;l.user_id===user&&delete _adp.projectData.access_data[e][d]}catch(m){}}}return _adp.projectData.access_data.raw=a.new_access_saved,stopLoad()}).error(function(a,b){return console.error("Server error",a,b),stopLoadError("Problem changing permissions")}),!1}),$(".add-user").unbind().click(function(){return showAddUserDialog(a.access_data.total),!1}),safariDialogHelper("#user-setter-dialog"),!1})},showAddUserDialog=function(a){var b;return b='<paper-dialog modal id="add-new-user">\n<h2>Add New User To Project</h2>\n<paper-dialog-scrollable>\n  <p>Search by email, real name, or username below. Click on a search result to queue a user for adding.</p>\n  <div class="form-horizontal" id="search-user-form-container">\n    <div class="form-group">\n      <label for="search-user" class="sr-only form-label">Search User</label>\n      <input type="text" id="search-user" name="search-user" class="form-control"/>\n    </div>\n    <paper-material id="user-search-result-container" class="pop-result" hidden>\n      <div class="result-list">\n      </div>\n    </paper-material>\n  </div>\n  <p>Adding users:</p>\n  <ul class="simple-list" id="user-add-queue">\n    <!--\n      <li class="list-add-users" data-uid="789">\n        jsmith@sample.com\n      </li>\n    -->\n  </ul>\n</paper-dialog-scrollable>\n<div class="buttons">\n  <paper-button id="add-user"><iron-icon icon="social:person-add"></iron-icon> Save Additions</paper-button>\n  <paper-button dialog-dismiss>Cancel</paper-button>\n</div>\n</paper-dialog>',$("#add-new-user").exists()||$("body").append(b),safariDialogHelper("#add-new-user"),$("#search-user").keyup(function(){var b;return console.log("Should search",$(this).val()),b=function(){var b;return b=$("#search-user").val(),isNull(b)?$("#user-search-result-container").prop("hidden","hidden"):$.post(uri.urlString+"/api.php","action=search_users&q="+b,"json").done(function(b){var c,d,e,f,g,h,i;if(console.info(b),i=Object.toArray(b.result),i.length>0){for($("#user-search-result-container").removeAttr("hidden"),e="",f=0,g=i.length;g>f;f++)user=i[f],null!=_adp.projectData.access_data.composite[user.email]?(h='<iron-icon icon="icons:done-all" class="materialgreen round"></iron-icon>',c='<paper-badge for="'+user.uid+'-email" icon="icons:done-all" label="Already Added"> </paper-badge>',d="noclick"):(h="",c="",d=""),e+='<div class="user-search-result '+d+'" data-uid="'+user.uid+'" id="'+user.uid+'-result">\n  <span class="email search-result-detail" id="'+user.uid+'-email">'+h+user.email+'</span>\n    |\n  <span class="name search-result-detail" id="'+user.uid+'-name">'+user.full_name+'</span>\n    |\n  <span class="user search-result-detail" id="'+user.uid+'-handle">'+user.handle+"</span></div>";return $("#user-search-result-container").html(e),$(".user-search-result:not(.noclick)").click(function(){var b,c,d,e,f,g;for(g=$(this).attr("data-uid"),console.info("Clicked on "+g),b=$(this).find(".email").text(),null==("undefined"!=typeof _adp&&null!==_adp?_adp.currentQueueUids:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.currentQueueUids=[]),f=$("#user-add-queue .list-add-users"),e=0,c=f.length;c>e;e++)user=f[e],_adp.currentQueueUids.push($(user).attr("data-uid"));return indexOf.call(a,b)<0?indexOf.call(_adp.currentQueueUids,g)<0?(d='<li class="list-add-users" data-uid="'+g+'">'+b+"</li>",$("#user-add-queue").append(d),$("#search-user").val(""),$("#user-search-result-container").prop("hidden","hidden")):(toastStatusMessage(b+" is already in the addition queue"),!1):(toastStatusMessage(b+" already has access to this project"),!1)})}return $("#user-search-result-container").prop("hidden","hidden")}).error(function(a,b){return console.error(a,b)})},b.debounce()}),$("#add-user").click(function(){var a,b,c,d,e,f,g,h;for(startLoad(),g=[],f=[],e=$("#user-add-queue .list-add-users"),c=0,d=e.length;d>c;c++)user=e[c],g.push($(user).attr("data-uid")),f.push(user);return g.length<1?(toastStatusMessage("Please add at least one user to the access list."),!1):(console.info("Saving list of "+g.length+" UIDs to "+window.projectParams.pid,g),b={add:g},h=jsonTo64(b),a="perform=editaccess&project="+window.projectParams.pid+"&deltas="+h,console.log("Would push args to",adminParams.apiTarget+"?"+a),$.post(adminParams.apiTarget,a,"json").done(function(a){var b,c,d,e,h,i,j,k,l,m,n;if(console.log("Server permissions said",a),a.status!==!0)return b=null!=(j=null!=(k=a.human_error)?k:a.error)?j:"We couldn't update user permissions",stopLoadError(b),!1;for(stopLoad(),l=1===g.length?"viewer":"viewers",toastStatusMessage("Successfully added "+g.length+" "+l+" to the project"),$("#user-add-queue").empty(),e='<iron-icon icon="icons:visibility"></iron-icon>',d=0,i=0,h=g.length;h>i;i++)m=g[i],user=f[d],++d,c='<tr class="user-permission-list-row" data-user="'+m+'">\n  <td colspan="5">'+user+'</td>\n  <td class="text-center user-current-permission">'+e+"</td>\n</tr>",$("#permissions-table").append(c),n={email:user,user_id:m,permission:"READ"},_adp.projectData.access_data.total.push(user),_adp.projectData.access_data.viewers_list.push(user),_adp.projectData.access_data.viewers.push(n),_adp.projectData.access_data.raw=a.new_access_saved,_adp.projectData.access_data.composite[user]=n;return p$("#add-new-user").close()}).error(function(a,b){return console.error("Server error",a,b)}))}),!1},getProjectCartoData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;if("object"!=typeof a)try{e=JSON.parse(deEscape(a))}catch(p){return console.error("cartoObj must be JSON string or obj, given",a),console.warn("Cleaned obj:",deEscape(a)),stopLoadError("Couldn't parse data"),!1}else e=a;g=e.table,console.info("Working with Carto data base set",e);try{o=getMapZoom(e.bounding_polygon.paths,"#transect-viewport"),console.info("Got zoom",o),$("#transect-viewport").attr("zoom",o)}catch(q){}j=getColumnObj(),k=[],i={};for(h in j)n=j[h],"id"!==h&&"the_geom"!==h&&(k.push(h),i[h.toLowerCase()]=h);return f="SELECT "+k.join(",")+", ST_asGeoJSON(the_geom) FROM "+g+";",console.info("Would ping cartodb with",f),c=encodeURIComponent(encode64(f)),d="action=fetch&sql_query="+c,$.post("api.php",d,"json").done(function(c){var d,f,g,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;if(console.info("Carto query got result:",c),!c.status)return j=null!=(v=c.human_error)?v:c.error,null==j&&(j="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+j+")"),!1;D=c.parsed_responses[0].rows,_adp.cartoRows={};for(l in D){C=D[l],_adp.cartoRows[l]={};for(h in C)H=C[h],u=i[h],_adp.cartoRows[l][u]=H}G=-13;try{I=geo.googleMapWebComponent.slice(0,G)}catch(J){I="<google-map>"}t=[];for(n in D)C=D[n],k=JSON.parse(C.st_asgeojson),o=k.coordinates[0],p=k.coordinates[1],s=new Point(o,p),s.infoWindow={},s.data=C,C.diseasedetected=function(){switch((""+C.diseasedetected).toLowerCase()){case"true":return"positive";case"false":return"negative";default:return""+C.diseasedetected}}(),E=C.genus+" "+C.specificepithet,r="",E!==C.originaltaxa&&(console.warn(E+" was changed from "+C.originaltaxa),r="(<em>"+C.originaltaxa+"</em>)"),m="<p>\n  <em>"+C.genus+" "+C.specificepithet+"</em> "+r+"\n  <br/>\n  Tested <strong>"+C.diseasedetected+"</strong> for "+C.diseasetested+"\n</p>",s.infoWindow.html=m,q='<google-map-marker latitude="'+o+'" longitude="'+p+'" data-disease-detected="'+C.diseasedetected+'">\n'+m+"\n</google-map-marker>",I+=q,t.push(s);if(null==(null!=e&&null!=(w=e.bounding_polygon)?w.paths:void 0)||null==(null!=e&&null!=(x=e.bounding_polygon)?x.fillColor:void 0))try{_adp.canonicalHull=createConvexHull(t,!0);try{a={},null==e&&(e={}),null==e.bounding_polygon&&(e.bounding_polygon={}),e.bounding_polygon.paths=_adp.canonicalHull.hull,null==(d=e.bounding_polygon).fillOpacity&&(d.fillOpacity=defaultFillOpacity),null==(f=e.bounding_polygon).fillColor&&(f.fillColor=defaultFillColor),_adp.projectData.carto_id=JSON.stringify(e),bsAlert("We've updated some of your data automatically. Please save the project before continuing.","warning")}catch(K){}}catch(K){}return F=null!=(y=c.parsed_responses[0].total_rows)?y:0,t.length>0||(null!=b&&null!=(z=b.boundingBox)?z.length:void 0)>0?(b.skipHull=!1,0===t.length&&(g=null!=(A=null!=(B=geo.centerPoint)?B:[b.boundingBox[0].lat,b.boundingBox[0].lng])?A:[window.locationData.lat,window.locationData.lng],t.push(g)),b.onClickCallback=function(){return console.log("No callback for data-provided maps.")},createMap2(t,b,function(a){var b;return b='<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+F+"</span> sample points in this dataset</p>",$(a.selector).after,stopLoad()})):(console.info("Classic render.",b,t.length),I+='</google-map>\n<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+F+"</span> sample points in this dataset</p>",$("#transect-viewport").replaceWith(I),stopLoad())}).fail(function(a,b){return console.error("Couldn't talk to back end server to ping carto!"),stopLoadError("There was a problem communicating with the server. Please try again in a bit. (E-002)")}),window.dataFileparams=e.raw_data,e.raw_data.hasDataFile?(l=e.raw_data.filePath,-1===l.search(helperDir)&&(l=""+helperDir+l),m='<p>\n  Your project already has data associated with it. <span id="last-modified-file"></span>\n</p>\n<button id="download-project-file" class="btn btn-primary center-block click download-file" data-href="'+l+'"><iron-icon icon="icons:cloud-download"></iron-icon> Download File</button>\n<p>You can upload more data below, or replace this existing data.</p>',$("#data-card .card-content .variable-card-content").html(m),d="do=get_last_mod&file="+l,console.info("Timestamp: ",uri.urlString+"meta.php?"+d),$.get("meta.php",d,"json").done(function(a){var b,c,d,e;return d=1e3*toInt(a.last_mod),console.log("Last modded",d,a),isNumber(d)?(c=new Date(d),b=c.toISOString(),e=""+b.slice(0,b.search("T")),$("#last-modified-file").text("Last uploaded on "+e+"."),bindClicks()):console.warn("Didn't get a number back to check last mod time for "+l),!1}).fail(function(a,b){return console.warn("Couldn't get last mod time for "+l),!1})):($("#data-card .card-content .variable-card-content").html("<p>You can upload data to your project here:</p>"),$("#append-replace-data-toggle").attr("hidden","hidden")),startEditorUploader(),!1},startEditorUploader=function(){var a;return $("link[href='components/neon-animation/animations/fade-out-animation.html']").exists()||(a='<link rel="import" href="components/neon-animation/animations/fade-in-animation.html" />\n<link rel="import" href="components/neon-animation/animations/fade-out-animation.html" />',$("head").append(a)),bootstrapUploader("data-card-uploader","",function(){return window.dropperParams.postUploadHandler=function(a,b){var c,d,e,f,g,h,i,j,k,l;if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof b)return console.error("Dropzone returned an error - "+b),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(b.status!==!0)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(""+b.human_error),console.error("Error uploading!",b),!1;try{switch(c='  <paper-dialog modal id="upload-progress-dialog"\n    entry-animation="fade-in-animation"\n    exit-animation="fade-out-animation">\n    <h2>Upload Progress</h2>\n    <paper-dialog-scrollable>\n      <div id="upload-progress-container" style="min-width:80vw; ">\n        '+renderValidateProgress(null,!0)+'\n      </div>\n<p class="col-xs-12">Species in dataset</p>\n<iron-autogrow-textarea id="species-list" class="project-field  col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    </paper-dialog-scrollable>\n    <div class="buttons">\n      <paper-button id="close-overlay">Close</paper-button>\n    </div>\n  </paper-dialog>',$("#upload-progress-dialog").remove(),$("body").append(c),p$("#upload-progress-dialog").open(),$("#close-overlay").click(function(){return p$("#upload-progress-dialog").close()}),console.info("Server returned the following result:",b),console.info("The script returned the following file information:",a),j="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",f=b.full_path.split("/").pop(),l=b.wrote_thumb,i=b.mime_provided.split("/")[0],h=b.mime_provided.split("/")[1],g=a.size<5242880||"image"!==i?""+j+b.wrote_file:""+j+l,k=function(){switch(i){case"image":return'<div class="uploaded-media center-block" data-system-file="'+f+'">\n  <img src="'+g+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+a.name+" -> "+f+'\n  (<a href="'+g+'" class="newwindow" download="'+a.name+'">\n    Original Image\n  </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+f+'">\n  <audio src="'+g+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+a.name+" -> "+f+'\n    (<a href="'+g+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+f+'">\n  <video src="'+g+'" controls preload="auto">\n    <img src="'+j+l+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+a.name+" -> "+f+'\n    (<a href="'+g+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+f+'" data-link-path="'+g+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+a.name+" -> "+f+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(k),$("#validator-progress-container").remove(),i){case"application":switch(console.info("Checking "+h+" in application"),h){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":excelHandler2(g);break;case"zip":case"x-zip-compressed":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===a.type||"xlsx"===g.split(".").pop()?excelHandler2(g):zipHandler(g);break;case"x-7z-compressed":_7zHandler(g),p$("#upload-progress-dialog").close()}break;case"text":csvHandler(),p$("#upload-progress-dialog").close();break;case"image":imageHandler(),p$("#upload-progress-dialog").close()}}catch(e){d=e,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}return!1}}),!1},excelHandler2=function(a,b,c){var d,e,f;return null==b&&(b=!0),startLoad(),$("#validator-progress-container").remove(),renderValidateProgress("#upload-progress-container"),f=helperDir+"excelHelper.php",e=a,-1!==a.search(helperDir)&&(console.info("removing '"+helperDir+"'"),e=a.slice(helperDir.length)),console.info("Pinging for "+e),d="action=parse&path="+e+"&sheets=Samples",$.get(f,d,"json").done(function(b){var d,f;return console.info("Got result",b),b.status===!1?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):($("#upload-data").attr("disabled","disabled"),d=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=d.pop(),dataFileParams.filePath=e,f=Object.size(b.data),uploadedData=b.data,_adp.parsedUploadedData=b.data,"function"!=typeof c?revalidateAndUpdateData(b):(console.warn("Skipping Revalidator() !"),c(b)),stopLoad())}).fail(function(a,b){return console.error("Couldn't POST"),console.warn(a,b),stopLoadError()}),!1},revalidateAndUpdateData=function(a){var b,c,d,e,f,g,h;return null==a&&(a=!1),b=JSON.parse(_adp.projectData.carto_id.unescape()),h=!1,a!==!1?"object"==typeof a?(h=!0,d=a.data,e=a.path.requested_path):e=a:e=null!=(null!=dataFileParams?dataFileParams.filePath:void 0)?dataFileParams.filePath:b.raw_data.filePath,_adp.projectIdentifierString=b.table.split("_")[0],_adp.projectId=_adp.projectData.project_id,null==(null!=(f=_adp.fims)&&null!=(g=f.expedition)?g.expeditionId:void 0)&&(_adp.fims={expedition:{expeditionId:26,ark:_adp.projectData.project_obj_id}}),c=function(a){return newGeoDataHandler(a,function(c,d){var e,f,g,h,i,j,k;return console.info("Ready to update",c),g=b.table,a=c.data,"object"!=typeof a?(console.info("This function requires the base data to be a JSON object."),toastStatusMessage("Your data is malformed. Please double check your data and try again."),!1):(e=["edit","insert","delete","create"],j="edit",indexOf.call(e,j)<0?(console.error(j+" is not an allowed operation on a data set!"),console.info("Allowed operations are ",e),toastStatusMessage("Sorry, '"+j+"' isn't an allowed operation."),!1):isNull(g)?(console.error("Must use a defined table name!"),toastStatusMessage("You must name your data table"),!1):(i=$.cookie(uri.domain+"_link"),h=$.cookie(uri.domain+"_auth"),k=$.cookie(uri.domain+"_secret"),null==i||null==h||null==k?(console.error("You're not logged in. Got one or more invalid tokens for secrets.",i,h,k),toastStatusMessage("Sorry, you're not logged in. Please log in and try again."),!1):(f="hash="+h+"&secret="+k+"&dblink="+i,null==("undefined"!=typeof adminParams&&null!==adminParams?adminParams.apiTarget:void 0)?(console.warn("Administration file not loaded. Upload cannot continue"),stopLoadError("Administration file not loaded. Upload cannot continue"),!1):$.post(adminParams.apiTarget,f,"json").done(function(d){var e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba;if(d.status){console.info("Validated data",c),U=[],D=[],I=[];for(L in a){T=a[L],G=[];for(l in T)switch(_=T[l],l){case"decimalLongitude":G[1]=_,I.push(_);break;case"decimalLatitude":G[0]=_,D.push(_)}U.push(G)}h=null!=(M=D.max())?M:0,i=null!=(N=D.min())?N:0,f=null!=(O=I.max())?O:0,j=null!=(P=I.min())?P:0,r=[[h,j],[h,f],[i,f],[i,j]];try{for(Z="string"==typeof a.transectRing?JSON.parse(c.transectRing):c.transectRing,Z=Object.toArray(Z),z=0,B=0,E=Z.length;E>B;B++){if(p=Z[B],p instanceof Point&&(p=p.toGeoJson(),Z[z]=p),2!==p.length)throw{message:"Bad coordinate length for '"+p+"'"};for(K=0,F=p.length;F>K;K++)if(o=p[K],!isNumber(o))throw{message:"Bad coordinate number '"+o+"'"};++z}}catch(u){s=u,console.warn("Error parsing the user transect ring - "+s.message),Z=void 0}X=null!=Z?Z:r,w={type:"GeometryCollection",geometries:[{type:"MultiPoint",coordinates:U},{type:"Polygon",coordinates:X}]},q="ST_AsBinary("+JSON.stringify(w)+", 4326)",m=getColumnObj();try{J={},Q=_adp.cartoRows;for(z in Q)T=Q[z],v=T.fieldNumber,Y=v.trim(),Y=Y.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2"),v=Y,J[v]=z}catch(ca){console.warn("Couldn't make lookupMap")}V="",ba=[],n=[],n.push("id int");for(z in a){T=a[z],z=toInt(z),aa=[],C=0,H=0,e=0,t=0,x={type:"Point",coordinates:[]},A=z+1,v=T.fieldNumber,S=J[v],R=null,null!=S&&(R=_adp.cartoRows[S]),k=[];for(l in T){_=T[l],k.push(l),0===z&&n.push(l+" "+m[l]);try{_=_.replace("'","&#95;")}catch(da){}switch(l){case"decimalLongitude":x.coordinates[1]=_;break;case"decimalLatitude":x.coordinates[0]=_;break;case"fieldNumber":continue}null!=R&&R[l]===_||("string"==typeof _?null!=R?aa.push("`"+l+"`='"+_+"'"):aa.push("'"+_+"'"):isNull(_)?null!=R?aa.push("`"+l+"`=null"):aa.push("null"):null!=R?aa.push("`"+l+"`="+_):aa.push(_))}y="ST_SetSRID(ST_Point("+x.coordinates[0]+","+x.coordinates[1]+"),4326)",aa.push(y),null!=R?(W=" WHERE `fieldNumber`='"+v+"';",V+="UPDATE "+g+" SET "+aa.join(", ")+" "+W):V+="INSERT INTO "+g+" ("+k.join(",")+") VALUES ("+aa.join(",")+"); "}return console.log(V),geo.postToCarto(V,g,function(a,d,e){var f;console.info("Post carto callback fn");try{p$("#taxa-validation").value=0,p$("#taxa-validation").indeterminate=!0}catch(g){}return _adp.canonicalHull=createConvexHull(d,!0),b.bounding_polygon.paths=_adp.canonicalHull.hull,_adp.projectData.carto_id=JSON.stringify(b),f={data:_adp.cartoRows},validateTaxonData(f,function(a){var b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,t,u,v,w,x,y,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,U,V,W,X;for(c.validated_taxa=a.validated_taxa,_adp.projectData.includes_anura=!1,_adp.projectData.includes_caudata=!1,_adp.projectData.includes_gymnophiona=!1,J=c.validated_taxa,A=0,r=J.length;r>A&&(S=J[A],d=S.response.validated_taxon,console.info("Aweb taxon result:",d),f=d.order.toLowerCase(),q="includes_"+f,_adp.projectData[q]=!0,null!=_adp.projectData.includes_anura==!1||null!=_adp.projectData.includes_caudata==!1||null!=_adp.projectData.includes_gymnophiona==!1);A++);for(R="",Q=[],g=[],z=0,K=c.validated_taxa,C=0,t=K.length;t>C;C++){P=K[C],U=P.genus+" "+P.species,null!=P.response.original_taxon&&(console.info("Taxon obj",P),B=""+P.response.original_taxon.slice(0,1).toUpperCase()+P.response.original_taxon.slice(1),y='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+B+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+U+"</em>' below. <a href=\""+P.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(y)),isNull(P.subspecies)||(U+=" "+P.subspecies),z>0&&(R+="\n"),R+=""+U,Q.push(U);try{L=P.response.validated_taxon.family,indexOf.call(g,L)<0&&g.push(P.response.validated_taxon.family)}catch(l){s=l,console.warn("Couldn't get the family! "+s.message,P.response),console.warn(s.stack)}++z}try{p$("#species-list").bindValue=R}catch(Y){}for(dataAttrs.dataObj=c,_adp.data.dataObj=c,_adp.data.taxa={},_adp.data.taxa.list=Q,_adp.data.taxa.clades=g,_adp.data.taxa.validated=c.validated_taxa,_adp.projectData.disease_morbidity=c.samples.morbidity,_adp.projectData.disease_mortality=c.samples.mortality,_adp.projectData.disease_positive=c.samples.positive,_adp.projectData.disease_negative=c.samples.negative,_adp.projectData.disease_no_confidence=c.samples.no_confidence,i=[],x=[],X=[],w=[],e=[],n=[],j=[],O=[],E=Object.toArray(_adp.cartoRows),D=0,u=E.length;u>D;D++)T=E[D],h=null!=(F=T.dateCollected)?F:T.dateIdentified,W=excelDateToUnixTime(h),i.push(W),V=new Date(W),v=dateMonthToString(V.getUTCMonth()),indexOf.call(x,v)<0&&x.push(v),G=V.getFullYear(),indexOf.call(X,G)<0&&X.push(V.getFullYear()),null!=T.catalogNumber&&e.push(T.catalogNumber),n.push(T.fieldNumber),M=T.decimalLatitude,N=T.decimalLongitude,k=geo.distance(M,N,center.lat,center.lng),k>m&&(m=k),null!=T.sampleType&&(H=T.sampleType,indexOf.call(O,H)<0&&O.push(T.sampleType)),null!=T.specimenDisposition&&(I=T.specimenDisposition,indexOf.call(j,I)<0&&j.push(T.sampleDisposition));return console.info("Got date ranges",i),x.sort(),X.sort(),_adp.projectData.sampled_collection_start=i.min(),_adp.projectData.sampled_collection_end=i.max(),console.info("Collected from",i.min(),i.max()),_adp.projectData.sampling_months=x.join(","),_adp.projectData.sampling_years=X.join(","),_adp.projectData.sample_catalog_numbers=e.join(","),_adp.projectData.sample_field_numbers=n.join(","),_adp.projectData.sample_methods_used=O.join(","),o=function(){return saveEditorData(!0,function(){return null==localStorage._adp?document.location.reload(!0):Y}),!1},p=""+uri.urlString+c.dataSrc,p!==_adp.projectData.sample_raw_data?(b=_adp.projectData.dataset_arks.split(","),mintBcid(_adp.projectId,p,_adp.projectData.project_title,function(a){var c,d,e;return null!=a.ark?(d=p.split("/"),c=d.pop(),e=a.ark+"::"+c,b.push(e),_adp.projectData.datset_arks=b.join(",")):console.warn("Couldn't mint!"),o()})):o(),!1}),!1}),!1}return stopLoadError("Error updating Carto")}).error(function(a,b){return stopLoadError("Error updating Carto")}))))}),!1},h?c(d):excelHandler2(e,!0,function(a){var b;return b=a.data,c(b)}),!1},saveEditorData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;if(null==a&&(a=!1),startLoad(),$(".hanging-alert").remove(),a||null==localStorage._adp){k=_adp.projectData;try{k.access_data=_adp.projectData.access_data.raw}catch(o){}for(l=$(".project-param:not([readonly])"),g=0,h=l.length;h>g;g++)e=l[g],f=$(e).attr("data-field"),isNull(f)||(k[f]=p$(e).value);for(d={},m=$(".author-param"),j=0,i=m.length;i>j;j++)e=m[j],f=$(e).attr("data-key"),d[f]=null!=(n=$(e).attr("data-value"))?n:p$(e).value;k.author_data=JSON.stringify(d),_adp.postedSaveData=k,_adp.postedSaveTimestamp=Date.now()}else k=localStorage._adp.postedSaveData,
window._adp=localStorage._adp;return console.log("Sending to server",k),c="perform=save&data="+jsonTo64(k),$.post(""+uri.urlString+adminParams.apiTarget,c,"json").done(function(a){var b,c,d;return console.info("Save result: server said",a),a.status!==!0?(b=null!=(c=null!=(d=a.human_error)?d:a.error)?c:"There was an error saving to the server",stopLoadError("There was an error saving to the server"),localStorage._adp=_adp,bsAlert("<strong>Save Error:</strong> "+b+". An offline backup has been made.","danger"),console.error(a.error),!1):(stopLoad(),toastStatusMessage("Save successful"),_adp.projectData=a.project,delete localStorage._adp)}).error(function(a,b){return stopLoadError("Sorry, there was an error communicating with the server"),localStorage._adp=_adp,bsAlert("<strong>Save Error</strong>: We had trouble communicating with the server and your data was NOT saved. Please try again in a bit. An offline backup has been made.","danger"),console.error(a,b)}).always(function(){return"function"==typeof b?b():o}),!1},$(function(){var a,b,c;return null!=(null!=(c=localStorage._adp)?c.postedSaveData:void 0)?(b=new Date(localStorage._adp.postedSaveTimestamp),a="<strong>You have offline save information</strong> &#8212; did you want to save it?\n<br/><br/>\nProject #"+localStorage._adp.postedSaveData.project_id+" on "+b.toLocaleDateString()+" at "+b.toLocaleTimeString()+'\n<br/><br/>\n<button class="btn btn-success" id="offline-save">\n  Save Now &amp; Refresh Page\n</button>',bsAlert(a,"info"),$("#offline-save").click(function(){return saveEditorData(!1,function(){return document.location.reload(!0)})})):void 0}),loadProjectBrowser=function(){var a,b,c;return c=uri.urlString+"admin-page.html#action:show-viewable",b={"do":"action",prop:"show-viewable"},history.pushState(b,"Viewing Personal Project List",c),startAdminActionHelper(),startLoad(),a="perform=list",$.get(adminParams.apiTarget,a,"json").done(function(a){var b,c,d,e,f,g,h,i;b='<h2 class="new-title col-xs-12">Available Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(b),g=[],h=a.public_projects;for(d in h)e=h[d],g.push(e);i=a.projects;for(e in i)f=i[e],c=indexOf.call(g,e)>=0?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',b='<li>\n  <button class="btn btn-primary" data-project="'+e+'" data-toggle="tooltip" title="Project #'+e.substring(0,8)+'...">\n    '+c+" "+f+"\n  </button>\n</li>",$("#project-list").append(b);return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),loadProject(a)}),stopLoad()}).error(function(a,b){return stopLoadError("There was a problem loading viable projects")}),!1},loadProject=function(a,b){return null==b&&(b=""),goTo(uri.urlString+"project.php?id="+a),!1},loadSUProjectBrowser=function(){var a,b;return b=uri.urlString+"admin-page.html#action:show-su-viewable",a={"do":"action",prop:"show-su-viewable"},history.pushState(a,"Viewing Superuser Project List",b),startAdminActionHelper(),startLoad(),verifyLoginCredentials(function(a){var b,c;return c=toInt(a.detail.userdata.su_flag),c.toBool()?(b="perform=sulist",$.get(adminParams.apiTarget,b,"json").done(function(a){var b,c,d,e,f,g,h,i;if(a.status!==!0)return b=null!=(h=a.human_error)?h:"Sorry, you can't do that right now",stopLoadError(b),console.error("Can't do SU listing!"),console.warn(a),populateAdminActions(),!1;c='<h2 class="new-title col-xs-12">All Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(c),e=[],i=a.projects;for(g in i)f=i[g],e.push(g),d=f["public"].toBool()?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',c='<li>\n  <button class="btn btn-primary" data-project="'+g+'" data-toggle="tooltip" title="Project #'+g.substring(0,8)+'...">\n    '+d+" "+f.title+"\n  </button>\n</li>",$("#project-list").append(c);return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),loadEditor(a)}),stopLoad()}).error(function(a,b){return stopLoadError("There was a problem loading projects")})):(stopLoadError("Sorry, you must be an admin to do this"),!1)}),!1},"object"!=typeof window.validationMeta&&(window.validationMeta={}),validateData=function(a,b){var c;return null==b&&(b=null),_adp.validationDataObject=a,console.info("Doing nested validation"),c=Date.now(),renderValidateProgress(),validateFimsData(a,function(){return validateTaxonData(a,function(){var d;return d=Date.now()-c,console.info("Validation took "+d+"ms",a),cleanupToasts(),toastStatusMessage("Your dataset has been successfully validated"),"function"==typeof b?b(a):(console.warn("validateData had no defined callback!"),console.info("Got back",a))})}),!1},stopLoadBarsError=function(a,b){var c,d,e,f;try{clearTimeout(a)}catch(g){}for($("#validator-progress-container paper-progress[indeterminate]").addClass("error-progress").removeAttr("indeterminate"),f=$("#validator-progress-container paper-progress:not([indeterminate])"),d=0,e=f.length;e>d;d++){c=f[d];try{p$(c).value!==p$(c).max&&($(c).addClass("error-progress"),$(c).find("#primaryProgress").css("background","#F44336"))}catch(g){}}return null!=b&&(bsAlert("<strong>Data Validation Error</strong: "+b,"danger"),stopLoadError("There was a problem validating your data")),!1},delayFimsRecheck=function(a,b){var c,d;return d=encodeURIComponent(a.responses.login_response.cookies),c="perform=validate&auth="+d,$.post(adminParams.apiTarget,c,"json").done(function(a){return console.log("Server said",a),"function"==typeof b?b():console.warn("Warning: delayed recheck had no callback")}).error(function(a,b){return console.error(b+": Couldn't check status on FIMS server!"),console.warn("Server said",a.responseText),stopLoadError("There was a problem validating your data, please try again later")}),!1},validateFimsData=function(a,b){var c,d,e,f,g,h,i,j,k;if(null==b&&(b=null),"number"!=typeof("undefined"!=typeof _adp&&null!==_adp&&null!=(f=_adp.fims)&&null!=(g=f.expedition)?g.expeditionId:void 0))return _adp.hasRunMintCallback===!0?(console.error("Couldn't run validateFimsData(); called itself back recursively. There may be a problem with the server. "),stopLoadError("Couldn't validate your data, please try again later"),_adp.hasRunMintCallback=!1,!1):(_adp.hasRunMintCallback=!1,console.warn("Haven't minted expedition yet! Minting that first"),mintExpedition(_adp.projectId,p$("#project-title").value,function(){return _adp.hasRunMintCallback=!0,validateFimsData(a,b)}),!1);console.info("FIMS Validating",a.data),$("#data-validation").removeAttr("indeterminate"),h=Object.size(a.data);try{p$("#data-validation").max=2*h}catch(l){}return j=20,k=null,(c=function(){var a;try{a=p$("#data-validation").value}catch(b){return!1}if(a>=h)return clearTimeout(k),!1;++a;try{p$("#data-validation").value=a}catch(d){return!1}return k=delay(j,function(){return c()})})(),e=jsonTo64(a.data),i=post64(a.dataSrc),d="perform=validate&datasrc="+i+"&link="+_adp.projectId,console.info("Posting ...",""+uri.urlString+adminParams.apiTarget+"?"+d),$.post(""+uri.urlString+adminParams.apiTarget,d,"json").done(function(c){var d,e,f,g,h,i,j,l,m,n,o,p,q,r,s,t,u,v;if(console.log("FIMS validate result",c),c.status!==!0)return stopLoadError("There was a problem talking to the server"),d=null!=(p=null!=(q=c.human_error)?q:c.error)?p:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.",bsAlert("<strong>Server Error:</strong> "+d,"danger"),stopLoadBarsError(k),!1;if(v=null!=(null!=(r=c.validate_status)?r.status:void 0)?c.validate_status.status:c.validate_status,"FIMS_SERVER_DOWN"===c.validate_status)toastStatusMessage("Validation server is down, proceeding ..."),bsAlert("<strong>FIMS error</strong>: The validation server is down, we're trying to finish up anyway.","warning");else if(v!==!0){if(o=!1,stopLoadError("There was a problem with your dataset"),d=null!=(s=null!=(t=null!=(u=c.validate_status.error)?u:c.human_error)?t:c.error)?s:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.",d.length>255&&(o=!0,d=d.substr(0,255)+"[...] and more."),bsAlert("<strong>FIMS reported an error validating your data:</strong> "+d,"danger"),stopLoadBarsError(k),i=c.validate_status.errors,Object.size(i)>1||o){j='<div class="error-block" id="validation-error-block">\n  <p><strong>Your dataset had errors</strong>. Here\'s a summary:</p>\n  <table class="table-responsive table-striped table-condensed table table-bordered table-hover" >\n    <thead>\n      <tr>\n        <th>Error Type</th>\n        <th>Error Message</th>\n      </tr>\n    </thhead>\n    <tbody>';for(m in i){h=i[m];for(e in h){g=h[e],f="<ul>";for(l in g)n=g[l],n=n.stripHtml(!0),/\[(?:((?:"(\w+)"((, )?))*?))\]/m.test(n)&&(n=n.replace(/"(\w+)"/gm,"<code>$1</code>")),f+="<li>"+n+"</li>";f+="</ul>",j+="<tr>\n  <td><strong>"+e.stripHtml(!0)+"</strong></td>\n  <td>"+f+"</td>\n</tr>"}}j+="    </tbody>\n  </table>\n</div>",$("#validator-progress-container").append(j),$("#validator-progress-container").get(0).scrollIntoView()}return!1}try{p$("#data-validation").value=p$("#data-validation").max,clearTimeout(k)}catch(w){}return"function"==typeof b?b(a):w}).error(function(a,b){return clearTimeout(k),console.error(b+": Couldn't upload to FIMS server!"),console.warn("Server said",a.responseText),stopLoadError("There was a problem validating your data, please try again later"),!1}),!1},mintBcid=function(a,b,c,d){var e,f,g,h,i;return null==b&&(b=null!=dataFileParams?dataFileParams.filePath:void 0),"function"!=typeof d?(console.warn("mintBcid() requires a callback function"),!1):(i={},e=null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(g=_adp.fims)&&null!=(h=g.expedition)?h.ark:void 0),f="perform=mint&link="+a+"&title="+post64(c)+"&file="+b+"&expedition="+e,$.post(adminParams.apiTarget,f,"json").done(function(a){return console.log("Got",a),a.status?i=a:(stopLoadError(a.human_error),console.error(a.error),!1)}).error(function(a,b){return i={ark:null,error:b,human_error:a.responseText,status:!1},!1}).always(function(){return console.info("mintBcid is calling back",i),d(i)}),!1)},mintExpedition=function(a,b,c){var d,e,f;return null==a&&(a=_adp.projectId),null==b&&(b=p$("#project-title").value),"function"!=typeof c?(console.warn("mintExpedition() requires a callback function"),!1):(f={},e=p$("#data-encumbrance-toggle").checked,"boolean"!=typeof e&&(e=!1),d="perform=create_expedition&link="+a+"&title="+post64(b)+"&public="+e,$.post(adminParams.apiTarget,d,"json").done(function(a){return console.log("Expedition got",a),a.status?(f=a,null==("undefined"!=typeof _adp&&null!==_adp?_adp.fims:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.fims={}),_adp.fims.expedition={permalink:a.project_permalink,ark:a.ark,expeditionId:a.fims_expedition_id,fimsRawResponse:a.responses.expedition_response}):(stopLoadError(a.human_error),console.error(a.error),!1)}).error(function(a,b){return f.ark=null,!1}).always(function(){return console.info("mintExpedition is calling back",f),c(f)}),!1)},validateTaxonData=function(a,b){var c,d,e,f,g,h,i,j,k;null==b&&(b=null),c=a.data,g=[],h={};for(e in c)f=c[e],j={genus:f.genus,species:f.specificEpithet,subspecies:f.infraspecificEpithet,clade:f.cladeSampled},g.containsObject(j)||g.push(j),i=j.genus+" "+j.species,isNull(j.subspecies)||(i+=" "+j.subspecies),null==h[i]&&(h[i]=[]),h[i].push(e);console.info("Found "+g.length+" unique taxa:",g),d=g.length>1?"taxa":"taxon",toastStatusMessage("Validating "+g.length+" unique "+d+" from "+c.length+" rows ..."),console.info("Replacement tracker",h),$("#taxa-validation").removeAttr("indeterminate");try{p$("#taxa-validation").max=g.length}catch(l){}return(k=function(c,d){return i=c[d].genus+" "+c[d].species,isNull(c[d].subspecies)||(i+=" "+c[d].subspecies),validateAWebTaxon(c[d],function(e){var g,j,l,m,n,o;if(e.invalid===!0)return cleanupToasts(),stopLoadError(e.response.human_error),console.error(e.response.error),n="<strong>Taxonomy Error</strong>: There was a taxon error in your file. "+e.response.human_error+" We stopped validation at that point. Please correct taxonomy issues and try uploading again.",bsAlert(n),removeDataFile(),stopLoadBarsError(),!1;try{for(o=h[i],console.info("Replacing rows @ "+i,o,c[d]),l=0,m=o.length;m>l;l++)f=o[l],a.data[f].genus=e.genus,a.data[f].specificEpithet=e.species,null==e.subspecies&&(e.subspecies=""),a.data[f].infraspecificEpithet=e.subspecies,a.data[f].originalTaxa=i}catch(j){g=j,console.warn("Problem replacing rows! "+g.message),console.warn(g.stack)}c[d]=e;try{p$("#taxa-validation").value=d}catch(p){}if(d++,d<c.length)return 0===modulo(d,50)&&toastStatusMessage("Validating taxa "+d+" of "+c.length+" ..."),k(c,d);try{p$("#taxa-validation").value=d}catch(p){}return a.validated_taxa=c,console.info("Calling back!",a),b(a)})})(g,0),!1},validateAWebTaxon=function(a,b){var c,d,e;return null==b&&(b=null),null==(null!=(e=window.validationMeta)?e.validatedTaxons:void 0)&&("object"!=typeof window.validationMeta&&(window.validationMeta={}),window.validationMeta.validatedTaxons=[]),d=function(a){return"function"==typeof b&&b(a),!1},window.validationMeta.validatedTaxons.containsObject(a)?(console.info("Already validated taxon, skipping revalidation",a),d(a),!1):(c="action=validate&genus="+a.genus+"&species="+a.species,null!=a.subspecies&&(c+="&subspecies="+a.subspecies),$.post("api.php",c,"json").done(function(b){return b.status?(a.genus=b.validated_taxon.genus,a.species=b.validated_taxon.species,a.subspecies=b.validated_taxon.subspecies,null==a.clade&&(a.clade=b.validated_taxon.family),window.validationMeta.validatedTaxons.push(a)):a.invalid=!0,a.response=b,d(a),!1}).error(function(b,c){var d;return d=a.genus+" "+a.species,d=null!=a.subspecies?d+" "+a.subspecies:d,bsAlert("<strong>Problem validating taxon:</strong> "+d+" couldn't be validated."),console.warn("Warning: Couldn't validated "+d+" with AmphibiaWeb")}),!1)};
//# sourceMappingURL=maps/c.map