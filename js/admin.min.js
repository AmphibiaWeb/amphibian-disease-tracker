var _7zHandler,alertBadProject,bootstrapTransect,bootstrapUploader,checkInitLoad,copyMarkdown,createOverflowMenu,csvHandler,dataAttrs,dataFileParams,delayFimsRecheck,domainHost,excelDateToUnixTime,excelHandler,excelHandler2,finalizeData,getCanonicalDataCoords,getInfoTooltip,getProjectCartoData,getTableCoordinates,getUploadIdentifier,helperDir,imageHandler,kmlHandler,kmlLoader,loadCreateNewProject,loadEditor,loadProject,loadProjectBrowser,loadSUProfileBrowser,loadSUProjectBrowser,mapAddPoints,mapOverlayPolygon,mintBcid,mintExpedition,newGeoDataHandler,pointStringToLatLng,pointStringToPoint,popManageUserAccess,populateAdminActions,recalculateAndUpdateHull,remintArk,removeDataFile,renderValidateProgress,resetForm,revalidateAndUpdateData,saveEditorData,showAddUserDialog,showUnrestrictionCriteria,singleDataFileHelper,startAdminActionHelper,startEditorUploader,stopLoadBarsError,uploadedData,user,userEmail,userFullname,validateData,validateFimsData,validateTaxonData,verifyLoginCredentials,zipHandler,indexOf=[].indexOf||function(e){for(var a=0,t=this.length;a<t;a++)if(a in this&&this[a]===e)return a;return-1},modulo=function(e,a){return(+e%(a=+a)+a)%a};try{(domainHost=uri.o.attr("host").split(".")).pop(),domainHost=domainHost.join(".").replace(/www\./g,"")}catch(e){}window.adminParams={},adminParams.domain=isNull(domainHost)?"amphibiandisease":domainHost,adminParams.apiTarget="admin-api.php",adminParams.adminPageUrl="https://"+adminParams.domain+".org/admin-page.html",adminParams.loginDir="admin/",adminParams.loginApiTarget=adminParams.loginDir+"async_login_handler.php",(dataFileParams={}).hasDataFile=!1,dataFileParams.fileName=null,dataFileParams.filePath=null,dataAttrs={},uploadedData=null,helperDir="helpers/",user=$.cookie(adminParams.domain+"_link"),userEmail=$.cookie(adminParams.domain+"_user"),userFullname=$.cookie(adminParams.domain+"_fullname"),window.loadAdminUi=function(){var o;try{o=delay(3e3,function(){return"<div class='bs-callout bs-callout-warning'>\n  <h4>Please be patient</h4>\n  <p>\n    The internet is a bit slow right now. We're still verifying your credentials.\n  </p>\n</div>",$("main #main-body").html("<div class='bs-callout bs-callout-warning'>\n  <h4>Please be patient</h4>\n  <p>\n    The internet is a bit slow right now. We're still verifying your credentials.\n  </p>\n</div>"),!1})}catch(e){}try{verifyLoginCredentials(function(e){var a,t;return clearTimeout(o),t=!0===e.unrestricted?"<iron-icon id='restriction-badge' icon='icons:verified-user' class='material-green' data-toggle='tooltip' title='Unrestricted Account'></iron-icon>":"<iron-icon id='restriction-badge' icon='icons:verified-user' class='text-muted' data-toggle='tooltip' title='Restricted Account'></iron-icon>",a="<h3>\n  Welcome, "+$.cookie(adminParams.domain+"_name")+" "+t+"\n</h3>\n<section id='admin-actions-block' class=\"row center-block text-center\">\n  <div class='bs-callout bs-callout-info'>\n    <p>Please be patient while the administrative interface loads.</p>\n  </div>\n</section>",$("main #main-body").before(a),$(".fill-user-fullname").text($.cookie(adminParams.domain+"_fullname")),$("#restriction-badge").click(function(){return showUnrestrictionCriteria()}),checkInitLoad(function(){return populateAdminActions(),bindClicks()}),!1})}catch(e){e,$("main #main-body").html("<div class='bs-callout bs-callout-danger'><h4>Application Error</h4><p>There was an error in the application. Please refresh and try again. If this persists, please contact administration.</p></div>")}return!1},populateAdminActions=function(){var e,a,t,o,n;return n=uri.urlString+"admin-page.html",o={do:"home",prop:null},history.pushState(o,"Admin Home",n),$(".hanging-alert").remove(),a='<paper-button id="new-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:add"></iron-icon>\n    Create New Project\n</paper-button>\n',t='<paper-button id="create-placeholder" class="admin-action non-action col-md-3 col-sm-4 col-xs-12" raised data-toggle="tooltip" title="Your account is restricted. Click to verify account">\n  <iron-icon icon="icons:star-border"></iron-icon>\n  Verify &amp; Create Project\n</paper-button>',e=(_adp.isUnrestricted?a:t)+'\n      <paper-button id="edit-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n        <iron-icon icon="icons:create"></iron-icon>\n          Edit Existing Project\n      </paper-button>\n      <paper-button id="view-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n        <iron-icon icon="icons:visibility"></iron-icon>\n          View All My Projects\n      </paper-button>',$("#admin-actions-block").html(e),$("#show-actions").remove(),$("main #main-body").empty(),$("#new-project").click(function(){return loadCreateNewProject()}),$("#edit-project").click(function(){return loadEditor()}),$("#view-project").click(function(){return loadProjectBrowser()}),$("#create-placeholder").click(function(){return showUnrestrictionCriteria()}),verifyLoginCredentials(function(e){if(toInt(e.detail.userdata.su_flag).toBool()){console.info("NOTICE: This is an SUPERUSER Admin"),'<paper-button id="su-view-projects" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:add"></iron-icon>\n  (SU) Administrate All Projects\n</paper-button>\n<paper-button id="su-manage-users" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:create"></iron-icon>\n  (SU) Manage All Users\n</paper-button>',$("#admin-actions-block").append('<paper-button id="su-view-projects" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:add"></iron-icon>\n  (SU) Administrate All Projects\n</paper-button>\n<paper-button id="su-manage-users" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:create"></iron-icon>\n  (SU) Manage All Users\n</paper-button>');try{delay(500,function(){return setupDebugContext()})}catch(e){}$("#su-view-projects").click(function(){return loadSUProjectBrowser()}),$("#su-manage-users").click(function(){return loadSUProfileBrowser()})}return _adp.isUnrestricted=e.unrestricted,!0!==e.unrestricted&&($("#new-project").remove(),$("#create-placeholder").exists()||$("#edit-project").before(t),$("#create-placeholder").unbind().click(function(){return showUnrestrictionCriteria()})),!0!==e.unrestricted||$("#new-project").exists()||($("#create-placeholder").remove(),$("#new-project").exists()||$("#edit-project").before(a),$("#new-project").unbind().click(function(){return loadCreateNewProject()})),!1}),!1};try{(createOverflowMenu=function(){return checkLoggedIn(function(e){var a,t;return t='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+(a=e.status?'    <paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"")+'\n    <paper-item data-href="https://amphibiandisease.org/dashboard.php" class="click">\n      <iron-icon icon="icons:donut-small"></iron-icon>\n      Data Dashboard\n    </paper-item>\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About / Legal\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(t),isNull(a)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1})()}catch(e){}showUnrestrictionCriteria=function(){return startLoad(),verifyLoginCredentials(function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y,w,_;return stopLoad(),m=e.unrestricted.toBool(),d=e.has_alternate.toBool(),w=e.detail.userdata.email_verified.toBool(),l=e.email_allowed.toBool(),d?(y=e.detail.userdata.alternate_email_verified.toBool(),c=(n=e.alternate_allowed.toBool())||l):c=l,h=toInt(e.detail.userdata.su_flag),f=toInt(e.detail.userdata.admin_flag),p=h.toBool()||f.toBool(),a="https://"+adminParams.domain+".org/"+adminParams.loginDir.slice(0,-1),r='<iron-icon icon="icons:verified-user" class="material-green" data-toggle="tooltip" title="Completed"></iron-icon>',u='<iron-icon icon="icons:verified-user" class="text-muted" data-toggle="tooltip" title="Incomplete"></iron-icon>',o="<br/><small class='allowed-tld-domains'>Verifiable email addresses can be from "+e.restriction_criteria.domains+" <span data-toggle='tooltip' title='e.g., your institution'>domains</span>, but must end in: "+e.restriction_criteria.tlds+"</small>",t=c?r+" Have an email in allowed TLDs / domains. "+o:d?u+" Neither your primary email or alternate email is in an allowed TLD / domain. <strong>Fix:</strong> Change your alternative email in <a href='"+a+"'>Account Settings</a>. "+o:u+" To create a new project, you must have a verifiable email address. <strong>Fix:</strong> Add  an alternative email address in <a href='"+a+"'>Account Settings</a>. "+o,_=w?r+" Have a verified username":u+" Your primary email isn't verified. <strong>Fix:</strong> Verify it in <a href='"+a+"'>Account Settings</a>",d&&(y?v=r+" Your alternate email is verified":n&&(v=u+" Your alternate email isn't verified. <strong>Fix:</strong> Verify it in <a href='"+a+"'>Account Settings</a>")),v=isNull(v)?"":"<li>"+v+"</li>",g="",p&&(g=r+" You're "+(h.toBool()?"a SuperUser":"an administrator")+". You're always unrestricted."),i="<div>\n  "+g+'\n  <ul class="restriction-criteria">\n    <li>'+t+"</li>\n    <li>"+_+"</li>\n    "+v+"\n  </ul>\n  <p>\n    Restricted accounts can't create projects.\n  </p>\n</div>",b=m?"Your account is unrestricted":"Your account is restricted",$("#restriction-summary").remove(),s='<paper-dialog id="restriction-summary" modal>\n  <h2>'+b+"</h2>\n  <paper-dialog-scrollable>\n    "+i+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("body").append(s),safariDialogHelper("#restriction-summary",0,function(){return console.info("Opened restriction summary dialog")}),!1}),!1},verifyLoginCredentials=function(a){var e;return e="hash="+$.cookie(adminParams.domain+"_auth")+"&secret="+$.cookie(adminParams.domain+"_secret")+"&dblink="+$.cookie(adminParams.domain+"_link"),$.post(adminParams.loginApiTarget,e,"json").done(function(e){if(!0===e.status)return"undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.isUnrestricted=e.unrestricted,a(e);console.error("Invalid login credentials, redirecting to login url");try{localStorage.lastLogin=JSON.stringify(e)}catch(e){}return goTo(e.login_url)}).fail(function(e,a){return $("main #main-body").html("<div class='bs-callout-danger bs-callout'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p></div>"),console.log(e,a),!1}),!1},startAdminActionHelper=function(){return $("#admin-actions-block").empty(),$("#pib-wrapper-dashboard").remove(),'<span id="pib-wrapper-dashboard" class="pib-wrapper" data-toggle="tooltip" title="Administration Home" data-placement="bottom">\n  <paper-icon-button icon="icons:dashboard" class="admin-action" id="show-actions">\n  </paper-icon-button>\n</span>',$("#pib-wrapper-settings").after('<span id="pib-wrapper-dashboard" class="pib-wrapper" data-toggle="tooltip" title="Administration Home" data-placement="bottom">\n  <paper-icon-button icon="icons:dashboard" class="admin-action" id="show-actions">\n  </paper-icon-button>\n</span>'),$("#show-actions").click(function(){return $(this).tooltip("hide"),$(".tooltip").tooltip("hide"),populateAdminActions()})},getInfoTooltip=function(e){return null==e&&(e="No Message Provided"),'<div class="col-xs-1 adjacent-info">\n  <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="'+e+'"></span>\n</div>'},alertBadProject=function(e){return e=null!=e?"project "+e:"this project",stopLoadError("Sorry, "+e+" doesn't exist"),!1},loadCreateNewProject=function(){var a,t,e,o,n,r,i,s,l;l=uri.urlString+"admin-page.html#action:create-project",i={do:"action",prop:"create-project"},history.pushState(i,"Create New Project",l),startAdminActionHelper(),t='<h2 class="new-title col-xs-12">Project Title</h2>\n<paper-input label="Descriptive, unique project title" id="project-title" class="project-field col-md-6 col-xs-11" required auto-validate data-field="project_title"></paper-input>\n'+getInfoTooltip("A descriptive title is most useful. Tell us the main focus of the project and whether a monitoring effort or project that just occurred in the Spring of 2015.")+'\n<h2 class="new-title col-xs-12">Project Parameters</h2>\n<section class="project-inputs clearfix col-xs-12">\n  <div class="row">\n    <paper-input label="Primary Pathogen" id="project-disease" class="project-field col-xs-6" required auto-validate data-field="disease"></paper-input>\n      '+getInfoTooltip("Bd, Bsal, or other. If empty, we'll take it from your data.")+'\n      <button class="btn btn-default fill-pathogen col-xs-2" data-pathogen="Batrachochytrium dendrobatidis">Bd</button>\n      <button class="btn btn-default fill-pathogen col-xs-2" data-pathogen="Batrachochytrium salamandrivorans">Bsal</button>\n    <paper-input label="Pathogen Strain" id="project-disease-strain" class="project-field col-md-6 col-xs-11" data-field="disease_strain"></paper-input>'+getInfoTooltip("For example, specific Bd strains which have been sequenced JEL423, JAM81, if known")+'\n    <paper-input label="Project Reference" id="reference-id" class="project-field col-md-6 col-xs-11" data-field="reference_id"></paper-input>\n    '+getInfoTooltip("E.g.  a DOI or other reference")+'\n    <paper-input label="Publication DOI" id="pub-doi" class="project-field col-md-6 col-xs-11" data-field="publication"></paper-input>\n    '+getInfoTooltip("Publication DOI citing these datasets may be added here.")+'\n    <h2 class="new-title col-xs-12">Lab Parameters</h2>\n    <paper-input label="Project PI" id="project-pi" class="project-field col-md-6 col-xs-12"  required auto-validate data-field="pi_lab"></paper-input>\n    <paper-input label="Project Contact" id="project-author" class="project-field col-md-6 col-xs-12" value="'+userFullname+'"  required auto-validate></paper-input>\n    '+getInfoTooltip("This will be the identity used for the project citation")+'\n    <gold-email-input label="Contact Email" id="author-email" class="project-field col-md-6 col-xs-12" value="'+userEmail+'"  required auto-validate></gold-email-input>\n    <paper-input label="Technical/Data Contact" id="project-technical-contact" class="project-field col-md-6 col-xs-12" value="'+userFullname+'"  required auto-validate></paper-input>\n    '+getInfoTooltip("This will be the identity suggested for technical communications about the project")+'\n    <gold-email-input label="Technical/Data Contact Email" id="technical-contact-email" class="project-field col-md-6 col-xs-12" value="'+userEmail+'"  required auto-validate></gold-email-input>\n    <paper-input label="Diagnostic Lab" id="project-lab" class="project-field col-md-6 col-xs-11"  required auto-validate></paper-input>\n    '+getInfoTooltip("Name or PI responsible for lab results")+'\n    <paper-input label="Affiliation" id="project-affiliation" class="project-field col-md-6 col-xs-11"  required auto-validate></paper-input> '+getInfoTooltip("Of project PI. e.g., UC Berkeley")+'\n    <h2 class="new-title col-xs-12">Project Notes</h2>\n    <iron-autogrow-textarea id="project-notes" class="project-field col-md-6 col-xs-11 language-markdown" rows="3" data-field="sample_notes"></iron-autogrow-textarea>'+getInfoTooltip("Project notes or brief abstract; accepts Markdown ")+'\n    <marked-element class="project-param col-md-6 col-xs-12" id="note-preview">\n      <div class="markdown-html"></div>\n    </marked-element>\n    <h2 class="new-title col-xs-12">Data Permissions</h2>\n    <div class="col-xs-12">\n      <span class="toggle-off-label iron-label">Private Dataset</span>\n      <paper-toggle-button id="data-encumbrance-toggle" class="red">Public Dataset</paper-toggle-button>\n      '+getInfoTooltip("this will be the setting for all data uploaded to this Project")+'\n    </div>\n\n    <h2 class="new-title col-xs-12">Project Area of Interest</h2>\n    <div class="col-xs-12">\n      <p>\n        This represents the approximate collection region for your samples.\n        <br/>\n        <strong>\n          The last thing you do (search, build a locality, or upload data) will be your dataset\'s canonical locality.\n        </strong>.\n      </p>\n      <span class="toggle-off-label iron-label">Locality Name</span>\n      <paper-toggle-button id="transect-input-toggle">Coordinate List</paper-toggle-button>\n    </div>\n    <p id="transect-instructions" class="col-xs-12"></p>\n    <div id="transect-input" class="col-md-6 col-xs-12">\n      <div id="transect-input-container" class="clearfix">\n      </div>\n      <p class="computed-locality" id="computed-locality">\n        You may also click on the map to outline a region of interest, then click "Build Map" below to calculate a locality.\n      </p>\n      <br/><br/>\n      <button class="btn btn-primary" disabled id="init-map-build">\n        <iron-icon icon="maps:map"></iron-icon>\n        Build Map\n        <small>\n          (<span class="points-count">0</span> points)\n        </small>\n      </button>\n      <paper-icon-button icon="icons:restore" id="reset-map-builder" data-toggle="tooltip" title="Reset Points"></paper-icon-button>\n    </div>\n    <div id="carto-rendered-map" class="col-md-6 col-xs-12">\n      <div id="carto-map-container" class="carto-map map">\n      </div>\n    </div>\n    <div class="col-xs-12">\n      <br/>\n      <paper-checkbox checked id="has-data">My project already has data</paper-checkbox>\n      <br/>\n    </div>\n  </div>\n</section>\n<section id="uploader-container-section" class="data-section col-xs-12 clearfix">\n  <h2 class="new-title">Uploading your project data</h2>\n  <p>Drag and drop as many files as you need below. </p>\n  <p>\n    Please note that the data <strong>must</strong> have a header row,\n    and the data <strong>must</strong> have the columns <code>decimalLatitude</code>, <code>decimalLongitude</code>, and <code>coordinateUncertaintyInMeters</code>. Your project must also be titled before uploading data.\n  </p>\n  <div class="alert alert-info" role="alert">\n    We\'ve partnered with the Biocode FIMS project and you can get a template with definitions at <a href="http://www.biscicol.org/template" class="newwindow alert-link" data-newtab="true">biscicol.org <span class="glyphicon glyphicon-new-window"></span></a> <small>(Alternate link: <a href="https://berkeley.box.com/v/AmphibianDisease-template" class="newwindow alert-link" data-newtab="true">Berkeley Box <span class="glyphicon glyphicon-new-window"></span></a>)</small>. Check out the documentation for <a href="https://amphibian-disease-tracker.readthedocs.org/en/latest/Creating%20a%20New%20Project/#with-data" class="newwindow alert-link" data-newtab="true">more instructions <span class="glyphicon glyphicon-new-window"></span></a>\n  </div>\n  <div class="alert alert-warning" role="alert">\n    <strong>If the data are in Excel</strong>, ensure that they are in the first sheet in the workbook, or in a worksheet titled <code>Samples</code>, as per FIMS.\n  </div>\n</section>\n<section class="project-inputs clearfix data-section col-xs-12">\n  <div class="row">\n    <h2 class="new-title col-xs-12">Project Data Summary</h2>\n    <h3 class="new-title col-xs-12">Calculated Data Parameters</h3>\n    <paper-input label="Samples Counted" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="samplecount" readonly type="number" data-field="disease_samples"></paper-input>\n    <paper-input label="Positive Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="positive-samples" readonly type="number" data-field="disease_positive"></paper-input>\n    <paper-input label="Negative Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="negative-samples" readonly type="number" data-field="disease_negative"></paper-input>\n    <paper-input label="No Confidence Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="no_confidence-samples" readonly type="number" data-field="disease_no_confidence"></paper-input>\n    <paper-input label="Disease Morbidity" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="morbidity-count" readonly type="number" data-field="disease_morbidity"></paper-input>\n    <paper-input label="Disease Mortality" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="mortality-count" readonly type="number" data-field="disease_mortality"></paper-input>\n    <h4 class="new-title col-xs-12">Species in dataset</h4>\n    <iron-autogrow-textarea id="species-list" class="project-field col-md-6 col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    <p class="col-xs-12"><a id="download-server-parsed-data" class="btn btn-primary disabled">Download Parsed Data</a></p>\n  </div>\n</section>\n<section id="submission-section" class="col-xs-12">\n  <div class="pull-right">\n    <button id="upload-data" class="btn btn-success click" data-function="finalizeData"><iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project</button>\n    <button id="reset-data" class="btn btn-danger click" data-function="resetForm">Reset Form</button>\n  </div>\n</section>',$("main #main-body").append(t);try{$("#project-title").blur(function(){return p$(this).value.toLowerCase().replace(/ *b(sal|d\W) *|(19|20)[0-9]{2}|\s+\W|\s+(for|the|and|of|in|from|a|an)\s+/gim," ").replace(/  /gm," ").trim().split(" ").length<=3&&bsAlert("Your title seems very short/generic. Read it again, and make sure it is both <strong>unique</strong> and <strong>descriptive</strong>."),!1})}catch(e){console.warn("Couldn't set up blur event - "+(a=e).message),console.warn(a.stack)}mapNewWindows();try{for(r=$("paper-input[required]"),o=0,n=r.length;o<n;o++)e=r[o],p$(e).validate()}catch(e){console.warn("Couldn't pre-validate fields")}return $(".fill-pathogen").click(function(){var e;return e=$(this).attr("data-pathogen"),p$("#project-disease").value=e,!1}),$("#init-map-build").click(function(){return doMapBuilder(window.mapBuilder,null,function(e){return console.debug("doMapBuilder callback initialized ..."),t='<p class="text-muted" id="computed-locality">\n  Computed locality: <strong>'+e.locality+"</strong>\n</p>",$("#computed-locality").remove(),$("#using-computed-locality").remove(),$("#transect-input-container").after(t),!1})}),$("#reset-map-builder").click(function(){delete window.mapBuilder,$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length);try{p$("google-map").clear()}catch(e){}return $("google-map google-map-marker").remove(),$("google-map google-map-poly").remove()}),s=p$("#project-notes").textarea,$(s).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),bootstrapUploader(),bootstrapTransect(),$("#has-data").on("iron-change",function(){return $(this).get(0).checked?($(".data-section").removeAttr("hidden"),$(".label-with-data").removeAttr("hidden")):($(".data-section").attr("hidden","hidden"),$(".label-with-data").attr("hidden","hidden"))}),$("#data-encumbrance-toggle").on("iron-change",function(){var e;return e=p$("#data-encumbrance-toggle").checked?'<iron-icon icon="social:public"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Public Project':'<iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project',$("#upload-data").html(e)}),console.log("Getting location, prerequisite to setting up map ..."),getLocation(function(){var e;_adp.currentLocation=new Point(window.locationData.lat,window.locationData.lng),e={bsGrid:""},console.log("Location fetched, setting up map ..."),createMap2(null,e);try{return delay(500,function(){return setupDebugContext()})}catch(e){}}),bindClicks(),!1},finalizeData=function(z,J){var e,a,t,o,n,r;null==z&&(z=!1),startLoad();try{return a=!0,$("[required]").each(function(){var e;try{if(e=$(this).val(),isNull(e))return $(this).get(0).focus(),a=!1}catch(e){}}),a?(e=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectId)&&(_adp.projectId=md5(""+geo.dataTable+e+Date.now())),r=p$("#project-title").value,(null!=dataFileParams?dataFileParams.hasDataFile:void 0)&&-1===dataFileParams.filePath.search(helperDir)&&(dataFileParams.filePath=""+helperDir+dataFileParams.filePath),o=null!=(n=null!=dataFileParams?dataFileParams.filePath:void 0)?n:null,mintBcid(_adp.projectId,o,r,function(e){var a,t,o,n,r,i,b,s,l,c,d,v,p,u,m,g,f,h,y,w,_,j,k,x,P,D,S,C,A,L,T,E,I,O,N,M,F,B,U,H,R;try{if(!e.status)return console.error(e.error),bsAlert(e.human_error,"danger"),stopLoadError(e.human_error),!1;if(dataAttrs.ark=e.ark,null==dataAttrs.data_ark&&(dataAttrs.data_ark=[]),dataAttrs.data_ark.push(e.ark+"::"+dataFileParams.fileName),k={},z)k=_adp.projectData;else for(x=$(".project-field"),p=0,u=x.length;p<u;p++)s=x[p],d=$(s).hasClass("iron-autogrow-textarea-0")?$($(s).get(0).textarea).val():$(s).val(),v=$(s).attr("data-field"),isNull(v)||("number"===$(s).attr("type")?k[v]=toInt(d):k[v]=d);if(t=getMapCenter(geo.boundingBox),l=0,null!=uploadedData){for(n=[],y=[],R=[],[],a=[],F=[],r=[],B=[],N=0,P=Object.toArray(uploadedData),f=0,m=P.length;f<m;f++){E=P[f],++N,o=null!=(D=E.dateCollected)?D:E.dateIdentified,H=excelDateToUnixTime(o),n.push(H),U=new Date(H),h=dateMonthToString(U.getUTCMonth()),indexOf.call(y,h)<0&&y.push(h),S=U.getFullYear(),indexOf.call(R,S)<0&&R.push(U.getFullYear()),null!=E.catalogNumber&&a.push(E.catalogNumber),F.push(E.sampleId),I=toFloat(E.decimalLatitude),O=toFloat(E.decimalLongitude);try{i=geo.distance(I,O,t.lat,t.lng)}catch(e){throw b=e,console.error("Couldn't calculate distanceFromCenter",I,O,t),console.warn("Row: #"+N,E),b}l<i&&(l=i),null!=E.sampleType&&(C=E.sampleType,indexOf.call(B,C)<0&&B.push(E.sampleType)),null!=E.specimenDisposition&&(A=E.specimenDisposition,indexOf.call(r,A)<0&&r.push(E.sampleDisposition))}console.info("Got date ranges",n),y.sort(),R.sort(),k.sampled_collection_start=n.min(),k.sampled_collection_end=n.max(),console.info("Collected from",n.min(),n.max()),k.sampling_months=y.join(","),k.sampling_years=R.join(","),console.info("Got uploaded data",uploadedData),k.sample_catalog_numbers=a.join(","),k.sample_field_numbers=F.join(","),k.sample_methods_used=B.join(",")}else{if(null==geo.canonicalHullObject)try{createConvexHullFINISHME}catch(e){}if(null!=geo.canonicalHullObject)for(c=geo.canonicalHullObject.hull,w=0,g=c.length;w<g;w++)_=c[w],l<(i=geo.distance(_.lat,_.lng,t.lat,t.lng))&&(l=i)}if((null!=dataFileParams?dataFileParams.hasDataFile:void 0)&&(-1===dataFileParams.filePath.search(helperDir)&&(dataFileParams.filePath=""+helperDir+dataFileParams.filePath),k.sample_raw_data="https://amphibiandisease.org/"+dataFileParams.filePath),k.lat=t.lat,k.lng=t.lng,k.radius=toInt(1e3*l),null!=(null!=(L=_adp.data)&&null!=(T=L.pushDataUpload)?T.samples:void 0)&&(M=_adp.data.pushDataUpload.samples,k.disease_morbidity=M.morbidity,k.disease_mortality=M.mortality,k.disease_negative=M.negative,k.disease_no_confidence=M.no_confidence,k.disease_positive=M.positive,k.disease_samples=toInt(M.positive)+toInt(M.negative)+toInt(M.no_confidence)),j=function(){var e,a,t,o,n,r,i,s,l,c,d,p,u,m,g,f,h;console.info("Computed locality "+_adp.locality),k.locality=_adp.locality,null!=geo.computedBoundingRectangle&&(k.bounding_box_n=geo.computedBoundingRectangle.north,k.bounding_box_s=geo.computedBoundingRectangle.south,k.bounding_box_e=geo.computedBoundingRectangle.east,k.bounding_box_w=geo.computedBoundingRectangle.west),k.author=$.cookie(adminParams.domain+"_link");try{k.technical_contact=p$("#project-technical-contact").value,k.technical_contact_email=p$("#project-technical-contact-email").value}catch(e){}try{if("object"==typeof kmlInfo)try{k.transect_file=JSON.stringify(kmlInfo)}catch(e){console.warn("Couldn't stringify data - "+(b=e).message,kmlInfo),null!=kmlInfo.path&&(k.transect_file=kmlInfo.path)}}catch(e){}null==("undefined"!=typeof _adp&&null!==_adp&&null!=(f=_adp.projectData)?f.author_data:void 0)?(a={name:p$("#project-author").value,contact_email:p$("#author-email").value,affiliation:p$("#project-affiliation").value,lab:p$("#project-pi").value,diagnostic_lab:p$("#project-lab").value,entry_date:Date.now()},k.author_data=JSON.stringify(a)):k.author_data=_adp.projectData.author_data,o={table:geo.dataTable,raw_data:dataFileParams,bounding_polygon:"undefined"!=typeof geo&&null!==geo?geo.canonicalBoundingBox:void 0,bounding_polygon_geojson:"undefined"!=typeof geo&&null!==geo?geo.geoJsonBoundingBox:void 0},k.carto_id=JSON.stringify(o),k.project_id=_adp.projectId,k.modified=Date.now()/1e3;try{k.project_obj_id=_adp.fims.expedition.ark}catch(e){return mintExpedition(_adp.projectId,null,function(){return j()}),!1}if(null==dataAttrs.data_ark&&(dataAttrs.data_ark=[]),k.dataset_arks=dataAttrs.data_ark.join(","),k.project_dir_identifier=getUploadIdentifier(),k.public=null==(s=null!=(l=null!=(c=null!=(d=p$("#data-encumbrance-toggle"))?d.checked:void 0)?c:null!=(p=p$("#public"))?p.checked:void 0)?l:"undefined"!=typeof _adp&&null!==_adp&&null!=(u=_adp.projectData)?u.public:void 0)||s,null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(m=_adp.data)&&null!=(g=m.taxa)?g.validated:void 0))for(h=_adp.data.taxa.validated,k.sampled_clades=_adp.data.taxa.clades.join(","),k.sampled_species=_adp.data.taxa.list.join(","),i=0,r=h.length;i<r&&(t=h[i].response.validated_taxon,console.info("Aweb taxon result:",t),n=t.order.toLowerCase(),k[v="includes_"+n]=!0,null!=k.includes_anura==!1||null!=k.includes_caudata==!1||null!=k.includes_gymnophiona==!1);i++);return e="perform=new&data="+jsonTo64(k),console.info("Data object constructed:",k),z?("function"==typeof J&&J(k),stopLoad(),k):_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,e,"json").done(function(a){var e,t,o;try{!0===a.status?(bsAlert("Project ID #<strong>"+k.project_id+"</strong> created","success"),e=(new Date).toLocaleString(),o={action:"notify",subject:"Project '"+k.project_title+"' Created",body:"Project "+k.project_id+" ('"+k.project_title+"') created at "+e+" by <a href='https://amphibiandisease.org/profile.php?id="+$.cookie("amphibiandisease_link")+"'>"+$.cookie("amphibiandisease_fullname")+"&lt;<code>"+$.cookie("amphibiandisease_user")+"</code>&gt;</a>"},$.get(uri.urlString+"admin-api.php",buildArgs(o,"json")),$.get(uri.urlString+"recordMigrator.php"),stopLoad(),delay(1e3,function(){return loadEditor(_adp.projectId)}),toastStatusMessage("Data successfully saved to server")):(console.error(a.error.error),console.log(a),stopLoadError(a.human_error),bsAlert(a.human_error,"error"))}catch(e){b=e,stopLoadError("There was a verifying your save data");try{t=JSON.stringify(a)}catch(e){t="BAD_OBJECT"}try{bsAlert("There was a problem verifying your save data<br/><br/>Application said: <code>"+t+"</code><code>"+b.message+"</code><code>"+b.stack+"</code>","error")}catch(e){}console.error("JavaScript error in save data callback! FinalizeData said: "+b.message),console.warn(b.stack)}return!1}).fail(function(e,a){return stopLoadError("There was a problem saving your data. Please try again"),!1})},console.info("Checking locality ..."),null==geo.computedLocality&&dataFileParams.hasDataFile){if(dataFileParams.hasDataFile)return null==t&&(t=getMapCenter(geo.boundingBox)),console.info("Computing locality with reverse geocode from",t,geo.boundingBox),geo.reverseGeocode(t.lat,t.lng,geo.boundingBox,function(e){return console.info("Computed locality "+e),_adp.locality=e,j()});try{_adp.locality=p$("#locality-input").value}catch(e){_adp.locality=""}return console.warn("How did we get to this state? No locality precomputed, no data file"),j()}if(null!=geo.computedLocality)console.info("Already have locality"),_adp.locality=geo.computedLocality;else try{console.info("Took written locality"),_adp.locality=p$("#locality-input").value}catch(e){console.info("Can't figure out locality"),_adp.locality=""}return dataFileParams.hasDataFile?j():mintExpedition(_adp.projectId,null,function(){return j()})}catch(e){return b=e,stopLoadError("There was a problem with the application. Please try again later. (E-003)"),console.error("JavaScript error in saving data (E-003)! FinalizeData said: "+b.message),console.warn(b.stack)}})):(stopLoadError("Please fill out all required fields"),!1)}catch(e){t=e,stopLoadError("There was a problem with the application. Please try again later. (E-004)");try{bsAlert("There was a problem with the application. Please try again later. (E-004)<br/><br/>Application said: <code>"+t.message+"</code><code>"+t.stack+"</code>","error")}catch(e){}return console.error("JavaScript error in saving data (E-004)! FinalizeData said: "+t.message),console.warn(t.stack)}},resetForm=function(){return foo()},getTableCoordinates=function(e){return null==e&&(e="tdf0f1bc730325de59d48a5c80df45931_6d6d454828c05e8ceea03c99cc5f547e52fcb5fb"),!1},pointStringToLatLng=function(e,a){var t,o,n;return null==a&&(a=!1),e.search(!1)?(n=e.slice(6,-1).split(" "),o=1===(t=90<Math.abs(n[0])||a?1:0)?0:1,{lat:n[t],lng:n[o]}):(console.warn("Invalid point string"),!1)},pointStringToPoint=function(e,a){var t;return null==a&&(a=!1),e.search(!1)?(t=pointStringToLatLng(e,a),canonicalizePoint(t)):(console.warn("Invalid point string"),!1)},bootstrapTransect=function(){var t,e;return window.geocodeLookupCallback=function(){var e;return startLoad(),e={address:p$("#locality-input").value},(new google.maps.Geocoder).geocode(e,function(a,e){var t,o,n,r,i,s,l,c,d;if(e===google.maps.GeocoderStatus.OK){console.info("Google said:",a),$("#locality-lookup-result").exists()||$("#carto-rendered-map").prepend('<div class="alert alert-info alert-dismissable" role="alert" id="locality-lookup-result">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <strong>Location Found</strong>: <span class="lookup-name">'+a[0].formatted_address+"</span>\n</div>"),s='<p class="text-muted" id="computed-locality">\n  Computed locality: <strong>'+a[0].formatted_address+'</strong>\n</p>\n<div class="alert alert-info" id="using-computed-locality">\n  <p>\n    This is your currently active locality. Entering points below will take priority over this.\n  </p>\n</div>',$("#computed-locality").remove(),$("#using-computed-locality").remove(),$("#transect-input-container").after(s),$("#locality-lookup-result .lookup-name").text(a[0].formatted_address),_adp.locality=a[0].formatted_address,d=a[0].geometry.location,l=d.lat(),c=d.lng(),r=a[0].geometry.viewport;try{t=r.R,o=r.j,n={nw:[t.j,o.R],ne:[t.j,o.j],se:[t.R,o.R],sw:[t.R,o.j],north:t.j,south:t.R,east:o.j,west:o.R}}catch(e){console.warn("Danger: There was an error calculating the bounding box ("+(i=e).message+")"),console.warn(i.stack),console.info("Got bounds",r),console.info("Got geometry",a[0].geometry)}return console.info("Got bounds: ",[l,c],n),geo.boundingBox=n,loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",function(){return geo.renderMapHelper(n,l,c)},!1)}return stopLoadError("Couldn't find location: "+e)})},geo.renderMapHelper=function(e,a,t){var o,n,r,i;if(null==e&&(e=geo.boundingBox),startLoad(),null==("undefined"!=typeof google&&null!==google?google.maps:void 0))return window.recallMapHelper=function(){return geo.renderMapHelper(e,a,t)},loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=recallMapHelper"),!1;try{return $("#carto-map-container").empty(),n={selector:"#carto-map-container",bsGrid:""},$(n.selector).empty(),i=function(){return stopLoad(),!1},null!=geo.dataTable?getCanonicalDataCoords(geo.dataTable,n,function(){return i()}):(n.boundingBox=e,r=new Point(a,t),createMap2([r],n,function(){return i()}))}catch(e){return console.error("There was an error rendering the map - "+(o=e).message),stopLoadError("There was an error rendering the map - "+o.message)}},t=function(){return null==("undefined"!=typeof google&&null!==google?google.maps:void 0)?loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=geocodeLookupCallback"):geocodeLookupCallback(),!1},(e=function(){var e,a;return p$("#transect-input-toggle").checked?(e="Please input a list of coordinates, in the form <code>lat, lng</code>, with one set on each line. <strong>Please press <kbd>enter</kbd> to insert a new line after your last coordinate</strong>.",a='<iron-autogrow-textarea id="coord-input" class="" rows="3"></iron-autogrow-textarea>'):(e="Please enter a name of a locality",a='<paper-input id="locality-input" label="Locality" class="pull-left"></paper-input> <paper-icon-button class="pull-left" id="do-search-locality" icon="icons:search"></paper-icon-button>'),$("#transect-instructions").html(e),$("#transect-input-container").html(a),p$("#transect-input-toggle").checked?$(p$("#coord-input").textarea).keyup(function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,g;if(13===(e.keyCode?e.keyCode:e.which)&&3<(g=$(p$("#coord-input").textarea).val()).split("\n").length){for(r=[],i=g.split("\n"),console.info("Raw coordinate info:",i),c=0,d=i.length;c<d;c++)0<(o=i[c]).search(",")&&!isNull(o)&&2===(n=o.split(",")).length&&(m=[toFloat(n[0]),toFloat(n[1])],r.push(m));if(3<=r.length){for(console.info("Coords:",r),a={},u=l=0,p=r.length;u<p;u++)t=r[u],a[++l]=t;return s=function(){return geo.renderMapHelper(a)},geo.boundingBox=a,loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",s,!1)}return console.warn("There is one or more invalid coordinates preventing the UI from being shown.")}}):($("#locality-input").keyup(function(e){if(13===(e.keyCode?e.keyCode:e.which))return t()}),$("#do-search-locality").click(function(){return t()})),!1})(),$("#transect-input-toggle").on("iron-change",function(){return e()}),!1},mapOverlayPolygon=function(e,a,t,o){var n,r,i,s,l,c,d,p,u,m,g,f,h,b;if(null==a&&(a=null),null==t&&(t={}),null==o&&(o=geo.googleMap),d={},"object"!=typeof e)return console.warn("mapOverlayPolygon() got an invalid data type to overlay!"),!1;if("object"!=typeof t&&(t={}),null==t.fillColor&&(t.fillColor="#ff7800"),d.fillColor=t.fillColor,d.fillOpacity=.35,"object"!=typeof a&&(a=null),console.info("Should overlay polygon from bounds here"),$("#carto-map-container").exists()&&null!=geo.cartoMap){for(g in f=[],[],n=[],[],c=[],-90,90,-180,180,e)h=e[g],f.push(h),(b={}).lat=h[0],b.lng=h[1],n.push(new fPoint(b.lat,b.lng)),c.push(new Point(b.lat,b.lng));sortPoints(c),r=sortPoints(c,!1),(i=n).sort(sortPointY),i.sort(sortPointX),[].push(f);try{s=getConvexHullPoints(i)}catch(e){console.error("Convex hull points CHP failed! - "+(l=e).message),console.warn(l.stack),console.info(i)}console.info("Got hulls",s),console.info("Sources",r,n,i),u={type:"Feature",properties:a,geometry:m={type:"Polygon",coordinates:d.paths=s}},console.info("Rendering GeoJSON MultiPolygon",m),geo.geoJsonBoundingBox=u,geo.overlayOptions=t,console.info("Rendering Google Maps polygon",d),geo.canonicalBoundingBox=d,p=new google.maps.Polygon(d),null!=geo.googlePolygon&&geo.googlePolygon.setMap(null),(geo.googlePolygon=p).setMap(o),isNull(dataAttrs.coords||isNull(geo.dataTable))||getCanonicalDataCoords(geo.dataTable)}else console.warn("There's no map yet! Can't overlay polygon");return!1},mapAddPoints=function(e,a,t){var o,n,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y;for(null==t&&(t=geo.googleMap),l=0,c=e.length;l<c;l++)if(!((h=e[l])instanceof geo.Point))return console.warn("Invalid datatype in array -- array must be constructed of Point objects"),!1;for(f={},r=[],p=o=0,d=e.length;p<d;p++)h=e[p],y=null!=a?null!=(v=a[o])?v.title:void 0:"",b=h.getObj(),m={position:new google.maps.LatLng(b.lat,b.lng),map:t,title:y},u=new google.maps.Marker(m),f[o]={marker:u},isNull(y)?console.info("Key "+o+" has no title in pointInfoArray",a[o]):(i={content:a[o].html},n=new google.maps.InfoWindow(i),f[o].infoWindow=n,r.push(n)),++o;if(!isNull(r)){for(s in dataAttrs.coordInfoWindows=r,f)(u=(g=f[s]).marker).unbind("click"),(u.self=u).iw=g.infoWindow,u.iwk=s,u.addListener("click",function(){try{return this.iw.open(t,this),console.info("Opening infoWindow #"+this.iwk)}catch(e){return e,console.error("Invalid infowindow @ "+this.iwk+"!",r,g,this.iw)}});geo.markers=f}return f},getCanonicalDataCoords=function(v,y,w){return null==y&&(y=_adp.defaultMapOptions),null==w&&(w=createMap2),isNull(v)?console.error("A table must be specified!"):"function"!=typeof w?console.error("This function needs a callback function as the second argument"):verifyLoginCredentials(function(f){var h,b;return b="SELECT * FROM "+v+" WHERE FALSE",h="action=fetch&sql_query="+post64(b),_adp.currentAsyncJqxhr=$.post("api.php",h,"json").done(function(a){var e,u,m,t,o,n,r,i,s,l,c,d,p,g;try{s=JSON.parse(a.post_response[0])}catch(e){console.error("getCanonicalDataCoords couldn't read carto data! Failed to get columns ("+(n=e).message+")",a),console.warn("Table: '"+v+"' for query",b),console.warn(n.stack),null!=(l=null!=(c=a.human_error)?c:a.error)?l:"It should be safe, however.",i="There was a problem fetching your data back from CartoDB. ",stopLoadError(i),bsAlert(i,"danger");try{"function"==typeof w&&w([],y)}catch(e){}return!1}for(r in t={},d=s.fields)g=d[r],t[r]=g;for(u in _adp.activeCols=t,o=[],m={},t)t[u],"id"!==u&&"the_geom"!==u&&o.push(u),m[u.toLowerCase()]=u;return _adp.colsList=o,_adp.colRemap=m,p="SELECT ST_AsText(the_geom), "+o.join(",")+" FROM "+v,e=encodeURIComponent(encode64(p)),h="action=fetch&sql_query="+e,_adp.currentAsyncJqxhr=$.post("api.php",h,"json").done(function(e){var a,t,o,n,r,i,s,l,c,d,p;for(o in a=e.parsed_responses[0],t=[],n=[],_adp.cartoRows={},s=a.rows){for(u in c=s[o],_adp.cartoRows[o]={},c)p=c[u],i=null!=(l=m[u])?l:u,_adp.cartoRows[o][i]=p;d=c.st_astext,isNull(c.infraspecificepithet)&&(c.infraspecificepithet=""),r=pointStringToLatLng(d,!0),f={title:c.catalognumber+": "+c.genus+" "+c.specificepithet+" "+c.infraspecificepithet,html:'<p>\n  <span class="sciname italic">'+c.genus+" "+c.specificepithet+" "+c.infraspecificepithet+"</span> collected on "+c.dateidentified+"\n</p>\n<p>\n  <strong>Status:</strong>\n  Sampled by "+c.samplemethod+", disease status "+c.diseasedetected+" for "+c.diseasetested+"\n</p>"},r.infoWindow=f,t.push(r),n.push(f)}if(dataAttrs.coords=t,dataAttrs.markerInfo=n,console.info("Calling back with",t,y),"function"==typeof w)return w(t,y)}).fail(function(e,a){return null!=(null!=dataAttrs?dataAttrs.coords:void 0)?w(dataAttrs.coords,y):(stopLoadError("Couldn't get bounding coordinates from data"),console.error("No valid coordinates accessible!"))})}).fail(function(e,a){return!1})}),!1},getUploadIdentifier=function(){var e,a,t;if(isNull(_adp.uploadIdentifier)){if(isNull(_adp.projectId)){if(e=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectIdentifierString)){try{t=isNull(p$("#project-title").value)?randomString(16):p$("#project-title").value}catch(e){t=randomString(16)}a="t"+md5(t+e),_adp.projectIdentifierString=a}_adp.projectId=md5(""+a+e+Date.now())}_adp.uploadIdentifier=md5(""+user+_adp.projectId)}return _adp.uploadIdentifier},bootstrapUploader=function(e,a,t){var o,n;return null==e&&(e="file-uploader"),null==a&&(a="col-md-4"),n="#"+e,$.cookie(adminParams.domain+"_link"),getUploadIdentifier(),_adp.projectIdentifierString,$(n).exists()||(o='<form id="'+e+'-form" class="'+a+' clearfix">\n  <p class="visible-xs-block">Tap the button to upload a file</p>\n  <fieldset class="hidden-xs">\n    <legend>Upload Files</legend>\n    <div id="'+e+'" class="media-uploader outline media-upload-target">\n    </div>\n  </fieldset>\n</form>',$("main #uploader-container-section").append(o),console.info("Appended upload form"),$(n).submit(function(e){return e.preventDefault(),e.stopPropagation(),!1})),verifyLoginCredentials(function(){var e;return null==window.dropperParams&&(window.dropperParams={}),window.dropperParams.dropTargetSelector=n,window.dropperParams.uploadPath="uploaded/"+getUploadIdentifier()+"/",e=!0===window.dropperParams.hasInitialized,loadJS("helpers/js-dragdrop/client-upload.min.js",function(){if(console.info("Loaded drag drop helper"),e){console.info("Reinitialized dropper");try{window.dropperParams.initialize()}catch(e){console.warn("Couldn't reinitialize dropper!")}}if(window.dropperParams.postUploadHandler=function(e,a){var t,o,n,r,i,s,l,c;if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof a)return console.error("Dropzone returned an error - "+a),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(!0!==a.status)return null==a.human_error&&(a.human_error="There was a problem uploading your image."),toastStatusMessage(""+a.human_error),console.error("Error uploading!",a),!1;try{switch(console.info("Server returned the following result:",a),console.info("The script returned the following file information:",e),s="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",o=a.full_path.split("/").pop(),c=a.wrote_thumb,i=a.mime_provided.split("/")[0],r=a.mime_provided.split("/")[1],n=e.size<5242880||"image"!==i?""+s+a.wrote_file:""+s+c,l=function(){switch(i){case"image":return'<div class="uploaded-media center-block" data-system-file="'+o+'" data-link-path="'+n+'">\n  <img src="'+n+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+e.name+" -> "+o+'\n      (<a href="'+n+'" class="newwindow" download="'+e.name+'">\n        Original Image\n      </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+o+'">\n  <audio src="'+n+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+e.name+" -> "+o+'\n    (<a href="'+n+'" class="newwindow" download="'+e.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+o+'">\n  <video src="'+n+'" controls preload="auto">\n    <img src="'+s+c+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+e.name+" -> "+o+'\n    (<a href="'+n+'" class="newwindow" download="'+e.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+o+'" data-link-path="'+n+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+e.name+" -> "+o+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(l),$("#validator-progress-container").remove(),n.slice(0),t=n.slice(0).split(".").pop(),i){case"application":switch(console.info("Checking "+r+" in application"),r){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":return excelHandler(n);case"vnd.ms-office":switch(t){case"xls":return excelHandler(n);default:return stopLoadError("Sorry, we didn't understand the upload type."),!1}break;case"zip":case"x-zip-compressed":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e.type||"xlsx"===t?excelHandler(n):"kmz"===t?kmlHandler(n):zipHandler(n);case"x-7z-compressed":return _7zHandler(n);case"vnd.google-earth.kml+xml":case"vnd.google-earth.kmz":case"xml":return"kml"===t||"kmz"===t?kmlHandler(n):(console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+r),!1);default:return console.warn("Unknown mime type application/"+r),allError("Sorry, we can't processes files of type application/"+r),!1}break;case"text":return csvHandler(n);case"image":return imageHandler(n)}}catch(e){return e,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}},"function"==typeof t)return t()}),!1})},singleDataFileHelper=function(e,a){if("function"!=typeof a)return console.error("Second argument must be a function"),!1;if(!0===dataFileParams.hasDataFile&&e!==dataFileParams.filePath){try{$("#bs-alert").remove()}catch(e){}return $("#single-data-file-modal").exists()&&$("#single-data-file-modal").remove(),'<paper-dialog modal id="single-data-file-modal">\n  <h2>You can only have one primary data file</h2>\n  <div>\n    Continuing will remove your previous one\n  </div>\n  <div class="buttons">\n    <paper-button id="cancel-parse">Cancel Upload</paper-button>\n    <paper-button id="overwrite">Replace Previous</paper-button>\n  </div>\n</paper-dialog>',$("body").append('<paper-dialog modal id="single-data-file-modal">\n  <h2>You can only have one primary data file</h2>\n  <div>\n    Continuing will remove your previous one\n  </div>\n  <div class="buttons">\n    <paper-button id="cancel-parse">Cancel Upload</paper-button>\n    <paper-button id="overwrite">Replace Previous</paper-button>\n  </div>\n</paper-dialog>'),$("#cancel-parse").click(function(){return removeDataFile(e,!1),p$("#single-data-file-modal").close(),!1}),$("#overwrite").click(function(){return removeDataFile(),p$("#single-data-file-modal").close(),a()}),safariDialogHelper("#single-data-file-modal")}return a()},excelHandler=function(t,e,o){var a,n,r,i,s,l,c,d;null==e&&(e=!0),startLoad(),$("#validator-progress-container").remove(),renderValidateProgress(),i=helperDir+"excelHelper.php",-1!==(n=t).search(helperDir)&&(console.info("removing '"+helperDir+"'"),n=t.slice(helperDir.length)),console.info("Pinging for "+n),a="action=parse&path="+n+"&sheets=Samples",r=!1;try{for(d=$("paper-input[required]"),l=0,c=d.length;l<c;l++)if(s=d[l],p$(s).invalid){r=!0,stopLoadError("Please fill out all required fields before uploading data"),bsAlert("Please fill out all required fields before uploading data","danger");try{stopLoadBarsError()}catch(e){}return removeDataFile(n),!1}}catch(e){}return r?console.error("Exiting handler -- invalid inputs"):$.get(i,a,"json").done(function(a){return console.info("Got result",a),!1===a.status?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):singleDataFileHelper(t,function(){var e;$("#upload-data").attr("disabled","disabled"),e=t.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=e.pop(),dataFileParams.filePath=n,Object.size(a.data),uploadedData=a.data,_adp.parsedUploadedData=a.data;try{p$("#replace-data-toggle").disabled=!1}catch(e){}return"function"!=typeof o?newGeoDataHandler(a.data):(console.warn("Skipping newGeoDataHandler() !"),o(a.data)),stopLoad()})}).fail(function(e,a){return console.error("Couldn't POST"),console.warn(e,a),stopLoadError()}),!1},csvHandler=function(a,e,t){var o;return null==e&&(e=!0),-1!==a.search(helperDir)&&(console.info("removing '"+helperDir+"'"),o=a.slice(helperDir.length)),singleDataFileHelper(a,function(){var e;return $("#upload-data").attr("disabled","disabled"),e=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=e.pop(),dataFileParams.filePath=o,geoDataHandler()}),!1},kmlHandler=function(x,$){var e,a;try{console.debug("Loading KML file")}catch(e){}return geo.inhibitKMLInit=!0,e=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(a=_adp.lastMod)?a.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),loadJS(e,function(){return initializeParser(null,function(){return loadKML(x,function(){var e,a,t,o,n,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y,w,_,j,k;try{if(u=geo.kml.parser.docsByUrl[x],isNull(u)&&(x="/"+x,u=geo.kml.parser.docsByUrl[x],isNull(u)&&(console.warn("Could not resolve KML by url, using first doc"),u=geo.kml.parser.docs[0])),isNull(u))return allError("Bad KML provided"),!1;for(console.debug("Using parsed data from path '"+x+"'",u),b=[],f=[],h=[],v=u.gpolygons,i=0,s=v.length;i<s;i++){for(g=v[i],m=[],f.push(g.fillColor),h.push(g.fillOpacity),y=g.getPaths().getArray(),d=0,l=y.length;d<l;d++)for(w=y[d].getArray(),p=0,c=w.length;p<c;p++)_=w[p],k=canonicalizePoint(_),m.push(k);b.push(m)}window.kmlInfo={},kmlInfo.path=x;try{if(j=b[0],1===b.length&&(b=b[0]),e={fillOpacity:h[0],fillColor:f[0],paths:j,multibounds:b},kmlInfo.parameters=e,kmlInfo.polys=b,isNull(geo)&&(window.geo={}),isNull(geo.canonicalHullObject)&&(geo.canonicalHullObject={}),geo.canonicalHullObject.hull=j,geo.canonicalBoundingBox=e,!isNull("undefined"!=typeof _adp&&null!==_adp?_adp.projectData:void 0))try{if("object"!=typeof(o=_adp.projectData.carto_id))try{a=JSON.parse(deEscape(o))}catch(e){r=(n=e).message;try{a=JSON.parse(o)}catch(e){if(n=e,511<o.length&&"object"==typeof(t=fixTruncatedJson(o))&&(console.debug("The carto data object was truncated, but rebuilt."),a=t),isNull(a))return console.error("cartoObj must be JSON string or obj, given",o),console.warn("Cleaned obj:",deEscape(o)),console.warn("Told '"+r+"' then",n.message),stopLoadError("Couldn't parse data"),!1}}else a=o;a.bounding_polygon=e,_adp.projectData.carto_id=JSON.stringify(a)}catch(e){console.error((n=e).message),console.warn(n.stack),allError("Warning: there may have been a problem saving your carto data")}}catch(e){n=e,console.warn("WARNING: Couldn't write polygon data to globals")}"function"==typeof $?$(kmlInfo):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(e){n=e,allError("There was an error importing the data from this KML file"),console.warn(n.message),console.warn(n.stack)}return!1}),!1}),!1}),!1},copyMarkdown=function(e,a,t){var o,n,r,i,s,l;if(null==t&&(t=!0),null==("undefined"!=typeof _adp&&null!==_adp?_adp.zcClient:void 0)&&(l={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},ZeroClipboard.config(l),_adp.zcClient=new ZeroClipboard($(e).get(0)),$("#copy-ark").click(function(){return copyLink(_adp.zcClient)})),o=p$(".ark-identifier").value,t)try{return r={dataType:"text/plain",data:s="https://n2t.net/"+o,"text/plain":s},n=new ClipboardEvent("copy",r),document.dispatchEvent(n),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(e){console.error("Error creating copy: "+(i=e).message),console.warn(i.stack)}return console.warn("Can't use HTML5"),"undefined"!=typeof zeroClipObj&&null!==zeroClipObj?(zeroClipObj.setData(r),null!=a&&a.setData(r),zeroClipObj.on("aftercopy",function(e){return e.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):toastStatusMessage("Error copying to clipboard")}),zeroClipObj.on("error",function(e){if(console.error("Error copying to clipboard"),console.warn("Got",e),"flash-overdue"===e.name){if(!0===_adp.resetClipboard)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,copyLink()}),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0))}if("flash-disabled"===e.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),$("#copy-ark").tooltip("destroy").remove(),$(".ark-identifier").removeClass("col-xs-9 col-md-11").addClass("col-xs-12"),toastStatusMessage("Clipboard copying isn't available on your system")})):console.error("Can't use HTML, and ZeroClipboard wasn't passed"),!1},imageHandler=function(e){return $("div[data-link-path='"+e+"']"),foo(),!1},zipHandler=function(e){return foo(),!1},_7zHandler=function(e){return foo(),!1},removeDataFile=function(e,a){var t;return null==e&&(e=dataFileParams.fileName),null==a&&(a=!0),e=e.split("/").pop(),a&&(dataFileParams.hasDataFile=!1),$(".uploaded-media[data-system-file='"+e+"']").remove(),$("#validator-progress-container paper-progress").removeAttr("indeterminate"),t=helperDir+"/js-dragdrop/uploaded/"+_adp.uploadIdentifier+"/"+e,"action=removefile&path="+encode64(t)+"&user="+user,!1},newGeoDataHandler=function(e,m,g){var a,t,o,n,r,i,f,s,l,c,d,p,u,h,b,v,y,w,_,j,k,x,P,D,S,C,A,L,T,E,I,O,N,M;null==e&&(e={}),null==m&&(m=!1),console.info("Starting geoDataHandler()");try{if(null==geo.geocoder)try{geo.geocoder=new google.maps.Geocoder}catch(e){}try{S=e[0]}catch(e){return toastStatusMessage("Your data file was malformed, and could not be parsed. Please try again."),removeDataFile(),!1}if(isNull(S.decimalLatitude)||isNull(S.decimalLongitude)||isNull(S.coordinateUncertaintyInMeters))return toastStatusMessage("Data are missing required geo columns. Please reformat and try again."),y="You're missing ",v=[],isNull(S.decimalLatitude)&&v.push("decimalLatitude"),isNull(S.decimalLongitude)&&v.push("decimalLongitude"),isNull(S.coordinateUncertaintyInMeters)&&v.push("coordinateUncertaintyInMeters"),y+=1<v.length?"some required columns: ":"a required column: ",y+="<code>"+v.join("</code>, <code>")+"</code>",bsAlert(y,"danger"),console.info("Missing: ",null!=S.decimalLatitude,null!=S.decimalLongitude,null!=S.coordinateUncertaintyInMeters),removeDataFile(),!1;if(!(isNumber(S.decimalLatitude)&&isNumber(S.decimalLongitude)&&isNumber(S.coordinateUncertaintyInMeters)))return toastStatusMessage("Data has invalid entries for geo columns. Please be sure they're all numeric and try again."),removeDataFile(),!1;D=Object.size(e);try{p$("#samplecount").value=D}catch(e){}if(isNull($("#project-disease").val()))try{p$("#project-disease").value=S.diseaseTested}catch(e){}j={},dataAttrs.coords=[],dataAttrs.coordsFull=[],dataAttrs.fimsData=[],u={},toastStatusMessage("Please wait, parsing your data"),$("#data-parsing").removeAttr("indeterminate");try{p$("#data-parsing").max=D}catch(e){}for(_ in Date.now(),N=[],d=[],e){for(n in P=e[_],k=toInt(_)+1,T={},O=[],P){if(M=P[n],n=n.trim(),0<=indexOf.call(O,n))return console.error("There was a duplicate column '"+n+"'",O),stopLoadBarsError(null,"You have at least one duplicate column '"+n+"'. Ensure all your columns are unique."),!1;switch(A=!1,n){case"ContactName":case"basisOfRecord":case"occurrenceID":case"institutionCode":case"collectionCode":case"labNumber":case"originalsource":case"datum":case"georeferenceSource":case"depth":case"Collector2":case"Collector3":case"verbatimLocality":case"Habitat":case"Test_Method":case"eventRemarks":case"quantityDetected":case"dilutionFactor":case"cycleTimeFirstDetection":if("string"==typeof M)try{M=(M=(M=M.replace(/;/gim,"&#59;")).replace(/'/gim,"&#39;")).replace(/"/gim,"&#34;")}catch(e){console.warn("Couldn't replace quotes for this:",M)}u[n]=M,A=!0;break;case"specimenDisposition":n="sampleDisposition";break;case"sampleType":n="sampleMethod";break;case"elevation":n="alt";break;case"dateCollected":case"dateIdentified":if(n="dateIdentified",L=excelDateToUnixTime(M,!0),!isNumber(L))return console.error("This row (#"+k+") has a non-date value ! ("+M+" = "+L+")"),stopLoadBarsError(null,"Detected an invalid date '"+M+"' at row #"+k+". Check your dates!"),!1;if(s=new Date(L),L<new Date("1868-03-23").getTime())return console.error("This row (#"+k+") has a date ("+M+" = "+L+") too far in the past!"),stopLoadBarsError(null,"Detected an implausibly old date '"+M+"' = <code>"+s.toDateString()+"</code> at row #"+k+". Check your dates!"),!1;if(L>Date.now())return console.error("This row (#"+k+") has a date ("+M+" = "+L+") after today!"),stopLoadBarsError(null,"Detected a future date '"+M+"' at row #"+k+". Check your dates!"),!1;(c=s.getUTCDate())<10&&(c="0"+c),(w=s.getUTCMonth()+1)<10&&(w="0"+w),o=s.getUTCFullYear()+"-"+w+"-"+c;break;case"fatal":o=M.toBool();break;case"decimalLatitude":case"decimalLongitude":case"alt":case"coordinateUncertaintyInMeters":if(!isNumber(M))return stopLoadBarsError(null,"Detected an invalid number for "+n+" at row "+k+" (<code>"+M+"</code>)"),!1;if("decimalLatitude"===n&&(M<-90||90<M))return stopLoadBarsError(null,"Detected an invalid latitude <code>"+M+"</code> at row "+k+"<br/><br/>Valid latitudes are between <code>90</code> and <code>-90</code>."),!1;if("decimalLongitude"===n&&(M<-180||180<M))return stopLoadBarsError(null,"Detected an invalid longitude <code>"+M+"</code> at row "+k+"<br/><br/>Valid latitudes are between <code>180</code> and <code>-180</code>."),!1;if("coordinateUncertaintyInMeters"===n&&M<=0)return stopLoadBarsError(null,"Coordinate uncertainty must be >= 0 at row "+k),!1;o=toFloat(M);break;case"diseaseDetected":if(isBool(M))o=M.toBool();else try{o="negative"!==M.trim().toLowerCase()&&("positive"===M.trim().toLowerCase()||"NO_CONFIDENCE")}catch(e){o="NO_CONFIDENCE"}break;case"sex":try{M="m"===(M=M.trim().toLowerCase()).slice(0,1)?"male":"f"===M.slice(0,1)?"female":"not determined"}catch(e){M="not determined"}break;case"sampleId":try{"n/a"===(I=M.trim()).toLowerCase()&&(I=""),o=I=I.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2")}catch(e){o=M}indexOf.call(N,o)<0?N.push(o):indexOf.call(d,o)<0&&d.push(o);break;default:try{o=M.trim()}catch(e){o=M}}A||(T[n]=o)}r={lat:T.decimalLatitude,lng:T.decimalLongitude,alt:T.alt,uncertainty:T.coordinateUncertaintyMeters},i=new Point(r.lat,r.lng),dataAttrs.coords.push(i),dataAttrs.coordsFull.push(r),dataAttrs.fimsData.push(u);try{T.fimsExtra=JSON.stringify(u)}catch(e){console.warn("Couldn't store FIMS extra data",u)}j[_]=T,0===modulo(_,500)&&0<_&&(toastStatusMessage("Processed "+_+" rows ..."),console.log("Processed "+_+" rows ..."));try{p$("#data-parsing").value=_+1}catch(e){}}try{console.log("Basic validation passed"),isNull(d)||bsAlert("<strong>Warning</strong>: the following field IDs all had duplicates:<br/><code>"+d+"</code></br>We <strong>strongly</strong> recommend unique IDs.","warning")}catch(e){}isNull(_adp.projectIdentifierString)?(x="t"+md5(p$("#project-title").value+a+Date.now()),_adp.projectIdentifierString=x):x=_adp.projectIdentifierString;try{f={downloadFile:"cleaned-dataset-"+Date.now()+".csv",selector:"#download-server-parsed-data"},downloadCSVFile(j,f),window.parsedData=j,_adp.cleanedAndParsedData=j}catch(e){}for(b in h=function(){var e,a,t,o,n,r,i;for(t={},i="",o=a=0,n=(r=sortPoints(dataAttrs.coords)).length;o<n;o++)e=r[o],t[a]=[e.lat,e.lng],i+=e.lat+","+e.lng+"\n",++a;try{p$("#transect-input-toggle").checked=!0,i+="\n",$(p$("#coord-input").textarea).val(i)}catch(e){}return t},null==geo.boundingBox&&(geo.boundingBox=h()),t=getMapCenter(geo.boundingBox),geo.reverseGeocode(t.lat,t.lng,geo.boundingBox,function(e){_adp.locality=e,dataAttrs.locality=e;try{return p$("#locality-input").value=e,p$("#locality-input").readonly=!0}catch(e){}}),C={mortality:0,morbidity:0,positive:0,negative:0,no_confidence:0},j){switch((l=j[b]).diseaseDetected){case!0:C.morbidity++,C.positive++;break;case!1:C.negative++;break;case"NO_CONFIDENCE":C.no_confidence++}l.fatal&&C.mortality++}try{p$("#positive-samples").value=C.positive,p$("#negative-samples").value=C.negative,p$("#no_confidence-samples").value=C.no_confidence,p$("#morbidity-count").value=C.morbidity,p$("#mortality-count").value=C.mortality}catch(e){}isNull(_adp.projectId)&&(a=$.cookie(adminParams.domain+"_link"),_adp.projectId=md5(""+x+a+Date.now())),E={transectRing:geo.boundingBox,data:j,samples:C,dataSrc:""+helperDir+dataFileParams.filePath},null==("undefined"!=typeof _adp&&null!==_adp?_adp.data:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),window._adp.data={}),_adp.data.pushDataUpload=E,validateData(E,function(e){var a,t,o,n,r,i,s,l,c,d,p,u;for(p="",d=[],a=[],n=o=0,r=(s=e.validated_taxa).length;n<r;n++){u=(c=s[n]).genus+" "+c.species,null!=c.response.original_taxon&&(console.info("Taxon obj",c),i='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+(""+c.response.original_taxon.slice(0,1).toUpperCase()+c.response.original_taxon.slice(1))+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+u+"</em>' below. <a href=\""+c.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(i)),isNull(c.subspecies)||(u+=" "+c.subspecies),indexOf.call(d,u)<0&&(0<o&&(p+="\n"),p+=""+u,d.push(u));try{l=c.response.validated_taxon.family,indexOf.call(a,l)<0&&a.push(c.response.validated_taxon.family)}catch(e){console.warn("Couldn't get the family! "+(t=e).message,c.response),console.warn(t.stack)}++o}try{p$("#species-list").bindValue=p}catch(e){}if(dataAttrs.dataObj=e,_adp.data.dataObj=e,_adp.data.taxa={},_adp.data.taxa.list=d,_adp.data.taxa.clades=a,_adp.data.taxa.validated=e.validated_taxa,"function"!=typeof m&&!0!==m){try{f={downloadFile:"cleaned-dataset-"+Date.now()+".csv",selector:"#download-server-parsed-data"},downloadCSVFile(e,f)}catch(e){}return geo.requestCartoUpload(e,x,"create",function(e,a,t){return createMap2(a,t,function(){if(window.mapBuilder.points=[],$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length),"function"==typeof g)return g(e,a)})})}return"function"==typeof m?m(e,x):console.warn("Carto upload was skipped, but no callback provided")})}catch(e){console.error("Error parsing data - "+(p=e).message),console.warn(p.stack),stopLoadBarsError(null,'There was a problem parsing your data. Please check <a href="http://biscicol.org/biocode-fims/template" class="newwindow alert-link" data-newtab="true">biscicol.org FIMS requirements<span class="glyphicon glyphicon-new-window"></span></a>')}return!1},excelDateToUnixTime=function(e,a){var t,o,n;null==a&&(a=!1),n=(new Date).getUTCFullYear();try{if(!isNumber(e)){if(t=Date.parse(e),isNumber(t))return t;throw"Bad date error"}if(1863<=e&&e<=n)o=Date.parse(e+"-01-03");else if(0<e&&e<1e6){if(24107,o=86400*(e-25569)*1e3,!isNumber(o))throw console.warn("excelDateToUnixTime got bad number: "+e+" -> "+o),"Bad Number Error"}else o=Date.parse(e)}catch(e){o=!a&&Date.now()}return o},renderValidateProgress=function(e,a){var t;return null==e&&(e="#file-uploader-form"),null==a&&(a=!1),t='<div id="validator-progress-container" class="col-md-6 col-xs-12">\n  <label for="data-parsing">Data Parsing:</label><paper-progress id="data-parsing" class="blue" indeterminate></paper-progress>\n  <label for="data-validation">Data Validation:</label><paper-progress id="data-validation" class="cyan" indeterminate></paper-progress>\n  <label for="taxa-validation">Taxa Validation:</label><paper-progress id="taxa-validation" class="teal" indeterminate></paper-progress>\n  <label for="data-sync">Estimated Data Sync Progress:</label><paper-progress id="data-sync" indeterminate></paper-progress>\n  <br/><br/>\n  <button class="btn btn-danger" id="cancel-new-upload"><iron-icon icon="icons:cancel"></iron-icon> Cancel</button>\n</div>',$("#validator-progress-container").exists()||($(e).after(t),$("#cancel-new-upload").click(function(){return cancelAsyncOperation(this)})),!!a&&t},checkInitLoad=function(e){var a,t,o;if($("#please-wait-prefill").remove(),o=uri.o.param("id"),isNull(o))if(a="string"==typeof e?e:"object"==typeof e?e.do+":"+e.prop:uri.o.attr("fragment"),isNull(a))"function"==typeof e&&e();else switch(t=a.split(":"),console.info("Looking at fragment",a,t),t[0]){case"edit":loadEditor(t[1]);break;case"action":switch(t[1]){case"show-editable":loadEditor();break;case"create-project":loadCreateNewProject();break;case"show-viewable":loadProjectBrowser();break;case"show-su-viewable":loadSUProjectBrowser();break;case"show-su-profiles":loadSUProfileBrowser()}break;case"home":populateAdminActions()}else loadEditor(o);return!1},window.onpopstate=function(e){return console.log("State popped",e,e.state),checkInitLoad(e.state),!1},$(function(){$("#next").exists()&&$("#next").unbind().click(function(){return openTab(adminParams.adminPageUrl)}),loadJS("bower_components/bootstrap/dist/js/bootstrap.min.js",function(){return $("body").tooltip({selector:"[data-toggle='tooltip']"})}),checkFileVersion(!1,"js/admin.min.js"),$("paper-icon-button[icon='icons:dashboard']").removeAttr("data-href").unbind("click").click(function(){return populateAdminActions()});try{return checkFileVersion(!0,"js/kml.min.js")}catch(e){}}),kmlLoader=function(t,o){var e,a,n,r,i;try{if("object"==typeof t)t=(a=t).path;else try{a=JSON.parse(t),t=a.path}catch(e){try{a=JSON.parse(deEscape(t)),t=a.path}catch(e){511<t.length&&"object"==typeof(r=fixTruncatedJson(t))&&(t=(a=r).path),isNull(a)&&(a={path:t})}}console.debug("Loading KML file",t)}catch(e){}if(geo.inhibitKMLInit=!0,e=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(i=_adp.lastMod)?i.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),!$("google-map").exists()){if(n='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+('<google-map id="transect-viewport" class="col-xs-12 col-md-9 col-lg-6 kml-lazy-map" api-key="'+gMapsApiKey+'" map-type="hybrid">\n</google-map>')+"\n</div>",!$("#auth-block").exists())return console.warn("Couldn't find an authorization block to render the KML map in!"),!1;$("#auth-block").append(n),_adp.mapRendered=!0}return loadJS(e,function(){return initializeParser(null,function(){return loadKML(t,function(){var a,e;try{if(e=geo.kml.parser.docsByUrl[t],isNull(e)&&(t="/"+t,e=geo.kml.parser.docsByUrl[t],isNull(e)&&(console.warn("Could not resolve KML by url, using first doc"),e=geo.kml.parser.docs[0])),isNull(e))return allError("Bad KML provided"),!1;console.debug("Using parsed data from path '"+t+"'",e),"function"==typeof o?o(e):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(e){a=e,allError("There was a importing the data from this KML file"),console.warn(a.message),console.warn(a.stack)}return!1}),!1}),!1}),!1},loadEditor=function(e){var u,te;return startAdminActionHelper(),u=function(ae){var e,a;return startAdminActionHelper(),a=uri.urlString+"admin-page.html#edit:"+ae,e={do:"edit",prop:ae},history.pushState(e,"Editing #"+ae,a),startLoad(),window.projectParams={},window.projectParams.pid=ae,verifyLoginCredentials(function(e){var Q,ee,a;return a=e.detail,user=a.uid,Q="perform=get&project="+(ae=encodeURIComponent(ee=ae)),_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,Q,"json").done(function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y,w,_,j,k,x,P,D,S,C,A,L,T,E,I,O,N,M,F,B,U,H,R,z,J,q,W,G,V,Y,K,Z,X;try{if(console.info("Server said",e),!0!==e.status)return null==(f=null!=(B=e.human_error)?B:e.error)&&(f="Unidentified Error"),stopLoadError("There was a problem loading your project ("+f+")"),console.error("Couldn't load project! (POST OK) Error: "+e.error),console.warn("Attempted",adminParams.apiTarget+"?"+Q),!1;if(!0!==e.user.has_edit_permissions)return e.user.has_view_permissions||!0===e.project.public.toBool()?(loadProject(ee,"Ineligible to edit "+ee+", loading as read-only"),delay(1e3,function(){return loadProject(ae)})):alertBadProject(ee),!1;for((M=e.project).access_data.total=Object.toArray(M.access_data.total),M.access_data.total.sort(),M.access_data.editors_list=Object.toArray(M.access_data.editors_list),M.access_data.viewers_list=Object.toArray(M.access_data.viewers_list),M.access_data.editors=Object.toArray(M.access_data.editors),M.access_data.viewers=Object.toArray(M.access_data.viewers),console.info("Project access lists:",M.access_data),_adp.projectData=M,_adp.originalProjectId=M.project_id,_adp.fetchResult=e,V="",y=[],U=M.access_data.total,k=0,x=U.length;k<x;k++){user=U[k];try{if(G=M.access_data.composite[user].user_id,0<=indexOf.call(y,G))continue;y.push(G)}catch(e){}j="",user===M.access_data.author?j='<iron-icon icon="social:person"></iron-icon>':0<=indexOf.call(M.access_data.editors_list,user)?j='<iron-icon icon="image:edit"></iron-icon>':0<=indexOf.call(M.access_data.viewers_list,user)&&(j='<iron-icon icon="icons:visibility"></iron-icon>'),V+='<tr class="user-permission-list-row" data-user="'+G+'">\n  <td colspan="5">'+user+'</td>\n  <td class="text-center user-current-permission">'+j+"</td>\n</tr>"}j=M.public.toBool()?'<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>':'<iron-icon icon="icons:lock" class="material-red" data-toggle="tooltip" title="Private Project"></iron-icon>',F=M.public.toBool()?"\x3c!-- This project is already public --\x3e":e.user.is_author?'<div class="col-xs-12">\n  <paper-toggle-button id="public" class="project-params danger-toggle red">\n    <iron-icon icon="icons:warning"></iron-icon>\n    Make this project public\n  </paper-toggle-button> <span class="text-muted small">Once saved, this cannot be undone</span>\n</div>':"\x3c!-- This user does not have permission to toggle the public state of this project --\x3e",l=e.user.has_edit_permissions?"":"readonly",a=M.includes_anura.toBool()?"checked disabled":"disabled",r=M.includes_caudata.toBool()?"checked disabled":"disabled",v=M.includes_gymnophiona.toBool()?"checked disabled":"disabled";try{n=JSON.parse(deEscape(M.carto_id))}catch(e){console.error("Couldn't parse the carto JSON!",M.carto_id),stopLoadError("We couldn't parse your data. Please try again later."),n={}}"";try{o=Object.toArray(n.bounding_polygon)}catch(e){o=null}c={boundingBox:o,classes:"carto-data map-editor",bsGrid:"",skipPoints:!1,skipHull:!1,onlyOne:!0},geo.mapOptions=c,null==(null!=(H=n.bounding_polygon)?H.paths:void 0)&&(b='<google-map id="transect-viewport" latitude="'+M.lat+'" longitude="'+M.lng+'" fit-to-markers map-type="hybrid" disable-default-ui  api-key="'+gMapsApiKey+'">\n</google-map>'),null==b&&(b=""),geo.googleMapWebComponent=b,m=e.user.is_author?'<div class="card-actions">\n      <paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>\n    </div>':"",A=isNull(M.sample_notes)?"*No notes for this project*":M.sample_notes.unescape(),O='<h3>Project Notes</h3>\n<ul class="nav nav-tabs" id="markdown-switcher">\n  <li role="presentation" class="active" data-view="md"><a>Preview</a></li>\n  <li role="presentation" data-view="edit"><a>Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-notes" class="markdown-pair project-param language-markdown" rows="3" data-field="sample_notes" hidden '+l+">"+M.sample_notes+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="note-preview">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+A+"<\/script>\n</marked-element>",C=isNull(M.extended_funding_reach_goals)?"*No funding reach goals*":M.extended_funding_reach_goals.unescape(),h='<ul class="nav nav-tabs" id="markdown-switcher-funding">\n  <li role="presentation" class="active" data-view="md"><a>Preview</a></li>\n  <li role="presentation" data-view="edit"><a>Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-funding" class="markdown-pair project-param language-markdown" rows="3" data-field="extended_funding_reach_goals" hidden '+l+">"+M.extended_funding_reach_goals+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="preview-funding">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+C+"<\/script>\n</marked-element>";try{t=JSON.parse(M.author_data),d=new Date(toInt(t.entry_date))}catch(e){t={},(d={}).toLocaleString=function(){return"Error retrieving creation time"}}for(T="",E=M.sampling_months.split(","),I=[],S=_=0,P=E.length;S<P;S++)L=E[S],1<++_&&_===E.length?(2<E.length&&(T+=","),T+=" and "):1<_&&(T+=", "),isNumber(L)&&(I.push(L),L=dateMonthToString(L)),T+=L;for(_=0,K="",Z=M.sampling_years.split(","),X=[],N=_=0,D=Z.length;N<D;N++)Y=Z[N],++_,isNumber(Y)&&(X.push(toInt(Y)),1<_&&_===Z.length?(2<X.length&&(K+=","),K+=" and "):1<_&&(K+=", "),K+=Y);K=1===Z.length?"the year "+K:"the years "+K,Z=X,0!==toInt(M.sampled_collection_start)?(p=new Date(toInt(M.sampled_collection_start)),u=new Date(toInt(M.sampled_collection_end)),s=dateMonthToString(p.getMonth())+" "+p.getFullYear()+" &#8212; "+dateMonthToString(u.getMonth())+" "+u.getFullYear()):s="<em>(no data)</em>",(0===E.length||isNull(T))&&(T="<em>(no data)</em>"),(0===Z.length||isNull(K))&&(K="<em>(no data)</em>"),W=null!=(null!=n&&null!=(R=n.raw_data)?R.filePath:void 0)?"":"checked disabled",isNull(M.technical_contact)&&(M.technical_contact=t.name),isNull(M.technical_contact_email)&&(M.technical_contact_email=t.contact_email),w='<h2 class="clearfix newtitle col-xs-12">'+M.project_title+" "+j+' <paper-icon-button icon="icons:visibility" class="click" data-href="'+uri.urlString+"project.php?id="+ee+'" data-toggle="tooltip" title="View in Project Viewer" data-newtab="true"></paper-icon-button><br/><small>Project #'+ee+"</small></h2>\n"+F+'\n<section id="manage-users" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Collaborators" elevation="2">\n    <div class="card-content">\n      <table class="table table-striped table-condensed table-responsive table-hover clearfix" id="permissions-table">\n        <thead>\n          <tr>\n            <td colspan="5">User</td>\n            <td>Permissions</td>\n          </tr>\n        </thead>\n        <tbody>\n          '+V+'\n        </tbody>\n      </table>\n    </div>\n    <div class="card-actions">\n      <paper-button class="manage-users" id="manage-users-button">Manage Users</paper-button>\n    </div>\n  </paper-card>\n</section>\n<section id="project-basics" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Basics</h3>\n  <paper-input readonly label="Project Identifier" value="'+M.project_id+'" id="project_id" class="project-param"></paper-input>\n  <paper-input readonly label="Project Creation" value="'+d.toLocaleString()+'" id="project_creation" class="author-param" data-key="entry_date" data-value="'+t.entry_date+'"></paper-input>\n  <div class="row">\n    <paper-input readonly label="Project ARK" value="'+M.project_obj_id+'" id="project_creation" class="project-param col-xs-11"></paper-input>\n    '+getInfoTooltip("ARK or Archival Resource Key identifier is a persistent, citable identifier for this project and maybe used to cite these data in a publication or report. We use the California Digital Library Name Assigning Authority")+"\n  </div>\n  <paper-input "+l+' class="project-param" label="Project Title" value="'+M.project_title+'" id="project-title" data-field="project_title"></paper-input>\n  <paper-input '+l+' class="project-param" label="Primary Pathogen" value="'+M.disease+'" data-field="disease"></paper-input>\n  <paper-input '+l+' class="project-param" label="PI Lab" value="'+M.pi_lab+'" id="project-title" data-field="pi_lab"></paper-input>\n  <paper-input '+l+' class="project-param" label="Project Reference" value="'+M.reference_id+'" id="project-reference" data-field="reference_id"></paper-input>\n  <div class="row">\n    <paper-input '+l+' class="project-param col-xs-11" label="Publication DOI" value="'+M.publication+'" id="doi" data-field="publication"></paper-input>\n    '+getInfoTooltip("Publication DOI citing these datasets may be added here.")+"\n  </div>\n  <paper-input "+l+' class="author-param" data-key="name" label="Project Contact" value="'+t.name+'" id="project-contact"></paper-input>\n  <gold-email-input '+l+' class="author-param" data-key="contact_email" label="Contact Email" value="'+t.contact_email+'" id="contact-email"></gold-email-input>\n  <paper-input '+l+' class="author-param" data-key="diagnostic_lab" label="Diagnostic Lab" value="'+t.diagnostic_lab+'" id="project-lab"></paper-input>\n  <paper-input '+l+' class="author-param" data-key="affiliation" label="Affiliation" value="'+t.affiliation+'" id="project-affiliation"></paper-input>\n  <paper-input '+l+' class="project-param" label="Technical/Data Contact" value="'+M.technical_contact+'" data-field="technical_contact" id="technical-contact"></paper-input>\n  <gold-email-input '+l+' class="project-param" label="Technical/Data Contact_email" value="'+M.technical_contact_email+'" data-field="technical_contact_email" id="technical-contact-email"></gold-email-input>\n</section>\n<section id="notes" class="col-xs-12 col-md-8 clearfix">\n  '+O+'\n</section>\n<section id="data-management" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Data" elevation="2" id="data-card">\n    <div class="card-content">\n      <div class="variable-card-content">\n      Your project does/does not have data associated with it. (Does should note overwrite, and link to cartoParsed.raw_data.filePath for current)\n      </div>\n      <div id="append-replace-data-toggle">\n        <span class="toggle-off-label iron-label">Append/Amend Data\n          <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload a dataset, append all rows as additional data, and modify existing ones by sampleId"></span>\n        </span>\n        <paper-toggle-button id="replace-data-toggle" class="material-red" '+W+'>Replace Data</paper-toggle-button>\n        <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload data, archive current data and only have new data parsed"></span>\n      </div>\n      <div id="uploader-container-section">\n      </div>\n    </div>\n  </paper-card>\n  <paper-card class="clearfix" heading="Project Status" elevation="2" id="save-card">\n    <div class="card-content">\n      <p>Notice if there\'s unsaved data or not. Buttons below should dynamically disable/enable based on appropriate state.</p>\n    </div>\n    <div class="card-actions">\n      <paper-button id="save-project"><iron-icon icon="icons:save" class="material-green"></iron-icon> Save Project</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="reparse-project"><iron-icon icon="icons:cached" class="materialindigotext"></iron-icon> Re-parse Data, Save Project &amp; Reload</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="discard-changes-exit"><iron-icon icon="icons:undo"></iron-icon> Discard Changes &amp; Exit</paper-button>\n    </div>\n    '+m+'\n  </paper-card>\n</section>\n<section id="project-data" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Data Overview</h3>\n    <h4>Project Studies:</h4>\n      <paper-checkbox '+a+">Anura</paper-checkbox>\n      <paper-checkbox "+r+">Caudata</paper-checkbox>\n      <paper-checkbox "+v+'>Gymnophiona</paper-checkbox>\n      <paper-input readonly label="Sampled Species" value="'+M.sampled_species.split(",").sort().join(", ")+'"></paper-input>\n      <paper-input readonly label="Sampled Clades" value="'+M.sampled_clades.split(",").sort().join(", ")+'"></paper-input>\n      <p class="text-muted">\n        <span class="glyphicon glyphicon-info-sign"></span> There are '+M.sampled_species.split(",").length+" species in this dataset, across "+M.sampled_clades.split(",").length+' clades\n      </p>\n    <h4>Sample Metrics</h4>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken from '+s+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken in '+T+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were sampled in '+K+'</p>\n      <p class="text-muted"><iron-icon icon="icons:language"></iron-icon> The effective project center is at ('+roundNumberSigfig(M.lat,6)+", "+roundNumberSigfig(M.lng,6)+") with a sample radius of "+M.radius+"m and a resulting locality <strong class='locality'>"+M.locality+'</strong></p>\n      <p class="text-muted"><iron-icon icon="editor:insert-chart"></iron-icon> The dataset contains '+M.disease_positive+" positive samples ("+roundNumber(100*M.disease_positive/M.disease_samples)+"%), "+M.disease_negative+" negative samples ("+roundNumber(100*M.disease_negative/M.disease_samples)+"%), and "+M.disease_no_confidence+" inconclusive samples ("+roundNumber(100*M.disease_no_confidence/M.disease_samples)+'%)</p>\n    <h4 id="map-header">Locality &amp; Transect Data</h4>\n      <div id="carto-map-container" class="clearfix">\n      '+b+"\n      </div>\n  <h3>Project Meta Parameters</h3>\n    <h4>Project funding status</h4>\n      "+h+'\n      <div class="row markdown-pair" id="preview-funding">\n        <span class="pull-left" style="margin-top:1.75em;vertical-align:bottom;padding-left:15px">$</span><paper-input '+l+' class="project-param col-xs-11" label="Additional Funding Request" value="'+M.more_analysis_funding_request+'" id="more-analysis-funding" data-field="more_analysis_funding_request" type="number"></paper-input>\n      </div>\n</section>',$("#main-body").html(w),$(".pull-right paper-card .header").click(function(){return console.info("Clicked header, triggering collapse"),$(this).parent().toggleClass("collapsed")}),null!=(null!=(z=n.bounding_polygon)?z.paths:void 0)&&(i=new Point(M.lat,M.lng),geo.centerPoint=i,geo.mapOptions=c,createMap2([i],c,function(e){var a;if(geo.mapOptions.selector=e.selector,!$(e.selector).exists())return(a=function(){return $("#map-header").exists()?($("#map-header").after(e.html),b=e.html):delay(250,function(){return a()})})()}),n.bounding_polygon,b=null!=(J=geo.googleMapWebComponent)?J:"");try{p$("#project-notes").bindValue=M.sample_notes.unescape()}catch(e){}try{p$("#project-funding").bindValue=M.extended_funding_reach_goals.unescape()}catch(e){}return isNull(M.transect_file)||kmlLoader(M.transect_file,function(){return console.debug("Editor loaded KML file")}),q=p$("#project-notes").textarea,$(q).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),$("#markdown-switcher li").click(function(){var e;switch($("#markdown-switcher li").removeClass("active"),$("#markdown-switcher").parent().find(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),e=$(this).attr("data-view"),console.info("Switching to target view",e),e){case"md":$("#project-notes").attr("hidden","hidden");break;case"edit":$("#note-preview").attr("hidden","hidden")}return!1}),q=p$("#project-funding").textarea,$(q).keyup(function(){return p$("#preview-funding").markdown=$(this).val()}),$("#markdown-switcher-funding li").click(function(){var e;switch($("#markdown-switcher-funding li").removeClass("active"),$("#markdown-switcher-funding").parent().find(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),e=$(this).attr("data-view"),console.info("Switching to target view",e),e){case"md":$("#project-funding").attr("hidden","hidden");break;case"edit":$("#preview-funding").attr("hidden","hidden")}return!1}),$("#delete-project").click(function(){return'<paper-button id="confirm-delete-project" class="materialred">\n  <iron-icon icon="icons:warning"></iron-icon> Confirm Project Deletion\n</paper-button>',$(this).replaceWith('<paper-button id="confirm-delete-project" class="materialred">\n  <iron-icon icon="icons:warning"></iron-icon> Confirm Project Deletion\n</paper-button>'),$("#confirm-delete-project").click(function(){var a;return startLoad(),a=this,Q="perform=delete&id="+M.id,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,Q,"json").done(function(e){return!0===e.status?(stopLoad(),toastStatusMessage("Successfully deleted Project #"+M.project_id),delay(1e3,function(){return populateAdminActions()})):(stopLoadError(e.human_error),$(a).remove())}).fail(function(e,a){return console.error("Server error",e,a),stopLoadError("Error deleting project")}),!1}),!1}),$("#save-project").click(function(){return $("#confirm-delete-project").exists()&&('<paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>',$("#confirm-delete-project").replaceWith('<paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>')),saveEditorData(!0),!1}),$("#discard-changes-exit").click(function(){return te(),!1}),$("#reparse-project").click(function(){try{recalculateAndUpdateHull()}catch(e){}return revalidateAndUpdateData(),!1}),{top:$("#data-management").offset().top,bottom:0,target:window},$("paper-button#manage-users-button").click(function(){return popManageUserAccess(_adp.projectData)}),$(".danger-toggle").on("iron-change",function(){return $(this).get(0).checked?$(this).find("iron-icon").addClass("material-red"):$(this).find("iron-icon").removeClass("material-red")}),isNull(M.carto_id)?(console.warn("There is no carto data to load up for the editor"),startEditorUploader()):(console.info("Getting carto data with id "+M.carto_id+" and options",c),getProjectCartoData(M.carto_id,c))}catch(e){return g=e,stopLoadError("There was an error loading your project"),console.error("Unhandled exception loading project! "+g.message),console.warn(g.stack),loadEditor(),!1}}).fail(function(e,a){return console.error("AJAX failure: Error from server",e,a),stopLoadError("We couldn't load your project. Please try again."),loadEditor()})}),!1},null==e?(te=function(){var e,a;return a=uri.urlString+"admin-page.html#action:show-editable",e={do:"action",prop:"show-editable"},history.pushState(e,"Viewing Editable Projects",a),startLoad(),"perform=list",$.get(adminParams.apiTarget,"perform=list","json").done(function(e){var a,t,o,n,r,i,s,l,c,d,p;for(s in r='<h2 class="new-title col-xs-12">Editable Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(r),c=Object.toArray(e.public_projects),t=Object.toArray(e.authored_projects),o=Object.toArray(e.editable_projects),n=!(p=[]),d=e.projects)l=d[s],a=0<=indexOf.call(c,s)?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',i=0<=indexOf.call(t,s)?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author"></iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator"></iron-icon>',0<=indexOf.call(o,s)?(r='<li>\n  <button class="btn btn-primary" data-project="'+s+'">\n    '+a+" "+l+" / #"+s.substring(0,8)+"\n  </button>\n  "+i+"\n</li>",$("#project-list").append(r),n=!0):p.push(s);if(console.info("Didn't display read-only projects",p),!n){r='<p class="text-muted col-xs-12" id="no-edits-available">\n  Sorry, you have no projects you\'re eligible to edit.\n</p>',$("#project-list").before(r);try{verifyLoginCredentials(function(e){if(toInt(e.detail.userdata.su_flag).toBool())return console.info("NOTICE: This is an SUPERUSER Admin"),r='<button class="btn btn-xs btn-primary" id="su-view-projects">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:add"></iron-icon>\n  (SU) Administrate All Projects\n</button>',$("#no-edits-available").append(r),$("#su-view-projects").click(function(){return loadSUProjectBrowser()})})}catch(e){}}return $("#project-list button").unbind().click(function(){var e;return e=$(this).attr("data-project"),u(e)}),stopLoad()}).fail(function(e,a){return stopLoadError("There was a problem loading viable projects")})})():u(e),!1},popManageUserAccess=function(m,g){return null==m&&(m=_adp.projectData),null==g&&(g=_adp.fetchResult),verifyLoginCredentials(function(e){var a,t,o,n,r,i,s,l,c,d,p,u;for(console.info("Working with",g,e,m),u="",n=[],s=0,l=(c=m.access_data.total).length;s<l;s++)user=c[s],p=m.access_data.composite[user].user_id,0<=indexOf.call(n,p)||(n.push(p),d=user+" <span class='set-permission-block' data-user='"+p+"'>",a=(r=user===m.access_data.author)?"disabled":"data-toggle='tooltip' title='Grant Ownership'",d+='<paper-icon-button icon="image:edit" '+((i=0<=indexOf.call(m.access_data.editors_list,user))||r?"disabled":"data-toggle='tooltip' title='Make Editor'")+' class="set-permission" data-permission="edit" data-user="'+p+'" '+(t="data-current='"+(r?"author":i?"edit":"read")+"'")+'> </paper-icon-button>\n<paper-icon-button icon="icons:visibility" '+(!i||r?"disabled":"data-toggle='tooltip' title='Make Read-Only'")+' class="set-permission" data-permission="read" data-user="'+p+'" '+t+"> </paper-icon-button>",g.user.is_author&&(d+='<paper-icon-button icon="social:person" '+a+' class="set-permission" data-permission="author" data-user="'+p+'" '+t+"> </paper-icon-button>"),g.user.has_edit_permissions&&!r&&p!==g.user.user&&(d+='<paper-icon-button icon="icons:delete" class="set-permission" data-permission="delete" data-user="'+p+'" '+t+">\n</paper-icon-button>"),u+="<li>"+d+"</span></li>");return u='<ul class="simple-list">\n  '+u+"\n</ul>",1===m.access_data.total.length&&(u+='<div id="single-user-warning">\n  <iron-icon icon="icons:warning"></iron-icon> <strong>Head\'s-up</strong>: You can\'t change permissions when a project only has one user. Consider adding another user first.\n</div>'),o='<paper-dialog modal id="user-setter-dialog">\n  <h2>Manage "'+m.project_title+'" users</h2>\n  <paper-dialog-scrollable>\n    '+u+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button class="add-user" dialog-confirm><iron-icon icon="social:group-add"></iron-icon> Add Users</paper-button>\n    <paper-button class="close-dialog" dialog-dismiss>Done</paper-button>\n  </div>\n</paper-dialog>',$("#user-setter-dialog").remove(),$("body").append(o),userEmail=user,$(".set-permission").unbind().click(function(){var e,a,d,t,p,o;if(user=$(this).attr("data-user"),p=$(this).attr("data-permission"),d=$(this).attr("data-current"),this,"delete"!==p)o={changes:{0:{newRole:p,currentRole:d,uid:user}}};else{try{a=$(this).attr("data-confirm").toBool()}catch(e){a=!1}if(!a)return $(this).addClass("extreme-danger").attr("data-confirm","true"),!1;o={delete:{0:{currentRole:d,uid:user}}}}return startLoad(),t=jsonTo64(o),e="perform=editaccess&project="+window.projectParams.pid+"&deltas="+t,console.log("Would push args to",""+uri.urlString+adminParams.apiTarget+"?"+e),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,e,"json").done(function(e){var a,t,o,n,r,i,s,l,c;if(console.log("Server permissions alter said",e),!0!==e.status)return a=null!=(n=null!=(r=e.human_error)?r:e.error)?n:"We couldn't update user permissions",stopLoadError(a),!1;if("delete"!==p)$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+p+"']").attr("disabled","disabled").attr("data-current",p),$(".set-permission-block[data-user='"+user+"'] paper-icon-button:not([data-permission='"+p+"'])").removeAttr("disabled"),l=$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+p+"']").attr("icon"),$(".user-permission-list-row[data-user='"+{user:user}+"'] .user-current-permission iron-icon").attr("icon",l),toastStatusMessage(user+" granted "+p+" permissions");else{for(t in $(".set-permission-block[data-user='"+user+"']").parent().remove(),$(".user-permission-list-row[data-user='"+{user:user}+"']").remove(),toastStatusMessage("Removed "+user+" from project #"+window.projectParams.pid),o="read"===d?"viewers":"editors",delete _adp.projectData.access_data.composite[userEmail],i=_adp.projectData.access_data[o+"_list"]){c=i[t];try{if("object"!=typeof c)continue;c.user_id===user&&delete _adp.projectData.access_data[o+"_list"][t]}catch(e){}}for(t in s=_adp.projectData.access_data[o]){c=s[t];try{if("object"!=typeof c)continue;c.user_id===user&&delete _adp.projectData.access_data[o][t]}catch(e){}}}return _adp.projectData.access_data.raw=e.new_access_saved,stopLoad()}).fail(function(e,a){return console.error("Server error",e,a),stopLoadError("Problem changing permissions")}),!1}),$(".add-user").unbind().click(function(){return showAddUserDialog(m.access_data.total),!1}),safariDialogHelper("#user-setter-dialog"),!1})},showAddUserDialog=function(c){return'<paper-dialog modal id="add-new-user">\n<h2>Add New User To Project</h2>\n<paper-dialog-scrollable>\n  <p>Search by email, real name, or username below. Click on a search result to queue a user for adding.</p>\n  <div class="form-horizontal" id="search-user-form-container">\n    <div class="form-group">\n      <label for="search-user" class="sr-only form-label">Search User</label>\n      <input type="text" id="search-user" name="search-user" class="form-control"/>\n    </div>\n    <paper-material id="user-search-result-container" class="pop-result" hidden>\n      <div class="result-list">\n      </div>\n    </paper-material>\n  </div>\n  <p>Adding users:</p>\n  <ul class="simple-list" id="user-add-queue">\n    \x3c!--\n      <li class="list-add-users" data-uid="789">\n        jsmith@sample.com\n      </li>\n    --\x3e\n  </ul>\n</paper-dialog-scrollable>\n<div class="buttons">\n  <paper-button id="add-user"><iron-icon icon="social:person-add"></iron-icon> Save Additions</paper-button>\n  <paper-button dialog-dismiss>Cancel</paper-button>\n</div>\n</paper-dialog>',$("#add-new-user").exists()||$("body").append('<paper-dialog modal id="add-new-user">\n<h2>Add New User To Project</h2>\n<paper-dialog-scrollable>\n  <p>Search by email, real name, or username below. Click on a search result to queue a user for adding.</p>\n  <div class="form-horizontal" id="search-user-form-container">\n    <div class="form-group">\n      <label for="search-user" class="sr-only form-label">Search User</label>\n      <input type="text" id="search-user" name="search-user" class="form-control"/>\n    </div>\n    <paper-material id="user-search-result-container" class="pop-result" hidden>\n      <div class="result-list">\n      </div>\n    </paper-material>\n  </div>\n  <p>Adding users:</p>\n  <ul class="simple-list" id="user-add-queue">\n    \x3c!--\n      <li class="list-add-users" data-uid="789">\n        jsmith@sample.com\n      </li>\n    --\x3e\n  </ul>\n</paper-dialog-scrollable>\n<div class="buttons">\n  <paper-button id="add-user"><iron-icon icon="social:person-add"></iron-icon> Save Additions</paper-button>\n  <paper-button dialog-dismiss>Cancel</paper-button>\n</div>\n</paper-dialog>'),safariDialogHelper("#add-new-user"),$("#search-user").keyup(function(){return console.log("Should search",$(this).val()),function(){var l;if(l=$("#search-user").val(),isNull(l))return $("#user-search-result-container").prop("hidden","hidden");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().removeClass("has-success"),$("#search-user").parent().find(".help-block").remove()}catch(e){}return _adp.currentAsyncJqxhr=$.post(uri.urlString+"/api.php","action=search_users&q="+l,"json").done(function(e){var a,t,o,n,r,i,s;if(console.info(e),0<(s=Object.toArray(e.result)).length){for($("#user-search-result-container").removeAttr("hidden"),o="",n=0,r=s.length;n<r;n++)user=s[n],null!=_adp.projectData.access_data.composite[user.email]?(i='<iron-icon icon="icons:done-all" class="materialgreen round"></iron-icon>','<paper-badge for="'+user.uid+'-email" icon="icons:done-all" label="Already Added"> </paper-badge>',a="noclick"):a=i="",o+='<div class="user-search-result '+a+'" data-uid="'+user.uid+'" id="'+user.uid+'-result">\n  <span class="email search-result-detail" id="'+user.uid+'-email">'+i+user.email+'</span>\n    |\n  <span class="name search-result-detail" id="'+user.uid+'-name">'+user.full_name+'</span>\n    |\n  <span class="user search-result-detail" id="'+user.uid+'-handle">'+user.handle+"</span></div>";return $("#user-search-result-container").html(o),$(".user-search-result:not(.noclick)").click(function(){var e,a,t,o,n,r;for(r=$(this).attr("data-uid"),console.info("Clicked on "+r),e=$(this).find(".email").text(),null==("undefined"!=typeof _adp&&null!==_adp?_adp.currentQueueUids:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.currentQueueUids=[]),o=0,a=(n=$("#user-add-queue .list-add-users")).length;o<a;o++)user=n[o],_adp.currentQueueUids.push($(user).attr("data-uid"));return indexOf.call(c,e)<0?indexOf.call(_adp.currentQueueUids,r)<0?(t='<li class="list-add-users" data-uid="'+r+'">'+e+"</li>",$("#user-add-queue").append(t),$("#search-user").val(""),$("#user-search-result-container").prop("hidden","hidden")):(toastStatusMessage(e+" is already in the addition queue"),!1):(toastStatusMessage(e+" already has access to this project"),!1)})}$("#user-search-result-container").prop("hidden","hidden");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().removeClass("has-success"),$("#search-user").parent().find(".help-block").remove()}catch(e){}return t='<span class="help-block">\n  We couldn\'t find a user matching "'+l+'".\n  '+(/^(?:[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/im.test(l)?'<button class="btn btn-xs btn-primary add-listed-user"> Invite Them </button> ':"Finish the email address and we can invite them.")+"\n</span>",$("#search-user").after(t),$("#search-user").parent().addClass("has-error"),$(".add-listed-user").click(function(){var e;return startLoad(),e="action=invite&invitee="+l,$.post(uri.urlString+"/admin-api.php",e,"json").done(function(e){var a;!0!==e.status&&(a=function(){switch(e.error){case"INVALID_EMAIL":return e.target+" isn't a valid email";case"ALREADY_REGISTERED":return e.target+" already has an account";default:return console.error(e),"There was a problem sending the email"}}(),stopLoadError(a)),toastStatusMessage("Invitation sent");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().addClass("has-success"),$("#search-user").parent().find(".help-block").text("Invitation Sent to "+e.invited),$("#search-user").val("")}catch(e){}return stopLoad()}).fail(function(){return stopLoadError("Failed to contact the server")}),!1})}).fail(function(e,a){return console.error(e,a)})}.debounce()}),$("#add-user").click(function(){var e,a,t,o,u,m,n;for(startLoad(),m=[],u=[],a=0,t=(o=$("#user-add-queue .list-add-users")).length;a<t;a++)user=o[a],m.push($(user).attr("data-uid")),u.push(user);return m.length<1?(toastStatusMessage("Please add at least one user to the access list."),!1):(console.info("Saving list of "+m.length+" UIDs to "+window.projectParams.pid,m),n=jsonTo64({add:m}),e="perform=editaccess&project="+window.projectParams.pid+"&deltas="+n,console.log("Would push args to",adminParams.apiTarget+"?"+e),_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,e,"json").done(function(e){var a,t,o,n,r,i,s,l,c,d,p;if(console.log("Server permissions said",e),!0!==e.status)return a=null!=(i=null!=(s=e.human_error)?s:e.error)?i:"We couldn't update user permissions",stopLoadError(a),!1;for(stopLoad(),l=1===m.length?"viewer":"viewers",toastStatusMessage("Successfully added "+m.length+" "+l+" to the project"),$("#user-add-queue").empty(),'<iron-icon icon="icons:visibility"></iron-icon>',r=o=0,n=m.length;r<n;r++){c=m[r],user=u[o],console.info("Adding",user);try{d=user.text()}catch(e){d=$(user).text()}++o,t='<tr class="user-permission-list-row" data-user="'+c+'">\n  <td colspan="5">'+d+'</td>\n  <td class="text-center user-current-permission"><iron-icon icon="icons:visibility"></iron-icon></td>\n</tr>',$("#permissions-table").append(t),p={email:user,user_id:c,permission:"READ"};try{isArray(_adp.projectData.access_data.total)||(_adp.projectData.access_data.total=Object.toArray(_adp.projectData.access_data.total),_adp.projectData.access_data.viewers_list=Object.toArray(_adp.projectData.access_data.viewers_list),_adp.projectData.access_data.viewers=Object.toArray(_adp.projectData.access_data.viewers))}catch(e){}_adp.projectData.access_data.total.push(user),_adp.projectData.access_data.viewers_list.push(user),_adp.projectData.access_data.viewers.push(p),_adp.projectData.access_data.raw=e.new_access_saved,_adp.projectData.access_data.composite[user]=p}return p$("#add-new-user").close()}).fail(function(e,a){return console.error("Server error",e,a)}))}),!1},getProjectCartoData=function(L,T){var d,E,a,p,u,t,e;if("object"!=typeof L)try{E=JSON.parse(deEscape(L))}catch(e){t=(u=e).message;try{E=JSON.parse(L)}catch(e){if(u=e,511<L.length&&"object"==typeof(a=fixTruncatedJson(L))&&(console.debug("The carto data object was truncated, but rebuilt."),E=a),isNull(E))return console.error("cartoObj must be JSON string or obj, given",L),console.warn("Cleaned obj:",deEscape(L)),console.warn("Told",t,u.message),stopLoadError("Couldn't parse data"),!1}}else E=L;p=E.table,console.info("Working with Carto data base set",E);try{e=getMapZoom(E.bounding_polygon.paths,"#transect-viewport"),console.info("Got zoom",e),$("#transect-viewport").attr("zoom",e)}catch(e){}return isNull(p)?(console.warn("There's no assigned table, not pulling carto data"),stopLoad(),startEditorUploader()):(d="action=fetch&sql_query="+post64("SELECT * FROM "+p+" WHERE FALSE"),_adp.currentAsyncJqxhr=$.post("api.php",d,"json").done(function(a){var e,t,S,C,o,n,r,i,A,s,l,c;try{s=JSON.parse(a.post_response[0])}catch(e){return console.error("Couldn't load carto data! ("+(u=e).message+")",a),console.warn("post_response: (want key 0)",a.post_response),console.warn("Base data source:",E),console.warn(u.stack),stopLoadError("There was a problem talking to CartoDB. Please try again later"),startEditorUploader(),!1}for(A in o={},l=s.fields)c=l[A],o[A]=c;for(S in _adp.activeCols=o,n=[],C={},o)o[S],"id"!==S&&"the_geom"!==S&&n.push(S),C[S.toLowerCase()]=S;return _adp.colsList=n,_adp.colRemap=C,t="SELECT "+n.join(",")+", ST_asGeoJSON(the_geom) FROM "+p+";",console.info("Would ping cartodb with",t),e=encodeURIComponent(encode64(t)),d="action=fetch&sql_query="+e,_adp.currentAsyncJqxhr=$.post("api.php",d,"json").done(function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y,w,_,j,k,x,P,D;if(console.info("Carto query got result:",e),!e.status)return null==(n=null!=(m=e.human_error)?m:e.error)&&(n="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+n+")"),!1;for(r in j=e.parsed_responses[0].rows,_adp.cartoRows={},j)for(S in _=j[r],_adp.cartoRows[r]={},_)P=_[S],u=null!=(g=C[S])?g:S,_adp.cartoRows[r][u]=P;try{D=geo.googleMapWebComponent.slice(0,-13)}catch(e){D="<google-map>"}for(A in p=[],j)_=j[A],JSON.parse(_.st_asgeojson),s=_.decimallatitude,l=_.decimallongitude,(d=new Point(s,l)).infoWindow={},(d.data=_).diseasedetected=function(){switch(_.diseasedetected.toString().toLowerCase()){case"true":return"positive";case"false":return"negative";default:return _.diseasedetected.toString()}}(),c="",(k=_.genus+" "+_.specificepithet)!==_.originaltaxa&&(console.warn(k+" was changed from "+_.originaltaxa),c="(<em>"+_.originaltaxa+"</em>)"),i="<p>\n  <em>"+_.genus+" "+_.specificepithet+"</em> "+c+"\n  <br/>\n  Tested <strong>"+_.diseasedetected+"</strong> for "+_.diseasetested+"\n</p>",d.infoWindow.html=i,D+='<google-map-marker latitude="'+s+'" longitude="'+l+'" data-disease-detected="'+_.diseasedetected+'">\n'+i+"\n</google-map-marker>",p.push(d);if(_adp.workingProjectPoints=p,null==(null!=E&&null!=(f=E.bounding_polygon)?f.paths:void 0)||null==(null!=E&&null!=(h=E.bounding_polygon)?h.fillColor:void 0))try{_adp.canonicalHull=createConvexHull(p,!0);try{L={},null==E&&(E={}),null==E.bounding_polygon&&(E.bounding_polygon={}),E.bounding_polygon.paths=_adp.canonicalHull.hull,null==(a=E.bounding_polygon).fillOpacity&&(a.fillOpacity=defaultFillOpacity),null==(t=E.bounding_polygon).fillColor&&(t.fillColor=defaultFillColor),_adp.projectData.carto_id=JSON.stringify(E)}catch(e){}}catch(e){}return x=null!=(b=e.parsed_responses[0].total_rows)?b:0,0<p.length||0<(null!=T&&null!=(v=T.boundingBox)?v.length:void 0)?(T.skipHull=!1,0===p.length&&(o=null!=(y=null!=(w=geo.centerPoint)?w:[T.boundingBox[0].lat,T.boundingBox[0].lng])?y:[window.locationData.lat,window.locationData.lng],p.push(o)),T.onClickCallback=function(){return console.log("No callback for data-provided maps.")},createMap2(p,T,function(e){return'<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+x+"</span> sample points in this dataset</p>",$(e.selector).after,stopLoad()})):(console.info("Classic render.",T,p.length),D+='</google-map>\n<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+x+"</span> sample points in this dataset</p>",$("#transect-viewport").replaceWith(D),stopLoad())}).fail(function(e,a){return console.error("Couldn't talk to back end server to ping carto!"),stopLoadError("There was a problem communicating with the server. Please try again in a bit. (E-002)")}),window.dataFileparams=E.raw_data,E.raw_data.hasDataFile?(-1===(r=E.raw_data.filePath).search(helperDir)&&(r=""+helperDir+r),i='<p>\n  Your project already has data associated with it. <span id="last-modified-file"></span>\n</p>\n<button id="download-project-file" class="btn btn-primary center-block click download-file" data-href="'+r+'"><iron-icon icon="icons:cloud-download"></iron-icon> Download File</button>\n<p>You can upload more data below, or replace existing data of the same type.</p>\n<br/><br/>\n<p class="text-muted">\n  Allowed types (single type of each): <code>*.kml</code>, <code>*.kmz</code>, <code>*.xls</code>, <code>*.xlsx</code>\n  <br/>\n  Allowed types (inifinite copies): <code>image/*</code>, <code>*.pdf</code>, <code>*.7z</code>, <code>*.zip</code>\n</p>',$("#data-card .card-content .variable-card-content").html(i),d="do=get_last_mod&file="+r,console.info("Timestamp: ",uri.urlString+"meta.php?"+d),$.get("meta.php",d,"json").done(function(e){var a,t,o;return t=1e3*toInt(e.last_mod),console.log("Last modded",t,e),isNumber(t)?(o=""+(a=new Date(t).toISOString()).slice(0,a.search("T")),$("#last-modified-file").text("Last uploaded on "+o+"."),bindClicks()):console.warn("Didn't get a number back to check last mod time for "+r),!1}).fail(function(e,a){return console.warn("Couldn't get last mod time for "+r),!1})):($("#data-card .card-content .variable-card-content").html("<p>You can upload data to your project here:</p>"),$("#append-replace-data-toggle").attr("hidden","hidden")),startEditorUploader()}).fail(function(e,a){return!1})),!1},startEditorUploader=function(){return $("link[href='bower_components/neon-animation/animations/fade-out-animation.html']").exists()||('<link rel="import" href="bower_components/neon-animation/animations/fade-in-animation.html" />\n<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html" />',$("head").append('<link rel="import" href="bower_components/neon-animation/animations/fade-in-animation.html" />\n<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html" />')),bootstrapUploader("data-card-uploader","",function(){return window.dropperParams.postUploadHandler=function(e,a){var t,o,n,r,i,s,l,c,d,p,u;try{d="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",i=a.full_path.split("/").pop(),u=a.wrote_thumb,c=a.mime_provided.split("/")[0],l=a.mime_provided.split("/")[1],(s=e.size<5242880||"image"!==c?""+d+a.wrote_file:""+d+u).slice(0),r=s.slice(0).split(".").pop()}catch(e){console.warn("Warning - "+(n=e).message),console.warn(n.stack)}if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof a)return console.error("Dropzone returned an error - "+a),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(!0!==a.status)return null==a.human_error&&(a.human_error="There was a problem uploading your image."),toastStatusMessage(""+a.human_error),console.error("Error uploading!",a),!1;if(t=["vnd.google-earth.kml+xml","vnd.google-earth.kmz","xml"],0<=indexOf.call(t,l))return"kml"===r||"kmz"===r?kmlHandler(s,function(a){var e;e={path:s,data:a};try{_adp.projectData.transect_file=JSON.stringify(e)}catch(e){n=e;try{console.warn("Couldn't stringify json - "+n.message,s,a)}catch(e){}_adp.projectData.transect_file=s}return bsAlert("Your KML will take over your current bounding polygon once you save and refresh this page")}):(console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+l),!1);try{switch(o='  <paper-dialog modal id="upload-progress-dialog"\n    entry-animation="fade-in-animation"\n    exit-animation="fade-out-animation">\n    <h2>Upload Progress</h2>\n    <paper-dialog-scrollable>\n      <div id="upload-progress-container" style="min-width:80vw; ">\n      </div>\n      '+renderValidateProgress("dont-exist",!0)+'\n<p class="col-xs-12">Species in dataset</p>\n<iron-autogrow-textarea id="species-list" class="project-field  col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    </paper-dialog-scrollable>\n    <div class="buttons">\n      <paper-button id="close-overlay">Close &amp; Cancel</paper-button>\n      <paper-button id="save-now-upload" disabled>Save</paper-button>\n    </div>\n  </paper-dialog>',$("#upload-progress-dialog").remove(),$("body").append(o),p$("#upload-progress-dialog").open(),$("#close-overlay").click(function(){return cancelAsyncOperation(this),p$("#upload-progress-dialog").close()}),console.info("Server returned the following result:",a),console.info("The script returned the following file information:",e),d="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",i=a.full_path.split("/").pop(),u=a.wrote_thumb,c=a.mime_provided.split("/")[0],l=a.mime_provided.split("/")[1],s=e.size<5242880||"image"!==c?""+d+a.wrote_file:""+d+u,p=function(){switch(c){case"image":return'<div class="uploaded-media center-block" data-system-file="'+i+'">\n  <img src="'+s+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+e.name+" -> "+i+'\n  (<a href="'+s+'" class="newwindow" download="'+e.name+'">\n    Original Image\n  </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+i+'">\n  <audio src="'+s+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+e.name+" -> "+i+'\n    (<a href="'+s+'" class="newwindow" download="'+e.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+i+'">\n  <video src="'+s+'" controls preload="auto">\n    <img src="'+d+u+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+e.name+" -> "+i+'\n    (<a href="'+s+'" class="newwindow" download="'+e.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+i+'" data-link-path="'+s+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+e.name+" -> "+i+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(p),$("#validator-progress-container").remove(),c){case"application":switch(console.info("Checking "+l+" in application"),l){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":excelHandler2(s);break;case"zip":case"x-zip-compressed":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e.type||"xlsx"===s.split(".").pop()?excelHandler2(s):(zipHandler(s),p$("#upload-progress-dialog").close());break;case"x-7z-compressed":_7zHandler(s),p$("#upload-progress-dialog").close();break;case"vnd.google-earth.kml+xml":case"vnd.google-earth.kmz":case"xml":if("kml"!==r&&"kmz"!==r)return console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+l),p$("#upload-progress-dialog").close(),!1;kmlHandler(s),p$("#upload-progress-dialog").close();break;default:return console.warn("Unknown mime type application/"+l),allError("Sorry, we can't processes files of type application/"+l),p$("#upload-progress-dialog").close(),!1}break;case"text":csvHandler(),p$("#upload-progress-dialog").close();break;case"image":imageHandler(),p$("#upload-progress-dialog").close()}}catch(e){n=e,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}return!1}}),!1},excelHandler2=function(o,e,n){var a,r,t;return null==e&&(e=!0),startLoad(),$("#validator-progress-container").remove(),t=helperDir+"excelHelper.php",-1!==(r=o).search(helperDir)&&(console.info("removing '"+helperDir+"'"),r=o.slice(helperDir.length)),console.info("Pinging for "+r),a="action=parse&path="+r+"&sheets=Samples",$.get(t,a,"json").done(function(e){var t,a;return console.info("Got result",e),!1===e.status?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):($("#upload-data").attr("disabled","disabled"),a=o.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=a.pop(),dataFileParams.filePath=r,Object.size(e.data),uploadedData=e.data,_adp.parsedUploadedData=e.data,"function"!=typeof n?p$("#replace-data-toggle").checked?(startLoad(),revalidateAndUpdateData(!1,!1,!1,!1,!0),console.info("Starting newGeoDataHandler to handle a replacement dataset"),_adp.projectIdentifierString="t"+md5(_adp.projectId+_adp.projectData.author+Date.now()),t='<div class="row">\n<div class="alert alert-info col-xs-12" id="still-processing">\n  Please do not close this window until your upload has finished. As long as this message is showing, your processing is still incomplete.\n</div>\n</div>',$("#validator-progress-container").before(t),newGeoDataHandler(e.data,!1,function(e,a){return console.info("Upload and save complete",e),startLoad(),finalizeData(!0,function(e){return e.project_id=_adp.originalProjectId,_adp.reassignedTrashProjectId=_adp.projectId,_adp.projectId=_adp.originalProjectId,console.info("Successfully finalized data",e),$("#still-processing").remove(),t='<div class="row">\n<div class="alert alert-warning center-block text-center col-xs-8 force-center">\n  <strong>IMPORTANT</strong>: Remember to save your project after closing this window!<br/><br/>\n    If you don\'t, your new data <em>will not be saved</em>!\n</div>\n</div>',$("#validator-progress-container").before(t),_adp.projectData=e,$("#save-now-upload").click(function(){return saveEditorData(!0,function(){return document.location.reload})}).removeAttr("disabled"),stopLoad()})})):(console.info("Starting revalidateAndUpdateData to handle an update"),revalidateAndUpdateData(e)):(console.warn("Skipping Revalidator() !"),n(e)),stopLoad())}).fail(function(e,a){var t;return console.error("Couldn't POST"),console.warn(e),console.warn(a),t="<code>"+e.status+" "+e.statusText+"</code>",stopLoadBarsError("There was a problem with the server handling your data. The server said: "+t),delay(500,function(){return stopLoad()})}),!1},revalidateAndUpdateData=function(e,re,ie,se,a){var le,t,o,n,r,i,s,l,c;if(null==e&&(e=!1),null==re&&(re=!1),null==ie&&(ie=!1),null==se&&(se=!1),null==a&&(a=!1),$("#upload-progress-dialog").exists()||(o='  <paper-dialog modal id="upload-progress-dialog"\n    entry-animation="fade-in-animation"\n    exit-animation="fade-out-animation">\n    <h2>Upload Progress</h2>\n    <paper-dialog-scrollable>\n      <div id="upload-progress-container" style="min-width:80vw; ">\n      </div>\n      '+renderValidateProgress("dont-exist",!0)+'\n<p class="col-xs-12">Species in dataset</p>\n<iron-autogrow-textarea id="species-list" class="project-field  col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    </paper-dialog-scrollable>\n    <div class="buttons">\n      <paper-button id="close-overlay">Close &amp; Cancel</paper-button>\n      <paper-button id="save-now-upload" disabled>Save</paper-button>\n    </div>\n  </paper-dialog>',$("#upload-progress-dialog").remove(),$("body").append(o),$("#close-overlay").click(function(){return cancelAsyncOperation(this),p$("#upload-progress-dialog").close()})),safariDialogHelper("#upload-progress-dialog"),a)return!1;try{le=JSON.parse(_adp.projectData.carto_id.unescape()),_adp.cartoData=le}catch(e){n=$.cookie(uri.domain+"_link"),le={table:_adp.projectIdentifierString+"_"+n,bounding_polygon:{}}}return(c=!1)!==e?"object"==typeof e?(c=!0,r=e.data,i=e.path.requested_path):i=e:null==(i=_adp.projectData.sample_raw_data.slice(uri.urlString.length))&&(i=null!=(null!=dataFileParams?dataFileParams.filePath:void 0)?dataFileParams.filePath:le.raw_data.filePath),_adp.projectIdentifierString=le.table.split("_")[0],_adp.projectId=_adp.projectData.project_id,null==(null!=(s=_adp.fims)&&null!=(l=s.expedition)?l.expeditionId:void 0)&&(_adp.fims={expedition:{expeditionId:26,ark:_adp.projectData.project_obj_id}}),t=function(ne){var e,a;return e=["edit","create"],a=p$("#replace-data-toggle").checked?"create":"edit",indexOf.call(e,a)<0?(console.error(a+" is not an allowed operation on a data set!"),console.info("Allowed operations are ",e),toastStatusMessage("Sorry, '"+a+"' isn't an allowed operation.")):newGeoDataHandler(ne,"create"===a?function(e,a){return geo.requestCartoUpload(e,a,"create",function(e,a,t){bsAlert("Hang on for a moment while we reprocess this for saving","info"),le.table=geo.dataTable;try{isArray(points)&&(le=recalculateAndUpdateHull())}catch(e){}return _adp.projectData.carto_id=JSON.stringify(le),i=dataFileParams.filePath,revalidateAndUpdateData(i),!1}),!1}:function(ae,e){var te,oe,a,t;return console.info("Ready to update",ae),oe=le.table,"object"!=typeof(ne=ae.data)?(console.info("This function requires the base data to be a JSON object."),toastStatusMessage("Your data is malformed. Please double check your data and try again."),!1):isNull(oe)?(console.error("Must use a defined table name!"),toastStatusMessage("You must name your data table"),!1):(n=$.cookie(uri.domain+"_link"),a=$.cookie(uri.domain+"_auth"),t=$.cookie(uri.domain+"_secret"),null==n||null==a||null==t?(console.error("You're not logged in. Got one or more invalid tokens for secrets.",n,a,t),toastStatusMessage("Sorry, you're not logged in. Please log in and try again."),!1):(te="hash="+a+"&secret="+t+"&dblink="+n,null==("undefined"!=typeof adminParams&&null!==adminParams?adminParams.apiTarget:void 0)?(console.warn("Administration file not loaded. Upload cannot continue"),stopLoadError("Administration file not loaded. Upload cannot continue")):_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,te,"json").done(function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,J,g,f,h,q,b,v,y,w,_,j,k,x,P,D,S,C,A,L,T,E,I,O,N,M,F,B,W,U,H,R,z,G,V,Y,K,Z,X,Q,ee;if(e.status){for(D in console.info("Validated data",ae),H=[],y=[],k=[],ne){for(s in j=[],W=ne[D])switch(Q=W[s],s){case"decimalLongitude":j[1]=Q,k.push(Q);break;case"decimalLatitude":j[0]=Q,y.push(Q)}H.push(j)}o=null!=(S=y.max())?S:0,n=null!=(C=y.min())?C:0,t=null!=(A=k.max())?A:0,m=[[o,r=null!=(L=k.min())?L:0],[o,t],[n,t],[n,r]];try{for(K="string"==typeof ne.transectRing?JSON.parse(ae.transectRing):ae.transectRing,K=Object.toArray(K),v=q=0,w=K.length;v<w;v++){if((p=K[v])instanceof Point&&(p=p.toGeoJson(),K[q]=p),2!==p.length)throw{message:"Bad coordinate length for '"+p+"'"};for(P=0,_=p.length;P<_;P++)if(d=p[P],!isNumber(d))throw{message:"Bad coordinate number '"+d+"'"};++q}}catch(e){console.warn("Error parsing the user transect ring - "+(J=e).message),K=void 0}"ST_AsBinary("+JSON.stringify({type:"GeometryCollection",geometries:[{type:"MultiPoint",coordinates:H},{type:"Polygon",coordinates:null!=K?K:m}]})+", 4326)",l=getColumnObj();try{for(q in x={},T=_adp.cartoRows){U=null!=(E=(W=T[q]).sampleId)?E:W.sampleid;try{Y=U.trim()}catch(e){continue}x[U=Y=Y.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2")]=q}}catch(e){console.warn("Couldn't make lookupMap")}for(q in R="",[],(c=[]).push("id int"),_adp.rowsCount=Object.size(ne),_adp.lookupMap=x,ne){W=ne[q],ee=[],0,g={type:"Point",coordinates:[]},(q=toInt(q))+1,U=W.sampleId;try{F=x[U]}catch(e){}for(s in(M=null)!=F&&(M=_adp.cartoRows[F]),i=[],W){Q=W[s],0===q&&c.push(s+" "+l[s]);try{Q=Q.replace("'","&#95;")}catch(e){}switch(s){case"decimalLongitude":g.coordinates[1]=Q;break;case"decimalLatitude":g.coordinates[0]=Q;break;case"sampleId":if(null!=M)continue}if(null!=M){if("object"==typeof(B=null!=(I=M[s])?I:M[s.toLowerCase()])){if("string"==typeof Q)try{X=JSON.parse(Q)}catch(e){}else X=Q;for(b in 10,X)"number"==typeof(Z=X[b])&&(X[b]=roundNumber(Z,10));for(b in B)"number"==typeof(Z=B[b])&&(B[b]=roundNumber(Z,10));if(u=JSON.stringify(X),(B=JSON.stringify(B))===u)continue;console.info("No Object Match:",B,u)}if("boolean"==typeof Q)a=B.toBool();else if("boolean"==typeof B)a=B.toString();else if("number"==typeof B)a=""+B;else if("number"==typeof Q)a=toFloat(B);else if("null"===B)a=null;else if(null===B)a="null";else try{a=B.replace("T00:00:00Z","")}catch(e){a=void 0}if(B===Q||a===Q)continue;console.info("Not skipping for",B,a,"on "+W.sampleId+" @ "+s+" = ",Q)}"string"==typeof Q?null!=M?ee.push(s.toLowerCase()+"='"+Q+"'"):ee.push("'"+Q+"'"):isNull(Q)?null!=M?ee.push(s.toLowerCase()+"=null"):ee.push("null"):null!=M?ee.push(s.toLowerCase()+"="+Q):ee.push(Q),i.push(s)}f="ST_SetSRID(ST_Point("+g.coordinates[1]+","+g.coordinates[0]+"),4326)",null!=M?(h=JSON.stringify(g),(N=null!=(O=M.the_geom)?O:M.st_asgeojson)!==h&&(console.info("Not skipping coords",N,g,h),ee.push("the_geom="+f))):(i.push("the_geom"),ee.push(f)),0!==ee.length&&(null!=M?(z=" WHERE sampleid='"+U+"';",R+="UPDATE "+oe+" SET "+ee.join(", ")+" "+z):R+="INSERT INTO "+oe+" ("+i.join(",")+") VALUES ("+ee.join(",")+"); ")}return G=(V=R.split(";")).length-1,console.log(V),console.info("Running "+G+" statements"),!0===ie?(console.warn("Exiting before carto post because testOnly is set true"),!1):(geo.postToCarto(R,oe,function(e,a,t){var o;console.info("Post carto callback fn"),bsAlert("<strong>Please Wait</strong>: Re-Validating your total taxa data","info");try{p$("#taxa-validation").value=0,p$("#taxa-validation").indeterminate=!0}catch(e){}return _adp.canonicalHull=createConvexHull(a,!0),le.bounding_polygon.paths=_adp.canonicalHull.hull,_adp.projectData.carto_id=JSON.stringify(le),o="SELECT "+_adp.colsList.join(",")+", ST_asGeoJSON(the_geom) FROM "+oe+";",te="action=fetch&sql_query="+post64(o),_adp.currentAsyncJqxhr=$.post("api.php",te,"json").done(function(e){var a,t,o,n,r,i,s,l;if(console.info("Carto query got result:",e),!e.status)return null==(t=null!=(r=e.human_error)?r:e.error)&&(t="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+t+")"),!1;for(q in s=e.parsed_responses[0].rows,_adp.cartoRows={},s)for(a in W=s[q],_adp.cartoRows[q]={},W)l=W[a],n=null!=(i=_adp.colRemap[a])?i:a,_adp.cartoRows[q][n]=l;o={data:_adp.cartoRows};try{p$("#taxa-validation").indeterminate=!1}catch(e){}return validateTaxonData(o,function(e){var o,a,t,n,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y,w,_,j,k,x,P,D,S,C,A,L,T,E,I,O,N,M,F,B,U,H,R,z;for(ae.validated_taxa=e.validated_taxa,_adp.projectData.includes_anura=!1,_adp.projectData.includes_caudata=!1,_adp.projectData.includes_gymnophiona=!1,w=0,g=(j=ae.validated_taxa).length;w<g&&(a=j[w].response.validated_taxon,console.info("Aweb taxon result:",a),m="includes_"+a.order.toLowerCase(),!(_adp.projectData[m]=!0)===_adp.projectData.includes_anura||!1===_adp.projectData.includes_caudata||!1===_adp.projectData.includes_gymnophiona);w++);for(F="",M=[],r=[],_=q=0,f=(k=ae.validated_taxa).length;_<f;_++){B=(N=k[_]).genus+" "+N.species,null!=N.response.original_taxon&&(console.info("Taxon obj",N),y='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+(""+N.response.original_taxon.slice(0,1).toUpperCase()+N.response.original_taxon.slice(1))+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+B+"</em>' below. <a href=\""+N.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(y)),isNull(N.subspecies)||(B+=" "+N.subspecies),indexOf.call(M,B)<0&&(0<q&&(F+="\n"),F+=""+B,M.push(B));try{x=N.response.validated_taxon.family,indexOf.call(r,x)<0&&r.push(N.response.validated_taxon.family)}catch(e){console.warn("Couldn't get the family! "+(J=e).message,N.response),console.warn(J.stack)}++q}try{p$("#species-list").bindValue=F}catch(e){}for(dataAttrs.dataObj=ae,_adp.data.dataObj=ae,_adp.data.taxa={},_adp.data.taxa.list=M,_adp.data.taxa.clades=r,_adp.data.taxa.validated=ae.validated_taxa,_adp.projectData.sampled_species=M.join(","),_adp.projectData.sampled_clades=r.join(","),_adp.projectData.disease_morbidity=ae.samples.morbidity,_adp.projectData.disease_mortality=ae.samples.mortality,_adp.projectData.disease_positive=ae.samples.positive,_adp.projectData.disease_negative=ae.samples.negative,_adp.projectData.disease_no_confidence=ae.samples.no_confidence,_adp.projectData.disease_samples=_adp.rowsCount,n=getMapCenter(geo.boundingBox),s=[],v=[],z=[],[],t=[],I=[],l=[],O=[],U=d=0,h=(P=Object.toArray(_adp.cartoRows)).length;U<h;U++)i=(W=P[U]).dateidentified,R=excelDateToUnixTime(i),s.push(R),H=new Date(R),b=dateMonthToString(H.getUTCMonth()),indexOf.call(v,b)<0&&v.push(b),D=H.getFullYear(),indexOf.call(z,D)<0&&z.push(H.getFullYear()),null!=W.catalogNumber&&t.push(W.catalognumber),I.push(W.sampleid),T=W.decimallatitude,E=W.decimallongitude,d<(c=geo.distance(T,E,n.lat,n.lng))&&(d=c),null!=W.samplemethod&&(S=W.samplemethod,indexOf.call(O,S)<0&&O.push(W.samplemethod)),null!=W.specimendisposition&&(C=W.specimendisposition,indexOf.call(l,C)<0&&l.push(W.sampledisposition));console.info("Got date ranges",s),v.sort(),z.sort(),_adp.projectData.sampled_collection_start=s.min(),_adp.projectData.sampled_collection_end=s.max(),console.info("Collected from",s.min(),s.max()),_adp.projectData.sampling_months=v.join(","),_adp.projectData.sampling_years=z.join(","),_adp.projectData.sample_catalog_numbers=t.join(","),_adp.projectData.sample_field_numbers=I.join(","),_adp.projectData.sample_methods_used=O.join(",");try{recalculateAndUpdateHull()}catch(e){}return p=function(){return _adp.skipRead=!0,_adp.dataBu=_adp.projectData,!0===se?(console.warn("Save skipped on flag!"),console.info("Project data",_adp.projectData)):saveEditorData(!0,function(){if(!0===re&&console.info("Saved",_adp.projectData,dataBu),null==localStorage._adp)return document.location.reload(!0)}),!1},(u=""+uri.urlString+ae.dataSrc)!==_adp.projectData.sample_raw_data?(o=_adp.projectData.dataset_arks.split(","),null==(null!=(A=_adp.fims)&&null!=(L=A.expedition)?L.ark:void 0)&&(null==_adp.fims&&(_adp.fims={}),null==_adp.fims.expedition&&(_adp.fims.expedition={}),_adp.fims.expedition.ark=_adp.projectData.project_obj_id),null!=_adp.originalProjectId&&(_adp.projectId===_adp.originalProjectId&&_adp.projectData.project_id===_adp.originalProjectId||(_adp.projectId=_adp.originalProjectId,_adp.projectData.project_id=_adp.originalProjectId)),_adp.projectData.project_id!==_adp.projectId&&(_adp.projectId=_adp.projectData.project_id),mintBcid(_adp.projectId,u,_adp.projectData.project_title,function(e){var a,t;return null!=e.ark?(a=u.split("/").pop(),t=e.ark+"::"+a,o.push(t),_adp.projectData.dataset_arks=o.join(",")):console.warn("Couldn't mint!"),_adp.previousRawData=_adp.projectData.sample_raw_data,_adp.projectData.sample_raw_data=u,p()})):p(),!1}),!1}).fail(function(e,a){return stopLoadError("Error fetching updated table")}),!1}),!1)}return stopLoadError("Invalid user")}).fail(function(e,a){return stopLoadError("Error updating Carto")}),!1))}),!1},c?t(r):excelHandler2(i,!0,function(e){var a;return a=e.data,t(a)}),!1},recalculateAndUpdateHull=function(e){var a,t,o,n,r,i,s,l,c,d,p,u;null==e&&(e=_adp.workingProjectPoints),null==e&&console.error("Can't run without points!"),_adp.projectPreModBackup=_adp.projectData;try{localStorage.projectPreModBackup=JSON.stringify(_adp.projectData)}catch(e){}if(_adp.canonicalHull=createConvexHull(e,!0),isNull(_adp.canonicalHull))return!1;for(u=[],o=0,n=(s=_adp.canonicalHull.hull).length;o<n;o++)i=s[o],u.push(i.getObj());try{a=JSON.parse(_adp.projectData.carto_id)}catch(e){a={}}return r=null!=(l=null!=(c=a.bounding_polygon)?c.fillOpacity:void 0)?l:defaultFillOpacity,t=null!=(d=null!=(p=a.bounding_polygon)?p.fillColor:void 0)?d:defaultFillColor,console.warn("Overwriting cartoData",a),a.bounding_polygon={paths:_adp.canonicalHull.hull,fillOpacity:r,fillColor:t},_adp.projectData.carto_id=JSON.stringify(a),a},remintArk=function(){var e;return e=_adp.projectData.project_title.trim(),mintExpedition(_adp.projectData.project_id,e,function(e){if(!0===e.status)return _adp.projectData.project_obj_id=e.ark.identifier,console.log("New ARK:",_adp.projectData.project_obj_id),console.warn("The save may not update the ARK -- it may have to be manually changed in the database"),saveEditorData(!0)})},saveEditorData=function(e,a){var n,t,o,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y,w,_,j,k,x,P,D,S,C,A,L,T,E,I,O,N,M,F,B,U,H,R,z;if(null==e&&(e=!1),startLoad(),$(".hanging-alert").remove(),e||null==localStorage._adp){S=_adp.projectData;try{S.access_data=_adp.projectData.access_data.raw}catch(e){}if(!0!==_adp.skipRead){for(m=0,g=(A=$(".project-param:not([readonly])")).length;m<g;m++)c=A[m],u=$(c).attr("data-field"),isNull(u)||(S[u]=p$(c).value.unescape());for(t={},_=0,f=(L=$(".author-param")).length;_<f;_++)c=L[_],t[u=$(c).attr("data-key")]=null!=(T=$(c).attr("data-value"))?T:p$(c).value;S.author_data=JSON.stringify(t)}_adp.postedSaveData=S,_adp.postedSaveTimestamp=Date.now()}else window._adp=JSON.parse(localStorage._adp),S=_adp.postedSaveData;for(u in S){i=S[u];try{S[u]=deEscape(i)}catch(e){}}if(p=!1,$("paper-toggle-button#public").exists()&&(S.public=p$("paper-toggle-button#public").checked,S.public)){p=!0;try{recalculateAndUpdateHull(),S.carto_id=_adp.projectData.carto_id}catch(e){}}null!=_adp.originalProjectId&&_adp.originalProjectId!==_adp.projectId&&(console.warn("Mismatched IDs!",_adp.originalProjectId,_adp.projectId),S.project_id=_adp.originalProjectId);try{j=4e3;try{P=(r=JSON.parse(S.carto_id)).bounding_polygon.paths}catch(e){P=[]}try{U=(F=JSON.parse(S.transect_file)).data.parameters.paths}catch(e){U=[]}o=Object.size(P);try{for(E=r.bounding_polygon.multibounds,x=0,h=E.length;x<h;x++)k=E[x],o+=Object.size(k)}catch(e){}B=Object.size(U);try{for(I=F.data.polys,C=0,b=I.length;C<b;C++)k=I[C],B+=Object.size(k)}catch(e){}if(j<(D=o+B)){if(console.warn("Danger: Have "+D+" paths. The recommended max is "+j),B===o){F.data.parameters.paths="SEE_BOUNDING_POLY";try{for(d=0,O=F.data.polys,H=0,v=O.length;H<v;H++)O[H],F.data.polys[d]="SEE_BOUNDING_POLY",++d}catch(e){}S.transect_file=JSON.stringify(F),B=F.data.parameters.paths.length}try{r.bounding_polygon.paths=!1,S.carto_id=JSON.stringify(r),o=0}catch(e){}try{for(N=r.bounding_polygon.multibounds,R=0,y=N.length;R<y;R++)k=N[R],o+=Object.size(k)}catch(e){}try{for(M=F.data.polys,z=0,w=M.length;z<w;z++)k=M[z],B+=Object.size(k)}catch(e){}console.debug("Shrunk to reduced data size "+(D=o+B)+". May have compatability errors.")}}catch(e){console.error("Couldn't check path count -- "+(l=e).message+". Faking it."),D=j+1}return S.modified=Date.now()/1e3,console.log("Sending to server",S),n="perform=save&data="+jsonTo64(S),s=delay(1e4,function(){return console.warn("POST may have hung after 10 seconds"),console.warn("args length was '"+n.length+"' = "+8*n.length+" bytes"),!1}),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,n,"json").done(function(e){var a,t,o,n,r;return console.info("Save result: server said",e),!0!==e.status?(t=null!=(n=null!=(r=e.human_error)?r:e.error)?n:"There was an error saving to the server",stopLoadError("There was an error saving to the server"),localStorage._adp=JSON.stringify(_adp),bsAlert("<strong>Save Error:</strong> "+t+". An offline backup has been made.","danger"),console.error(e.error),!1):(stopLoad(),toastStatusMessage("Save successful"),a=(new Date).toLocaleString(),o={action:"notify",subject:"Project '"+e.project.project.project_title+"' Updated",body:"Project "+e.project.project_id+" ('"+e.project.project.project_title+"') updated at "+a+" by <a href='https://amphibiandisease.org/profile.php?id="+e.project.user.user+"'>"+$.cookie("amphibiandisease_fullname")+"&lt;<code>"+$.cookie("amphibiandisease_user")+"</code>&gt;</a>"},$.get(uri.urlString+"admin-api.php",buildArgs(o,"json")),$.get(uri.urlString+"recordMigrator.php"),_adp.projectData=e.project.project,delete localStorage._adp,p?_adp.projectData.public?($("paper-toggle-button#public").parent().remove(),'<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>',$("iron-icon[icon='icons:lock'].material-red").replaceWith('<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>')):console.warn("We sent a change to public, but it didn't update server-side."):void 0)}).fail(function(e,a){var t,o;stopLoadError("Sorry, there was an error communicating with the server");try{if(delete(o=_adp).currentAsyncJqxhr,j<D)try{(F=JSON.parse(o.projectData.transect_file)).data.parameters.paths="REMOVED_FOR_LOCAL_SAVE",F.data.polys="REMOVED_FOR_LOCAL_SAVE",o.projectData.transect_file=JSON.stringify(F)}catch(e){}localStorage._adp=JSON.stringify(o),console.debug("Local storage backup succeeded"),t="An offline backup has been made."}catch(e){console.warn("Couldn't backup to local storage! "+(l=e).message),console.warn(l.stack),t="Offline backup failed (said: <code>"+l.message+"</code>)",delay(250,function(){delete o.currentAsyncJqxhr,delete _adp.currentAsyncJqxhr;try{return localStorage._adp=JSON.stringify(_adp),t="An offline backup has been made.",$("#offline-backup-status").replaceWith(t)}catch(e){}}),$("#offline-backup-status").replaceWith(t)}return bsAlert("<strong>Save Error</strong>: We had trouble communicating with the server and your data was NOT saved. Please try again in a bit. <span id='offline-backup-status'>"+t+"</span>","danger"),console.error(e,a),console.warn("Raw post data",S),console.warn("args length was '"+n.length+"' = "+8*n.length+" bytes")}).always(function(){if(clearTimeout(s),"function"==typeof a)return a()}),!1},$(function(){var e,a,t;try{_adp.originalProjectId=_adp.projectData.project_id,a=_adp.projectData.project_id}catch(e){delay(1e3,function(){try{return _adp.originalProjectId=_adp.projectData.project_id,a=_adp.projectData.project_id}catch(e){return console.warn("Warning: COuldn't backup project id")}})}if(null!=localStorage._adp){try{window._adp=JSON.parse(localStorage._adp)}catch(e){null==window._adp&&(window._adp={})}try{_adp.originalProjectId=a}catch(e){}try{return t=new Date(_adp.postedSaveTimestamp),e="<strong>You have offline save information</strong> &#8212; did you want to save it?\n<br/><br/>\nProject #"+_adp.postedSaveData.project_id+" on "+t.toLocaleDateString()+" at "+t.toLocaleTimeString()+'\n<br/><br/>\n<button class="btn btn-success" id="offline-save">\n  Save Now &amp; Refresh Page\n</button>\n<button class="btn btn-danger" id="offline-trash">\n  Remove Offline Backup\n</button>',bsAlert(e,"info"),$("#outdated-warning").remove(),delay(300,function(){return $("#outdated-warning").remove()}),$("#offline-save").click(function(){return saveEditorData(!1,function(){return document.location.reload(!0)})}),$("#offline-trash").click(function(){return delete localStorage._adp,$(".hanging-alert").alert("close")})}catch(e){return console.warn("Backup corrupted, removing -- "+e.message),delete localStorage._adp}}}),loadProjectBrowser=function(){var e,a;return a=uri.urlString+"admin-page.html#action:show-viewable",e={do:"action",prop:"show-viewable"},history.pushState(e,"Viewing Personal Project List",a),startAdminActionHelper(),startLoad(),"perform=list",$.get(adminParams.apiTarget,"perform=list","json").done(function(e){var a,t,o,n,r,i,s,l;for(o in a='<h2 class="new-title col-xs-12">Available Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(a),i=[],s=e.public_projects)n=s[o],i.push(n);for(n in l=e.projects)r=l[n],t=0<=indexOf.call(i,n)?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',a='<li>\n  <button class="btn btn-primary" data-project="'+n+'" data-toggle="tooltip" title="Project #'+n.substring(0,8)+'...">\n    '+t+" "+r+"\n  </button>\n</li>",$("#project-list").append(a);return $("#project-list button").unbind().click(function(){var e;return e=$(this).attr("data-project"),loadProject(e)}),stopLoad()}).fail(function(e,a){return stopLoadError("There was a problem loading viable projects")}),!1},loadProject=function(e,a){return null==a&&(a=""),goTo(uri.urlString+"project.php?id="+e),!1},"object"!=typeof window.validationMeta&&(window.validationMeta={}),validateData=function(a,t){var o;return null==t&&(t=null),_adp.validationDataObject=a,console.info("Doing nested validation"),o=Date.now(),renderValidateProgress(),validateFimsData(a,function(){return validateTaxonData(a,function(){var e;return e=Date.now()-o,console.info("Validation took "+e+"ms",a),cleanupToasts(),toastStatusMessage("Your dataset has been successfully validated"),"function"==typeof t?t(a):(console.warn("validateData had no defined callback!"),console.info("Got back",a))})}),!1},stopLoadBarsError=function(e,a){var t,o,n,r;if(!$("#validator-progress-container:visible").exists())throw new function(){return this.message="Loading bars aren't visible!",this.name="BadLoadState"};"string"==typeof e&&isNull(a)&&(a=e);try{clearTimeout(e)}catch(e){}for($("#validator-progress-container paper-progress[indeterminate]").addClass("error-progress").removeAttr("indeterminate"),o=0,n=(r=$("#validator-progress-container paper-progress:not([indeterminate])")).length;o<n;o++){t=r[o];try{p$(t).value!==p$(t).max&&($(t).addClass("error-progress"),$(t).find("#primaryProgress").css("background","#F44336"))}catch(e){}}null!=a&&(bsAlert("<strong>Data Validation Error</strong>: "+a,"danger"),stopLoadError(null,"There was a problem validating your data"));try{$("#cancel-new-upload").remove()}catch(e){}return!1},delayFimsRecheck=function(e,a){var t;return t="perform=validate&auth="+encodeURIComponent(e.responses.login_response.cookies),_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,t,"json").done(function(e){return console.log("Server said",e),"function"==typeof a?a():console.warn("Warning: delayed recheck had no callback")}).fail(function(e,a){return console.error(a+": Couldn't check status on FIMS server!"),console.warn("Server said",e.responseText),stopLoadBarsError(null,"There was a problem validating your data, please try again later")}),!1},validateFimsData=function(C,A){var a,e,t,o,n,L;if(null==A&&(A=null),"number"!=typeof("undefined"!=typeof _adp&&null!==_adp&&null!=(t=_adp.fims)&&null!=(o=t.expedition)?o.expeditionId:void 0))return!0===_adp.hasRunMintCallback?(console.error("Couldn't run validateFimsData(); called itself back recursively. There may be a problem with the server. "),stopLoadBarsError(null,"Couldn't generate an ARK for your data, please try again later (couldn't communicate with the FIMS server)"),_adp.hasRunMintCallback=!1):(_adp.hasRunMintCallback=!1,console.warn("Haven't minted expedition yet! Minting that first"),mintExpedition(_adp.projectId,p$("#project-title").value,function(){return _adp.hasRunMintCallback=!0,validateFimsData(C,A)}),!1);console.info("FIMS Validating",C.data),$("#data-validation").removeAttr("indeterminate"),n=Object.size(C.data);try{p$("#data-validation").max=2*n}catch(e){}return 20,L=null,(a=function(){var e;try{e=p$("#data-validation").value}catch(e){return!1}if(n<=e)return clearTimeout(L),!1;++e;try{p$("#data-validation").value=e}catch(e){return!1}return L=delay(20,function(){return a()})})(),jsonTo64(C.data),e="perform=validate&datasrc="+post64(C.dataSrc)+"&link="+_adp.projectId,console.info("Posting ...",""+uri.urlString+adminParams.apiTarget+"?"+e),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,e,"json").done(function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,g,f,h,b,v,y,w,_,j,k,x,P,D,S;if(console.log("FIMS validate result",e),!0!==e.status)return stopLoadError("There was a problem talking to the server"),a=null!=(v=null!=(y=e.human_error)?y:e.error)?v:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.",bsAlert("<strong>Server Error:</strong> "+a,"danger"),stopLoadBarsError(L),!1;S=null!=(null!=(w=e.validate_status)?w.status:void 0)?e.validate_status.status:e.validate_status,d=["FIMS_SERVER_DOWN"],h=!(c=["server error"]),D="";try{if(1===Object.size(e.validate_status.errors)){for(s in _=e.validate_status.errors[0]){"object"==typeof(D=n=_[s])&&(D=n[0]);break}j=D.toLowerCase(),h=0<=indexOf.call(c,j)}}catch(e){}if(i={statusesOK:d,errorsOK:c,message:D,permissible:h,errorSize:Object.size(e.validate_status.errors)},k=e.validate_status,0<=indexOf.call(d,k)||h)toastStatusMessage("Validation server is down, proceeding ..."),bsAlert("<strong>FIMS error</strong>: The validation server is down, we're trying to finish up anyway.","warning");else if(!0!==S){if(f=!1,console.error("Bad validation",i),stopLoadError("There was a problem with your dataset"),255<(a=null!=(x=null!=(P=null!=(b="<code>"+e.validate_status.error+"</code>")?b:e.human_error)?P:e.error)?x:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.").length&&(f=!0,a=a.substr(0,255)+"[...] and more."),bsAlert("<strong>FIMS reported an error validating your data:</strong> "+a,"danger"),stopLoadBarsError(L),l=e.validate_status.errors,1<Object.size(l)||f){for(m in p='<div class="error-block" id="validation-error-block">\n  <p><strong>Your dataset had errors</strong>. Here\'s a summary:</p>\n  <table class="table-responsive table-striped table-condensed table table-bordered table-hover" >\n    <thead>\n      <tr>\n        <th>Error Type</th>\n        <th>Error Message</th>\n      </tr>\n    </thhead>\n    <tbody>',l)for(t in s=l[m]){for(u in o="<ul>",r=s[t])g=(g=r[u]).stripHtml(!0),/\[(?:((?:"(\w+)"((, )?))*?))\]/m.test(g)&&(g=g.replace(/"(\w+)"/gm,"<code>$1</code>")),o+="<li>"+g+"</li>";o+="</ul>",p+="<tr>\n  <td><strong>"+t.stripHtml(!0)+"</strong></td>\n  <td>"+o+"</td>\n</tr>"}p+="    </tbody>\n  </table>\n</div>",$("#validator-progress-container").append(p),$("#validator-progress-container").get(0).scrollIntoView()}return!1}try{p$("#data-validation").value=p$("#data-validation").max,clearTimeout(L)}catch(e){}return"function"==typeof A?A(C):void 0}).fail(function(e,a){return clearTimeout(L),console.error(a+": Couldn't upload to FIMS server!"),console.warn("Server said",e.responseText),stopLoadBarsError(null,"There was a problem validating your data, please try again later"),!1}),!1},mintBcid=function(e,a,t,o){var n,r,i,s,l;return null==a&&(a=null!=dataFileParams?dataFileParams.filePath:void 0),"function"!=typeof o?console.warn("mintBcid() requires a callback function"):(l={},n=null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(i=_adp.fims)&&null!=(s=i.expedition)?s.ark:void 0),r="perform=mint&link="+e+"&title="+post64(t)+"&file="+a+"&expedition="+n,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,r,"json").done(function(e){return console.log("Got",e),e.status?l=e:(stopLoadBarsError(null,e.human_error),console.error(e.error),!1)}).fail(function(e,a){return!(l={ark:null,error:a,human_error:e.responseText,status:!1})}).always(function(){return console.info("mintBcid is calling back",l),o(l)})),!1},mintExpedition=function(e,a,t,i){var s,o,l;if(null==e&&(e=_adp.projectId),null==a&&(a=p$("#project-title").value),null==i&&(i=!1),"function"!=typeof t)return console.warn("mintExpedition() requires a callback function"),!1;l={};try{o=p$("#data-encumbrance-toggle").checked}catch(e){try{o=p$("#public").checked}catch(e){}}return"boolean"!=typeof o&&(o=!1),s="perform=create_expedition&link="+e+"&title="+post64(a)+"&public="+o,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,s,"json").done(function(a){var t,e,o,n,r;if(console.log("Expedition got",a),a.status)return l=a,null==("undefined"!=typeof _adp&&null!==_adp?_adp.fims:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.fims={}),_adp.fims.expedition={permalink:a.project_permalink,ark:"object"!=typeof a.ark?a.ark:a.ark.identifier,expeditionId:a.fims_expedition_id,fimsRawResponse:a.responses.expedition_response};e=a.error.replace(/^.*\[(.*)\]$/gim,"$1").unescape();try{o=(n=JSON.parse(e).message.trim()).replace(/^([a-z_]+\(.*\):\s*)?((.*?(?::|!)\s*)*(.*))/gim,"$4"),r=n.replace(/^([a-z_]+\(.*\):\s*)?((.*?(?::|!)\s*)*(.*))/gim,"$2"),t=isNull(o)?r:o}catch(e){t="UNREADABLE_FIMS_ERROR"}if(a.human_error+='" Server said: <code>'+t+"</code> ",console.error(a.error,adminParams.apiTarget+"?"+s),i){try{stopLoadBarsError(null,a.human_error)}catch(e){stopLoadError(a.human_error)}return!1}return null==("undefined"!=typeof _adp&&null!==_adp?_adp.fims:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.fims={}),_adp.fims.expedition={expeditionId:-1}}).fail(function(e,a){return l.ark=null,!1}).always(function(){return console.info("mintExpedition is calling back",l),t(l)}),!1},validateTaxonData=function(v,y){var e,a,t,o,w,n,r,i,_,s,l,c,j,k,d,x;for(w in null==y&&(y=null),a=v.data,c=[],j={},a)s=null!=(n=(_=a[w]).specificEpithet)?n:_.specificepithet,l=null!=(r=_.infraspecificEpithet)?r:_.infraspecificepithet,e=null!=(i=_.cladeSampled)?i:_.cladesampled,d={genus:_.genus,species:s,subspecies:l,clade:e},c.containsObject(d)||c.push(d),k=d.genus+" "+d.species,isNull(d.subspecies)||(k+=" "+d.subspecies),null==j[k]&&(j[k]=[]),j[k].push(w);console.info("Found "+c.length+" unique taxa:",c),t=1<c.length?"taxa":"taxon",o=Object.toArray(a).length,toastStatusMessage("Validating "+c.length+" unique "+t+" from "+o+" rows ..."),console.info("Replacement tracker",j),$("#taxa-validation").removeAttr("indeterminate");try{p$("#taxa-validation").max=c.length}catch(e){}return(x=function(h,b){return k=h[b].genus+" "+h[b].species,isNull(h[b].subspecies)||(k+=" "+h[b].subspecies),validateAWebTaxon(h[b],function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,g,f;if(!0===e.invalid){for(cleanupToasts(),s=(m=/^([a-zA-Z]+) +[a-zA-Z\. ]+$/im).exec(h[b].species),g=m.exec(h[b].subspecies),t=null!=s||null!=g?"(We noticed your "+(null!=s?"species":"subspecies")+' looks like the full species name. <a href="https://tdwg.github.io/dwc/terms/index.htm#specificEpithet" class="alert-link newwindow" data-newtab="true">Double check the definition <span class="glyphicon glyphicon-new-window"></span></a> and your entry &#8212; that may help!)':"Please correct taxonomy issues and try uploading again. If you're confused by this message, please check <a href='https://amphibian-disease-tracker.readthedocs.io/en/latest/APIs/#validating-updating-taxa' data-newtab='true' class='newwindow alert-link'>our documentation  <span class='glyphicon glyphicon-new-window'></span></a>.",l=null!=(c=null!=(d=e.response.human_error)?d:e.response.error)?c:"Unknown error.",stopLoadError(l),l=null!=(p=e.response.human_error_html)?p:l,console.error(e.response.error),f=j[k].slice(0),o=w=0,n=f.length;o<n;o++)_=f[o],_++,f[w]=_,w++;return 5<f.length&&(f=(f=f.slice(0,5)).toString()+"..."),l="<strong>Taxonomy Error</strong>: There was a taxon error in your file. "+l+" The error occured while we were checking taxon <span class='sciname'>\""+k+'"</span>, which occurs at rows '+f+". We stopped validation at that point. "+t,bsAlert(l),removeDataFile(),stopLoadBarsError(),!1}try{for(u=j[k],console.info("Replacing rows @ "+k,u,h[b]),i=0,r=u.length;i<r;i++)_=u[i],v.data[_].genus=e.genus,v.data[_].specificEpithet=e.species,null==e.subspecies&&(e.subspecies=""),v.data[_].infraspecificEpithet=e.subspecies,v.data[_].originalTaxa=k}catch(e){console.warn("Problem replacing rows! "+(a=e).message),console.warn(a.stack)}h[b]=e;try{p$("#taxa-validation").value=b}catch(e){}if(++b<h.length)return 0===modulo(b,50)&&toastStatusMessage("Validating taxa "+b+" of "+h.length+" ..."),x(h,b);try{p$("#taxa-validation").value=b}catch(e){}return v.validated_taxa=h,console.info("Calling back!",v),y(v)})})(c,0),!1},loadSUProfileBrowser=function(){var e,a;return a=uri.urlString+"admin-page.html#action:show-su-profiles",e={do:"action",prop:"show-su-profiles"},history.pushState(e,"Viewing Superuser Profile List",a),startAdminActionHelper(),startLoad(),verifyLoginCredentials(function(e){var y,f,a;return toInt(e.detail.userdata.su_flag).toBool()?(f="su-admin-users",y="action=search_users&q=",a=uri.urlString+"api.php",$.post(a,y).done(function(e){var a,t,v,o,n,r,i,s,l,c,d,p,u,m,g;if(!0!==e.status)return d=null!=(p=null!=(u=e.human_error)?u:e.error)?p:"There was a problem loading the user list",stopLoadError(d),!1;for(s=e.result,l=[],r=o=0,i=(s=Object.toArray(s)).length;r<i;r++)user=s[r],++o,isNull(user.full_name)||(g=user.has_verified_email?"<iron-icon id='restriction-badge-"+o+"' icon='icons:verified-user' class='material-blue' data-toggle='tooltip' title='At least one verified email'></iron-icon>":"",n=user.unrestricted?"<iron-icon id='unrestriction-badge-"+o+"' icon='icons:verified-user' class='material-green' data-toggle='tooltip' title='Meets restriction criteria'></iron-icon>":"<iron-icon id='unrestriction-badge-"+o+"' icon='icons:verified-user' class='material-red' data-toggle='tooltip' title='Fails restriction criteria'></iron-icon>",a=user.is_admin?'<span class="glyphicons glyphicons-user-key" data-toggle="tooltip" title="Adminstrator"></span>':"",t='<span class="'+f+'-user-details">\n  '+user.full_name+" / "+user.handle+" / "+user.email+" | <small>"+(null!=(m=user.alternate_email)?m:"No Alternate Email")+"</small> "+n+" "+g+" "+a+'\n</span>\n<div>\n  <button class="'+f+'-view-projects btn btn-default" data-uid="'+user.uid+'" data-email="'+user.email+'">\n    <iron-icon icon="icons:find-in-page"></iron-icon>\n    Find Projects\n  </button>\n  <button class="'+f+'-reset btn btn-warning" data-uid="'+user.uid+'" data-email="'+user.email+'">\n    <iron-icon icon="av:replay"></iron-icon>\n    Reset Password\n  </button>\n  <button class="'+f+'-delete btn btn-danger" data-uid="'+user.uid+'">\n    <iron-icon icon="icons:delete"></iron-icon>\n    Delete User\n  </button>\n</div>',l.push(t));return c=l.join("</li><li class='su-user-list'>"),v="<ul class='su-total-list col-xs-12' id=\"su-management-list\">\n  <li class='su-user-list'>"+c+"</li>\n</ul>",$("#main-body").html(v),$("."+f+"-view-projects").click(function(){var e,f,h,a,b;return startLoad(),a=$(this).attr("data-uid"),f=$(this).attr("data-email"),console.info("Searching on "+(h=a)+" ... in "+(e="access_data,author_data,author")),y="action=search_project&q="+h+"&cols="+e,$.post(uri.urlString+"api.php",y,"json").done((b=this,function(e){var a,t,o,n,r,i,s,l,c,d,p,u,m,g;if(console.info(e),v='<h3 class="col-xs-12">\n  Projects with "'+f+'" as a participant\n</h3>',g=[],0<(c=Object.toArray(e.result)).length){for(v+="<ul class='project-search-su col-xs-12'>",i=0,r=c.length;i<r;i++)l=c[i],isNull(l.project_id)||(g.push(l.project_id),d=l.public.toBool(),n=h===l.author,console.log(h,l.author,n,l),s=n?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author">\n</iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator">\n</iron-icon>',t=isNull(l.dataset_arks)?"":'<iron-icon icon="editor:insert-chart" data-toggle="tooltip" title="Data Attached">\n</iron-icon>',o=d?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',a='<button class="btn btn-primary search-proj-link" data-href="'+uri.urlString+"project.php?id="+l.project_id+'" data-toggle="tooltip" data-placement="right" title="Project #'+l.project_id.slice(0,8)+'...">\n  '+o+" "+l.project_title+"\n</button> "+s+" "+t,v+="<li class='project-search-result'>"+a+"</li>");v+="</ul>"}else m=null!=(p=null!=(u=null!=f?f:$(b).attr("data-email"))?u:e.search)?p:h,v="<p class='col-xs-12'><em>No results found for user \"<strong>"+m+'</strong>"';return v+='<div class="col-xs-12">\n  <button class="btn btn-default go-back-button">\n    <iron-icon icon="icons:arrow-back"></iron-icon>\n    Back to Profile Browser\n  </button>\n</div>',$("#main-body").html(v),bindClicks(".search-proj-link"),$(".go-back-button").click(function(){return loadSUProfileBrowser(),!1}),!1})).fail(function(e,a){return console.error("AJAX error trying to search on user projects",e,a),d=a+" "+e.status+": "+e.statusText,stopLoadError("Couldn't search projects ("+d+")"),!1}),stopLoad(),!1}),$("."+f+"-reset").click(function(){var o,t;return startLoad(),o=$(this).attr("data-email"),y="action=startpasswordreset&username="+o+"&method=email",$(this).attr("disabled","disabled"),$.post("admin/async_login_handler.php",y,"json").done(function(e){var a,t;return console.info("Reset prompt returned",e),e.status?(stopLoad(),d="Successfully prompted '"+o+"' to reset their password (method: "+e.method+")",toastStatusMessage(d,"",7e3)):(d=null!=(a=null!=(t=e.human_error)?t:e.error)?a:"Couldn't initiate password reset for "+o,"GET_TOTP"===e.action?d="User has two-factor authentication. They have to reset themselves.":isNull(e.action)||(d+=" ("+e.action+")"),stopLoadError(d)),!1}).fail((t=this,function(e,a){return console.error("AJAX error trying to initiate password reset",e,a),d=a+" "+e.status+": "+e.statusText,stopLoadError("Couldn't initiate password reset ("+d+")"),$(t).removeAttr("disabled"),!1})),!1}),$("."+f+"-delete").click(function(){return v='<iron-icon icon="icons:warning" class="">\n</iron-icon>\nConfirm Deletion',$(this).addClass("danger-glow").html(v).unbind().click(function(){var n,e,a,r;return startLoad(),n=$(this).parents(".su-user-list"),e=$(this).attr("data-uid"),$(this).attr("disabled","disabled"),y="perform=su_manipulate_user&user="+e+"&change_type=delete",console.info("Posting to",""+uri.urlString+adminParams.apiTarget+"?"+y),$.post(adminParams.apiTarget,y,"json").done((r=this,function(e){var a,t,o;if(console.info("Click to delete returned",e),!0!==e.status){switch(d=null!=(a=null!=(t=e.human_error)?t:e.error)?a:"There was an error executing the action",o=e.error){case-1!==o.search("INVALID_TARGET"):$(r).attr("disabled","disabled")}return stopLoadError(d),!1}return console.log("Got li of ",n),n.slideUp("slow",function(){return n.remove()}),delay(1e3,function(){if(n.exists())return console.warn("Trying to force removal of element"),n.remove()}),!1})).fail(function(e,a){return console.error("AJAX error",e,a),d=a+" "+e.status+": "+e.statusText,stopLoadError("Couldn't execute action ("+d+")"),!1}).always((a=this,function(){return delay(300,function(){return $(a).removeAttr("disabled")})})),stopLoad(),!1}),!1}),stopLoad(),!1}).fail(function(e,a){var t;return console.error("Couldn't load user list",e,a),t=a+" "+e.status+": "+e.statusText,stopLoadError("Sorry, can't load user list ("+t+")")})):(stopLoadError("Sorry, you must be an admin to do this"),!1)}),!1},loadSUProjectBrowser=function(){var e,a;return a=uri.urlString+"admin-page.html#action:show-su-viewable",e={do:"action",prop:"show-su-viewable"},history.pushState(e,"Viewing Superuser Project List",a),startAdminActionHelper(),startLoad(),verifyLoginCredentials(function(e){return toInt(e.detail.userdata.su_flag).toBool()?("perform=sulist",$.get(adminParams.apiTarget,"perform=sulist","json").done(function(e){var a,t,o,n,r,i,s,l;if(!0!==e.status)return a=null!=(s=e.human_error)?s:"Sorry, you can't do that right now",stopLoadError(a),console.error("Can't do SU listing!"),console.warn(e),populateAdminActions(),!1;for(i in t='<h2 class="new-title col-xs-12">All Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(t),n=[],l=e.projects)r=l[i],n.push(i),o=r.public.toBool()?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',t='<li>\n  <button class="btn btn-primary" data-project="'+i+'" data-toggle="tooltip" title="Project #'+i.substring(0,8)+'...">\n    '+o+" "+r.title+"\n  </button>\n</li>",$("#project-list").append(t);return $("#project-list button").unbind().click(function(){var e;return e=$(this).attr("data-project"),loadEditor(e)}),stopLoad()}).fail(function(e,a){return stopLoadError("There was a problem loading projects")})):(stopLoadError("Sorry, you must be an admin to do this"),!1)}),!1};
//# sourceMappingURL=admin.min.js.map