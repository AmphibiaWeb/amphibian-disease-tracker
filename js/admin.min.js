var _7zHandler,alertBadProject,bootstrapTransect,bootstrapUploader,checkInitLoad,copyMarkdown,createOverflowMenu,csvHandler,dataAttrs,dataFileParams,delayFimsRecheck,excelDateToUnixTime,excelHandler,excelHandler2,finalizeData,getCanonicalDataCoords,getInfoTooltip,getProjectCartoData,getTableCoordinates,getUploadIdentifier,helperDir,imageHandler,kmlHandler,kmlLoader,loadCreateNewProject,loadEditor,loadProject,loadProjectBrowser,loadSUProfileBrowser,loadSUProjectBrowser,mapAddPoints,mapOverlayPolygon,mintBcid,mintExpedition,newGeoDataHandler,pointStringToLatLng,pointStringToPoint,popManageUserAccess,populateAdminActions,recalculateAndUpdateHull,remintArk,removeDataFile,renderValidateProgress,resetForm,revalidateAndUpdateData,saveEditorData,showAddUserDialog,showUnrestrictionCriteria,singleDataFileHelper,startAdminActionHelper,startEditorUploader,stopLoadBarsError,uploadedData,user,userEmail,userFullname,validateData,validateFimsData,validateTaxonData,verifyLoginCredentials,zipHandler,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},modulo=function(a,b){return(+a%(b=+b)+b)%b};window.adminParams={},adminParams.domain="amphibiandisease",adminParams.apiTarget="admin-api.php",adminParams.adminPageUrl="https://"+adminParams.domain+".org/admin-page.html",adminParams.loginDir="admin/",adminParams.loginApiTarget=adminParams.loginDir+"async_login_handler.php",dataFileParams={},dataFileParams.hasDataFile=!1,dataFileParams.fileName=null,dataFileParams.filePath=null,dataAttrs={},uploadedData=null,helperDir="helpers/",user=$.cookie(adminParams.domain+"_link"),userEmail=$.cookie(adminParams.domain+"_user"),userFullname=$.cookie(adminParams.domain+"_fullname"),window.loadAdminUi=function(){try{verifyLoginCredentials(function(a){var b,c;return c=!0===a.unrestricted?"<iron-icon id='restriction-badge' icon='icons:verified-user' class='material-green' data-toggle='tooltip' title='Unrestricted Account'></iron-icon>":"<iron-icon id='restriction-badge' icon='icons:verified-user' class='text-muted' data-toggle='tooltip' title='Restricted Account'></iron-icon>",b="<h3>\n  Welcome, "+$.cookie(adminParams.domain+"_name")+" "+c+"\n</h3>\n<section id='admin-actions-block' class=\"row center-block text-center\">\n  <div class='bs-callout bs-callout-info'>\n    <p>Please be patient while the administrative interface loads.</p>\n  </div>\n</section>",$("main #main-body").before(b),$(".fill-user-fullname").text($.cookie(adminParams.domain+"_fullname")),$("#restriction-badge").click(function(){return showUnrestrictionCriteria()}),checkInitLoad(function(){return populateAdminActions(),bindClicks()}),!1})}catch(a){a,$("main #main-body").html("<div class='bs-callout bs-callout-danger'><h4>Application Error</h4><p>There was an error in the application. Please refresh and try again. If this persists, please contact administration.</p></div>")}return!1},populateAdminActions=function(){var a,b,c,d,e,f;return f=uri.urlString+"admin-page.html",e={do:"home",prop:null},history.pushState(e,"Admin Home",f),$(".hanging-alert").remove(),b='<paper-button id="new-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:add"></iron-icon>\n    Create New Project\n</paper-button>\n',d='<paper-button id="create-placeholder" class="admin-action non-action col-md-3 col-sm-4 col-xs-12" raised data-toggle="tooltip" title="Your account is restricted. Click to verify account">\n  <iron-icon icon="icons:star-border"></iron-icon>\n  Verify &amp; Create Project\n</paper-button>',c=_adp.isUnrestricted?b:d,a=c+'\n      <paper-button id="edit-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n        <iron-icon icon="icons:create"></iron-icon>\n          Edit Existing Project\n      </paper-button>\n      <paper-button id="view-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n        <iron-icon icon="icons:visibility"></iron-icon>\n          View All My Projects\n      </paper-button>',$("#admin-actions-block").html(a),$("#show-actions").remove(),$("main #main-body").empty(),$("#new-project").click(function(){return loadCreateNewProject()}),$("#edit-project").click(function(){return loadEditor()}),$("#view-project").click(function(){return loadProjectBrowser()}),$("#create-placeholder").click(function(){return showUnrestrictionCriteria()}),verifyLoginCredentials(function(a){var c,e;if(e=toInt(a.detail.userdata.su_flag),e.toBool()){console.info("NOTICE: This is an SUPERUSER Admin"),c='<paper-button id="su-view-projects" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:add"></iron-icon>\n  (SU) Administrate All Projects\n</paper-button>\n<paper-button id="su-manage-users" class="admin-action su-action col-md-3 col-sm-4 col-xs-12">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:create"></iron-icon>\n  (SU) Manage All Users\n</paper-button>',$("#admin-actions-block").append(c);try{delay(500,function(){return setupDebugContext()})}catch(a){}$("#su-view-projects").click(function(){return loadSUProjectBrowser()}),$("#su-manage-users").click(function(){return loadSUProfileBrowser()})}return _adp.isUnrestricted=a.unrestricted,!0!==a.unrestricted&&($("#new-project").remove(),$("#create-placeholder").exists()||$("#edit-project").before(d),$("#create-placeholder").unbind().click(function(){return showUnrestrictionCriteria()})),!0!==a.unrestricted||$("#new-project").exists()||($("#create-placeholder").remove(),$("#new-project").exists()||$("#edit-project").before(b),$("#new-project").unbind().click(function(){return loadCreateNewProject()})),!1}),!1};try{(createOverflowMenu=function(){return checkLoggedIn(function(a){var b,c;return b=a.status?'    <paper-item data-href="https://amphibiandisease.org/admin" class="click">\n  <iron-icon icon="icons:settings-applications"></iron-icon>\n  Account Settings\n</paper-item>\n<paper-item data-href="https://amphibiandisease.org/admin-login.php?q=logout" class="click">\n  <span class="glyphicon glyphicon-log-out"></span>\n  Log Out\n</paper-item>':"",c='<paper-menu-button id="header-overflow-menu" vertical-align="bottom" horizontal-offset="-15" horizontal-align="right" vertical-offset="30">\n  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>\n  <paper-menu class="dropdown-content">\n    '+b+'\n    <paper-item disabled data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker/issues/176" class="click">\n      Data Dashboard\n    </paper-item>\n    <paper-item data-href="https://amphibian-disease-tracker.readthedocs.org" class="click">\n      <iron-icon icon="icons:chrome-reader-mode"></iron-icon>\n      Documentation\n    </paper-item>\n    <paper-item data-href="https://github.com/AmphibiaWeb/amphibian-disease-tracker" class="click">\n      <iron-icon icon="glyphicon-social:github"></iron-icon>\n      Github\n    </paper-item>\n    <paper-item data-href="https://amphibiandisease.org/about.php" class="click">\n      About / Legal\n    </paper-item>\n  </paper-menu>\n</paper-menu-button>',$("#header-overflow-menu").remove(),$("header#header-bar .logo-container + p").append(c),isNull(b)||$("header#header-bar paper-icon-button[icon='icons:settings-applications']").remove(),bindClicks()}),!1})()}catch(a){}showUnrestrictionCriteria=function(){return startLoad(),verifyLoginCredentials(function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;return stopLoad(),n=a.unrestricted.toBool(),k=a.has_alternate.toBool(),v=a.detail.userdata.email_verified.toBool(),i=a.email_allowed.toBool(),k?(u=a.detail.userdata.alternate_email_verified.toBool(),e=a.alternate_allowed.toBool(),j=e||i):j=i,r=toInt(a.detail.userdata.su_flag),q=toInt(a.detail.userdata.admin_flag),l=r.toBool()||q.toBool(),b="https://"+adminParams.domain+".org/"+adminParams.loginDir.slice(0,-1),f='<iron-icon icon="icons:verified-user" class="material-green" data-toggle="tooltip" title="Completed"></iron-icon>',m='<iron-icon icon="icons:verified-user" class="text-muted" data-toggle="tooltip" title="Incomplete"></iron-icon>',d="<br/><small class='allowed-tld-domains'>Verifiable email addresses can be from "+a.restriction_criteria.domains+" <span data-toggle='tooltip' title='e.g., your institution'>domains</span>, but must end in: "+a.restriction_criteria.tlds+"</small>",c=j?f+" Have an email in allowed TLDs / domains. "+d:k?m+" Neither your primary email or alternate email is in an allowed TLD / domain. <strong>Fix:</strong> Change your alternative email in <a href='"+b+"'>Account Settings</a>. "+d:m+" To create a new project, you must have a verifiable email address. <strong>Fix:</strong> Add  an alternative email address in <a href='"+b+"'>Account Settings</a>. "+d,w=v?f+" Have a verified username":m+" Your primary email isn't verified. <strong>Fix:</strong> Verify it in <a href='"+b+"'>Account Settings</a>",k&&(u?t=f+" Your alternate email is verified":e&&(t=m+" Your alternate email isn't verified. <strong>Fix:</strong> Verify it in <a href='"+b+"'>Account Settings</a>")),t=isNull(t)?"":"<li>"+t+"</li>",o="",l&&(p=r.toBool()?"a SuperUser":"an administrator",o=f+" You're "+p+". You're always unrestricted."),g="<div>\n  "+o+'\n  <ul class="restriction-criteria">\n    <li>'+c+"</li>\n    <li>"+w+"</li>\n    "+t+"\n  </ul>\n  <p>\n    Restricted accounts can't create projects.\n  </p>\n</div>",s=n?"Your account is unrestricted":"Your account is restricted",$("#restriction-summary").remove(),h='<paper-dialog id="restriction-summary" modal>\n  <h2>'+s+"</h2>\n  <paper-dialog-scrollable>\n    "+g+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("body").append(h),safariDialogHelper("#restriction-summary",0,function(){return console.info("Opened restriction summary dialog")}),!1}),!1},verifyLoginCredentials=function(a){var b,c,d,e;return c=$.cookie(adminParams.domain+"_auth"),e=$.cookie(adminParams.domain+"_secret"),d=$.cookie(adminParams.domain+"_link"),b="hash="+c+"&secret="+e+"&dblink="+d,$.post(adminParams.loginApiTarget,b,"json").done(function(b){return!0===b.status?("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.isUnrestricted=b.unrestricted,a(b)):goTo(b.login_url)}).fail(function(a,b){return $("main #main-body").html("<div class='bs-callout-danger bs-callout'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p></div>"),console.log(a,b),!1}),!1},startAdminActionHelper=function(){var a;return $("#admin-actions-block").empty(),$("#pib-wrapper-dashboard").remove(),a='<span id="pib-wrapper-dashboard" class="pib-wrapper" data-toggle="tooltip" title="Administration Home" data-placement="bottom">\n  <paper-icon-button icon="icons:dashboard" class="admin-action" id="show-actions">\n  </paper-icon-button>\n</span>',$("#pib-wrapper-settings").after(a),$("#show-actions").click(function(){return $(this).tooltip("hide"),$(".tooltip").tooltip("hide"),populateAdminActions()})},getInfoTooltip=function(a){return null==a&&(a="No Message Provided"),'<div class="col-xs-1 adjacent-info">\n  <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="'+a+'"></span>\n</div>'},alertBadProject=function(a){return a=null!=a?"project "+a:"this project",stopLoadError("Sorry, "+a+" doesn't exist"),!1},loadCreateNewProject=function(){var a,b,c,d,e,f,g,h,i;i=uri.urlString+"admin-page.html#action:create-project",g={do:"action",prop:"create-project"},history.pushState(g,"Create New Project",i),startAdminActionHelper(),b='<h2 class="new-title col-xs-12">Project Title</h2>\n<paper-input label="Descriptive, unique project title" id="project-title" class="project-field col-md-6 col-xs-11" required auto-validate data-field="project_title"></paper-input>\n'+getInfoTooltip("A descriptive title is most useful. Tell us the main focus of the project and whether a monitoring effort or project that just occurred in the Spring of 2015.")+'\n<h2 class="new-title col-xs-12">Project Parameters</h2>\n<section class="project-inputs clearfix col-xs-12">\n  <div class="row">\n    <paper-input label="Primary Pathogen" id="project-disease" class="project-field col-xs-6" required auto-validate data-field="disease"></paper-input>\n      '+getInfoTooltip("Bd, Bsal, or other. If empty, we'll take it from your data.")+'\n      <button class="btn btn-default fill-pathogen col-xs-2" data-pathogen="Batrachochytrium dendrobatidis">Bd</button>\n      <button class="btn btn-default fill-pathogen col-xs-2" data-pathogen="Batrachochytrium salamandrivorans">Bsal</button>\n    <paper-input label="Pathogen Strain" id="project-disease-strain" class="project-field col-md-6 col-xs-11" data-field="disease_strain"></paper-input>'+getInfoTooltip("For example, specific Bd strains which have been sequenced JEL423, JAM81, if known")+'\n    <paper-input label="Project Reference" id="reference-id" class="project-field col-md-6 col-xs-11" data-field="reference_id"></paper-input>\n    '+getInfoTooltip("E.g.  a DOI or other reference")+'\n    <paper-input label="Publication DOI" id="pub-doi" class="project-field col-md-6 col-xs-11" data-field="publication"></paper-input>\n    '+getInfoTooltip("Publication DOI citing these datasets may be added here.")+'\n    <h2 class="new-title col-xs-12">Lab Parameters</h2>\n    <paper-input label="Project PI" id="project-pi" class="project-field col-md-6 col-xs-12"  required auto-validate data-field="pi_lab"></paper-input>\n    <paper-input label="Project Contact" id="project-author" class="project-field col-md-6 col-xs-12" value="'+userFullname+'"  required auto-validate></paper-input>\n    '+getInfoTooltip("This will be the identity used for the project citation")+'\n    <gold-email-input label="Contact Email" id="author-email" class="project-field col-md-6 col-xs-12" value="'+userEmail+'"  required auto-validate></gold-email-input>\n    <paper-input label="Technical/Data Contact" id="project-technical-contact" class="project-field col-md-6 col-xs-12" value="'+userFullname+'"  required auto-validate></paper-input>\n    '+getInfoTooltip("This will be the identity suggested for technical communications about the project")+'\n    <gold-email-input label="Technical/Data Contact Email" id="technical-contact-email" class="project-field col-md-6 col-xs-12" value="'+userEmail+'"  required auto-validate></gold-email-input>\n    <paper-input label="Diagnostic Lab" id="project-lab" class="project-field col-md-6 col-xs-11"  required auto-validate></paper-input>\n    '+getInfoTooltip("Name or PI responsible for lab results")+'\n    <paper-input label="Affiliation" id="project-affiliation" class="project-field col-md-6 col-xs-11"  required auto-validate></paper-input> '+getInfoTooltip("Of project PI. e.g., UC Berkeley")+'\n    <h2 class="new-title col-xs-12">Project Notes</h2>\n    <iron-autogrow-textarea id="project-notes" class="project-field col-md-6 col-xs-11 language-markdown" rows="3" data-field="sample_notes"></iron-autogrow-textarea>'+getInfoTooltip("Project notes or brief abstract; accepts Markdown ")+'\n    <marked-element class="project-param col-md-6 col-xs-12" id="note-preview">\n      <div class="markdown-html"></div>\n    </marked-element>\n    <h2 class="new-title col-xs-12">Data Permissions</h2>\n    <div class="col-xs-12">\n      <span class="toggle-off-label iron-label">Private Dataset</span>\n      <paper-toggle-button id="data-encumbrance-toggle" class="red">Public Dataset</paper-toggle-button>\n      '+getInfoTooltip("this will be the setting for all data uploaded to this Project")+'\n    </div>\n\n    <h2 class="new-title col-xs-12">Project Area of Interest</h2>\n    <div class="col-xs-12">\n      <p>\n        This represents the approximate collection region for your samples.\n        <br/>\n        <strong>\n          The last thing you do (search, build a locality, or upload data) will be your dataset\'s canonical locality.\n        </strong>.\n      </p>\n      <span class="toggle-off-label iron-label">Locality Name</span>\n      <paper-toggle-button id="transect-input-toggle">Coordinate List</paper-toggle-button>\n    </div>\n    <p id="transect-instructions" class="col-xs-12"></p>\n    <div id="transect-input" class="col-md-6 col-xs-12">\n      <div id="transect-input-container" class="clearfix">\n      </div>\n      <p class="computed-locality" id="computed-locality">\n        You may also click on the map to outline a region of interest, then click "Build Map" below to calculate a locality.\n      </p>\n      <br/><br/>\n      <button class="btn btn-primary" disabled id="init-map-build">\n        <iron-icon icon="maps:map"></iron-icon>\n        Build Map\n        <small>\n          (<span class="points-count">0</span> points)\n        </small>\n      </button>\n      <paper-icon-button icon="icons:restore" id="reset-map-builder" data-toggle="tooltip" title="Reset Points"></paper-icon-button>\n    </div>\n    <div id="carto-rendered-map" class="col-md-6 col-xs-12">\n      <div id="carto-map-container" class="carto-map map">\n      </div>\n    </div>\n    <div class="col-xs-12">\n      <br/>\n      <paper-checkbox checked id="has-data">My project already has data</paper-checkbox>\n      <br/>\n    </div>\n  </div>\n</section>\n<section id="uploader-container-section" class="data-section col-xs-12 clearfix">\n  <h2 class="new-title">Uploading your project data</h2>\n  <p>Drag and drop as many files as you need below. </p>\n  <p>\n    Please note that the data <strong>must</strong> have a header row,\n    and the data <strong>must</strong> have the columns <code>decimalLatitude</code>, <code>decimalLongitude</code>, and <code>coordinateUncertaintyInMeters</code>. Your project must also be titled before uploading data.\n  </p>\n  <div class="alert alert-info" role="alert">\n    We\'ve partnered with the Biocode FIMS project and you can get a template with definitions at <a href="http://www.biscicol.org/template" class="newwindow alert-link" data-newtab="true">biscicol.org <span class="glyphicon glyphicon-new-window"></span></a> <small>(Alternate link: <a href="https://berkeley.box.com/v/AmphibianDisease-template" class="newwindow alert-link" data-newtab="true">Berkeley Box <span class="glyphicon glyphicon-new-window"></span></a>)</small>. Check out the documentation for <a href="https://amphibian-disease-tracker.readthedocs.org/en/latest/Creating%20a%20New%20Project/#with-data" class="newwindow alert-link" data-newtab="true">more instructions <span class="glyphicon glyphicon-new-window"></span></a>\n  </div>\n  <div class="alert alert-warning" role="alert">\n    <strong>If the data are in Excel</strong>, ensure that they are in the first sheet in the workbook, or in a worksheet titled <code>Samples</code>, as per FIMS.\n  </div>\n</section>\n<section class="project-inputs clearfix data-section col-xs-12">\n  <div class="row">\n    <h2 class="new-title col-xs-12">Project Data Summary</h2>\n    <h3 class="new-title col-xs-12">Calculated Data Parameters</h3>\n    <paper-input label="Samples Counted" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="samplecount" readonly type="number" data-field="disease_samples"></paper-input>\n    <paper-input label="Positive Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="positive-samples" readonly type="number" data-field="disease_positive"></paper-input>\n    <paper-input label="Negative Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="negative-samples" readonly type="number" data-field="disease_negative"></paper-input>\n    <paper-input label="No Confidence Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="no_confidence-samples" readonly type="number" data-field="disease_no_confidence"></paper-input>\n    <paper-input label="Disease Morbidity" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="morbidity-count" readonly type="number" data-field="disease_morbidity"></paper-input>\n    <paper-input label="Disease Mortality" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="mortality-count" readonly type="number" data-field="disease_mortality"></paper-input>\n    <h4 class="new-title col-xs-12">Species in dataset</h4>\n    <iron-autogrow-textarea id="species-list" class="project-field col-md-6 col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    <p class="col-xs-12"><a id="download-server-parsed-data" class="btn btn-primary disabled">Download Parsed Data</a></p>\n  </div>\n</section>\n<section id="submission-section" class="col-xs-12">\n  <div class="pull-right">\n    <button id="upload-data" class="btn btn-success click" data-function="finalizeData"><iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project</button>\n    <button id="reset-data" class="btn btn-danger click" data-function="resetForm">Reset Form</button>\n  </div>\n</section>',$("main #main-body").append(b);try{$("#project-title").blur(function(){var a,b,c,d;return c=p$(this).value.toLowerCase(),b=c.replace(/ *b(sal|d\W) *|(19|20)[0-9]{2}|\s+\W|\s+(for|the|and|of|in|from|a|an)\s+/gim," "),a=b.replace(/  /gm," "),d=a.trim().split(" "),d.length<=3&&bsAlert("Your title seems very short/generic. Read it again, and make sure it is both <strong>unique</strong> and <strong>descriptive</strong>."),!1})}catch(b){a=b,console.warn("Couldn't set up blur event - "+a.message),console.warn(a.stack)}mapNewWindows();try{for(f=$("paper-input[required]"),d=0,e=f.length;d<e;d++)c=f[d],p$(c).validate()}catch(a){console.warn("Couldn't pre-validate fields")}return $(".fill-pathogen").click(function(){var a;return a=$(this).attr("data-pathogen"),p$("#project-disease").value=a,!1}),$("#init-map-build").click(function(){return doMapBuilder(window.mapBuilder,null,function(a){return console.debug("doMapBuilder callback initialized ..."),b='<p class="text-muted" id="computed-locality">\n  Computed locality: <strong>'+a.locality+"</strong>\n</p>",$("#computed-locality").remove(),$("#using-computed-locality").remove(),$("#transect-input-container").after(b),!1})}),$("#reset-map-builder").click(function(){delete window.mapBuilder,$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length);try{p$("google-map").clear()}catch(a){}return $("google-map google-map-marker").remove(),$("google-map google-map-poly").remove()}),h=p$("#project-notes").textarea,$(h).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),bootstrapUploader(),bootstrapTransect(),$("#has-data").on("iron-change",function(){return $(this).get(0).checked?($(".data-section").removeAttr("hidden"),$(".label-with-data").removeAttr("hidden")):($(".data-section").attr("hidden","hidden"),$(".label-with-data").attr("hidden","hidden"))}),$("#data-encumbrance-toggle").on("iron-change",function(){var a;return a=p$("#data-encumbrance-toggle").checked?'<iron-icon icon="social:public"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Public Project':'<iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project',$("#upload-data").html(a)}),console.log("Getting location, prerequisite to setting up map ..."),getLocation(function(){var a;_adp.currentLocation=new Point(window.locationData.lat,window.locationData.lng),a={bsGrid:""},console.log("Location fetched, setting up map ..."),createMap2(null,a);try{return delay(500,function(){return setupDebugContext()})}catch(a){}}),bindClicks(),!1},finalizeData=function(a,b){var c,d,e,f,g,h;null==a&&(a=!1),startLoad();try{return d=!0,($("[required]").each(function(){var a;try{if(a=$(this).val(),isNull(a))return $(this).get(0).focus(),d=!1,!1}catch(a){}}),d)?(c=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectId)&&(_adp.projectId=md5(""+geo.dataTable+c+Date.now())),h=p$("#project-title").value,(null!=dataFileParams?dataFileParams.hasDataFile:void 0)&&-1===dataFileParams.filePath.search(helperDir)&&(dataFileParams.filePath=""+helperDir+dataFileParams.filePath),f=null!=(g=null!=dataFileParams?dataFileParams.filePath:void 0)?g:null,mintBcid(_adp.projectId,f,h,function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R;try{if(!c.status)return console.error(c.error),bsAlert(c.human_error,"danger"),stopLoadError(c.human_error),!1;if(dataAttrs.ark=c.ark,null==dataAttrs.data_ark&&(dataAttrs.data_ark=[]),dataAttrs.data_ark.push(c.ark+"::"+dataFileParams.fileName),z={},a)z=_adp.projectData;else for(A=$(".project-field"),p=0,q=A.length;p<q;p++)k=A[p],n=$(k).hasClass("iron-autogrow-textarea-0")?$($(k).get(0).textarea).val():$(k).val(),o=$(k).attr("data-field"),isNull(o)||("number"===$(k).attr("type")?z[o]=toInt(n):z[o]=n);if(e=getMapCenter(geo.boundingBox),l=0,null!=uploadedData){for(g=[],v=[],R=[],[],d=[],N=[],h=[],O=[],L=0,B=Object.toArray(uploadedData),t=0,r=B.length;t<r;t++){I=B[t],++L,f=null!=(C=I.dateCollected)?C:I.dateIdentified,Q=excelDateToUnixTime(f),g.push(Q),P=new Date(Q),u=dateMonthToString(P.getUTCMonth()),indexOf.call(v,u)<0&&v.push(u),D=P.getFullYear(),indexOf.call(R,D)<0&&R.push(P.getFullYear()),null!=I.catalogNumber&&d.push(I.catalogNumber),N.push(I.sampleId),J=toFloat(I.decimalLatitude),K=toFloat(I.decimalLongitude);try{i=geo.distance(J,K,e.lat,e.lng)}catch(a){throw j=a,console.error("Couldn't calculate distanceFromCenter",J,K,e),console.warn("Row: #"+L,I),j}i>l&&(l=i),null!=I.sampleType&&(E=I.sampleType,indexOf.call(O,E)<0&&O.push(I.sampleType)),null!=I.specimenDisposition&&(F=I.specimenDisposition,indexOf.call(h,F)<0&&h.push(I.sampleDisposition))}console.info("Got date ranges",g),v.sort(),R.sort(),z.sampled_collection_start=g.min(),z.sampled_collection_end=g.max(),console.info("Collected from",g.min(),g.max()),z.sampling_months=v.join(","),z.sampling_years=R.join(","),console.info("Got uploaded data",uploadedData),z.sample_catalog_numbers=d.join(","),z.sample_field_numbers=N.join(","),z.sample_methods_used=O.join(",")}else{if(null==geo.canonicalHullObject)try{createConvexHullFINISHME}catch(a){}if(null!=geo.canonicalHullObject)for(m=geo.canonicalHullObject.hull,w=0,s=m.length;w<s;w++)x=m[w],(i=geo.distance(x.lat,x.lng,e.lat,e.lng))>l&&(l=i)}if((null!=dataFileParams?dataFileParams.hasDataFile:void 0)&&(-1===dataFileParams.filePath.search(helperDir)&&(dataFileParams.filePath=""+helperDir+dataFileParams.filePath),z.sample_raw_data="https://amphibiandisease.org/"+dataFileParams.filePath),z.lat=e.lat,z.lng=e.lng,z.radius=toInt(1e3*l),null!=(null!=(G=_adp.data)&&null!=(H=G.pushDataUpload)?H.samples:void 0)&&(M=_adp.data.pushDataUpload.samples,z.disease_morbidity=M.morbidity,z.disease_mortality=M.mortality,z.disease_negative=M.negative,z.disease_no_confidence=M.no_confidence,z.disease_positive=M.positive,z.disease_samples=toInt(M.positive)+toInt(M.negative)+toInt(M.no_confidence)),y=function(){var c,d,e,f,g,h,i,k,l,m,n,p,q,r,s,t,u,v;console.info("Computed locality "+_adp.locality),z.locality=_adp.locality,null!=geo.computedBoundingRectangle&&(z.bounding_box_n=geo.computedBoundingRectangle.north,z.bounding_box_s=geo.computedBoundingRectangle.south,z.bounding_box_e=geo.computedBoundingRectangle.east,z.bounding_box_w=geo.computedBoundingRectangle.west),z.author=$.cookie(adminParams.domain+"_link");try{z.technical_contact=p$("#project-technical-contact").value,z.technical_contact_email=p$("#project-technical-contact-email").value}catch(a){}try{if("object"==typeof kmlInfo)try{z.transect_file=JSON.stringify(kmlInfo)}catch(a){j=a,console.warn("Couldn't stringify data - "+j.message,kmlInfo),null!=kmlInfo.path&&(z.transect_file=kmlInfo.path)}}catch(a){}null==("undefined"!=typeof _adp&&null!==_adp&&null!=(t=_adp.projectData)?t.author_data:void 0)?(d={name:p$("#project-author").value,contact_email:p$("#author-email").value,affiliation:p$("#project-affiliation").value,lab:p$("#project-pi").value,diagnostic_lab:p$("#project-lab").value,entry_date:Date.now()},z.author_data=JSON.stringify(d)):z.author_data=_adp.projectData.author_data,f={table:geo.dataTable,raw_data:dataFileParams,bounding_polygon:"undefined"!=typeof geo&&null!==geo?geo.canonicalBoundingBox:void 0,bounding_polygon_geojson:"undefined"!=typeof geo&&null!==geo?geo.geoJsonBoundingBox:void 0},z.carto_id=JSON.stringify(f),z.project_id=_adp.projectId,z.modified=Date.now()/1e3;try{z.project_obj_id=_adp.fims.expedition.ark}catch(a){return mintExpedition(_adp.projectId,null,function(){return y()}),!1}if(null==dataAttrs.data_ark&&(dataAttrs.data_ark=[]),z.dataset_arks=dataAttrs.data_ark.join(","),z.project_dir_identifier=getUploadIdentifier(),z.public=null==(k=null!=(l=null!=(m=null!=(n=p$("#data-encumbrance-toggle"))?n.checked:void 0)?m:null!=(p=p$("#public"))?p.checked:void 0)?l:"undefined"!=typeof _adp&&null!==_adp&&null!=(q=_adp.projectData)?q.public:void 0)||k,null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(r=_adp.data)&&null!=(s=r.taxa)?s.validated:void 0))for(u=_adp.data.taxa.validated,z.sampled_clades=_adp.data.taxa.clades.join(","),z.sampled_species=_adp.data.taxa.list.join(","),i=0,h=u.length;i<h&&(v=u[i],e=v.response.validated_taxon,console.info("Aweb taxon result:",e),g=e.order.toLowerCase(),o="includes_"+g,z[o]=!0,null!=z.includes_anura==!1||null!=z.includes_caudata==!1||null!=z.includes_gymnophiona==!1);i++);return c="perform=new&data="+jsonTo64(z),console.info("Data object constructed:",z),a?("function"==typeof b&&b(z),stopLoad(),z):_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,c,"json").done(function(a){var b;try{!0===a.status?(bsAlert("Project ID #<strong>"+z.project_id+"</strong> created","success"),$.get(uri.urlString+"recordMigrator.php"),stopLoad(),delay(1e3,function(){return loadEditor(_adp.projectId)}),toastStatusMessage("Data successfully saved to server")):(console.error(a.error.error),console.log(a),stopLoadError(a.human_error),bsAlert(a.human_error,"error"))}catch(c){j=c,stopLoadError("There was a verifying your save data");try{b=JSON.stringify(a)}catch(a){b="BAD_OBJECT"}try{bsAlert("There was a problem verifying your save data<br/><br/>Application said: <code>"+b+"</code><code>"+j.message+"</code><code>"+j.stack+"</code>","error")}catch(a){}console.error("JavaScript error in save data callback! FinalizeData said: "+j.message),console.warn(j.stack)}return!1}).fail(function(a,b){return stopLoadError("There was a problem saving your data. Please try again"),!1})},console.info("Checking locality ..."),null==geo.computedLocality&&dataFileParams.hasDataFile){if(dataFileParams.hasDataFile)return null==e&&(e=getMapCenter(geo.boundingBox)),console.info("Computing locality with reverse geocode from",e,geo.boundingBox),geo.reverseGeocode(e.lat,e.lng,geo.boundingBox,function(a){return console.info("Computed locality "+a),_adp.locality=a,y()});try{_adp.locality=p$("#locality-input").value}catch(a){_adp.locality=""}return console.warn("How did we get to this state? No locality precomputed, no data file"),y()}if(null!=geo.computedLocality)console.info("Already have locality"),_adp.locality=geo.computedLocality;else try{console.info("Took written locality"),_adp.locality=p$("#locality-input").value}catch(a){console.info("Can't figure out locality"),_adp.locality=""}return dataFileParams.hasDataFile?y():mintExpedition(_adp.projectId,null,function(){return y()})}catch(a){return j=a,stopLoadError("There was a problem with the application. Please try again later. (E-003)"),console.error("JavaScript error in saving data (E-003)! FinalizeData said: "+j.message),console.warn(j.stack)}
})):(stopLoadError("Please fill out all required fields"),!1)}catch(a){e=a,stopLoadError("There was a problem with the application. Please try again later. (E-004)");try{bsAlert("There was a problem with the application. Please try again later. (E-004)<br/><br/>Application said: <code>"+e.message+"</code><code>"+e.stack+"</code>","error")}catch(a){}return console.error("JavaScript error in saving data (E-004)! FinalizeData said: "+e.message),console.warn(e.stack)}},resetForm=function(){return foo()},getTableCoordinates=function(a){return null==a&&(a="tdf0f1bc730325de59d48a5c80df45931_6d6d454828c05e8ceea03c99cc5f547e52fcb5fb"),!1},pointStringToLatLng=function(a,b){var c,d,e,f;return null==b&&(b=!1),a.search(!1)?(f=a.slice(6,-1),e=f.split(" "),c=Math.abs(e[0])>90||b?1:0,d=1===c?0:1,{lat:e[c],lng:e[d]}):(console.warn("Invalid point string"),!1)},pointStringToPoint=function(a,b){var c;return null==b&&(b=!1),a.search(!1)?(c=pointStringToLatLng(a,b),canonicalizePoint(c)):(console.warn("Invalid point string"),!1)},bootstrapTransect=function(){var a,b;return window.geocodeLookupCallback=function(){var a,b,c;return startLoad(),b=p$("#locality-input").value,a=new google.maps.Geocoder,c={address:b},a.geocode(c,function(a,b){var c,d,e,f,g,h,i,j,k,l;if(b===google.maps.GeocoderStatus.OK){console.info("Google said:",a),$("#locality-lookup-result").exists()||$("#carto-rendered-map").prepend('<div class="alert alert-info alert-dismissable" role="alert" id="locality-lookup-result">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <strong>Location Found</strong>: <span class="lookup-name">'+a[0].formatted_address+"</span>\n</div>"),i='<p class="text-muted" id="computed-locality">\n  Computed locality: <strong>'+a[0].formatted_address+'</strong>\n</p>\n<div class="alert alert-info" id="using-computed-locality">\n  <p>\n    This is your currently active locality. Entering points below will take priority over this.\n  </p>\n</div>',$("#computed-locality").remove(),$("#using-computed-locality").remove(),$("#transect-input-container").after(i),$("#locality-lookup-result .lookup-name").text(a[0].formatted_address),_adp.locality=a[0].formatted_address,l=a[0].geometry.location,j=l.lat(),k=l.lng(),f=a[0].geometry.viewport;try{c=f.R,d=f.j,e={nw:[c.j,d.R],ne:[c.j,d.j],se:[c.R,d.R],sw:[c.R,d.j],north:c.j,south:c.R,east:d.j,west:d.R}}catch(b){h=b,console.warn("Danger: There was an error calculating the bounding box ("+h.message+")"),console.warn(h.stack),console.info("Got bounds",f),console.info("Got geometry",a[0].geometry)}return console.info("Got bounds: ",[j,k],e),geo.boundingBox=e,g=function(){return geo.renderMapHelper(e,j,k)},loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",g,!1)}return stopLoadError("Couldn't find location: "+b)})},geo.renderMapHelper=function(a,b,c){var d,e,f,g;if(null==a&&(a=geo.boundingBox),startLoad(),null==("undefined"!=typeof google&&null!==google?google.maps:void 0))return window.recallMapHelper=function(){return geo.renderMapHelper(a,b,c)},loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=recallMapHelper"),!1;try{return $("#carto-map-container").empty(),e={selector:"#carto-map-container",bsGrid:""},$(e.selector).empty(),g=function(){return stopLoad(),!1},null!=geo.dataTable?getCanonicalDataCoords(geo.dataTable,e,function(){return g()}):(e.boundingBox=a,f=new Point(b,c),createMap2([f],e,function(){return g()}))}catch(a){return d=a,console.error("There was an error rendering the map - "+d.message),stopLoadError("There was an error rendering the map - "+d.message)}},a=function(){return null==("undefined"!=typeof google&&null!==google?google.maps:void 0)?loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=geocodeLookupCallback"):geocodeLookupCallback(),!1},(b=function(){var b,c;return p$("#transect-input-toggle").checked?(b="Please input a list of coordinates, in the form <code>lat, lng</code>, with one set on each line. <strong>Please press <kbd>enter</kbd> to insert a new line after your last coordinate</strong>.",c='<iron-autogrow-textarea id="coord-input" class="" rows="3"></iron-autogrow-textarea>'):(b="Please enter a name of a locality",c='<paper-input id="locality-input" label="Locality" class="pull-left"></paper-input> <paper-icon-button class="pull-left" id="do-search-locality" icon="icons:search"></paper-icon-button>'),$("#transect-instructions").html(b),$("#transect-input-container").html(c),p$("#transect-input-toggle").checked?$(p$("#coord-input").textarea).keyup(function(a){return function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(13===(a.keyCode?a.keyCode:a.which)&&(o=$(p$("#coord-input").textarea).val(),o.split("\n").length>3)){for(f=[],g=o.split("\n"),console.info("Raw coordinate info:",g),j=0,k=g.length;j<k;j++)d=g[j],d.search(",")>0&&!isNull(d)&&(e=d.split(","),2===e.length&&(n=[toFloat(e[0]),toFloat(e[1])],f.push(n)));if(f.length>=3){for(console.info("Coords:",f),i=0,b={},m=0,l=f.length;m<l;m++)c=f[m],++i,b[i]=c;return h=function(){return geo.renderMapHelper(b)},geo.boundingBox=b,loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",h,!1)}return console.warn("There is one or more invalid coordinates preventing the UI from being shown.")}}}()):($("#locality-input").keyup(function(b){if(13===(b.keyCode?b.keyCode:b.which))return a()}),$("#do-search-locality").click(function(){return a()})),!1})(),$("#transect-input-toggle").on("iron-change",function(){return b()}),!1},mapOverlayPolygon=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(null==b&&(b=null),null==c&&(c={}),null==d&&(d=geo.googleMap),l={},"object"!=typeof a)return console.warn("mapOverlayPolygon() got an invalid data type to overlay!"),!1;if("object"!=typeof c&&(c={}),null==c.fillColor&&(c.fillColor="#ff7800"),l.fillColor=c.fillColor,l.fillOpacity=.35,"object"!=typeof b&&(b=null),console.info("Should overlay polygon from bounds here"),$("#carto-map-container").exists()&&null!=geo.cartoMap){q=[],f=[],e=[],[],k=[],-90,90,-180,180;for(p in a)r=a[p],q.push(r),s={},s.lat=r[0],s.lng=r[1],e.push(new fPoint(s.lat,s.lng)),k.push(new Point(s.lat,s.lng));sortPoints(k),f=sortPoints(k,!1),g=e,g.sort(sortPointY),g.sort(sortPointX),h=[],h.push(q);try{i=getConvexHullPoints(g)}catch(a){j=a,console.error("Convex hull points CHP failed! - "+j.message),console.warn(j.stack),console.info(g)}console.info("Got hulls",i),console.info("Sources",f,e,g),l.paths=i,o={type:"Polygon",coordinates:i},n={type:"Feature",properties:b,geometry:o},console.info("Rendering GeoJSON MultiPolygon",o),geo.geoJsonBoundingBox=n,geo.overlayOptions=c,console.info("Rendering Google Maps polygon",l),geo.canonicalBoundingBox=l,m=new google.maps.Polygon(l),null!=geo.googlePolygon&&geo.googlePolygon.setMap(null),geo.googlePolygon=m,m.setMap(d),isNull(dataAttrs.coords||isNull(geo.dataTable))||getCanonicalDataCoords(geo.dataTable)}else console.warn("There's no map yet! Can't overlay polygon");return!1},mapAddPoints=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(null==c&&(c=geo.googleMap),j=0,k=a.length;j<k;j++)if(!((r=a[j])instanceof geo.Point))return console.warn("Invalid datatype in array -- array must be constructed of Point objects"),!1;for(q={},g=[],e=0,m=0,l=a.length;m<l;m++)r=a[m],u=null!=b?null!=(t=b[e])?t.title:void 0:"",s=r.getObj(),d=new google.maps.LatLng(s.lat,s.lng),o={position:d,map:c,title:u},n=new google.maps.Marker(o),q[e]={marker:n},isNull(u)?console.info("Key "+e+" has no title in pointInfoArray",b[e]):(h={content:b[e].html},f=new google.maps.InfoWindow(h),q[e].infoWindow=f,g.push(f)),++e;if(!isNull(g)){dataAttrs.coordInfoWindows=g;for(i in q)p=q[i],n=p.marker,n.unbind("click"),n.self=n,n.iw=p.infoWindow,n.iwk=i,n.addListener("click",function(){try{return this.iw.open(c,this),console.info("Opening infoWindow #"+this.iwk)}catch(a){return a,console.error("Invalid infowindow @ "+this.iwk+"!",g,p,this.iw)}});geo.markers=q}return q},getCanonicalDataCoords=function(a,b,c){return null==b&&(b=_adp.defaultMapOptions),null==c&&(c=createMap2),isNull(a)?(console.error("A table must be specified!"),!1):"function"!=typeof c?(console.error("This function needs a callback function as the second argument"),!1):(verifyLoginCredentials(function(d){var e,f;return f="SELECT * FROM "+a+" WHERE FALSE",e="action=fetch&sql_query="+post64(f),_adp.currentAsyncJqxhr=$.post("api.php",e,"json").done(function(g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u;try{p=JSON.parse(g.post_response[0])}catch(d){m=d,console.error("getCanonicalDataCoords couldn't read carto data! Failed to get columns ("+m.message+")",g),console.warn("Table: '"+a+"' for query",f),console.warn(m.stack),null!=(q=null!=(r=g.human_error)?r:g.error)?q:"It should be safe, however.",o="There was a problem fetching your data back from CartoDB. ",stopLoadError(o),bsAlert(o,"danger");try{"function"==typeof c&&c([],b)}catch(a){}return!1}k={},s=p.fields;for(n in s)u=s[n],k[n]=u;_adp.activeCols=k,l=[],j={};for(i in k)k[i],"id"!==i&&"the_geom"!==i&&l.push(i),j[i.toLowerCase()]=i;return _adp.colsList=l,_adp.colRemap=j,t="SELECT ST_AsText(the_geom), "+l.join(",")+" FROM "+a,h=encodeURIComponent(encode64(t)),e="action=fetch&sql_query="+h,_adp.currentAsyncJqxhr=$.post("api.php",e,"json").done(function(a){var e,f,g,h,k,l,m,n,o,p,q;e=a.parsed_responses[0],f=[],h=[],_adp.cartoRows={},m=e.rows;for(g in m){o=m[g],_adp.cartoRows[g]={};for(i in o)q=o[i],l=null!=(n=j[i])?n:i,_adp.cartoRows[g][l]=q;p=o.st_astext,isNull(o.infraspecificepithet)&&(o.infraspecificepithet=""),k=pointStringToLatLng(p,!0),d={title:o.catalognumber+": "+o.genus+" "+o.specificepithet+" "+o.infraspecificepithet,html:'<p>\n  <span class="sciname italic">'+o.genus+" "+o.specificepithet+" "+o.infraspecificepithet+"</span> collected on "+o.dateidentified+"\n</p>\n<p>\n  <strong>Status:</strong>\n  Sampled by "+o.samplemethod+", disease status "+o.diseasedetected+" for "+o.diseasetested+"\n</p>"},k.infoWindow=d,f.push(k),h.push(d)}if(dataAttrs.coords=f,dataAttrs.markerInfo=h,console.info("Calling back with",f,b),"function"==typeof c)return c(f,b)}).fail(function(a,d){return null!=(null!=dataAttrs?dataAttrs.coords:void 0)?c(dataAttrs.coords,b):(stopLoadError("Couldn't get bounding coordinates from data"),console.error("No valid coordinates accessible!"))})}).fail(function(a,b){return!1})}),!1)},getUploadIdentifier=function(){var a,b,c;if(isNull(_adp.uploadIdentifier)){if(isNull(_adp.projectId)){if(a=$.cookie(adminParams.domain+"_link"),isNull(_adp.projectIdentifierString)){try{c=isNull(p$("#project-title").value)?randomString(16):p$("#project-title").value}catch(a){c=randomString(16)}b="t"+md5(c+a),_adp.projectIdentifierString=b}_adp.projectId=md5(""+b+a+Date.now())}_adp.uploadIdentifier=md5(""+user+_adp.projectId)}return _adp.uploadIdentifier},bootstrapUploader=function(a,b,c){var d,e;return null==a&&(a="file-uploader"),null==b&&(b="col-md-4"),e="#"+a,$.cookie(adminParams.domain+"_link"),getUploadIdentifier(),_adp.projectIdentifierString,$(e).exists()||(d='<form id="'+a+'-form" class="'+b+' clearfix">\n  <p class="visible-xs-block">Tap the button to upload a file</p>\n  <fieldset class="hidden-xs">\n    <legend>Upload Files</legend>\n    <div id="'+a+'" class="media-uploader outline media-upload-target">\n    </div>\n  </fieldset>\n</form>',$("main #uploader-container-section").append(d),console.info("Appended upload form"),$(e).submit(function(a){return a.preventDefault(),a.stopPropagation(),!1})),verifyLoginCredentials(function(){var a;return null==window.dropperParams&&(window.dropperParams={}),window.dropperParams.dropTargetSelector=e,window.dropperParams.uploadPath="uploaded/"+getUploadIdentifier()+"/",a=!0===window.dropperParams.hasInitialized,loadJS("helpers/js-dragdrop/client-upload.min.js",function(){if(console.info("Loaded drag drop helper"),a){console.info("Reinitialized dropper");try{window.dropperParams.initialize()}catch(a){console.warn("Couldn't reinitialize dropper!")}}if(window.dropperParams.postUploadHandler=function(a,b){var c,d,e,f,g,h,i,j,k;if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof b)return console.error("Dropzone returned an error - "+b),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(!0!==b.status)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(""+b.human_error),console.error("Error uploading!",b),!1;try{switch(console.info("Server returned the following result:",b),console.info("The script returned the following file information:",a),i="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",e=b.full_path.split("/").pop(),k=b.wrote_thumb,h=b.mime_provided.split("/")[0],g=b.mime_provided.split("/")[1],f=a.size<5242880||"image"!==h?""+i+b.wrote_file:""+i+k,j=function(){switch(h){case"image":return'<div class="uploaded-media center-block" data-system-file="'+e+'" data-link-path="'+f+'">\n  <img src="'+f+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+a.name+" -> "+e+'\n      (<a href="'+f+'" class="newwindow" download="'+a.name+'">\n        Original Image\n      </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+e+'">\n  <audio src="'+f+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+a.name+" -> "+e+'\n    (<a href="'+f+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+e+'">\n  <video src="'+f+'" controls preload="auto">\n    <img src="'+i+k+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+a.name+" -> "+e+'\n    (<a href="'+f+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+e+'" data-link-path="'+f+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+a.name+" -> "+e+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(j),$("#validator-progress-container").remove(),f.slice(0),c=f.slice(0),d=c.split(".").pop(),h){case"application":switch(console.info("Checking "+g+" in application"),g){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":return excelHandler(f);case"vnd.ms-office":switch(d){case"xls":return excelHandler(f);default:return stopLoadError("Sorry, we didn't understand the upload type."),!1}break;case"zip":case"x-zip-compressed":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===a.type||"xlsx"===d?excelHandler(f):"kmz"===d?kmlHandler(f):zipHandler(f);case"x-7z-compressed":return _7zHandler(f);case"vnd.google-earth.kml+xml":case"vnd.google-earth.kmz":case"xml":return"kml"===d||"kmz"===d?kmlHandler(f):(console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+g),!1);default:return console.warn("Unknown mime type application/"+g),allError("Sorry, we can't processes files of type application/"+g),!1}break;case"text":return csvHandler(f);case"image":return imageHandler(f)}}catch(a){return a,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}},"function"==typeof c)return c()}),!1})},singleDataFileHelper=function(a,b){var c;if("function"!=typeof b)return console.error("Second argument must be a function"),!1;if(!0===dataFileParams.hasDataFile&&a!==dataFileParams.filePath){try{$("#bs-alert").remove()}catch(a){}return $("#single-data-file-modal").exists()&&$("#single-data-file-modal").remove(),c='<paper-dialog modal id="single-data-file-modal">\n  <h2>You can only have one primary data file</h2>\n  <div>\n    Continuing will remove your previous one\n  </div>\n  <div class="buttons">\n    <paper-button id="cancel-parse">Cancel Upload</paper-button>\n    <paper-button id="overwrite">Replace Previous</paper-button>\n  </div>\n</paper-dialog>',$("body").append(c),$("#cancel-parse").click(function(){return removeDataFile(a,!1),p$("#single-data-file-modal").close(),!1}),$("#overwrite").click(function(){return removeDataFile(),p$("#single-data-file-modal").close(),b()}),safariDialogHelper("#single-data-file-modal")}return b()},excelHandler=function(a,b,c){var d,e,f,g,h,i,j,k;null==b&&(b=!0),startLoad(),$("#validator-progress-container").remove(),renderValidateProgress(),g=helperDir+"excelHelper.php",e=a,-1!==a.search(helperDir)&&(console.info("removing '"+helperDir+"'"),e=a.slice(helperDir.length)),console.info("Pinging for "+e),d="action=parse&path="+e+"&sheets=Samples",f=!1;try{for(k=$("paper-input[required]"),i=0,j=k.length;i<j;i++)if(h=k[i],p$(h).invalid){f=!0,stopLoadError("Please fill out all required fields before uploading data"),bsAlert("Please fill out all required fields before uploading data","danger");try{stopLoadBarsError()}catch(a){}return removeDataFile(e),!1}}catch(a){}return f?(console.error("Exiting handler -- invalid inputs"),!1):($.get(g,d,"json").done(function(b){return console.info("Got result",b),!1===b.status?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):singleDataFileHelper(a,function(){var d;$("#upload-data").attr("disabled","disabled"),d=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=d.pop(),dataFileParams.filePath=e,Object.size(b.data),uploadedData=b.data,_adp.parsedUploadedData=b.data;try{p$("#replace-data-toggle").disabled=!1}catch(a){}return"function"!=typeof c?newGeoDataHandler(b.data):(console.warn("Skipping newGeoDataHandler() !"),c(b.data)),stopLoad()})}).fail(function(a,b){return console.error("Couldn't POST"),console.warn(a,b),stopLoadError()}),!1)},csvHandler=function(a,b,c){var d;return null==b&&(b=!0),-1!==a.search(helperDir)&&(console.info("removing '"+helperDir+"'"),d=a.slice(helperDir.length)),singleDataFileHelper(a,function(){var b;return $("#upload-data").attr("disabled","disabled"),b=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=b.pop(),dataFileParams.filePath=d,geoDataHandler()}),!1},kmlHandler=function(a,b){var c,d;try{console.debug("Loading KML file")}catch(a){}return geo.inhibitKMLInit=!0,c=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(d=_adp.lastMod)?d.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),loadJS(c,function(){return initializeParser(null,function(){return loadKML(a,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;try{if(o=geo.kml.parser.docsByUrl[a],isNull(o)&&(a="/"+a,o=geo.kml.parser.docsByUrl[a],isNull(o)&&(console.warn("Could not resolve KML by url, using first doc"),o=geo.kml.parser.docs[0])),isNull(o))return allError("Bad KML provided"),!1;for(console.debug("Using parsed data from path '"+a+"'",o),t=[],r=[],s=[],u=o.gpolygons,i=0,j=u.length;i<j;i++){for(q=u[i],p=[],r.push(q.fillColor),s.push(q.fillOpacity),v=q.getPaths().getArray(),m=0,k=v.length;m<k;m++)for(x=v[m],w=x.getArray(),n=0,l=w.length;n<l;n++)y=w[n],A=canonicalizePoint(y),p.push(A);t.push(p)}window.kmlInfo={},kmlInfo.path=a;try{if(z=t[0],1===t.length&&(t=t[0]),c={fillOpacity:s[0],fillColor:r[0],paths:z,multibounds:t},kmlInfo.parameters=c,kmlInfo.polys=t,isNull(geo)&&(window.geo={}),isNull(geo.canonicalHullObject)&&(geo.canonicalHullObject={}),geo.canonicalHullObject.hull=z,geo.canonicalBoundingBox=c,!isNull("undefined"!=typeof _adp&&null!==_adp?_adp.projectData:void 0))try{if("object"!=typeof(f=_adp.projectData.carto_id))try{d=JSON.parse(deEscape(f))}catch(a){g=a,h=g.message;try{d=JSON.parse(f)}catch(a){if(g=a,f.length>511&&"object"==typeof(e=fixTruncatedJson(f))&&(console.debug("The carto data object was truncated, but rebuilt."),d=e),isNull(d))return console.error("cartoObj must be JSON string or obj, given",f),console.warn("Cleaned obj:",deEscape(f)),console.warn("Told '"+h+"' then",g.message),stopLoadError("Couldn't parse data"),!1}}else d=f;d.bounding_polygon=c,_adp.projectData.carto_id=JSON.stringify(d)}catch(a){g=a,console.error(g.message),console.warn(g.stack),allError("Warning: there may have been a problem saving your carto data")}}catch(a){g=a,console.warn("WARNING: Couldn't write polygon data to globals")}"function"==typeof b?b(kmlInfo):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(a){g=a,allError("There was an error importing the data from this KML file"),console.warn(g.message),console.warn(g.stack)}return!1}),!1}),!1}),!1},copyMarkdown=function(a,b,c){var d,e,f,g,h,i;if(null==c&&(c=!0),null==("undefined"!=typeof _adp&&null!==_adp?_adp.zcClient:void 0)&&(i={swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"},ZeroClipboard.config(i),_adp.zcClient=new ZeroClipboard($(a).get(0)),$("#copy-ark").click(function(){return copyLink(_adp.zcClient)})),d=p$(".ark-identifier").value,c)try{return h="https://n2t.net/"+d,f={dataType:"text/plain",data:h,"text/plain":h},e=new ClipboardEvent("copy",f),document.dispatchEvent(e),toastStatusMessage("ARK resolver path copied to clipboard"),!1}catch(a){g=a,console.error("Error creating copy: "+g.message),console.warn(g.stack)}return console.warn("Can't use HTML5"),"undefined"!=typeof zeroClipObj&&null!==zeroClipObj?(zeroClipObj.setData(f),null!=b&&b.setData(f),zeroClipObj.on("aftercopy",function(a){return a.data["text/plain"]?toastStatusMessage("ARK resolver path copied to clipboard"):toastStatusMessage("Error copying to clipboard")}),zeroClipObj.on("error",function(a){if(console.error("Error copying to clipboard"),console.warn("Got",a),"flash-overdue"===a.name){if(!0===_adp.resetClipboard)return console.error("Resetting ZeroClipboard didn't work!"),!1;ZeroClipboard.on("ready",function(){return _adp.resetClipboard=!0,copyLink()}),_adp.zcClient=new ZeroClipboard($("#copy-ark").get(0))}if("flash-disabled"===a.name)return console.info("No flash on this system"),ZeroClipboard.destroy(),$("#copy-ark").tooltip("destroy").remove(),$(".ark-identifier").removeClass("col-xs-9 col-md-11").addClass("col-xs-12"),toastStatusMessage("Clipboard copying isn't available on your system")})):console.error("Can't use HTML, and ZeroClipboard wasn't passed"),!1},imageHandler=function(a){return $("div[data-link-path='"+a+"']"),foo(),!1},zipHandler=function(a){return foo(),!1},_7zHandler=function(a){return foo(),!1},removeDataFile=function(a,b){var c;return null==a&&(a=dataFileParams.fileName),null==b&&(b=!0),a=a.split("/").pop(),b&&(dataFileParams.hasDataFile=!1),$(".uploaded-media[data-system-file='"+a+"']").remove(),$("#validator-progress-container paper-progress").removeAttr("indeterminate"),c=helperDir+"/js-dragdrop/uploaded/"+_adp.uploadIdentifier+"/"+a,"action=removefile&path="+encode64(c)+"&user="+user,!1},newGeoDataHandler=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N;null==a&&(a={}),null==b&&(b=!1),console.info("Starting geoDataHandler()");try{if(null==geo.geocoder)try{geo.geocoder=new google.maps.Geocoder}catch(a){}try{D=a[0]}catch(a){return toastStatusMessage("Your data file was malformed, and could not be parsed. Please try again."),removeDataFile(),!1}if(isNull(D.decimalLatitude)||isNull(D.decimalLongitude)||isNull(D.coordinateUncertaintyInMeters))return toastStatusMessage("Data are missing required geo columns. Please reformat and try again."),v="You're missing ",u=[],isNull(D.decimalLatitude)&&u.push("decimalLatitude"),isNull(D.decimalLongitude)&&u.push("decimalLongitude"),isNull(D.coordinateUncertaintyInMeters)&&u.push("coordinateUncertaintyInMeters"),v+=u.length>1?"some required columns: ":"a required column: ",t=u.join("</code>, <code>"),v+="<code>"+t+"</code>",bsAlert(v,"danger"),console.info("Missing: ",null!=D.decimalLatitude,null!=D.decimalLongitude,null!=D.coordinateUncertaintyInMeters),removeDataFile(),!1;if(!(isNumber(D.decimalLatitude)&&isNumber(D.decimalLongitude)&&isNumber(D.coordinateUncertaintyInMeters)))return toastStatusMessage("Data has invalid entries for geo columns. Please be sure they're all numeric and try again."),removeDataFile(),!1;C=Object.size(a);try{p$("#samplecount").value=C}catch(a){}if(isNull($("#project-disease").val()))try{p$("#project-disease").value=D.diseaseTested}catch(a){}y={},dataAttrs.coords=[],dataAttrs.coordsFull=[],dataAttrs.fimsData=[],p={},toastStatusMessage("Please wait, parsing your data"),$("#data-parsing").removeAttr("indeterminate");try{p$("#data-parsing").max=C}catch(a){}Date.now(),M=[],n=[];for(x in a){B=a[x],z=toInt(x)+1,H={},L=[];for(g in B){if(N=B[g],g=g.trim(),indexOf.call(L,g)>=0)return console.error("There was a duplicate column '"+g+"'",L),stopLoadBarsError(null,"You have at least one duplicate column '"+g+"'. Ensure all your columns are unique."),!1;switch(F=!1,g){case"ContactName":case"basisOfRecord":case"occurrenceID":case"institutionCode":case"collectionCode":case"labNumber":case"originalsource":case"datum":case"georeferenceSource":case"depth":case"Collector2":case"Collector3":case"verbatimLocality":case"Habitat":case"Test_Method":case"eventRemarks":case"quantityDetected":case"dilutionFactor":case"cycleTimeFirstDetection":if("string"==typeof N)try{N=N.replace(/;/gim,"&#59;"),N=N.replace(/'/gim,"&#39;"),N=N.replace(/"/gim,"&#34;")}catch(a){console.warn("Couldn't replace quotes for this:",N)}p[g]=N,F=!0;break;case"specimenDisposition":g="sampleDisposition";break;case"sampleType":g="sampleMethod";break;case"elevation":g="alt";break;case"dateCollected":case"dateIdentified":if(g="dateIdentified",G=excelDateToUnixTime(N,!0),!isNumber(G))return console.error("This row (#"+z+") has a non-date value ! ("+N+" = "+G+")"),stopLoadBarsError(null,"Detected an invalid date '"+N+"' at row #"+z+". Check your dates!"),!1;if(k=new Date(G),K=new Date("1868-03-23"),G<K.getTime())return console.error("This row (#"+z+") has a date ("+N+" = "+G+") too far in the past!"),stopLoadBarsError(null,"Detected an implausibly old date '"+N+"' = <code>"+k.toDateString()+"</code> at row #"+z+". Check your dates!"),!1;if(G>Date.now())return console.error("This row (#"+z+") has a date ("+N+" = "+G+") after today!"),stopLoadBarsError(null,"Detected a future date '"+N+"' at row #"+z+". Check your dates!"),!1;m=k.getUTCDate(),m<10&&(m="0"+m),w=k.getUTCMonth()+1,w<10&&(w="0"+w),f=k.getUTCFullYear()+"-"+w+"-"+m;break;case"fatal":f=N.toBool();break;case"decimalLatitude":case"decimalLongitude":case"alt":case"coordinateUncertaintyInMeters":if(!isNumber(N))return stopLoadBarsError(null,"Detected an invalid number for "+g+" at row "+z+" (<code>"+N+"</code>)"),!1;if("decimalLatitude"===g&&(N<-90||N>90))return stopLoadBarsError(null,"Detected an invalid latitude <code>"+N+"</code> at row "+z+"<br/><br/>Valid latitudes are between <code>90</code> and <code>-90</code>."),!1;if("decimalLongitude"===g&&(N<-180||N>180))return stopLoadBarsError(null,"Detected an invalid longitude <code>"+N+"</code> at row "+z+"<br/><br/>Valid latitudes are between <code>180</code> and <code>-180</code>."),!1;if("coordinateUncertaintyInMeters"===g&&N<=0)return stopLoadBarsError(null,"Coordinate uncertainty must be >= 0 at row "+z),!1;f=toFloat(N);break;case"diseaseDetected":if(isBool(N))f=N.toBool();else try{f="negative"!==N.trim().toLowerCase()&&("positive"===N.trim().toLowerCase()||"NO_CONFIDENCE")}catch(a){f="NO_CONFIDENCE"}break;case"sex":try{N=N.trim().toLowerCase(),N="m"===N.slice(0,1)?"male":"f"===N.slice(0,1)?"female":"not determined"}catch(a){N="not determined"}break;case"sampleId":try{J=N.trim(),"n/a"===J.toLowerCase()&&(J=""),J=J.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2"),f=J}catch(a){f=N}indexOf.call(M,f)<0?M.push(f):indexOf.call(n,f)<0&&n.push(f);break;default:try{f=N.trim()}catch(a){f=N}}F||(H[g]=f)}h={lat:H.decimalLatitude,lng:H.decimalLongitude,alt:H.alt,uncertainty:H.coordinateUncertaintyMeters},i=new Point(h.lat,h.lng),dataAttrs.coords.push(i),dataAttrs.coordsFull.push(h),dataAttrs.fimsData.push(p);try{H.fimsExtra=JSON.stringify(p)}catch(a){console.warn("Couldn't store FIMS extra data",p)}y[x]=H,0===modulo(x,500)&&x>0&&(toastStatusMessage("Processed "+x+" rows ..."),console.log("Processed "+x+" rows ..."));try{p$("#data-parsing").value=x+1}catch(a){}}try{console.log("Basic validation passed"),isNull(n)||bsAlert("<strong>Warning</strong>: the following field IDs all had duplicates:<br/><code>"+n+"</code></br>We <strong>strongly</strong> recommend unique IDs.","warning")}catch(a){}isNull(_adp.projectIdentifierString)?(A="t"+md5(p$("#project-title").value+d+Date.now()),_adp.projectIdentifierString=A):A=_adp.projectIdentifierString;try{j={downloadFile:"cleaned-dataset-"+Date.now()+".csv",selector:"#download-server-parsed-data"},downloadCSVFile(y,j),window.parsedData=y,_adp.cleanedAndParsedData=y}catch(a){}q=function(){var a,b,c,d,e,f,g;for(b=0,c={},f=sortPoints(dataAttrs.coords),g="",d=0,e=f.length;d<e;d++)a=f[d],c[b]=[a.lat,a.lng],g+=a.lat+","+a.lng+"\n",++b;try{p$("#transect-input-toggle").checked=!0,g+="\n",$(p$("#coord-input").textarea).val(g)}catch(a){}return c},null==geo.boundingBox&&(geo.boundingBox=q()),e=getMapCenter(geo.boundingBox),geo.reverseGeocode(e.lat,e.lng,geo.boundingBox,function(a){_adp.locality=a,dataAttrs.locality=a;try{return p$("#locality-input").value=a,p$("#locality-input").readonly=!0}catch(a){}}),E={mortality:0,morbidity:0,positive:0,negative:0,no_confidence:0};for(r in y){switch(l=y[r],l.diseaseDetected){case!0:E.morbidity++,E.positive++;break;case!1:E.negative++;break;case"NO_CONFIDENCE":E.no_confidence++}l.fatal&&E.mortality++}try{p$("#positive-samples").value=E.positive,p$("#negative-samples").value=E.negative,p$("#no_confidence-samples").value=E.no_confidence,p$("#morbidity-count").value=E.morbidity,p$("#mortality-count").value=E.mortality}catch(a){}isNull(_adp.projectId)&&(d=$.cookie(adminParams.domain+"_link"),_adp.projectId=md5(""+A+d+Date.now())),I={transectRing:geo.boundingBox,data:y,samples:E,dataSrc:""+helperDir+dataFileParams.filePath},null==("undefined"!=typeof _adp&&null!==_adp?_adp.data:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),window._adp.data={}),_adp.data.pushDataUpload=I,validateData(I,function(a){var d,e,f,g,h,i,k,l,m,n,o,p,q;for(p="",o=[],d=[],f=0,l=a.validated_taxa,g=0,h=l.length;g<h;g++){n=l[g],q=n.genus+" "+n.species,null!=n.response.original_taxon&&(console.info("Taxon obj",n),k=""+n.response.original_taxon.slice(0,1).toUpperCase()+n.response.original_taxon.slice(1),i='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+k+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+q+"</em>' below. <a href=\""+n.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(i)),isNull(n.subspecies)||(q+=" "+n.subspecies),indexOf.call(o,q)<0&&(f>0&&(p+="\n"),p+=""+q,o.push(q));try{m=n.response.validated_taxon.family,indexOf.call(d,m)<0&&d.push(n.response.validated_taxon.family)}catch(a){e=a,console.warn("Couldn't get the family! "+e.message,n.response),console.warn(e.stack)}++f}try{p$("#species-list").bindValue=p}catch(a){}if(dataAttrs.dataObj=a,_adp.data.dataObj=a,_adp.data.taxa={},_adp.data.taxa.list=o,_adp.data.taxa.clades=d,_adp.data.taxa.validated=a.validated_taxa,"function"!=typeof b&&!0!==b){try{j={
downloadFile:"cleaned-dataset-"+Date.now()+".csv",selector:"#download-server-parsed-data"},downloadCSVFile(a,j)}catch(a){}return geo.requestCartoUpload(a,A,"create",function(a,b,d){return createMap2(b,d,function(){if(window.mapBuilder.points=[],$("#init-map-build").attr("disabled","disabled"),$("#init-map-build .points-count").text(window.mapBuilder.points.length),"function"==typeof c)return c(a,b)})})}return"function"==typeof b?b(a,A):console.warn("Carto upload was skipped, but no callback provided")})}catch(a){o=a,console.error("Error parsing data - "+o.message),console.warn(o.stack),s='There was a problem parsing your data. Please check <a href="http://biscicol.org/biocode-fims/templates.jsp" class="newwindow alert-link" data-newtab="true">biscicol.org FIMS requirements<span class="glyphicon glyphicon-new-window"></span></a>',stopLoadBarsError(null,s)}return!1},excelDateToUnixTime=function(a,b){var c,d,e,f,g,h,i;null==b&&(b=!1),e=1863,c=new Date,i=c.getUTCFullYear();try{if(!isNumber(a))throw"Bad date error";if(e<=a&&a<=i)f=a+"-01-03",h=Date.parse(f);else if(0<a&&a<1e6){if(d=25569,24107,g=86400,h=(a-d)*g*1e3,!isNumber(h))throw console.warn("excelDateToUnixTime got bad number: "+a+" -> "+h),"Bad Number Error"}else h=Date.parse(a)}catch(a){h=!b&&Date.now()}return h},renderValidateProgress=function(a,b){var c;return null==a&&(a="#file-uploader-form"),null==b&&(b=!1),c='<div id="validator-progress-container" class="col-md-6 col-xs-12">\n  <label for="data-parsing">Data Parsing:</label><paper-progress id="data-parsing" class="blue" indeterminate></paper-progress>\n  <label for="data-validation">Data Validation:</label><paper-progress id="data-validation" class="cyan" indeterminate></paper-progress>\n  <label for="taxa-validation">Taxa Validation:</label><paper-progress id="taxa-validation" class="teal" indeterminate></paper-progress>\n  <label for="data-sync">Estimated Data Sync Progress:</label><paper-progress id="data-sync" indeterminate></paper-progress>\n  <br/><br/>\n  <button class="btn btn-danger" id="cancel-new-upload"><iron-icon icon="icons:cancel"></iron-icon> Cancel</button>\n</div>',$("#validator-progress-container").exists()||($(a).after(c),$("#cancel-new-upload").click(function(){return cancelAsyncOperation(this)})),!!b&&c},checkInitLoad=function(a){var b,c,d;if($("#please-wait-prefill").remove(),d=uri.o.param("id"),isNull(d))if(b="string"==typeof a?a:"object"==typeof a?a.do+":"+a.prop:uri.o.attr("fragment"),isNull(b))"function"==typeof a&&a();else switch(c=b.split(":"),console.info("Looking at fragment",b,c),c[0]){case"edit":loadEditor(c[1]);break;case"action":switch(c[1]){case"show-editable":loadEditor();break;case"create-project":loadCreateNewProject();break;case"show-viewable":loadProjectBrowser();break;case"show-su-viewable":loadSUProjectBrowser();break;case"show-su-profiles":loadSUProfileBrowser()}break;case"home":populateAdminActions()}else loadEditor(d);return!1},window.onpopstate=function(a){return console.log("State popped",a,a.state),checkInitLoad(a.state),!1},$(function(){$("#next").exists()&&$("#next").unbind().click(function(){return openTab(adminParams.adminPageUrl)}),loadJS("bower_components/bootstrap/dist/js/bootstrap.min.js",function(){return $("body").tooltip({selector:"[data-toggle='tooltip']"})}),checkFileVersion(!1,"js/admin.min.js"),$("paper-icon-button[icon='icons:dashboard']").removeAttr("data-href").unbind("click").click(function(){return populateAdminActions()});try{return checkFileVersion(!0,"js/kml.min.js")}catch(a){}}),kmlLoader=function(a,b){var c,d,e,f,g,h;try{if("object"==typeof a)e=a,a=e.path;else try{e=JSON.parse(a),a=e.path}catch(b){try{e=JSON.parse(deEscape(a)),a=e.path}catch(b){a.length>511&&"object"==typeof(g=fixTruncatedJson(a))&&(e=g,a=e.path),isNull(e)&&(e={path:a})}}console.debug("Loading KML file",a)}catch(a){}if(geo.inhibitKMLInit=!0,d=isNull("undefined"!=typeof _adp&&null!==_adp&&null!=(h=_adp.lastMod)?h.kml:void 0)?"js/kml.min.js":"js/kml.min.js?t="+_adp.lastMod.kml,startLoad(),!$("google-map").exists()){if(c='<google-map id="transect-viewport" class="col-xs-12 col-md-9 col-lg-6 kml-lazy-map" api-key="'+gMapsApiKey+'" map-type="hybrid">\n</google-map>',f='<div class="row">\n  <h2 class="col-xs-12">Mapping Data</h2>\n  '+c+"\n</div>",!$("#auth-block").exists())return console.warn("Couldn't find an authorization block to render the KML map in!"),!1;$("#auth-block").append(f),_adp.mapRendered=!0}return loadJS(d,function(){return initializeParser(null,function(){return loadKML(a,function(){var c,d;try{if(d=geo.kml.parser.docsByUrl[a],isNull(d)&&(a="/"+a,d=geo.kml.parser.docsByUrl[a],isNull(d)&&(console.warn("Could not resolve KML by url, using first doc"),d=geo.kml.parser.docs[0])),isNull(d))return allError("Bad KML provided"),!1;console.debug("Using parsed data from path '"+a+"'",d),"function"==typeof b?b(d):console.info("kmlHandler wasn't given a callback function"),stopLoad()}catch(a){c=a,allError("There was a importing the data from this KML file"),console.warn(c.message),console.warn(c.stack)}return!1}),!1}),!1}),!1},loadEditor=function(a){var b,c;return startAdminActionHelper(),b=function(a){var b,d;return startAdminActionHelper(),d=uri.urlString+"admin-page.html#edit:"+a,b={do:"edit",prop:a},history.pushState(b,"Editing #"+a,d),startLoad(),window.projectParams={},window.projectParams.pid=a,verifyLoginCredentials(function(b){var d,e,f;return f=b.detail,user=f.uid,e=a,a=encodeURIComponent(a),d="perform=get&project="+a,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,d,"json").done(function(b){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da;try{if(console.info("Server said",b),!0!==b.status)return t=null!=(Q=b.human_error)?Q:b.error,null==t&&(t="Unidentified Error"),stopLoadError("There was a problem loading your project ("+t+")"),console.error("Couldn't load project! (POST OK) Error: "+b.error),console.warn("Attempted",adminParams.apiTarget+"?"+d),!1;if(!0!==b.user.has_edit_permissions)return b.user.has_view_permissions||!0===b.project.public.toBool()?(loadProject(e,"Ineligible to edit "+e+", loading as read-only"),delay(1e3,function(){return loadProject(a)}),!1):(alertBadProject(e),!1);for(O=b.project,O.access_data.total=Object.toArray(O.access_data.total),O.access_data.total.sort(),O.access_data.editors_list=Object.toArray(O.access_data.editors_list),O.access_data.viewers_list=Object.toArray(O.access_data.viewers_list),O.access_data.editors=Object.toArray(O.access_data.editors),O.access_data.viewers=Object.toArray(O.access_data.viewers),console.info("Project access lists:",O.access_data),_adp.projectData=O,_adp.originalProjectId=O.project_id,_adp.fetchResult=b,_="",x=[],R=O.access_data.total,B=0,C=R.length;B<C;B++){user=R[B];try{if(Z=O.access_data.composite[user].user_id,indexOf.call(x,Z)>=0)continue;x.push(Z)}catch(a){}A="",user===O.access_data.author?A='<iron-icon icon="social:person"></iron-icon>':indexOf.call(O.access_data.editors_list,user)>=0?A='<iron-icon icon="image:edit"></iron-icon>':indexOf.call(O.access_data.viewers_list,user)>=0&&(A='<iron-icon icon="icons:visibility"></iron-icon>'),_+='<tr class="user-permission-list-row" data-user="'+Z+'">\n  <td colspan="5">'+user+'</td>\n  <td class="text-center user-current-permission">'+A+"</td>\n</tr>"}A=O.public.toBool()?'<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>':'<iron-icon icon="icons:lock" class="material-red" data-toggle="tooltip" title="Private Project"></iron-icon>',P=O.public.toBool()?"\x3c!-- This project is already public --\x3e":b.user.is_author?'<div class="col-xs-12">\n  <paper-toggle-button id="public" class="project-params danger-toggle red">\n    <iron-icon icon="icons:warning"></iron-icon>\n    Make this project public\n  </paper-toggle-button> <span class="text-muted small">Once saved, this cannot be undone</span>\n</div>':"\x3c!-- This user does not have permission to toggle the public state of this project --\x3e",m=b.user.has_edit_permissions?"":"readonly",f=O.includes_anura.toBool()?"checked disabled":"disabled",j=O.includes_caudata.toBool()?"checked disabled":"disabled",w=O.includes_gymnophiona.toBool()?"checked disabled":"disabled";try{i=JSON.parse(deEscape(O.carto_id))}catch(a){console.error("Couldn't parse the carto JSON!",O.carto_id),stopLoadError("We couldn't parse your data. Please try again later."),i={}}"";try{h=Object.toArray(i.bounding_polygon)}catch(a){h=null}n={boundingBox:h,classes:"carto-data map-editor",bsGrid:"",skipPoints:!1,skipHull:!1,onlyOne:!0},geo.mapOptions=n,null==(null!=(S=i.bounding_polygon)?S.paths:void 0)&&(v='<google-map id="transect-viewport" latitude="'+O.lat+'" longitude="'+O.lng+'" fit-to-markers map-type="hybrid" disable-default-ui  api-key="'+gMapsApiKey+'">\n</google-map>'),null==v&&(v=""),geo.googleMapWebComponent=v,r=b.user.is_author?'<div class="card-actions">\n      <paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>\n    </div>':"",H=isNull(O.sample_notes)?"*No notes for this project*":O.sample_notes.unescape(),M='<h3>Project Notes</h3>\n<ul class="nav nav-tabs" id="markdown-switcher">\n  <li role="presentation" class="active" data-view="md"><a>Preview</a></li>\n  <li role="presentation" data-view="edit"><a>Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-notes" class="markdown-pair project-param language-markdown" rows="3" data-field="sample_notes" hidden '+m+">"+O.sample_notes+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="note-preview">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+H+"<\/script>\n</marked-element>",G=isNull(O.extended_funding_reach_goals)?"*No funding reach goals*":O.extended_funding_reach_goals.unescape(),u='<ul class="nav nav-tabs" id="markdown-switcher-funding">\n  <li role="presentation" class="active" data-view="md"><a>Preview</a></li>\n  <li role="presentation" data-view="edit"><a>Edit</a></li>\n</ul>\n<iron-autogrow-textarea id="project-funding" class="markdown-pair project-param language-markdown" rows="3" data-field="extended_funding_reach_goals" hidden '+m+">"+O.extended_funding_reach_goals+'</iron-autogrow-textarea>\n<marked-element class="markdown-pair" id="preview-funding">\n  <div class="markdown-html"></div>\n  <script type="text/markdown">'+G+"<\/script>\n</marked-element>";try{g=JSON.parse(O.author_data),o=new Date(toInt(g.entry_date))}catch(a){g={},o={},o.toLocaleString=function(){return"Error retrieving creation time"}}for(J="",K=O.sampling_months.split(","),L=[],z=0,F=0,D=K.length;F<D;F++)I=K[F],++z,z>1&&z===K.length?(K.length>2&&(J+=","),J+=" and "):z>1&&(J+=", "),isNumber(I)&&(L.push(I),I=dateMonthToString(I)),J+=I;for(z=0,ba="",ca=O.sampling_years.split(","),da=[],z=0,N=0,E=ca.length;N<E;N++)aa=ca[N],++z,isNumber(aa)&&(da.push(toInt(aa)),z>1&&z===ca.length?(da.length>2&&(ba+=","),ba+=" and "):z>1&&(ba+=", "),ba+=aa);ba=1===ca.length?"the year "+ba:"the years "+ba,ca=da,0!==toInt(O.sampled_collection_start)?(p=new Date(toInt(O.sampled_collection_start)),q=new Date(toInt(O.sampled_collection_end)),l=dateMonthToString(p.getMonth())+" "+p.getFullYear()+" &#8212; "+dateMonthToString(q.getMonth())+" "+q.getFullYear()):l="<em>(no data)</em>",(0===K.length||isNull(J))&&(J="<em>(no data)</em>"),(0===ca.length||isNull(ba))&&(ba="<em>(no data)</em>"),X=null!=(null!=i&&null!=(T=i.raw_data)?T.filePath:void 0)?"":"checked disabled",isNull(O.technical_contact)&&(O.technical_contact=g.name),isNull(O.technical_contact_email)&&(O.technical_contact_email=g.contact_email),y='<h2 class="clearfix newtitle col-xs-12">'+O.project_title+" "+A+' <paper-icon-button icon="icons:visibility" class="click" data-href="'+uri.urlString+"project.php?id="+e+'" data-toggle="tooltip" title="View in Project Viewer" data-newtab="true"></paper-icon-button><br/><small>Project #'+e+"</small></h2>\n"+P+'\n<section id="manage-users" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Collaborators" elevation="2">\n    <div class="card-content">\n      <table class="table table-striped table-condensed table-responsive table-hover clearfix" id="permissions-table">\n        <thead>\n          <tr>\n            <td colspan="5">User</td>\n            <td>Permissions</td>\n          </tr>\n        </thead>\n        <tbody>\n          '+_+'\n        </tbody>\n      </table>\n    </div>\n    <div class="card-actions">\n      <paper-button class="manage-users" id="manage-users-button">Manage Users</paper-button>\n    </div>\n  </paper-card>\n</section>\n<section id="project-basics" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Basics</h3>\n  <paper-input readonly label="Project Identifier" value="'+O.project_id+'" id="project_id" class="project-param"></paper-input>\n  <paper-input readonly label="Project Creation" value="'+o.toLocaleString()+'" id="project_creation" class="author-param" data-key="entry_date" data-value="'+g.entry_date+'"></paper-input>\n  <div class="row">\n    <paper-input readonly label="Project ARK" value="'+O.project_obj_id+'" id="project_creation" class="project-param col-xs-11"></paper-input>\n    '+getInfoTooltip("ARK or Archival Resource Key identifier is a persistent, citable identifier for this project and maybe used to cite these data in a publication or report. We use the California Digital Library Name Assigning Authority")+"\n  </div>\n  <paper-input "+m+' class="project-param" label="Project Title" value="'+O.project_title+'" id="project-title" data-field="project_title"></paper-input>\n  <paper-input '+m+' class="project-param" label="Primary Pathogen" value="'+O.disease+'" data-field="disease"></paper-input>\n  <paper-input '+m+' class="project-param" label="PI Lab" value="'+O.pi_lab+'" id="project-title" data-field="pi_lab"></paper-input>\n  <paper-input '+m+' class="project-param" label="Project Reference" value="'+O.reference_id+'" id="project-reference" data-field="reference_id"></paper-input>\n  <div class="row">\n    <paper-input '+m+' class="project-param col-xs-11" label="Publication DOI" value="'+O.publication+'" id="doi" data-field="publication"></paper-input>\n    '+getInfoTooltip("Publication DOI citing these datasets may be added here.")+"\n  </div>\n  <paper-input "+m+' class="author-param" data-key="name" label="Project Contact" value="'+g.name+'" id="project-contact"></paper-input>\n  <gold-email-input '+m+' class="author-param" data-key="contact_email" label="Contact Email" value="'+g.contact_email+'" id="contact-email"></gold-email-input>\n  <paper-input '+m+' class="author-param" data-key="diagnostic_lab" label="Diagnostic Lab" value="'+g.diagnostic_lab+'" id="project-lab"></paper-input>\n  <paper-input '+m+' class="author-param" data-key="affiliation" label="Affiliation" value="'+g.affiliation+'" id="project-affiliation"></paper-input>\n  <paper-input '+m+' class="project-param" label="Technical/Data Contact" value="'+O.technical_contact+'" data-field="technical_contact" id="technical-contact"></paper-input>\n  <gold-email-input '+m+' class="project-param" label="Technical/Data Contact_email" value="'+O.technical_contact_email+'" data-field="technical_contact_email" id="technical-contact-email"></gold-email-input>\n</section>\n<section id="notes" class="col-xs-12 col-md-8 clearfix">\n  '+M+'\n</section>\n<section id="data-management" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Data" elevation="2" id="data-card">\n    <div class="card-content">\n      <div class="variable-card-content">\n      Your project does/does not have data associated with it. (Does should note overwrite, and link to cartoParsed.raw_data.filePath for current)\n      </div>\n      <div id="append-replace-data-toggle">\n        <span class="toggle-off-label iron-label">Append/Amend Data\n          <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload a dataset, append all rows as additional data, and modify existing ones by sampleId"></span>\n        </span>\n        <paper-toggle-button id="replace-data-toggle" class="material-red" '+X+'>Replace Data</paper-toggle-button>\n        <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="If you upload data, archive current data and only have new data parsed"></span>\n      </div>\n      <div id="uploader-container-section">\n      </div>\n    </div>\n  </paper-card>\n  <paper-card class="clearfix" heading="Project Status" elevation="2" id="save-card">\n    <div class="card-content">\n      <p>Notice if there\'s unsaved data or not. Buttons below should dynamically disable/enable based on appropriate state.</p>\n    </div>\n    <div class="card-actions">\n      <paper-button id="save-project"><iron-icon icon="icons:save" class="material-green"></iron-icon> Save Project</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="reparse-project"><iron-icon icon="icons:cached" class="materialindigotext"></iron-icon> Re-parse Data, Save Project &amp; Reload</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="discard-changes-exit"><iron-icon icon="icons:undo"></iron-icon> Discard Changes &amp; Exit</paper-button>\n    </div>\n    '+r+'\n  </paper-card>\n</section>\n<section id="project-data" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Data Overview</h3>\n    <h4>Project Studies:</h4>\n      <paper-checkbox '+f+">Anura</paper-checkbox>\n      <paper-checkbox "+j+">Caudata</paper-checkbox>\n      <paper-checkbox "+w+'>Gymnophiona</paper-checkbox>\n      <paper-input readonly label="Sampled Species" value="'+O.sampled_species.split(",").sort().join(", ")+'"></paper-input>\n      <paper-input readonly label="Sampled Clades" value="'+O.sampled_clades.split(",").sort().join(", ")+'"></paper-input>\n      <p class="text-muted">\n        <span class="glyphicon glyphicon-info-sign"></span> There are '+O.sampled_species.split(",").length+" species in this dataset, across "+O.sampled_clades.split(",").length+' clades\n      </p>\n    <h4>Sample Metrics</h4>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken from '+l+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were taken in '+J+'</p>\n      <p class="text-muted"><span class="glyphicon glyphicon-calendar"></span> Data were sampled in '+ba+'</p>\n      <p class="text-muted"><iron-icon icon="icons:language"></iron-icon> The effective project center is at ('+roundNumberSigfig(O.lat,6)+", "+roundNumberSigfig(O.lng,6)+") with a sample radius of "+O.radius+"m and a resulting locality <strong class='locality'>"+O.locality+'</strong></p>\n      <p class="text-muted"><iron-icon icon="editor:insert-chart"></iron-icon> The dataset contains '+O.disease_positive+" positive samples ("+roundNumber(100*O.disease_positive/O.disease_samples)+"%), "+O.disease_negative+" negative samples ("+roundNumber(100*O.disease_negative/O.disease_samples)+"%), and "+O.disease_no_confidence+" inconclusive samples ("+roundNumber(100*O.disease_no_confidence/O.disease_samples)+'%)</p>\n    <h4 id="map-header">Locality &amp; Transect Data</h4>\n      <div id="carto-map-container" class="clearfix">\n      '+v+"\n      </div>\n  <h3>Project Meta Parameters</h3>\n    <h4>Project funding status</h4>\n      "+u+'\n      <div class="row markdown-pair" id="preview-funding">\n        <span class="pull-left" style="margin-top:1.75em;vertical-align:bottom;padding-left:15px">$</span><paper-input '+m+' class="project-param col-xs-11" label="Additional Funding Request" value="'+O.more_analysis_funding_request+'" id="more-analysis-funding" data-field="more_analysis_funding_request" type="number"></paper-input>\n      </div>\n</section>',$("#main-body").html(y),$(".pull-right paper-card .header").click(function(){return console.info("Clicked header, triggering collapse"),$(this).parent().toggleClass("collapsed")}),null!=(null!=(U=i.bounding_polygon)?U.paths:void 0)&&(k=new Point(O.lat,O.lng),geo.centerPoint=k,geo.mapOptions=n,createMap2([k],n,function(a){var b;if(geo.mapOptions.selector=a.selector,!$(a.selector).exists())return(b=function(){return $("#map-header").exists()?($("#map-header").after(a.html),v=a.html):delay(250,function(){return b()})})()}),i.bounding_polygon,v=null!=(V=geo.googleMapWebComponent)?V:"");try{p$("#project-notes").bindValue=O.sample_notes.unescape()}catch(a){}try{p$("#project-funding").bindValue=O.extended_funding_reach_goals.unescape()}catch(a){}return isNull(O.transect_file)||kmlLoader(O.transect_file,function(){return console.debug("Editor loaded KML file")}),W=p$("#project-notes").textarea,$(W).keyup(function(){return p$("#note-preview").markdown=$(this).val()}),$("#markdown-switcher li").click(function(){var a;switch($("#markdown-switcher li").removeClass("active"),$("#markdown-switcher").parent().find(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),a=$(this).attr("data-view"),console.info("Switching to target view",a),a){case"md":$("#project-notes").attr("hidden","hidden");break;case"edit":$("#note-preview").attr("hidden","hidden")}return!1}),W=p$("#project-funding").textarea,$(W).keyup(function(){return p$("#preview-funding").markdown=$(this).val()}),$("#markdown-switcher-funding li").click(function(){var a;switch($("#markdown-switcher-funding li").removeClass("active"),$("#markdown-switcher-funding").parent().find(".markdown-pair").removeAttr("hidden"),$(this).addClass("active"),a=$(this).attr("data-view"),console.info("Switching to target view",a),a){case"md":$("#project-funding").attr("hidden","hidden");break;case"edit":$("#preview-funding").attr("hidden","hidden")}return!1}),$("#delete-project").click(function(){var a;return a='<paper-button id="confirm-delete-project" class="materialred">\n  <iron-icon icon="icons:warning"></iron-icon> Confirm Project Deletion\n</paper-button>',$(this).replaceWith(a),$("#confirm-delete-project").click(function(){var a;return startLoad(),a=this,d="perform=delete&id="+O.id,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,d,"json").done(function(b){return!0===b.status?(stopLoad(),toastStatusMessage("Successfully deleted Project #"+O.project_id),delay(1e3,function(){return populateAdminActions()})):(stopLoadError(b.human_error),$(a).remove())}).fail(function(a,b){return console.error("Server error",a,b),stopLoadError("Error deleting project")}),!1}),!1}),$("#save-project").click(function(){var a;return $("#confirm-delete-project").exists()&&(a='<paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>',$("#confirm-delete-project").replaceWith(a)),saveEditorData(!0),!1}),$("#discard-changes-exit").click(function(){return c(),!1}),$("#reparse-project").click(function(){try{recalculateAndUpdateHull()}catch(a){}return revalidateAndUpdateData(),!1}),Y=$("#data-management").offset().top,{top:Y,bottom:0,target:window},$("paper-button#manage-users-button").click(function(){return popManageUserAccess(_adp.projectData)}),$(".danger-toggle").on("iron-change",function(){return $(this).get(0).checked?$(this).find("iron-icon").addClass("material-red"):$(this).find("iron-icon").removeClass("material-red")}),isNull(O.carto_id)?(console.warn("There is no carto data to load up for the editor"),startEditorUploader()):(console.info("Getting carto data with id "+O.carto_id+" and options",n),getProjectCartoData(O.carto_id,n))}catch(a){return s=a,stopLoadError("There was an error loading your project"),console.error("Unhandled exception loading project! "+s.message),console.warn(s.stack),loadEditor(),!1}}).fail(function(a,b){return console.error("AJAX failure: Error from server",a,b),stopLoadError("We couldn't load your project. Please try again."),loadEditor()})}),!1},null==a?(c=function(){var a,c,d;return d=uri.urlString+"admin-page.html#action:show-editable",c={do:"action",prop:"show-editable"},history.pushState(c,"Viewing Editable Projects",d),startLoad(),a="perform=list",$.get(adminParams.apiTarget,a,"json").done(function(a){var c,d,e,f,g,h,i,j,k,l,m;g='<h2 class="new-title col-xs-12">Editable Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(g),k=Object.toArray(a.public_projects),d=Object.toArray(a.authored_projects),e=Object.toArray(a.editable_projects),m=[],f=!1,l=a.projects;for(i in l)j=l[i],c=indexOf.call(k,i)>=0?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',h=indexOf.call(d,i)>=0?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author"></iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator"></iron-icon>',indexOf.call(e,i)>=0?(g='<li>\n  <button class="btn btn-primary" data-project="'+i+'">\n    '+c+" "+j+" / #"+i.substring(0,8)+"\n  </button>\n  "+h+"\n</li>",$("#project-list").append(g),f=!0):m.push(i);if(console.info("Didn't display read-only projects",m),!f){g='<p class="text-muted col-xs-12" id="no-edits-available">\n  Sorry, you have no projects you\'re eligible to edit.\n</p>',$("#project-list").before(g);try{verifyLoginCredentials(function(a){var b;if(b=toInt(a.detail.userdata.su_flag),b.toBool())return console.info("NOTICE: This is an SUPERUSER Admin"),g='<button class="btn btn-xs btn-primary" id="su-view-projects">\n  <iron-icon icon="icons:supervisor-account"></iron-icon>\n   <iron-icon icon="icons:add"></iron-icon>\n  (SU) Administrate All Projects\n</button>',$("#no-edits-available").append(g),$("#su-view-projects").click(function(){return loadSUProjectBrowser()})})}catch(a){}}return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),b(a)}),stopLoad()}).fail(function(a,b){return stopLoadError("There was a problem loading viable projects")})})():b(a),!1},popManageUserAccess=function(a,b){return null==a&&(a=_adp.projectData),null==b&&(b=_adp.fetchResult),verifyLoginCredentials(function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(console.info("Working with",b,c,a),r="",i=[],o=a.access_data.total,m=0,n=o.length;m<n;m++)user=o[m],q=a.access_data.composite[user].user_id,indexOf.call(i,q)>=0||(i.push(q),p=user+" <span class='set-permission-block' data-user='"+q+"'>",j=user===a.access_data.author,k=indexOf.call(a.access_data.editors_list,user)>=0,l=!k,h=k||j?"disabled":"data-toggle='tooltip' title='Make Editor'",s=l||j?"disabled":"data-toggle='tooltip' title='Make Read-Only'",d=j?"disabled":"data-toggle='tooltip' title='Grant Ownership'",f=j?"author":k?"edit":"read",e="data-current='"+f+"'",p+='<paper-icon-button icon="image:edit" '+h+' class="set-permission" data-permission="edit" data-user="'+q+'" '+e+'> </paper-icon-button>\n<paper-icon-button icon="icons:visibility" '+s+' class="set-permission" data-permission="read" data-user="'+q+'" '+e+"> </paper-icon-button>",b.user.is_author&&(p+='<paper-icon-button icon="social:person" '+d+' class="set-permission" data-permission="author" data-user="'+q+'" '+e+"> </paper-icon-button>"),b.user.has_edit_permissions&&!j&&q!==b.user.user&&(p+='<paper-icon-button icon="icons:delete" class="set-permission" data-permission="delete" data-user="'+q+'" '+e+">\n</paper-icon-button>"),r+="<li>"+p+"</span></li>");return r='<ul class="simple-list">\n  '+r+"\n</ul>",1===a.access_data.total.length&&(r+='<div id="single-user-warning">\n  <iron-icon icon="icons:warning"></iron-icon> <strong>Head\'s-up</strong>: You can\'t change permissions when a project only has one user. Consider adding another user first.\n</div>'),g='<paper-dialog modal id="user-setter-dialog">\n  <h2>Manage "'+a.project_title+'" users</h2>\n  <paper-dialog-scrollable>\n    '+r+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button class="add-user" dialog-confirm><iron-icon icon="social:group-add"></iron-icon> Add Users</paper-button>\n    <paper-button class="close-dialog" dialog-dismiss>Done</paper-button>\n  </div>\n</paper-dialog>',$("#user-setter-dialog").remove(),$("body").append(g),userEmail=user,$(".set-permission").unbind().click(function(){var a,b,c,d,e,f;if(user=$(this).attr("data-user"),e=$(this).attr("data-permission"),c=$(this).attr("data-current"),this,"delete"!==e)f={changes:{0:{newRole:e,currentRole:c,uid:user}}};else{try{b=$(this).attr("data-confirm").toBool()}catch(a){b=!1}if(!b)return $(this).addClass("extreme-danger").attr("data-confirm","true"),!1;f={delete:{0:{currentRole:c,uid:user}}}}return startLoad(),d=jsonTo64(f),a="perform=editaccess&project="+window.projectParams.pid+"&deltas="+d,console.log("Would push args to",""+uri.urlString+adminParams.apiTarget+"?"+a),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,a,"json").done(function(a){var b,d,f,g,h,i,j,k,l;if(console.log("Server permissions alter said",a),!0!==a.status)return b=null!=(g=null!=(h=a.human_error)?h:a.error)?g:"We couldn't update user permissions",stopLoadError(b),!1;if("delete"!==e)$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+e+"']").attr("disabled","disabled").attr("data-current",e),$(".set-permission-block[data-user='"+user+"'] paper-icon-button:not([data-permission='"+e+"'])").removeAttr("disabled"),k=$(".set-permission-block[data-user='"+user+"'] paper-icon-button[data-permission='"+e+"']").attr("icon"),$(".user-permission-list-row[data-user='"+{user:user}+"'] .user-current-permission iron-icon").attr("icon",k),toastStatusMessage(user+" granted "+e+" permissions");else{$(".set-permission-block[data-user='"+user+"']").parent().remove(),$(".user-permission-list-row[data-user='"+{user:user}+"']").remove(),toastStatusMessage("Removed "+user+" from project #"+window.projectParams.pid),f="read"===c?"viewers":"editors",delete _adp.projectData.access_data.composite[userEmail],i=_adp.projectData.access_data[f+"_list"];for(d in i){l=i[d];try{if("object"!=typeof l)continue;l.user_id===user&&delete _adp.projectData.access_data[f+"_list"][d]}catch(a){}}j=_adp.projectData.access_data[f];for(d in j){l=j[d];try{if("object"!=typeof l)continue;l.user_id===user&&delete _adp.projectData.access_data[f][d]}catch(a){}}}return _adp.projectData.access_data.raw=a.new_access_saved,stopLoad()}).fail(function(a,b){return console.error("Server error",a,b),stopLoadError("Problem changing permissions")}),!1}),$(".add-user").unbind().click(function(){return showAddUserDialog(a.access_data.total),!1}),safariDialogHelper("#user-setter-dialog"),!1})},showAddUserDialog=function(a){var b;return b='<paper-dialog modal id="add-new-user">\n<h2>Add New User To Project</h2>\n<paper-dialog-scrollable>\n  <p>Search by email, real name, or username below. Click on a search result to queue a user for adding.</p>\n  <div class="form-horizontal" id="search-user-form-container">\n    <div class="form-group">\n      <label for="search-user" class="sr-only form-label">Search User</label>\n      <input type="text" id="search-user" name="search-user" class="form-control"/>\n    </div>\n    <paper-material id="user-search-result-container" class="pop-result" hidden>\n      <div class="result-list">\n      </div>\n    </paper-material>\n  </div>\n  <p>Adding users:</p>\n  <ul class="simple-list" id="user-add-queue">\n    \x3c!--\n      <li class="list-add-users" data-uid="789">\n        jsmith@sample.com\n      </li>\n    --\x3e\n  </ul>\n</paper-dialog-scrollable>\n<div class="buttons">\n  <paper-button id="add-user"><iron-icon icon="social:person-add"></iron-icon> Save Additions</paper-button>\n  <paper-button dialog-dismiss>Cancel</paper-button>\n</div>\n</paper-dialog>',$("#add-new-user").exists()||$("body").append(b),safariDialogHelper("#add-new-user"),$("#search-user").keyup(function(){var b;return console.log("Should search",$(this).val()),b=function(){var b;if(b=$("#search-user").val(),
isNull(b))return $("#user-search-result-container").prop("hidden","hidden");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().removeClass("has-success"),$("#search-user").parent().find(".help-block").remove()}catch(a){}return _adp.currentAsyncJqxhr=$.post(uri.urlString+"/api.php","action=search_users&q="+b,"json").done(function(c){var d,e,f,g,h,i,j,k;if(console.info(c),k=Object.toArray(c.result),k.length>0){for($("#user-search-result-container").removeAttr("hidden"),g="",h=0,i=k.length;h<i;h++)user=k[h],null!=_adp.projectData.access_data.composite[user.email]?(j='<iron-icon icon="icons:done-all" class="materialgreen round"></iron-icon>','<paper-badge for="'+user.uid+'-email" icon="icons:done-all" label="Already Added"> </paper-badge>',d="noclick"):(j="","",d=""),g+='<div class="user-search-result '+d+'" data-uid="'+user.uid+'" id="'+user.uid+'-result">\n  <span class="email search-result-detail" id="'+user.uid+'-email">'+j+user.email+'</span>\n    |\n  <span class="name search-result-detail" id="'+user.uid+'-name">'+user.full_name+'</span>\n    |\n  <span class="user search-result-detail" id="'+user.uid+'-handle">'+user.handle+"</span></div>";return $("#user-search-result-container").html(g),$(".user-search-result:not(.noclick)").click(function(){var b,c,d,e,f,g;for(g=$(this).attr("data-uid"),console.info("Clicked on "+g),b=$(this).find(".email").text(),null==("undefined"!=typeof _adp&&null!==_adp?_adp.currentQueueUids:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.currentQueueUids=[]),f=$("#user-add-queue .list-add-users"),e=0,c=f.length;e<c;e++)user=f[e],_adp.currentQueueUids.push($(user).attr("data-uid"));return indexOf.call(a,b)<0?indexOf.call(_adp.currentQueueUids,g)<0?(d='<li class="list-add-users" data-uid="'+g+'">'+b+"</li>",$("#user-add-queue").append(d),$("#search-user").val(""),$("#user-search-result-container").prop("hidden","hidden")):(toastStatusMessage(b+" is already in the addition queue"),!1):(toastStatusMessage(b+" already has access to this project"),!1)})}$("#user-search-result-container").prop("hidden","hidden");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().removeClass("has-success"),$("#search-user").parent().find(".help-block").remove()}catch(a){}return e=/^(?:[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/im.test(b)?'<button class="btn btn-xs btn-primary add-listed-user"> Invite Them </button> ':"Finish the email address and we can invite them.",f='<span class="help-block">\n  We couldn\'t find a user matching "'+b+'".\n  '+e+"\n</span>",$("#search-user").after(f),$("#search-user").parent().addClass("has-error"),$(".add-listed-user").click(function(){var a;return startLoad(),a="action=invite&invitee="+b,$.post(uri.urlString+"/admin-api.php",a,"json").done(function(a){var b;!0!==a.status&&(b=function(){switch(a.error){case"INVALID_EMAIL":return a.target+" isn't a valid email";case"ALREADY_REGISTERED":return a.target+" already has an account";default:return console.error(a),"There was a problem sending the email"}}(),stopLoadError(b)),toastStatusMessage("Invitation sent");try{$("#search-user").parent().removeClass("has-error"),$("#search-user").parent().addClass("has-success"),$("#search-user").parent().find(".help-block").text("Invitation Sent to "+a.invited),$("#search-user").val("")}catch(a){}return stopLoad()}).fail(function(){return stopLoadError("Failed to contact the server")}),!1})}).fail(function(a,b){return console.error(a,b)})},b.debounce()}),$("#add-user").click(function(){var a,b,c,d,e,f,g,h;for(startLoad(),g=[],f=[],e=$("#user-add-queue .list-add-users"),c=0,d=e.length;c<d;c++)user=e[c],g.push($(user).attr("data-uid")),f.push(user);return g.length<1?(toastStatusMessage("Please add at least one user to the access list."),!1):(console.info("Saving list of "+g.length+" UIDs to "+window.projectParams.pid,g),b={add:g},h=jsonTo64(b),a="perform=editaccess&project="+window.projectParams.pid+"&deltas="+h,console.log("Would push args to",adminParams.apiTarget+"?"+a),_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,a,"json").done(function(a){var b,c,d,e,h,i,j,k,l,m,n,o;if(console.log("Server permissions said",a),!0!==a.status)return b=null!=(j=null!=(k=a.human_error)?k:a.error)?j:"We couldn't update user permissions",stopLoadError(b),!1;for(stopLoad(),l=1===g.length?"viewer":"viewers",toastStatusMessage("Successfully added "+g.length+" "+l+" to the project"),$("#user-add-queue").empty(),e='<iron-icon icon="icons:visibility"></iron-icon>',d=0,i=0,h=g.length;i<h;i++){m=g[i],user=f[d],console.info("Adding",user),n=$(user).text(),++d,c='<tr class="user-permission-list-row" data-user="'+m+'">\n  <td colspan="5">'+n+'</td>\n  <td class="text-center user-current-permission">'+e+"</td>\n</tr>",$("#permissions-table").append(c),o={email:user,user_id:m,permission:"READ"};try{isArray(_adp.projectData.access_data.total)||(_adp.projectData.access_data.total=Object.toArray(_adp.projectData.access_data.total),_adp.projectData.access_data.viewers_list=Object.toArray(_adp.projectData.access_data.viewers_list),_adp.projectData.access_data.viewers=Object.toArray(_adp.projectData.access_data.viewers))}catch(a){}_adp.projectData.access_data.total.push(user),_adp.projectData.access_data.viewers_list.push(user),_adp.projectData.access_data.viewers.push(o),_adp.projectData.access_data.raw=a.new_access_saved,_adp.projectData.access_data.composite[user]=o}return p$("#add-new-user").close()}).fail(function(a,b){return console.error("Server error",a,b)}))}),!1},getProjectCartoData=function(a,b){var c,d,e,f,g,h,i,j;if("object"!=typeof a)try{d=JSON.parse(deEscape(a))}catch(b){g=b,h=g.message;try{d=JSON.parse(a)}catch(b){if(g=b,a.length>511&&"object"==typeof(e=fixTruncatedJson(a))&&(console.debug("The carto data object was truncated, but rebuilt."),d=e),isNull(d))return console.error("cartoObj must be JSON string or obj, given",a),console.warn("Cleaned obj:",deEscape(a)),console.warn("Told",h,g.message),stopLoadError("Couldn't parse data"),!1}}else d=a;f=d.table,console.info("Working with Carto data base set",d);try{j=getMapZoom(d.bounding_polygon.paths,"#transect-viewport"),console.info("Got zoom",j),$("#transect-viewport").attr("zoom",j)}catch(a){}return isNull(f)?(console.warn("There's no assigned table, not pulling carto data"),stopLoad(),startEditorUploader(),!1):(i="SELECT * FROM "+f+" WHERE FALSE",c="action=fetch&sql_query="+post64(i),_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(e){var h,i,j,k,l,m,n,o,p,q,r,s;try{q=JSON.parse(e.post_response[0])}catch(a){return g=a,console.error("Couldn't load carto data! ("+g.message+")",e),console.warn("post_response: (want key 0)",e.post_response),console.warn("Base data source:",d),console.warn(g.stack),stopLoadError("There was a problem talking to CartoDB. Please try again later"),startEditorUploader(),!1}l={},r=q.fields;for(p in r)s=r[p],l[p]=s;_adp.activeCols=l,m=[],k={};for(j in l)l[j],"id"!==j&&"the_geom"!==j&&m.push(j),k[j.toLowerCase()]=j;return _adp.colsList=m,_adp.colRemap=k,i="SELECT "+m.join(",")+", ST_asGeoJSON(the_geom) FROM "+f+";",console.info("Would ping cartodb with",i),h=encodeURIComponent(encode64(i)),c="action=fetch&sql_query="+h,_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(c){var e,f,g,h,i,l,m,n,o,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;if(console.info("Carto query got result:",c),!c.status)return h=null!=(u=c.human_error)?u:c.error,null==h&&(h="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+h+")"),!1;D=c.parsed_responses[0].rows,_adp.cartoRows={};for(i in D){C=D[i],_adp.cartoRows[i]={};for(j in C)H=C[j],t=null!=(v=k[j])?v:j,_adp.cartoRows[i][t]=H}G=-13;try{I=geo.googleMapWebComponent.slice(0,G)}catch(a){I="<google-map>"}s=[];for(p in D)C=D[p],JSON.parse(C.st_asgeojson),m=C.decimallatitude,n=C.decimallongitude,r=new Point(m,n),r.infoWindow={},r.data=C,C.diseasedetected=function(){switch((""+C.diseasedetected).toLowerCase()){case"true":return"positive";case"false":return"negative";default:return""+C.diseasedetected}}(),E=C.genus+" "+C.specificepithet,q="",E!==C.originaltaxa&&(console.warn(E+" was changed from "+C.originaltaxa),q="(<em>"+C.originaltaxa+"</em>)"),l="<p>\n  <em>"+C.genus+" "+C.specificepithet+"</em> "+q+"\n  <br/>\n  Tested <strong>"+C.diseasedetected+"</strong> for "+C.diseasetested+"\n</p>",r.infoWindow.html=l,o='<google-map-marker latitude="'+m+'" longitude="'+n+'" data-disease-detected="'+C.diseasedetected+'">\n'+l+"\n</google-map-marker>",I+=o,s.push(r);if(_adp.workingProjectPoints=s,null==(null!=d&&null!=(w=d.bounding_polygon)?w.paths:void 0)||null==(null!=d&&null!=(x=d.bounding_polygon)?x.fillColor:void 0))try{_adp.canonicalHull=createConvexHull(s,!0);try{a={},null==d&&(d={}),null==d.bounding_polygon&&(d.bounding_polygon={}),d.bounding_polygon.paths=_adp.canonicalHull.hull,null==(e=d.bounding_polygon).fillOpacity&&(e.fillOpacity=defaultFillOpacity),null==(f=d.bounding_polygon).fillColor&&(f.fillColor=defaultFillColor),_adp.projectData.carto_id=JSON.stringify(d)}catch(a){}}catch(a){}return F=null!=(y=c.parsed_responses[0].total_rows)?y:0,s.length>0||(null!=b&&null!=(z=b.boundingBox)?z.length:void 0)>0?(b.skipHull=!1,0===s.length&&(g=null!=(A=null!=(B=geo.centerPoint)?B:[b.boundingBox[0].lat,b.boundingBox[0].lng])?A:[window.locationData.lat,window.locationData.lng],s.push(g)),b.onClickCallback=function(){return console.log("No callback for data-provided maps.")},createMap2(s,b,function(a){return'<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+F+"</span> sample points in this dataset</p>",$(a.selector).after,stopLoad()})):(console.info("Classic render.",b,s.length),I+='</google-map>\n<p class="text-muted"><span class="glyphicon glyphicon-info-sign"></span> There are <span class=\'carto-row-count\'>'+F+"</span> sample points in this dataset</p>",$("#transect-viewport").replaceWith(I),stopLoad())}).fail(function(a,b){return console.error("Couldn't talk to back end server to ping carto!"),stopLoadError("There was a problem communicating with the server. Please try again in a bit. (E-002)")}),window.dataFileparams=d.raw_data,d.raw_data.hasDataFile?(n=d.raw_data.filePath,-1===n.search(helperDir)&&(n=""+helperDir+n),o='<p>\n  Your project already has data associated with it. <span id="last-modified-file"></span>\n</p>\n<button id="download-project-file" class="btn btn-primary center-block click download-file" data-href="'+n+'"><iron-icon icon="icons:cloud-download"></iron-icon> Download File</button>\n<p>You can upload more data below, or replace existing data of the same type.</p>\n<br/><br/>\n<p class="text-muted">\n  Allowed types (single type of each): <code>*.kml</code>, <code>*.kmz</code>, <code>*.xls</code>, <code>*.xlsx</code>\n  <br/>\n  Allowed types (inifinite copies): <code>image/*</code>, <code>*.pdf</code>, <code>*.7z</code>, <code>*.zip</code>\n</p>',$("#data-card .card-content .variable-card-content").html(o),c="do=get_last_mod&file="+n,console.info("Timestamp: ",uri.urlString+"meta.php?"+c),$.get("meta.php",c,"json").done(function(a){var b,c,d,e;return d=1e3*toInt(a.last_mod),console.log("Last modded",d,a),isNumber(d)?(c=new Date(d),b=c.toISOString(),e=""+b.slice(0,b.search("T")),$("#last-modified-file").text("Last uploaded on "+e+"."),bindClicks()):console.warn("Didn't get a number back to check last mod time for "+n),!1}).fail(function(a,b){return console.warn("Couldn't get last mod time for "+n),!1})):($("#data-card .card-content .variable-card-content").html("<p>You can upload data to your project here:</p>"),$("#append-replace-data-toggle").attr("hidden","hidden")),startEditorUploader()}).fail(function(a,b){return!1}),!1)},startEditorUploader=function(){var a;return $("link[href='bower_components/neon-animation/animations/fade-out-animation.html']").exists()||(a='<link rel="import" href="bower_components/neon-animation/animations/fade-in-animation.html" />\n<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html" />',$("head").append(a)),bootstrapUploader("data-card-uploader","",function(){return window.dropperParams.postUploadHandler=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;try{n="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",h=b.full_path.split("/").pop(),p=b.wrote_thumb,m=b.mime_provided.split("/")[0],l=b.mime_provided.split("/")[1],k=a.size<5242880||"image"!==m?""+n+b.wrote_file:""+n+p,k.slice(0),d=k.slice(0),g=d.split(".").pop()}catch(a){f=a,console.warn("Warning - "+f.message),console.warn(f.stack)}if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof b)return console.error("Dropzone returned an error - "+b),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(!0!==b.status)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(""+b.human_error),console.error("Error uploading!",b),!1;if(c=["vnd.google-earth.kml+xml","vnd.google-earth.kmz","xml"],indexOf.call(c,l)>=0)return"kml"===g||"kmz"===g?(i=function(a){var b;b={path:k,data:a};try{_adp.projectData.transect_file=JSON.stringify(b)}catch(b){f=b;try{console.warn("Couldn't stringify json - "+f.message,k,a)}catch(a){}_adp.projectData.transect_file=k}return bsAlert("Your KML will take over your current bounding polygon once you save and refresh this page")},kmlHandler(k,i)):(console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+l),!1);try{switch(j=renderValidateProgress("dont-exist",!0),e='  <paper-dialog modal id="upload-progress-dialog"\n    entry-animation="fade-in-animation"\n    exit-animation="fade-out-animation">\n    <h2>Upload Progress</h2>\n    <paper-dialog-scrollable>\n      <div id="upload-progress-container" style="min-width:80vw; ">\n      </div>\n      '+j+'\n<p class="col-xs-12">Species in dataset</p>\n<iron-autogrow-textarea id="species-list" class="project-field  col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    </paper-dialog-scrollable>\n    <div class="buttons">\n      <paper-button id="close-overlay">Close &amp; Cancel</paper-button>\n      <paper-button id="save-now-upload" disabled>Save</paper-button>\n    </div>\n  </paper-dialog>',$("#upload-progress-dialog").remove(),$("body").append(e),p$("#upload-progress-dialog").open(),$("#close-overlay").click(function(){return cancelAsyncOperation(this),p$("#upload-progress-dialog").close()}),console.info("Server returned the following result:",b),console.info("The script returned the following file information:",a),n="helpers/js-dragdrop/uploaded/"+getUploadIdentifier()+"/",h=b.full_path.split("/").pop(),p=b.wrote_thumb,m=b.mime_provided.split("/")[0],l=b.mime_provided.split("/")[1],k=a.size<5242880||"image"!==m?""+n+b.wrote_file:""+n+p,o=function(){switch(m){case"image":return'<div class="uploaded-media center-block" data-system-file="'+h+'">\n  <img src="'+k+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+a.name+" -> "+h+'\n  (<a href="'+k+'" class="newwindow" download="'+a.name+'">\n    Original Image\n  </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+h+'">\n  <audio src="'+k+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+a.name+" -> "+h+'\n    (<a href="'+k+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+h+'">\n  <video src="'+k+'" controls preload="auto">\n    <img src="'+n+p+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+a.name+" -> "+h+'\n    (<a href="'+k+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+h+'" data-link-path="'+k+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+a.name+" -> "+h+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(o),$("#validator-progress-container").remove(),m){case"application":switch(console.info("Checking "+l+" in application"),l){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":excelHandler2(k);break;case"zip":case"x-zip-compressed":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===a.type||"xlsx"===k.split(".").pop()?excelHandler2(k):(zipHandler(k),p$("#upload-progress-dialog").close());break;case"x-7z-compressed":_7zHandler(k),p$("#upload-progress-dialog").close();break;case"vnd.google-earth.kml+xml":case"vnd.google-earth.kmz":case"xml":if("kml"!==g&&"kmz"!==g)return console.warn("Non-KML xml"),allError("Sorry, we can't processes files of type application/"+l),p$("#upload-progress-dialog").close(),!1;kmlHandler(k),p$("#upload-progress-dialog").close();break;default:return console.warn("Unknown mime type application/"+l),allError("Sorry, we can't processes files of type application/"+l),p$("#upload-progress-dialog").close(),!1}break;case"text":csvHandler(),p$("#upload-progress-dialog").close();break;case"image":imageHandler(),p$("#upload-progress-dialog").close()}}catch(a){f=a,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}return!1}}),!1},excelHandler2=function(a,b,c){var d,e,f;return null==b&&(b=!0),startLoad(),$("#validator-progress-container").remove(),f=helperDir+"excelHelper.php",e=a,-1!==a.search(helperDir)&&(console.info("removing '"+helperDir+"'"),e=a.slice(helperDir.length)),console.info("Pinging for "+e),d="action=parse&path="+e+"&sheets=Samples",$.get(f,d,"json").done(function(b){var d,f;return console.info("Got result",b),!1===b.status?(bsAlert("There was a problem verifying your upload. Please try again.","danger"),stopLoadError("There was a problem processing your data"),!1):($("#upload-data").attr("disabled","disabled"),f=a.split("/"),dataFileParams.hasDataFile=!0,dataFileParams.fileName=f.pop(),dataFileParams.filePath=e,Object.size(b.data),uploadedData=b.data,_adp.parsedUploadedData=b.data,"function"!=typeof c?p$("#replace-data-toggle").checked?(startLoad(),revalidateAndUpdateData(!1,!1,!1,!1,!0),console.info("Starting newGeoDataHandler to handle a replacement dataset"),_adp.projectIdentifierString="t"+md5(_adp.projectId+_adp.projectData.author+Date.now()),d='<div class="row">\n<div class="alert alert-info col-xs-12" id="still-processing">\n  Please do not close this window until your upload has finished. As long as this message is showing, your processing is still incomplete.\n</div>\n</div>',$("#validator-progress-container").before(d),newGeoDataHandler(b.data,!1,function(a,b){return console.info("Upload and save complete",a),startLoad(),finalizeData(!0,function(a){return a.project_id=_adp.originalProjectId,_adp.reassignedTrashProjectId=_adp.projectId,_adp.projectId=_adp.originalProjectId,console.info("Successfully finalized data",a),$("#still-processing").remove(),d='<div class="row">\n<div class="alert alert-warning center-block text-center col-xs-8 force-center">\n  <strong>IMPORTANT</strong>: Remember to save your project after closing this window!<br/><br/>\n    If you don\'t, your new data <em>will not be saved</em>!\n</div>\n</div>',$("#validator-progress-container").before(d),_adp.projectData=a,$("#save-now-upload").click(function(){return saveEditorData(!0,function(){return document.location.reload})}).removeAttr("disabled"),stopLoad()})})):(console.info("Starting revalidateAndUpdateData to handle an update"),revalidateAndUpdateData(b)):(console.warn("Skipping Revalidator() !"),c(b)),stopLoad())}).fail(function(a,b){return console.error("Couldn't POST"),console.warn(a,b),stopLoadError()}),!1},revalidateAndUpdateData=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o;if(null==a&&(a=!1),null==b&&(b=!1),null==c&&(c=!1),null==d&&(d=!1),null==e&&(e=!1),$("#upload-progress-dialog").exists()||(i=renderValidateProgress("dont-exist",!0),h='  <paper-dialog modal id="upload-progress-dialog"\n    entry-animation="fade-in-animation"\n    exit-animation="fade-out-animation">\n    <h2>Upload Progress</h2>\n    <paper-dialog-scrollable>\n      <div id="upload-progress-container" style="min-width:80vw; ">\n      </div>\n      '+i+'\n<p class="col-xs-12">Species in dataset</p>\n<iron-autogrow-textarea id="species-list" class="project-field  col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    </paper-dialog-scrollable>\n    <div class="buttons">\n      <paper-button id="close-overlay">Close &amp; Cancel</paper-button>\n      <paper-button id="save-now-upload" disabled>Save</paper-button>\n    </div>\n  </paper-dialog>',$("#upload-progress-dialog").remove(),$("body").append(h),$("#close-overlay").click(function(){return cancelAsyncOperation(this),p$("#upload-progress-dialog").close()})),safariDialogHelper("#upload-progress-dialog"),e)return!1;try{f=JSON.parse(_adp.projectData.carto_id.unescape()),_adp.cartoData=f}catch(a){j=$.cookie(uri.domain+"_link"),f={table:_adp.projectIdentifierString+"_"+j,bounding_polygon:{}}}return o=!1,!1!==a?"object"==typeof a?(o=!0,k=a.data,l=a.path.requested_path):l=a:null==(l=_adp.projectData.sample_raw_data.slice(uri.urlString.length))&&(l=null!=(null!=dataFileParams?dataFileParams.filePath:void 0)?dataFileParams.filePath:f.raw_data.filePath),_adp.projectIdentifierString=f.table.split("_")[0],_adp.projectId=_adp.projectData.project_id,null==(null!=(m=_adp.fims)&&null!=(n=m.expedition)?n.expeditionId:void 0)&&(_adp.fims={expedition:{expeditionId:26,ark:_adp.projectData.project_obj_id}}),g=function(a){var e,g;return e=["edit","create"],g=p$("#replace-data-toggle").checked?"create":"edit",indexOf.call(e,g)<0?(console.error(g+" is not an allowed operation on a data set!"),console.info("Allowed operations are ",e),toastStatusMessage("Sorry, '"+g+"' isn't an allowed operation."),!1):"create"===g?(newGeoDataHandler(a,function(a,b){return geo.requestCartoUpload(a,b,"create",function(a,b,c){bsAlert("Hang on for a moment while we reprocess this for saving","info"),f.table=geo.dataTable;try{isArray(points)&&(f=recalculateAndUpdateHull())}catch(a){}return _adp.projectData.carto_id=JSON.stringify(f),l=dataFileParams.filePath,revalidateAndUpdateData(l),!1}),!1}),!1):(newGeoDataHandler(a,function(e,g){var h,i,k,l;return console.info("Ready to update",e),i=f.table,"object"!=typeof(a=e.data)?(console.info("This function requires the base data to be a JSON object."),toastStatusMessage("Your data is malformed. Please double check your data and try again."),!1):isNull(i)?(console.error("Must use a defined table name!"),toastStatusMessage("You must name your data table"),!1):(j=$.cookie(uri.domain+"_link"),k=$.cookie(uri.domain+"_auth"),l=$.cookie(uri.domain+"_secret"),null==j||null==k||null==l?(console.error("You're not logged in. Got one or more invalid tokens for secrets.",j,k,l),toastStatusMessage("Sorry, you're not logged in. Please log in and try again."),!1):(h="hash="+k+"&secret="+l+"&dblink="+j,null==("undefined"!=typeof adminParams&&null!==adminParams?adminParams.apiTarget:void 0)?(console.warn("Administration file not loaded. Upload cannot continue"),stopLoadError("Administration file not loaded. Upload cannot continue"),!1):(_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,h,"json").done(function(g){var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la;if(g.status){console.info("Validated data",e),aa=[],E=[],I=[];for(L in a){Z=a[L],H=[];for(p in Z)switch(ka=Z[p],p){case"decimalLongitude":H[1]=ka,I.push(ka);break;case"decimalLatitude":H[0]=ka,E.push(ka)}aa.push(H)}l=null!=(M=E.max())?M:0,m=null!=(N=E.min())?N:0,k=null!=(O=I.max())?O:0,n=null!=(P=I.min())?P:0,v=[[l,n],[l,k],[m,k],[m,n]];try{for(ha="string"==typeof a.transectRing?JSON.parse(e.transectRing):e.transectRing,ha=Object.toArray(ha),B=0,D=0,F=ha.length;D<F;D++){if(t=ha[D],t instanceof Point&&(t=t.toGeoJson(),ha[B]=t),2!==t.length)throw{message:"Bad coordinate length for '"+t+"'"};for(K=0,G=t.length;K<G;K++)if(s=t[K],!isNumber(s))throw{message:"Bad coordinate number '"+s+"'"};++B}}catch(a){w=a,console.warn("Error parsing the user transect ring - "+w.message),ha=void 0}fa=null!=ha?ha:v,x={type:"GeometryCollection",geometries:[{type:"MultiPoint",coordinates:aa},{type:"Polygon",coordinates:fa}]},"ST_AsBinary("+JSON.stringify(x)+", 4326)",q=getColumnObj();try{J={},Q=_adp.cartoRows;for(B in Q){Z=Q[B],_=null!=(R=Z.sampleId)?R:Z.sampleid;try{ga=_.trim()}catch(a){continue}ga=ga.replace(/^([a-zA-Z]+) (\d+)$/gm,"$1$2"),_=ga,J[_]=B}}catch(a){console.warn("Couldn't make lookupMap")}ba="",[],r=[],r.push("id int"),_adp.rowsCount=Object.size(a),_adp.lookupMap=J;for(B in a){Z=a[B],B=toInt(B),la=[],0,0,0,0,y={type:"Point",coordinates:[]},B+1,_=Z.sampleId;try{W=J[_]}catch(a){}V=null,null!=W&&(V=_adp.cartoRows[W]),o=[];for(p in Z){ka=Z[p],0===B&&r.push(p+" "+q[p]);try{ka=ka.replace("'","&#95;")}catch(a){}switch(p){case"decimalLongitude":y.coordinates[1]=ka;break;case"decimalLatitude":y.coordinates[0]=ka;break;case"sampleId":if(null!=V)continue}if(null!=V){if("object"==typeof(X=null!=(S=V[p])?S:V[p.toLowerCase()])){if("string"==typeof ka)try{ja=JSON.parse(ka)}catch(a){}else ja=ka;Y=10;for(C in ja)"number"==typeof(ia=ja[C])&&(ja[C]=roundNumber(ia,Y));for(C in X)"number"==typeof(ia=X[C])&&(X[C]=roundNumber(ia,Y));if(u=JSON.stringify(ja),(X=JSON.stringify(X))===u)continue;console.info("No Object Match:",X,u)}if("boolean"==typeof ka)j=X.toBool();else if("boolean"==typeof X)j=""+X;else if("number"==typeof X)j=""+X;else if("number"==typeof ka)j=toFloat(X);else if("null"===X)j=null;else if(null===X)j="null";else try{j=X.replace("T00:00:00Z","")}catch(a){j=void 0}if(X===ka||j===ka)continue;console.info("Not skipping for",X,j,"on "+Z.sampleId+" @ "+p+" = ",ka)}"string"==typeof ka?null!=V?la.push(p.toLowerCase()+"='"+ka+"'"):la.push("'"+ka+"'"):isNull(ka)?null!=V?la.push(p.toLowerCase()+"=null"):la.push("null"):null!=V?la.push(p.toLowerCase()+"="+ka):la.push(ka),o.push(p)}z="ST_SetSRID(ST_Point("+y.coordinates[1]+","+y.coordinates[0]+"),4326)",null!=V?(A=JSON.stringify(y),(U=null!=(T=V.the_geom)?T:V.st_asgeojson)!==A&&(console.info("Not skipping coords",U,y,A),la.push("the_geom="+z))):(o.push("the_geom"),la.push(z)),0!==la.length&&(null!=V?(ca=" WHERE sampleid='"+_+"';",ba+="UPDATE "+i+" SET "+la.join(", ")+" "+ca):ba+="INSERT INTO "+i+" ("+o.join(",")+") VALUES ("+la.join(",")+"); ")}return ea=ba.split(";"),(da=ea.length-1,console.log(ea),console.info("Running "+da+" statements"),!0===c)?(console.warn("Exiting before carto post because testOnly is set true"),!1):(geo.postToCarto(ba,i,function(a,c,g){var j;console.info("Post carto callback fn"),bsAlert("<strong>Please Wait</strong>: Re-Validating your total taxa data","info");try{p$("#taxa-validation").value=0,p$("#taxa-validation").indeterminate=!0}catch(a){}return _adp.canonicalHull=createConvexHull(c,!0),f.bounding_polygon.paths=_adp.canonicalHull.hull,_adp.projectData.carto_id=JSON.stringify(f),j="SELECT "+_adp.colsList.join(",")+", ST_asGeoJSON(the_geom) FROM "+i+";",h="action=fetch&sql_query="+post64(j),_adp.currentAsyncJqxhr=$.post("api.php",h,"json").done(function(a){var c,f,g,h,i,j,k,l;if(console.info("Carto query got result:",a),!a.status)return f=null!=(i=a.human_error)?i:a.error,null==f&&(f="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+f+")"),!1;k=a.parsed_responses[0].rows,_adp.cartoRows={};for(B in k){Z=k[B],_adp.cartoRows[B]={};for(c in Z)l=Z[c],h=null!=(j=_adp.colRemap[c])?j:c,_adp.cartoRows[B][h]=l}g={data:_adp.cartoRows};try{p$("#taxa-validation").indeterminate=!1}catch(a){}return validateTaxonData(g,function(a){var c,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,x,y,z,A,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y;for(e.validated_taxa=a.validated_taxa,_adp.projectData.includes_anura=!1,_adp.projectData.includes_caudata=!1,_adp.projectData.includes_gymnophiona=!1,D=e.validated_taxa,z=0,s=D.length;z<s&&(T=D[z],f=T.response.validated_taxon,console.info("Aweb taxon result:",f),i=f.order.toLowerCase(),r="includes_"+i,_adp.projectData[r]=!0,!1===_adp.projectData.includes_anura||!1===_adp.projectData.includes_caudata||!1===_adp.projectData.includes_gymnophiona);z++);for(S="",R=[],j=[],B=0,E=e.validated_taxa,C=0,t=E.length;C<t;C++){Q=E[C],U=Q.genus+" "+Q.species,null!=Q.response.original_taxon&&(console.info("Taxon obj",Q),A=""+Q.response.original_taxon.slice(0,1).toUpperCase()+Q.response.original_taxon.slice(1),y='<div class="alert alert-info alert-dismissable amended-taxon-notice col-md-6 col-xs-12 project-field" role="alert">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n    Your entry \'<em>'+A+"</em>' was a synonym in the AmphibiaWeb database. It was automatically converted to '<em>"+U+"</em>' below. <a href=\""+Q.response.validated_taxon.uri_or_guid+'" target="_blank">See the AmphibiaWeb entry <span class="glyphicon glyphicon-new-window"></span></a>\n</div>',$("#species-list").before(y)),isNull(Q.subspecies)||(U+=" "+Q.subspecies),indexOf.call(R,U)<0&&(B>0&&(S+="\n"),S+=""+U,R.push(U));try{F=Q.response.validated_taxon.family,indexOf.call(j,F)<0&&j.push(Q.response.validated_taxon.family)}catch(a){w=a,console.warn("Couldn't get the family! "+w.message,Q.response),console.warn(w.stack)}++B}try{p$("#species-list").bindValue=S}catch(a){}for(dataAttrs.dataObj=e,_adp.data.dataObj=e,_adp.data.taxa={},_adp.data.taxa.list=R,_adp.data.taxa.clades=j,_adp.data.taxa.validated=e.validated_taxa,_adp.projectData.sampled_species=R.join(","),_adp.projectData.sampled_clades=j.join(","),_adp.projectData.disease_morbidity=e.samples.morbidity,_adp.projectData.disease_mortality=e.samples.mortality,_adp.projectData.disease_positive=e.samples.positive,_adp.projectData.disease_negative=e.samples.negative,_adp.projectData.disease_no_confidence=e.samples.no_confidence,_adp.projectData.disease_samples=_adp.rowsCount,h=getMapCenter(geo.boundingBox),o=0,l=[],x=[],Y=[],[],g=[],O=[],m=[],P=[],G=Object.toArray(_adp.cartoRows),V=0,u=G.length;V<u;V++)Z=G[V],k=Z.dateidentified,X=excelDateToUnixTime(k),l.push(X),W=new Date(X),v=dateMonthToString(W.getUTCMonth()),indexOf.call(x,v)<0&&x.push(v),H=W.getFullYear(),indexOf.call(Y,H)<0&&Y.push(W.getFullYear()),null!=Z.catalogNumber&&g.push(Z.catalognumber),O.push(Z.sampleid),M=Z.decimallatitude,N=Z.decimallongitude,n=geo.distance(M,N,h.lat,h.lng),n>o&&(o=n),null!=Z.samplemethod&&(I=Z.samplemethod,indexOf.call(P,I)<0&&P.push(Z.samplemethod)),null!=Z.specimendisposition&&(J=Z.specimendisposition,indexOf.call(m,J)<0&&m.push(Z.sampledisposition));console.info("Got date ranges",l),x.sort(),Y.sort(),_adp.projectData.sampled_collection_start=l.min(),_adp.projectData.sampled_collection_end=l.max(),console.info("Collected from",l.min(),l.max()),_adp.projectData.sampling_months=x.join(","),_adp.projectData.sampling_years=Y.join(","),_adp.projectData.sample_catalog_numbers=g.join(","),_adp.projectData.sample_field_numbers=O.join(","),
_adp.projectData.sample_methods_used=P.join(",");try{recalculateAndUpdateHull()}catch(a){}return p=function(){return _adp.skipRead=!0,_adp.dataBu=_adp.projectData,!0===d?(console.warn("Save skipped on flag!"),console.info("Project data",_adp.projectData),!1):(saveEditorData(!0,function(){if(!0===b&&console.info("Saved",_adp.projectData,dataBu),null==localStorage._adp)return document.location.reload(!0)}),!1)},q=""+uri.urlString+e.dataSrc,q!==_adp.projectData.sample_raw_data?(c=_adp.projectData.dataset_arks.split(","),null==(null!=(K=_adp.fims)&&null!=(L=K.expedition)?L.ark:void 0)&&(null==_adp.fims&&(_adp.fims={}),null==_adp.fims.expedition&&(_adp.fims.expedition={}),_adp.fims.expedition.ark=_adp.projectData.project_obj_id),null!=_adp.originalProjectId&&(_adp.projectId===_adp.originalProjectId&&_adp.projectData.project_id===_adp.originalProjectId||(_adp.projectId=_adp.originalProjectId,_adp.projectData.project_id=_adp.originalProjectId)),_adp.projectData.project_id!==_adp.projectId&&(_adp.projectId=_adp.projectData.project_id),mintBcid(_adp.projectId,q,_adp.projectData.project_title,function(a){var b,d,e;return null!=a.ark?(d=q.split("/"),b=d.pop(),e=a.ark+"::"+b,c.push(e),_adp.projectData.dataset_arks=c.join(",")):console.warn("Couldn't mint!"),_adp.previousRawData=_adp.projectData.sample_raw_data,_adp.projectData.sample_raw_data=q,p()})):p(),!1}),!1}).fail(function(a,b){return stopLoadError("Error fetching updated table")}),!1}),!1)}return stopLoadError("Invalid user")}).fail(function(a,b){return stopLoadError("Error updating Carto")}),!1)))}),!1)},o?g(k):excelHandler2(l,!0,function(a){var b;return b=a.data,g(b)}),!1},recalculateAndUpdateHull=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;null==a&&(a=_adp.workingProjectPoints),null==a&&console.error("Can't run without points!"),_adp.projectPreModBackup=_adp.projectData;try{localStorage.projectPreModBackup=JSON.stringify(_adp.projectData)}catch(a){}if(_adp.canonicalHull=createConvexHull(a,!0),isNull(_adp.canonicalHull))return!1;for(n=[],i=_adp.canonicalHull.hull,e=0,f=i.length;e<f;e++)h=i[e],n.push(h.getObj());try{b=JSON.parse(_adp.projectData.carto_id)}catch(a){b={}}return g=null!=(j=null!=(k=b.bounding_polygon)?k.fillOpacity:void 0)?j:defaultFillOpacity,c=null!=(l=null!=(m=b.bounding_polygon)?m.fillColor:void 0)?l:defaultFillColor,d=b,console.warn("Overwriting cartoData",d),b.bounding_polygon={paths:_adp.canonicalHull.hull,fillOpacity:g,fillColor:c},_adp.projectData.carto_id=JSON.stringify(b),b},remintArk=function(){var a;return a=_adp.projectData.project_title.trim(),mintExpedition(_adp.projectData.project_id,a,function(a){if(!0===a.status)return _adp.projectData.project_obj_id=a.ark.identifier,console.log("New ARK:",_adp.projectData.project_obj_id),console.warn("The save may not update the ARK -- it may have to be manually changed in the database"),saveEditorData(!0)})},saveEditorData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q;if(null==a&&(a=!1),startLoad(),$(".hanging-alert").remove(),a||null==localStorage._adp){B=_adp.projectData;try{B.access_data=_adp.projectData.access_data.raw}catch(a){}if(!0!==_adp.skipRead){for(D=$(".project-param:not([readonly])"),n=0,o=D.length;n<o;n++)j=D[n],m=$(j).attr("data-field"),isNull(m)||(B[m]=p$(j).value.unescape());for(d={},E=$(".author-param"),v=0,p=E.length;v<p;v++)j=E[v],m=$(j).attr("data-key"),d[m]=null!=(F=$(j).attr("data-value"))?F:p$(j).value;B.author_data=JSON.stringify(d)}_adp.postedSaveData=B,_adp.postedSaveTimestamp=Date.now()}else window._adp=JSON.parse(localStorage._adp),B=_adp.postedSaveData;for(m in B){g=B[m];try{B[m]=deEscape(g)}catch(a){}}if(l=!1,$("paper-toggle-button#public").exists()&&(B.public=p$("paper-toggle-button#public").checked,B.public)){l=!0;try{recalculateAndUpdateHull(),B.carto_id=_adp.projectData.carto_id}catch(a){}}null!=_adp.originalProjectId&&_adp.originalProjectId!==_adp.projectId&&(console.warn("Mismatched IDs!",_adp.originalProjectId,_adp.projectId),B.project_id=_adp.originalProjectId);try{w=4e3;try{f=JSON.parse(B.carto_id),z=f.bounding_polygon.paths}catch(a){z=[]}try{L=JSON.parse(B.transect_file),N=L.data.parameters.paths}catch(a){N=[]}e=Object.size(z);try{for(G=f.bounding_polygon.multibounds,y=0,q=G.length;y<q;y++)x=G[y],e+=Object.size(x)}catch(a){}M=Object.size(N);try{for(H=L.data.polys,C=0,r=H.length;C<r;C++)x=H[C],M+=Object.size(x)}catch(a){}if((A=e+M)>w){if(console.warn("Danger: Have "+A+" paths. The recommended max is "+w),M===e){L.data.parameters.paths="SEE_BOUNDING_POLY";try{for(k=0,I=L.data.polys,O=0,s=I.length;O<s;O++)I[O],L.data.polys[k]="SEE_BOUNDING_POLY",++k}catch(a){}B.transect_file=JSON.stringify(L),M=L.data.parameters.paths.length}try{f.bounding_polygon.paths=!1,B.carto_id=JSON.stringify(f),e=0}catch(a){}try{for(J=f.bounding_polygon.multibounds,P=0,t=J.length;P<t;P++)x=J[P],e+=Object.size(x)}catch(a){}try{for(K=L.data.polys,Q=0,u=K.length;Q<u;Q++)x=K[Q],M+=Object.size(x)}catch(a){}A=e+M,console.debug("Shrunk to reduced data size "+A+". May have compatability errors.")}}catch(a){i=a,console.error("Couldn't check path count -- "+i.message+". Faking it."),A=w+1}return B.modified=Date.now()/1e3,console.log("Sending to server",B),c="perform=save&data="+jsonTo64(B),h=delay(1e4,function(){return console.warn("POST may have hung after 10 seconds"),console.warn("args length was '"+c.length+"' = "+8*c.length+" bytes"),!1}),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,c,"json").done(function(a){var b,c,d,e;return console.info("Save result: server said",a),!0!==a.status?(b=null!=(d=null!=(e=a.human_error)?e:a.error)?d:"There was an error saving to the server",stopLoadError("There was an error saving to the server"),localStorage._adp=JSON.stringify(_adp),bsAlert("<strong>Save Error:</strong> "+b+". An offline backup has been made.","danger"),console.error(a.error),!1):(stopLoad(),toastStatusMessage("Save successful"),$.get(uri.urlString+"recordMigrator.php"),_adp.projectData=a.project.project,delete localStorage._adp,l?_adp.projectData.public?($("paper-toggle-button#public").parent().remove(),c='<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>',$("iron-icon[icon='icons:lock'].material-red").replaceWith(c)):console.warn("We sent a change to public, but it didn't update server-side."):void 0)}).fail(function(a,b){var d,e;stopLoadError("Sorry, there was an error communicating with the server");try{if(e=_adp,delete e.currentAsyncJqxhr,A>w)try{L=JSON.parse(e.projectData.transect_file),L.data.parameters.paths="REMOVED_FOR_LOCAL_SAVE",L.data.polys="REMOVED_FOR_LOCAL_SAVE",e.projectData.transect_file=JSON.stringify(L)}catch(a){}localStorage._adp=JSON.stringify(e),console.debug("Local storage backup succeeded"),d="An offline backup has been made."}catch(a){i=a,console.warn("Couldn't backup to local storage! "+i.message),console.warn(i.stack),d="Offline backup failed (said: <code>"+i.message+"</code>)",delay(250,function(){delete e.currentAsyncJqxhr,delete _adp.currentAsyncJqxhr;try{return localStorage._adp=JSON.stringify(_adp),d="An offline backup has been made.",$("#offline-backup-status").replaceWith(d)}catch(a){}}),$("#offline-backup-status").replaceWith(d)}return bsAlert("<strong>Save Error</strong>: We had trouble communicating with the server and your data was NOT saved. Please try again in a bit. <span id='offline-backup-status'>"+d+"</span>","danger"),console.error(a,b),console.warn("Raw post data",B),console.warn("args length was '"+c.length+"' = "+8*c.length+" bytes")}).always(function(){if(clearTimeout(h),"function"==typeof b)return b()}),!1},$(function(){var a,b,c,d;try{_adp.originalProjectId=_adp.projectData.project_id,b=_adp.projectData.project_id}catch(a){delay(1e3,function(){try{return _adp.originalProjectId=_adp.projectData.project_id,b=_adp.projectData.project_id}catch(a){return console.warn("Warning: COuldn't backup project id")}})}if(null!=localStorage._adp){try{window._adp=JSON.parse(localStorage._adp)}catch(a){null==window._adp&&(window._adp={})}try{_adp.originalProjectId=b}catch(a){}try{return c=new Date(_adp.postedSaveTimestamp),a="<strong>You have offline save information</strong> &#8212; did you want to save it?\n<br/><br/>\nProject #"+_adp.postedSaveData.project_id+" on "+c.toLocaleDateString()+" at "+c.toLocaleTimeString()+'\n<br/><br/>\n<button class="btn btn-success" id="offline-save">\n  Save Now &amp; Refresh Page\n</button>\n<button class="btn btn-danger" id="offline-trash">\n  Remove Offline Backup\n</button>',bsAlert(a,"info"),$("#outdated-warning").remove(),delay(300,function(){return $("#outdated-warning").remove()}),$("#offline-save").click(function(){return saveEditorData(!1,function(){return document.location.reload(!0)})}),$("#offline-trash").click(function(){return delete localStorage._adp,$(".hanging-alert").alert("close")})}catch(a){return d=a,console.warn("Backup corrupted, removing -- "+d.message),delete localStorage._adp}}}),loadProjectBrowser=function(){var a,b,c;return c=uri.urlString+"admin-page.html#action:show-viewable",b={do:"action",prop:"show-viewable"},history.pushState(b,"Viewing Personal Project List",c),startAdminActionHelper(),startLoad(),a="perform=list",$.get(adminParams.apiTarget,a,"json").done(function(a){var b,c,d,e,f,g,h,i;b='<h2 class="new-title col-xs-12">Available Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(b),g=[],h=a.public_projects;for(d in h)e=h[d],g.push(e);i=a.projects;for(e in i)f=i[e],c=indexOf.call(g,e)>=0?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',b='<li>\n  <button class="btn btn-primary" data-project="'+e+'" data-toggle="tooltip" title="Project #'+e.substring(0,8)+'...">\n    '+c+" "+f+"\n  </button>\n</li>",$("#project-list").append(b);return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),loadProject(a)}),stopLoad()}).fail(function(a,b){return stopLoadError("There was a problem loading viable projects")}),!1},loadProject=function(a,b){return null==b&&(b=""),goTo(uri.urlString+"project.php?id="+a),!1},"object"!=typeof window.validationMeta&&(window.validationMeta={}),validateData=function(a,b){var c;return null==b&&(b=null),_adp.validationDataObject=a,console.info("Doing nested validation"),c=Date.now(),renderValidateProgress(),validateFimsData(a,function(){return validateTaxonData(a,function(){var d;return d=Date.now()-c,console.info("Validation took "+d+"ms",a),cleanupToasts(),toastStatusMessage("Your dataset has been successfully validated"),"function"==typeof b?b(a):(console.warn("validateData had no defined callback!"),console.info("Got back",a))})}),!1},stopLoadBarsError=function(a,b){var c,d,e,f;if(!$("#validator-progress-container:visible").exists())throw new function(){return this.message="Loading bars aren't visible!",this.name="BadLoadState"};try{clearTimeout(a)}catch(a){}for($("#validator-progress-container paper-progress[indeterminate]").addClass("error-progress").removeAttr("indeterminate"),f=$("#validator-progress-container paper-progress:not([indeterminate])"),d=0,e=f.length;d<e;d++){c=f[d];try{p$(c).value!==p$(c).max&&($(c).addClass("error-progress"),$(c).find("#primaryProgress").css("background","#F44336"))}catch(a){}}null!=b&&(bsAlert("<strong>Data Validation Error</strong>: "+b,"danger"),stopLoadError(null,"There was a problem validating your data"));try{$("#cancel-new-upload").remove()}catch(a){}return!1},delayFimsRecheck=function(a,b){var c,d;return d=encodeURIComponent(a.responses.login_response.cookies),c="perform=validate&auth="+d,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,c,"json").done(function(a){return console.log("Server said",a),"function"==typeof b?b():console.warn("Warning: delayed recheck had no callback")}).fail(function(a,b){return console.error(b+": Couldn't check status on FIMS server!"),console.warn("Server said",a.responseText),stopLoadBarsError(null,"There was a problem validating your data, please try again later")}),!1},validateFimsData=function(a,b){var c,d,e,f,g,h,i,j;if(null==b&&(b=null),"number"!=typeof("undefined"!=typeof _adp&&null!==_adp&&null!=(e=_adp.fims)&&null!=(f=e.expedition)?f.expeditionId:void 0))return!0===_adp.hasRunMintCallback?(console.error("Couldn't run validateFimsData(); called itself back recursively. There may be a problem with the server. "),stopLoadBarsError(null,"Couldn't generate an ARK for your data, please try again later (couldn't communicate with the FIMS server)"),_adp.hasRunMintCallback=!1,!1):(_adp.hasRunMintCallback=!1,console.warn("Haven't minted expedition yet! Minting that first"),mintExpedition(_adp.projectId,p$("#project-title").value,function(){return _adp.hasRunMintCallback=!0,validateFimsData(a,b)}),!1);console.info("FIMS Validating",a.data),$("#data-validation").removeAttr("indeterminate"),g=Object.size(a.data);try{p$("#data-validation").max=2*g}catch(a){}return i=20,j=null,(c=function(){var a;try{a=p$("#data-validation").value}catch(a){return!1}if(a>=g)return clearTimeout(j),!1;++a;try{p$("#data-validation").value=a}catch(a){return!1}return j=delay(i,function(){return c()})})(),jsonTo64(a.data),h=post64(a.dataSrc),d="perform=validate&datasrc="+h+"&link="+_adp.projectId,console.info("Posting ...",""+uri.urlString+adminParams.apiTarget+"?"+d),_adp.currentAsyncJqxhr=$.post(""+uri.urlString+adminParams.apiTarget,d,"json").done(function(c){var d,e,f,g,h,i,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;if(console.log("FIMS validate result",c),!0!==c.status)return stopLoadError("There was a problem talking to the server"),d=null!=(v=null!=(w=c.human_error)?w:c.error)?v:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.",bsAlert("<strong>Server Error:</strong> "+d,"danger"),stopLoadBarsError(j),!1;E=null!=(null!=(x=c.validate_status)?x.status:void 0)?c.validate_status.status:c.validate_status,n=["FIMS_SERVER_DOWN"],m=["server error"],t=!1,D="";try{if(1===Object.size(c.validate_status.errors)){y=c.validate_status.errors[0];for(k in y){g=y[k],D=g,"object"==typeof D&&(D=g[0]);break}z=D.toLowerCase(),t=indexOf.call(m,z)>=0}}catch(a){}if(i={statusesOK:n,errorsOK:m,message:D,permissible:t,errorSize:Object.size(c.validate_status.errors)},A=c.validate_status,indexOf.call(n,A)>=0||t)toastStatusMessage("Validation server is down, proceeding ..."),bsAlert("<strong>FIMS error</strong>: The validation server is down, we're trying to finish up anyway.","warning");else if(!0!==E){if(s=!1,console.error("Bad validation",i),stopLoadError("There was a problem with your dataset"),d=null!=(B=null!=(C=null!=(u="<code>"+c.validate_status.error+"</code>")?u:c.human_error)?C:c.error)?B:"There was a problem with your dataset, but we couldn't understand what FIMS said. Please manually examine your data, correct it, and try again.",d.length>255&&(s=!0,d=d.substr(0,255)+"[...] and more."),bsAlert("<strong>FIMS reported an error validating your data:</strong> "+d,"danger"),stopLoadBarsError(j),l=c.validate_status.errors,Object.size(l)>1||s){o='<div class="error-block" id="validation-error-block">\n  <p><strong>Your dataset had errors</strong>. Here\'s a summary:</p>\n  <table class="table-responsive table-striped table-condensed table table-bordered table-hover" >\n    <thead>\n      <tr>\n        <th>Error Type</th>\n        <th>Error Message</th>\n      </tr>\n    </thhead>\n    <tbody>';for(q in l){k=l[q];for(e in k){h=k[e],f="<ul>";for(p in h)r=h[p],r=r.stripHtml(!0),/\[(?:((?:"(\w+)"((, )?))*?))\]/m.test(r)&&(r=r.replace(/"(\w+)"/gm,"<code>$1</code>")),f+="<li>"+r+"</li>";f+="</ul>",o+="<tr>\n  <td><strong>"+e.stripHtml(!0)+"</strong></td>\n  <td>"+f+"</td>\n</tr>"}}o+="    </tbody>\n  </table>\n</div>",$("#validator-progress-container").append(o),$("#validator-progress-container").get(0).scrollIntoView()}return!1}try{p$("#data-validation").value=p$("#data-validation").max,clearTimeout(j)}catch(a){}return"function"==typeof b?b(a):void 0}).fail(function(a,b){return clearTimeout(j),console.error(b+": Couldn't upload to FIMS server!"),console.warn("Server said",a.responseText),stopLoadBarsError(null,"There was a problem validating your data, please try again later"),!1}),!1},mintBcid=function(a,b,c,d){var e,f,g,h,i;return null==b&&(b=null!=dataFileParams?dataFileParams.filePath:void 0),"function"!=typeof d?(console.warn("mintBcid() requires a callback function"),!1):(i={},e=null!=("undefined"!=typeof _adp&&null!==_adp&&null!=(g=_adp.fims)&&null!=(h=g.expedition)?h.ark:void 0),f="perform=mint&link="+a+"&title="+post64(c)+"&file="+b+"&expedition="+e,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,f,"json").done(function(a){return console.log("Got",a),a.status?i=a:(stopLoadBarsError(null,a.human_error),console.error(a.error),!1)}).fail(function(a,b){return i={ark:null,error:b,human_error:a.responseText,status:!1},!1}).always(function(){return console.info("mintBcid is calling back",i),d(i)}),!1)},mintExpedition=function(a,b,c){var d,e,f;if(null==a&&(a=_adp.projectId),null==b&&(b=p$("#project-title").value),"function"!=typeof c)return console.warn("mintExpedition() requires a callback function"),!1;f={};try{e=p$("#data-encumbrance-toggle").checked}catch(a){try{e=p$("#public").checked}catch(a){}}return"boolean"!=typeof e&&(e=!1),d="perform=create_expedition&link="+a+"&title="+post64(b)+"&public="+e,_adp.currentAsyncJqxhr=$.post(adminParams.apiTarget,d,"json").done(function(a){var b,c,e,g,h,i,j;if(console.log("Expedition got",a),!a.status){e=a.error.replace(/^.*\[(.*)\]$/gim,"$1"),c=e.unescape();try{g=JSON.parse(c),i=g.message.trim(),h=i.replace(/^([a-z_]+\(.*\):\s*)?((.*?(?::|!)\s*)*(.*))/gim,"$4"),j=i.replace(/^([a-z_]+\(.*\):\s*)?((.*?(?::|!)\s*)*(.*))/gim,"$2"),b=isNull(h)?j:h}catch(a){b="UNREADABLE_FIMS_ERROR"}a.human_error+='" Server said: <code>'+b+"</code> ";try{stopLoadBarsError(null,a.human_error)}catch(b){stopLoadError(a.human_error)}return console.error(a.error,adminParams.apiTarget+"?"+d),!1}return f=a,null==("undefined"!=typeof _adp&&null!==_adp?_adp.fims:void 0)&&("undefined"!=typeof _adp&&null!==_adp||(window._adp={}),_adp.fims={}),_adp.fims.expedition={permalink:a.project_permalink,ark:"object"!=typeof a.ark?a.ark:a.ark.identifier,expeditionId:a.fims_expedition_id,fimsRawResponse:a.responses.expedition_response}}).fail(function(a,b){return f.ark=null,!1}).always(function(){return console.info("mintExpedition is calling back",f),c(f)}),!1},validateTaxonData=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;null==b&&(b=null),d=a.data,n=[],o={};for(g in d)k=d[g],l=null!=(h=k.specificEpithet)?h:k.specificepithet,m=null!=(i=k.infraspecificEpithet)?i:k.infraspecificepithet,c=null!=(j=k.cladeSampled)?j:k.cladesampled,q={genus:k.genus,species:l,subspecies:m,clade:c},n.containsObject(q)||n.push(q),p=q.genus+" "+q.species,isNull(q.subspecies)||(p+=" "+q.subspecies),null==o[p]&&(o[p]=[]),o[p].push(g);console.info("Found "+n.length+" unique taxa:",n),e=n.length>1?"taxa":"taxon",f=Object.toArray(d).length,toastStatusMessage("Validating "+n.length+" unique "+e+" from "+f+" rows ..."),console.info("Replacement tracker",o),$("#taxa-validation").removeAttr("indeterminate");try{p$("#taxa-validation").max=n.length}catch(a){}return(r=function(c,d){return p=c[d].genus+" "+c[d].species,isNull(c[d].subspecies)||(p+=" "+c[d].subspecies),validateAWebTaxon(c[d],function(e){var f,h,i,j,l,m,n,q,s,t,u,v,w,x,y,z;if(!0===e.invalid){for(cleanupToasts(),w=/^([a-zA-Z]+) +[a-zA-Z\. ]+$/im,n=w.exec(c[d].species),x=w.exec(c[d].subspecies),null!=n||null!=x?(z=null!=n?"species":"subspecies",h="(We noticed your "+z+' looks like the full species name. <a href="https://tdwg.github.io/dwc/terms/index.htm#specificEpithet" class="alert-link newwindow" data-newtab="true">Double check the definition <span class="glyphicon glyphicon-new-window"></span></a> and your entry &#8212; that may help!)'):h="Please correct taxonomy issues and try uploading again. If you're confused by this message, please check <a href='https://amphibian-disease-tracker.readthedocs.io/en/latest/APIs/#validating-updating-taxa' data-newtab='true' class='newwindow alert-link'>our documentation  <span class='glyphicon glyphicon-new-window'></span></a>.",q=null!=(s=null!=(t=e.response.human_error)?t:e.response.error)?s:"Unknown error.",stopLoadError(q),q=null!=(u=e.response.human_error_html)?u:q,console.error(e.response.error),y=o[p].slice(0),g=0,i=0,j=y.length;i<j;i++)k=y[i],k++,y[g]=k,g++;return y.length>5&&(y=y.slice(0,5),y+="..."),q="<strong>Taxonomy Error</strong>: There was a taxon error in your file. "+q+" The error occured while we were checking taxon <span class='sciname'>\""+p+'"</span>, which occurs at rows '+y+". We stopped validation at that point. "+h,bsAlert(q),removeDataFile(),stopLoadBarsError(),!1}try{for(v=o[p],console.info("Replacing rows @ "+p,v,c[d]),m=0,l=v.length;m<l;m++)k=v[m],a.data[k].genus=e.genus,a.data[k].specificEpithet=e.species,null==e.subspecies&&(e.subspecies=""),a.data[k].infraspecificEpithet=e.subspecies,a.data[k].originalTaxa=p}catch(a){f=a,console.warn("Problem replacing rows! "+f.message),console.warn(f.stack)}c[d]=e;try{p$("#taxa-validation").value=d}catch(a){}if(++d<c.length)return 0===modulo(d,50)&&toastStatusMessage("Validating taxa "+d+" of "+c.length+" ..."),r(c,d);try{p$("#taxa-validation").value=d}catch(a){}return a.validated_taxa=c,console.info("Calling back!",a),b(a)})})(n,0),!1},loadSUProfileBrowser=function(){var a,b;return b=uri.urlString+"admin-page.html#action:show-su-profiles",a={do:"action",prop:"show-su-profiles"},history.pushState(a,"Viewing Superuser Profile List",b),startAdminActionHelper(),startLoad(),verifyLoginCredentials(function(a){var b,c,d,e;return e=toInt(a.detail.userdata.su_flag),e.toBool()?(c="su-admin-users",b="action=search_users&q=",d=uri.urlString+"api.php",$.post(d,b).done(function(a){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(!0!==a.status)return n=null!=(o=null!=(p=a.human_error)?p:a.error)?o:"There was a problem loading the user list",stopLoadError(n),!1;for(k=a.result,k=Object.toArray(k),l=[],g=0,i=0,j=k.length;i<j;i++)user=k[i],++g,isNull(user.full_name)||(r=user.has_verified_email?"<iron-icon id='restriction-badge-"+g+"' icon='icons:verified-user' class='material-blue' data-toggle='tooltip' title='At least one verified email'></iron-icon>":"",h=user.unrestricted?"<iron-icon id='unrestriction-badge-"+g+"' icon='icons:verified-user' class='material-green' data-toggle='tooltip' title='Meets restriction criteria'></iron-icon>":"<iron-icon id='unrestriction-badge-"+g+"' icon='icons:verified-user' class='material-red' data-toggle='tooltip' title='Fails restriction criteria'></iron-icon>",d=user.is_admin?'<span class="glyphicons glyphicons-user-key" data-toggle="tooltip" title="Adminstrator"></span>':"",e='<span class="'+c+'-user-details">\n  '+user.full_name+" / "+user.handle+" / "+user.email+" | <small>"+(null!=(q=user.alternate_email)?q:"No Alternate Email")+"</small> "+h+" "+r+" "+d+'\n</span>\n<div>\n  <button class="'+c+'-view-projects btn btn-default" data-uid="'+user.uid+'" data-email="'+user.email+'">\n    <iron-icon icon="icons:find-in-page"></iron-icon>\n    Find Projects\n  </button>\n  <button class="'+c+'-reset btn btn-warning" data-uid="'+user.uid+'" data-email="'+user.email+'">\n    <iron-icon icon="av:replay"></iron-icon>\n    Reset Password\n  </button>\n  <button class="'+c+'-delete btn btn-danger" data-uid="'+user.uid+'">\n    <iron-icon icon="icons:delete"></iron-icon>\n    Delete User\n  </button>\n</div>',l.push(e));return m=l.join("</li><li class='su-user-list'>"),f="<ul class='su-total-list col-xs-12' id=\"su-management-list\">\n  <li class='su-user-list'>"+m+"</li>\n</ul>",$("#main-body").html(f),$("."+c+"-view-projects").click(function(){var a,c,d,e;return startLoad(),e=$(this).attr("data-uid"),c=$(this).attr("data-email"),d=e,a="access_data,author_data,author",console.info("Searching on "+d+" ... in "+a),b="action=search_project&q="+d+"&cols="+a,$.post(uri.urlString+"api.php",b,"json").done(function(a){return function(b){var e,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(console.info(b),f='<h3 class="col-xs-12">\n  Projects with "'+c+'" as a participant\n</h3>',t=[],o=Object.toArray(b.result),o.length>0){for(f+="<ul class='project-search-su col-xs-12'>",l=0,k=o.length;l<k;l++)n=o[l],isNull(n.project_id)||(t.push(n.project_id),p=n.public.toBool(),j=d===n.author,console.log(d,n.author,j,n),m=j?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author">\n</iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator">\n</iron-icon>',h=!isNull(n.dataset_arks),g=h?'<iron-icon icon="editor:insert-chart" data-toggle="tooltip" title="Data Attached">\n</iron-icon>':"",i=p?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',e='<button class="btn btn-primary search-proj-link" data-href="'+uri.urlString+"project.php?id="+n.project_id+'" data-toggle="tooltip" data-placement="right" title="Project #'+n.project_id.slice(0,8)+'...">\n  '+i+" "+n.project_title+"\n</button> "+m+" "+g,f+="<li class='project-search-result'>"+e+"</li>");f+="</ul>"}else s=null!=(q=null!=(r=null!=c?c:$(a).attr("data-email"))?r:b.search)?q:d,f="<p class='col-xs-12'><em>No results found for user \"<strong>"+s+'</strong>"';return f+='<div class="col-xs-12">\n  <button class="btn btn-default go-back-button">\n    <iron-icon icon="icons:arrow-back"></iron-icon>\n    Back to Profile Browser\n  </button>\n</div>',$("#main-body").html(f),bindClicks(".search-proj-link"),$(".go-back-button").click(function(){return loadSUProfileBrowser(),!1}),!1}}(this)).fail(function(a){return function(a,b){return console.error("AJAX error trying to search on user projects",a,b),n=b+" "+a.status+": "+a.statusText,stopLoadError("Couldn't search projects ("+n+")"),!1}}()),stopLoad(),!1}),$("."+c+"-reset").click(function(){var a;return startLoad(),a=$(this).attr("data-email"),b="action=startpasswordreset&username="+a+"&method=email",$(this).attr("disabled","disabled"),$.post("admin/async_login_handler.php",b,"json").done(function(b){var c,d;return console.info("Reset prompt returned",b),b.status?(stopLoad(),n="Successfully prompted '"+a+"' to reset their password (method: "+b.method+")",toastStatusMessage(n,"",7e3),!1):(n=null!=(c=null!=(d=b.human_error)?d:b.error)?c:"Couldn't initiate password reset for "+a,"GET_TOTP"===b.action?n="User has two-factor authentication. They have to reset themselves.":isNull(b.action)||(n+=" ("+b.action+")"),stopLoadError(n),!1)}).fail(function(a){return function(b,c){return console.error("AJAX error trying to initiate password reset",b,c),n=c+" "+b.status+": "+b.statusText,stopLoadError("Couldn't initiate password reset ("+n+")"),$(a).removeAttr("disabled"),!1}}(this)),!1}),$("."+c+"-delete").click(function(){return f='<iron-icon icon="icons:warning" class="">\n</iron-icon>\nConfirm Deletion',$(this).addClass("danger-glow").html(f).unbind().click(function(){var a,c;return startLoad(),a=$(this).parents(".su-user-list"),c=$(this).attr("data-uid"),$(this).attr("disabled","disabled"),b="perform=su_manipulate_user&user="+c+"&change_type=delete",console.info("Posting to",""+uri.urlString+adminParams.apiTarget+"?"+b),$.post(adminParams.apiTarget,b,"json").done(function(b){return function(c){var d,e,f;if(console.info("Click to delete returned",c),!0!==c.status){switch(n=null!=(d=null!=(e=c.human_error)?e:c.error)?d:"There was an error executing the action",f=c.error){case-1!==f.search("INVALID_TARGET"):$(b).attr("disabled","disabled")}return stopLoadError(n),!1}return console.log("Got li of ",a),a.slideUp("slow",function(){return a.remove()}),delay(1e3,function(){if(a.exists())return console.warn("Trying to force removal of element"),a.remove()}),!1}}(this)).fail(function(a,b){return console.error("AJAX error",a,b),n=b+" "+a.status+": "+a.statusText,stopLoadError("Couldn't execute action ("+n+")"),!1}).always(function(a){return function(){return delay(300,function(){return $(a).removeAttr("disabled")})}}(this)),stopLoad(),!1}),!1}),stopLoad(),!1}).fail(function(a,b){var c;return console.error("Couldn't load user list",a,b),c=b+" "+a.status+": "+a.statusText,stopLoadError("Sorry, can't load user list ("+c+")")})):(stopLoadError("Sorry, you must be an admin to do this"),!1)}),!1},loadSUProjectBrowser=function(){var a,b;return b=uri.urlString+"admin-page.html#action:show-su-viewable",a={do:"action",prop:"show-su-viewable"},history.pushState(a,"Viewing Superuser Project List",b),startAdminActionHelper(),startLoad(),verifyLoginCredentials(function(a){var b,c;return c=toInt(a.detail.userdata.su_flag),c.toBool()?(b="perform=sulist",$.get(adminParams.apiTarget,b,"json").done(function(a){var b,c,d,e,f,g,h,i;if(!0!==a.status)return b=null!=(h=a.human_error)?h:"Sorry, you can't do that right now",stopLoadError(b),console.error("Can't do SU listing!"),console.warn(a),populateAdminActions(),!1;c='<h2 class="new-title col-xs-12">All Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(c),e=[],i=a.projects;for(g in i)f=i[g],e.push(g),d=f.public.toBool()?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock"></iron-icon>',c='<li>\n  <button class="btn btn-primary" data-project="'+g+'" data-toggle="tooltip" title="Project #'+g.substring(0,8)+'...">\n    '+d+" "+f.title+"\n  </button>\n</li>",$("#project-list").append(c);return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),loadEditor(a)}),stopLoad()}).fail(function(a,b){return stopLoadError("There was a problem loading projects")})):(stopLoadError("Sorry, you must be an admin to do this"),!1)}),!1};
//# sourceMappingURL=admin.min.js.map