var _7zHandler,alertBadProject,bootstrapTransect,bootstrapUploader,csvHandler,dataAttrs,dataFileParams,excelHandler,finalizeData,getCanonicalDataCoords,getInfoTooltip,getProjectCartoData,getTableCoordinates,helperDir,imageHandler,loadCreateNewProject,loadEditor,loadProject,loadProjectBrowser,mapAddPoints,mapOverlayPolygon,newGeoDataHandler,pointStringToLatLng,pointStringToPoint,populateAdminActions,removeDataFile,resetForm,showAddUserDialog,singleDataFileHelper,startAdminActionHelper,user,validateAWebTaxon,validateData,validateFimsData,validateTaxonData,verifyLoginCredentials,zipHandler,modulo=function(a,b){return(+a%(b=+b)+b)%b},indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};window.adminParams={},adminParams.domain="amphibiandisease",adminParams.apiTarget="admin-api.php",adminParams.adminPageUrl="https://"+adminParams.domain+".org/admin-page.html",adminParams.loginDir="admin/",adminParams.loginApiTarget=adminParams.loginDir+"async_login_handler.php",dataFileParams={},dataFileParams.hasDataFile=!1,dataFileParams.fileName=null,dataFileParams.filePath=null,dataAttrs={},helperDir="helpers/",user=$.cookie(adminParams.domain+"_link"),window.loadAdminUi=function(){var a;try{verifyLoginCredentials(function(a){var b;return b="<h3>\n  Welcome, "+$.cookie(adminParams.domain+"_name")+'\n  <span id="pib-wrapper-settings" class="pib-wrapper" data-toggle="tooltip" title="User Settings" data-placement="bottom">\n    <paper-icon-button icon=\'icons:settings-applications\' class=\'click\' data-href=\''+a.login_url+"'></paper-icon-button>\n  </span>\n\n</h3>\n<section id='admin-actions-block' class=\"row center-block text-center\">\n  <div class='bs-callout bs-callout-info'>\n    <p>Please be patient while the administrative interface loads.</p>\n  </div>\n</section>",$("main #main-body").before(b),populateAdminActions(),bindClicks(),!1})}catch(b){a=b,$("main #main-body").html("<div class='bs-callout bs-callout-danger'><h4>Application Error</h4><p>There was an error in the application. Please refresh and try again. If this persists, please contact administration.</p></div>")}return!1},populateAdminActions=function(){var a;return a='<paper-button id="new-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:add"></iron-icon>\n    Create New Project\n</paper-button>\n<paper-button id="edit-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:create"></iron-icon>\n    Edit Existing Project\n</paper-button>\n<paper-button id="view-project" class="admin-action col-md-3 col-sm-4 col-xs-12" raised>\n  <iron-icon icon="icons:visibility"></iron-icon>\n    View All My Projects\n</paper-button>',$("#admin-actions-block").html(a),$("#show-actions").remove(),$("main #main-body").empty(),$("#new-project").click(function(){return loadCreateNewProject()}),$("#edit-project").click(function(){return loadEditor()}),$("#view-project").click(function(){return loadProjectBrowser()})},verifyLoginCredentials=function(a){var b,c,d,e;return c=$.cookie(adminParams.domain+"_auth"),e=$.cookie(adminParams.domain+"_secret"),d=$.cookie(adminParams.domain+"_link"),b="hash="+c+"&secret="+e+"&dblink="+d,$.post(adminParams.loginApiTarget,b,"json").done(function(b){return b.status===!0?a(b):goTo(b.login_url)}).fail(function(a,b){return $("main #main-body").html("<div class='bs-callout-danger bs-callout'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p></div>"),console.log(a,b),!1}),!1},startAdminActionHelper=function(){var a;return $("#admin-actions-block").empty(),$("#pib-wrapper-dashboard").remove(),a='<span id="pib-wrapper-dashboard" class="pib-wrapper" data-toggle="tooltip" title="Administration Home" data-placement="bottom">\n  <paper-icon-button icon="icons:dashboard" class="admin-action" id="show-actions">\n  </paper-icon-button>\n</span>',$("#pib-wrapper-settings").after(a),$("#show-actions").click(function(){return $(this).tooltip("hide"),$(".tooltip").tooltip("hide"),populateAdminActions()})},getInfoTooltip=function(a){var b;return null==a&&(a="No Message Provided"),b='<div class="col-xs-1 adjacent-info">\n  <span class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="'+a+'"></span>\n</div>'},alertBadProject=function(a){return a=null!=a?"project "+a:"this project",stopLoadError("Sorry, "+a+" doesn't exist"),!1},loadCreateNewProject=function(){var a;return startAdminActionHelper(),a='<h2 class="new-title col-xs-12">Project Title</h2>\n<paper-input label="Project Title" id="project-title" class="project-field col-md-6 col-xs-12" required auto-validate data-field="project_title"></paper-input>\n<h2 class="new-title col-xs-12">Project Parameters</h2>\n<section class="project-inputs clearfix col-xs-12">\n  <div class="row">\n    <paper-input label="Primary Pathogen Studied" id="project-disease" class="project-field col-md-6 col-xs-11" required auto-validate data-field="disease"></paper-input>'+getInfoTooltip("Bd, Bsal, or other")+'\n    <paper-input label="Pathogen Strain" id="project-disease-strain" class="project-field col-md-6 col-xs-11" data-field="disease_strain"></paper-input>'+getInfoTooltip("For example, Hepatitus A, B, C would enter the appropriate letter here")+'\n    <paper-input label="Project Reference" id="reference-id" class="project-field col-md-6 col-xs-11" data-field="reference_id"></paper-input>\n    '+getInfoTooltip("E.g.  a DOI or other reference")+'\n    <paper-input label="Publication DOI" id="pub-doi" class="project-field col-md-6 col-xs-11" data-field="publication"></paper-input>\n    <h2 class="new-title col-xs-12">Lab Parameters</h2>\n    <paper-input label="Project PI" id="project-pi" class="project-field col-md-6 col-xs-12"  required auto-validate data-field="pi_lab"></paper-input>\n    <paper-input label="Project Contact" id="project-author" class="project-field col-md-6 col-xs-12"  required auto-validate></paper-input>\n    <gold-email-input label="Contact Email" id="author-email" class="project-field col-md-6 col-xs-12"  required auto-validate></gold-email-input>\n    <paper-input label="Diagnostic Lab" id="project-lab" class="project-field col-md-6 col-xs-12"  required auto-validate></paper-input>\n    <h2 class="new-title col-xs-12">Project Notes</h2>\n    <iron-autogrow-textarea id="project-notes" class="project-field col-md-6 col-xs-11" rows="3" data-field="sample_notes"></iron-autogrow-textarea>'+getInfoTooltip("Project notes or brief abstract")+'\n    <h2 class="new-title col-xs-12">Data Permissions</h2>\n    <div class="col-xs-12">\n      <span class="toggle-off-label iron-label">Private Dataset</span>\n      <paper-toggle-button id="data-encumbrance-toggle" class="red">Public Dataset</paper-toggle-button>\n      <p><strong>Smart selector here for registered users</strong>, only show when "private" toggle set</p>\n    </div>\n    <h2 class="new-title col-xs-12">Project Area of Interest</h2>\n    <div class="col-xs-12">\n      <p>\n        This represents the approximate collection region for your samples.\n        <strong>\n          Leave blank for a bounding box to be calculated from your sample sites\n        </strong>.\n      </p>\n      <span class="toggle-off-label iron-label">Locality Name</span>\n      <paper-toggle-button id="transect-input-toggle">Coordinate List</paper-toggle-button>\n    </div>\n    <p id="transect-instructions" class="col-xs-12"></p>\n    <div id="transect-input" class="col-md-6 col-xs-12">\n    </div>\n    <div id="carto-rendered-map" class="col-md-6">\n      <div id="carto-map-container" class="carto-map map">\n      </div>\n    </div>\n    <div class="col-xs-12">\n      <br/>\n      <paper-checkbox checked id="has-data">My project already has data</paper-checkbox>\n      <br/>\n    </div>\n  </div>\n</section>\n<section id="uploader-container-section" class="data-section col-xs-12">\n  <h2 class="new-title">Uploading your project data</h2>\n  <p>Drag and drop as many files as you need below. </p>\n  <p>\n    To save your project, we need at least one file with structured data containing coordinates.\n    Please note that the data <strong>must</strong> have a header row,\n    and the data <strong>must</strong> have the columns <code>decimalLatitude</code>, <code>decimalLongitude</code>, <code>elevation</code>, and <code>coordinateUncertaintyInMeters</code>.\n  </p>\n  <div class="alert alert-info" role="alert">\n    We\'ve partnered with the Biocode FIMS project and you can get a template with definitions at <a href="http://biscicol.org/biocode-fims/templates.jsp" class="newwindow alert-link">biscicol.org <span class="glyphicon glyphicon-new-window"></span></a>. Your data will be validated with the same service.\n  </div>\n  <div class="alert alert-warning" role="alert">\n    <strong>If the data is in Excel</strong>, ensure that it is in a single-sheet workbook. Data across multiple sheets in one workbook may be improperly processed.\n  </div>\n</section>\n<section class="project-inputs clearfix data-section col-xs-12">\n  <div class="row">\n    <h2 class="new-title col-xs-12">Project Data Summary</h2>\n    <h3 class="new-title col-xs-12">Calculated Data Parameters</h3>\n    <paper-input label="Samples Counted" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="samplecount" readonly type="number" data-field="disease_samples"></paper-input>\n    <paper-input label="Positive Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="positive-samples" readonly type="number" data-field="disease_positive"></paper-input>\n    <paper-input label="Negative Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="negative-samples" readonly type="number" data-field="disease_negative"></paper-input>\n    <paper-input label="No Confidence Samples" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="no_confidence-samples" readonly type="number" data-field="disease_no_confidence"></paper-input>\n    <paper-input label="Disease Morbidity" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="morbidity-count" readonly type="number" data-field="disease_morbidity"></paper-input>\n    <paper-input label="Disease Mortality" placeholder="Please upload a data file to see sample count" class="project-field col-md-6 col-xs-12" id="mortality-count" readonly type="number" data-field="disease_mortality"></paper-input>\n    <h4 class="new-title col-xs-12">Species in dataset</h4>\n    <iron-autogrow-textarea id="species-list" class="project-field col-md-6 col-xs-12" rows="3" placeholder="Taxon List" readonly></iron-autogrow-textarea>\n    <p class="col-xs-12">Etc</p>\n  </div>\n</section>\n<section id="submission-section col-xs-12">\n  <div class="pull-right">\n    <button id="upload-data" class="btn btn-success click" data-function="finalizeData"><iron-icon icon="icons:lock-open"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project</button>\n    <button id="reset-data" class="btn btn-danger click" data-function="resetForm">Reset Form</button>\n  </div>\n</section>',$("main #main-body").append(a),bootstrapUploader(),bootstrapTransect(),$("#has-data").on("iron-change",function(){return $(this).get(0).checked?($(".data-section").removeAttr("hidden"),$(".label-with-data").removeAttr("hidden")):($(".data-section").attr("hidden","hidden"),$(".label-with-data").attr("hidden","hidden"))}),$("#data-encumbrance-toggle").on("iron-change",function(){var a;return a=p$("#data-encumbrance-toggle").checked?'<iron-icon icon="social:public"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Public Project':'<iron-icon icon="icons:lock"></iron-icon> <span class="label-with-data">Save Data &amp;</span> Create Private Project',$("#upload-data").html(a)}),bindClicks(),!1},finalizeData=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(startLoad(),e=!0,$("[required]").each(function(){var a;try{if(a=$(this).val(),isNull(a))return $(this).get(0).focus(),e=!1,!1}catch(b){}}),!e)return stopLoadError("Please fill out all required fields"),!1;for(k={},l=$(".project-field"),i=0,j=l.length;j>i;i++)f=l[i],g=$(f).hasClass("iron-autogrow-textarea-0")?$($(f).get(0).textarea).val():$(f).val(),h=$(f).attr("data-field"),isNull(h)||("number"===$(f).attr("type")?k[h]=toInt(g):k[h]=g);return d=getMapCenter(geo.boundingBox),k.lat=d.lat,k.lng=d.lng,k.author=$.cookie(adminParams.domain+"_link"),b={name:"",affiliation:"",lab:"",entry_date:""},k.author_data=JSON.stringify(b),c={table:geo.dataTable,raw_data:dataFileParams,bounding_polygon:"undefined"!=typeof geo&&null!==geo?geo.canonicalBoundingBox:void 0,bounding_polygon_geojson:"undefined"!=typeof geo&&null!==geo?geo.geoJsonBoundingBox:void 0},k.carto_id=JSON.stringify(c),m=md5(""+geo.dataTable+k.author+Date.now()),k.project_id=m,k["public"]=p$("#data-encumbrance-toggle").checked,a="perform=new&data="+jsonTo64(k),console.info("Data object constructed:",k),$.post(adminParams.apiTarget,a,"json").done(function(a){return a.status===!0?(toastStatusMessage("Data successfully saved to server (Warning: Parsing incomplete! Test Mode!)"),bsAlert("Project ID #<strong>"+k.project_id+"</strong> created","success"),stopLoad()):(console.error(a.error.error),console.log(a),stopLoadError(a.human_error)),!1}).error(function(a,b){return stopLoadError("There was a problem saving your data. Please try again"),!1})},resetForm=function(){return foo()},getTableCoordinates=function(a){return null==a&&(a="tdf0f1bc730325de59d48a5c80df45931_6d6d454828c05e8ceea03c99cc5f547e52fcb5fb"),!1},pointStringToLatLng=function(a){var b,c,d;return a.search(!1)?(d=a.slice(6,-1),b=d.split(" "),c={lat:b[0],lng:b[1]}):(console.warn("Invalid point string"),!1)},pointStringToPoint=function(a){var b,c,d;return a.search(!1)?(d=a.slice(6,-1),c=d.split(" "),b=new Point(c[0],c[1])):(console.warn("Invalid point string"),!1)},bootstrapTransect=function(){var a,b;return window.geocodeLookupCallback=function(){var a,b,c;return startLoad(),b=p$("#locality-input").value,a=new google.maps.Geocoder,c={address:b},a.geocode(c,function(a,b){var c,d,e,f,g,h,i,j,k;if(b===google.maps.GeocoderStatus.OK){console.info("Google said:",a),$("#locality-lookup-result").exists()||$("#carto-rendered-map").prepend('<div class="alert alert-info alert-dismissable" role="alert" id="locality-lookup-result">\n  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n  <strong>Location Found</strong>: <span class="lookup-name"></span>\n</div>'),$("#locality-lookup-result .lookup-name").text(a[0].formatted_address),k=a[0].geometry.location,i=k.lat(),j=k.lng(),f=a[0].geometry.viewport;try{c=f.N,d=f.j,e={nw:[c.j,d.N],ne:[c.j,d.j],se:[c.N,d.N],sw:[c.N,d.j]}}catch(l){h=l,console.warn("Danger: There was an error calculating the bounding box ("+h.message+")"),console.warn(h.stack),console.info("Got bounds",f),console.info("Got geometry",a[0].geometry)}return console.info("Got bounds: ",[i,j],e),geo.boundingBox=e,g=function(){return geo.renderMapHelper(e,i,j)},loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",g,!1)}return stopLoadError("Couldn't find location: "+b)})},geo.renderMapHelper=function(a,b,c){var d,e,f,g,h,i,j;if(null==a&&(a=geo.boundingBox),startLoad(),null==("undefined"!=typeof google&&null!==google?google.maps:void 0))return window.recallMapHelper=function(){return geo.renderMapHelper(a,b,c)},loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=recallMapHelper"),!1;try{if(geo.boundingBox=a,"number"!=typeof b){f=0,i=0;for(g in a)d=a[g],++f,i+=d[0],console.info(d,f,i);b=toFloat(i)/toFloat(f)}if("number"!=typeof c){f=0,j=0;for(g in a)d=a[g],++f,j+=d[1];c=toFloat(j)/toFloat(f)}return b=toFloat(b),c=toFloat(c),h={cartodb_logo:!1,https:!0,mobile_layout:!0,gmaps_base_type:"hybrid",center_lat:b,center_lon:c,zoom:getMapZoom(a)},geo.mapParams=h,$("#carto-map-container").empty(),createMap(null,"carto-map-container",h,function(b,c){var d;try{mapOverlayPolygon(a),stopLoad()}catch(e){d=e,console.error("There was an error drawing your bounding box - "+d.emssage),stopLoadError("There was an error drawing your bounding box - "+d.emssage)}return!1})}catch(k){return e=k,console.error("There was an error rendering the map - "+e.message),stopLoadError("There was an error rendering the map - "+e.message)}},a=function(){return null==("undefined"!=typeof google&&null!==google?google.maps:void 0)?loadJS("https://maps.googleapis.com/maps/api/js?key="+gMapsApiKey+"&callback=geocodeLookupCallback"):geocodeLookupCallback(),!1},(b=function(){var b,c;return p$("#transect-input-toggle").checked?(b="Please input a list of coordinates, in the form <code>lat, lng</code>, with one set on each line. <strong>Please press <kbd>enter</kbd> to insert a new line after your last coordinate</strong>.",c='<iron-autogrow-textarea id="coord-input" class="" rows="3"></iron-autogrow-textarea>'):(b="Please enter a name of a locality",c='<paper-input id="locality-input" label="Locality" class="pull-left"></paper-input> <paper-icon-button class="pull-left" id="do-search-locality" icon="icons:search"></paper-icon-button>'),$("#transect-instructions").html(b),$("#transect-input").html(c),p$("#transect-input-toggle").checked?$(p$("#coord-input").textarea).keyup(function(a){return function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(j=a.keyCode?a.keyCode:a.which,13===j&&(q=$(p$("#coord-input").textarea).val(),n=q.split("\n").length,n>3)){for(f=[],g=q.split("\n"),console.info("Raw coordinate info:",g),k=0,l=g.length;l>k;k++)d=g[k],d.search(",")>0&&!isNull(d)&&(e=d.split(","),2===e.length&&(p=[toFloat(e[0]),toFloat(e[1])],f.push(p)));if(f.length>=3){for(console.info("Coords:",f),i=0,b={},o=0,m=f.length;m>o;o++)c=f[o],++i,b[i]=c;return h=function(){return geo.renderMapHelper(b)},geo.boundingBox=b,loadJS("https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js",h,!1)}return console.warn("There is one or more invalid coordinates preventing the UI from being shown.")}}}(this)):($("#locality-input").keyup(function(b){var c;return c=b.keyCode?b.keyCode:b.which,13===c?a():void 0}),$("#do-search-locality").click(function(){return a()})),!1})(),$("#transect-input-toggle").on("iron-change",function(){return b()}),!1},mapOverlayPolygon=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(null==b&&(b=null),null==c&&(c={}),null==d&&(d=geo.googleMap),n={},"object"!=typeof a)return console.warn("mapOverlayPolygon() got an invalid data type to overlay!"),!1;if("object"!=typeof c&&(c={}),null==c.fillColor&&(c.fillColor="#ff7800"),n.fillColor=c.fillColor,n.fillOpacity=.35,"object"!=typeof b&&(b=null),console.info("Should overlay polygon from bounds here"),$("#carto-map-container").exists()&&null!=geo.cartoMap){s=[],f=[],e=[],l=[],m=[],t=-90,v=90,k=-180,x=180;for(r in a)u=a[r],s.push(u),w={},w.lat=u[0],w.lng=u[1],e.push(new fPoint(w.lat,w.lng)),m.push(new Point(w.lat,w.lng));l=sortPoints(m),f=sortPoints(m,!1),g=e,g.sort(sortPointY),g.sort(sortPointX),h=[],h.push(s);try{i=getConvexHullPoints(g)}catch(y){j=y,console.error("Convex hull points CHP failed! - "+j.message),console.warn(j.stack),console.info(g)}console.info("Got hulls",i),console.info("Sources",f,e,g),n.paths=i,q={type:"Polygon",coordinates:i},p={type:"Feature",properties:b,geometry:q},console.info("Rendering GeoJSON MultiPolygon",q),geo.geoJsonBoundingBox=p,geo.overlayOptions=c,console.info("Rendering Google Maps polygon",n),geo.canonicalBoundingBox=n,o=new google.maps.Polygon(n),null!=geo.googlePolygon&&geo.googlePolygon.setMap(null),geo.googlePolygon=o,o.setMap(d),isNull(dataAttrs.coords||isNull(geo.dataTable))||getCanonicalDataCoords(geo.dataTable)}else console.warn("There's no map yet! Can't overlay polygon");return!1},mapAddPoints=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(null==c&&(c=geo.googleMap),j=0,k=a.length;k>j;j++)if(r=a[j],!(r instanceof geo.Point))return console.warn("Invalid datatype in array -- array must be constructed of Point objects"),!1;for(q={},g=[],e=0,m=0,l=a.length;l>m;m++)r=a[m],u=null!=b?null!=(t=b[e])?t.title:void 0:"",s=r.getObj(),d=new google.maps.LatLng(s.lat,s.lng),o={position:d,map:c,title:u},n=new google.maps.Marker(o),q[e]={marker:n},isNull(u)?console.info("Key "+e+" has no title in pointInfoArray",b[e]):(h={content:b[e].html},f=new google.maps.InfoWindow(h),q[e].infoWindow=f,g.push(f)),++e;if(!isNull(g)){dataAttrs.coordInfoWindows=g;for(i in q)p=q[i],n=p.marker,n.unbind("click"),n.self=n,n.iw=p.infoWindow,n.iwk=i,n.addListener("click",function(){var a;try{return this.iw.open(c,this),console.info("Opening infoWindow #"+this.iwk)}catch(b){return a=b,console.error("Invalid infowindow @ "+this.iwk+"!",g,p,this.iw)}});geo.markers=q}return q},getCanonicalDataCoords=function(a,b){return null==b&&(b=mapAddPoints),isNull(a)?(console.error("A table must be specified!"),!1):"function"!=typeof b?(console.error("This function needs a callback function as the second argument"),!1):(verifyLoginCredentials(function(c){var d,e,f;return f="SELECT ST_AsText(the_geom), genus, specificEpithet, infraspecificEpithet, dateIdentified, sampleMethod, diseaseDetected, diseaseTested, catalogNumber FROM "+a,d=encodeURIComponent(encode64(f)),e="action=fetch&sql_query="+d,$.post("api.php",e,"json").done(function(a){var d,e,f,g,h,i,j,k;d=a.parsed_responses[0],e=[],g=[],i=d.rows;for(f in i)j=i[f],k=j.st_astext,isNull(j.infraspecificepithet)&&(j.infraspecificepithet=""),h=pointStringToPoint(k),c={title:j.catalognumber+": "+j.genus+" "+j.specificepithet+" "+j.infraspecificepithet,html:'<p>\n  <span class="sciname italic">'+j.genus+" "+j.specificepithet+" "+j.infraspecificepithet+"</span> collected on "+j.dateidentified+"\n</p>\n<p>\n  <strong>Status:</strong>\n  Sampled by "+j.samplemethod+", disease status "+j.diseasedetected+" for "+j.diseasetested+"\n</p>"},e.push(h),g.push(c);return dataAttrs.coords=e,dataAttrs.markerInfo=g,b(e,g)}).error(function(a,c){return null!=(null!=dataAttrs?dataAttrs.coords:void 0)?b(dataAttrs.coords,dataAttrs.markerInfo):(stopLoadError("Couldn't get bounding coordinates from data"),console.error("No valid coordinates accessible!"))})}),!1)},bootstrapUploader=function(a,b){var c,d;return null==a&&(a="file-uploader"),null==b&&(b="col-md-4"),d="#"+a,$(d).exists()||(c='<form id="'+a+'-form" class="'+b+' clearfix">\n  <p class="visible-xs-block">Tap the button to upload a file</p>\n  <fieldset class="hidden-xs">\n    <legend>Upload Files</legend>\n    <div id="'+a+'" class="media-uploader outline media-upload-target">\n    </div>\n  </fieldset>\n</form>',$("main #uploader-container-section").append(c),console.info("Appended upload form"),$(d).submit(function(a){return a.preventDefault(),a.stopPropagation(),!1})),verifyLoginCredentials(function(){return null==window.dropperParams&&(window.dropperParams={}),window.dropperParams.uploadPath="uploaded/"+user+"/",loadJS("helpers/js-dragdrop/client-upload.min.js",function(){return console.info("Loaded drag drop helper"),window.dropperParams.postUploadHandler=function(a,b){var c,d,e,f,g,h;if(window.dropperParams.dropzone.removeAllFiles(),"object"!=typeof b)return console.error("Dropzone returned an error - "+b),toastStatusMessage("There was a problem with the server handling your image. Please try again."),!1;if(b.status!==!0)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(""+b.human_error),console.error("Error uploading!",b),!1;try{switch(console.info("Server returned the following result:",b),console.info("The script returned the following file information:",a),g="helpers/js-dragdrop/uploaded/"+user+"/",b.full_path=b.wrote_file,b.thumb_path=b.wrote_thumb,f=b.mime_provided.split("/")[0],e=b.mime_provided.split("/")[1],d=a.size<5242880||"image"!==f?""+g+b.full_path:""+g+b.thumb_path,h=function(){switch(f){case"image":return'<div class="uploaded-media center-block" data-system-file="'+b.full_path+'">\n  <img src="'+d+'" alt=\'Uploaded Image\' class="img-circle thumb-img img-responsive"/>\n    <p class="text-muted">\n      '+a.name+" -> "+b.full_path+'\n  (<a href="'+d+'" class="newwindow" download="'+a.name+'">\n    Original Image\n  </a>)\n    </p>\n</div>';case"audio":return'<div class="uploaded-media center-block" data-system-file="'+b.full_path+'">\n  <audio src="'+d+'" controls preload="auto">\n    <span class="glyphicon glyphicon-music"></span>\n    <p>\n      Your browser doesn\'t support the HTML5 <code>audio</code> element.\n      Please download the file below.\n    </p>\n  </audio>\n  <p class="text-muted">\n    '+a.name+" -> "+b.full_path+'\n    (<a href="'+d+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';case"video":return'<div class="uploaded-media center-block" data-system-file="'+b.full_path+'">\n  <video src="'+d+'" controls preload="auto">\n    <img src="'+g+b.thumb_path+'" alt="Video Thumbnail" class="img-responsive" />\n    <p>\n      Your browser doesn\'t support the HTML5 <code>video</code> element.\n      Please download the file below.\n    </p>\n  </video>\n  <p class="text-muted">\n    '+a.name+" -> "+b.full_path+'\n    (<a href="'+d+'" class="newwindow" download="'+a.name+'">\n      Original Media\n    </a>)\n  </p>\n</div>';default:return'<div class="uploaded-media center-block" data-system-file="'+b.full_path+'">\n  <span class="glyphicon glyphicon-file"></span>\n  <p class="text-muted">'+a.name+" -> "+b.full_path+"</p>\n</div>"}}(),$(window.dropperParams.dropTargetSelector).before(h),f){case"application":switch(console.info("Checking "+e+" in application"),e){case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"vnd.ms-excel":return excelHandler(d);case"zip":case"x-zip-compressed":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===a.type||"xlsx"===d.split(".").pop()?excelHandler(d):zipHandler(d);case"x-7z-compressed":return _7zHandler(d)}break;case"text":return csvHandler();case"image":return imageHandler()}}catch(i){return c=i,toastStatusMessage("Your file uploaded successfully, but there was a problem in the post-processing.")}}}),!1})},singleDataFileHelper=function(a,b){var c;return"function"!=typeof b?(console.error("Second argument must be a function"),!1):dataFileParams.hasDataFile===!0?($("#single-data-file-modal").exists()&&$("#single-data-file-modal").remove(),c='<paper-dialog modal id="single-data-file-modal">\n  <h2>You can only have one primary data file</h2>\n  <div>\n    Continuing will remove your previous one\n  </div>\n  <div class="buttons">\n    <paper-button id="cancel-parse">Cancel Upload</paper-button>\n    <paper-button id="overwrite">Replace Previous</paper-button>\n  </div>\n</paper-dialog>',$("body").append(c),$("#cancel-parse").click(function(){return removeDataFile(a,!1),p$("#single-data-file-modal").close(),!1}),$("#overwrite").click(function(){return removeDataFile(),p$("#single-data-file-modal").close(),b()}),safariDialogHelper("#single-data-file-modal")):b()},excelHandler=function(a,b){var c,d,e;return null==b&&(b=!0),startLoad(),toastStatusMessage("Processing ..."),e=helperDir+"excelHelper.php",d=a,a.search(-1!==helperDir)&&(d=a.slice(helperDir.length)),console.info("Pinging for "+d),c="action=parse&path="+d,$.get(e,c,"json").done(function(b){return console.info("Got result",b),singleDataFileHelper(a,function(){var c,e,f,g;return dataFileParams.hasDataFile=!0,dataFileParams.fileName=a,dataFileParams.filePath=d,g=Object.size(b.data),e="",g>0&&(f=randomInt(1,g)-1,e="\n\nHere's a random row: "+JSON.stringify(b.data[f])),c="<pre>\nFrom upload, fetched "+g+" rows."+e+"\n</pre>",newGeoDataHandler(b.data),stopLoad()})}).fail(function(a,b){return console.error("Couldn't POST"),console.warn(a,b),stopLoadError()}),!1},csvHandler=function(a){return dataFileParams.hasDataFile=!0,dataFileParams.fileName=a,dataFileParams.filePath=correctedPath,geoDataHandler(),!1},imageHandler=function(a){return foo(),!1},zipHandler=function(a){return foo(),!1},_7zHandler=function(a){return foo(),!1},removeDataFile=function(a,b){var c,d;return null==a&&(a=dataFileParams.fileName),null==b&&(b=!0),a=a.split("/").pop(),b&&(dataFileParams.hasDataFile=!1),$(".uploaded-media[data-system-file='"+a+"']").remove(),d=helperDir+"/js-dragdrop/uploaded/"+user+"/"+a,c="action=removefile&path="+encode64(a)+"&user="+user,!1},newGeoDataHandler=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;null==a&&(a={});try{try{v=a[0]}catch(C){return toastStatusMessage("Your data file was malformed, and could not be parsed. Please try again."),removeDataFile(),!1}if(null==v.decimalLatitude||null==v.decimalLongitude||null==v.coordinateUncertaintyInMeters||null==v.alt)return toastStatusMessage("Data are missing required geo columns. Please reformat and try again."),console.info("Missing: ",null!=v.decimalLatitude,null!=v.decimalLongitude,null!=v.coordinateUncertaintyInMeters,null!=v.alt),removeDataFile(),!1;if(!(isNumber(v.decimalLatitude)&&isNumber(v.decimalLongitude)&&isNumber(v.coordinateUncertaintyInMeters)&&isNumber(v.alt)))return toastStatusMessage("Data has invalid entries for geo columns. Please be sure they're all numeric and try again."),removeDataFile(),!1;u=Object.size(a),p$("#samplecount").value=u,isNull($("#project-disease").val())&&(p$("#project-disease").value=v.diseaseTested),q={},dataAttrs.coords=[],dataAttrs.coordsFull=[],dataAttrs.fimsData=[],l={},toastStatusMessage("Please wait, parsing your data");for(p in a){t=a[p],z={};for(c in t){switch(B=t[c],c){case"ContactName":case"basisOfRecord":case"occurrenceID":case"institutionCode":case"collectionCode":case"labNumber":case"originalsource":case"datum":case"georeferenceSource":case"depth":case"Collector2":case"Collector3":case"verbatimLocality":case"Habitat":case"Test_Method":case"eventRemarks":case"quantityDetected":case"dilutionFactor":case"cycleTimeFirstDetection":l[c]=B;break;case"specimenDisposition":c="sampleDisposition";break;case"elevation":c="alt";break;case"dateIdentified":try{B>0&&1e6>B?(i=25569,j=24107,x=86400,y=(B-i)*x*1e3):y=Date.parse(B)}catch(C){y=Date.now()}f=new Date(y),h=f.getUTCDate(),10>h&&(h="0"+h),o=f.getUTCMonth()+1,10>o&&(o="0"+o),b=f.getUTCFullYear()+"-"+o+"-"+h;break;case"fatal":b=B.toBool();break;case"decimalLatitude":case"decimalLongitude":case"alt":case"coordinateUncertaintyInMeters":if(!isNumber(B))return stopLoadError("Detected an invalid number for "+c+" at row "+p+" ('"+B+"')"),!1;if("decimalLatitude"===c&&-90>B&&B>90)return stopLoadError("Detected an invalid latitude "+B+" at row "+p),!1;if("decimalLongitude"===c&&-180>B&&B>180)return stopLoadError("Detected an invalid longitude "+B+" at row "+p),!1;if("coordinateUncertaintyInMeters"===c&&0>=B)return stopLoadError("Coordinate uncertainty must be >= 0 at row "+p),!1;b=toFloat(B);break;case"diseaseDetected":b=isBool(B)?B.toBool():"NO_CONFIDENCE";break;default:try{b=B.trim()}catch(C){b=B}}z[c]=b}d={lat:z.decimalLatitude,lng:z.decimalLongitude,alt:z.alt,uncertainty:z.coordinateUncertaintyMeters},e=new Point(d.lat,d.lng),dataAttrs.coords.push(e),dataAttrs.coordsFull.push(d),dataAttrs.fimsData.push(l);try{z.fimsExtra=JSON.stringify(l)}catch(C){console.warn("Couldn't store FIMS extra data",l)}q[p]=z,0===modulo(p,500)&&p>0&&toastStatusMessage("Processed "+p+" rows ...")}try{r=JsonHuman.format(q)}catch(C){k=C,console.warn("Couldn't pretty set!"),console.warn(k.stack),console.info(q)}s="t"+md5(p$("#project-title").value+$.cookie(uri.domain+"_link")),m=function(){var a,b,c,d,e,f,g;for(b=0,c={},f=sortPoints(dataAttrs.coords),g="",d=0,e=f.length;e>d;d++)a=f[d],c[b]=[a.lat,a.lng],g+=a.lat+","+a.lng+"\n",++b;try{p$("#transect-input-toggle").checked=!0,
g+="\n",$(p$("#coord-input").textarea).val(g)}catch(h){}return c},null==geo.boundingBox&&(geo.boundingBox=m()),w={mortality:0,morbidity:0,positive:0,negative:0,no_confidence:0};for(n in q){switch(g=q[n],g.diseaseDetected){case!0:w.morbidity++,w.positive++;break;case!1:w.negative++;break;case"NO_CONFIDENCE":w.no_confidence++}g.fatal&&w.mortality++}p$("#positive-samples").value=w.positive,p$("#negative-samples").value=w.negative,p$("#no_confidence-samples").value=w.no_confidence,p$("#morbidity-count").value=w.morbidity,p$("#mortality-count").value=w.mortality,A={transectRing:geo.boundingBox,data:q,samples:w},validateData(A,function(a){var b,c,d,e,f,g,h;for(g="",b=0,e=a.validated_taxa,c=0,d=e.length;d>c;c++)f=e[c],h=f.genus+" "+f.species,isNull(f.subspecies)||(h+=" "+f.subspecies),b>0&&(g+="\n"),g+=""+h,++b;return p$("#species-list").bindValue=g,dataAttrs.dataObj=a,geo.requestCartoUpload(a,s,"create",function(b){return mapOverlayPolygon(a.transectRing)})})}catch(C){k=C,console.error(k.message),toastStatusMessage("There was a problem parsing your data")}return!1},$(function(){return $("#next").exists()&&$("#next").unbind().click(function(){return openTab(adminParams.adminPageUrl)}),loadJS("bower_components/bootstrap/dist/js/bootstrap.min.js",function(){return $("body").tooltip({selector:"[data-toggle='tooltip']"})})}),loadEditor=function(){var a,b;return startAdminActionHelper(),a=function(a){return startAdminActionHelper(),startLoad(),window.projectParams={},window.projectParams.pid=a,verifyLoginCredentials(function(c){var d,e,f;return f=c.detail,user=f.uid,e=a,a=encodeURIComponent(a),d="perform=get&project="+a,$.post(adminParams.apiTarget,d,"json").done(function(a){var c,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;try{if(console.info("Server said",a),a.status!==!0)return l=null!=(A=a.human_error)?A:a.error,null==l&&(l="Unidentified Error"),stopLoadError("There was a problem loading your project ("+l+")"),console.error("Couldn't load project! (POST OK) Error: "+a.error),console.warn("Attempted",adminParams.apiTarget+"?"+d),!1;if(a.user.has_edit_permissions!==!0)return a.user.has_view_permissions||a.project["public"]===!0?(loadProject(e,"Ineligible to edit "+e+", loading as read-only"),!1):(alertBadProject(e),!1);for(toastStatusMessage("Good user, would load editor for project"),y=a.project,y.access_data.total=Object.toArray(y.access_data.total),y.access_data.total.sort(),y.access_data.editors_list=Object.toArray(y.access_data.editors_list),y.access_data.viewers_list=Object.toArray(y.access_data.viewers_list),y.access_data.editors=Object.toArray(y.access_data.editors),y.access_data.viewers=Object.toArray(y.access_data.viewers),console.info("Project access lists:",y.access_data),x=function(){return verifyLoginCredentials(function(b){var c,e,f,g,h,i,j,k,l,m,n,o,p;for(o="",l=y.access_data.total,j=0,k=l.length;k>j;j++)user=l[j],m=user+" <span class='set-permission-block'>",g=user===y.access_data.author,h=indexOf.call(y.access_data.editors_list,user)>=0,i=!h,f=h||g?"disabled":"data-toggle='tooltip' title='Make Editor'",p=i||g?"disabled":"data-toggle='tooltip' title='Make Read-Only'",c=g?"disabled":"data-toggle='tooltip' title='Grant Ownership'",n=y.access_data.composite[user].user_id,m+='<paper-icon-button icon="image:edit" '+f+' class="set-permission" data-permission="edit" data-user="'+n+'"> </paper-icon-button>\n<paper-icon-button icon="image:remove-red-eye" '+p+' class="set-permission" data-permission="read" data-user="'+n+'"> </paper-icon-button>',a.user.is_author&&(m+='<paper-icon-button icon="social:person" '+c+' class="set-permission" data-permission="author" data-user="'+n+'"> </paper-icon-button>'),a.user.has_edit_permissions&&user!==g&&user!==a.user.user.userdata.username&&(m+='<paper-icon-button icon="icons:delete" class="set-permission" data-permission="delete" data-user="'+n+'">\n</paper-icon-button>'),o+="<li>"+m+"</span></li>";return o='<ul class="simple-list">\n  '+o+"\n</ul>",1===y.access_data.total.length&&(o+='<div id="single-user-warning">\n  <iron-icon icon="icons:warning"></iron-icon> <strong>Head\'s-up</strong>: You can\'t change permissions when a project only has one user. Consider adding another user first.\n</div>'),e='<paper-dialog modal id="user-setter-dialog">\n  <h2>Manage "'+y.project_title+'" users</h2>\n  <paper-dialog-scrollable>\n    '+o+'\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button class="add-user" dialog-confirm><iron-icon icon="social:group-add"></iron-icon> Add Users</paper-button>\n    <paper-button class="close-dialog" dialog-dismiss>Done</paper-button>\n  </div>\n</paper-dialog>',$("#user-setter-dialog").remove(),$("body").append(e),$(".set-permission").unbind().click(function(){var a,b,c,e;return user=$(this).attr("data-user"),b=$(this).attr("data-permission"),c={},e=[],e.push(user),c[b]=e,a=jsonTo64(c),d="perform=editaccess&project="+window.projectParams.pid+"&deltas="+a,toastStatusMessage("Would grant "+user+" permission '"+b+"'"),console.log("Would push args to",adminParams.apiTarget+"?"+d),!1}),$(".add-user").unbind().click(function(){return showAddUserDialog(y.access_data.total),!1}),safariDialogHelper("#user-setter-dialog"),!1})},G="",B=y.access_data.total,q=0,r=B.length;r>q;q++)user=B[q],p="",user===y.access_data.author?p='<iron-icon icon="social:person"></iron-icon>':indexOf.call(y.access_data.editors_list,user)>=0?p='<iron-icon icon="image:edit"></iron-icon>':indexOf.call(y.access_data.viewers_list,user)>=0&&(p='<iron-icon icon="image:remove-red-eye"></iron-icon>'),G+='<tr>\n  <td colspan="5">'+user+'</td>\n  <td class="text-center">'+p+"</td>\n</tr>";p=y["public"].toBool()?'<iron-icon icon="social:public" class="material-green" data-toggle="tooltip" title="Public Project"></iron-icon>':'<iron-icon icon="icons:lock" class="material-red" data-toggle="tooltip" title="Private Project"></iron-icon>',z=y["public"].toBool()?"<!-- This project is already public -->":a.user.is_author?'<div class="col-xs-12">\n  <paper-toggle-button id="public" class="project-params danger-toggle red">\n    <iron-icon icon="icons:warning"></iron-icon>\n    Make this project public\n  </paper-toggle-button> <span class="text-muted small">Once saved, this cannot be undone</span>\n</div>':"<!-- This user does not have permission to toggle the public state of this project -->",i=a.user.has_edit_permissions?"":"readonly",f=y.includes_anura.toBool()?"checked disabled":"disabled",h=y.includes_caudata.toBool()?"checked disabled":"disabled",n=y.includes_gymnophiona.toBool()?"checked disabled":"disabled";try{g=JSON.parse(deEscape(y.carto_id))}catch(H){console.error("Couldn't parse the carto JSON!",y.carto_id),stopLoadError("We couldn't parse your data. Please try again later."),g={}}if(u="",null!=(null!=(C=g.bounding_polygon)?C.paths:void 0)){for(w=g.bounding_polygon,u='<google-map-poly closed fill-color="'+w.fillColor+'" fill-opacity="'+w.fillOpacity+'" stroke-weight="1">',F=[],D=w.paths,t=0,s=D.length;s>t;t++)v=D[t],indexOf.call(F,v)<0&&(F.push(v),u+='<google-map-point latitude="'+v.lat+'" longitude="'+v.lng+'"> </google-map-point>');u+="    </google-map-poly>"}return m='<google-map id="transect-viewport" latitude="'+y.lat+'" longitude="'+y.lng+'" fit-to-markers map-type="hybrid" disable-default-ui>\n  '+u+"\n</google-map>",geo.googleMapWebComponent=m,j=a.user.is_author?'<div class="card-actions">\n      <paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>\n    </div>':"",o='<h2 class="clearfix newtitle col-xs-12">Managing '+y.project_title+" "+p+"<br/><small>Project #"+e+"</small></h2>\n"+z+'\n<section id="manage-users" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Collaborators" elevation="2">\n    <div class="card-content">\n      <table class="table table-striped table-condensed table-responsive table-hover clearfix">\n        <thead>\n          <tr>\n            <td colspan="5">User</td>\n            <td>Permissions</td>\n          </tr>\n        </thead>\n        <tbody>\n          '+G+'\n        </tbody>\n      </table>\n    </div>\n    <div class="card-actions">\n      <paper-button class="manage-users" id="manage-users">Manage Users</paper-button>\n    </div>\n  </paper-card>\n</section>\n<section id="project-basics" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Basics</h3>\n  <paper-input readonly label="Project Identifier" value="'+y.project_id+'" id="project_id" class="project-param"></paper-input>\n  <paper-input '+i+' class="project-param" label="Project Title" value="'+y.project_title+'" id="project_title" class="project-param"></paper-input>\n  <paper-input '+i+' class="project-param" label="Primary Disease" value="'+y.disease+'"></paper-input>\n  <paper-input '+i+' class="project-param" label="PI Lab" value="'+y.pi_lab+'" id="project_title" class="project-param"></paper-input>\n  <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n  <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n  <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n</section>\n<section id="data-management" class="col-xs-12 col-md-4 pull-right">\n  <paper-card class="clearfix" heading="Project Data" elevation="2" id="data-card">\n    <div class="card-content">\n      <div class="variable-card-content">\n      Your project does/does not have data associated with it. (Does should note overwrite, and link to cartoParsed.raw_data.filePath for current)\n      </div>\n      <div id="append-replace-data-toggle">\n        <span class="toggle-off-label iron-label">Append Data</span>\n        <paper-toggle-button id="replace-data-toggle" checked>Replace Data</paper-toggle-button>\n      </div>\n      <div id="uploader-container-section">\n      </div>\n    </div>\n  </paper-card>\n  <paper-card class="clearfix" heading="Project Status" elevation="2" id="save-card">\n    <div class="card-content">\n      <p>Notice if there\'s unsaved data or not. Buttons below should dynamically disable/enable based on appropriate state.</p>\n    </div>\n    <div class="card-actions">\n      <paper-button id="save-project"><iron-icon icon="icons:save" class="material-green"></iron-icon> Save Project</paper-button>\n    </div>\n    <div class="card-actions">\n      <paper-button id="discard-changes-exit"><iron-icon icon="icons:undo"></iron-icon> Discard Changes &amp; Exit</paper-button>\n    </div>\n    '+j+'\n  </paper-card>\n</section>\n<section id="project-data" class="col-xs-12 col-md-8 clearfix">\n  <h3>Project Data Overview</h3>\n    <h4>Project Studies:</h4>\n      <paper-checkbox '+f+">Anura</paper-checkbox>\n      <paper-checkbox "+h+">Caudata</paper-checkbox>\n      <paper-checkbox "+n+">Gymnophiona</paper-checkbox>\n    <h4>Sample Metrics</h4>\n      <paper-input "+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n    <h4>Locality &amp; Transect Data</h4>\n      '+m+"\n      <paper-input "+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n  <h3>Project Meta Parameters</h3>\n    <h4>Project funding status</h4>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n      <paper-input '+i+' class="project-param" label="" value="" id="" class="project-param"></paper-input>\n</section>',$("#main-body").html(o),$("#delete-project").click(function(){var a;return a='<paper-button id="confirm-delete-project" class="materialred">\n  <iron-icon icon="icons:warning"></iron-icon> Confirm Project Deletion\n</paper-button>',$(this).replaceWith(a),$("#confirm-delete-project").click(function(){return toastStatusMessage("TODO Would delete this project"),!1}),!1}),$("#save-project").click(function(){var a;return $("#confirm-delete-project").exists()&&(a='<paper-button id="delete-project"><iron-icon icon="icons:delete" class="material-red"></iron-icon> Delete this project</paper-button>',$("#confirm-delete-project").replaceWith(a)),toastStatusMessage("TODO Would save this project"),!1}),$("#discard-changes-exit").click(function(){return b(),!1}),E=$("#data-management").offset().top,c={top:E,bottom:0,target:window},$("#manage-users").click(function(){return x()}),$(".danger-toggle").on("iron-change",function(){return $(this).get(0).checked?$(this).find("iron-icon").addClass("material-red"):$(this).find("iron-icon").removeClass("material-red")}),getProjectCartoData(y.carto_id)}catch(H){return k=H,stopLoadError("There was an error loading your project"),console.error("Unhandled exception loading project! "+k.message),console.warn(k.stack),!1}}).error(function(a,b){return stopLoadError("We couldn't load your project. Please try again.")})}),!1},(b=function(){var b;return startLoad(),b="perform=list",$.get(adminParams.apiTarget,b,"json").done(function(b){var c,d,e,f,g,h,i,j;d='<h2 class="new-title col-xs-12">Editable Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(d),c=[],i=b.authored_projects;for(f in i)g=i[f],c.push(g);j=b.projects;for(g in j)h=j[g],e=indexOf.call(c,g)>=0?'<iron-icon icon="social:person" data-toggle="tooltip" title="Author"></iron-icon>':'<iron-icon icon="social:group" data-toggle="tooltip" title="Collaborator"></iron-icon>',indexOf.call(c,g)>=0&&(d='<li>\n  <button class="btn btn-primary" data-project="'+g+'">\n    '+h+" / #"+g.substring(0,8)+"\n  </button>\n  "+e+"\n</li>",$("#project-list").append(d));return $("#project-list button").unbind().click(function(){var b;return b=$(this).attr("data-project"),a(b)}),stopLoad()}).error(function(a,b){return stopLoadError("There was a problem loading viable projects")})})(),!1},showAddUserDialog=function(a){var b;return b='<paper-dialog modal id="add-new-user">\n<h2>Add New User To Project</h2>\n<paper-dialog-scrollable>\n  <p>Search by email, real name, or username below. Click on a search result to queue a user for adding.</p>\n  <div class="form-horizontal" id="search-user-form-container">\n    <div class="form-group">\n      <label for="search-user" class="sr-only form-label">Search User</label>\n      <input type="text" id="search-user" name="search-user" class="form-control"/>\n    </div>\n    <paper-material id="user-search-result-container" class="pop-result" hidden>\n      <div class="result-list">\n        <div class="user-search-result" data-uid="456"><span class="email">foo@bar.com</span> | <span class="name">Jane Smith</span> | <span class="user">FooBar</span></div>\n        <div class="user-search-result" data-uid="123"><span class="email">foo2@bar.com</span> | <span class="name">John Smith</span> | <span class="user">FooBar2</span></div>\n      </div>\n    </paper-material>\n  </div>\n  <p>Adding users:</p>\n  <ul class="simple-list" id="user-add-queue">\n    <!--\n      <li class="list-add-users" data-uid="789">\n        jsmith@sample.com\n      </li>\n    -->\n  </ul>\n</paper-dialog-scrollable>\n<div class="buttons">\n  <paper-button id="add-user"><iron-icon icon="social:person-add"></iron-icon> Save Additions</paper-button>\n  <paper-button dialog-dismiss>Cancel</paper-button>\n</div>\n</paper-dialog>',$("#add-new-user").exists()||$("body").append(b),safariDialogHelper("#add-new-user"),$("#search-user").keyup(function(){var a;return console.log("Should search",$(this).val()),$("#debug-alert").exists()||(a='<div class="alert alert-warning" id="debug-alert">\n  Would search against "<span id="debug-placeholder"></span>". Incomplete. Sample result shown.\n</div>',$(this).before(a)),$("#debug-placeholder").text($(this).val()),isNull($(this).val())?$("#user-search-result-container").prop("hidden","hidden"):$("#user-search-result-container").removeAttr("hidden")}),$("body .user-search-result").click(function(){var b,c,d,e,f,g,h;for(h=$(this).attr("data-uid"),console.info("Clicked on "+h),c=$(this).find(".email").text(),b=[],g=$("#user-add-queue .list-add-users"),d=0,e=g.length;e>d;d++)user=g[d],b.push($(user).attr("data-uid"));return indexOf.call(a,c)<0?indexOf.call(b,h)<0?(f='<li class="list-add-users" data-uid="'+h+'">'+c+"</li>",$("#user-add-queue").append(f),$("#search-user").val(""),$("#user-search-result-container").prop("hidden","hidden")):(toastStatusMessage(c+" is already in the addition queue"),!1):(toastStatusMessage(c+" already has access to this project"),!1)}),$("#add-user").click(function(){var a,b,c,d,e,f,g;for(f=[],e=$("#user-add-queue .list-add-users"),c=0,d=e.length;d>c;c++)user=e[c],f.push($(user).attr("data-uid"));return f.length<1?(toastStatusMessage("Please add at least one user to the access list."),!1):(console.info("Saving list of "+f.length+" UIDs to "+window.projectParams.pid,f),b={add:f},g=jsonTo64(b),a="perform=editaccess&project="+window.projectParams.pid+"&deltas="+g,toastStatusMessage("Would save the list above of "+f.length+" UIDs to "+window.projectParams.pid),console.log("Would push args to",adminParams.apiTarget+"?"+a))}),!1},getProjectCartoData=function(a){var b,c,d,e,f,g,h;if("object"!=typeof a)try{d=JSON.parse(deEscape(a))}catch(i){return console.error("cartoObj must be JSON string or obj, given",a),console.warn("Cleaned obj:",deEscape(a)),stopLoadError("Couldn't parse data"),!1}else d=a;return f=d.table,console.info("Working with Carto data base set",d),h=getMapZoom(d.bounding_polygon.paths,"#transect-viewport"),console.info("Got zoom",h),$("#transect-viewport").attr("zoom",h),toastStatusMessage("Would ping CartoDB and fetch data for table "+f),e="SELECT genus, specificEpithet, diseaseTested, diseaseDetected, ST_asGeoJSON(the_geom) FROM "+f+";",console.info("Would ping cartodb with",e),b=encodeURIComponent(encode64(e)),c="action=fetch&sql_query="+b,$.post("api.php",c,"json").done(function(a){var b,c,d,e,f,g,h,i,j,k,l;if(console.info("Carto query got result:",a),!a.status)return b=null!=(h=a.human_error)?h:a.error,null==b&&(b="Unknown error"),stopLoadError("Sorry, we couldn't retrieve your information at the moment ("+b+")"),!1;j=a.parsed_responses[0].rows,k=-13,l=geo.googleMapWebComponent.slice(0,k);for(d in j)i=j[d],c=JSON.parse(i.st_asgeojson),e=c.coordinates[0],f=c.coordinates[1],g='<google-map-marker latitude="'+e+'" longitude="'+f+'">\n  <p>\n    <em>'+i.genus+" "+i.specificepithet+"</em>\n    <br/>\n    Tested <strong>"+i.diseasedetected+"</strong> for "+i.diseasetested+"\n  </p>\n</google-map-marker>",l+=g;return l+="</google-map>",$("#transect-viewport").replaceWith(l),stopLoad()}).fail(function(a,b){return console.error("Couldn't talk to back end server to ping carto!"),stopLoadError("There was a problem communicating with the server. Please try again in a bit. (E-002)")}),d.raw_data.hasDataFile?(g='<p>\n  Your project already has data associated with it. <span id="last-modified-file"></span>\n</p>\n<button id="download-project-file" class="btn btn-primary center-block click" data-href="'+d.raw_data.fileName+'"><iron-icon icon="icons:cloud-download"></iron-icon> Download File</button>\n<p>You can upload more data below, or replace this existing data.</p>',$("#data-card .card-content .variable-card-content").html(g),$.get("meta.php","do=get_last_mod&file="+d.raw_data.fileName,"json").done(function(a){var b,c,e,f;return e=1e3*toInt(a.last_mod),console.log("Last modded",e,a),isNumber(e)?(c=new Date(e),b=c.toISOString(),f=b.slice(0,b.search("T"))+" "+c.toTimeString().split(" ")[0],$("#last-modified-file").text("Last uploaded on "+f+".")):console.warn("Didn't get a number back to check last mod time for "+d.raw_data.fileName),!1}).fail(function(a,b){return console.warn("Couldn't get last mod time for "+d.raw_data.fileName),!1})):($("#data-card .card-content .variable-card-content").html("<p>You can upload data to your project here:</p>"),$("#append-replace-data-toggle").attr("hidden","hidden")),bootstrapUploader("data-card-uploader",""),!1},loadProjectBrowser=function(){var a;return startAdminActionHelper(),startLoad(),a="perform=list",$.get(adminParams.apiTarget,a,"json").done(function(a){var b,c,d,e,f,g,h,i;b='<h2 class="new-title col-xs-12">Available Projects</h2>\n<ul id="project-list" class="col-xs-12 col-md-6">\n</ul>',$("#main-body").html(b),g=[],h=a.public_projects;for(d in h)e=h[d],g.push(e);i=a.projects;for(e in i)f=i[e],c=indexOf.call(g,e)>=0?'<iron-icon icon="social:public"></iron-icon>':'<iron-icon icon="icons:lock-open"></iron-icon>',b='<li>\n  <button class="btn btn-primary" data-project="'+e+'" data-toggle="tooltip" title="Project #'+e.substring(0,8)+'...">\n    '+c+" "+f+"\n  </button>\n</li>",$("#project-list").append(b);return $("#project-list button").unbind().click(function(){var a;return a=$(this).attr("data-project"),loadProject(a)}),stopLoad()}).error(function(a,b){return stopLoadError("There was a problem loading viable projects")}),!1},loadProject=function(a,b){return null==b&&(b=""),toastStatusMessage("Would load project "+a+" to view"),!1},"object"!=typeof window.validationMeta&&(window.validationMeta={}),validateData=function(a,b){var c;return null==b&&(b=null),console.info("Doing nested validation"),c=Date.now(),validateFimsData(a,function(){return validateTaxonData(a,function(){var d;return d=Date.now()-c,console.info("Validation took "+d+"ms",a),cleanupToasts(),toastStatusMessage("Your dataset has been successfully validated"),"function"==typeof b?b(a):(console.warn("validateData had no defined callback!"),console.info("Got back",a))})}),!1},validateFimsData=function(a,b){var c;return null==b&&(b=null),console.info("FIMS Validating",a.data),c="","function"==typeof b&&b(a),!1},validateTaxonData=function(a,b){var c,d,e,f,g,h,i;null==b&&(b=null),c=a.data,g=[];for(e in c)f=c[e],h={genus:f.genus,species:f.specificEpithet,subspecies:f.infraspecificEpithet,clade:f.cladeSampled},g.containsObject(h)||g.push(h);return console.info("Found "+g.length+" unique taxa:",g),d=g.length>1?"taxa":"taxon",toastStatusMessage("Validating "+g.length+" uniqe "+d),(i=function(c,d){return validateAWebTaxon(c[d],function(e){var f;return e.invalid===!0?(cleanupToasts(),stopLoadError(e.response.human_error),console.error(e.response.error),f="<strong>Taxonomy Error</strong>: There was a taxon error in your file. "+e.response.human_error+" We stopped validation at that point. Please correct taxonomy issues and try uploading again.",bsAlert(f),removeDataFile(),!1):(c[d]=e,d++,d<c.length?i(c,d):(a.validated_taxa=c,b(a)))})})(g,0),!1},validateAWebTaxon=function(a,b){var c,d,e;return null==b&&(b=null),null==(null!=(e=window.validationMeta)?e.validatedTaxons:void 0)&&("object"!=typeof window.validationMeta&&(window.validationMeta={}),window.validationMeta.validatedTaxons=[]),d=function(a){return"function"==typeof b&&b(a),!1},window.validationMeta.validatedTaxons.containsObject(a)?(console.info("Already validated taxon, skipping revalidation",a),d(a),!1):(c="action=validate&genus="+a.genus+"&species="+a.species,null!=a.subspecies&&(c+="&subspecies="+a.subspecies),$.post("api.php",c,"json").done(function(b){return b.status?(a.genus=b.validated_taxon.genus,a.species=b.validated_taxon.species,a.subspecies=b.validated_taxon.subspecies,window.validationMeta.validatedTaxons.push(a)):a.invalid=!0,a.response=b,d(a),!1}).fail(function(b,c){var d;return d=a.genus+" "+a.species,d=null!=a.subspecies?d+" "+a.subspecies:d,bsAlert("<strong>Problem validating taxon:</strong> "+d+" couldn't be validated."),console.warn("Warning: Couldn't validated "+d+" with AmphibiaWeb")}),!1)};
//# sourceMappingURL=maps/c.map