AmphibianDisease.og
==========================

Quick Links:

- [Project Browser](https://amphibiandisease.org/project.php)
- [Login/Administration](https://amphibiandisease.org/admin)
- [Administration Dashboard](https://amphibiandisease.org/admin-page.html)

## Features


## API access

All responses are as `application/json`.

### API errors

If a given query produces an error, the `status` key will be `false`.

In addition, you will always have an `error` key with technical
details. When appropriate, the server may provide a `human_error` key
with a response that's more friendly to an end user.

### API Authentication

These parameters are optional for unauthenticated API access (in some cases, you may get additional results here), and mandatory for authenticated API access.

#### Acquiring API tokens

If you don't already have a set of identifier tokens, you will need to acquire them.

Method: `POST`  
Target:

Parameters:

> `action`: `login`  
> `username`: The email of the user  
> `password`: The password of the user  
  
    
**Aside: TOTP**  
>**Important Note**: If your user is configured to use Two-Factor authentication, you'll recieve a response like:
>
>```json
>{
>  "status": false,
>  "user": "foo@bar.com",
>  "encrypted_hash": "jU+3Yson68O6vluIAStEnBFOX87xT0dmnYLauKs+jM8=",
>  "encrypted_secret": "jU+3Yson68O6vluIAStEnBFOX87xT0dmnYLauKs+jM8=",
>  "encrypted_password": "%2BaHg3NELhMcD%2FKUXrjAnXPu8xA4evKS0Ew8%2F%2Bv9Nxtk%3D",
>  "human_error": "Please enter the code generated by the authenticator application on your device for foo@bar.com.",
>  "error": false,
>  "totp": true
>}
>```
>
>Which you can test for by checking if `result.status === false && result.totp === true`.
>
>When you re-reply, send
>
>> `action`: `login`  
>> `username`: The email of the user  
>> `password`: The previous response `response.encrypted_password`  
>> `totp`: Your TOTP value  



Response:

> `status`: boolean  
> `user`: JSON string of {'COOKIE_NAME':'USER_EMAIL'}. Note this is NOT an object.  
> `auth`: JSON string of {'COOKIE_NAME':'USER_AUTHORIZATION_HASH'}. Note this is NOT an object.  
> `secret`: JSON string of {'COOKIE_NAME':'USER_AUTHORIZATION_SECRET'}. Note this is NOT an object.  
> `link`: JSON string of {'COOKIE_NAME':'USER_DB_UNQ_ID'}. Note this is NOT an object.  
> `pic`: JSON string of {'COOKIE_NAME':'USER_PICTURE_PATH'}. Note this is NOT an object.  
> `name`: JSON string of {'COOKIE_NAME':'USER_FIRST_NAME'}. Note this is NOT an object.  
> `full_name`: JSON string of {'COOKIE_NAME':'USER_FULL_NAME'}. Note this is NOT an object.  
> `js`: A JavaScript function to evaluate using [js-cookie](https://github.com/js-cookie/js-cookie/tree/v1.5.1) to set the cookies in-browser.  
> `ip_given`: The IP from which these cookies are valid. Changing IP addresses will invalidate the cookies.  
> `raw_auth`: The data from `response.auth`  
> `raw_secret`: The data from `response.secret`  
> `raw_uid`: The data from `response.link`  
> `expires`: The expires parameter on the cookies.  

#### Sending API tokens

| Parameter | Value Meaning                                       | Key from Acquired Tokens |
|-----------|-----------------------------------------------------|--------------------------|
| `hash`    | Verification value of user secret and server secret | `response.raw_auth`  |
| `secret`  | One of two parts of a secret session identiifer     | `response.raw_secret`|
| `dblink`  | Unique server ID for user; UserID equivalent        | `response.raw_uid`  |


For any authenticated/psuedoauthenticated request, these parameters can be sent as extra parameters to validate a login session. The cookie key pairs may also be sent in the header of the POST, rather than these raw cookie values.

### Unauthenticated APIs

API target: `https://amphibiandisease.org/api.php`  
Method: `GET`/`POST`

**Note**: The `Access-Control-Allow-Origin` header is set to `*`. This may be directly accessed by JavaScript from any origin.

Mandatory parameter: `action`

- `fetch`:
  > Queries raw data from the total dataset. Psuedoauthenticated.  
  > Be aware that access may be restricted based on your login status. If you're not logged in, only public resources are queryable.
  >
  > Parameters:  
  > `sql_query`: An SQL query against the raw data. When constructing your query, you'll want to use the `table` value from the JSON in the `carto_id` key.
  >
  > Response:  
  > `status`: boolean  
  > `sql_statements`: Array of queried statements  
  > `post_response`: Array of raw responses from CartoDB  
  > `parsed_responses`: Formatted responses from CartoDB  

- `validate`:
  > Validates a taxon against Amphibiaweb and returns canonical information.
  >
  > The taxonomy returned may be different from the one provided if AmphibiaWeb views it as a synonym. Synonyms may also include a species gender change, which you can monitor via the notice `FUZZY_SPECIES_MATCH`.
  >
  > Parameters:  
  > (req) `genus`: Genus to validate. Case-insensitive.  
  > (req) `species`: Species to validate. If you only want to check for a genus, the value 'sp.' may be used here.  
  > `subspecies`: Reserved for future use; currently not tracked by AmphibiaWeb.  
  >
  > Response:  
  > `status`: boolean  
  > `aweb_list_age`: Current age of the taxonomy list being validated against  
  > `aweb_list_max_age`: Maximum age of the AmphibiaWeb taxonomy used, in seconds.  
  > `notices`: Array. List of non-fatal notices. Includes notices if taxonomy was changed.  
  > `original_taxon`: The provided taxon, if changed. If unchanged, this field is absent.  
  > `validated_taxon`: Object. The canonical taxon information  

- `search_project`:

- `search_users`:





### Authenticated APIs

API target: `https://amphibiandisease.org/admin-api.php`  
Method: `POST`

**Note**: The `Access-Control-Allow-Origin` header is set to `*`. This may be directly accessed by JavaScript from any origin.

Mandatory parameter: `perform`

- `list`
- `new`
- `save`
- `delete`
- `get`
- `mint_data`
- `create_expedition`
- `associate_expedition`
- `validate`
- `check_access`


## Data Storage

You can view  a [CSON](https://github.com/bevry/cson) representation of the data storage of the system at [./meta/data-storage.coffee](https://github.com/AmphibiaWeb/amphibian-disease-tracker/blob/master/meta/data-storage.coffee)

There is no equivalent to [BD-Maps'](http://www.bd-maps.net/isolates/) following fields:

- Global ID: Redundant to sample ID
- Country / Continent / Region: Redundant and derivable from coordinate bounding boxes
- Elevation: Lookup-able from sample coordinates
- Accuracy: Should be built in to `radius` field.
- Coordinate source: Is the model of GPS actually relevant?
- Developmental stage: Per-sample, should be included in raw data. At a high level, redundant to `sampled_species_detail[N].sampled_life_stages`
- Method of detection: Since this may vary on a per-sample basis, this is relegated to the raw data.
- Abnormalities: Problems in data are encapsulated in `disease_no_confidence`, problems with animals belong with the raw data.
- All individual sample data (eg, spore count, genbank ID, etc): Belongs in raw data


## Configuration Data

This data is encrypted using
[BlackBox](https://github.com/StackExchange/blackbox). If you want
access to the configuration, please ask to have your credentials
added, or add it yourself in a clone and push the changes. Once you
let an administrator know, you can be added to the keyring and gain
decryption privledges.
