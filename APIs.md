# General API information

All responses are as `application/json`.

Note that input is aggressively URL escaped. Depending on your use you may want to de-escape the text before use (especially raw JSON-as-text).

[This Github Gist](https://gist.github.com/tigerhawkvok/285b8631ed6ebef4446d) has CoffeeScript and JavaScript code to help, or [this PHP block](https://github.com/tigerhawkvok/php-core/blob/070cd80b9c5ae5526be87ae41abc0d047e5e948a/core.php#L349-L369) as a PHP helper.

## API errors

If a given query produces an error, the `status` key will be `false`.

In addition, you will always have an `error` key with technical
details. When appropriate, the server may provide a `human_error` key
with a response that's more friendly to an end user.

# API Authentication

These parameters are optional for unauthenticated API access (in some cases, you may get additional results here), and mandatory for authenticated API access.

## Acquiring API tokens

If you don't already have a set of identifier tokens, you will need to acquire them.

API target: `https://amphibiandisease.org/api.php`  
Method: `POST`

Parameters:


| Parameter | Value |
|-----------|-------|
| `action` | `login` |
| `username` | The email of the user |
| `password` | The password of the user |


Response:

*Please note that a "JSON string" is **not** an object, below. It is instead a string representing JSON that will have to be `json_decode()`d (PHP) or `JSON.parse()`d (JavaScript).*


| Key | Detail                                       |
|-----|----------------------------------------------|
| `status` | `true` or `false` (boolean) |
| `user` | JSON string of `{'COOKIE_NAME':'USER_EMAIL'}` |
| `auth` | JSON string of `{'COOKIE_NAME':'USER_AUTHORIZATION_HASH'}`.|
| `secret` | JSON string of `{'COOKIE_NAME':'USER_AUTHORIZATION_SECRET'}`.  |
| `link` | JSON string of `{'COOKIE_NAME':'USER_DB_UNQ_ID'}`.|
| `pic` | JSON string of `{'COOKIE_NAME':'USER_PICTURE_PATH'}`.|
| `name` | JSON string of `{'COOKIE_NAME':'USER_FIRST_NAME'}`.|
| `full_name` | JSON string of `{'COOKIE_NAME':'USER_FULL_NAME'}`.  |
| `js` | A JavaScript function to evaluate using [js-cookie](https://github.com/js-cookie/js-cookie/tree/v1.5.1) to set the cookies in-browser.  |
| `ip_given` | The IP from which these cookies are valid. Changing IP addresses will invalidate the cookies.  |
| `raw_auth` | The data from `response.auth`  |
| `raw_secret` | The data from `response.secret`  |
| `raw_uid` | The data from `response.link`  |
| `expires` | The expires parameter on the cookies.  |



### Aside: TOTP
**Important Note**: If your user is configured to use Two-Factor authentication, you'll recieve a response like:

```json
{
  "status": false,
  "user": "foo@bar.com",
  "encrypted_hash": "jU+3Yson68O6vluIAStEnBFOX87xT0dmnYLauKs+jM8=",
  "encrypted_secret": "jU+3Yson68O6vluIAStEnBFOX87xT0dmnYLauKs+jM8=",
  "encrypted_password": "%2BaHg3NELhMcD%2FKUXrjAnXPu8xA4evKS0Ew8%2F%2Bv9Nxtk%3D",
  "human_error": "Please enter the code generated by the authenticator application on your device for foo@bar.com.",
  "error": false,
  "totp": true
}
```

Which you can test for by checking

```coffee
# CoffeeScript
$.post endpointUrl, args, "json"
.done (response) ->
  if response.status is false and response.totp is true
    # We need to handle the user's TOTP
```

When you re-reply, send

| Parameter | Value |
|-----------|-------|
| `action` | `login` |
| `username` | The email of the user |
| `password` | The previous response's `response.encrypted_password` value |
| `totp` | The TOTP value |

Only once you've done that, will you get a response as above.


## Sending API tokens

Assuming you're accessing the return in JavaScript and have named the variable `response`:

| Parameter | Value Meaning                                       | Key from Acquired Tokens |
|-----------|-----------------------------------------------------|--------------------------|
| `hash`    | Verification value of user secret and server secret | `response.raw_auth`  |
| `secret`  | One of two parts of a secret session identiifer     | `response.raw_secret`|
| `dblink`  | Unique server ID for user; UserID equivalent        | `response.raw_uid`  |


For any authenticated/psuedoauthenticated request, these parameters can be sent as extra parameters to validate a login session. The cookie key pairs may also be sent in the header of the POST, rather than these raw cookie values.

# Unauthenticated APIs

API target: `https://amphibiandisease.org/api.php`  
Method: `GET`/`POST`

**Note**: The `Access-Control-Allow-Origin` header is set to `*`. This may be directly accessed by JavaScript from any origin.

Mandatory parameter: `action`

## Querying project samples


Queries raw data from the total dataset. **Psuedoauthenticated**.

Be aware that access may be restricted based on your login status. If you're not logged in, only public resources are queryable.  Attempting to access a non-public project will return an `UNAUTHORIZED` error.

| Parameter | Value |
|-----------|-------|
| `action` | `fetch` |
| `sql_query` | An SQL query against the raw data. When constructing your query, you'll want to use the `table` value from the JSON in the `carto_id` key. To obtain this the first time, you'll want to make an authenticated API hit with `perform=get` ([see below](#authenticated-apis)) |

Response:


| Key | Detail                                       |
|-----|----------------------------------------------|
| `status` | `true` or `false` (boolean) |
| `sql_statements`  | Array of queried statements  |
| `post_response`  | Array of raw responses from CartoDB |
| `parsed_responses`  | Formatted responses from CartoDB  |


## Validating / Updating Taxa

Validates a taxon against Amphibiaweb and returns canonical information.

The taxonomy returned may be different from the one provided if AmphibiaWeb views it as a synonym. Synonyms may also include a species gender change, which you can monitor via the `notices` response key for `FUZZY_SPECIES_MATCH`.

Parameters:  

| Parameter | Value |
|-----------|-------|
| `action` | `validate` |
| `genus` |  Genus to validate. Case-insensitive. |
| `species` | Species to validate. If you only want to check for a genus, the string `sp.` may be used here. |
| `subspecies` | **Optional:** Reserved for future use; currently not tracked by AmphibiaWeb. |

Response:  

| Key | Detail                                       |
|-----|----------------------------------------------|
| `status` | `true` or `false` (boolean) |
| `aweb_list_age` | Current age of the taxonomy list being validated against  |
| `aweb_list_max_age` | Maximum age of the AmphibiaWeb taxonomy used, in seconds.  |
| `notices` | Array. List of non-fatal notices. Includes notices if taxonomy was changed.  |
| `original_taxon` | The provided taxon, if changed. If unchanged, this field is absent.  |
| `validated_taxon` | Object. The canonical taxon information. Most relevant keys would be `genus` and `species`. |

Please note that generic names are not necessarily capitalized. It is assumed that this will be taken care of presentationally when parsed, eg,

```coffee
html = """
<span style="text-transform:capitalize;">#{response.validated_taxon.genus}</span> #{response.validated_taxon.species}
"""
```

Sample response: 

*query: `https://amphibiandisease.org/api.php?action=validate&genus=bufo&species=boreas`*

```json
{
  "execution_time": 173.39897155762,
  "validated_taxon": {
    "taxon_notes_public": "",
    "uri_or_guid": "http:\/\/amphibiaweb.org\/species\/122",
    "aweb_uid": "122",
    "intro_isocc": "",
    "isocc": {
      "2": "MX",
      "1": "CA",
      "0": "US"
    },
    "iucn": "Near Threatened (NT)",
    "itis_names": {
      "1": "Bufo politus",
      "0": "Bufo boreas"
    },
    "synonymies": "",
    "gaa_name": "Anaxyrus boreas",
    "common_name": {
      "2": "California Toad (<i>B. b. halophilus<\/i>)",
      "1": "Boreal Toad (<i>B. b. boreas<\/i>)",
      "0": "Western Toad"
    },
    "species": "boreas",
    "subgenus": "",
    "genus": "Anaxyrus",
    "subfamily": "",
    "family": "Bufonidae",
    "order": "Anura"
  },
  "original_taxon": "bufo boreas",
  "aweb_list_max_age": 86400,
  "aweb_list_age": 13,
  "notices": {
    "0": "Your entry 'bufo boreas' was a synonym in the AmphibiaWeb database. It was automatically converted to the canonical taxon."
  },
  "args_provided": {
    "species": "boreas",
    "genus": "bufo",
    "action": "validate"
  },
  "status": true
}
```

## Find a project
`search_projects`:

Parameters:  

| Parameter | Value |
|-----------|-------|
| `action` | `search_projects` |

Response:  

| Key | Detail                                       |
|-----|----------------------------------------------|
| `status` | `true` or `false` (boolean) |


## Find a user

Find a user in the database. Searches email, name, and handle. Returns all partial string matches.

Parameters:  

| Parameter | Value |
|-----------|-------|
| `action` | `search_users` |
| `q` | Search query |

Response:  

| Key | Detail                                       |
|-----|----------------------------------------------|
| `status` | `true` or `false` (boolean) |
| `result` | Array of results, each an object containing `email`, `uid`, `handle`, `first_name`, `last_name`, and `full_name` |
| `count` | Total number of results |




# Authenticated APIs

API target: `https://amphibiandisease.org/admin-api.php`  
Method: `POST`

**Note**: The `Access-Control-Allow-Origin` header is set to `*`. This may be directly accessed by JavaScript from any origin.

Mandatory parameter: `perform`

## Listing accessible projects

**Psuedoauthenticated**. If this is hit without authentication, a list of public projects will be returned.

Parameters: 

| Parameter | Value |
|-----------|-------|
| `perform` | `list` |

Response:

| Key | Detail                                       |
|-----|----------------------------------------------|
| `status` | `true` or `false` (boolean) |
| `projects` | Array of projects, as `projectId: "projectName"` key:value pairs. |
| `public_projects` | Array of project IDs for public projects in this list |
| `authored_projects` | Array of project IDs for projects authored by the checking user |
| `check_authentication` | `true` or `false` if the authentication status of the user was checked |


## Create a new project
`new`:

## Save changes to a project
`save`:

## Delete a project
`delete`:

## Get project details

Get the details of a project

Parameters:  

| Parameter | Value |
|-----------|-------|
| `perform` | `get` |
| `project_id` | The ID string of the project |

Response:  

| Key | Detail                                       |
|-----------|-----------------------------------------------------|
| `status` | `true` or `false` (boolean) |
| `project_id` | ID of the project |
| `user`  | Permission details of the user making this request  |
| `project`  | Actual project details. Detailed key information is available [on Github in the  `./meta/data-storage.coffee` file, with comments](https://github.com/AmphibiaWeb/amphibian-disease-tracker/blob/master/meta/data-storage.coffee). However, note that some columns will contain parsed information, rather than raw database information, such as `access_data`.  |


Please note that if you're not authorized to view the project, you'll recieve an `ACCESS_AUTHORIZATION_FAILED` error.

Sample Response:  

```json
{
  "execution_time": 6.0899257659912,
  "project_id_raw": "ffa21641ba4266adabd59ee826a15eaa",
  "project_id": "ffa21641ba4266adabd59ee826a15eaa",
  "user": {
    "is_author": true,
    "has_view_permissions": true,
    "has_edit_permissions": true,
    "user": "6d6d454828c05e8ceea03c99cc5f547e52fcb5fb"
  },
  "project": {
    "project_dir_identifier": "45c66a601877cadcb32caa4181c582b4",
    "dataset_arks": "ark:\/21547\/AMe2::f70e11df52296545a7d61c184064f992.xlsx",
    "project_obj_id": "ark:\/21547\/AMd2",
    "extended_funding_reach_goals": "",
    "more_analysis_funding_request": "0",
    "public": true,
    "carto_id": "{\"table\":\"t29c7b8ff37f83116c16efc7d1e70136b&#95;6d6d454828c05e8ceea03c99cc5f547e52fcb5fb\",\"raw&#95;data\":{\"hasDataFile\":true,\"fileName\":\"f70e11df52296545a7d61c184064f992.xlsx\",\"filePath\":\"helpers\/js-dragdrop\/uploaded\/45c66a601877cadcb32caa4181c582b4\/f70e11df52296545a7d61c184064f992.xlsx\"},\"bounding&#95;polygon\":[{\"lat\":37.86,\"lng\":-122.30000000000001},{\"lat\":37.87,\"lng\":-122.2894},{\"lat\":37.88,\"lng\":-122.281},{\"lat\":37.89,\"lng\":-122.27499999999998},{\"lat\":37.8865,\"lng\":-122.28499999999997},{\"lat\":37.88,\"lng\":-122.29500000000002},{\"lat\":37.86,\"lng\":-122.30000000000001}]}",
    "publication": "",
    "pi_lab": "mkoo",
    "access_data": {
      "composite": {
        "tigerhawkvok@gmail.com": {
          "user_id": "6d6d454828c05e8ceea03c99cc5f547e52fcb5fb",
          "email": "tigerhawkvok@gmail.com"
        }
      },
      "author": "tigerhawkvok@gmail.com",
      "viewers_list": null,
      "editors_list": {
        "0": "tigerhawkvok@gmail.com"
      },
      "total": {
        "0": "tigerhawkvok@gmail.com"
      },
      "viewers": null,
      "editors": {
        "0": {
          "user_id": "6d6d454828c05e8ceea03c99cc5f547e52fcb5fb",
          "email": "tigerhawkvok@gmail.com"
        },
      }
    },
    "author_data": "{\"name\":\"Philip Kahn\",\"contact_email\":\"tigerhawkvok@gmail.com\",\"affiliation\":\"Github\",\"lab\":\"mkoo\",\"diagnostic_lab\":\"CoffeeScript\",\"entry_date\":1457399089073}",
    "author": "6d6d454828c05e8ceea03c99cc5f547e52fcb5fb",
    "transect_file": "",
    "radius": "2238",
    "bounding_box_s": "37.86",
    "bounding_box_w": "-122.3",
    "bounding_box_e": "-122.275",
    "bounding_box_n": "37.89",
    "lng": "-122.28805466667",
    "lat": "37.877788555556",
    "sample_raw_data": "https:\/\/amphibiandisease.org\/helpers\/js-dragdrop\/uploaded\/45c66a601877cadcb32caa4181c582b4\/f70e11df52296545a7d61c184064f992.xlsx",
    "locality": "Berkeley, CA, USA",
    "sample_notes": "Testing different ARKs for project and datasets. Expedition ARK should be `ark:\/21547\/AMd2`",
    "sample_field_numbers": "1,2,3,4,5,6,6,6,6",
    "sample_catalog_numbers": "PLK1,PLK2,PLK3,PLK4,PLK5,PLK6,PLK7,PLK8,PLK9",
    "sample_dispositions_used": "",
    "sample_methods_used": "",
    "sampling_years": "2015,2016",
    "sampling_months": "February,January,November",
    "sampled_collection_end": "1.45437e+12",
    "sampled_collection_start": "1.4478e+12",
    "sampled_species_data": "",
    "sampled_clades": "Plethodontidae,Bufonidae",
    "sampled_species": "Batrachoseps attenuatus,Anaxyrus fowleri,Batrachoseps major,Atelopus tricolor",
    "includes_gymnophiona": false,
    "includes_caudata": true,
    "includes_anura": true,
    "sample_method": "",
    "disease_mortality": "5",
    "disease_morbidity": "3",
    "disease_no_confidence": "1",
    "disease_negative": "5",
    "disease_positive": "3",
    "disease_samples": "9",
    "disease_strain": "",
    "disease": "Batrachochytridium dendrobatidus",
    "reference_id": "",
    "project_title": "test diff arks for project and datasets",
    "project_id": "ffa21641ba4266adabd59ee826a15eaa",
    "id": "39"
  },
  "human_error": null,
  "error": null,
  "status": true
}
```

## Validate Project Data
`validate`

# Get Project Access Lists
`check_access`

